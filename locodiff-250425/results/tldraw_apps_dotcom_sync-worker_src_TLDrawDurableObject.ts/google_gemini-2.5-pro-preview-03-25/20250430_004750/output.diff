--- tldraw_apps_dotcom_sync-worker_src_TLDrawDurableObject.ts_expectedoutput.txt (expected)+++ tldraw_apps_dotcom_sync-worker_src_TLDrawDurableObject.ts_extracted.txt (actual)@@ -40,8 +40,8 @@ import { AlarmScheduler } from './AlarmScheduler'
 import { PERSIST_INTERVAL_MS } from './config'
 import { createPostgresConnectionPool } from './postgres'
+import { getPublishedRoomSnapshot } from './routes/tla/getPublishedFile'
 import { getR2KeyForRoom } from './r2'
-import { getPublishedRoomSnapshot } from './routes/tla/getPublishedFile'
 import { Analytics, DBLoadResult, Environment, TLServerEvent } from './types'
 import { EventData, writeDataPoint } from './utils/analytics'
 import { createSupabaseClient } from './utils/createSupabaseClient'
@@ -130,7 +130,6 @@ 								})
 							},
 						})
-
 						this.logEvent({ type: 'room', roomId: slug, name: 'room_start' })
 						// Also associate file assets after we load the room
 						setTimeout(this.maybeAssociateFileAssets.bind(this), PERSIST_INTERVAL_MS)
@@ -167,6 +166,10 @@ 	readonly r2: {
 		readonly rooms: R2Bucket
 		readonly versionCache: R2Bucket
+		readonly ROOM_SNAPSHOTS: R2Bucket
+		readonly SNAPSHOT_SLUG_TO_PARENT_SLUG: KVNamespace
+		readonly ROOMS_HISTORY_EPHEMERAL: R2Bucket
+		readonly UPLOADS: R2Bucket
 	}
 
 	_documentInfo: DocumentInfo | null = null
@@ -189,6 +192,10 @@ 		this.r2 = {
 			rooms: env.ROOMS,
 			versionCache: env.ROOMS_HISTORY_EPHEMERAL,
+			ROOM_SNAPSHOTS: env.ROOM_SNAPSHOTS,
+			SNAPSHOT_SLUG_TO_PARENT_SLUG: env.SNAPSHOT_SLUG_TO_PARENT_SLUG,
+			ROOMS_HISTORY_EPHEMERAL: env.ROOMS_HISTORY_EPHEMERAL,
+			UPLOADS: env.UPLOADS,
 		}
 
 		state.blockConcurrencyWhile(async () => {
@@ -350,7 +357,6 @@ 		// handle legacy param names
 		sessionId ??= params.sessionKey ?? params.instanceId
 		storeId ??= params.localClientId
-		const isNewSession = !this._room
 
 		// Create the websocket pair for the client
 		const { 0: clientWebSocket, 1: serverWebSocket } = new WebSocketPair()
@@ -419,6 +425,7 @@ 			}
 
 			// all good
+			const isNewSession = room.getNumActiveSessions() === 0
 			room.handleSocketConnect({
 				sessionId: sessionId,
 				socket: serverWebSocket,
