--- aider_aider_coders_wholefile_coder.py_expectedoutput.txt (expected)+++ aider_aider_coders_wholefile_coder.py_extracted.txt (actual)@@ -98,13 +98,14 @@         if mode == "diff":
             if fname is not None:
                 # ending an existing block
-                full_path = (Path(self.root) / fname).absolute()
+                full_path = self.abs_root_path(fname)
                 output += self.do_live_diff(full_path, new_lines, False)
             return "\n".join(output)
 
         if fname:
             edits.append((fname, fname_source, new_lines))
 
+        edited = set()
         seen = set()
         refined_edits = []
         # process from most reliable filename, to least reliable
