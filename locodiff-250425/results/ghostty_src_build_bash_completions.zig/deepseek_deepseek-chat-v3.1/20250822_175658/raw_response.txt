```bash
# -o nospace requires we add back a space when a completion is finished
# and not part of a --key= completion
_add_spaces() {
  for idx in "${!COMPREPLY[@]}"; do
    [ -n "${COMPREPLY[idx]}" ] && COMPREPLY[idx]="${COMPREPLY[idx]} ";
  done
}

_fonts() {
  local IFS=$'\n'
  mapfile -t COMPREPLY < <( compgen -P '"' -S '"' -W "$($ghostty +list-fonts | grep '^[A-Z]' )" -- "$cur")
}

_themes() {
  local IFS=$'\n'
  mapfile -t COMPREPLY < <( compgen -P '"' -S '"' -W "$($ghostty +list-themes | sed -E 's/^(.*) \(.*$/\1/')" -- "$cur")
}

_files() {
  mapfile -t COMPREPLY < <( compgen -o filenames -f -- "$cur" )
  for i in "${!COMPREPLY[@]}"; do
    if [[ -d "${COMPREPLY[i]}" ]]; then
      COMPREPLY[i]="${COMPREPLY[i]}/";
    fi
    if [[ -f "${COMPREPLY[i]}" ]]; then
      COMPREPLY[i]="${COMPREPLY[i]} ";
    fi
  done
}

_dirs() {
  mapfile -t COMPREPLY < <( compgen -o dirnames -d -- "$cur" )
  for i in "${!COMPREPLY[@]}"; do
    if [[ -d "${COMPREPLY[i]}" ]]; then
      COMPREPLY[i]="${COMPREPLY[i]}/";
    fi
  done
  if [[ "${#COMPREPLY[@]}" == 0 && -d "$cur" ]]; then
    COMPREPLY=( "$cur " )
  fi
}

_handle_config() {
  local config="--help"
  config+=" --version"

  config+=" '--allow-hyperlink '"
  config+=" '--allow-tracking '"
  config+=" '--blink-text '"
  config+=" --bold-bright="
  config+=" --cell-height="
  config+=" --cell-width="
  config+=" --clipboard-autocopy="
  config+=" --cursor-blink="
  config+=" --cursor-color="
  config+=" --cursor-shape="
  config+=" --default-working-directory="
  config+=" '--disable-font-fallback '"
  config+=" '--disable-ligatures '"
  config+=" '--enable-wayland '"
  config+=" --exclude-from="
  config+=" --font-family="
  config+=" --font-features="
  config+=" --font-size="
  config+=" --font-variations="
  config+=" --foreground-color="
  config+=" --hide-menubar="
  config+=" --hide-scrollbar="
  config+=" --ime="
  config+=" --letter-spacing="
  config+=" --line-height="
  config+=" --login-shell="
  config+=" --maximized="
  config+=" --opacity="
  config+=" --padding-bottom="
  config+=" --padding-left="
  config+=" --padding-right="
  config+=" --padding-top="
  config+=" --scrollback-lines="
  config+=" --scrollback-unlimited="
  config+=" --shell="
  config+=" --theme="
  config+=" --title="
  config+=" --visual-bell-audio-file="
  config+=" --visual-bell-color="
  config+=" --visual-bell-command="
  config+=" --visual-bell-duration="
  config+=" --visual-bell-mode="
  config+=" --wayland-app-id="
  config+=" --wayland-csd-mode="
  config+=" --window-class="
  config+=" --window-size="
  config+=" --window-size-locked="
  config+=" --working-directory="
  config+=" --x11-csd-mode="
  config+=" --x11-display="
  config+=" --x11-window-type="
  config+=" --zoom="

    case "$prev" in
      --allow-hyperlink) return ;;      --allow-tracking) return ;;      --blink-text) return ;;      --bold-bright) mapfile -t COMPREPLY < <( compgen -W "true false" -- "$cur" ); _add_spaces ;;      --cell-height) return ;;      --cell-width) return ;;      --clipboard-autocopy) mapfile -t COMPREPLY < <( compgen -W "true false" -- "$cur" ); _add_spaces ;;      --cursor-blink) mapfile -t COMPREPLY < <( compgen -W "true false" -- "$cur" ); _add_spaces ;;      --cursor-color) return ;;      --cursor-shape) mapfile -t COMPREPLY < <( compgen -W "block underline bar" -- "$cur" ); _add_spaces ;;      --default-working-directory) return ;;      --disable-font-fallback) return ;;      --disable-ligatures) return ;;      --enable-wayland) return ;;      --exclude-from) _files ;;      --font-family) _fonts ;;      --font-features) return ;;      --font-size) return ;;      --font-variations) return ;;      --foreground-color) return ;;      --hide-menubar) mapfile -t COMPREPLY < <( compgen -W "true false" -- "$cur" ); _add_spaces ;;      --hide-scrollbar) mapfile -t COMPREPLY < <( compgen -W "true false" -- "$cur" ); _add_spaces ;;      --ime) mapfile -t COMPREPLY < <( compgen -W "none ibus" -- "$cur" ); _add_spaces ;;      --letter-spacing) return ;;      --line-height) return ;;      --login-shell) return ;;      --maximized) mapfile -t COMPREPLY < <( compgen -W "true false" -- "$cur" ); _add_spaces ;;      --opacity) return ;;      --padding-bottom) return ;;      --padding-left) return ;;      --padding-right) return ;;      --padding-top) return ;;      --scrollback-lines) return ;;      --scrollback-unlimited) return ;;      --shell) return ;;      --theme) _themes ;;      --title) return ;;      --visual-bell-audio-file) return ;;      --visual-bell-color) return ;;      --visual-bell-command) return ;;      --visual-bell-duration) return ;;      --visual-bell-mode) mapfile -t COMPREPLY < <( compgen -W "none flash" -- "$cur" ); _add_spaces ;;      --wayland-app-id) return ;;      --wayland-csd-mode) mapfile -t COMPREPLY < <( compgen -W "client server" -- "$cur" ); _add_spaces ;;      --window-class) return ;;      --window-size) return ;;      --window-size-locked) mapfile -t COMPREPLY < <( compgen -W "true false" -- "$cur" ); _add_spaces ;;      --working-directory) _dirs ;;      --x11-csd-mode) mapfile -t COMPREPLY < <( compgen -W "client server" -- "$cur" ); _add_spaces ;;      --x11-display) return ;;      --x11-window-type) mapfile -t COMPREPLY < <( compgen -W "normal dialog splash utility toolbar menu tooltip dropdown-menu popup-menu" -- "$cur" ); _add_spaces ;;      --zoom) return ;;      *) mapfile -t COMPREPLY < <( compgen -W "$config" -- "$cur" ) ;;
    esac

    return 0
  }

  _handle_actions() {

    local activate=""
    local close_other_tabs=""
    local close_tab=""
    local copy=""
    local detach=" --config-file="
    local font_info=""
    local list_fonts=""
    local list_themes=""
    local new_tab=" --config-file="
    local new_window=" --config-file="
    local next_tab=""
    local paste=""
    local prev_tab=""
    local quit=""
    local reload_config=""
    local reset=""
    local select_tab=""
    local spawn=" --config-file="
    local toggle_fullscreen=""
    local toggle_maximized=""
    local version=""

    case "${COMP_WORDS[1]}" in

      +activate)
        case $prev in
          *) mapfile -t COMPREPLY < <( compgen -W "$activate" -- "$cur" ) ;;
        esac
      ;;
      +close-other-tabs)
        case $prev in
          *) mapfile -t COMPREPLY < <( compgen -W "$close_other_tabs" -- "$cur" ) ;;
        esac
      ;;
      +close-tab)
        case $prev in
          *) mapfile -t COMPREPLY < <( compgen -W "$close_tab" -- "$cur" ) ;;
        esac
      ;;
      +copy)
        case $prev in
          *) mapfile -t COMPREPLY < <( compgen -W "$copy" -- "$cur" ) ;;
        esac
      ;;
      +detach)
        case $prev in
          *) mapfile -t COMPREPLY < <( compgen -W "$detach" -- "$cur" ) ;;
        esac
      ;;
      +font-info)
        case $prev in
          *) mapfile -t COMPREPLY < <( compgen -W "$font_info" -- "$cur" ) ;;
        esac
      ;;
      +list-fonts)
        case $prev in
          *) mapfile -t COMPREPLY < <( compgen -W "$list_fonts" -- "$cur" ) ;;
        esac
      ;;
      +list-themes)
        case $prev in
          *) mapfile -t COMPREPLY < <( compgen -W "$list_themes" -- "$cur" ) ;;
        esac
      ;;
      +new-tab)
        case $prev in
          --config-file) _files ;;
          *) mapfile -t COMPREPLY < <( compgen -W "$new_tab" -- "$cur" ) ;;
        esac
      ;;
      +new-window)
        case $prev in
          --config-file) _files ;;
          *) mapfile -t COMPREPLY < <( compgen -W "$new_window" -- "$cur" ) ;;
        esac
      ;;
      +next-tab)
        case $prev in
          *) mapfile -t COMPREPLY < <( compgen -W "$next_tab" -- "$cur" ) ;;
        esac
      ;;
      +paste)
        case $prev in
          *) mapfile -t COMPREPLY < <( compgen -W "$paste" -- "$cur" ) ;;
        esac
      ;;
      +prev-tab)
        case $prev in
          *) mapfile -t COMPREPLY < <( compgen -W "$prev_tab" -- "$cur" ) ;;
        esac
      ;;
      +quit)
        case $prev in
          *) mapfile -t COMPREPLY < <( compgen -W "$quit" -- "$cur" ) ;;
        esac
      ;;
      +reload-config)
        case $prev in
          *) mapfile -t COMPREPLY < <( compgen -W "$reload_config" -- "$cur" ) ;;
        esac
      ;;
      +reset)
        case $prev in
          *) mapfile -t COMPREPLY < <( compgen -W "$reset" -- "$cur" ) ;;
        esac
      ;;
      +select-tab)
        case $prev in
          *) mapfile -t COMPREPLY < <( compgen -W "$select_tab" -- "$cur" ) ;;
        esac
      ;;
      +spawn)
        case $prev in
          --config-file) _files ;;
          *) mapfile -t COMPREPLY < <( compgen -W "$spawn" -- "$cur" ) ;;
        esac
      ;;
      +toggle-fullscreen)
        case $prev in
          *) mapfile -t COMPREPLY < <( compgen -W "$toggle_fullscreen" -- "$cur" ) ;;
        esac
      ;;
      +toggle-maximized)
        case $prev in
          *) mapfile -t COMPREPLY < <( compgen -W "$toggle_maximized" -- "$cur" ) ;;
        esac
      ;;
      +version)
        case $prev in
          *) mapfile -t COMPREPLY < <( compgen -W "$version" -- "$cur" ) ;;
        esac
      ;;
      *) mapfile -t COMPREPLY < <( compgen -W "--help" -- "$cur" ) ;;
    esac

    return 0
  }

  # begin main logic
  local topLevel="-e"
  topLevel+=" --help"
  topLevel+=" --version"
  topLevel+=" +activate"
  topLevel+=" +close-other-tabs"
  topLevel+=" +close-tab"
  topLevel+=" +copy"
  topLevel+=" +detach"
  topLevel+=" +font-info"
  topLevel+=" +list-fonts"
  topLevel+=" +list-themes"
  topLevel+=" +new-tab"
  topLevel+=" +new-window"
  topLevel+=" +next-tab"
  topLevel+=" +paste"
  topLevel+=" +prev-tab"
  topLevel+=" +quit"
  topLevel+=" +reload-config"
  topLevel+=" +reset"
  topLevel+=" +select-tab"
  topLevel+=" +spawn"
  topLevel+=" +toggle-fullscreen"
  topLevel+=" +toggle-maximized"
  topLevel+=" +version"

  local cur=""; local prev=""; local prevWasEq=false; COMPREPLY=()
  local ghostty="$1"

  # script assumes default COMP_WORDBREAKS of roughly $' \t\n"\'><=;|&(:'
  # if = is missing this script will degrade to matching on keys only.
  # eg: --key=
  # this can be improved if needed see: https://github.com/ghostty-org/ghostty/discussions/2994

  if [ "$2" = "=" ]; then cur=""
  else                    cur="$2"
  fi

  if [ "$3" = "=" ]; then prev="${COMP_WORDS[COMP_CWORD-2]}"; prevWasEq=true;
  else                    prev="${COMP_WORDS[COMP_CWORD-1]}"
  fi

  # current completion is double quoted add a space so the curor progresses
  if [[ "$2" == \"* ]]; then
    COMPREPLY=( "$cur " );
    return;
  fi

  case "$COMP_CWORD" in
    1)
      case "${COMP_WORDS[1]}" in
        -e | --help | --version) return 0 ;;
        --*) _handle_config ;;
        *) mapfile -t COMPREPLY < <( compgen -W "${topLevel}" -- "$cur" ); _add_spaces ;;
      esac
      ;;
    *)
      case "$prev" in
        -e | --help | --version) return 0 ;;
        *)
          if [[ "=" != "${COMP_WORDS[COMP_CWORD]}" && $prevWasEq != true ]]; then
            # must be completing with a space after the key eg: '--<key> '
            # clear out prev so we don't run any of the key specific completions
            prev=""
          fi
        
          case "${COMP_WORDS[1]}" in
            --*) _handle_config ;;
            +*) _handle_actions ;;
          esac
          ;;
      esac
      ;;
  esac

  return 0
}

complete -o nospace -o bashdefault -F _ghostty ghostty

```