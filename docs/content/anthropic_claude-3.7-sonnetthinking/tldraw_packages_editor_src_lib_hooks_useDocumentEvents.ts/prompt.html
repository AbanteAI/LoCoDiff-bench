<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prompt: packages/editor/src/lib/hooks/useDocumentEvents.ts - Sonnet 3.7 Thinking</title>
    <link rel="stylesheet" href="../../../../styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/default.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
</head>
<body>
    <header>
        <h1>Prompt: packages/editor/src/lib/hooks/useDocumentEvents.ts</h1>
        <p><a href="../../../cases/anthropic_claude-3.7-sonnetthinking/tldraw_packages_editor_src_lib_hooks_useDocumentEvents.ts.html">‚Üê Back to Case</a> | <a href="../../../index.html">Home</a></p>
    </header>
    <main>
        <section>
            <h2>Prompt Content</h2>
            <pre><code class="language-plaintext"># Instructions

You are being benchmarked. You will see the output of a git log command, and from that must infer the current state of a file. Think carefully, as you must output the exact state of the file to earn full marks.

**Important:** Your goal is to reproduce the file's content *exactly* as it exists at the final commit, even if the code appears broken, buggy, or contains obvious errors. Do **not** try to "fix" the code. Attempting to correct issues will result in a poor score, as this benchmark evaluates your ability to reproduce the precise state of the file based on its history.

# Required Response Format

Wrap the content of the file in triple backticks (```). Any text outside the final closing backticks will be ignored. End your response after outputting the closing backticks.

# Example Response

```python
#!/usr/bin/env python
print('Hello, world!')
```

# File History

> git log -p --cc --topo-order --reverse -- packages/editor/src/lib/hooks/useDocumentEvents.ts

commit 29ed921c6745923dcc8daa72ba6f815a5c4b279a
Author: alex <alex@dytry.ch>
Date:   Tue Apr 25 12:01:25 2023 +0100

    transfer-out: transfer out

diff --git a/packages/editor/src/lib/hooks/useDocumentEvents.ts b/packages/editor/src/lib/hooks/useDocumentEvents.ts
new file mode 100644
index 000000000..55af7f0a8
--- /dev/null
+++ b/packages/editor/src/lib/hooks/useDocumentEvents.ts
@@ -0,0 +1,270 @@
+import { useEffect } from 'react'
+import { useValue } from 'signia-react'
+import { TLKeyboardEventInfo, TLPointerEventInfo } from '../app/types/event-types'
+import { preventDefault } from '../utils/dom'
+import { useApp } from './useApp'
+import { useContainer } from './useContainer'
+
+export function useDocumentEvents() {
+	const app = useApp()
+	const container = useContainer()
+
+	const isAppFocused = useValue('isFocused', () => app.isFocused, [app])
+
+	useEffect(() => {
+		if (!isAppFocused) return
+
+		const handleKeyDown = (e: KeyboardEvent) => {
+			if (
+				e.altKey &&
+				(app.isIn('zoom') || !app.root.path.value.endsWith('.idle')) &&
+				!isFocusingInput()
+			) {
+				// On windows the alt key opens the menu bar.
+				// We want to prevent that if the user is doing something else,
+				// e.g. resizing a shape
+				preventDefault(e)
+			}
+
+			if ((e as any).isKilled) return
+			;(e as any).isKilled = true
+
+			switch (e.key) {
+				case '=': {
+					if (e.metaKey || e.ctrlKey) {
+						preventDefault(e)
+						return
+					}
+					break
+				}
+				case '-': {
+					if (e.metaKey || e.ctrlKey) {
+						preventDefault(e)
+						return
+					}
+					break
+				}
+				case '0': {
+					if (e.metaKey || e.ctrlKey) {
+						preventDefault(e)
+						return
+					}
+					break
+				}
+				case 'Tab': {
+					if (isFocusingInput() || app.isMenuOpen) {
+						return
+					}
+					break
+				}
+				case ',': {
+					if (!isFocusingInput()) {
+						preventDefault(e)
+						if (!app.inputs.keys.has('Comma')) {
+							const { x, y, z } = app.inputs.currentScreenPoint
+							const {
+								pageState: { hoveredId },
+							} = app
+							app.inputs.keys.add('Comma')
+
+							const info: TLPointerEventInfo = {
+								type: 'pointer',
+								name: 'pointer_down',
+								point: { x, y, z },
+								shiftKey: e.shiftKey,
+								altKey: e.altKey,
+								ctrlKey: e.metaKey || e.ctrlKey,
+								pointerId: 0,
+								button: 0,
+								isPen: app.isPenMode,
+								...(hoveredId
+									? {
+											target: 'shape',
+											shape: app.getShapeById(hoveredId)!,
+									  }
+									: {
+											target: 'canvas',
+									  }),
+							}
+
+							app.dispatch(info)
+							return
+						}
+					}
+					break
+				}
+				case 'Escape': {
+					if (!app.inputs.keys.has('Escape')) {
+						app.inputs.keys.add('Escape')
+
+						app.cancel()
+						// Pressing escape will focus the document.body,
+						// which will cause the app to lose focus, which
+						// will break additional shortcuts. We need to
+						// refocus the container in order to keep these
+						// shortcuts working.
+						container.focus()
+					}
+					return
+				}
+				default: {
+					if (isFocusingInput() || app.isMenuOpen) {
+						return
+					}
+				}
+			}
+
+			const info: TLKeyboardEventInfo = {
+				type: 'keyboard',
+				name: app.inputs.keys.has(e.code) ? 'key_repeat' : 'key_down',
+				key: e.key,
+				code: e.code,
+				shiftKey: e.shiftKey,
+				altKey: e.altKey,
+				ctrlKey: e.metaKey || e.ctrlKey,
+			}
+
+			app.dispatch(info)
+		}
+
+		const handleKeyUp = (e: KeyboardEvent) => {
+			if ((e as any).isKilled) return
+			;(e as any).isKilled = true
+
+			if (isFocusingInput() || app.isMenuOpen) {
+				return
+			}
+
+			// Use the , key to send pointer events
+			if (e.key === ',') {
+				if (document.activeElement?.ELEMENT_NODE) preventDefault(e)
+				if (app.inputs.keys.has(e.code)) {
+					const { x, y, z } = app.inputs.currentScreenPoint
+					const {
+						pageState: { hoveredId },
+					} = app
+
+					app.inputs.keys.delete(e.code)
+
+					const info: TLPointerEventInfo = {
+						type: 'pointer',
+						name: 'pointer_up',
+						point: { x, y, z },
+						shiftKey: e.shiftKey,
+						altKey: e.altKey,
+						ctrlKey: e.metaKey || e.ctrlKey,
+						pointerId: 0,
+						button: 0,
+						isPen: app.isPenMode,
+						...(hoveredId
+							? {
+									target: 'shape',
+									shape: app.getShapeById(hoveredId)!,
+							  }
+							: {
+									target: 'canvas',
+							  }),
+					}
+					app.dispatch(info)
+					return
+				}
+			}
+
+			const info: TLKeyboardEventInfo = {
+				type: 'keyboard',
+				name: 'key_up',
+				key: e.key,
+				code: e.code,
+				shiftKey: e.shiftKey,
+				altKey: e.altKey,
+				ctrlKey: e.metaKey || e.ctrlKey,
+			}
+
+			app.dispatch(info)
+		}
+
+		function handleTouchStart(e: TouchEvent) {
+			if (container.contains(e.target as Node)) {
+				// Center point of the touch area
+				const touchXPosition = e.touches[0].pageX
+				// Size of the touch area
+				const touchXRadius = e.touches[0].radiusX || 0
+
+				// We set a threshold (10px) on both sizes of the screen,
+				// if the touch area overlaps with the screen edges
+				// it's likely to trigger the navigation. We prevent the
+				// touchstart event in that case.
+				if (
+					touchXPosition - touchXRadius < 10 ||
+					touchXPosition + touchXRadius > app.viewportScreenBounds.width - 10
+				) {
+					if ((e.target as HTMLElement)?.tagName === 'BUTTON') {
+						// Force a click before bailing
+						;(e.target as HTMLButtonElement)?.click()
+					}
+
+					preventDefault(e)
+				}
+			}
+		}
+
+		// Prevent wheel events that occur inside of the container
+		const handleWheel = (e: WheelEvent) => {
+			if (container.contains(e.target as Node) && (e.ctrlKey || e.metaKey)) {
+				preventDefault(e)
+			}
+		}
+
+		function handleBlur() {
+			app.complete()
+		}
+
+		function handleFocus() {
+			app.updateViewportScreenBounds()
+		}
+
+		container.addEventListener('touchstart', handleTouchStart, { passive: false })
+
+		document.addEventListener('wheel', handleWheel, { passive: false })
+		document.addEventListener('gesturestart', preventDefault)
+		document.addEventListener('gesturechange', preventDefault)
+		document.addEventListener('gestureend', preventDefault)
+
+		document.addEventListener('keydown', handleKeyDown)
+		document.addEventListener('keyup', handleKeyUp)
+
+		window.addEventListener('blur', handleBlur)
+		window.addEventListener('focus', handleFocus)
+
+		return () => {
+			container.removeEventListener('touchstart', handleTouchStart)
+
+			document.removeEventListener('wheel', handleWheel)
+			document.removeEventListener('gesturestart', preventDefault)
+			document.removeEventListener('gesturechange', preventDefault)
+			document.removeEventListener('gestureend', preventDefault)
+
+			document.removeEventListener('keydown', handleKeyDown)
+			document.removeEventListener('keyup', handleKeyUp)
+
+			window.removeEventListener('blur', handleBlur)
+			window.removeEventListener('focus', handleFocus)
+		}
+	}, [app, container, isAppFocused])
+}
+
+const INPUTS = ['input', 'select', 'button', 'textarea']
+
+function isFocusingInput() {
+	const { activeElement } = document
+
+	if (
+		activeElement &&
+		(activeElement.getAttribute('contenteditble') ||
+			INPUTS.indexOf(activeElement.tagName.toLowerCase()) > -1)
+	) {
+		return true
+	}
+
+	return false
+}

commit f44f6e2c9fabf5fa6929adca45fbf052ffeceb84
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Wed May 3 16:57:59 2023 +0100

    [fix] typo in isFocusingInput (#1221)
    
    Fixes
    https://discord.com/channels/859816885297741824/1103050527731884082/1103052355110457354

diff --git a/packages/editor/src/lib/hooks/useDocumentEvents.ts b/packages/editor/src/lib/hooks/useDocumentEvents.ts
index 55af7f0a8..7d39181e9 100644
--- a/packages/editor/src/lib/hooks/useDocumentEvents.ts
+++ b/packages/editor/src/lib/hooks/useDocumentEvents.ts
@@ -260,7 +260,7 @@ function isFocusingInput() {
 
 	if (
 		activeElement &&
-		(activeElement.getAttribute('contenteditble') ||
+		(activeElement.getAttribute('contenteditable') ||
 			INPUTS.indexOf(activeElement.tagName.toLowerCase()) > -1)
 	) {
 		return true

commit 735f1c41b79a3fcce14446b6384ec796f0298a31
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Fri Jun 2 16:21:45 2023 +0100

    rename app to editor (#1503)
    
    This PR renames `App`, `app` and all appy names to `Editor`, `editor`,
    and editorry names.
    
    ### Change Type
    
    - [x] `major` ‚Äî Breaking Change
    
    ### Release Notes
    
    - Rename `App` to `Editor` and many other things that reference `app` to
    `editor`.

diff --git a/packages/editor/src/lib/hooks/useDocumentEvents.ts b/packages/editor/src/lib/hooks/useDocumentEvents.ts
index 7d39181e9..69e9928ee 100644
--- a/packages/editor/src/lib/hooks/useDocumentEvents.ts
+++ b/packages/editor/src/lib/hooks/useDocumentEvents.ts
@@ -2,14 +2,14 @@ import { useEffect } from 'react'
 import { useValue } from 'signia-react'
 import { TLKeyboardEventInfo, TLPointerEventInfo } from '../app/types/event-types'
 import { preventDefault } from '../utils/dom'
-import { useApp } from './useApp'
 import { useContainer } from './useContainer'
+import { useEditor } from './useEditor'
 
 export function useDocumentEvents() {
-	const app = useApp()
+	const editor = useEditor()
 	const container = useContainer()
 
-	const isAppFocused = useValue('isFocused', () => app.isFocused, [app])
+	const isAppFocused = useValue('isFocused', () => editor.isFocused, [editor])
 
 	useEffect(() => {
 		if (!isAppFocused) return
@@ -17,7 +17,7 @@ export function useDocumentEvents() {
 		const handleKeyDown = (e: KeyboardEvent) => {
 			if (
 				e.altKey &&
-				(app.isIn('zoom') || !app.root.path.value.endsWith('.idle')) &&
+				(editor.isIn('zoom') || !editor.root.path.value.endsWith('.idle')) &&
 				!isFocusingInput()
 			) {
 				// On windows the alt key opens the menu bar.
@@ -52,7 +52,7 @@ export function useDocumentEvents() {
 					break
 				}
 				case 'Tab': {
-					if (isFocusingInput() || app.isMenuOpen) {
+					if (isFocusingInput() || editor.isMenuOpen) {
 						return
 					}
 					break
@@ -60,12 +60,12 @@ export function useDocumentEvents() {
 				case ',': {
 					if (!isFocusingInput()) {
 						preventDefault(e)
-						if (!app.inputs.keys.has('Comma')) {
-							const { x, y, z } = app.inputs.currentScreenPoint
+						if (!editor.inputs.keys.has('Comma')) {
+							const { x, y, z } = editor.inputs.currentScreenPoint
 							const {
 								pageState: { hoveredId },
-							} = app
-							app.inputs.keys.add('Comma')
+							} = editor
+							editor.inputs.keys.add('Comma')
 
 							const info: TLPointerEventInfo = {
 								type: 'pointer',
@@ -76,28 +76,28 @@ export function useDocumentEvents() {
 								ctrlKey: e.metaKey || e.ctrlKey,
 								pointerId: 0,
 								button: 0,
-								isPen: app.isPenMode,
+								isPen: editor.isPenMode,
 								...(hoveredId
 									? {
 											target: 'shape',
-											shape: app.getShapeById(hoveredId)!,
+											shape: editor.getShapeById(hoveredId)!,
 									  }
 									: {
 											target: 'canvas',
 									  }),
 							}
 
-							app.dispatch(info)
+							editor.dispatch(info)
 							return
 						}
 					}
 					break
 				}
 				case 'Escape': {
-					if (!app.inputs.keys.has('Escape')) {
-						app.inputs.keys.add('Escape')
+					if (!editor.inputs.keys.has('Escape')) {
+						editor.inputs.keys.add('Escape')
 
-						app.cancel()
+						editor.cancel()
 						// Pressing escape will focus the document.body,
 						// which will cause the app to lose focus, which
 						// will break additional shortcuts. We need to
@@ -108,7 +108,7 @@ export function useDocumentEvents() {
 					return
 				}
 				default: {
-					if (isFocusingInput() || app.isMenuOpen) {
+					if (isFocusingInput() || editor.isMenuOpen) {
 						return
 					}
 				}
@@ -116,7 +116,7 @@ export function useDocumentEvents() {
 
 			const info: TLKeyboardEventInfo = {
 				type: 'keyboard',
-				name: app.inputs.keys.has(e.code) ? 'key_repeat' : 'key_down',
+				name: editor.inputs.keys.has(e.code) ? 'key_repeat' : 'key_down',
 				key: e.key,
 				code: e.code,
 				shiftKey: e.shiftKey,
@@ -124,27 +124,27 @@ export function useDocumentEvents() {
 				ctrlKey: e.metaKey || e.ctrlKey,
 			}
 
-			app.dispatch(info)
+			editor.dispatch(info)
 		}
 
 		const handleKeyUp = (e: KeyboardEvent) => {
 			if ((e as any).isKilled) return
 			;(e as any).isKilled = true
 
-			if (isFocusingInput() || app.isMenuOpen) {
+			if (isFocusingInput() || editor.isMenuOpen) {
 				return
 			}
 
 			// Use the , key to send pointer events
 			if (e.key === ',') {
 				if (document.activeElement?.ELEMENT_NODE) preventDefault(e)
-				if (app.inputs.keys.has(e.code)) {
-					const { x, y, z } = app.inputs.currentScreenPoint
+				if (editor.inputs.keys.has(e.code)) {
+					const { x, y, z } = editor.inputs.currentScreenPoint
 					const {
 						pageState: { hoveredId },
-					} = app
+					} = editor
 
-					app.inputs.keys.delete(e.code)
+					editor.inputs.keys.delete(e.code)
 
 					const info: TLPointerEventInfo = {
 						type: 'pointer',
@@ -155,17 +155,17 @@ export function useDocumentEvents() {
 						ctrlKey: e.metaKey || e.ctrlKey,
 						pointerId: 0,
 						button: 0,
-						isPen: app.isPenMode,
+						isPen: editor.isPenMode,
 						...(hoveredId
 							? {
 									target: 'shape',
-									shape: app.getShapeById(hoveredId)!,
+									shape: editor.getShapeById(hoveredId)!,
 							  }
 							: {
 									target: 'canvas',
 							  }),
 					}
-					app.dispatch(info)
+					editor.dispatch(info)
 					return
 				}
 			}
@@ -180,7 +180,7 @@ export function useDocumentEvents() {
 				ctrlKey: e.metaKey || e.ctrlKey,
 			}
 
-			app.dispatch(info)
+			editor.dispatch(info)
 		}
 
 		function handleTouchStart(e: TouchEvent) {
@@ -196,7 +196,7 @@ export function useDocumentEvents() {
 				// touchstart event in that case.
 				if (
 					touchXPosition - touchXRadius < 10 ||
-					touchXPosition + touchXRadius > app.viewportScreenBounds.width - 10
+					touchXPosition + touchXRadius > editor.viewportScreenBounds.width - 10
 				) {
 					if ((e.target as HTMLElement)?.tagName === 'BUTTON') {
 						// Force a click before bailing
@@ -216,11 +216,11 @@ export function useDocumentEvents() {
 		}
 
 		function handleBlur() {
-			app.complete()
+			editor.complete()
 		}
 
 		function handleFocus() {
-			app.updateViewportScreenBounds()
+			editor.updateViewportScreenBounds()
 		}
 
 		container.addEventListener('touchstart', handleTouchStart, { passive: false })
@@ -250,7 +250,7 @@ export function useDocumentEvents() {
 			window.removeEventListener('blur', handleBlur)
 			window.removeEventListener('focus', handleFocus)
 		}
-	}, [app, container, isAppFocused])
+	}, [editor, container, isAppFocused])
 }
 
 const INPUTS = ['input', 'select', 'button', 'textarea']

commit 355ed1de72de231232ce61612270f5fc7915690b
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Tue Jun 6 17:01:54 2023 +0100

    rename app folder to editor (#1528)
    
    Turns out there was one last terrible renaming PR to make. This PR
    renames the `@tldraw.editor`'s `app` folder to `editor`. It should not
    effect exports but it will be a gnarly diff.
    
    ### Change Type
    
    - [x] `internal` ‚Äî Any other changes that don't affect the published
    package (will not publish a new version)

diff --git a/packages/editor/src/lib/hooks/useDocumentEvents.ts b/packages/editor/src/lib/hooks/useDocumentEvents.ts
index 69e9928ee..515309119 100644
--- a/packages/editor/src/lib/hooks/useDocumentEvents.ts
+++ b/packages/editor/src/lib/hooks/useDocumentEvents.ts
@@ -1,6 +1,6 @@
 import { useEffect } from 'react'
 import { useValue } from 'signia-react'
-import { TLKeyboardEventInfo, TLPointerEventInfo } from '../app/types/event-types'
+import { TLKeyboardEventInfo, TLPointerEventInfo } from '../editor/types/event-types'
 import { preventDefault } from '../utils/dom'
 import { useContainer } from './useContainer'
 import { useEditor } from './useEditor'

commit 57bb341593d5f66261de4f0341736681aa6a71b6
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Mon Jun 19 15:01:18 2023 +0100

    `ShapeUtil` refactor, `Editor` cleanup (#1611)
    
    This PR improves the ergonomics of `ShapeUtil` classes.
    
    ### Cached methods
    
    First, I've remove the cached methods (such as `bounds`) from the
    `ShapeUtil` class and lifted this to the `Editor` class.
    
    Previously, calling `ShapeUtil.getBounds` would return the un-cached
    bounds of a shape, while calling `ShapeUtil.bounds` would return the
    cached bounds of a shape. We also had `Editor.getBounds`, which would
    call `ShapeUtil.bounds`. It was confusing. The cached methods like
    `outline` were also marked with "please don't override", which suggested
    the architecture was just wrong.
    
    The only weirdness from this is that utils sometimes reach out to the
    editor for cached versions of data rather than calling their own cached
    methods. It's still an easier story to tell than what we had before.
    
    ### More defaults
    
    We now have three and only three `abstract` methods for a `ShapeUtil`:
    - `getDefaultProps` (renamed from `defaultProps`)
    - `getBounds`,
    - `component`
    -  `indicator`
    
    Previously, we also had `getCenter` as an abstract method, though this
    was usually just the middle of the bounds anyway.
    
    ### Editing bounds
    
    This PR removes the concept of editingBounds. The viewport will no
    longer animate to editing shapes.
    
    ### Active area manager
    
    This PR also removes the active area manager, which was not being used
    in the way we expected it to be.
    
    ### Dpr manager
    
    This PR removes the dpr manager and uses a hook instead to update it
    from React. This is one less runtime browser dependency in the app, one
    less thing to document.
    
    ### Moving things around
    
    This PR also continues to try to organize related methods and properties
    in the editor.
    
    ### Change Type
    
    - [x] `major` ‚Äî Breaking change
    
    ### Release Notes
    
    - [editor] renames `defaultProps` to `getDefaultProps`
    - [editor] removes `outline`, `outlineSegments`, `handles`, `bounds`
    - [editor] renames `renderBackground` to `backgroundComponent`

diff --git a/packages/editor/src/lib/hooks/useDocumentEvents.ts b/packages/editor/src/lib/hooks/useDocumentEvents.ts
index 515309119..28a93dabf 100644
--- a/packages/editor/src/lib/hooks/useDocumentEvents.ts
+++ b/packages/editor/src/lib/hooks/useDocumentEvents.ts
@@ -11,6 +11,21 @@ export function useDocumentEvents() {
 
 	const isAppFocused = useValue('isFocused', () => editor.isFocused, [editor])
 
+	useEffect(() => {
+		if (typeof matchMedia !== undefined) return
+
+		function updateDevicePixelRatio() {
+			editor.setDevicePixelRatio(window.devicePixelRatio)
+		}
+
+		const MM = matchMedia(`(resolution: ${window.devicePixelRatio}dppx)`)
+
+		MM.addEventListener('change', updateDevicePixelRatio)
+		return () => {
+			MM.removeEventListener('change', updateDevicePixelRatio)
+		}
+	}, [editor])
+
 	useEffect(() => {
 		if (!isAppFocused) return
 

commit 5cb08711c19c086a013b3a52b06b7cdcfd443fe5
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Tue Jun 20 14:31:26 2023 +0100

    Incorporate signia as @tldraw/state (#1620)
    
    It tried to get out but we're dragging it back in.
    
    This PR brings [signia](https://github.com/tldraw/signia) back into
    tldraw as @tldraw/state.
    
    ### Change Type
    
    - [x] major
    
    ---------
    
    Co-authored-by: David Sheldrick <d.j.sheldrick@gmail.com>

diff --git a/packages/editor/src/lib/hooks/useDocumentEvents.ts b/packages/editor/src/lib/hooks/useDocumentEvents.ts
index 28a93dabf..30cd879f0 100644
--- a/packages/editor/src/lib/hooks/useDocumentEvents.ts
+++ b/packages/editor/src/lib/hooks/useDocumentEvents.ts
@@ -1,5 +1,5 @@
+import { useValue } from '@tldraw/state'
 import { useEffect } from 'react'
-import { useValue } from 'signia-react'
 import { TLKeyboardEventInfo, TLPointerEventInfo } from '../editor/types/event-types'
 import { preventDefault } from '../utils/dom'
 import { useContainer } from './useContainer'

commit c524cac3f7b7190ecced8f5f2c3745bf9fbf1722
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Thu Jun 29 21:30:33 2023 +0100

    [fix] comma keyboard shortcuts (#1675)
    
    This PR fixes some issues in our `useDocumentEvents`. It closes
    https://github.com/tldraw/tldraw/issues/1667 (I think).
    
    ### Change Type
    
    - [x] `patch`
    
    ### Release Notes
    
    - [@tldraw/editor] Bug fixes on document events.

diff --git a/packages/editor/src/lib/hooks/useDocumentEvents.ts b/packages/editor/src/lib/hooks/useDocumentEvents.ts
index 30cd879f0..276cb763e 100644
--- a/packages/editor/src/lib/hooks/useDocumentEvents.ts
+++ b/packages/editor/src/lib/hooks/useDocumentEvents.ts
@@ -240,13 +240,14 @@ export function useDocumentEvents() {
 
 		container.addEventListener('touchstart', handleTouchStart, { passive: false })
 
-		document.addEventListener('wheel', handleWheel, { passive: false })
+		container.addEventListener('wheel', handleWheel, { passive: false })
+
 		document.addEventListener('gesturestart', preventDefault)
 		document.addEventListener('gesturechange', preventDefault)
 		document.addEventListener('gestureend', preventDefault)
 
-		document.addEventListener('keydown', handleKeyDown)
-		document.addEventListener('keyup', handleKeyUp)
+		container.addEventListener('keydown', handleKeyDown)
+		container.addEventListener('keyup', handleKeyUp)
 
 		window.addEventListener('blur', handleBlur)
 		window.addEventListener('focus', handleFocus)
@@ -254,13 +255,14 @@ export function useDocumentEvents() {
 		return () => {
 			container.removeEventListener('touchstart', handleTouchStart)
 
-			document.removeEventListener('wheel', handleWheel)
+			container.removeEventListener('wheel', handleWheel)
+
 			document.removeEventListener('gesturestart', preventDefault)
 			document.removeEventListener('gesturechange', preventDefault)
 			document.removeEventListener('gestureend', preventDefault)
 
-			document.removeEventListener('keydown', handleKeyDown)
-			document.removeEventListener('keyup', handleKeyUp)
+			container.removeEventListener('keydown', handleKeyDown)
+			container.removeEventListener('keyup', handleKeyUp)
 
 			window.removeEventListener('blur', handleBlur)
 			window.removeEventListener('focus', handleFocus)

commit b7d9c8684cb6cf7bd710af5420135ea3516cc3bf
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Mon Jul 17 22:22:34 2023 +0100

    tldraw zero - package shuffle (#1710)
    
    This PR moves code between our packages so that:
    - @tldraw/editor is a ‚Äúcore‚Äù library with the engine and canvas but no
    shapes, tools, or other things
    - @tldraw/tldraw contains everything particular to the experience we‚Äôve
    built for tldraw
    
    At first look, this might seem like a step away from customization and
    configuration, however I believe it greatly increases the configuration
    potential of the @tldraw/editor while also providing a more accurate
    reflection of what configuration options actually exist for
    @tldraw/tldraw.
    
    ## Library changes
    
    @tldraw/editor re-exports its dependencies and @tldraw/tldraw re-exports
    @tldraw/editor.
    
    - users of @tldraw/editor WITHOUT @tldraw/tldraw should almost always
    only import things from @tldraw/editor.
    - users of @tldraw/tldraw should almost always only import things from
    @tldraw/tldraw.
    
    - @tldraw/polyfills is merged into @tldraw/editor
    - @tldraw/indices is merged into @tldraw/editor
    - @tldraw/primitives is merged mostly into @tldraw/editor, partially
    into @tldraw/tldraw
    - @tldraw/file-format is merged into @tldraw/tldraw
    - @tldraw/ui is merged into @tldraw/tldraw
    
    Many (many) utils and other code is moved from the editor to tldraw. For
    example, embeds now are entirely an feature of @tldraw/tldraw. The only
    big chunk of code left in core is related to arrow handling.
    
    ## API Changes
    
    The editor can now be used without tldraw's assets. We load them in
    @tldraw/tldraw instead, so feel free to use whatever fonts or images or
    whatever that you like with the editor.
    
    All tools and shapes (except for the `Group` shape) are moved to
    @tldraw/tldraw. This includes the `select` tool.
    
    You should use the editor with at least one tool, however, so you now
    also need to send in an `initialState` prop to the Editor /
    <TldrawEditor> component indicating which state the editor should begin
    in.
    
    The `components` prop now also accepts `SelectionForeground`.
    
    The complex selection component that we use for tldraw is moved to
    @tldraw/tldraw. The default component is quite basic but can easily be
    replaced via the `components` prop. We pass down our tldraw-flavored
    SelectionFg via `components`.
    
    Likewise with the `Scribble` component: the `DefaultScribble` no longer
    uses our freehand tech and is a simple path instead. We pass down the
    tldraw-flavored scribble via `components`.
    
    The `ExternalContentManager` (`Editor.externalContentManager`) is
    removed and replaced with a mapping of types to handlers.
    
    - Register new content handlers with
    `Editor.registerExternalContentHandler`.
    - Register new asset creation handlers (for files and URLs) with
    `Editor.registerExternalAssetHandler`
    
    ### Change Type
    
    - [x] `major` ‚Äî Breaking change
    
    ### Test Plan
    
    - [x] Unit Tests
    - [x] End to end tests
    
    ### Release Notes
    
    - [@tldraw/editor] lots, wip
    - [@tldraw/ui] gone, merged to tldraw/tldraw
    - [@tldraw/polyfills] gone, merged to tldraw/editor
    - [@tldraw/primitives] gone, merged to tldraw/editor / tldraw/tldraw
    - [@tldraw/indices] gone, merged to tldraw/editor
    - [@tldraw/file-format] gone, merged to tldraw/tldraw
    
    ---------
    
    Co-authored-by: alex <alex@dytry.ch>

diff --git a/packages/editor/src/lib/hooks/useDocumentEvents.ts b/packages/editor/src/lib/hooks/useDocumentEvents.ts
index 276cb763e..47c6bfa2f 100644
--- a/packages/editor/src/lib/hooks/useDocumentEvents.ts
+++ b/packages/editor/src/lib/hooks/useDocumentEvents.ts
@@ -15,7 +15,7 @@ export function useDocumentEvents() {
 		if (typeof matchMedia !== undefined) return
 
 		function updateDevicePixelRatio() {
-			editor.setDevicePixelRatio(window.devicePixelRatio)
+			editor.devicePixelRatio = window.devicePixelRatio
 		}
 
 		const MM = matchMedia(`(resolution: ${window.devicePixelRatio}dppx)`)

commit 3e31ef2a7d01467ef92ca4f7aed13ee708db73ef
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Tue Jul 18 22:50:23 2023 +0100

    Remove helpers / extraneous API methods. (#1745)
    
    This PR removes several extraneous computed values from the editor. It
    adds some silly instance state onto the instance state record and
    unifies a few methods which were inconsistent. This is fit and finish
    work üßΩ
    
    ## Computed Values
    
    In general, where once we had a getter and setter for `isBlahMode`,
    which really masked either an `_isBlahMode` atom on the editor or
    `instanceState.isBlahMode`, these are merged into `instanceState`; they
    can be accessed / updated via `editor.instanceState` /
    `editor.updateInstanceState`.
    
    ## tldraw select tool specific things
    
    This PR also removes some tldraw specific state checks and creates new
    component overrides to allow us to include them in tldraw/tldraw.
    
    ### Change Type
    
    - [x] `major` ‚Äî Breaking change
    
    ### Test Plan
    
    - [x] Unit Tests
    - [x] End to end tests
    
    ### Release Notes
    
    - [tldraw] rename `useReadonly` to `useReadOnly`
    - [editor] remove `Editor.isDarkMode`
    - [editor] remove `Editor.isChangingStyle`
    - [editor] remove `Editor.isCoarsePointer`
    - [editor] remove `Editor.isDarkMode`
    - [editor] remove `Editor.isFocused`
    - [editor] remove `Editor.isGridMode`
    - [editor] remove `Editor.isPenMode`
    - [editor] remove `Editor.isReadOnly`
    - [editor] remove `Editor.isSnapMode`
    - [editor] remove `Editor.isToolLocked`
    - [editor] remove `Editor.locale`
    - [editor] rename `Editor.pageState` to `Editor.currentPageState`
    - [editor] add `Editor.pageStates`
    - [editor] add `Editor.setErasingIds`
    - [editor] add `Editor.setEditingId`
    - [editor] add several new component overrides

diff --git a/packages/editor/src/lib/hooks/useDocumentEvents.ts b/packages/editor/src/lib/hooks/useDocumentEvents.ts
index 47c6bfa2f..f2e0aed04 100644
--- a/packages/editor/src/lib/hooks/useDocumentEvents.ts
+++ b/packages/editor/src/lib/hooks/useDocumentEvents.ts
@@ -9,13 +9,13 @@ export function useDocumentEvents() {
 	const editor = useEditor()
 	const container = useContainer()
 
-	const isAppFocused = useValue('isFocused', () => editor.isFocused, [editor])
+	const isAppFocused = useValue('isFocused', () => editor.instanceState.isFocused, [editor])
 
 	useEffect(() => {
 		if (typeof matchMedia !== undefined) return
 
 		function updateDevicePixelRatio() {
-			editor.devicePixelRatio = window.devicePixelRatio
+			editor.updateInstanceState({ devicePixelRatio: window.devicePixelRatio })
 		}
 
 		const MM = matchMedia(`(resolution: ${window.devicePixelRatio}dppx)`)
@@ -78,7 +78,7 @@ export function useDocumentEvents() {
 						if (!editor.inputs.keys.has('Comma')) {
 							const { x, y, z } = editor.inputs.currentScreenPoint
 							const {
-								pageState: { hoveredId },
+								currentPageState: { hoveredId },
 							} = editor
 							editor.inputs.keys.add('Comma')
 
@@ -91,7 +91,7 @@ export function useDocumentEvents() {
 								ctrlKey: e.metaKey || e.ctrlKey,
 								pointerId: 0,
 								button: 0,
-								isPen: editor.isPenMode,
+								isPen: editor.instanceState.isPenMode,
 								...(hoveredId
 									? {
 											target: 'shape',
@@ -156,7 +156,7 @@ export function useDocumentEvents() {
 				if (editor.inputs.keys.has(e.code)) {
 					const { x, y, z } = editor.inputs.currentScreenPoint
 					const {
-						pageState: { hoveredId },
+						currentPageState: { hoveredId },
 					} = editor
 
 					editor.inputs.keys.delete(e.code)
@@ -170,7 +170,7 @@ export function useDocumentEvents() {
 						ctrlKey: e.metaKey || e.ctrlKey,
 						pointerId: 0,
 						button: 0,
-						isPen: editor.isPenMode,
+						isPen: editor.instanceState.isPenMode,
 						...(hoveredId
 							? {
 									target: 'shape',

commit b22ea7cd4e6c27dcebd6615daa07116ecacbf554
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Wed Jul 19 11:52:21 2023 +0100

    More cleanup, focus bug fixes (#1749)
    
    This PR is another grab bag:
    - renames `readOnly` to `readonly` throughout editor
    - fixes a regression related to focus and keyboard shortcuts
    - adds a small outline for focused editors
    
    ### Change Type
    
    - [x] `major`
    
    ### Test Plan
    
    - [x] End to end tests

diff --git a/packages/editor/src/lib/hooks/useDocumentEvents.ts b/packages/editor/src/lib/hooks/useDocumentEvents.ts
index f2e0aed04..5a58b5c8c 100644
--- a/packages/editor/src/lib/hooks/useDocumentEvents.ts
+++ b/packages/editor/src/lib/hooks/useDocumentEvents.ts
@@ -32,6 +32,7 @@ export function useDocumentEvents() {
 		const handleKeyDown = (e: KeyboardEvent) => {
 			if (
 				e.altKey &&
+				// todo: When should we allow the alt key to be used? Perhaps states should declare which keys matter to them?
 				(editor.isIn('zoom') || !editor.root.path.value.endsWith('.idle')) &&
 				!isFocusingInput()
 			) {
@@ -45,21 +46,14 @@ export function useDocumentEvents() {
 			;(e as any).isKilled = true
 
 			switch (e.key) {
-				case '=': {
-					if (e.metaKey || e.ctrlKey) {
-						preventDefault(e)
-						return
-					}
-					break
-				}
-				case '-': {
-					if (e.metaKey || e.ctrlKey) {
-						preventDefault(e)
-						return
-					}
-					break
-				}
+				case '=':
+				case '-':
 				case '0': {
+					// These keys are used for zooming. Technically we only use
+					// the + - and 0 keys, however it's common for them to be
+					// paired with modifier keys (command / control) so we need
+					// to prevent the browser's regular actions (i.e. zooming
+					// the page). A user can zoom by unfocusing the editor.
 					if (e.metaKey || e.ctrlKey) {
 						preventDefault(e)
 						return
@@ -73,6 +67,9 @@ export function useDocumentEvents() {
 					break
 				}
 				case ',': {
+					// todo: extract to extension
+					// This seems very fragile; the comma key here is used to send pointer events,
+					// but that means it also needs to know about pen mode, hovered ids, etc.
 					if (!isFocusingInput()) {
 						preventDefault(e)
 						if (!editor.inputs.keys.has('Comma')) {

commit d750da8f40efda4b011a91962ef8f30c63d1e5da
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Tue Jul 25 17:10:15 2023 +0100

    `ShapeUtil.getGeometry`, selection rewrite (#1751)
    
    This PR is a significant rewrite of our selection / hit testing logic.
    
    It
    - replaces our current geometric helpers (`getBounds`, `getOutline`,
    `hitTestPoint`, and `hitTestLineSegment`) with a new geometry API
    - moves our hit testing entirely to JS using geometry
    - improves selection logic, especially around editing shapes, groups and
    frames
    - fixes many minor selection bugs (e.g. shapes behind frames)
    - removes hit-testing DOM elements from ShapeFill etc.
    - adds many new tests around selection
    - adds new tests around selection
    - makes several superficial changes to surface editor APIs
    
    This PR is hard to evaluate. The `selection-omnibus` test suite is
    intended to describe all of the selection behavior, however all existing
    tests are also either here preserved and passing or (in a few cases
    around editing shapes) are modified to reflect the new behavior.
    
    ## Geometry
    
    All `ShapeUtils` implement `getGeometry`, which returns a single
    geometry primitive (`Geometry2d`). For example:
    
    ```ts
    class BoxyShapeUtil {
      getGeometry(shape: BoxyShape) {
        return new Rectangle2d({
            width: shape.props.width,
            height: shape.props.height,
            isFilled: true,
            margin: shape.props.strokeWidth
          })
        }
    }
    ```
    
    This geometric primitive is used for all bounds calculation, hit
    testing, intersection with arrows, etc.
    
    There are several geometric primitives that extend `Geometry2d`:
    - `Arc2d`
    - `Circle2d`
    - `CubicBezier2d`
    - `CubicSpline2d`
    - `Edge2d`
    - `Ellipse2d`
    - `Group2d`
    - `Polygon2d`
    - `Rectangle2d`
    - `Stadium2d`
    
    For shapes that have more complicated geometric representations, such as
    an arrow with a label, the `Group2d` can accept other primitives as its
    children.
    
    ## Hit testing
    
    Previously, we did all hit testing via events set on shapes and other
    elements. In this PR, I've replaced those hit tests with our own
    calculation for hit tests in JavaScript. This removed the need for many
    DOM elements, such as hit test area borders and fills which only existed
    to trigger pointer events.
    
    ## Selection
    
    We now support selecting "hollow" shapes by clicking inside of them.
    This involves a lot of new logic but it should work intuitively. See
    `Editor.getShapeAtPoint` for the (thoroughly commented) implementation.
    
    ![Kapture 2023-07-23 at 23 27
    27](https://github.com/tldraw/tldraw/assets/23072548/a743275c-acdb-42d9-a3fe-b3e20dce86b6)
    
    every sunset is actually the sun hiding in fear and respect of tldraw's
    quality of interactions
    
    This PR also fixes several bugs with scribble selection, in particular
    around the shift key modifier.
    
    ![Kapture 2023-07-24 at 23 34
    07](https://github.com/tldraw/tldraw/assets/23072548/871d67d0-8d06-42ae-a2b2-021effba37c5)
    
    ...as well as issues with labels and editing.
    
    There are **over 100 new tests** for selection covering groups, frames,
    brushing, scribbling, hovering, and editing. I'll add a few more before
    I feel comfortable merging this PR.
    
    ## Arrow binding
    
    Using the same "hollow shape" logic as selection, arrow binding is
    significantly improved.
    
    ![Kapture 2023-07-22 at 07 46
    25](https://github.com/tldraw/tldraw/assets/23072548/5aa724b3-b57d-4fb7-92d0-80e34246753c)
    
    a thousand wise men could not improve on this
    
    ## Moving focus between editing shapes
    
    Previously, this was handled in the `editing_shapes` state. This is
    moved to `useEditableText`, and should generally be considered an
    advanced implementation detail on a shape-by-shape basis. This addresses
    a bug that I'd never noticed before, but which can be reproduced by
    selecting an shape‚Äîbut not focusing its input‚Äîwhile editing a different
    shape. Previously, the new shape became the editing shape but its input
    did not focus.
    
    ![Kapture 2023-07-23 at 23 19
    09](https://github.com/tldraw/tldraw/assets/23072548/a5e157fb-24a8-42bd-a692-04ce769b1a9c)
    
    In this PR, you can select a shape by clicking on its edge or body, or
    select its input to transfer editing / focus.
    
    ![Kapture 2023-07-23 at 23 22
    21](https://github.com/tldraw/tldraw/assets/23072548/7384e7ea-9777-4e1a-8f63-15de2166a53a)
    
    tldraw, glorious tldraw
    
    ### Change Type
    
    - [x] `major` ‚Äî Breaking change
    
    ### Test Plan
    
    1. Erase shapes
    2. Select shapes
    3. Calculate their bounding boxes
    
    - [ ] Unit Tests // todo
    - [ ] End to end tests // todo
    
    ### Release Notes
    
    - [editor] Remove `ShapeUtil.getBounds`, `ShapeUtil.getOutline`,
    `ShapeUtil.hitTestPoint`, `ShapeUtil.hitTestLineSegment`
    - [editor] Add `ShapeUtil.getGeometry`
    - [editor] Add `Editor.getShapeGeometry`

diff --git a/packages/editor/src/lib/hooks/useDocumentEvents.ts b/packages/editor/src/lib/hooks/useDocumentEvents.ts
index 5a58b5c8c..c94c600c8 100644
--- a/packages/editor/src/lib/hooks/useDocumentEvents.ts
+++ b/packages/editor/src/lib/hooks/useDocumentEvents.ts
@@ -74,9 +74,6 @@ export function useDocumentEvents() {
 						preventDefault(e)
 						if (!editor.inputs.keys.has('Comma')) {
 							const { x, y, z } = editor.inputs.currentScreenPoint
-							const {
-								currentPageState: { hoveredId },
-							} = editor
 							editor.inputs.keys.add('Comma')
 
 							const info: TLPointerEventInfo = {
@@ -89,14 +86,7 @@ export function useDocumentEvents() {
 								pointerId: 0,
 								button: 0,
 								isPen: editor.instanceState.isPenMode,
-								...(hoveredId
-									? {
-											target: 'shape',
-											shape: editor.getShapeById(hoveredId)!,
-									  }
-									: {
-											target: 'canvas',
-									  }),
+								target: 'canvas',
 							}
 
 							editor.dispatch(info)
@@ -152,9 +142,6 @@ export function useDocumentEvents() {
 				if (document.activeElement?.ELEMENT_NODE) preventDefault(e)
 				if (editor.inputs.keys.has(e.code)) {
 					const { x, y, z } = editor.inputs.currentScreenPoint
-					const {
-						currentPageState: { hoveredId },
-					} = editor
 
 					editor.inputs.keys.delete(e.code)
 
@@ -168,14 +155,7 @@ export function useDocumentEvents() {
 						pointerId: 0,
 						button: 0,
 						isPen: editor.instanceState.isPenMode,
-						...(hoveredId
-							? {
-									target: 'shape',
-									shape: editor.getShapeById(hoveredId)!,
-							  }
-							: {
-									target: 'canvas',
-							  }),
+						target: 'canvas',
 					}
 					editor.dispatch(info)
 					return

commit 930abaf5d726e64b277e29805d794271215691ba
Author: Brian Hung <brianlhung@gmail.com>
Date:   Fri Sep 8 03:47:14 2023 -0700

    avoid pixel rounding / transformation miscalc for overlay items (#1858)
    
    Fixes pixel rounding when calculating css transformations for overlay
    items. Also fixes issue where `editor.instanceState.devicePixelRatio`
    wasn't properly updating.
    
    TLDR; `width * window.devicePixelRatio` should be integer to avoid
    rounding. `--tl-dpr-multiple` is smallest integer to multiply
    `window.devicePixelRatio` such that its product is an integer.
    
    #1852
    #1836
    #1834
    
    ### Change Type
    
    - [x] `patch` ‚Äî Bug fix
    - [ ] `minor` ‚Äî New feature
    - [ ] `major` ‚Äî Breaking change
    - [ ] `dependencies` ‚Äî Changes to package dependencies[^1]
    - [ ] `documentation` ‚Äî Changes to the documentation only[^2]
    - [ ] `tests` ‚Äî Changes to any test code only[^2]
    - [ ] `internal` ‚Äî Any other changes that don't affect the published
    package[^2]
    - [ ] I don't know
    
    [^1]: publishes a `patch` release, for devDependencies use `internal`
    [^2]: will not publish a new version
    
    ### Test Plan
    
    Would need to add a test checking when `window.devicePixelRatio`
    changes, that `editor.instanceState.devicePixelRatio` is equal.
    
    ---------
    
    Co-authored-by: David Sheldrick <d.j.sheldrick@gmail.com>

diff --git a/packages/editor/src/lib/hooks/useDocumentEvents.ts b/packages/editor/src/lib/hooks/useDocumentEvents.ts
index c94c600c8..281c661b3 100644
--- a/packages/editor/src/lib/hooks/useDocumentEvents.ts
+++ b/packages/editor/src/lib/hooks/useDocumentEvents.ts
@@ -12,17 +12,24 @@ export function useDocumentEvents() {
 	const isAppFocused = useValue('isFocused', () => editor.instanceState.isFocused, [editor])
 
 	useEffect(() => {
-		if (typeof matchMedia !== undefined) return
-
-		function updateDevicePixelRatio() {
+		if (typeof matchMedia === undefined) return
+		// https://developer.mozilla.org/en-US/docs/Web/API/Window/devicePixelRatio#monitoring_screen_resolution_or_zoom_level_changes
+		let remove: (() => void) | null = null
+		const updatePixelRatio = () => {
+			if (remove != null) {
+				remove()
+			}
+			const mqString = `(resolution: ${window.devicePixelRatio}dppx)`
+			const media = matchMedia(mqString)
+			media.addEventListener('change', updatePixelRatio)
+			remove = () => {
+				media.removeEventListener('change', updatePixelRatio)
+			}
 			editor.updateInstanceState({ devicePixelRatio: window.devicePixelRatio })
 		}
-
-		const MM = matchMedia(`(resolution: ${window.devicePixelRatio}dppx)`)
-
-		MM.addEventListener('change', updateDevicePixelRatio)
+		updatePixelRatio()
 		return () => {
-			MM.removeEventListener('change', updateDevicePixelRatio)
+			remove?.()
 		}
 	}, [editor])
 

commit 20704ea41768f0746480bd840b008ecda9778627
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Sat Sep 9 10:41:06 2023 +0100

    [fix] iframe losing focus on pointer down (#1848)
    
    This PR fixes a bug that would cause an interactive iframe (e.g. a
    youtube video) to lose its editing state once clicked.
    
    ### Change Type
    
    - [x] `patch` ‚Äî Bug fix
    
    ### Test Plan
    
    1. Create an interactive iframe.
    2. Begin editing.
    3. Click inside of the iframe

diff --git a/packages/editor/src/lib/hooks/useDocumentEvents.ts b/packages/editor/src/lib/hooks/useDocumentEvents.ts
index 281c661b3..9524dfe5a 100644
--- a/packages/editor/src/lib/hooks/useDocumentEvents.ts
+++ b/packages/editor/src/lib/hooks/useDocumentEvents.ts
@@ -214,14 +214,6 @@ export function useDocumentEvents() {
 			}
 		}
 
-		function handleBlur() {
-			editor.complete()
-		}
-
-		function handleFocus() {
-			editor.updateViewportScreenBounds()
-		}
-
 		container.addEventListener('touchstart', handleTouchStart, { passive: false })
 
 		container.addEventListener('wheel', handleWheel, { passive: false })
@@ -233,9 +225,6 @@ export function useDocumentEvents() {
 		container.addEventListener('keydown', handleKeyDown)
 		container.addEventListener('keyup', handleKeyUp)
 
-		window.addEventListener('blur', handleBlur)
-		window.addEventListener('focus', handleFocus)
-
 		return () => {
 			container.removeEventListener('touchstart', handleTouchStart)
 
@@ -247,9 +236,6 @@ export function useDocumentEvents() {
 
 			container.removeEventListener('keydown', handleKeyDown)
 			container.removeEventListener('keyup', handleKeyUp)
-
-			window.removeEventListener('blur', handleBlur)
-			window.removeEventListener('focus', handleFocus)
 		}
 	}, [editor, container, isAppFocused])
 }

commit 2694a7ab48582b5a00f52600550f5635cc968fef
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Mon Oct 2 16:24:43 2023 +0100

    [fix] Escape key exiting full screen while editing shapes (#1986)
    
    This PR prevents the escape key from exiting full screen when a shape is
    being edited or when shapes are selected. Basically, if the select tool
    is going to use the escape key, then don't let it be used for its normal
    purpose.
    
    ### Change Type
    
    - [x] `patch` ‚Äî Bug fix
    
    ### Test Plan
    
    1. Open a firefox full screen tab.
    2. Start editing a text shape.
    3. Press escape. It should stop editing.
    4. Press escape again. It should deselect the shape.
    5. Press escape again. It should exit full screen mode.

diff --git a/packages/editor/src/lib/hooks/useDocumentEvents.ts b/packages/editor/src/lib/hooks/useDocumentEvents.ts
index 9524dfe5a..9293a0609 100644
--- a/packages/editor/src/lib/hooks/useDocumentEvents.ts
+++ b/packages/editor/src/lib/hooks/useDocumentEvents.ts
@@ -103,6 +103,17 @@ export function useDocumentEvents() {
 					break
 				}
 				case 'Escape': {
+					// In certain browsers, pressing escape while in full screen mode
+					// will exit full screen mode. We want to allow that, but not when
+					// escape is being handled by the editor. When a user has an editing
+					// shape, escape stops editing. When a user is using a tool, escape
+					// returns to the select tool. When the user has selected shapes,
+					// escape de-selects them. Only when the user's selection is empty
+					// should we allow escape to do its normal thing.
+					if (editor.editingShape || editor.selectedShapeIds.length > 0) {
+						e.preventDefault()
+					}
+
 					if (!editor.inputs.keys.has('Escape')) {
 						editor.inputs.keys.add('Escape')
 
@@ -125,7 +136,7 @@ export function useDocumentEvents() {
 
 			const info: TLKeyboardEventInfo = {
 				type: 'keyboard',
-				name: editor.inputs.keys.has(e.code) ? 'key_repeat' : 'key_down',
+				name: e.repeat ? 'key_repeat' : 'key_down',
 				key: e.key,
 				code: e.code,
 				shiftKey: e.shiftKey,

commit 3b7acb8997ae2cef0ce0a443685c76b51c112d2f
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Tue Oct 17 14:06:53 2023 +0100

    [fix] Context menu + menus not closing correctly (#2086)
    
    This PR fixes a bug that causes menus not to close correctly when open.
    
    ### Change Type
    
    - [x] `patch` ‚Äî Bug fix
    
    ### Test Plan
    
    1. On mobile, open the menu.
    2. Tap the canvas‚Äîit should close the panel.
    3. Open the mobile style panel.
    4. Tap the canvas‚Äîit should close the panel.
    5. Open the mobile style panel.
    6. Tap the mobile style panel button‚Äîit should close the panel.
    7. On mobile, long press to open the context menu
    
    ### Release Notes
    
    - [fix] bug with menus

diff --git a/packages/editor/src/lib/hooks/useDocumentEvents.ts b/packages/editor/src/lib/hooks/useDocumentEvents.ts
index 9293a0609..e63aefb50 100644
--- a/packages/editor/src/lib/hooks/useDocumentEvents.ts
+++ b/packages/editor/src/lib/hooks/useDocumentEvents.ts
@@ -110,10 +110,14 @@ export function useDocumentEvents() {
 					// returns to the select tool. When the user has selected shapes,
 					// escape de-selects them. Only when the user's selection is empty
 					// should we allow escape to do its normal thing.
+
 					if (editor.editingShape || editor.selectedShapeIds.length > 0) {
 						e.preventDefault()
 					}
 
+					// Don't do anything if we open menus open
+					if (editor.openMenus.length > 0) return
+
 					if (!editor.inputs.keys.has('Escape')) {
 						editor.inputs.keys.add('Escape')
 

commit bc832bae6f529f420e725b906041ff90642f620e
Author: Mitja Bezen≈°ek <mitja.bezensek@gmail.com>
Date:   Tue Oct 24 21:47:12 2023 +0200

    Fix an issue with `addEventListener` in old Safari (pre v14) (#2114)
    
    Seems Safari only added `MediaQueryList: change event` in version 14.
    This is a workaround for older versions.
    
    https://developer.mozilla.org/en-US/docs/Web/API/MediaQueryList/change_event
    
    Reported here
    
    https://discord.com/channels/859816885297741824/926464446694580275/1166028196832092282
    
    ### Change Type
    
    - [x] `patch` ‚Äî Bug fix
    - [ ] `minor` ‚Äî New feature
    - [ ] `major` ‚Äî Breaking change
    - [ ] `dependencies` ‚Äî Changes to package dependencies[^1]
    - [ ] `documentation` ‚Äî Changes to the documentation only[^2]
    - [ ] `tests` ‚Äî Changes to any test code only[^2]
    - [ ] `internal` ‚Äî Any other changes that don't affect the published
    package[^2]
    - [ ] I don't know
    
    [^1]: publishes a `patch` release, for devDependencies use `internal`
    [^2]: will not publish a new version
    
    ### Release Notes
    
    - Fixes an issue with `addEventListener` on MediaQueryList object in old
    versions of Safari.

diff --git a/packages/editor/src/lib/hooks/useDocumentEvents.ts b/packages/editor/src/lib/hooks/useDocumentEvents.ts
index e63aefb50..8aae008a1 100644
--- a/packages/editor/src/lib/hooks/useDocumentEvents.ts
+++ b/packages/editor/src/lib/hooks/useDocumentEvents.ts
@@ -21,9 +21,24 @@ export function useDocumentEvents() {
 			}
 			const mqString = `(resolution: ${window.devicePixelRatio}dppx)`
 			const media = matchMedia(mqString)
-			media.addEventListener('change', updatePixelRatio)
+			// Safari only started supporting `addEventListener('change',...) in version 14
+			// https://developer.mozilla.org/en-US/docs/Web/API/MediaQueryList/change_event
+			const safariCb = (ev: any) => {
+				if (ev.type === 'change') {
+					updatePixelRatio()
+				}
+			}
+			if (media.addEventListener) {
+				media.addEventListener('change', updatePixelRatio)
+			} else if (media.addListener) {
+				media.addListener(safariCb)
+			}
 			remove = () => {
-				media.removeEventListener('change', updatePixelRatio)
+				if (media.removeEventListener) {
+					media.removeEventListener('change', updatePixelRatio)
+				} else if (media.removeListener) {
+					media.removeListener(safariCb)
+				}
 			}
 			editor.updateInstanceState({ devicePixelRatio: window.devicePixelRatio })
 		}

commit 5db3c1553e14edd14aa5f7c0fc85fc5efc352335
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Mon Nov 13 11:51:22 2023 +0000

    Replace Atom.value with Atom.get() (#2189)
    
    This PR replaces the `.value` getter for the atom with `.get()`
    
    ### Change Type
    
    - [x] `major` ‚Äî Breaking change
    
    ---------
    
    Co-authored-by: David Sheldrick <d.j.sheldrick@gmail.com>

diff --git a/packages/editor/src/lib/hooks/useDocumentEvents.ts b/packages/editor/src/lib/hooks/useDocumentEvents.ts
index 8aae008a1..b442aa8d1 100644
--- a/packages/editor/src/lib/hooks/useDocumentEvents.ts
+++ b/packages/editor/src/lib/hooks/useDocumentEvents.ts
@@ -9,7 +9,7 @@ export function useDocumentEvents() {
 	const editor = useEditor()
 	const container = useContainer()
 
-	const isAppFocused = useValue('isFocused', () => editor.instanceState.isFocused, [editor])
+	const isAppFocused = useValue('isFocused', () => editor.getInstanceState().isFocused, [editor])
 
 	useEffect(() => {
 		if (typeof matchMedia === undefined) return
@@ -55,7 +55,7 @@ export function useDocumentEvents() {
 			if (
 				e.altKey &&
 				// todo: When should we allow the alt key to be used? Perhaps states should declare which keys matter to them?
-				(editor.isIn('zoom') || !editor.root.path.value.endsWith('.idle')) &&
+				(editor.isIn('zoom') || !editor.root.path.get().endsWith('.idle')) &&
 				!isFocusingInput()
 			) {
 				// On windows the alt key opens the menu bar.
@@ -107,7 +107,7 @@ export function useDocumentEvents() {
 								ctrlKey: e.metaKey || e.ctrlKey,
 								pointerId: 0,
 								button: 0,
-								isPen: editor.instanceState.isPenMode,
+								isPen: editor.getInstanceState().isPenMode,
 								target: 'canvas',
 							}
 
@@ -131,7 +131,7 @@ export function useDocumentEvents() {
 					}
 
 					// Don't do anything if we open menus open
-					if (editor.openMenus.length > 0) return
+					if (editor.getOpenMenus().length > 0) return
 
 					if (!editor.inputs.keys.has('Escape')) {
 						editor.inputs.keys.add('Escape')
@@ -191,7 +191,7 @@ export function useDocumentEvents() {
 						ctrlKey: e.metaKey || e.ctrlKey,
 						pointerId: 0,
 						button: 0,
-						isPen: editor.instanceState.isPenMode,
+						isPen: editor.getInstanceState().isPenMode,
 						target: 'canvas',
 					}
 					editor.dispatch(info)

commit 2ca2f81f2aac16790c73bd334eda53a35a9d9f45
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Mon Nov 13 12:42:07 2023 +0000

    No impure getters pt2 (#2202)
    
    follow up to #2189

diff --git a/packages/editor/src/lib/hooks/useDocumentEvents.ts b/packages/editor/src/lib/hooks/useDocumentEvents.ts
index b442aa8d1..f973269aa 100644
--- a/packages/editor/src/lib/hooks/useDocumentEvents.ts
+++ b/packages/editor/src/lib/hooks/useDocumentEvents.ts
@@ -83,7 +83,7 @@ export function useDocumentEvents() {
 					break
 				}
 				case 'Tab': {
-					if (isFocusingInput() || editor.isMenuOpen) {
+					if (isFocusingInput() || editor.getIsMenuOpen()) {
 						return
 					}
 					break
@@ -126,7 +126,7 @@ export function useDocumentEvents() {
 					// escape de-selects them. Only when the user's selection is empty
 					// should we allow escape to do its normal thing.
 
-					if (editor.editingShape || editor.selectedShapeIds.length > 0) {
+					if (editor.editingShape || editor.getSelectedShapeIds().length > 0) {
 						e.preventDefault()
 					}
 
@@ -147,7 +147,7 @@ export function useDocumentEvents() {
 					return
 				}
 				default: {
-					if (isFocusingInput() || editor.isMenuOpen) {
+					if (isFocusingInput() || editor.getIsMenuOpen()) {
 						return
 					}
 				}
@@ -170,7 +170,7 @@ export function useDocumentEvents() {
 			if ((e as any).isKilled) return
 			;(e as any).isKilled = true
 
-			if (isFocusingInput() || editor.isMenuOpen) {
+			if (isFocusingInput() || editor.getIsMenuOpen()) {
 				return
 			}
 

commit daf729d45c879d4e234d9417570149ad854f635b
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Mon Nov 13 16:02:50 2023 +0000

    No impure getters pt4 (#2206)
    
    follow up to #2189 and #2203
    
    ### Change Type
    
    - [x] `patch` ‚Äî Bug fix

diff --git a/packages/editor/src/lib/hooks/useDocumentEvents.ts b/packages/editor/src/lib/hooks/useDocumentEvents.ts
index f973269aa..c383059c0 100644
--- a/packages/editor/src/lib/hooks/useDocumentEvents.ts
+++ b/packages/editor/src/lib/hooks/useDocumentEvents.ts
@@ -126,7 +126,7 @@ export function useDocumentEvents() {
 					// escape de-selects them. Only when the user's selection is empty
 					// should we allow escape to do its normal thing.
 
-					if (editor.editingShape || editor.getSelectedShapeIds().length > 0) {
+					if (editor.getEditingShape() || editor.getSelectedShapeIds().length > 0) {
 						e.preventDefault()
 					}
 

commit 6f872c796afd6cf538ce81d35c5a40dcccbe7013
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Tue Nov 14 11:57:43 2023 +0000

    No impure getters pt6 (#2218)
    
    follow up to #2189
    
    ### Change Type
    
    - [x] `patch` ‚Äî Bug fix

diff --git a/packages/editor/src/lib/hooks/useDocumentEvents.ts b/packages/editor/src/lib/hooks/useDocumentEvents.ts
index c383059c0..fe58b7925 100644
--- a/packages/editor/src/lib/hooks/useDocumentEvents.ts
+++ b/packages/editor/src/lib/hooks/useDocumentEvents.ts
@@ -225,7 +225,7 @@ export function useDocumentEvents() {
 				// touchstart event in that case.
 				if (
 					touchXPosition - touchXRadius < 10 ||
-					touchXPosition + touchXRadius > editor.viewportScreenBounds.width - 10
+					touchXPosition + touchXRadius > editor.getViewportScreenBounds().width - 10
 				) {
 					if ((e.target as HTMLElement)?.tagName === 'BUTTON') {
 						// Force a click before bailing

commit 7186368f0d4cb7fbe59a59ffa4265908e8f48eae
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Tue Nov 14 13:02:50 2023 +0000

    StateNode atoms (#2213)
    
    This PR extracts some improvements from #2198 into a separate PR.
    
    ### Release Notes
    - adds computed `StateNode.getPath`
    - adds computed StateNode.getCurrent`
    - adds computed StateNode.getIsActive`
    - adds computed `Editor.getPath()`
    - makes transition's second property optional
    
    ### Change Type
    
    - [x] `minor` ‚Äî New feature
    
    ### Test Plan
    
    - [x] Unit Tests
    - [x] End to end tests

diff --git a/packages/editor/src/lib/hooks/useDocumentEvents.ts b/packages/editor/src/lib/hooks/useDocumentEvents.ts
index fe58b7925..b945493f5 100644
--- a/packages/editor/src/lib/hooks/useDocumentEvents.ts
+++ b/packages/editor/src/lib/hooks/useDocumentEvents.ts
@@ -55,7 +55,7 @@ export function useDocumentEvents() {
 			if (
 				e.altKey &&
 				// todo: When should we allow the alt key to be used? Perhaps states should declare which keys matter to them?
-				(editor.isIn('zoom') || !editor.root.path.get().endsWith('.idle')) &&
+				(editor.isIn('zoom') || !editor.root.getPath().endsWith('.idle')) &&
 				!isFocusingInput()
 			) {
 				// On windows the alt key opens the menu bar.

commit 14e8d19a713fb21c3f976a15cdbdf0dd05167366
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Wed Nov 15 18:06:02 2023 +0000

    Custom Tools DX + screenshot example (#2198)
    
    This PR adds a custom tool example, the `Screenshot Tool`.
    
    It demonstrates how a user can create a custom tool together with custom
    tool UI.
    
    ### Change Type
    
    - [x] `minor` ‚Äî New feature
    
    ### Test Plan
    
    1. Use the screenshot example
    
    ### Release Notes
    
    - adds ScreenshotTool custom tool example
    - improvements and new exports related to copying and exporting images /
    files
    - loosens up types around icons and translations
    - moving `StateNode.isActive` into an atom
    - adding `Editor.path`

diff --git a/packages/editor/src/lib/hooks/useDocumentEvents.ts b/packages/editor/src/lib/hooks/useDocumentEvents.ts
index b945493f5..829f87afc 100644
--- a/packages/editor/src/lib/hooks/useDocumentEvents.ts
+++ b/packages/editor/src/lib/hooks/useDocumentEvents.ts
@@ -55,7 +55,7 @@ export function useDocumentEvents() {
 			if (
 				e.altKey &&
 				// todo: When should we allow the alt key to be used? Perhaps states should declare which keys matter to them?
-				(editor.isIn('zoom') || !editor.root.getPath().endsWith('.idle')) &&
+				(editor.isIn('zoom') || !editor.getPath().endsWith('.idle')) &&
 				!isFocusingInput()
 			) {
 				// On windows the alt key opens the menu bar.

commit 34cfb85169e02178a20dd9e7b7c0c4e48b1428c4
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Thu Nov 16 15:34:56 2023 +0000

    no impure getters pt 11 (#2236)
    
    follow up to #2189
    
    adds runtime warnings for deprecated fields. cleans up remaining fields
    and usages. Adds a lint rule to prevent access to deprecated fields.
    Adds a lint rule to prevent using getters.
    
    ### Change Type
    
    - [x] `patch` ‚Äî Bug fix

diff --git a/packages/editor/src/lib/hooks/useDocumentEvents.ts b/packages/editor/src/lib/hooks/useDocumentEvents.ts
index 829f87afc..019b41046 100644
--- a/packages/editor/src/lib/hooks/useDocumentEvents.ts
+++ b/packages/editor/src/lib/hooks/useDocumentEvents.ts
@@ -30,13 +30,17 @@ export function useDocumentEvents() {
 			}
 			if (media.addEventListener) {
 				media.addEventListener('change', updatePixelRatio)
+				// eslint-disable-next-line deprecation/deprecation
 			} else if (media.addListener) {
+				// eslint-disable-next-line deprecation/deprecation
 				media.addListener(safariCb)
 			}
 			remove = () => {
 				if (media.removeEventListener) {
 					media.removeEventListener('change', updatePixelRatio)
+					// eslint-disable-next-line deprecation/deprecation
 				} else if (media.removeListener) {
+					// eslint-disable-next-line deprecation/deprecation
 					media.removeListener(safariCb)
 				}
 			}

commit 6fde34fafd6cac58a736f9c40aa40a61ec26bf35
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Sun Jan 21 14:09:05 2024 +0000

    [improvement] better comma control for pointer (#2568)
    
    This PR fixes a few bugs with the "comma as pointer" feature.
    
    In tldraw, the `,` key can be used as a replacement for "pointer down"
    and "pointer up". This is most useful on laptops with trackpads that
    make dragging inconvenient. (See
    https://github.com/tldraw/tldraw/issues/2550).
    
    Previously, the canvas had to be focused in order for the comma key to
    work. If you clicked on a menu item and then pressed comma, it would not
    product a pointer event until you first clicked on the canvas. This is
    now fixed by moving the listener out of the `useDocumentEvents` and into
    `useKeyboardShortcuts`.
    
    ### Change Type
    
    - [x] `minor` ‚Äî New feature
    
    ### Test Plan
    
    1. Click the canvas.
    2. Use the comma key to control pointer down / up.
    3. Click a shape tool on the toolbar.
    4. Move your mouse over the canvas.
    5. Press the comma key. It should produce a dot / shape / etc
    
    ### Release Notes
    
    - Improve comma key as a replacement for pointer down / pointer up.

diff --git a/packages/editor/src/lib/hooks/useDocumentEvents.ts b/packages/editor/src/lib/hooks/useDocumentEvents.ts
index 019b41046..ef2cbf9ac 100644
--- a/packages/editor/src/lib/hooks/useDocumentEvents.ts
+++ b/packages/editor/src/lib/hooks/useDocumentEvents.ts
@@ -1,6 +1,6 @@
 import { useValue } from '@tldraw/state'
 import { useEffect } from 'react'
-import { TLKeyboardEventInfo, TLPointerEventInfo } from '../editor/types/event-types'
+import { TLKeyboardEventInfo } from '../editor/types/event-types'
 import { preventDefault } from '../utils/dom'
 import { useContainer } from './useContainer'
 import { useEditor } from './useEditor'
@@ -93,33 +93,12 @@ export function useDocumentEvents() {
 					break
 				}
 				case ',': {
-					// todo: extract to extension
-					// This seems very fragile; the comma key here is used to send pointer events,
-					// but that means it also needs to know about pen mode, hovered ids, etc.
-					if (!isFocusingInput()) {
-						preventDefault(e)
-						if (!editor.inputs.keys.has('Comma')) {
-							const { x, y, z } = editor.inputs.currentScreenPoint
-							editor.inputs.keys.add('Comma')
-
-							const info: TLPointerEventInfo = {
-								type: 'pointer',
-								name: 'pointer_down',
-								point: { x, y, z },
-								shiftKey: e.shiftKey,
-								altKey: e.altKey,
-								ctrlKey: e.metaKey || e.ctrlKey,
-								pointerId: 0,
-								button: 0,
-								isPen: editor.getInstanceState().isPenMode,
-								target: 'canvas',
-							}
-
-							editor.dispatch(info)
-							return
-						}
-					}
-					break
+					// this was moved to useKeyBoardShortcuts; it's possible
+					// that the comma key is pressed when the container is not
+					// focused, for example when the user has just interacted
+					// with the toolbar. We need to handle it on the window
+					// (ofc ensuring it's a correct time for a shortcut)
+					return
 				}
 				case 'Escape': {
 					// In certain browsers, pressing escape while in full screen mode
@@ -178,29 +157,8 @@ export function useDocumentEvents() {
 				return
 			}
 
-			// Use the , key to send pointer events
 			if (e.key === ',') {
-				if (document.activeElement?.ELEMENT_NODE) preventDefault(e)
-				if (editor.inputs.keys.has(e.code)) {
-					const { x, y, z } = editor.inputs.currentScreenPoint
-
-					editor.inputs.keys.delete(e.code)
-
-					const info: TLPointerEventInfo = {
-						type: 'pointer',
-						name: 'pointer_up',
-						point: { x, y, z },
-						shiftKey: e.shiftKey,
-						altKey: e.altKey,
-						ctrlKey: e.metaKey || e.ctrlKey,
-						pointerId: 0,
-						button: 0,
-						isPen: editor.getInstanceState().isPenMode,
-						target: 'canvas',
-					}
-					editor.dispatch(info)
-					return
-				}
+				return
 			}
 
 			const info: TLKeyboardEventInfo = {

commit 647d03a173608e3e45493c896b78d7431f3357b8
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Sun Feb 4 12:03:49 2024 +0000

    [Fix] Camera coordinate issues (#2719)
    
    This PR fixes some bugs related to our coordinate systems. These bugs
    would appear when the editor was not full screen.
    
    ![Kapture 2024-02-04 at 11 53
    37](https://github.com/tldraw/tldraw/assets/23072548/9c2199f3-b34d-4fe1-a3e5-d0c65fe5a11e)
    
    In short, we were being inconsistent with whether the
    `currentScreenPoint` was relative to the top left corner of the
    component or the top left corner of the page that contained the
    component.
    
    Here's the actual system:
    
    <img width="898" alt="image"
    src="https://github.com/tldraw/tldraw/assets/23072548/c49b3686-aeb6-4164-a55d-8639d40290a1">
    
    The `viewportPageBounds` describes the bounds of the component within
    the browser's space. Its `x` and `y` describe the delta in browser space
    between the top left corner of the **page** and the component. This is
    not effected by scrolling.
    
    The use's `screenPoint` describes the user's cursor's location relative
    to the `viewportPageBounds`. Its `x` and `y` describe the delta in
    browser space between the top left corner of the **component** and the
    cursor.
    
    While this is a bug fix, I'm marking it as major as apps may be
    depending on the previous (broken) behavior.
    
    ### Change Type
    
    - [x] `major` ‚Äî Breaking change
    
    ### Test Plan
    
    1. Zoom in, out, and pinch on an editor that isn't full screen.
    2. Zoom in, out, and pinch on an editor that is full screen.
    3. Drag and scroll on an editor that isn't full screen.
    4. Drag and scroll on an editor that is full screen.
    
    - [x] Unit Tests
    
    ### Release Notes
    
    - Fixed bugs with `getViewportScreenCenter` that could effect zooming
    and pinching on editors that aren't full screen

diff --git a/packages/editor/src/lib/hooks/useDocumentEvents.ts b/packages/editor/src/lib/hooks/useDocumentEvents.ts
index ef2cbf9ac..6b7fa7b6f 100644
--- a/packages/editor/src/lib/hooks/useDocumentEvents.ts
+++ b/packages/editor/src/lib/hooks/useDocumentEvents.ts
@@ -185,6 +185,7 @@ export function useDocumentEvents() {
 				// if the touch area overlaps with the screen edges
 				// it's likely to trigger the navigation. We prevent the
 				// touchstart event in that case.
+				// todo: make this relative to the actual window, not the editor's screen bounds
 				if (
 					touchXPosition - touchXRadius < 10 ||
 					touchXPosition + touchXRadius > editor.getViewportScreenBounds().width - 10

commit b4c1f606e18e338b16e2386b3cddfb1d2fc2bcff
Author: Mime ƒåuvalo <mimecuvalo@gmail.com>
Date:   Fri May 17 09:53:57 2024 +0100

    focus: rework and untangle existing focus management logic in the sdk (#3718)
    
    Focus management is really scattered across the codebase. There's sort
    of a battle between different code paths to make the focus the correct
    desired state. It seemed to grow like a knot and once I started pulling
    on one thread to see if it was still needed you could see underneath
    that it was accounting for another thing underneath that perhaps wasn't
    needed.
    
    The impetus for this PR came but especially during the text label
    rework, now that it's much more easy to jump around from textfield to
    textfield. It became apparent that we were playing whack-a-mole trying
    to preserve the right focus conditions (especially on iOS, ugh).
    
    This tries to remove as many hacks as possible, and bring together in
    place the focus logic (and in the darkness, bind them).
    
    ## Places affected
    - [x] `useEditableText`: was able to remove a bunch of the focus logic
    here. In addition, it doesn't look like we need to save the selection
    range anymore.
    - lingering footgun that needed to be fixed anyway: if there are two
    labels in the same shape, because we were just checking `editingShapeId
    === id`, the two text labels would have just fought each other for
    control
    - [x] `useFocusEvents`: nixed and refactored ‚Äî we listen to the store in
    `FocusManager` and then take care of autoFocus there
    - [x] `useSafariFocusOutFix`: nixed. not necessary anymore because we're
    not trying to refocus when blurring in `useEditableText`. original PR
    for reference: https://github.com/tldraw/brivate/pull/79
    - [x] `defaultSideEffects`: moved logic to `FocusManager`
    - [x] `PointingShape` focus for `startTranslating`, decided to leave
    this alone actually.
    - [x] `TldrawUIButton`: it doesn't look like this focus bug fix is
    needed anymore, original PR for reference:
    https://github.com/tldraw/tldraw/pull/2630
    - [x] `useDocumentEvents`: left alone its manual focus after the Escape
    key is hit
    - [x] `FrameHeading`: double focus/select doesn't seem necessary anymore
    - [x] `useCanvasEvents`: `onPointerDown` focus logic never happened b/c
    in `Editor.ts` we `clearedMenus` on pointer down
    - [x] `onTouchStart`: looks like `document.body.click()` is not
    necessary anymore
    
    ## Future Changes
    - [ ] a11y: work on having an accessebility focus ring
    - [ ] Page visibility API:
    (https://developer.mozilla.org/en-US/docs/Web/API/Page_Visibility_API)
    events when tab is back in focus vs. background, different kind of focus
    - [ ] Reexamine places we manually dispatch `pointer_down` events to see
    if they're necessary.
    - [ ] Minor: get rid of `useContainer` maybe? Is it really necessary to
    have this hook? you can just do `useEditor` ‚Üí `editor.getContainer()`,
    feels superfluous.
    
    ## Methodology
    Looked for places where we do:
    - `body.click()`
    - places we do `container.focus()`
    - places we do `container.blur()`
    - places we do `editor.updateInstanceState({ isFocused })`
    - places we do `autofocus`
    - searched for `document.activeElement`
    
    ### Change Type
    
    <!-- ‚ùó Please select a 'Scope' label ‚ùóÔ∏è -->
    
    - [x] `sdk` ‚Äî Changes the tldraw SDK
    - [ ] `dotcom` ‚Äî Changes the tldraw.com web app
    - [ ] `docs` ‚Äî Changes to the documentation, examples, or templates.
    - [ ] `vs code` ‚Äî Changes to the vscode plugin
    - [ ] `internal` ‚Äî Does not affect user-facing stuff
    
    <!-- ‚ùó Please select a 'Type' label ‚ùóÔ∏è -->
    
    - [ ] `bugfix` ‚Äî Bug fix
    - [ ] `feature` ‚Äî New feature
    - [x] `improvement` ‚Äî Improving existing features
    - [ ] `chore` ‚Äî Updating dependencies, other boring stuff
    - [ ] `galaxy brain` ‚Äî Architectural changes
    - [ ] `tests` ‚Äî Changes to any test code
    - [ ] `tools` ‚Äî Changes to infrastructure, CI, internal scripts,
    debugging tools, etc.
    - [ ] `dunno` ‚Äî I don't know
    
    
    ### Test Plan
    
    - [x] run test-focus.spec.ts
    - [x] check MultipleExample
    - [x] check EditorFocusExample
    - [x] check autoFocus
    - [x] check style panel usage and focus events in general
    - [x] check text editing focus, lots of different devices,
    mobile/desktop
    
    ### Release Notes
    
    - Focus: rework and untangle existing focus management logic in the SDK

diff --git a/packages/editor/src/lib/hooks/useDocumentEvents.ts b/packages/editor/src/lib/hooks/useDocumentEvents.ts
index 6b7fa7b6f..e8325168b 100644
--- a/packages/editor/src/lib/hooks/useDocumentEvents.ts
+++ b/packages/editor/src/lib/hooks/useDocumentEvents.ts
@@ -125,7 +125,7 @@ export function useDocumentEvents() {
 						// will break additional shortcuts. We need to
 						// refocus the container in order to keep these
 						// shortcuts working.
-						container.focus()
+						editor.focus()
 					}
 					return
 				}

commit aa1c99fee3384ee33daf20b3b1c8754148d7f885
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Thu Jun 27 14:30:18 2024 +0100

    Cleanup z-indices (#4020)
    
    This PR:
    - simplifies a lot of z-index layers
    
    ### Change Type
    
    - [x] `sdk` ‚Äî Changes the tldraw SDK
    - [x] `bugfix` ‚Äî Bug fix
    
    ### Release Notes
    
    - Cleans up z-indexes and removes some unused CSS.

diff --git a/packages/editor/src/lib/hooks/useDocumentEvents.ts b/packages/editor/src/lib/hooks/useDocumentEvents.ts
index e8325168b..d76f8e779 100644
--- a/packages/editor/src/lib/hooks/useDocumentEvents.ts
+++ b/packages/editor/src/lib/hooks/useDocumentEvents.ts
@@ -9,7 +9,7 @@ export function useDocumentEvents() {
 	const editor = useEditor()
 	const container = useContainer()
 
-	const isAppFocused = useValue('isFocused', () => editor.getInstanceState().isFocused, [editor])
+	const isAppFocused = useValue('isFocused', () => editor.getIsFocused(), [editor])
 
 	useEffect(() => {
 		if (typeof matchMedia === undefined) return

commit 7ba4040e840fcf6e2972edf9b4ae318438039f21
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Mon Jul 15 12:18:59 2024 +0100

    Split @tldraw/state into @tldraw/state and @tldraw/state-react (#4170)
    
    The backend code uses `@tldraw/state`, which is fine, but the package
    has a peer dependency on `react`, which is not fine to impose on backend
    consumers. So let's split this up again.
    
    ### Change type
    
    - [ ] `bugfix`
    - [ ] `improvement`
    - [ ] `feature`
    - [x] `api`
    - [x] `other`
    
    ### Test plan
    
    1. Create a shape...
    2.
    
    - [ ] Unit tests
    - [ ] End to end tests
    
    ### Release notes
    
    - Fixed a bug with‚Ä¶

diff --git a/packages/editor/src/lib/hooks/useDocumentEvents.ts b/packages/editor/src/lib/hooks/useDocumentEvents.ts
index d76f8e779..e0da6aa2c 100644
--- a/packages/editor/src/lib/hooks/useDocumentEvents.ts
+++ b/packages/editor/src/lib/hooks/useDocumentEvents.ts
@@ -1,4 +1,4 @@
-import { useValue } from '@tldraw/state'
+import { useValue } from '@tldraw/state-react'
 import { useEffect } from 'react'
 import { TLKeyboardEventInfo } from '../editor/types/event-types'
 import { preventDefault } from '../utils/dom'

commit 146965c2405eb4756c4952b55c61dbf6234d38ed
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Thu Jul 18 12:59:02 2024 +0100

    Watermark II (#4196)
    
    This PR is a second go at the watermark.
    
    ![localhost_5420_develop
    (1)](https://github.com/user-attachments/assets/70757e93-d8e5-4c96-b6ca-30dfbf1c21b1)
    
    It:
    - updates the watermark icon
    - removes the watermark on small devices
    - makes the watermark a react component with inline styles
      - the classname for these styles is based on the current version
    - improves the interactions around the watermark
      - the watermark requires a short delay before accepting events
      - events prior to that delay will be passed to the canvas
      - events after that delay will interact with the link to tldraw.dev
      - prevents interactions with the watermark while a menu is open
      - moves the watermark up when debug mode is active
    
    It also:
    - moves the "is unlicensed" logic into the license manager
    - adds the license manager as a private member of the editor class
    - removes the watermark manager
    
    ## Some thoughts
    
    I couldn't get the interaction we wanted from the watermark manager
    itself. It's important that this just the right amount of disruptive,
    and accidental clicks seemed to be a step too far. After some thinking,
    I think an improved experience is worth a little less security.
    
    Using a React component (with CSS styling) felt acceptable as long as we
    provided our own "inline" style sheet. My previous concern was that we'd
    designed a system where external CSS is acceptable, and so would require
    other users to provide our watermark CSS with any of their own CSS; but
    inline styles fix that.
    
    ### Change type
    
    - [x] `other`
    
    ### Test plan
    
    1. Same as the previous watermark tests.
    
    - [x] Unit tests
    
    ---------
    
    Co-authored-by: Mime ƒåuvalo <mimecuvalo@gmail.com>

diff --git a/packages/editor/src/lib/hooks/useDocumentEvents.ts b/packages/editor/src/lib/hooks/useDocumentEvents.ts
index e0da6aa2c..c83964391 100644
--- a/packages/editor/src/lib/hooks/useDocumentEvents.ts
+++ b/packages/editor/src/lib/hooks/useDocumentEvents.ts
@@ -12,7 +12,8 @@ export function useDocumentEvents() {
 	const isAppFocused = useValue('isFocused', () => editor.getIsFocused(), [editor])
 
 	useEffect(() => {
-		if (typeof matchMedia === undefined) return
+		if (typeof window === 'undefined' || !('matchMedia' in window)) return
+
 		// https://developer.mozilla.org/en-US/docs/Web/API/Window/devicePixelRatio#monitoring_screen_resolution_or_zoom_level_changes
 		let remove: (() => void) | null = null
 		const updatePixelRatio = () => {

commit 7be2c0f7b3ac2abab578b8ef6321ebb1250b3ed4
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Tue Sep 10 09:33:07 2024 +0100

    Fix escape bug (#4470)
    
    The editor was already "focused", so it wasn't refocusing the container.
    The container needed to be focused.
    
    To reproduce: create a text shape, press escape, press enter to re-edit,
    press escape to blur again.
    
    ### Change type
    
    - [x] `bugfix`
    - [ ] `improvement`
    - [ ] `feature`
    - [ ] `api`
    - [ ] `other`

diff --git a/packages/editor/src/lib/hooks/useDocumentEvents.ts b/packages/editor/src/lib/hooks/useDocumentEvents.ts
index c83964391..9c4da5374 100644
--- a/packages/editor/src/lib/hooks/useDocumentEvents.ts
+++ b/packages/editor/src/lib/hooks/useDocumentEvents.ts
@@ -111,13 +111,15 @@ export function useDocumentEvents() {
 					// should we allow escape to do its normal thing.
 
 					if (editor.getEditingShape() || editor.getSelectedShapeIds().length > 0) {
-						e.preventDefault()
+						preventDefault(e)
 					}
 
 					// Don't do anything if we open menus open
 					if (editor.getOpenMenus().length > 0) return
 
-					if (!editor.inputs.keys.has('Escape')) {
+					if (editor.inputs.keys.has('Escape')) {
+						// noop
+					} else {
 						editor.inputs.keys.add('Escape')
 
 						editor.cancel()
@@ -126,7 +128,7 @@ export function useDocumentEvents() {
 						// will break additional shortcuts. We need to
 						// refocus the container in order to keep these
 						// shortcuts working.
-						editor.focus()
+						container.focus()
 					}
 					return
 				}

commit 09f89a60f403ff704c1372eff9fecba6cd5ce361
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Mon Sep 30 16:27:45 2024 -0400

    [dotcom] Menus, dialogs, toasts, etc. (#4624)
    
    This PR brings tldraw's ui into the application layer: dialogs, menus,
    etc.
    
    It:
    - brings our dialogs to the application layer
    - brings our toasts to the application layer
    - brings our translations to the application layer
    - brings our assets to the application layer
    - creates a "file menu"
    - creates a "rename file" dialog
    - creates the UI for changing the title of a file in the header
    - adjusts some text sizes
    
    In order to do that, I've had to:
    - create a global `tlmenus` system for menus
    - create a global `tltime` system for timers
    - create a global `tlenv` for environment"
    - create a `useMaybeEditor` hook
    
    ### Change type
    
    - [x] `other`
    
    ### Release notes
    - exports dialogs system
    - exports toasts system
    - exports translations system
    - create a global `tlmenus` system for menus
    - create a global `tltime` system for timers
    - create a global `tlenv` for environment"
    - create a `useMaybeEditor` hook
    
    ---------
    
    Co-authored-by: Mitja Bezen≈°ek <mitja.bezensek@gmail.com>

diff --git a/packages/editor/src/lib/hooks/useDocumentEvents.ts b/packages/editor/src/lib/hooks/useDocumentEvents.ts
index 9c4da5374..3c7e96218 100644
--- a/packages/editor/src/lib/hooks/useDocumentEvents.ts
+++ b/packages/editor/src/lib/hooks/useDocumentEvents.ts
@@ -88,7 +88,7 @@ export function useDocumentEvents() {
 					break
 				}
 				case 'Tab': {
-					if (isFocusingInput() || editor.getIsMenuOpen()) {
+					if (isFocusingInput() || editor.menus.hasAnyOpenMenus()) {
 						return
 					}
 					break
@@ -115,7 +115,7 @@ export function useDocumentEvents() {
 					}
 
 					// Don't do anything if we open menus open
-					if (editor.getOpenMenus().length > 0) return
+					if (editor.menus.getOpenMenus().length > 0) return
 
 					if (editor.inputs.keys.has('Escape')) {
 						// noop
@@ -133,7 +133,7 @@ export function useDocumentEvents() {
 					return
 				}
 				default: {
-					if (isFocusingInput() || editor.getIsMenuOpen()) {
+					if (isFocusingInput() || editor.menus.hasAnyOpenMenus()) {
 						return
 					}
 				}
@@ -156,7 +156,7 @@ export function useDocumentEvents() {
 			if ((e as any).isKilled) return
 			;(e as any).isKilled = true
 
-			if (isFocusingInput() || editor.getIsMenuOpen()) {
+			if (isFocusingInput() || editor.menus.hasAnyOpenMenus()) {
 				return
 			}
 

commit 4aeb1496b83a80d46c934931f23adb25ea9cf35c
Author: Mime ƒåuvalo <mimecuvalo@gmail.com>
Date:   Thu Oct 3 20:59:09 2024 +0100

    selection: allow cmd/ctrl to add to selection (#4570)
    
    In the How-To sesh, I noticed that using Shift of course lets you add to
    a selection of shapes, but Cmd/Ctrl does not.
    Typically, cmd/ctrl lets you do this in other contexts so some of that
    muscle memory doesn't get allowed in tldraw currently.
    This enables cmd/ctrl to have the same behavior as shift.
    
    ### Change type
    
    - [ ] `bugfix`
    - [x] `improvement`
    - [ ] `feature`
    - [ ] `api`
    - [ ] `other`
    
    ### Release notes
    
    - Selection: allow cmd/ctrl to add multiple shapes to the selection.
    
    ---------
    
    Co-authored-by: Steve Ruiz <steveruizok@gmail.com>

diff --git a/packages/editor/src/lib/hooks/useDocumentEvents.ts b/packages/editor/src/lib/hooks/useDocumentEvents.ts
index 3c7e96218..3d1315b56 100644
--- a/packages/editor/src/lib/hooks/useDocumentEvents.ts
+++ b/packages/editor/src/lib/hooks/useDocumentEvents.ts
@@ -2,6 +2,7 @@ import { useValue } from '@tldraw/state-react'
 import { useEffect } from 'react'
 import { TLKeyboardEventInfo } from '../editor/types/event-types'
 import { preventDefault } from '../utils/dom'
+import { isAccelKey } from '../utils/keyboard'
 import { useContainer } from './useContainer'
 import { useEditor } from './useEditor'
 
@@ -147,6 +148,8 @@ export function useDocumentEvents() {
 				shiftKey: e.shiftKey,
 				altKey: e.altKey,
 				ctrlKey: e.metaKey || e.ctrlKey,
+				metaKey: e.metaKey,
+				accelKey: isAccelKey(e),
 			}
 
 			editor.dispatch(info)
@@ -172,6 +175,8 @@ export function useDocumentEvents() {
 				shiftKey: e.shiftKey,
 				altKey: e.altKey,
 				ctrlKey: e.metaKey || e.ctrlKey,
+				metaKey: e.metaKey,
+				accelKey: isAccelKey(e),
 			}
 
 			editor.dispatch(info)

commit 9636546a09b34e7519658ae836e4ce76d475fb81
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Sat Oct 5 08:45:57 2024 +0100

    prevent accidental image drops (#4651)
    
    This PR handles a case where users drop images or videos on top of our
    user interface (on tldraw.com).
    
    ### Change type
    
    - [x] `bugfix`
    - [ ] `improvement`
    - [ ] `feature`
    - [ ] `api`
    - [ ] `other`
    
    ### Release notes
    
    - Fixed a bug where dropping images or other things on user interface
    elements would navigate away from the canvas

diff --git a/packages/editor/src/lib/hooks/useDocumentEvents.ts b/packages/editor/src/lib/hooks/useDocumentEvents.ts
index 3d1315b56..ac748628e 100644
--- a/packages/editor/src/lib/hooks/useDocumentEvents.ts
+++ b/packages/editor/src/lib/hooks/useDocumentEvents.ts
@@ -12,6 +12,36 @@ export function useDocumentEvents() {
 
 	const isAppFocused = useValue('isFocused', () => editor.getIsFocused(), [editor])
 
+	// Prevent the browser's default drag and drop behavior on our container (UI, etc)
+	useEffect(() => {
+		if (!container) return
+
+		function onDrop(e: DragEvent) {
+			// this is tricky: we don't want the event to do anything
+			// here, but we do want it to make its way to the canvas,
+			// even if the drop is over some other element (like a toolbar),
+			// so we're going to flag the event and then dispatch
+			// it to the canvas; the canvas will handle it and try to
+			// stop it from propagating back, but in case we do see it again,
+			// we'll look for the flag so we know to stop it from being
+			// re-dispatched, which would lead to an infinite loop.
+			if ((e as any).isSpecialRedispatchedEvent) return
+			preventDefault(e)
+			const cvs = container.querySelector('.tl-canvas')
+			if (!cvs) return
+			const newEvent = new DragEvent('drop', e)
+			;(newEvent as any).isSpecialRedispatchedEvent = true
+			cvs.dispatchEvent(newEvent)
+		}
+
+		container.addEventListener('dragover', onDrop)
+		container.addEventListener('drop', onDrop)
+		return () => {
+			container.removeEventListener('dragover', onDrop)
+			container.removeEventListener('drop', onDrop)
+		}
+	}, [container])
+
 	useEffect(() => {
 		if (typeof window === 'undefined' || !('matchMedia' in window)) return
 

commit 3fc33afd26fdee90ee23faba1e6151c82c90248f
Author: Mime ƒåuvalo <mimecuvalo@gmail.com>
Date:   Thu Oct 10 23:03:07 2024 +0100

    botcom: prevent pinch-zoom on sidebar (#4697)
    
    ### Change type
    
    - [ ] `bugfix`
    - [ ] `improvement`
    - [ ] `feature`
    - [ ] `api`
    - [x] `other`

diff --git a/packages/editor/src/lib/hooks/useDocumentEvents.ts b/packages/editor/src/lib/hooks/useDocumentEvents.ts
index ac748628e..e26d7a780 100644
--- a/packages/editor/src/lib/hooks/useDocumentEvents.ts
+++ b/packages/editor/src/lib/hooks/useDocumentEvents.ts
@@ -240,6 +240,7 @@ export function useDocumentEvents() {
 
 		// Prevent wheel events that occur inside of the container
 		const handleWheel = (e: WheelEvent) => {
+			// Ctrl/Meta key indicates a pinch event (funny, eh?)
 			if (container.contains(e.target as Node) && (e.ctrlKey || e.metaKey)) {
 				preventDefault(e)
 			}

commit 51cbc6c80b8712ea5370cb0e24e0e6f596c88069
Author: Mime ƒåuvalo <mimecuvalo@gmail.com>
Date:   Sat Oct 12 12:54:53 2024 +0100

    drag/drop: followup to accidental img drop pr (#4704)
    
    Drag/dropping was creating multiple images when putting an image on the
    canvas.
    Followup to https://github.com/tldraw/tldraw/pull/4651
    
    ### Change type
    
    - [x] `bugfix`
    - [ ] `improvement`
    - [ ] `feature`
    - [ ] `api`
    - [ ] `other`
    
    ### Release notes
    
    - Fix bug with multiple images being created when dropping it onto the
    canvas.

diff --git a/packages/editor/src/lib/hooks/useDocumentEvents.ts b/packages/editor/src/lib/hooks/useDocumentEvents.ts
index e26d7a780..7d1e43c09 100644
--- a/packages/editor/src/lib/hooks/useDocumentEvents.ts
+++ b/packages/editor/src/lib/hooks/useDocumentEvents.ts
@@ -1,7 +1,7 @@
 import { useValue } from '@tldraw/state-react'
 import { useEffect } from 'react'
 import { TLKeyboardEventInfo } from '../editor/types/event-types'
-import { preventDefault } from '../utils/dom'
+import { preventDefault, stopEventPropagation } from '../utils/dom'
 import { isAccelKey } from '../utils/keyboard'
 import { useContainer } from './useContainer'
 import { useEditor } from './useEditor'
@@ -27,6 +27,7 @@ export function useDocumentEvents() {
 			// re-dispatched, which would lead to an infinite loop.
 			if ((e as any).isSpecialRedispatchedEvent) return
 			preventDefault(e)
+			stopEventPropagation(e)
 			const cvs = container.querySelector('.tl-canvas')
 			if (!cvs) return
 			const newEvent = new DragEvent('drop', e)

commit a9646eacafaef7264db29fc20c6b5c480f505e59
Author: Mime ƒåuvalo <mimecuvalo@gmail.com>
Date:   Mon Oct 21 10:16:03 2024 +0100

    drag: passthrough correct event type for drag events (#4739)
    
    ### Change type
    
    - [x] `bugfix`
    - [ ] `improvement`
    - [ ] `feature`
    - [ ] `api`
    - [ ] `other`
    
    ### Release notes
    
    - Fix bug with passing correct event type for drag events

diff --git a/packages/editor/src/lib/hooks/useDocumentEvents.ts b/packages/editor/src/lib/hooks/useDocumentEvents.ts
index 7d1e43c09..beb73e386 100644
--- a/packages/editor/src/lib/hooks/useDocumentEvents.ts
+++ b/packages/editor/src/lib/hooks/useDocumentEvents.ts
@@ -30,7 +30,7 @@ export function useDocumentEvents() {
 			stopEventPropagation(e)
 			const cvs = container.querySelector('.tl-canvas')
 			if (!cvs) return
-			const newEvent = new DragEvent('drop', e)
+			const newEvent = new DragEvent(e.type, e)
 			;(newEvent as any).isSpecialRedispatchedEvent = true
 			cvs.dispatchEvent(newEvent)
 		}

commit 9d6b5916e83ef758dc7c28d3fc221fd4f0236b14
Author: Mime ƒåuvalo <mimecuvalo@gmail.com>
Date:   Mon Oct 21 13:01:37 2024 +0100

    menus: rework the open menu logic to be in one consistent place (#4642)
    
    We have a lot of logic scattered everywhere to prevent certain logic
    when menus are open. It's a very manual process, easy to forget about
    when adding new shapes/tools/logic. This flips the logic a bit to be
    handled in one place vs. various places trying to account for this.
    
    ### Change type
    
    - [ ] `bugfix`
    - [x] `improvement`
    - [ ] `feature`
    - [ ] `api`
    - [ ] `other`
    
    ### Release notes
    
    - Rework open menu logic to be centralized.
    
    ---------
    
    Co-authored-by: Steve Ruiz <steveruizok@gmail.com>

diff --git a/packages/editor/src/lib/hooks/useDocumentEvents.ts b/packages/editor/src/lib/hooks/useDocumentEvents.ts
index beb73e386..ee0f06fd0 100644
--- a/packages/editor/src/lib/hooks/useDocumentEvents.ts
+++ b/packages/editor/src/lib/hooks/useDocumentEvents.ts
@@ -120,7 +120,7 @@ export function useDocumentEvents() {
 					break
 				}
 				case 'Tab': {
-					if (isFocusingInput() || editor.menus.hasAnyOpenMenus()) {
+					if (isFocusingInput()) {
 						return
 					}
 					break
@@ -165,7 +165,7 @@ export function useDocumentEvents() {
 					return
 				}
 				default: {
-					if (isFocusingInput() || editor.menus.hasAnyOpenMenus()) {
+					if (isFocusingInput()) {
 						return
 					}
 				}
@@ -190,7 +190,7 @@ export function useDocumentEvents() {
 			if ((e as any).isKilled) return
 			;(e as any).isKilled = true
 
-			if (isFocusingInput() || editor.menus.hasAnyOpenMenus()) {
+			if (isFocusingInput()) {
 				return
 			}
 

commit cda5ce3f74369b714cf946c89a66e45476ade49f
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Wed Oct 23 12:42:21 2024 +0100

    [Fix] Keyboard events on menus (#4745)
    
    This PR fixes a bug where keyboard events weren't working in dialogs.
    
    ### Change type
    
    - [x] `bugfix`

diff --git a/packages/editor/src/lib/hooks/useDocumentEvents.ts b/packages/editor/src/lib/hooks/useDocumentEvents.ts
index ee0f06fd0..bda4af780 100644
--- a/packages/editor/src/lib/hooks/useDocumentEvents.ts
+++ b/packages/editor/src/lib/hooks/useDocumentEvents.ts
@@ -1,5 +1,6 @@
 import { useValue } from '@tldraw/state-react'
 import { useEffect } from 'react'
+import { Editor } from '../editor/Editor'
 import { TLKeyboardEventInfo } from '../editor/types/event-types'
 import { preventDefault, stopEventPropagation } from '../utils/dom'
 import { isAccelKey } from '../utils/keyboard'
@@ -93,7 +94,7 @@ export function useDocumentEvents() {
 				e.altKey &&
 				// todo: When should we allow the alt key to be used? Perhaps states should declare which keys matter to them?
 				(editor.isIn('zoom') || !editor.getPath().endsWith('.idle')) &&
-				!isFocusingInput()
+				!areShortcutsDisabled(editor)
 			) {
 				// On windows the alt key opens the menu bar.
 				// We want to prevent that if the user is doing something else,
@@ -120,7 +121,7 @@ export function useDocumentEvents() {
 					break
 				}
 				case 'Tab': {
-					if (isFocusingInput()) {
+					if (areShortcutsDisabled(editor)) {
 						return
 					}
 					break
@@ -165,7 +166,7 @@ export function useDocumentEvents() {
 					return
 				}
 				default: {
-					if (isFocusingInput()) {
+					if (areShortcutsDisabled(editor)) {
 						return
 					}
 				}
@@ -190,7 +191,7 @@ export function useDocumentEvents() {
 			if ((e as any).isKilled) return
 			;(e as any).isKilled = true
 
-			if (isFocusingInput()) {
+			if (areShortcutsDisabled(editor)) {
 				return
 			}
 
@@ -275,16 +276,13 @@ export function useDocumentEvents() {
 
 const INPUTS = ['input', 'select', 'button', 'textarea']
 
-function isFocusingInput() {
+function areShortcutsDisabled(editor: Editor) {
 	const { activeElement } = document
 
-	if (
-		activeElement &&
-		(activeElement.getAttribute('contenteditable') ||
-			INPUTS.indexOf(activeElement.tagName.toLowerCase()) > -1)
-	) {
-		return true
-	}
-
-	return false
+	return (
+		editor.menus.hasOpenMenus() ||
+		(activeElement &&
+			(activeElement.getAttribute('contenteditable') ||
+				INPUTS.indexOf(activeElement.tagName.toLowerCase()) > -1))
+	)
 }

commit b301aeb64e5ff7bcd55928d7200a39092da8c501
Author: Mime ƒåuvalo <mimecuvalo@gmail.com>
Date:   Wed Oct 23 15:55:42 2024 +0100

    npm: upgrade eslint v8 ‚Üí v9 (#4757)
    
    As I worked on the i18n PR (https://github.com/tldraw/tldraw/pull/4719)
    I noticed that `react-intl` required a new version of `eslint`. That led
    me down a bit of a rabbit hole of upgrading v8 ‚Üí v9. There were a couple
    things to upgrade to make this work.
    
    - ran `npx @eslint/migrate-config .eslintrc.js` to upgrade to the new
    `eslint.config.mjs`
    - `.eslintignore` is now deprecated and part of `eslint.config.mjs`
    - some packages are no longer relevant, of note: `eslint-plugin-local`
    and `eslint-plugin-deprecation`
    - the upgrade caught a couple bugs/dead code
    
    ### Change type
    
    - [ ] `bugfix`
    - [x] `improvement`
    - [ ] `feature`
    - [ ] `api`
    - [ ] `other`
    
    ### Release notes
    
    - Upgrade eslint v8 ‚Üí v9
    
    ---------
    
    Co-authored-by: alex <alex@dytry.ch>
    Co-authored-by: David Sheldrick <d.j.sheldrick@gmail.com>
    Co-authored-by: Mitja Bezen≈°ek <mitja.bezensek@gmail.com>
    Co-authored-by: Steve Ruiz <steveruizok@gmail.com>

diff --git a/packages/editor/src/lib/hooks/useDocumentEvents.ts b/packages/editor/src/lib/hooks/useDocumentEvents.ts
index bda4af780..11c0d6fdc 100644
--- a/packages/editor/src/lib/hooks/useDocumentEvents.ts
+++ b/packages/editor/src/lib/hooks/useDocumentEvents.ts
@@ -64,17 +64,17 @@ export function useDocumentEvents() {
 			}
 			if (media.addEventListener) {
 				media.addEventListener('change', updatePixelRatio)
-				// eslint-disable-next-line deprecation/deprecation
+				// eslint-disable-next-line @typescript-eslint/no-deprecated
 			} else if (media.addListener) {
-				// eslint-disable-next-line deprecation/deprecation
+				// eslint-disable-next-line @typescript-eslint/no-deprecated
 				media.addListener(safariCb)
 			}
 			remove = () => {
 				if (media.removeEventListener) {
 					media.removeEventListener('change', updatePixelRatio)
-					// eslint-disable-next-line deprecation/deprecation
+					// eslint-disable-next-line @typescript-eslint/no-deprecated
 				} else if (media.removeListener) {
-					// eslint-disable-next-line deprecation/deprecation
+					// eslint-disable-next-line @typescript-eslint/no-deprecated
 					media.removeListener(safariCb)
 				}
 			}

commit fcad75fe42f9f6e451e84f5b3a1aec757c15ca51
Author: Mitja Bezen≈°ek <mitja.bezensek@gmail.com>
Date:   Fri Feb 7 11:00:57 2025 +0100

    Numeric shortcuts were still getting triggered when used inside some inputs (like the file rename input) (#5378)
    
    We used `hotkeys` library [in the past
    t](https://github.com/tldraw/tldraw/pull/5340)o add the shortcuts for
    numeric tool shortcut keys. Looks like it handled the editable element
    filtering (not triggering keyboard shortcuts when the source was an
    editable element). Since we no longer use that we should prevent the
    shortcuts manually.
    
    ### Change type
    
    - [x] `bugfix`
    
    ### Test plan
    
    1. Edit the file name in the sidebar.
    2. Pressing 1, 2, 3 should no longer change the tool and should add the
    pressed key to the name input.
    
    ### Release notes
    
    - Fix an issue with numeric shortcuts working inside of editable
    elements.

diff --git a/packages/editor/src/lib/hooks/useDocumentEvents.ts b/packages/editor/src/lib/hooks/useDocumentEvents.ts
index 11c0d6fdc..045a08433 100644
--- a/packages/editor/src/lib/hooks/useDocumentEvents.ts
+++ b/packages/editor/src/lib/hooks/useDocumentEvents.ts
@@ -2,7 +2,7 @@ import { useValue } from '@tldraw/state-react'
 import { useEffect } from 'react'
 import { Editor } from '../editor/Editor'
 import { TLKeyboardEventInfo } from '../editor/types/event-types'
-import { preventDefault, stopEventPropagation } from '../utils/dom'
+import { activeElementShouldCaptureKeys, preventDefault, stopEventPropagation } from '../utils/dom'
 import { isAccelKey } from '../utils/keyboard'
 import { useContainer } from './useContainer'
 import { useEditor } from './useEditor'
@@ -274,15 +274,6 @@ export function useDocumentEvents() {
 	}, [editor, container, isAppFocused])
 }
 
-const INPUTS = ['input', 'select', 'button', 'textarea']
-
 function areShortcutsDisabled(editor: Editor) {
-	const { activeElement } = document
-
-	return (
-		editor.menus.hasOpenMenus() ||
-		(activeElement &&
-			(activeElement.getAttribute('contenteditable') ||
-				INPUTS.indexOf(activeElement.tagName.toLowerCase()) > -1))
-	)
+	return editor.menus.hasOpenMenus() || activeElementShouldCaptureKeys()
 }

commit 629125a2e474effa3536411584aaac8f77657673
Author: Mime ƒåuvalo <mimecuvalo@gmail.com>
Date:   Thu Apr 3 16:07:49 2025 +0100

    a11y: navigable shapes (#5761)
    
    As part of a [larger push](https://github.com/tldraw/tldraw/issues/5215)
    to add accessibility to our SDK, a big piece of that work is being able
    to navigate through our shapes in some kind of predictable fashion. This
    builds upon @Taha-Hassan-Git 's great work and knowledge in this area,
    thanks man. :tip-o-the-hat:
    
    Things that were tackled in this PR:
    - navigating shapes using the Tab key, when in the Select tool.
    - navigating shapes using Cmd/Ctrl+Arrow keys, when in the Select tool.
    - only allowing certain shapes to be navigated to. We ignore
    draw/highlighter/arrow/group/line. Groups need exploration and will be
    tackled later.
    - panning the camera to the selected shape, but avoiding doing so in a
    jarring way. We don't center the shape to avoid too much whiplashy-ness.
    
    An initial foray into this was relaying purely on DOM but it had a bunch
    of browser quirks which forced making this purely a programmatic control
    on our end. Things like ensuring culled shapes are still accessible even
    though they're not rendered was one of the issues but also tab order
    became unpredictable at times which steered me away from that direction.
    
    We coud have considered using something like rbush for some spatial
    indexing of the shapes. For the intents and purposes of this PR, it
    seemed like overkill at the moment. But we might cross that bridge down
    the line, we'll see.
    
    The reading-direction heuristics are a combination of dividing the pages
    into rows and then looking at distance and angles to see what is the
    spatially "next" shape to be read. It takes _all_ of the shapes and
    sorts them into a logical order so that nothing is missed/skipped when
    tabbing around.
    The directional-arrow heuristics don't divide things into rows and don't
    create a sorted set of shapes. Instead, they decide based on the current
    shape and direction which is the next spatially to go to, depending on
    distance+angle.
    
    There's a decent amount of nuance in this kind of navigation but it's
    not all covered in this PR, for separate PRs, we'll look at:
    - [x] adding a "skipping to content" button
    - [ ] question whether maybe directional navigation visits ‚ÄòcanTabTo‚Äô
    shapes, maybe yes?
    - [ ] tackling what Enter/Escape should do when on the canvas shapes
    - [ ] how to deal with hierarchy / parent-child / frame / group shapes
    - [ ] and more
    
    
    
    https://github.com/user-attachments/assets/49b6b34e-2553-4047-846f-5d3383e1e3c6
    
    
    ### Change type
    
    - [ ] `bugfix`
    - [ ] `improvement`
    - [x] `feature`
    - [ ] `api`
    - [ ] `other`
    
    ### Test plan
    
    - [x] Unit tests
    - [x] End to end tests
    
    ### Release notes
    
    - a11y: navigable shapes using Tab and Cmd/Ctrl+Arrow

diff --git a/packages/editor/src/lib/hooks/useDocumentEvents.ts b/packages/editor/src/lib/hooks/useDocumentEvents.ts
index 045a08433..10cb7220e 100644
--- a/packages/editor/src/lib/hooks/useDocumentEvents.ts
+++ b/packages/editor/src/lib/hooks/useDocumentEvents.ts
@@ -104,6 +104,7 @@ export function useDocumentEvents() {
 
 			if ((e as any).isKilled) return
 			;(e as any).isKilled = true
+			const hasSelectedShapes = !!editor.getSelectedShapeIds().length
 
 			switch (e.key) {
 				case '=':
@@ -124,6 +125,23 @@ export function useDocumentEvents() {
 					if (areShortcutsDisabled(editor)) {
 						return
 					}
+					if (hasSelectedShapes) {
+						// This is used in tandem with shape navigation.
+						preventDefault(e)
+					}
+					break
+				}
+				case 'ArrowLeft':
+				case 'ArrowRight':
+				case 'ArrowUp':
+				case 'ArrowDown': {
+					if (areShortcutsDisabled(editor)) {
+						return
+					}
+					if (hasSelectedShapes && (e.metaKey || e.ctrlKey)) {
+						// This is used in tandem with shape navigation.
+						preventDefault(e)
+					}
 					break
 				}
 				case ',': {

commit 2449ca610c41a2dc29ab4461c4c9ed56ddcc92f0
Author: Mime ƒåuvalo <mimecuvalo@gmail.com>
Date:   Tue Apr 29 11:34:13 2025 +0100

    a11y: better embed interaction (#5958)
    
    Fixes up the tabIndex for embeds.
    
    ### Change type
    
    - [ ] `bugfix`
    - [x] `improvement`
    - [ ] `feature`
    - [ ] `api`
    - [ ] `other`
    
    ### Release notes
    
    - a11y: make sure we can tab into embeds.

diff --git a/packages/editor/src/lib/hooks/useDocumentEvents.ts b/packages/editor/src/lib/hooks/useDocumentEvents.ts
index 10cb7220e..7f6a1d428 100644
--- a/packages/editor/src/lib/hooks/useDocumentEvents.ts
+++ b/packages/editor/src/lib/hooks/useDocumentEvents.ts
@@ -11,6 +11,7 @@ export function useDocumentEvents() {
 	const editor = useEditor()
 	const container = useContainer()
 
+	const isEditing = useValue('isEditing', () => editor.getEditingShapeId(), [editor])
 	const isAppFocused = useValue('isFocused', () => editor.getIsFocused(), [editor])
 
 	// Prevent the browser's default drag and drop behavior on our container (UI, etc)
@@ -125,7 +126,11 @@ export function useDocumentEvents() {
 					if (areShortcutsDisabled(editor)) {
 						return
 					}
-					if (hasSelectedShapes) {
+					// isEditing here sounds like it's about text editing
+					// but more specifically, this is so you can tab into an
+					// embed that's being 'edited'. In our world,
+					// editing an embed, means it's interactive.
+					if (hasSelectedShapes && !isEditing) {
 						// This is used in tandem with shape navigation.
 						preventDefault(e)
 					}
@@ -289,7 +294,7 @@ export function useDocumentEvents() {
 			container.removeEventListener('keydown', handleKeyDown)
 			container.removeEventListener('keyup', handleKeyUp)
 		}
-	}, [editor, container, isAppFocused])
+	}, [editor, container, isAppFocused, isEditing])
 }
 
 function areShortcutsDisabled(editor: Editor) {

</code></pre>
        </section>
    </main>
    <footer>
        <p>LoCoDiff-bench - <a href="https://github.com/AbanteAI/LoCoDiff-bench">GitHub Repository</a></p>
    </footer>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            hljs.highlightAll();
        });
    </script>
</body>
</html>
    