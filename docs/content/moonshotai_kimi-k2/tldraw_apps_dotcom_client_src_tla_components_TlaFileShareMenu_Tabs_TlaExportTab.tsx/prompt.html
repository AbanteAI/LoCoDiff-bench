<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prompt: apps/dotcom/client/src/tla/components/TlaFileShareMenu/Tabs/TlaExportTab.tsx - Kimi K2</title>
    <link rel="stylesheet" href="../../../../styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/default.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
</head>
<body>
    <header>
        <h1>Prompt: apps/dotcom/client/src/tla/components/TlaFileShareMenu/Tabs/TlaExportTab.tsx</h1>
        <h2>Model: Kimi K2</h2>
        <p><a href="../../../cases/moonshotai_kimi-k2/tldraw_apps_dotcom_client_src_tla_components_TlaFileShareMenu_Tabs_TlaExportTab.tsx.html">Back to Case</a> | <a href="../../../cases.html">All Cases</a> | <a href="../../../index.html">Home</a></p>
    </header>
    <main>
        <section>
            <h2>Prompt Content</h2>
            <pre><code class="language-plaintext"># Instructions

You are being benchmarked. You will see the output of a git log command, and from that must infer the current state of a file. Think carefully, as you must output the exact state of the file to earn full marks.

**Important:** Your goal is to reproduce the file's content *exactly* as it exists at the final commit, even if the code appears broken, buggy, or contains obvious errors. Do **not** try to "fix" the code. Attempting to correct issues will result in a poor score, as this benchmark evaluates your ability to reproduce the precise state of the file based on its history.

# Required Response Format

Wrap the content of the file in triple backticks (```). Any text outside the final closing backticks will be ignored. End your response after outputting the closing backticks.

# Example Response

```python
#!/usr/bin/env python
print('Hello, world!')
```

# File History

> git log -p --cc --topo-order --reverse -- apps/dotcom/client/src/tla/components/TlaFileShareMenu/Tabs/TlaExportTab.tsx

commit 42812e6141b09480393c2d48c017abf33af09b93
Author: Mitja Bezen≈°ek <mitja.bezensek@gmail.com>
Date:   Wed Oct 23 17:31:53 2024 +0200

    [botcom] Publishing (#4688)
    
    Adds publishing to botcom.
    
    This allows the users to publish the existing document. This is a point
    in time snapshot, which they can then update or delete at a later time.
    Only the owner of the file has the permission to do that, while everyone
    with a link can view the published document.
    
    ### Change type
    
    - [ ] `bugfix`
    - [ ] `improvement`
    - [x] `feature`
    - [ ] `api`
    - [ ] `other`
    
    ### Release notes
    
    - Add publishing to botcom.
    
    ---------
    
    Co-authored-by: David Sheldrick <d.j.sheldrick@gmail.com>
    Co-authored-by: Steve Ruiz <steveruizok@gmail.com>

diff --git a/apps/dotcom/client/src/tla/components/TlaFileShareMenu/Tabs/TlaExportTab.tsx b/apps/dotcom/client/src/tla/components/TlaFileShareMenu/Tabs/TlaExportTab.tsx
new file mode 100644
index 000000000..0b36c5ef1
--- /dev/null
+++ b/apps/dotcom/client/src/tla/components/TlaFileShareMenu/Tabs/TlaExportTab.tsx
@@ -0,0 +1,360 @@
+import classNames from 'classnames'
+import { useCallback, useRef, useState } from 'react'
+import {
+	Editor,
+	FileHelpers,
+	TLImageExportOptions,
+	TLShape,
+	compact,
+	debounce,
+	exportAs,
+	useReactor,
+	useValue,
+} from 'tldraw'
+import { globalEditor } from '../../../../utils/globalEditor'
+import { TldrawApp } from '../../../app/TldrawApp'
+import { useMaybeApp } from '../../../hooks/useAppState'
+import { useRaw } from '../../../hooks/useRaw'
+import { useTldrawAppUiEvents } from '../../../utils/app-ui-events'
+import { getCurrentEditor } from '../../../utils/getCurrentEditor'
+import {
+	TldrawAppSessionState,
+	getLocalSessionState,
+	updateLocalSessionState,
+} from '../../../utils/local-session-state'
+import { TlaButton } from '../../TlaButton/TlaButton'
+import { TlaSelect } from '../../TlaSelect/TlaSelect'
+import { TlaSwitch } from '../../TlaSwitch/TlaSwitch'
+import {
+	TlaMenuControl,
+	TlaMenuControlGroup,
+	TlaMenuControlLabel,
+	TlaMenuSection,
+} from '../../tla-menu/tla-menu'
+import styles from '../file-share-menu.module.css'
+
+export function TlaExportTab() {
+	const app = useMaybeApp()
+
+	const preferences = useValue('preferences', () => getExportPreferences(app), [app])
+
+	const onChange = useCallback(
+		<T extends keyof TldrawAppSessionState['exportSettings']>(
+			key: T,
+			value: TldrawAppSessionState['exportSettings'][T]
+		) => {
+			if (app) {
+				app.updateUserExportPreferences({ [key]: value })
+			} else {
+				updateLocalSessionState((s) => ({ exportSettings: { ...s.exportSettings, [key]: value } }))
+			}
+		},
+		[app]
+	)
+
+	const { exportPadding, exportBackground, exportTheme, exportFormat } = preferences
+
+	return (
+		<TlaMenuSection>
+			<TlaMenuControlGroup>
+				<ExportBackgroundToggle onChange={onChange} value={exportBackground} />
+				<ExportPaddingToggle onChange={onChange} value={exportPadding} />
+				<ExportThemeSelect onChange={onChange} value={exportTheme} />
+				<ExportFormatSelect onChange={onChange} value={exportFormat} />
+			</TlaMenuControlGroup>
+			<ExportPreviewImage />
+			<ExportImageButton />
+		</TlaMenuSection>
+	)
+}
+
+function ExportPaddingToggle({
+	value,
+	onChange,
+}: {
+	value: TldrawAppSessionState['exportSettings']['exportPadding']
+	onChange(
+		key: 'exportPadding',
+		value: TldrawAppSessionState['exportSettings']['exportPadding']
+	): void
+}) {
+	const raw = useRaw()
+	const trackEvent = useTldrawAppUiEvents()
+
+	const handleChange = useCallback(() => {
+		const padding = !value
+		onChange('exportPadding', padding)
+		trackEvent('toggle-export-padding', { padding, source: 'file-share-menu' })
+	}, [trackEvent, value, onChange])
+
+	return (
+		<TlaMenuControl>
+			<TlaMenuControlLabel>{raw('Padding')}</TlaMenuControlLabel>
+			<TlaSwitch checked={value} onChange={handleChange} />
+		</TlaMenuControl>
+	)
+}
+
+function ExportBackgroundToggle({
+	value,
+	onChange,
+}: {
+	value: TldrawAppSessionState['exportSettings']['exportBackground']
+	onChange(
+		key: 'exportBackground',
+		value: TldrawAppSessionState['exportSettings']['exportBackground']
+	): void
+}) {
+	const raw = useRaw()
+	const trackEvent = useTldrawAppUiEvents()
+
+	const handleChange = useCallback(() => {
+		const background = !value
+		onChange('exportBackground', background)
+		trackEvent('toggle-export-background', { background, source: 'file-share-menu' })
+	}, [value, onChange, trackEvent])
+
+	return (
+		<TlaMenuControl>
+			<TlaMenuControlLabel>{raw('Background')}</TlaMenuControlLabel>
+			<TlaSwitch checked={value} onChange={handleChange} />
+		</TlaMenuControl>
+	)
+}
+
+function ExportFormatSelect({
+	value,
+	onChange,
+}: {
+	value: TldrawAppSessionState['exportSettings']['exportFormat']
+	onChange(
+		key: 'exportFormat',
+		value: TldrawAppSessionState['exportSettings']['exportFormat']
+	): void
+}) {
+	const raw = useRaw()
+	const trackEvent = useTldrawAppUiEvents()
+
+	const handleChange = useCallback(
+		(value: TldrawAppSessionState['exportSettings']['exportFormat']) => {
+			onChange('exportFormat', value)
+			trackEvent('set-export-format', { format: value, source: 'file-share-menu' })
+		},
+		[onChange, trackEvent]
+	)
+
+	return (
+		<TlaMenuControl>
+			<TlaMenuControlLabel>{raw('Export as')}</TlaMenuControlLabel>
+			<TlaSelect value={value} label={value === 'svg' ? 'SVG' : 'PNG'} onChange={handleChange}>
+				<option value="svg">{raw('SVG')}</option>
+				<option value="png">{raw('PNG')}</option>
+			</TlaSelect>
+		</TlaMenuControl>
+	)
+}
+
+function ExportThemeSelect({
+	value,
+	onChange,
+}: {
+	value: TldrawAppSessionState['exportSettings']['exportTheme']
+	onChange(key: 'exportTheme', value: TldrawAppSessionState['exportSettings']['exportTheme']): void
+}) {
+	const raw = useRaw()
+	const trackEvent = useTldrawAppUiEvents()
+	const handleChange = useCallback(
+		(value: TldrawAppSessionState['exportSettings']['exportTheme']) => {
+			onChange('exportTheme', value)
+			trackEvent('set-export-theme', { theme: value, source: 'file-share-menu' })
+		},
+		[onChange, trackEvent]
+	)
+
+	return (
+		<TlaMenuControl>
+			<TlaMenuControlLabel>{raw('Theme')}</TlaMenuControlLabel>
+			<TlaSelect
+				value={value}
+				label={value[0].toLocaleUpperCase() + value.slice(1)}
+				onChange={handleChange}
+			>
+				<option value="auto">{raw('Auto')}</option>
+				<option value="light">{raw('Light')}</option>
+				<option value="dark">{raw('Dark')}</option>
+			</TlaSelect>
+		</TlaMenuControl>
+	)
+}
+
+function ExportImageButton() {
+	const app = useMaybeApp()
+	const raw = useRaw()
+	const trackEvent = useTldrawAppUiEvents()
+
+	const [exported, setExported] = useState(false)
+
+	const handleClick = useCallback(() => {
+		if (exported) return
+
+		const editor = getCurrentEditor()
+		if (!editor) return
+
+		const { exportPadding, exportBackground, exportTheme, exportFormat } = getExportPreferences(app)
+
+		let fullPage = false
+
+		let ids = editor.getSelectedShapeIds()
+		if (ids.length === 0) {
+			fullPage = true
+			ids = editor.getSortedChildIdsForParent(editor.getCurrentPageId())
+		}
+
+		const opts: TLImageExportOptions = {
+			padding: exportPadding ? editor.options.defaultSvgPadding : 0,
+			background: exportBackground,
+			darkMode: exportTheme === 'auto' ? undefined : exportTheme === 'dark',
+		}
+
+		exportAs(editor, ids, exportFormat, 'file', opts)
+
+		trackEvent('export-image', {
+			source: 'file-share-menu',
+			fullPage,
+			padding: exportPadding,
+			background: !!opts.background,
+			theme: exportTheme,
+			format: exportFormat,
+		})
+
+		setExported(true)
+		setTimeout(() => setExported(false), 2500)
+
+		return () => {
+			setExported(false)
+		}
+	}, [exported, trackEvent, app])
+
+	return (
+		<>
+			<TlaButton className="tla-share-menu__copy-button" onClick={handleClick} iconRight="export">
+				{raw('Export image')}
+			</TlaButton>
+		</>
+	)
+}
+
+function ExportPreviewImage() {
+	const app = useMaybeApp()
+	const raw = useRaw()
+	const ref = useRef<HTMLImageElement>(null)
+
+	const [exportPreviewSize, setExportPreviewSize] = useState<null | string[]>(null)
+
+	useReactor(
+		'update preview',
+		() => {
+			let cancelled = false
+
+			const editor = globalEditor.get()
+			if (!editor) return
+
+			const preferences = getExportPreferences(app)
+
+			// We need shapes here so that the reactor updates when selected shapes change
+			let shapes = editor.getSelectedShapes()
+			if (shapes.length === 0) {
+				shapes = compact(
+					editor
+						.getSortedChildIdsForParent(editor.getCurrentPageId())
+						.map((s) => editor.getShape(s))
+				)
+			}
+
+			if (shapes.length === 0) {
+				const elm = ref.current
+				if (!elm) return
+				elm.setAttribute('src', '')
+				setExportPreviewSize(null)
+				return
+			}
+
+			// while lots of shapes are selected, debounce a little so that the thread doesn't freeze when editing the page
+			const fn = shapes.length > 20 ? getEditorImageSlowly : getEditorImage
+
+			fn(editor, shapes, preferences, ({ src, width, height }) => {
+				if (cancelled) return
+				const elm = ref.current
+				if (!elm) return
+				// We want to use an image element here so that a user can right click and copy / save / drag the qr code
+				elm.setAttribute('src', src)
+				setExportPreviewSize([width.toFixed(), height.toFixed()])
+			})
+
+			return () => {
+				cancelled = true
+			}
+		},
+		[]
+	)
+
+	return (
+		<div className={styles.exportPreview}>
+			<img ref={ref} className={styles.exportPreviewInner} />
+			{exportPreviewSize && (
+				<div className={classNames(styles.exportPreviewSize, 'tla-text_ui__small')}>
+					{raw(`${exportPreviewSize[0]}√ó${exportPreviewSize[1]}`)}
+				</div>
+			)}
+		</div>
+	)
+}
+
+async function getEditorImage(
+	editor: Editor,
+	shapes: TLShape[],
+	preferences: TldrawAppSessionState['exportSettings'],
+	cb: (info: { src: string; width: number; height: number }) => void
+) {
+	const { exportPadding, exportBackground, exportTheme } = preferences
+	const result = await editor.getSvgString(
+		shapes.map((s) => s.id),
+		{
+			padding: exportPadding ? editor.options.defaultSvgPadding : 0,
+			background: exportBackground,
+			darkMode: exportTheme === 'auto' ? undefined : exportTheme === 'dark',
+		}
+	)
+
+	if (!result) return
+
+	const blob = new Blob([result.svg], { type: 'image/svg+xml' })
+	const src = await FileHelpers.blobToDataUrl(blob)
+
+	cb({ src, width: result.width, height: result.height })
+}
+
+const getEditorImageSlowly = debounce(getEditorImage, 60)
+
+function getExportPreferences(app: TldrawApp | null) {
+	const sessionState = getLocalSessionState()
+
+	let { exportPadding, exportBackground, exportTheme, exportFormat } = sessionState.exportSettings
+
+	if (app && sessionState.auth) {
+		const user = app.getUser(sessionState.auth.userId)
+		if (user) {
+			exportPadding = user.exportPadding
+			exportBackground = user.exportBackground
+			exportTheme = user.exportTheme
+			exportFormat = user.exportFormat
+		}
+	}
+
+	return {
+		exportPadding,
+		exportBackground,
+		exportTheme,
+		exportFormat,
+	}
+}

commit 63f003023fc7af4d25b1a5f4f33ad8c25256a39e
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Thu Oct 24 15:35:00 2024 +0100

    [botcom] Add tooltips / links to Share Menu (#4765)
    
    <img width="745" alt="image"
    src="https://github.com/user-attachments/assets/74dd720b-beed-40a8-91ae-67cb974fc028">
    
    
    This PR:
    - adds help links to the share menu for sharing / publishing
    - stubs pages on notion for help content
    - removes the QR code from the publish tab
    - adds `lastPublished`
    - strips published data from file when publicating
    - removes copied toasts from menu
    - adds nice animation for updating published
    - adds one second of fake delay to update published
    
    ![Kapture 2024-10-24 at 15 02
    27](https://github.com/user-attachments/assets/ae9b114f-b9c7-48d8-a481-a769eb6ba5b5)
    
    
    ### Change type
    
    - [x] `other`

diff --git a/apps/dotcom/client/src/tla/components/TlaFileShareMenu/Tabs/TlaExportTab.tsx b/apps/dotcom/client/src/tla/components/TlaFileShareMenu/Tabs/TlaExportTab.tsx
index 0b36c5ef1..5a1f3f51c 100644
--- a/apps/dotcom/client/src/tla/components/TlaFileShareMenu/Tabs/TlaExportTab.tsx
+++ b/apps/dotcom/client/src/tla/components/TlaFileShareMenu/Tabs/TlaExportTab.tsx
@@ -246,10 +246,9 @@ function ExportImageButton() {
 
 function ExportPreviewImage() {
 	const app = useMaybeApp()
-	const raw = useRaw()
 	const ref = useRef<HTMLImageElement>(null)
 
-	const [exportPreviewSize, setExportPreviewSize] = useState<null | string[]>(null)
+	const rImagePreviewSize = useRef<HTMLDivElement>(null)
 
 	useReactor(
 		'update preview',
@@ -275,7 +274,8 @@ function ExportPreviewImage() {
 				const elm = ref.current
 				if (!elm) return
 				elm.setAttribute('src', '')
-				setExportPreviewSize(null)
+				const sizeElm = rImagePreviewSize.current
+				if (sizeElm) sizeElm.textContent = ''
 				return
 			}
 
@@ -288,7 +288,8 @@ function ExportPreviewImage() {
 				if (!elm) return
 				// We want to use an image element here so that a user can right click and copy / save / drag the qr code
 				elm.setAttribute('src', src)
-				setExportPreviewSize([width.toFixed(), height.toFixed()])
+				const sizeElm = rImagePreviewSize.current
+				if (sizeElm) sizeElm.textContent = `${width.toFixed()}√ó${height.toFixed()}`
 			})
 
 			return () => {
@@ -301,11 +302,10 @@ function ExportPreviewImage() {
 	return (
 		<div className={styles.exportPreview}>
 			<img ref={ref} className={styles.exportPreviewInner} />
-			{exportPreviewSize && (
-				<div className={classNames(styles.exportPreviewSize, 'tla-text_ui__small')}>
-					{raw(`${exportPreviewSize[0]}√ó${exportPreviewSize[1]}`)}
-				</div>
-			)}
+			<div
+				ref={rImagePreviewSize}
+				className={classNames(styles.exportPreviewSize, 'tla-text_ui__small')}
+			/>
 		</div>
 	)
 }

commit 5c2fba38c0b11471f14399d9d57920d9d557e645
Author: Mime ƒåuvalo <mimecuvalo@gmail.com>
Date:   Wed Nov 6 11:40:43 2024 +0000

    i18n: wire up strings (#4834)
    
    finds all the strings in botcom and integrates them into the new system
    
    ### Change type
    
    - [ ] `bugfix`
    - [ ] `improvement`
    - [ ] `feature`
    - [ ] `api`
    - [x] `other`

diff --git a/apps/dotcom/client/src/tla/components/TlaFileShareMenu/Tabs/TlaExportTab.tsx b/apps/dotcom/client/src/tla/components/TlaFileShareMenu/Tabs/TlaExportTab.tsx
index 5a1f3f51c..7a10931b2 100644
--- a/apps/dotcom/client/src/tla/components/TlaFileShareMenu/Tabs/TlaExportTab.tsx
+++ b/apps/dotcom/client/src/tla/components/TlaFileShareMenu/Tabs/TlaExportTab.tsx
@@ -13,8 +13,8 @@ import {
 } from 'tldraw'
 import { globalEditor } from '../../../../utils/globalEditor'
 import { TldrawApp } from '../../../app/TldrawApp'
+import { F, defineMessages, useIntl } from '../../../app/i18n'
 import { useMaybeApp } from '../../../hooks/useAppState'
-import { useRaw } from '../../../hooks/useRaw'
 import { useTldrawAppUiEvents } from '../../../utils/app-ui-events'
 import { getCurrentEditor } from '../../../utils/getCurrentEditor'
 import {
@@ -78,7 +78,6 @@ function ExportPaddingToggle({
 		value: TldrawAppSessionState['exportSettings']['exportPadding']
 	): void
 }) {
-	const raw = useRaw()
 	const trackEvent = useTldrawAppUiEvents()
 
 	const handleChange = useCallback(() => {
@@ -89,7 +88,9 @@ function ExportPaddingToggle({
 
 	return (
 		<TlaMenuControl>
-			<TlaMenuControlLabel>{raw('Padding')}</TlaMenuControlLabel>
+			<TlaMenuControlLabel>
+				<F defaultMessage="Padding" />
+			</TlaMenuControlLabel>
 			<TlaSwitch checked={value} onChange={handleChange} />
 		</TlaMenuControl>
 	)
@@ -105,7 +106,6 @@ function ExportBackgroundToggle({
 		value: TldrawAppSessionState['exportSettings']['exportBackground']
 	): void
 }) {
-	const raw = useRaw()
 	const trackEvent = useTldrawAppUiEvents()
 
 	const handleChange = useCallback(() => {
@@ -116,7 +116,9 @@ function ExportBackgroundToggle({
 
 	return (
 		<TlaMenuControl>
-			<TlaMenuControlLabel>{raw('Background')}</TlaMenuControlLabel>
+			<TlaMenuControlLabel>
+				<F defaultMessage="Background" />
+			</TlaMenuControlLabel>
 			<TlaSwitch checked={value} onChange={handleChange} />
 		</TlaMenuControl>
 	)
@@ -132,7 +134,6 @@ function ExportFormatSelect({
 		value: TldrawAppSessionState['exportSettings']['exportFormat']
 	): void
 }) {
-	const raw = useRaw()
 	const trackEvent = useTldrawAppUiEvents()
 
 	const handleChange = useCallback(
@@ -145,15 +146,27 @@ function ExportFormatSelect({
 
 	return (
 		<TlaMenuControl>
-			<TlaMenuControlLabel>{raw('Export as')}</TlaMenuControlLabel>
+			<TlaMenuControlLabel>
+				<F defaultMessage="Export as" />
+			</TlaMenuControlLabel>
 			<TlaSelect value={value} label={value === 'svg' ? 'SVG' : 'PNG'} onChange={handleChange}>
-				<option value="svg">{raw('SVG')}</option>
-				<option value="png">{raw('PNG')}</option>
+				<option value="svg">
+					<F defaultMessage="SVG" />
+				</option>
+				<option value="png">
+					<F defaultMessage="PNG" />
+				</option>
 			</TlaSelect>
 		</TlaMenuControl>
 	)
 }
 
+const messages = defineMessages({
+	auto: { defaultMessage: 'Auto' },
+	light: { defaultMessage: 'Light' },
+	dark: { defaultMessage: 'Dark' },
+})
+
 function ExportThemeSelect({
 	value,
 	onChange,
@@ -161,7 +174,7 @@ function ExportThemeSelect({
 	value: TldrawAppSessionState['exportSettings']['exportTheme']
 	onChange(key: 'exportTheme', value: TldrawAppSessionState['exportSettings']['exportTheme']): void
 }) {
-	const raw = useRaw()
+	const intl = useIntl()
 	const trackEvent = useTldrawAppUiEvents()
 	const handleChange = useCallback(
 		(value: TldrawAppSessionState['exportSettings']['exportTheme']) => {
@@ -171,17 +184,22 @@ function ExportThemeSelect({
 		[onChange, trackEvent]
 	)
 
+	const label = intl.formatMessage(messages[value])
 	return (
 		<TlaMenuControl>
-			<TlaMenuControlLabel>{raw('Theme')}</TlaMenuControlLabel>
-			<TlaSelect
-				value={value}
-				label={value[0].toLocaleUpperCase() + value.slice(1)}
-				onChange={handleChange}
-			>
-				<option value="auto">{raw('Auto')}</option>
-				<option value="light">{raw('Light')}</option>
-				<option value="dark">{raw('Dark')}</option>
+			<TlaMenuControlLabel>
+				<F defaultMessage="Theme" />
+			</TlaMenuControlLabel>
+			<TlaSelect value={value} label={label} onChange={handleChange}>
+				<option value="auto">
+					<F defaultMessage="Auto" />
+				</option>
+				<option value="light">
+					<F defaultMessage="Light" />
+				</option>
+				<option value="dark">
+					<F defaultMessage="Dark" />
+				</option>
 			</TlaSelect>
 		</TlaMenuControl>
 	)
@@ -189,7 +207,6 @@ function ExportThemeSelect({
 
 function ExportImageButton() {
 	const app = useMaybeApp()
-	const raw = useRaw()
 	const trackEvent = useTldrawAppUiEvents()
 
 	const [exported, setExported] = useState(false)
@@ -238,7 +255,7 @@ function ExportImageButton() {
 	return (
 		<>
 			<TlaButton className="tla-share-menu__copy-button" onClick={handleClick} iconRight="export">
-				{raw('Export image')}
+				<F defaultMessage="Export image" />
 			</TlaButton>
 		</>
 	)

commit 51310c28a1933528586ca540c039289c3e7de496
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Mon Nov 11 11:10:41 2024 +0000

    [wip] custom botcom backend (#4879)
    
    Describe what your pull request does. If you can, add GIFs or images
    showing the before and after of your change.
    
    ### Change type
    
    - [ ] `bugfix`
    - [ ] `improvement`
    - [ ] `feature`
    - [ ] `api`
    - [x] `other`
    
    ### Test plan
    
    1. Create a shape...
    2.
    
    - [ ] Unit tests
    - [ ] End to end tests
    
    ### Release notes
    
    - Fixed a bug with‚Ä¶
    
    ---------
    
    Co-authored-by: Mitja Bezen≈°ek <mitja.bezensek@gmail.com>

diff --git a/apps/dotcom/client/src/tla/components/TlaFileShareMenu/Tabs/TlaExportTab.tsx b/apps/dotcom/client/src/tla/components/TlaFileShareMenu/Tabs/TlaExportTab.tsx
index 7a10931b2..f93669fac 100644
--- a/apps/dotcom/client/src/tla/components/TlaFileShareMenu/Tabs/TlaExportTab.tsx
+++ b/apps/dotcom/client/src/tla/components/TlaFileShareMenu/Tabs/TlaExportTab.tsx
@@ -233,7 +233,7 @@ function ExportImageButton() {
 			darkMode: exportTheme === 'auto' ? undefined : exportTheme === 'dark',
 		}
 
-		exportAs(editor, ids, exportFormat, 'file', opts)
+		exportAs(editor, ids, exportFormat as any, 'file', opts)
 
 		trackEvent('export-image', {
 			source: 'file-share-menu',
@@ -359,7 +359,7 @@ function getExportPreferences(app: TldrawApp | null) {
 	let { exportPadding, exportBackground, exportTheme, exportFormat } = sessionState.exportSettings
 
 	if (app && sessionState.auth) {
-		const user = app.getUser(sessionState.auth.userId)
+		const user = app.getUser()
 		if (user) {
 			exportPadding = user.exportPadding
 			exportBackground = user.exportBackground

commit 2e534b6f70c2950a1b754e12359bd786a62890f3
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Mon Nov 11 11:39:22 2024 +0000

    Revert "[wip] custom botcom backend" (#4883)
    
    Reverts tldraw/tldraw#487
    
    - [x] other

diff --git a/apps/dotcom/client/src/tla/components/TlaFileShareMenu/Tabs/TlaExportTab.tsx b/apps/dotcom/client/src/tla/components/TlaFileShareMenu/Tabs/TlaExportTab.tsx
index f93669fac..7a10931b2 100644
--- a/apps/dotcom/client/src/tla/components/TlaFileShareMenu/Tabs/TlaExportTab.tsx
+++ b/apps/dotcom/client/src/tla/components/TlaFileShareMenu/Tabs/TlaExportTab.tsx
@@ -233,7 +233,7 @@ function ExportImageButton() {
 			darkMode: exportTheme === 'auto' ? undefined : exportTheme === 'dark',
 		}
 
-		exportAs(editor, ids, exportFormat as any, 'file', opts)
+		exportAs(editor, ids, exportFormat, 'file', opts)
 
 		trackEvent('export-image', {
 			source: 'file-share-menu',
@@ -359,7 +359,7 @@ function getExportPreferences(app: TldrawApp | null) {
 	let { exportPadding, exportBackground, exportTheme, exportFormat } = sessionState.exportSettings
 
 	if (app && sessionState.auth) {
-		const user = app.getUser()
+		const user = app.getUser(sessionState.auth.userId)
 		if (user) {
 			exportPadding = user.exportPadding
 			exportBackground = user.exportBackground

commit 8d8471f530a48377b3223b8cb64647ef3e590a36
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Mon Nov 11 11:49:21 2024 +0000

    [botcom] New backend (again) (#4884)
    
    re-attempt at #4879
    So it turns out you have to delete a durable object class in two
    deploys:
    
    1. stop using it
    2. add the 'delete' migration in wrangler.toml
    
    - [x] `other`
    
    ---------
    
    Co-authored-by: Mitja Bezen≈°ek <mitja.bezensek@gmail.com>

diff --git a/apps/dotcom/client/src/tla/components/TlaFileShareMenu/Tabs/TlaExportTab.tsx b/apps/dotcom/client/src/tla/components/TlaFileShareMenu/Tabs/TlaExportTab.tsx
index 7a10931b2..f93669fac 100644
--- a/apps/dotcom/client/src/tla/components/TlaFileShareMenu/Tabs/TlaExportTab.tsx
+++ b/apps/dotcom/client/src/tla/components/TlaFileShareMenu/Tabs/TlaExportTab.tsx
@@ -233,7 +233,7 @@ function ExportImageButton() {
 			darkMode: exportTheme === 'auto' ? undefined : exportTheme === 'dark',
 		}
 
-		exportAs(editor, ids, exportFormat, 'file', opts)
+		exportAs(editor, ids, exportFormat as any, 'file', opts)
 
 		trackEvent('export-image', {
 			source: 'file-share-menu',
@@ -359,7 +359,7 @@ function getExportPreferences(app: TldrawApp | null) {
 	let { exportPadding, exportBackground, exportTheme, exportFormat } = sessionState.exportSettings
 
 	if (app && sessionState.auth) {
-		const user = app.getUser(sessionState.auth.userId)
+		const user = app.getUser()
 		if (user) {
 			exportPadding = user.exportPadding
 			exportBackground = user.exportBackground

commit aa1a8fe60eb4eaba4af9d32af02d86b54f08ec81
Author: Mime ƒåuvalo <mimecuvalo@gmail.com>
Date:   Mon Nov 18 10:43:01 2024 +0000

    botcom: add react-select for better select menus (#4920)
    
    I noticed while looking into
    https://linear.app/tldraw/issue/INT-468/issues-with-react-intl-wrapping-translations-into-spans-when-using
    that we should just be using a richer Select menu option that allows for
    content other than just strings.
    
    This brings the radix-select library into use for our selects instead of
    just the raw/native browser one.
    
    <img width="263" alt="Screenshot 2024-11-14 at 12 24 00"
    src="https://github.com/user-attachments/assets/391c477a-2af9-4cd7-8417-3b7b8d49834c">
    
    
    ### Change type
    
    - [ ] `bugfix`
    - [ ] `improvement`
    - [ ] `feature`
    - [ ] `api`
    - [x] `other`

diff --git a/apps/dotcom/client/src/tla/components/TlaFileShareMenu/Tabs/TlaExportTab.tsx b/apps/dotcom/client/src/tla/components/TlaFileShareMenu/Tabs/TlaExportTab.tsx
index f93669fac..2214925d2 100644
--- a/apps/dotcom/client/src/tla/components/TlaFileShareMenu/Tabs/TlaExportTab.tsx
+++ b/apps/dotcom/client/src/tla/components/TlaFileShareMenu/Tabs/TlaExportTab.tsx
@@ -149,14 +149,15 @@ function ExportFormatSelect({
 			<TlaMenuControlLabel>
 				<F defaultMessage="Export as" />
 			</TlaMenuControlLabel>
-			<TlaSelect value={value} label={value === 'svg' ? 'SVG' : 'PNG'} onChange={handleChange}>
-				<option value="svg">
-					<F defaultMessage="SVG" />
-				</option>
-				<option value="png">
-					<F defaultMessage="PNG" />
-				</option>
-			</TlaSelect>
+			<TlaSelect
+				value={value}
+				label={value === 'svg' ? 'SVG' : 'PNG'}
+				onChange={handleChange}
+				options={[
+					{ value: 'svg', label: <F defaultMessage="SVG" /> },
+					{ value: 'png', label: <F defaultMessage="PNG" /> },
+				]}
+			/>
 		</TlaMenuControl>
 	)
 }
@@ -190,17 +191,16 @@ function ExportThemeSelect({
 			<TlaMenuControlLabel>
 				<F defaultMessage="Theme" />
 			</TlaMenuControlLabel>
-			<TlaSelect value={value} label={label} onChange={handleChange}>
-				<option value="auto">
-					<F defaultMessage="Auto" />
-				</option>
-				<option value="light">
-					<F defaultMessage="Light" />
-				</option>
-				<option value="dark">
-					<F defaultMessage="Dark" />
-				</option>
-			</TlaSelect>
+			<TlaSelect
+				value={value}
+				label={label}
+				onChange={handleChange}
+				options={[
+					{ value: 'auto', label: <F defaultMessage="Auto" /> },
+					{ value: 'light', label: <F defaultMessage="Light" /> },
+					{ value: 'dark', label: <F defaultMessage="Dark" /> },
+				]}
+			/>
 		</TlaMenuControl>
 	)
 }

commit 73f6dccd86f2a06575be2e8c64920959adf5537a
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Sun Nov 24 14:07:38 2024 +0000

    Add eslint rule for react-intl. (#4983)
    
    We want all of our files to use our wrapped version of react-intl. This
    _should_ fix auto imports resolving to react-int by mistake.
    
    ### Change type
    
    - [ ] `bugfix`
    - [ ] `improvement`
    - [ ] `feature`
    - [ ] `api`
    - [x] `other`

diff --git a/apps/dotcom/client/src/tla/components/TlaFileShareMenu/Tabs/TlaExportTab.tsx b/apps/dotcom/client/src/tla/components/TlaFileShareMenu/Tabs/TlaExportTab.tsx
index 2214925d2..2d5e1485b 100644
--- a/apps/dotcom/client/src/tla/components/TlaFileShareMenu/Tabs/TlaExportTab.tsx
+++ b/apps/dotcom/client/src/tla/components/TlaFileShareMenu/Tabs/TlaExportTab.tsx
@@ -13,10 +13,10 @@ import {
 } from 'tldraw'
 import { globalEditor } from '../../../../utils/globalEditor'
 import { TldrawApp } from '../../../app/TldrawApp'
-import { F, defineMessages, useIntl } from '../../../app/i18n'
 import { useMaybeApp } from '../../../hooks/useAppState'
 import { useTldrawAppUiEvents } from '../../../utils/app-ui-events'
 import { getCurrentEditor } from '../../../utils/getCurrentEditor'
+import { F, defineMessages, useIntl } from '../../../utils/i18n'
 import {
 	TldrawAppSessionState,
 	getLocalSessionState,

commit 68491f0ffc96f801d17620680b738173dec29e20
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Sun Nov 24 21:14:33 2024 +0000

    Revert "Add eslint rule for react-intl." (#4985)
    
    Reverts tldraw/tldraw#4983

diff --git a/apps/dotcom/client/src/tla/components/TlaFileShareMenu/Tabs/TlaExportTab.tsx b/apps/dotcom/client/src/tla/components/TlaFileShareMenu/Tabs/TlaExportTab.tsx
index 2d5e1485b..2214925d2 100644
--- a/apps/dotcom/client/src/tla/components/TlaFileShareMenu/Tabs/TlaExportTab.tsx
+++ b/apps/dotcom/client/src/tla/components/TlaFileShareMenu/Tabs/TlaExportTab.tsx
@@ -13,10 +13,10 @@ import {
 } from 'tldraw'
 import { globalEditor } from '../../../../utils/globalEditor'
 import { TldrawApp } from '../../../app/TldrawApp'
+import { F, defineMessages, useIntl } from '../../../app/i18n'
 import { useMaybeApp } from '../../../hooks/useAppState'
 import { useTldrawAppUiEvents } from '../../../utils/app-ui-events'
 import { getCurrentEditor } from '../../../utils/getCurrentEditor'
-import { F, defineMessages, useIntl } from '../../../utils/i18n'
 import {
 	TldrawAppSessionState,
 	getLocalSessionState,

commit 5bcd5873e53853dbf0603292f2a3aadca23aa3db
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Mon Nov 25 17:12:29 2024 +0000

    [botcom] Pre-launch design / UX pass (#4984)
    
    Are you ready to go? I'm ready to go! This PR does a few design and UX
    changes ahead of the launch.
    
    Logged out, root page
    
    <img width="1241" alt="Screenshot 2024-11-24 at 21 05 17"
    src="https://github.com/user-attachments/assets/b4b0dea7-5140-417e-b9fd-986a571eeaba">
    
    Logged out, published page
    
    <img width="1241" alt="image"
    src="https://github.com/user-attachments/assets/fb7435b4-9713-43c8-991d-e6db60f18237">
    
    Logged out, file page
    
    <img width="1241" alt="Screenshot 2024-11-24 at 21 05 59"
    src="https://github.com/user-attachments/assets/afebe371-8808-400a-bac8-d5055cf53698">
    
    Logged in, file page
    
    <img width="1241" alt="Screenshot 2024-11-24 at 21 01 05"
    src="https://github.com/user-attachments/assets/1da95e8d-e000-4fab-95c4-1beb58ea372c">
    
    Logged in, guest file
    
    <img width="1241" alt="Screenshot 2024-11-24 at 21 02 33"
    src="https://github.com/user-attachments/assets/2a5a3ff5-11e1-46db-af2d-7d3ac9eb3778">
    
    Logged in, published file
    
    <img width="1241" alt="Screenshot 2024-11-24 at 21 03 26"
    src="https://github.com/user-attachments/assets/d832775e-ac55-43a4-8f93-35e1793a92a7">
    
    
    ### General sidebar / editor
    - parts sidebar components into their own files
    - cleans up some weird props in sidebar items
    - fixes spacing in the "workspace header"
    - fixes spacing in the file editor top left
    - fix icon weight difference in file editor top left
    - set mobile sidebar width to max(220px, 100%-100px)
    - animate desktop sidebar open/close
    - move menu items into the file menu (except for app-level things)
    - adds sidebar items to menu for logged out users
    - adds sign in to menu for logged out users
    - adds shortcut (Cmd + \) to toggle sidebar on desktop
    
    <img width="1241" alt="Screenshot 2024-11-24 at 21 03 43"
    src="https://github.com/user-attachments/assets/5e32019b-ef7f-457a-9d76-c94710e8c832">
    
    <img width="577" alt="image"
    src="https://github.com/user-attachments/assets/426b718d-d788-4503-bcdb-d5d1ce269e92">
    
    
    ### Anon layout
    - redesign anonymous layout
    - remove share menu / export options from anon pages
    
    ### Publish menu
    - redesign share menu for published projects
    
    ### Guest file
    - adds a temporary "collaborator" in sidebar for guest files
    - fix a bug where a user could edit the name of a file they don't own
    
    ### Creating too many pages
    - adds 1s timeout for creating new files
    
    ### Published file
    - fix document name in published files
    
    ### Sidebar user link
    - moved editor-related preferences into the editor
    - extracted the theme and language (they appear in both menus)
    
    <img width="417" alt="image"
    src="https://github.com/user-attachments/assets/550dcbbe-7b3a-46e4-b29a-d1ceff313b11">
    
    ### useMsg
    
    Add a `useMsg` hook that calls `useIntl().formatMessage`.
    
    ### Playground
    - creates a very small playground route where we can view components in
    different states. I don't like committing to this kind of storybook
    style documentation, so let's just use this when needed.
    
    ### Change type
    
    - [ ] `bugfix`
    - [ ] `improvement`
    - [ ] `feature`
    - [ ] `api`
    - [x] `other`
    
    ---------
    
    Co-authored-by: Mitja Bezen≈°ek <mitja.bezensek@gmail.com>

diff --git a/apps/dotcom/client/src/tla/components/TlaFileShareMenu/Tabs/TlaExportTab.tsx b/apps/dotcom/client/src/tla/components/TlaFileShareMenu/Tabs/TlaExportTab.tsx
index 2214925d2..4b332c51a 100644
--- a/apps/dotcom/client/src/tla/components/TlaFileShareMenu/Tabs/TlaExportTab.tsx
+++ b/apps/dotcom/client/src/tla/components/TlaFileShareMenu/Tabs/TlaExportTab.tsx
@@ -13,10 +13,10 @@ import {
 } from 'tldraw'
 import { globalEditor } from '../../../../utils/globalEditor'
 import { TldrawApp } from '../../../app/TldrawApp'
-import { F, defineMessages, useIntl } from '../../../app/i18n'
 import { useMaybeApp } from '../../../hooks/useAppState'
 import { useTldrawAppUiEvents } from '../../../utils/app-ui-events'
 import { getCurrentEditor } from '../../../utils/getCurrentEditor'
+import { F, defineMessages, useMsg } from '../../../utils/i18n'
 import {
 	TldrawAppSessionState,
 	getLocalSessionState,
@@ -175,7 +175,7 @@ function ExportThemeSelect({
 	value: TldrawAppSessionState['exportSettings']['exportTheme']
 	onChange(key: 'exportTheme', value: TldrawAppSessionState['exportSettings']['exportTheme']): void
 }) {
-	const intl = useIntl()
+	const label = useMsg(messages[value])
 	const trackEvent = useTldrawAppUiEvents()
 	const handleChange = useCallback(
 		(value: TldrawAppSessionState['exportSettings']['exportTheme']) => {
@@ -185,7 +185,6 @@ function ExportThemeSelect({
 		[onChange, trackEvent]
 	)
 
-	const label = intl.formatMessage(messages[value])
 	return (
 		<TlaMenuControl>
 			<TlaMenuControlLabel>

commit b8acb5d79aabb6f38a29f26aa62524a13f426f64
Author: Mime ƒåuvalo <mimecuvalo@gmail.com>
Date:   Wed Nov 27 10:54:32 2024 +0000

    i18n: better typing and fix tldr file drop (#5006)
    
    fix up bad i18n typing on defineMessages
    
    ### Change type
    
    - [ ] `bugfix`
    - [ ] `improvement`
    - [ ] `feature`
    - [ ] `api`
    - [x] `other`

diff --git a/apps/dotcom/client/src/tla/components/TlaFileShareMenu/Tabs/TlaExportTab.tsx b/apps/dotcom/client/src/tla/components/TlaFileShareMenu/Tabs/TlaExportTab.tsx
index 4b332c51a..cc8a6a1e8 100644
--- a/apps/dotcom/client/src/tla/components/TlaFileShareMenu/Tabs/TlaExportTab.tsx
+++ b/apps/dotcom/client/src/tla/components/TlaFileShareMenu/Tabs/TlaExportTab.tsx
@@ -175,7 +175,7 @@ function ExportThemeSelect({
 	value: TldrawAppSessionState['exportSettings']['exportTheme']
 	onChange(key: 'exportTheme', value: TldrawAppSessionState['exportSettings']['exportTheme']): void
 }) {
-	const label = useMsg(messages[value])
+	const label = useMsg(messages[value as 'auto' | 'light' | 'dark'])
 	const trackEvent = useTldrawAppUiEvents()
 	const handleChange = useCallback(
 		(value: TldrawAppSessionState['exportSettings']['exportTheme']) => {

commit 5ed55f12f0508edec34292d7c1bdd08b4e8c21a1
Author: alex <alex@dytry.ch>
Date:   Mon Jan 20 18:19:00 2025 +0000

    Exports DX pass (#5114)
    
    Over the last few weeks we've had a lot of requests on discord around
    asset resolution, exports, and the two together. Some of the APIs here
    have evolved and change independently of each other over time, so I
    wanted to take a pass at making them make sense with each other a bit
    more. There are a few things going on in this diff:
    
    1. **BREAKING** The export/copy-as JSON option has been removed. I think
    this was only ever there as a debug helper, and it's impossible to
    actually make use of the JSON once copied (it's not the same as .tldr
    json which confuses people).
    2. `exportToBlob` is deprecated in favour of a new `Editor.toImage`
    method. `exportToBlob` has been the canonical 'turn the canvas into an
    image' helper for a while, but it has quite a weird looking signature
    and isn't very discoverable.
    3. the `copyAs` and `exportAs` helpers have had a couple of args merged
    into the options bag for consistency.
    4. The `jpeg` format has been removed from `copyAs`. This is technically
    a breaking API change, but since it never actually worked anyway due to
    browser limitations i think its fine.
    5. SVG exports now resolve assets according to how they'll be used:
    - if it's for an SVG, we still use the existing
    `shouldResolveToOriginal` behaviour
    - if it's for a bitmap export, we request an image downscaled according
    to the size it will appear in that resulting bitmap.
    6. Better reference docs for several APIs around this stuff.
    7. **BREAKING** the `useImageOrVideoAsset` hook now requires passing in
    `width`, instead of reading `shape.props.w`. This is so it can be used
    with shapes other than our own. Whilst this is technically a breaking
    change, this limitation means its unlikely that it was used with many
    custom shapes in practice.
    8. The clamping that we used to apply in to `steppedScreenScale` in
    `resolveAssetUrl` has been moved to our own implementations of
    `TLAssetStore`. This is so implementors can make their own decisions
    about the range of scalings they might want to use.
    9. The `steppedScreenScale` limit changed from 1/8 to 1/32. This is
    because when testing with full res photos from a modern smartphone, we
    were still downloading a 1000+px image in order to render it at a few
    hundred px across (and also we don't pay anything for these right now).
    Happy to change now/in the future if this doesn't seem right though.
    
    ### Change type
    
    - [x] `api`
    
    ### Release notes
    
    #### Breaking changes / user facing changes
    - The copy/export as JSON option has been removed. Data copied/exported
    from here could not be used anyway. If you need this in your app, look
    into `Editor.getContentFromCurrentPage`.
    - `useImageOrVideoAssetUrl` now expects a `width` parameter representing
    the rendered width of the asset.
    - `Editor.getSvgElement` and `Editor.getSvgString` will now export all
    shapes on the current page instead of returning undefined when passed an
    empty array of shape ids.
    
    #### Product improvement
    - When exporting to an image, image assets are now downloaded at a
    resolution appropriate for how they will appear in the export.
    
    #### API changes
    - There's a new `Editor.toImage` method that makes creating an image
    from your canvas easier. (`exportToBlob` is deprecated in favour of it)
    - `SvgExportContext` now exposes the `scale` and `pixelRatio` options of
    the current export
    - `SvgExportContext` now has a `resolveAssetUrl` method to resolve an
    asset at a resolution appropriate for the export.
    - `copyAs(editor, ids, format, opts)` has been deprecated in favour of
    `copyAs(editor, ids, opts)`.
    - `exportAs(editor, ids, format, name, opts)` has been deprecated in
    favour of `exportAs(editor, ids, opts)`

diff --git a/apps/dotcom/client/src/tla/components/TlaFileShareMenu/Tabs/TlaExportTab.tsx b/apps/dotcom/client/src/tla/components/TlaFileShareMenu/Tabs/TlaExportTab.tsx
index cc8a6a1e8..0eec88fe7 100644
--- a/apps/dotcom/client/src/tla/components/TlaFileShareMenu/Tabs/TlaExportTab.tsx
+++ b/apps/dotcom/client/src/tla/components/TlaFileShareMenu/Tabs/TlaExportTab.tsx
@@ -3,7 +3,7 @@ import { useCallback, useRef, useState } from 'react'
 import {
 	Editor,
 	FileHelpers,
-	TLImageExportOptions,
+	TLExportType,
 	TLShape,
 	compact,
 	debounce,
@@ -226,13 +226,14 @@ function ExportImageButton() {
 			ids = editor.getSortedChildIdsForParent(editor.getCurrentPageId())
 		}
 
-		const opts: TLImageExportOptions = {
+		const opts = {
 			padding: exportPadding ? editor.options.defaultSvgPadding : 0,
 			background: exportBackground,
 			darkMode: exportTheme === 'auto' ? undefined : exportTheme === 'dark',
+			format: exportFormat as TLExportType,
 		}
 
-		exportAs(editor, ids, exportFormat as any, 'file', opts)
+		exportAs(editor, ids, opts)
 
 		trackEvent('export-image', {
 			source: 'file-share-menu',

commit 7bd13bef2242ee7fe295607dfa87c248b6c0537c
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Tue Feb 25 16:43:51 2025 +0000

    [botcom] Fix slow export menu in big files (#5435)
    
    This PR fixes an issue where large files or files with GIFs / large
    images could freeze when opening the export menu.
    
    
    https://github.com/user-attachments/assets/af0b21c2-d50b-4106-bef6-7738868f863e
    
    ## GIFs
    
    Previously, we were inlining the entire GIF when creating an SVG. We now
    only inline the first frame. This was a crashing bug previously.
    
    ## Images / asset caching
    
    Previously, we were loading a URL for each image or video shape. We now
    cache the result of the previous generation, so that we only load one
    image per asset. This is especially important for GIFs because the work
    to generate the export image src associated with the asset was
    expensive.
    
    ## File size
    
    Previously, the image shown in the export panel could be very very large
    depending on the size of the canvas.
    
    **Problem**
    
    When we export images, we do so at 100% resolution. For large canvases,
    that can result in images which are very large (e.g. 5000x5000px or
    larger). Creating and displaying such a large image can be extremely
    hard on resources.
    
    **Solution**
    
    In this PR, we find a **scale** for the image based on the common bounds
    of the selected shapes, then apply that scale to keep the image small
    (under 500x500 pixels). We also use png instead of svg as the output
    format, which for small but dense images should work better. Together,
    these lead to preview images for even very large files (4000 draw
    shapes) being relatively quick. The actual exports are unaffected and
    slower.
    
    ### Change type
    
    - [x] `bugfix`
    - [ ] `improvement`
    - [ ] `feature`
    - [ ] `api`
    - [ ] `other`
    
    ### Test plan
    
    1. Visit a very large file.
    2. Open the export menu.
    
    ### Release notes
    
    - Fixed a bug with export menu performance.

diff --git a/apps/dotcom/client/src/tla/components/TlaFileShareMenu/Tabs/TlaExportTab.tsx b/apps/dotcom/client/src/tla/components/TlaFileShareMenu/Tabs/TlaExportTab.tsx
index 0eec88fe7..f35b1c2fc 100644
--- a/apps/dotcom/client/src/tla/components/TlaFileShareMenu/Tabs/TlaExportTab.tsx
+++ b/apps/dotcom/client/src/tla/components/TlaFileShareMenu/Tabs/TlaExportTab.tsx
@@ -1,6 +1,7 @@
 import classNames from 'classnames'
 import { useCallback, useRef, useState } from 'react'
 import {
+	Box,
 	Editor,
 	FileHelpers,
 	TLExportType,
@@ -334,21 +335,25 @@ async function getEditorImage(
 	cb: (info: { src: string; width: number; height: number }) => void
 ) {
 	const { exportPadding, exportBackground, exportTheme } = preferences
-	const result = await editor.getSvgString(
-		shapes.map((s) => s.id),
-		{
-			padding: exportPadding ? editor.options.defaultSvgPadding : 0,
-			background: exportBackground,
-			darkMode: exportTheme === 'auto' ? undefined : exportTheme === 'dark',
-		}
-	)
+
+	const commonBounds = Box.Common(shapes.map((s) => editor.getShapePageBounds(s)!))
+
+	// image max is 216x216, so let's say 500 to be nice and safe
+	const scale = Math.min(500 / commonBounds.width, 500 / commonBounds.height)
+
+	const result = await editor.toImage(shapes, {
+		scale,
+		format: 'png',
+		padding: exportPadding ? editor.options.defaultSvgPadding : 0,
+		background: exportBackground,
+		darkMode: exportTheme === 'auto' ? undefined : exportTheme === 'dark',
+	})
 
 	if (!result) return
 
-	const blob = new Blob([result.svg], { type: 'image/svg+xml' })
-	const src = await FileHelpers.blobToDataUrl(blob)
+	const src = await FileHelpers.blobToDataUrl(result.blob)
 
-	cb({ src, width: result.width, height: result.height })
+	cb({ src, width: Math.ceil(result.width / scale), height: Math.ceil(result.height / scale) })
 }
 
 const getEditorImageSlowly = debounce(getEditorImage, 60)

</code></pre>
        </section>
    </main>
    <footer>
        <p>LoCoDiff-bench - <a href="https://github.com/AbanteAI/LoCoDiff-bench">GitHub Repository</a></p>
    </footer>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            hljs.highlightAll();
        });
    </script>
</body>
</html>
    