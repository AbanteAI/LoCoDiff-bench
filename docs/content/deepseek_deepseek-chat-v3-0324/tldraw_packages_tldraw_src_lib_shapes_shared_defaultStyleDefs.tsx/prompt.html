<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prompt: packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx - DeepSeek Chat v3-0324</title>
    <link rel="stylesheet" href="../../../../styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/default.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
</head>
<body>
    <header>
        <h1>Prompt: packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx</h1>
        <p><a href="../../../cases/deepseek_deepseek-chat-v3-0324/tldraw_packages_tldraw_src_lib_shapes_shared_defaultStyleDefs.tsx.html">← Back to Case</a> | <a href="../../../index.html">Home</a></p>
    </header>
    <main>
        <section>
            <h2>Prompt Content</h2>
            <pre><code class="language-plaintext"># Instructions

You are being benchmarked. You will see the output of a git log command, and from that must infer the current state of a file. Think carefully, as you must output the exact state of the file to earn full marks.

**Important:** Your goal is to reproduce the file's content *exactly* as it exists at the final commit, even if the code appears broken, buggy, or contains obvious errors. Do **not** try to "fix" the code. Attempting to correct issues will result in a poor score, as this benchmark evaluates your ability to reproduce the precise state of the file based on its history.

# Required Response Format

Wrap the content of the file in triple backticks (```). Any text outside the final closing backticks will be ignored. End your response after outputting the closing backticks.

# Example Response

```python
#!/usr/bin/env python
print('Hello, world!')
```

# File History

> git log -p --cc --topo-order --reverse -- packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx

commit b7d9c8684cb6cf7bd710af5420135ea3516cc3bf
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Mon Jul 17 22:22:34 2023 +0100

    tldraw zero - package shuffle (#1710)
    
    This PR moves code between our packages so that:
    - @tldraw/editor is a “core” library with the engine and canvas but no
    shapes, tools, or other things
    - @tldraw/tldraw contains everything particular to the experience we’ve
    built for tldraw
    
    At first look, this might seem like a step away from customization and
    configuration, however I believe it greatly increases the configuration
    potential of the @tldraw/editor while also providing a more accurate
    reflection of what configuration options actually exist for
    @tldraw/tldraw.
    
    ## Library changes
    
    @tldraw/editor re-exports its dependencies and @tldraw/tldraw re-exports
    @tldraw/editor.
    
    - users of @tldraw/editor WITHOUT @tldraw/tldraw should almost always
    only import things from @tldraw/editor.
    - users of @tldraw/tldraw should almost always only import things from
    @tldraw/tldraw.
    
    - @tldraw/polyfills is merged into @tldraw/editor
    - @tldraw/indices is merged into @tldraw/editor
    - @tldraw/primitives is merged mostly into @tldraw/editor, partially
    into @tldraw/tldraw
    - @tldraw/file-format is merged into @tldraw/tldraw
    - @tldraw/ui is merged into @tldraw/tldraw
    
    Many (many) utils and other code is moved from the editor to tldraw. For
    example, embeds now are entirely an feature of @tldraw/tldraw. The only
    big chunk of code left in core is related to arrow handling.
    
    ## API Changes
    
    The editor can now be used without tldraw's assets. We load them in
    @tldraw/tldraw instead, so feel free to use whatever fonts or images or
    whatever that you like with the editor.
    
    All tools and shapes (except for the `Group` shape) are moved to
    @tldraw/tldraw. This includes the `select` tool.
    
    You should use the editor with at least one tool, however, so you now
    also need to send in an `initialState` prop to the Editor /
    <TldrawEditor> component indicating which state the editor should begin
    in.
    
    The `components` prop now also accepts `SelectionForeground`.
    
    The complex selection component that we use for tldraw is moved to
    @tldraw/tldraw. The default component is quite basic but can easily be
    replaced via the `components` prop. We pass down our tldraw-flavored
    SelectionFg via `components`.
    
    Likewise with the `Scribble` component: the `DefaultScribble` no longer
    uses our freehand tech and is a simple path instead. We pass down the
    tldraw-flavored scribble via `components`.
    
    The `ExternalContentManager` (`Editor.externalContentManager`) is
    removed and replaced with a mapping of types to handlers.
    
    - Register new content handlers with
    `Editor.registerExternalContentHandler`.
    - Register new asset creation handlers (for files and URLs) with
    `Editor.registerExternalAssetHandler`
    
    ### Change Type
    
    - [x] `major` — Breaking change
    
    ### Test Plan
    
    - [x] Unit Tests
    - [x] End to end tests
    
    ### Release Notes
    
    - [@tldraw/editor] lots, wip
    - [@tldraw/ui] gone, merged to tldraw/tldraw
    - [@tldraw/polyfills] gone, merged to tldraw/editor
    - [@tldraw/primitives] gone, merged to tldraw/editor / tldraw/tldraw
    - [@tldraw/indices] gone, merged to tldraw/editor
    - [@tldraw/file-format] gone, merged to tldraw/tldraw
    
    ---------
    
    Co-authored-by: alex <alex@dytry.ch>

diff --git a/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx b/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
new file mode 100644
index 000000000..f9ac852a5
--- /dev/null
+++ b/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
@@ -0,0 +1,276 @@
+import {
+	DefaultColorThemePalette,
+	DefaultFontFamilies,
+	DefaultFontStyle,
+	HASH_PATTERN_ZOOM_NAMES,
+	MAX_ZOOM,
+	SvgExportDef,
+	TLDefaultColorTheme,
+	TLDefaultFillStyle,
+	TLDefaultFontStyle,
+	TLShapeUtilCanvasSvgDef,
+	debugFlags,
+	useEditor,
+} from '@tldraw/editor'
+import { useEffect, useMemo, useRef, useState } from 'react'
+
+/** @public */
+export function getFontDefForExport(fontStyle: TLDefaultFontStyle): SvgExportDef {
+	return {
+		key: `${DefaultFontStyle.id}:${fontStyle}`,
+		getElement: async () => {
+			const font = findFont(fontStyle)
+			if (!font) return null
+
+			const url = (font as any).$$_url
+			const fontFaceRule = (font as any).$$_fontface
+			if (!url || !fontFaceRule) return null
+
+			const fontFile = await (await fetch(url)).blob()
+			const base64FontFile = await new Promise<string>((resolve, reject) => {
+				const reader = new FileReader()
+				reader.onload = () => resolve(reader.result as string)
+				reader.onerror = reject
+				reader.readAsDataURL(fontFile)
+			})
+
+			const newFontFaceRule = fontFaceRule.replace(url, base64FontFile)
+			const style = document.createElementNS('http://www.w3.org/2000/svg', 'style')
+			style.textContent = newFontFaceRule
+			return style
+		},
+	}
+}
+
+function findFont(name: TLDefaultFontStyle): FontFace | null {
+	const fontFamily = DefaultFontFamilies[name]
+	for (const font of document.fonts) {
+		if (fontFamily.includes(font.family)) {
+			return font
+		}
+	}
+	return null
+}
+
+/** @public */
+export function getFillDefForExport(
+	fill: TLDefaultFillStyle,
+	theme: TLDefaultColorTheme
+): SvgExportDef {
+	return {
+		key: `${DefaultFontStyle.id}:${fill}`,
+		getElement: async () => {
+			if (fill !== 'pattern') return null
+
+			const t = 8 / 12
+			const divEl = document.createElement('div')
+			divEl.innerHTML = `
+				<svg>
+					<defs>
+						<mask id="hash_pattern_mask">
+							<rect x="0" y="0" width="8" height="8" fill="white" />
+							<g
+								strokeLinecap="round"
+								stroke="black"
+							>
+								<line x1="${t * 1}" y1="${t * 3}" x2="${t * 3}" y2="${t * 1}" />
+								<line x1="${t * 5}" y1="${t * 7}" x2="${t * 7}" y2="${t * 5}" />
+								<line x1="${t * 9}" y1="${t * 11}" x2="${t * 11}" y2="${t * 9}" />
+							</g>
+						</mask>
+						<pattern
+							id="hash_pattern"
+							width="8"
+							height="8"
+							patternUnits="userSpaceOnUse"
+						>
+							<rect x="0" y="0" width="8" height="8" fill="${theme.solid}" mask="url(#hash_pattern_mask)" />
+						</pattern>
+					</defs>
+				</svg>
+			`
+			return Array.from(divEl.querySelectorAll('defs > *'))
+		},
+	}
+}
+
+export function getFillDefForCanvas(): TLShapeUtilCanvasSvgDef {
+	return {
+		key: `${DefaultFontStyle.id}:pattern`,
+		component: PatternFillDefForCanvas,
+	}
+}
+const TILE_PATTERN_SIZE = 8
+
+const generateImage = (dpr: number, currentZoom: number, darkMode: boolean) => {
+	return new Promise<Blob>((resolve, reject) => {
+		const size = TILE_PATTERN_SIZE * currentZoom * dpr
+
+		const canvasEl = document.createElement('canvas')
+		canvasEl.width = size
+		canvasEl.height = size
+
+		const ctx = canvasEl.getContext('2d')
+		if (!ctx) return
+
+		ctx.fillStyle = darkMode ? '#212529' : '#f8f9fa'
+		ctx.fillRect(0, 0, size, size)
+
+		// This essentially generates an inverse of the pattern we're drawing.
+		ctx.globalCompositeOperation = 'destination-out'
+
+		ctx.lineCap = 'round'
+		ctx.lineWidth = 1.25 * currentZoom * dpr
+
+		const t = 8 / 12
+		const s = (v: number) => v * currentZoom * dpr
+
+		ctx.beginPath()
+		ctx.moveTo(s(t * 1), s(t * 3))
+		ctx.lineTo(s(t * 3), s(t * 1))
+
+		ctx.moveTo(s(t * 5), s(t * 7))
+		ctx.lineTo(s(t * 7), s(t * 5))
+
+		ctx.moveTo(s(t * 9), s(t * 11))
+		ctx.lineTo(s(t * 11), s(t * 9))
+		ctx.stroke()
+
+		canvasEl.toBlob((blob) => {
+			if (!blob || debugFlags.throwToBlob.value) {
+				reject()
+			} else {
+				resolve(blob)
+			}
+		})
+	})
+}
+
+const canvasBlob = (size: [number, number], fn: (ctx: CanvasRenderingContext2D) => void) => {
+	const canvas = document.createElement('canvas')
+	canvas.width = size[0]
+	canvas.height = size[1]
+	const ctx = canvas.getContext('2d')
+	if (!ctx) return ''
+	fn(ctx)
+	return canvas.toDataURL()
+}
+type PatternDef = { zoom: number; url: string; darkMode: boolean }
+
+const getDefaultPatterns = () => {
+	const defaultPatterns: PatternDef[] = []
+	for (let i = 1; i <= Math.ceil(MAX_ZOOM); i++) {
+		const whitePixelBlob = canvasBlob([1, 1], (ctx) => {
+			ctx.fillStyle = DefaultColorThemePalette.lightMode.black.semi
+			ctx.fillRect(0, 0, 1, 1)
+		})
+		const blackPixelBlob = canvasBlob([1, 1], (ctx) => {
+			ctx.fillStyle = DefaultColorThemePalette.darkMode.black.semi
+			ctx.fillRect(0, 0, 1, 1)
+		})
+		defaultPatterns.push({
+			zoom: i,
+			url: whitePixelBlob,
+			darkMode: false,
+		})
+		defaultPatterns.push({
+			zoom: i,
+			url: blackPixelBlob,
+			darkMode: true,
+		})
+	}
+	return defaultPatterns
+}
+
+function usePattern() {
+	const editor = useEditor()
+	const dpr = editor.devicePixelRatio
+	const [isReady, setIsReady] = useState(false)
+	const defaultPatterns = useMemo(() => getDefaultPatterns(), [])
+	const [backgroundUrls, setBackgroundUrls] = useState<PatternDef[]>(defaultPatterns)
+
+	useEffect(() => {
+		const promises: Promise<{ zoom: number; url: string; darkMode: boolean }>[] = []
+
+		for (let i = 1; i <= Math.ceil(MAX_ZOOM); i++) {
+			promises.push(
+				generateImage(dpr, i, false).then((blob) => ({
+					zoom: i,
+					url: URL.createObjectURL(blob),
+					darkMode: false,
+				}))
+			)
+			promises.push(
+				generateImage(dpr, i, true).then((blob) => ({
+					zoom: i,
+					url: URL.createObjectURL(blob),
+					darkMode: true,
+				}))
+			)
+		}
+
+		let isCancelled = false
+		Promise.all(promises).then((urls) => {
+			if (isCancelled) return
+			setBackgroundUrls(urls)
+			setIsReady(true)
+		})
+
+		return () => {
+			isCancelled = true
+			setIsReady(false)
+		}
+	}, [dpr])
+
+	const defs = (
+		<>
+			{backgroundUrls.map((item) => {
+				const key = item.zoom + (item.darkMode ? '_dark' : '_light')
+				return (
+					<pattern
+						key={key}
+						id={HASH_PATTERN_ZOOM_NAMES[key]}
+						width={TILE_PATTERN_SIZE}
+						height={TILE_PATTERN_SIZE}
+						patternUnits="userSpaceOnUse"
+					>
+						<image href={item.url} width={TILE_PATTERN_SIZE} height={TILE_PATTERN_SIZE} />
+					</pattern>
+				)
+			})}
+		</>
+	)
+
+	return { defs, isReady }
+}
+
+function PatternFillDefForCanvas() {
+	const editor = useEditor()
+	const containerRef = useRef<SVGGElement>(null)
+	const { defs, isReady } = usePattern()
+
+	useEffect(() => {
+		if (isReady && editor.isSafari) {
+			const htmlLayer = findHtmlLayerParent(containerRef.current!)
+			if (htmlLayer) {
+				// Wait for `patternContext` to be picked up
+				requestAnimationFrame(() => {
+					htmlLayer.style.display = 'none'
+
+					// Wait for 'display = "none"' to take effect
+					requestAnimationFrame(() => {
+						htmlLayer.style.display = ''
+					})
+				})
+			}
+		}
+	}, [editor, isReady])
+
+	return <g ref={containerRef}>{defs}</g>
+}
+
+function findHtmlLayerParent(element: Element): HTMLElement | null {
+	if (element.classList.contains('tl-html-layer')) return element as HTMLElement
+	if (element.parentElement) return findHtmlLayerParent(element.parentElement)
+	return null
+}

commit 3e31ef2a7d01467ef92ca4f7aed13ee708db73ef
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Tue Jul 18 22:50:23 2023 +0100

    Remove helpers / extraneous API methods. (#1745)
    
    This PR removes several extraneous computed values from the editor. It
    adds some silly instance state onto the instance state record and
    unifies a few methods which were inconsistent. This is fit and finish
    work 🧽
    
    ## Computed Values
    
    In general, where once we had a getter and setter for `isBlahMode`,
    which really masked either an `_isBlahMode` atom on the editor or
    `instanceState.isBlahMode`, these are merged into `instanceState`; they
    can be accessed / updated via `editor.instanceState` /
    `editor.updateInstanceState`.
    
    ## tldraw select tool specific things
    
    This PR also removes some tldraw specific state checks and creates new
    component overrides to allow us to include them in tldraw/tldraw.
    
    ### Change Type
    
    - [x] `major` — Breaking change
    
    ### Test Plan
    
    - [x] Unit Tests
    - [x] End to end tests
    
    ### Release Notes
    
    - [tldraw] rename `useReadonly` to `useReadOnly`
    - [editor] remove `Editor.isDarkMode`
    - [editor] remove `Editor.isChangingStyle`
    - [editor] remove `Editor.isCoarsePointer`
    - [editor] remove `Editor.isDarkMode`
    - [editor] remove `Editor.isFocused`
    - [editor] remove `Editor.isGridMode`
    - [editor] remove `Editor.isPenMode`
    - [editor] remove `Editor.isReadOnly`
    - [editor] remove `Editor.isSnapMode`
    - [editor] remove `Editor.isToolLocked`
    - [editor] remove `Editor.locale`
    - [editor] rename `Editor.pageState` to `Editor.currentPageState`
    - [editor] add `Editor.pageStates`
    - [editor] add `Editor.setErasingIds`
    - [editor] add `Editor.setEditingId`
    - [editor] add several new component overrides

diff --git a/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx b/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
index f9ac852a5..a225eb8bb 100644
--- a/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
+++ b/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
@@ -184,7 +184,7 @@ const getDefaultPatterns = () => {
 
 function usePattern() {
 	const editor = useEditor()
-	const dpr = editor.devicePixelRatio
+	const dpr = editor.instanceState.devicePixelRatio
 	const [isReady, setIsReady] = useState(false)
 	const defaultPatterns = useMemo(() => getDefaultPatterns(), [])
 	const [backgroundUrls, setBackgroundUrls] = useState<PatternDef[]>(defaultPatterns)

commit e17074a8b3a60d26a2e54ca5b5d47622db7676be
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Tue Aug 1 14:21:14 2023 +0100

    Editor commands API / effects (#1778)
    
    This PR shrinks the commands API surface and adds a manager
    (`CleanupManager`) for side effects.
    
    ### Change Type
    
    - [x] `major` — Breaking change
    
    ### Test Plan
    
    Use the app! Especially undo and redo. Our tests are passing but I've
    found more cases where our coverage fails to catch issues.
    
    ### Release Notes
    
    - tbd

diff --git a/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx b/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
index a225eb8bb..d3419ce98 100644
--- a/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
+++ b/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
@@ -250,7 +250,7 @@ function PatternFillDefForCanvas() {
 	const { defs, isReady } = usePattern()
 
 	useEffect(() => {
-		if (isReady && editor.isSafari) {
+		if (isReady && editor.environment.isSafari) {
 			const htmlLayer = findHtmlLayerParent(containerRef.current!)
 			if (htmlLayer) {
 				// Wait for `patternContext` to be picked up

commit 79fae186e4816f4b60f336fa80c2d85ef1debc21
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Tue Aug 1 18:03:31 2023 +0100

    Revert "Editor commands API / effects" (#1783)
    
    Reverts tldraw/tldraw#1778.
    
    Fuzz testing picked up errors related to deleting pages and undo/redo
    which may doom this PR.
    
    ### Change Type
    
    - [x] `major` — Breaking change

diff --git a/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx b/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
index d3419ce98..a225eb8bb 100644
--- a/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
+++ b/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
@@ -250,7 +250,7 @@ function PatternFillDefForCanvas() {
 	const { defs, isReady } = usePattern()
 
 	useEffect(() => {
-		if (isReady && editor.environment.isSafari) {
+		if (isReady && editor.isSafari) {
 			const htmlLayer = findHtmlLayerParent(containerRef.current!)
 			if (htmlLayer) {
 				// Wait for `patternContext` to be picked up

commit c478d75117172a6b1aa7e615efa22ef54ce6e453
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Wed Aug 2 12:05:09 2023 +0100

    environment manager (#1784)
    
    This PR extracts the environment manager from #1778.
    
    ### Change Type
    
    - [x] `major` — Breaking change
    
    ### Release Notes
    
    - [editor] Move environment flags to environment manager

diff --git a/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx b/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
index a225eb8bb..d3419ce98 100644
--- a/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
+++ b/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
@@ -250,7 +250,7 @@ function PatternFillDefForCanvas() {
 	const { defs, isReady } = usePattern()
 
 	useEffect(() => {
-		if (isReady && editor.isSafari) {
+		if (isReady && editor.environment.isSafari) {
 			const htmlLayer = findHtmlLayerParent(containerRef.current!)
 			if (htmlLayer) {
 				// Wait for `patternContext` to be picked up

commit 5db3c1553e14edd14aa5f7c0fc85fc5efc352335
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Mon Nov 13 11:51:22 2023 +0000

    Replace Atom.value with Atom.get() (#2189)
    
    This PR replaces the `.value` getter for the atom with `.get()`
    
    ### Change Type
    
    - [x] `major` — Breaking change
    
    ---------
    
    Co-authored-by: David Sheldrick <d.j.sheldrick@gmail.com>

diff --git a/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx b/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
index d3419ce98..8a41d4730 100644
--- a/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
+++ b/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
@@ -137,7 +137,7 @@ const generateImage = (dpr: number, currentZoom: number, darkMode: boolean) => {
 		ctx.stroke()
 
 		canvasEl.toBlob((blob) => {
-			if (!blob || debugFlags.throwToBlob.value) {
+			if (!blob || debugFlags.throwToBlob.get()) {
 				reject()
 			} else {
 				resolve(blob)
@@ -184,7 +184,7 @@ const getDefaultPatterns = () => {
 
 function usePattern() {
 	const editor = useEditor()
-	const dpr = editor.instanceState.devicePixelRatio
+	const dpr = editor.getInstanceState().devicePixelRatio
 	const [isReady, setIsReady] = useState(false)
 	const defaultPatterns = useMemo(() => getDefaultPatterns(), [])
 	const [backgroundUrls, setBackgroundUrls] = useState<PatternDef[]>(defaultPatterns)

commit 45c8777ea0bc4db5ca3ed5fcbcdae405e38b9327
Author: alex <alex@dytry.ch>
Date:   Wed Jan 31 16:35:49 2024 +0000

    reactive context menu overrides (#2697)
    
    Previously, we were calling context menu `overrides` in a `useMemo`, so
    they weren't updating reactively in the way that most of our other
    schema overrides do. This diff calls `override` in a `useValue` instead
    so it updates reactively.
    
    It also fixes some issues with testing the `<Tldraw />` component:
    currently we get a lot of errors in the console about updates not being
    wrapped in `act`. These are caused by the fill patterns at different
    zoom levels popping in without us waiting for them. Now, we have a
    helper for rendering the tldraw component that waits for this correctly
    and stops the error.
    
    ### Change Type
    
    - [x] `patch` — Bug fix
    
    ### Test Plan
    
    
    - [x] Unit Tests
    
    
    ### Release Notes
    
    - Context Menu overrides will now update reactively

diff --git a/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx b/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
index 8a41d4730..4848dc0fc 100644
--- a/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
+++ b/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
@@ -266,7 +266,11 @@ function PatternFillDefForCanvas() {
 		}
 	}, [editor, isReady])
 
-	return <g ref={containerRef}>{defs}</g>
+	return (
+		<g ref={containerRef} data-testid={isReady ? 'ready-pattern-fill-defs' : undefined}>
+			{defs}
+		</g>
+	)
 }
 
 function findHtmlLayerParent(element: Element): HTMLElement | null {

commit dba6d4c414fa571519e252d581e3489101280acc
Author: Mime Čuvalo <mimecuvalo@gmail.com>
Date:   Tue Mar 12 09:10:18 2024 +0000

    chore: cleanup multiple uses of FileReader (#3110)
    
    from
    https://discord.com/channels/859816885297741824/1006133967642177556/1213038401465618433
    
    ### Change Type
    
    - [x] `patch` — Bug fix

diff --git a/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx b/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
index 4848dc0fc..8f114af66 100644
--- a/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
+++ b/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
@@ -2,6 +2,7 @@ import {
 	DefaultColorThemePalette,
 	DefaultFontFamilies,
 	DefaultFontStyle,
+	FileHelpers,
 	HASH_PATTERN_ZOOM_NAMES,
 	MAX_ZOOM,
 	SvgExportDef,
@@ -27,12 +28,7 @@ export function getFontDefForExport(fontStyle: TLDefaultFontStyle): SvgExportDef
 			if (!url || !fontFaceRule) return null
 
 			const fontFile = await (await fetch(url)).blob()
-			const base64FontFile = await new Promise<string>((resolve, reject) => {
-				const reader = new FileReader()
-				reader.onload = () => resolve(reader.result as string)
-				reader.onerror = reject
-				reader.readAsDataURL(fontFile)
-			})
+			const base64FontFile = FileHelpers.fileToBase64(fontFile)
 
 			const newFontFaceRule = fontFaceRule.replace(url, base64FontFile)
 			const style = document.createElementNS('http://www.w3.org/2000/svg', 'style')

commit 0a48aea7bb042ceaebf692e04cbdd0c97074d709
Author: alex <alex@dytry.ch>
Date:   Tue Mar 12 16:51:29 2024 +0000

    fixup file helpers (#3130)
    
    We had a couple regressions in #3110: first a missing `await` was
    causing fonts not to get properly embedded in exports. second, some
    `readAsText` calls were replaced with `readAsDataURL` calls.
    
    ### Change Type
    
    <!-- ❗ Please select a 'Scope' label ❗️ -->
    
    - [x] `sdk` — Changes the tldraw SDK
    - [ ] `dotcom` — Changes the tldraw.com web app
    - [ ] `docs` — Changes to the documentation, examples, or templates.
    - [ ] `vs code` — Changes to the vscode plugin
    - [ ] `internal` — Does not affect user-facing stuff
    
    <!-- ❗ Please select a 'Type' label ❗️ -->
    
    - [x] `bugfix` — Bug fix
    - [ ] `feature` — New feature
    - [ ] `improvement` — Improving existing features
    - [ ] `chore` — Updating dependencies, other boring stuff
    - [ ] `galaxy brain` — Architectural changes
    - [ ] `tests` — Changes to any test code
    - [ ] `tools` — Changes to infrastructure, CI, internal scripts,
    debugging tools, etc.
    - [ ] `dunno` — I don't know

diff --git a/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx b/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
index 8f114af66..3f8e2f831 100644
--- a/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
+++ b/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
@@ -23,12 +23,12 @@ export function getFontDefForExport(fontStyle: TLDefaultFontStyle): SvgExportDef
 			const font = findFont(fontStyle)
 			if (!font) return null
 
-			const url = (font as any).$$_url
-			const fontFaceRule = (font as any).$$_fontface
+			const url: string = (font as any).$$_url
+			const fontFaceRule: string = (font as any).$$_fontface
 			if (!url || !fontFaceRule) return null
 
 			const fontFile = await (await fetch(url)).blob()
-			const base64FontFile = FileHelpers.fileToBase64(fontFile)
+			const base64FontFile = await FileHelpers.blobToDataUrl(fontFile)
 
 			const newFontFaceRule = fontFaceRule.replace(url, base64FontFile)
 			const style = document.createElementNS('http://www.w3.org/2000/svg', 'style')

commit 05f58f7c2a16ba3860471f8188beba930567c818
Author: alex <alex@dytry.ch>
Date:   Mon Mar 25 14:16:55 2024 +0000

    React-powered SVG exports (#3117)
    
    ## Migration path
    1. If any of your shapes implement `toSvg` for exports, you'll need to
    replace your implementation with a new version that returns JSX (it's a
    react component) instead of manually constructing SVG DOM nodes
    2. `editor.getSvg` is deprecated. It still works, but will be going away
    in a future release. If you still need SVGs as DOM elements rather than
    strings, use `new DOMParser().parseFromString(svgString,
    'image/svg+xml').firstElementChild`
    
    ## The change in detail
    At the moment, our SVG exports very carefully try to recreate the
    visuals of our shapes by manually constructing SVG DOM nodes. On its own
    this is really painful, but it also results in a lot of duplicated logic
    between the `component` and `getSvg` methods of shape utils.
    
    In #3020, we looked at using string concatenation & DOMParser to make
    this a bit less painful. This works, but requires specifying namespaces
    everywhere, is still pretty painful (no syntax highlighting or
    formatting), and still results in all that duplicated logic.
    
    I briefly experimented with creating my own version of the javascript
    language that let you embed XML like syntax directly. I was going to
    call it EXTREME JAVASCRIPT or XJS for short, but then I noticed that we
    already wrote the whole of tldraw in this thing called react and a (imo
    much worse named) version of the javascript xml thing already existed.
    
    Given the entire library already depends on react, what would it look
    like if we just used react directly for these exports? Turns out things
    get a lot simpler! Take a look at lmk what you think
    
    This diff was intended as a proof of concept, but is actually pretty
    close to being landable. The main thing is that here, I've deliberately
    leant into this being a big breaking change to see just how much code we
    could delete (turns out: lots). We could if we wanted to make this
    without making it a breaking change at all, but it would add back a lot
    of complexity on our side and run a fair bit slower
    
    ---------
    
    Co-authored-by: huppy-bot[bot] <128400622+huppy-bot[bot]@users.noreply.github.com>

diff --git a/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx b/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
index 3f8e2f831..8a6ec0787 100644
--- a/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
+++ b/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
@@ -6,7 +6,6 @@ import {
 	HASH_PATTERN_ZOOM_NAMES,
 	MAX_ZOOM,
 	SvgExportDef,
-	TLDefaultColorTheme,
 	TLDefaultFillStyle,
 	TLDefaultFontStyle,
 	TLShapeUtilCanvasSvgDef,
@@ -14,6 +13,7 @@ import {
 	useEditor,
 } from '@tldraw/editor'
 import { useEffect, useMemo, useRef, useState } from 'react'
+import { useDefaultColorTheme } from './ShapeFill'
 
 /** @public */
 export function getFontDefForExport(fontStyle: TLDefaultFontStyle): SvgExportDef {
@@ -31,9 +31,7 @@ export function getFontDefForExport(fontStyle: TLDefaultFontStyle): SvgExportDef
 			const base64FontFile = await FileHelpers.blobToDataUrl(fontFile)
 
 			const newFontFaceRule = fontFaceRule.replace(url, base64FontFile)
-			const style = document.createElementNS('http://www.w3.org/2000/svg', 'style')
-			style.textContent = newFontFaceRule
-			return style
+			return <style>{newFontFaceRule}</style>
 		},
 	}
 }
@@ -49,47 +47,42 @@ function findFont(name: TLDefaultFontStyle): FontFace | null {
 }
 
 /** @public */
-export function getFillDefForExport(
-	fill: TLDefaultFillStyle,
-	theme: TLDefaultColorTheme
-): SvgExportDef {
+export function getFillDefForExport(fill: TLDefaultFillStyle): SvgExportDef {
 	return {
 		key: `${DefaultFontStyle.id}:${fill}`,
 		getElement: async () => {
 			if (fill !== 'pattern') return null
 
-			const t = 8 / 12
-			const divEl = document.createElement('div')
-			divEl.innerHTML = `
-				<svg>
-					<defs>
-						<mask id="hash_pattern_mask">
-							<rect x="0" y="0" width="8" height="8" fill="white" />
-							<g
-								strokeLinecap="round"
-								stroke="black"
-							>
-								<line x1="${t * 1}" y1="${t * 3}" x2="${t * 3}" y2="${t * 1}" />
-								<line x1="${t * 5}" y1="${t * 7}" x2="${t * 7}" y2="${t * 5}" />
-								<line x1="${t * 9}" y1="${t * 11}" x2="${t * 11}" y2="${t * 9}" />
-							</g>
-						</mask>
-						<pattern
-							id="hash_pattern"
-							width="8"
-							height="8"
-							patternUnits="userSpaceOnUse"
-						>
-							<rect x="0" y="0" width="8" height="8" fill="${theme.solid}" mask="url(#hash_pattern_mask)" />
-						</pattern>
-					</defs>
-				</svg>
-			`
-			return Array.from(divEl.querySelectorAll('defs > *'))
+			return <HashPatternForExport />
 		},
 	}
 }
 
+function HashPatternForExport() {
+	const theme = useDefaultColorTheme()
+	const t = 8 / 12
+	return (
+		<>
+			<mask id="hash_pattern_mask">
+				<rect x="0" y="0" width="8" height="8" fill="white" />
+				<g strokeLinecap="round" stroke="black">
+					<line x1={t * 1} y1={t * 3} x2={t * 3} y2={t * 1} />
+					<line x1={t * 5} y1={t * 7} x2={t * 7} y2={t * 5} />
+					<line x1={t * 9} y1={t * 11} x2={t * 11} y2={t * 9} />
+				</g>
+			</mask>
+			<pattern
+				id={HASH_PATTERN_ZOOM_NAMES[`1_${theme.id}`]}
+				width="8"
+				height="8"
+				patternUnits="userSpaceOnUse"
+			>
+				<rect x="0" y="0" width="8" height="8" fill={theme.solid} mask="url(#hash_pattern_mask)" />
+			</pattern>
+		</>
+	)
+}
+
 export function getFillDefForCanvas(): TLShapeUtilCanvasSvgDef {
 	return {
 		key: `${DefaultFontStyle.id}:pattern`,

commit 6305e838306782c4092121a2a17299ecd04838eb
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Tue Apr 9 16:42:54 2024 +0100

    Fix some tests (#3403)
    
    This PR fixes some jest test.
    
    - We skip the culling shapes in test environments.
    - We skip rendering patterns in test environments.
    
    ### Change Type
    
    - [x] `sdk` — Changes the tldraw SDK
    - [x] `tests` — Changes to any test code

diff --git a/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx b/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
index 8a6ec0787..16e4495be 100644
--- a/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
+++ b/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
@@ -179,6 +179,11 @@ function usePattern() {
 	const [backgroundUrls, setBackgroundUrls] = useState<PatternDef[]>(defaultPatterns)
 
 	useEffect(() => {
+		if (process.env.NODE_ENV === 'test') {
+			setIsReady(true)
+			return
+		}
+
 		const promises: Promise<{ zoom: number; url: string; darkMode: boolean }>[] = []
 
 		for (let i = 1; i <= Math.ceil(MAX_ZOOM); i++) {

commit fabba66c0f4b6c42ece30f409e70eb01e588f8e1
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Sat May 4 18:39:04 2024 +0100

    Camera options (#3282)
    
    This PR implements a camera options API.
    
    - [x] Initial PR
    - [x] Updated unit tests
    - [x] Feedback / review
    - [x] New unit tests
    - [x] Update use-case examples
    - [x] Ship?
    
    ## Public API
    
    A user can provide camera options to the `Tldraw` component via the
    `cameraOptions` prop. The prop is also available on the `TldrawEditor`
    component and the constructor parameters of the `Editor` class.
    
    ```tsx
    export default function CameraOptionsExample() {
            return (
                    <div className="tldraw__editor">
                            <Tldraw cameraOptions={CAMERA_OPTIONS} />
                    </div>
            )
    }
    ```
    
    At runtime, a user can:
    -  get the current camera options with `Editor.getCameraOptions`
    -  update the camera options with `Editor.setCameraOptions`
    
    Setting the camera options automatically applies them to the current
    camera.
    
    ```ts
    editor.setCameraOptions({...editor.getCameraOptions(), isLocked: true })
    ```
    
    A user can get the "camera fit zoom" via `editor.getCameraFitZoom()`.
    
    # Interface
    
    The camera options themselves can look a few different ways depending on
    the `type` provided.
    
    
    ```tsx
    export type TLCameraOptions = {
            /** Whether the camera is locked. */
            isLocked: boolean
            /** The speed of a scroll wheel / trackpad pan. Default is 1. */
            panSpeed: number
            /** The speed of a scroll wheel / trackpad zoom. Default is 1. */
            zoomSpeed: number
            /** The steps that a user can zoom between with zoom in / zoom out. The first and last value will determine the min and max zoom. */
            zoomSteps: number[]
            /** Controls whether the wheel pans or zooms.
             *
             * - `zoom`: The wheel will zoom in and out.
             * - `pan`: The wheel will pan the camera.
             * - `none`: The wheel will do nothing.
             */
            wheelBehavior: 'zoom' | 'pan' | 'none'
            /** The camera constraints. */
            constraints?: {
                    /** The bounds (in page space) of the constrained space */
                    bounds: BoxModel
                    /** The padding inside of the viewport (in screen space) */
                    padding: VecLike
                    /** The origin for placement. Used to position the bounds within the viewport when an axis is fixed or contained and zoom is below the axis fit. */
                    origin: VecLike
                    /** The camera's initial zoom, used also when the camera is reset.
                     *
                     * - `default`: Sets the initial zoom to 100%.
                     * - `fit-x`: The x axis will completely fill the viewport bounds.
                     * - `fit-y`: The y axis will completely fill the viewport bounds.
                     * - `fit-min`: The smaller axis will completely fill the viewport bounds.
                     * - `fit-max`: The larger axis will completely fill the viewport bounds.
                     * - `fit-x-100`: The x axis will completely fill the viewport bounds, or 100% zoom, whichever is smaller.
                     * - `fit-y-100`: The y axis will completely fill the viewport bounds, or 100% zoom, whichever is smaller.
                     * - `fit-min-100`: The smaller axis will completely fill the viewport bounds, or 100% zoom, whichever is smaller.
                     * - `fit-max-100`: The larger axis will completely fill the viewport bounds, or 100% zoom, whichever is smaller.
                     */
                    initialZoom:
                            | 'fit-min'
                            | 'fit-max'
                            | 'fit-x'
                            | 'fit-y'
                            | 'fit-min-100'
                            | 'fit-max-100'
                            | 'fit-x-100'
                            | 'fit-y-100'
                            | 'default'
                    /** The camera's base for its zoom steps.
                     *
                     * - `default`: Sets the initial zoom to 100%.
                     * - `fit-x`: The x axis will completely fill the viewport bounds.
                     * - `fit-y`: The y axis will completely fill the viewport bounds.
                     * - `fit-min`: The smaller axis will completely fill the viewport bounds.
                     * - `fit-max`: The larger axis will completely fill the viewport bounds.
                     * - `fit-x-100`: The x axis will completely fill the viewport bounds, or 100% zoom, whichever is smaller.
                     * - `fit-y-100`: The y axis will completely fill the viewport bounds, or 100% zoom, whichever is smaller.
                     * - `fit-min-100`: The smaller axis will completely fill the viewport bounds, or 100% zoom, whichever is smaller.
                     * - `fit-max-100`: The larger axis will completely fill the viewport bounds, or 100% zoom, whichever is smaller.
                     */
                    baseZoom:
                            | 'fit-min'
                            | 'fit-max'
                            | 'fit-x'
                            | 'fit-y'
                            | 'fit-min-100'
                            | 'fit-max-100'
                            | 'fit-x-100'
                            | 'fit-y-100'
                            | 'default'
                    /** The behavior for the constraints for both axes or each axis individually.
                     *
                     * - `free`: The bounds are ignored when moving the camera.
                     * - 'fixed': The bounds will be positioned within the viewport based on the origin
                     * - `contain`: The 'fixed' behavior will be used when the zoom is below the zoom level at which the bounds would fill the viewport; and when above this zoom, the bounds will use the 'inside' behavior.
                     * - `inside`: The bounds will stay completely within the viewport.
                     * - `outside`: The bounds will stay touching the viewport.
                     */
                    behavior:
                            | 'free'
                            | 'fixed'
                            | 'inside'
                            | 'outside'
                            | 'contain'
                            | {
                                            x: 'free' | 'fixed' | 'inside' | 'outside' | 'contain'
                                            y: 'free' | 'fixed' | 'inside' | 'outside' | 'contain'
                              }
            }
    }
    ```
    
    ### Change Type
    
    - [x] `sdk` — Changes the tldraw SDK
    - [x] `feature` — New feature
    
    ### Test Plan
    
    These features combine in different ways, so we'll want to write some
    more tests to find surprises.
    
    1. Add a step-by-step description of how to test your PR here.
    2.
    
    - [ ] Unit Tests
    
    ### Release Notes
    
    - SDK: Adds camera options.
    
    ---------
    
    Co-authored-by: Mitja Bezenšek <mitja.bezensek@gmail.com>

diff --git a/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx b/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
index 16e4495be..d2407bb32 100644
--- a/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
+++ b/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
@@ -3,8 +3,6 @@ import {
 	DefaultFontFamilies,
 	DefaultFontStyle,
 	FileHelpers,
-	HASH_PATTERN_ZOOM_NAMES,
-	MAX_ZOOM,
 	SvgExportDef,
 	TLDefaultFillStyle,
 	TLDefaultFontStyle,
@@ -15,6 +13,16 @@ import {
 import { useEffect, useMemo, useRef, useState } from 'react'
 import { useDefaultColorTheme } from './ShapeFill'
 
+/** @internal */
+export const HASH_PATTERN_ZOOM_NAMES: Record<string, string> = {}
+
+const HASH_PATTERN_COUNT = 6
+
+for (let zoom = 1; zoom <= HASH_PATTERN_COUNT; zoom++) {
+	HASH_PATTERN_ZOOM_NAMES[zoom + '_dark'] = `hash_pattern_zoom_${zoom}_dark`
+	HASH_PATTERN_ZOOM_NAMES[zoom + '_light'] = `hash_pattern_zoom_${zoom}_light`
+}
+
 /** @public */
 export function getFontDefForExport(fontStyle: TLDefaultFontStyle): SvgExportDef {
 	return {
@@ -148,7 +156,7 @@ type PatternDef = { zoom: number; url: string; darkMode: boolean }
 
 const getDefaultPatterns = () => {
 	const defaultPatterns: PatternDef[] = []
-	for (let i = 1; i <= Math.ceil(MAX_ZOOM); i++) {
+	for (let i = 1; i <= HASH_PATTERN_COUNT; i++) {
 		const whitePixelBlob = canvasBlob([1, 1], (ctx) => {
 			ctx.fillStyle = DefaultColorThemePalette.lightMode.black.semi
 			ctx.fillRect(0, 0, 1, 1)
@@ -186,7 +194,7 @@ function usePattern() {
 
 		const promises: Promise<{ zoom: number; url: string; darkMode: boolean }>[] = []
 
-		for (let i = 1; i <= Math.ceil(MAX_ZOOM); i++) {
+		for (let i = 1; i <= HASH_PATTERN_COUNT; i++) {
 			promises.push(
 				generateImage(dpr, i, false).then((blob) => ({
 					zoom: i,

commit b5caa53cee16a2ddf0186ec6f32c3e47a690ab0d
Author: Mitja Bezenšek <mitja.bezensek@gmail.com>
Date:   Tue May 7 15:55:44 2024 +0200

    Fix background color for patterned shapes. (#3708)
    
    Background on exported patterned shapes was not the same as on the
    shapes themselves. This was especially noticeable in dark mode.
    
    I'm not sure if this is the colour we want to use as this changes the
    existing shape colour. But it is in line to what we had a while back. In
    any case
    [generateImage](https://github.com/tldraw/tldraw/blob/main/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx#L113)
    should be using the same colour as
    [HashPatternForExport](https://github.com/tldraw/tldraw/blob/main/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx#L88).
    
    ### Before
    
    ![image](https://github.com/tldraw/tldraw/assets/2523721/2772818e-7461-4cea-a36b-c16c8206b9d5)
    
    
    ### After
    
    ![image](https://github.com/tldraw/tldraw/assets/2523721/2bbe189c-fa18-4198-b9b3-1851c2336cf1)
    
    
    ### Change Type
    
    <!-- ❗ Please select a 'Scope' label ❗️ -->
    
    - [x] `sdk` — Changes the tldraw SDK
    - [ ] `dotcom` — Changes the tldraw.com web app
    - [ ] `docs` — Changes to the documentation, examples, or templates.
    - [ ] `vs code` — Changes to the vscode plugin
    - [ ] `internal` — Does not affect user-facing stuff
    
    <!-- ❗ Please select a 'Type' label ❗️ -->
    
    - [x] `bugfix` — Bug fix
    - [ ] `feature` — New feature
    - [ ] `improvement` — Improving existing features
    - [ ] `chore` — Updating dependencies, other boring stuff
    - [ ] `galaxy brain` — Architectural changes
    - [ ] `tests` — Changes to any test code
    - [ ] `tools` — Changes to infrastructure, CI, internal scripts,
    debugging tools, etc.
    - [ ] `dunno` — I don't know
    
    
    ### Test Plan
    
    1. Add patterned shapes.
    2. Copy them as SVG.
    3. Paste them. They should look the same.
    
    - [ ] Unit Tests
    - [ ] End to end tests
    
    ### Release Notes
    
    - Fixes an issue with copy pasting shapes as svg and png not correctly
    working for patterned shapes.

diff --git a/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx b/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
index d2407bb32..69fb90b37 100644
--- a/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
+++ b/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
@@ -110,7 +110,9 @@ const generateImage = (dpr: number, currentZoom: number, darkMode: boolean) => {
 		const ctx = canvasEl.getContext('2d')
 		if (!ctx) return
 
-		ctx.fillStyle = darkMode ? '#212529' : '#f8f9fa'
+		ctx.fillStyle = darkMode
+			? DefaultColorThemePalette.darkMode.solid
+			: DefaultColorThemePalette.lightMode.solid
 		ctx.fillRect(0, 0, size, size)
 
 		// This essentially generates an inverse of the pattern we're drawing.

commit abc8521a7129e8c5b435d13368c035fe2525640f
Author: alex <alex@dytry.ch>
Date:   Wed May 22 14:24:14 2024 +0100

    fix pattern fill lods (#3801)
    
    Camera options broke pattern lods. This PR adapts the more flexible take
    of pattern LODs i did for my version of camera controls to the new
    version.
    
    ### Change Type
    
    - [x] `sdk` — Changes the tldraw SDK
    - [x] `bugfix` — Bug fix

diff --git a/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx b/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
index 69fb90b37..601583470 100644
--- a/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
+++ b/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
@@ -4,25 +4,18 @@ import {
 	DefaultFontStyle,
 	FileHelpers,
 	SvgExportDef,
+	TLDefaultColorTheme,
 	TLDefaultFillStyle,
 	TLDefaultFontStyle,
 	TLShapeUtilCanvasSvgDef,
 	debugFlags,
+	last,
 	useEditor,
+	useValue,
 } from '@tldraw/editor'
-import { useEffect, useMemo, useRef, useState } from 'react'
+import { useEffect, useRef, useState } from 'react'
 import { useDefaultColorTheme } from './ShapeFill'
 
-/** @internal */
-export const HASH_PATTERN_ZOOM_NAMES: Record<string, string> = {}
-
-const HASH_PATTERN_COUNT = 6
-
-for (let zoom = 1; zoom <= HASH_PATTERN_COUNT; zoom++) {
-	HASH_PATTERN_ZOOM_NAMES[zoom + '_dark'] = `hash_pattern_zoom_${zoom}_dark`
-	HASH_PATTERN_ZOOM_NAMES[zoom + '_light'] = `hash_pattern_zoom_${zoom}_light`
-}
-
 /** @public */
 export function getFontDefForExport(fontStyle: TLDefaultFontStyle): SvgExportDef {
 	return {
@@ -80,7 +73,7 @@ function HashPatternForExport() {
 				</g>
 			</mask>
 			<pattern
-				id={HASH_PATTERN_ZOOM_NAMES[`1_${theme.id}`]}
+				id={getHashPatternZoomName(1, theme.id)}
 				width="8"
 				height="8"
 				patternUnits="userSpaceOnUse"
@@ -154,39 +147,64 @@ const canvasBlob = (size: [number, number], fn: (ctx: CanvasRenderingContext2D)
 	fn(ctx)
 	return canvas.toDataURL()
 }
-type PatternDef = { zoom: number; url: string; darkMode: boolean }
-
-const getDefaultPatterns = () => {
-	const defaultPatterns: PatternDef[] = []
-	for (let i = 1; i <= HASH_PATTERN_COUNT; i++) {
-		const whitePixelBlob = canvasBlob([1, 1], (ctx) => {
-			ctx.fillStyle = DefaultColorThemePalette.lightMode.black.semi
-			ctx.fillRect(0, 0, 1, 1)
-		})
-		const blackPixelBlob = canvasBlob([1, 1], (ctx) => {
-			ctx.fillStyle = DefaultColorThemePalette.darkMode.black.semi
-			ctx.fillRect(0, 0, 1, 1)
-		})
-		defaultPatterns.push({
-			zoom: i,
-			url: whitePixelBlob,
-			darkMode: false,
-		})
-		defaultPatterns.push({
-			zoom: i,
-			url: blackPixelBlob,
-			darkMode: true,
-		})
+type PatternDef = { zoom: number; url: string; theme: 'light' | 'dark' }
+
+let defaultPixels: { white: string; black: string } | null = null
+function getDefaultPixels() {
+	if (!defaultPixels) {
+		defaultPixels = {
+			white: canvasBlob([1, 1], (ctx) => {
+				ctx.fillStyle = '#f8f9fa'
+				ctx.fillRect(0, 0, 1, 1)
+			}),
+			black: canvasBlob([1, 1], (ctx) => {
+				ctx.fillStyle = '#212529'
+				ctx.fillRect(0, 0, 1, 1)
+			}),
+		}
+	}
+	return defaultPixels
+}
+
+function getPatternLodForZoomLevel(zoom: number) {
+	return Math.ceil(Math.log2(Math.max(1, zoom)))
+}
+
+export function getHashPatternZoomName(zoom: number, theme: TLDefaultColorTheme['id']) {
+	const lod = getPatternLodForZoomLevel(zoom)
+	return `tldraw_hash_pattern_${theme}_${lod}`
+}
+
+function getPatternLodsToGenerate(maxZoom: number) {
+	const levels = []
+	const minLod = 0
+	const maxLod = getPatternLodForZoomLevel(maxZoom)
+	for (let i = minLod; i <= maxLod; i++) {
+		levels.push(Math.pow(2, i))
 	}
-	return defaultPatterns
+	return levels
+}
+
+function getDefaultPatterns(maxZoom: number): PatternDef[] {
+	const defaultPixels = getDefaultPixels()
+	return getPatternLodsToGenerate(maxZoom).flatMap((zoom) => [
+		{ zoom, url: defaultPixels.white, theme: 'light' },
+		{ zoom, url: defaultPixels.black, theme: 'dark' },
+	])
 }
 
 function usePattern() {
 	const editor = useEditor()
-	const dpr = editor.getInstanceState().devicePixelRatio
+	const dpr = useValue('devicePixelRatio', () => editor.getInstanceState().devicePixelRatio, [
+		editor,
+	])
+	const maxZoom = useValue('maxZoom', () => Math.ceil(last(editor.getCameraOptions().zoomSteps)!), [
+		editor,
+	])
 	const [isReady, setIsReady] = useState(false)
-	const defaultPatterns = useMemo(() => getDefaultPatterns(), [])
-	const [backgroundUrls, setBackgroundUrls] = useState<PatternDef[]>(defaultPatterns)
+	const [backgroundUrls, setBackgroundUrls] = useState<PatternDef[]>(() =>
+		getDefaultPatterns(maxZoom)
+	)
 
 	useEffect(() => {
 		if (process.env.NODE_ENV === 'test') {
@@ -194,46 +212,46 @@ function usePattern() {
 			return
 		}
 
-		const promises: Promise<{ zoom: number; url: string; darkMode: boolean }>[] = []
-
-		for (let i = 1; i <= HASH_PATTERN_COUNT; i++) {
-			promises.push(
-				generateImage(dpr, i, false).then((blob) => ({
-					zoom: i,
+		const promise = Promise.all(
+			getPatternLodsToGenerate(maxZoom).flatMap<Promise<PatternDef>>((zoom) => [
+				generateImage(dpr, zoom, false).then((blob) => ({
+					zoom,
+					theme: 'light',
 					url: URL.createObjectURL(blob),
-					darkMode: false,
-				}))
-			)
-			promises.push(
-				generateImage(dpr, i, true).then((blob) => ({
-					zoom: i,
+				})),
+				generateImage(dpr, zoom, true).then((blob) => ({
+					zoom,
+					theme: 'dark',
 					url: URL.createObjectURL(blob),
-					darkMode: true,
-				}))
-			)
-		}
+				})),
+			])
+		)
 
 		let isCancelled = false
-		Promise.all(promises).then((urls) => {
+		promise.then((urls) => {
 			if (isCancelled) return
 			setBackgroundUrls(urls)
 			setIsReady(true)
 		})
-
 		return () => {
 			isCancelled = true
 			setIsReady(false)
+			promise.then((patterns) => {
+				for (const { url } of patterns) {
+					URL.revokeObjectURL(url)
+				}
+			})
 		}
-	}, [dpr])
+	}, [dpr, maxZoom])
 
 	const defs = (
 		<>
 			{backgroundUrls.map((item) => {
-				const key = item.zoom + (item.darkMode ? '_dark' : '_light')
+				const id = getHashPatternZoomName(item.zoom, item.theme)
 				return (
 					<pattern
-						key={key}
-						id={HASH_PATTERN_ZOOM_NAMES[key]}
+						key={id}
+						id={id}
 						width={TILE_PATTERN_SIZE}
 						height={TILE_PATTERN_SIZE}
 						patternUnits="userSpaceOnUse"

commit f9ed1bf2c9480b1c49f591a8609adfb4fcf91eae
Author: alex <alex@dytry.ch>
Date:   Wed May 22 16:55:49 2024 +0100

    Force `interface` instead of `type` for better docs (#3815)
    
    Typescript's type aliases (`type X = thing`) can refer to basically
    anything, which makes it hard to write an automatic document formatter
    for them. Interfaces on the other hand are only object, so they play
    much nicer with docs. Currently, object-flavoured type aliases don't
    really get expanded at all on our docs site, which means we have a bunch
    of docs content that's not shown on the site.
    
    This diff introduces a lint rule that forces `interface X {foo: bar}`s
    instead of `type X = {foo: bar}` where possible, as it results in a much
    better documentation experience:
    
    Before:
    <img width="437" alt="Screenshot 2024-05-22 at 15 24 13"
    src="https://github.com/tldraw/tldraw/assets/1489520/32606fd1-6832-4a1e-aa5f-f0534d160c92">
    
    After:
    <img width="431" alt="Screenshot 2024-05-22 at 15 33 01"
    src="https://github.com/tldraw/tldraw/assets/1489520/4e0d59ee-c38e-4056-b9fd-6a7f15d28f0f">
    
    
    ### Change Type
    
    - [x] `sdk` — Changes the tldraw SDK
    - [x] `docs` — Changes to the documentation, examples, or templates.
    - [x] `improvement` — Improving existing features

diff --git a/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx b/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
index 601583470..fe0ba1f6b 100644
--- a/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
+++ b/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
@@ -147,7 +147,11 @@ const canvasBlob = (size: [number, number], fn: (ctx: CanvasRenderingContext2D)
 	fn(ctx)
 	return canvas.toDataURL()
 }
-type PatternDef = { zoom: number; url: string; theme: 'light' | 'dark' }
+interface PatternDef {
+	zoom: number
+	url: string
+	theme: 'light' | 'dark'
+}
 
 let defaultPixels: { white: string; black: string } | null = null
 function getDefaultPixels() {

commit aadc0aab4dba09fde89f66a32f6b67d6494a16a3
Author: Mime Čuvalo <mimecuvalo@gmail.com>
Date:   Tue Jun 4 09:50:40 2024 +0100

    editor: register timeouts/intervals/rafs for disposal (#3852)
    
    We have a lot of events that fire in the editor and, technically, they
    can fire after the Editor is long gone.
    This adds a registry/manager to track those timeout/interval/raf IDs
    (and some eslint rules to enforce it).
    
    Some other cleanups:
    - `requestAnimationFrame.polyfill.ts` looks like it's unused now (it
    used to be used in a prev. revision)
    - @ds300 I could use your feedback on the `EffectScheduler` tweak. in
    `useReactor` we do: `() => new EffectScheduler(name, reactFn, {
    scheduleEffect: (cb) => requestAnimationFrame(cb) }),`
    and that looks like it doesn't currently get disposed of properly.
    thoughts? happy to do that separately from this PR if you think that's a
    trickier thing.
    
    ### Change Type
    
    <!-- ❗ Please select a 'Scope' label ❗️ -->
    
    - [x] `sdk` — Changes the tldraw SDK
    - [ ] `dotcom` — Changes the tldraw.com web app
    - [ ] `docs` — Changes to the documentation, examples, or templates.
    - [ ] `vs code` — Changes to the vscode plugin
    - [ ] `internal` — Does not affect user-facing stuff
    
    <!-- ❗ Please select a 'Type' label ❗️ -->
    
    - [ ] `bugfix` — Bug fix
    - [ ] `feature` — New feature
    - [x] `improvement` — Improving existing features
    - [ ] `chore` — Updating dependencies, other boring stuff
    - [ ] `galaxy brain` — Architectural changes
    - [ ] `tests` — Changes to any test code
    - [ ] `tools` — Changes to infrastructure, CI, internal scripts,
    debugging tools, etc.
    - [ ] `dunno` — I don't know
    
    
    ### Test Plan
    
    1. Test async operations and make sure they don't fire after disposal.
    
    ### Release Notes
    
    - Editor: add registry of timeouts/intervals/rafs
    
    ---------
    
    Co-authored-by: Steve Ruiz <steveruizok@gmail.com>

diff --git a/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx b/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
index fe0ba1f6b..cce4163ca 100644
--- a/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
+++ b/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
@@ -280,11 +280,11 @@ function PatternFillDefForCanvas() {
 			const htmlLayer = findHtmlLayerParent(containerRef.current!)
 			if (htmlLayer) {
 				// Wait for `patternContext` to be picked up
-				requestAnimationFrame(() => {
+				editor.timers.requestAnimationFrame(() => {
 					htmlLayer.style.display = 'none'
 
 					// Wait for 'display = "none"' to take effect
-					requestAnimationFrame(() => {
+					editor.timers.requestAnimationFrame(() => {
 						htmlLayer.style.display = ''
 					})
 				})

commit b7bc2dbbce6a3c53c4ed7c95201c2f82ad5df4ef
Author: Mime Čuvalo <mimecuvalo@gmail.com>
Date:   Wed Jun 5 11:52:10 2024 +0100

    security: don't send referrer paths for images and bookmarks (#3881)
    
    We're currently sending `referrer` with path for image/bookmark
    requests. We shouldn't do that as it exposes the rooms to other servers.
    
    ## `<img>`
    - `<img>` tags have the right referrerpolicy to be
    `strict-origin-when-cross-origin`:
    https://developer.mozilla.org/en-US/docs/Web/HTML/Element/img#referrerpolicy
    - _however_, because we use React, it looks like react creates a raw DOM
    node and adds properties one by one and it loses the default
    referrerpolicy it would otherwise get! So, in `BookmarkShapeUtil` we
    explicitly state the `referrerpolicy`
    - `background-image` does the right thing 👍
    - _also_, I added this to places we do programmatic `new Image()`
    
    ## `fetch`
    - _however_, fetch does not! wtf.
    https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch
    
    it's almost a footnote in this section of the docs
    (https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch#supplying_request_options)
    that `no-referrer-when-downgrade` is the default.
    
    ## `new Image()`
    ugh, but _also_ doing a programmatic `new Image()` doesn't do the right
    thing and we need to set the referrerpolicy here as well
    
    ### Change Type
    
    <!-- ❗ Please select a 'Scope' label ❗️ -->
    
    - [x] `sdk` — Changes the tldraw SDK
    - [x] `dotcom` — Changes the tldraw.com web app
    - [ ] `docs` — Changes to the documentation, examples, or templates.
    - [ ] `vs code` — Changes to the vscode plugin
    - [ ] `internal` — Does not affect user-facing stuff
    
    <!-- ❗ Please select a 'Type' label ❗️ -->
    
    - [x] `bugfix` — Bug fix
    - [ ] `feature` — New feature
    - [ ] `improvement` — Improving existing features
    - [ ] `chore` — Updating dependencies, other boring stuff
    - [ ] `galaxy brain` — Architectural changes
    - [ ] `tests` — Changes to any test code
    - [ ] `tools` — Changes to infrastructure, CI, internal scripts,
    debugging tools, etc.
    - [ ] `dunno` — I don't know
    
    
    ### Test Plan
    
    1. Test on staging that referrer with path isn't being sent anymore.
    
    ### Release Notes
    
    - Security: fix referrer being sent for bookmarks and images.

diff --git a/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx b/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
index cce4163ca..08c8c0fb5 100644
--- a/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
+++ b/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
@@ -28,7 +28,9 @@ export function getFontDefForExport(fontStyle: TLDefaultFontStyle): SvgExportDef
 			const fontFaceRule: string = (font as any).$$_fontface
 			if (!url || !fontFaceRule) return null
 
-			const fontFile = await (await fetch(url)).blob()
+			const fontFile = await (
+				await fetch(url, { referrerPolicy: 'strict-origin-when-cross-origin' })
+			).blob()
 			const base64FontFile = await FileHelpers.blobToDataUrl(fontFile)
 
 			const newFontFaceRule = fontFaceRule.replace(url, base64FontFile)

commit 3adae06d9c1db0b047bf44d2dc216841bcbc6ce8
Author: Mime Čuvalo <mimecuvalo@gmail.com>
Date:   Tue Jun 11 14:59:25 2024 +0100

    security: enforce use of our fetch function and its default referrerpolicy (#3884)
    
    followup to https://github.com/tldraw/tldraw/pull/3881 to enforce this
    in the codebase
    
    Describe what your pull request does. If appropriate, add GIFs or images
    showing the before and after.
    
    ### Change Type
    
    <!-- ❗ Please select a 'Scope' label ❗️ -->
    
    - [x] `sdk` — Changes the tldraw SDK
    - [x] `dotcom` — Changes the tldraw.com web app
    - [ ] `docs` — Changes to the documentation, examples, or templates.
    - [ ] `vs code` — Changes to the vscode plugin
    - [ ] `internal` — Does not affect user-facing stuff
    
    <!-- ❗ Please select a 'Type' label ❗️ -->
    
    - [ ] `bugfix` — Bug fix
    - [ ] `feature` — New feature
    - [x] `improvement` — Improving existing features
    - [ ] `chore` — Updating dependencies, other boring stuff
    - [ ] `galaxy brain` — Architectural changes
    - [ ] `tests` — Changes to any test code
    - [ ] `tools` — Changes to infrastructure, CI, internal scripts,
    debugging tools, etc.
    - [ ] `dunno` — I don't know

diff --git a/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx b/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
index 08c8c0fb5..04cf86add 100644
--- a/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
+++ b/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
@@ -9,6 +9,7 @@ import {
 	TLDefaultFontStyle,
 	TLShapeUtilCanvasSvgDef,
 	debugFlags,
+	fetch,
 	last,
 	useEditor,
 	useValue,
@@ -28,9 +29,7 @@ export function getFontDefForExport(fontStyle: TLDefaultFontStyle): SvgExportDef
 			const fontFaceRule: string = (font as any).$$_fontface
 			if (!url || !fontFaceRule) return null
 
-			const fontFile = await (
-				await fetch(url, { referrerPolicy: 'strict-origin-when-cross-origin' })
-			).blob()
+			const fontFile = await (await fetch(url)).blob()
 			const base64FontFile = await FileHelpers.blobToDataUrl(fontFile)
 
 			const newFontFaceRule = fontFaceRule.replace(url, base64FontFile)

commit ac149c1014fb5f0539d7c55f0f10ce2a05a23f74
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Sun Jun 16 19:58:13 2024 +0300

    Dynamic size mode + fill fill (#3835)
    
    This PR adds a user preference for "dynamic size mode" where the scale
    of shapes (text size, stroke width) is relative to the current zoom
    level. This means that the stroke width in screen pixels (or text size
    in screen pixels) is identical regardless of zoom level.
    
    ![Kapture 2024-05-27 at 05 23
    21](https://github.com/tldraw/tldraw/assets/23072548/f247ecce-bfcd-4f85-b7a5-d7677b38e4d8)
    
    - [x] Draw shape
    - [x] Text shape
    - [x] Highlighter shape
    - [x] Geo shape
    - [x] Arrow shape
    - [x] Note shape
    - [x] Line shape
    
    Embed shape?
    
    ### Change Type
    
    - [x] `sdk` — Changes the tldraw SDK
    - [x] `feature` — New feature
    
    ### Test Plan
    
    1. Use the tools.
    2. Change zoom
    
    - [ ] Unit Tests
    
    ### Release Notes
    
    - Adds a dynamic size user preferences.
    - Removes double click to reset scale on text shapes.
    - Removes double click to reset autosize on text shapes.
    
    ---------
    
    Co-authored-by: Taha <98838967+Taha-Hassan-Git@users.noreply.github.com>
    Co-authored-by: huppy-bot[bot] <128400622+huppy-bot[bot]@users.noreply.github.com>

diff --git a/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx b/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
index 04cf86add..6bd5191e1 100644
--- a/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
+++ b/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
@@ -15,7 +15,7 @@ import {
 	useValue,
 } from '@tldraw/editor'
 import { useEffect, useRef, useState } from 'react'
-import { useDefaultColorTheme } from './ShapeFill'
+import { useDefaultColorTheme } from './useDefaultColorTheme'
 
 /** @public */
 export function getFontDefForExport(fontStyle: TLDefaultFontStyle): SvgExportDef {

commit f05d102cd44ec3ab3ac84b51bf8669ef3b825481
Author: Mitja Bezenšek <mitja.bezensek@gmail.com>
Date:   Mon Jul 29 15:40:18 2024 +0200

    Move from function properties to methods (#4288)
    
    Things left to do
    - [x] Update docs (things like the [tools
    page](https://tldraw-docs-fqnvru1os-tldraw.vercel.app/docs/tools),
    possibly more)
    - [x] Write a list of breaking changes and how to upgrade.
    - [x] Do another pass and check if we can update any lines that have
    `@typescript-eslint/method-signature-style` and
    `local/prefer-class-methods` disabled
    - [x] Thinks about what to do with `TLEventHandlers`. Edit: Feels like
    keeping them is the best way to go.
    - [x] Remove `override` keyword where it's not needed. Not sure if it's
    worth the effort. Edit: decided not to spend time here.
    - [ ] What about possible detached / destructured uses?
    
    Fixes https://github.com/tldraw/tldraw/issues/2799
    
    ### Change type
    
    - [ ] `bugfix`
    - [ ] `improvement`
    - [ ] `feature`
    - [x] `api`
    - [ ] `other`
    
    ### Test plan
    
    1. Create a shape...
    2.
    
    - [ ] Unit tests
    - [ ] End to end tests
    
    ### Release notes
    
    - Adds eslint rules for enforcing the use of methods instead of function
    properties and fixes / disables all the resulting errors.
    
    # Breaking changes
    
    This change affects the syntax of how the event handlers for shape tools
    and utils are defined.
    
    ## Shape utils
    **Before**
    ```ts
    export class CustomShapeUtil extends ShapeUtil<CustomShape> {
       // Defining flags
       override canEdit = () => true
    
       // Defining event handlers
       override onResize: TLOnResizeHandler<CustomShape> = (shape, info) => {
          ...
       }
    }
    ```
    
    
    **After**
    ```ts
    export class CustomShapeUtil extends ShapeUtil<CustomShape> {
       // Defining flags
       override canEdit() {
          return true
       }
    
       // Defining event handlers
       override onResize(shape: CustomShape, info: TLResizeInfo<CustomShape>) {
          ...
       }
    }
    ```
    
    ## Tools
    
    **Before**
    ```ts
    export class CustomShapeTool extends StateNode {
       // Defining child states
       static override children = (): TLStateNodeConstructor[] => [Idle, Pointing]
    
       // Defining event handlers
       override onKeyDown: TLEventHandlers['onKeyDown'] = (info) => {
          ...
       }
    }
    ```
    
    
    **After**
    ```ts
    export class CustomShapeTool extends StateNode {
       // Defining child states
       static override children(): TLStateNodeConstructor[] {
          return [Idle, Pointing]
       }
    
       // Defining event handlers
       override onKeyDown(info: TLKeyboardEventInfo) {
          ...
       }
    }
    ```
    
    ---------
    
    Co-authored-by: David Sheldrick <d.j.sheldrick@gmail.com>
    Co-authored-by: Steve Ruiz <steveruizok@gmail.com>

diff --git a/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx b/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
index 6bd5191e1..18dc4f2ca 100644
--- a/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
+++ b/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
@@ -21,7 +21,7 @@ import { useDefaultColorTheme } from './useDefaultColorTheme'
 export function getFontDefForExport(fontStyle: TLDefaultFontStyle): SvgExportDef {
 	return {
 		key: `${DefaultFontStyle.id}:${fontStyle}`,
-		getElement: async () => {
+		async getElement() {
 			const font = findFont(fontStyle)
 			if (!font) return null
 
@@ -52,7 +52,7 @@ function findFont(name: TLDefaultFontStyle): FontFace | null {
 export function getFillDefForExport(fill: TLDefaultFillStyle): SvgExportDef {
 	return {
 		key: `${DefaultFontStyle.id}:${fill}`,
-		getElement: async () => {
+		async getElement() {
 			if (fill !== 'pattern') return null
 
 			return <HashPatternForExport />

commit 09f89a60f403ff704c1372eff9fecba6cd5ce361
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Mon Sep 30 16:27:45 2024 -0400

    [dotcom] Menus, dialogs, toasts, etc. (#4624)
    
    This PR brings tldraw's ui into the application layer: dialogs, menus,
    etc.
    
    It:
    - brings our dialogs to the application layer
    - brings our toasts to the application layer
    - brings our translations to the application layer
    - brings our assets to the application layer
    - creates a "file menu"
    - creates a "rename file" dialog
    - creates the UI for changing the title of a file in the header
    - adjusts some text sizes
    
    In order to do that, I've had to:
    - create a global `tlmenus` system for menus
    - create a global `tltime` system for timers
    - create a global `tlenv` for environment"
    - create a `useMaybeEditor` hook
    
    ### Change type
    
    - [x] `other`
    
    ### Release notes
    - exports dialogs system
    - exports toasts system
    - exports translations system
    - create a global `tlmenus` system for menus
    - create a global `tltime` system for timers
    - create a global `tlenv` for environment"
    - create a `useMaybeEditor` hook
    
    ---------
    
    Co-authored-by: Mitja Bezenšek <mitja.bezensek@gmail.com>

diff --git a/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx b/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
index 18dc4f2ca..2b05ddea6 100644
--- a/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
+++ b/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
@@ -11,6 +11,7 @@ import {
 	debugFlags,
 	fetch,
 	last,
+	tlenv,
 	useEditor,
 	useValue,
 } from '@tldraw/editor'
@@ -277,7 +278,7 @@ function PatternFillDefForCanvas() {
 	const { defs, isReady } = usePattern()
 
 	useEffect(() => {
-		if (isReady && editor.environment.isSafari) {
+		if (isReady && tlenv.isSafari) {
 			const htmlLayer = findHtmlLayerParent(containerRef.current!)
 			if (htmlLayer) {
 				// Wait for `patternContext` to be picked up

commit d5f4c1d05bb834ab5623d19d418e31e4ab5afa66
Author: alex <alex@dytry.ch>
Date:   Wed Oct 9 15:55:15 2024 +0100

    make sure DOM IDs are globally unique (#4694)
    
    There are a lot of places where we currently derive a DOM ID from a
    shape ID. This works fine (ish) on tldraw.com, but doesn't work for a
    lot of developer use-cases: if there are multiple tldraw instances or
    exports happening, for example. This is because the DOM expects IDs to
    be globally unique. If there are multiple elements with the same ID in
    the dom, only the first is ever used. This can cause issues if e.g.
    
    1. i have a shape with a clip-path determined by the shape ID
    2. i export that shape and add the resulting SVG to the dom. now, there
    are two clip paths with the same ID, but they're the same
    3. I change the shape - and now, the ID is referring to the export, so i
    get weird rendering issues.
    
    This diff attempts to resolve this issue and prevent it from happening
    again by introducing a new `SafeId` type, and helpers for generating and
    working with `SafeId`s. in tldraw, jsx using the `id` attribute will now
    result in a type error if the value isn't a safe ID. This doesn't affect
    library consumers writing JSX.
    
    As part of this, I've removed the ID that were added to certain shapes.
    Instead, all shapes now have a `data-shape-id` attribute on their
    wrapper.
    
    ### Change type
    
    - [x] `bugfix`
    
    ### Release notes
    
    - Exports and other tldraw instances no longer can affect how each other
    are rendered
    - **BREAKING:** the `id` attribute that was present on some shapes in
    the dom has been removed. there's now a data-shape-id attribute on every
    shape wrapper instead though.

diff --git a/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx b/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
index 2b05ddea6..6c5cec139 100644
--- a/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
+++ b/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
@@ -11,11 +11,14 @@ import {
 	debugFlags,
 	fetch,
 	last,
+	suffixSafeId,
 	tlenv,
 	useEditor,
+	useSharedSafeId,
+	useUniqueSafeId,
 	useValue,
 } from '@tldraw/editor'
-import { useEffect, useRef, useState } from 'react'
+import { useCallback, useEffect, useRef, useState } from 'react'
 import { useDefaultColorTheme } from './useDefaultColorTheme'
 
 /** @public */
@@ -62,11 +65,13 @@ export function getFillDefForExport(fill: TLDefaultFillStyle): SvgExportDef {
 }
 
 function HashPatternForExport() {
+	const getHashPatternZoomName = useGetHashPatternZoomName()
+	const maskId = useUniqueSafeId()
 	const theme = useDefaultColorTheme()
 	const t = 8 / 12
 	return (
 		<>
-			<mask id="hash_pattern_mask">
+			<mask id={maskId}>
 				<rect x="0" y="0" width="8" height="8" fill="white" />
 				<g strokeLinecap="round" stroke="black">
 					<line x1={t * 1} y1={t * 3} x2={t * 3} y2={t * 1} />
@@ -80,7 +85,7 @@ function HashPatternForExport() {
 				height="8"
 				patternUnits="userSpaceOnUse"
 			>
-				<rect x="0" y="0" width="8" height="8" fill={theme.solid} mask="url(#hash_pattern_mask)" />
+				<rect x="0" y="0" width="8" height="8" fill={theme.solid} mask={`url(#${maskId})`} />
 			</pattern>
 		</>
 	)
@@ -176,9 +181,15 @@ function getPatternLodForZoomLevel(zoom: number) {
 	return Math.ceil(Math.log2(Math.max(1, zoom)))
 }
 
-export function getHashPatternZoomName(zoom: number, theme: TLDefaultColorTheme['id']) {
-	const lod = getPatternLodForZoomLevel(zoom)
-	return `tldraw_hash_pattern_${theme}_${lod}`
+export function useGetHashPatternZoomName() {
+	const id = useSharedSafeId('hash_pattern')
+	return useCallback(
+		(zoom: number, theme: TLDefaultColorTheme['id']) => {
+			const lod = getPatternLodForZoomLevel(zoom)
+			return suffixSafeId(id, `${theme}_${lod}`)
+		},
+		[id]
+	)
 }
 
 function getPatternLodsToGenerate(maxZoom: number) {
@@ -211,6 +222,7 @@ function usePattern() {
 	const [backgroundUrls, setBackgroundUrls] = useState<PatternDef[]>(() =>
 		getDefaultPatterns(maxZoom)
 	)
+	const getHashPatternZoomName = useGetHashPatternZoomName()
 
 	useEffect(() => {
 		if (process.env.NODE_ENV === 'test') {

commit da786d59e440577bb3731c2ff7e9e013b677b98f
Author: alex <alex@dytry.ch>
Date:   Tue Dec 3 11:25:20 2024 +0000

    Fix some export bugs (#5022)
    
    Fix #5020, #5045 & an issue where running two exports at the same time
    could cause one not to correctly include the right fonts
    
    ### Change type
    
    - [x] `bugfix`
    - [ ] `improvement`
    - [ ] `feature`
    - [ ] `api`
    - [ ] `other`
    
    ### Release notes
    
    - Properly clip scaled text in frames when exporting
    - Stop multiple concurrent exports from interfering with each-others
    fonts
    
    ---------
    
    Co-authored-by: huppy-bot[bot] <128400622+huppy-bot[bot]@users.noreply.github.com>

diff --git a/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx b/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
index 6c5cec139..01557ee17 100644
--- a/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
+++ b/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
@@ -26,12 +26,10 @@ export function getFontDefForExport(fontStyle: TLDefaultFontStyle): SvgExportDef
 	return {
 		key: `${DefaultFontStyle.id}:${fontStyle}`,
 		async getElement() {
-			const font = findFont(fontStyle)
-			if (!font) return null
+			const fontInfo = findFontInfo(fontStyle)
+			if (!fontInfo) return null
 
-			const url: string = (font as any).$$_url
-			const fontFaceRule: string = (font as any).$$_fontface
-			if (!url || !fontFaceRule) return null
+			const { url, fontFaceRule } = fontInfo
 
 			const fontFile = await (await fetch(url)).blob()
 			const base64FontFile = await FileHelpers.blobToDataUrl(fontFile)
@@ -42,11 +40,18 @@ export function getFontDefForExport(fontStyle: TLDefaultFontStyle): SvgExportDef
 	}
 }
 
-function findFont(name: TLDefaultFontStyle): FontFace | null {
+function findFontInfo(name: TLDefaultFontStyle) {
 	const fontFamily = DefaultFontFamilies[name]
 	for (const font of document.fonts) {
 		if (fontFamily.includes(font.family)) {
-			return font
+			if (
+				'$$_url' in font &&
+				typeof font.$$_url === 'string' &&
+				'$$_fontface' in font &&
+				typeof font.$$_fontface === 'string'
+			) {
+				return { url: font.$$_url, fontFaceRule: font.$$_fontface }
+			}
 		}
 	}
 	return null

commit 3bf31007c5a7274f3f7926a84c96c89a4cc2c278
Author: Mime Čuvalo <mimecuvalo@gmail.com>
Date:   Mon Mar 3 14:23:09 2025 +0000

    [feature] add rich text and contextual toolbar (#4895)
    
    We're looking to add rich text to the editor!
    
    We originally started with ProseMirror but it became quickly clear that
    since it's more down-to-the-metal we'd have to rebuild a bunch of
    functionality, effectively managing a rich text editor in addition to a
    2D canvas. Examples of this include behaviors around lists where people
    expect certain behaviors around combination of lists next to each other,
    tabbing, etc.
    On top of those product expectations, we'd need to provide a
    higher-level API that provided better DX around things like
    transactions, switching between lists↔headers, and more.
    
    Given those considerations, a very natural fit was to use TipTap. Much
    like tldraw, they provide a great experience around manipulating a rich
    text editor. And, we want to pass on those product/DX benefits
    downstream to our SDK users.
    
    Some high-level notes:
    - the data is stored as the TipTap stringified JSON, it's lightly
    validated at the moment, but not stringently.
    - there was originally going to be a short-circuit path for plaintext
    but it ended up being error-prone with richtext/plaintext living
    side-by-side. (this meant there were two separate fields)
    - We could still add a way to render faster — I just want to avoid it
    being two separate fields, too many footguns.
    - things like arrow labels are only plain text (debatable though).
    
    Other related efforts:
    - https://github.com/tldraw/tldraw/pull/3051
    - https://github.com/tldraw/tldraw/pull/2825
    
    Todo
    - [ ] figure out whether we should have a migration or not. This is what
    we discussed cc @ds300 and @SomeHats - and whether older clients would
    start messing up newer clients. The data becomes lossy if older clients
    overwrite with plaintext.
    
    <img width="427" alt="Screenshot 2024-12-09 at 14 43 51"
    src="https://github.com/user-attachments/assets/f9dddaee-bfd3-4746-8016-d4247e417e80">
    <img width="378" alt="Screenshot 2024-12-09 at 14 42 59"
    src="https://github.com/user-attachments/assets/95e016d3-ab4d-4d34-afd3-b3ef511d2d77">
    
    Current discussion list:
    - [x] positioning: discuss toolbar position (selection bounds vs cursor
    bounds, toolbar is going in center weirdly sometimes)
    - [x] artificial delay: latest updates make it feel slow/unresponsive?
    e.g. list toggle, changing selection
    - [x] keyboard selection: discuss toolbar logic around "mousing around"
    vs. being present when keyboard selecting (which is annoying)
    - [x] mobile: discuss concerns around mobile toolbar
    - [x] mobile, precision tap: discuss / rm tap into text (and sticky
    notes?) - disable precision editing on mobile
    - [x] discuss
    useContextualToolbar/useContextualToolbarPosition/ContextualToolbar/TldrawUiContextualToolbar
    example
    - [x] existing code: middle alignment for pasted text - keep?
    - [x] existing code: should text replace the shape content when pasted?
    keep?
    - [x] discuss animation, we had it, nixed it, it's back again; why the
    0.08s animation? imperceptible?
    - [x] hide during camera move?
    - [x] short form content - hard to make a different selection b/c
    toolbar is in the way of content
    - [x] check 'overflow: hidden' on tl-text-input (update: this is needed
    to avoid scrollbars)
    - [x] decide on toolbar set: italic, underline, strikethrough, highlight
    - [x] labelColor w/ highlighted text - steve has a commit here to tweak
    highlighting
    
    todos:
    - [x] font rebuild (bold, randomization tweaks) - david looking into
    this
    
    check bugs raised:
    - [x] can't do selection on list item
    - [x] mobile: b/c of the blur/Done logic, doesn't work if you dbl-click
    on geo shape (it's a plaintext problem too)
    - [x] mobile: No cursor when using the text tool - specifically for the
    Text tool — can't repro?
    - [x] VSCode html pasting, whitespace issue?
    - [x] Link toolbar make it extend to the widest size of the current tool
    set
    - [x] code has mutual exclusivity (this is a design choice by the Code
    plugin - we could fork)
    - [x] Text is copied to the clipboard with paragraphs rather than line
    breaks.
    - [x] multi-line plaintext for arrows busted
    
    nixed/outdated
    - [ ] ~link: on mobile should be in modal?~
    - [ ] ~link: back button?~
    - [ ] ~list button toggling? (can't repro)~
    - [ ] ~double/triple-clicking is now wonky with the new logic~
    - [ ] ~move blur() code into useEditableRichText - for Done on iOS~
    - [ ] ~toolbar when shape is rotated~
    - [ ] ~"The "isMousingDown" logic doesn't work, the events aren't
    reaching the window. Not sure how we get those from the editor element."
    (can't repro?)~
    - [ ] ~toolbar position bug when toggling code on and off (can't
    repro?)~
    - [ ] ~some issue around "Something's up with the initial size
    calculated from the text selection bounds."~
    - [ ] ~mobile: Context bar still visible out if user presses "Done" to
    end editing~
    - [ ] ~mobile: toolbar when switching between text fields~
    
    
    ### Change type
    
    - [ ] `bugfix`
    - [ ] `improvement`
    - [x] `feature`
    - [ ] `api`
    - [ ] `other`
    
    ### Test plan
    
    1. TODO: write a bunch more tests
    
    - [x] Unit tests
    - [x] End to end tests
    
    ### Release notes
    
    - Rich text using ProseMirror as a first-class supported option in the
    Editor.
    
    ---------
    
    Co-authored-by: huppy-bot[bot] <128400622+huppy-bot[bot]@users.noreply.github.com>
    Co-authored-by: alex <alex@dytry.ch>
    Co-authored-by: David Sheldrick <d.j.sheldrick@gmail.com>
    Co-authored-by: Steve Ruiz <steveruizok@gmail.com>

diff --git a/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx b/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
index 01557ee17..0c39a5aac 100644
--- a/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
+++ b/packages/tldraw/src/lib/shapes/shared/defaultStyleDefs.tsx
@@ -1,15 +1,11 @@
 import {
 	DefaultColorThemePalette,
-	DefaultFontFamilies,
 	DefaultFontStyle,
-	FileHelpers,
 	SvgExportDef,
 	TLDefaultColorTheme,
 	TLDefaultFillStyle,
-	TLDefaultFontStyle,
 	TLShapeUtilCanvasSvgDef,
 	debugFlags,
-	fetch,
 	last,
 	suffixSafeId,
 	tlenv,
@@ -21,42 +17,6 @@ import {
 import { useCallback, useEffect, useRef, useState } from 'react'
 import { useDefaultColorTheme } from './useDefaultColorTheme'
 
-/** @public */
-export function getFontDefForExport(fontStyle: TLDefaultFontStyle): SvgExportDef {
-	return {
-		key: `${DefaultFontStyle.id}:${fontStyle}`,
-		async getElement() {
-			const fontInfo = findFontInfo(fontStyle)
-			if (!fontInfo) return null
-
-			const { url, fontFaceRule } = fontInfo
-
-			const fontFile = await (await fetch(url)).blob()
-			const base64FontFile = await FileHelpers.blobToDataUrl(fontFile)
-
-			const newFontFaceRule = fontFaceRule.replace(url, base64FontFile)
-			return <style>{newFontFaceRule}</style>
-		},
-	}
-}
-
-function findFontInfo(name: TLDefaultFontStyle) {
-	const fontFamily = DefaultFontFamilies[name]
-	for (const font of document.fonts) {
-		if (fontFamily.includes(font.family)) {
-			if (
-				'$$_url' in font &&
-				typeof font.$$_url === 'string' &&
-				'$$_fontface' in font &&
-				typeof font.$$_fontface === 'string'
-			) {
-				return { url: font.$$_url, fontFaceRule: font.$$_fontface }
-			}
-		}
-	}
-	return null
-}
-
 /** @public */
 export function getFillDefForExport(fill: TLDefaultFillStyle): SvgExportDef {
 	return {

</code></pre>
        </section>
    </main>
    <footer>
        <p>LoCoDiff-bench - <a href="https://github.com/AbanteAI/LoCoDiff-bench">GitHub Repository</a></p>
    </footer>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            hljs.highlightAll();
        });
    </script>
</body>
</html>
    