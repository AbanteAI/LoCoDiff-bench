<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prompt: packages/editor/src/lib/TldrawEditor.tsx - DeepSeek R1 0528</title>
    <link rel="stylesheet" href="../../../../styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/default.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
</head>
<body>
    <header>
        <h1>Prompt: packages/editor/src/lib/TldrawEditor.tsx</h1>
        <h2>Model: DeepSeek R1 0528</h2>
        <p><a href="../../../cases/deepseek_deepseek-r1-0528/tldraw_packages_editor_src_lib_TldrawEditor.tsx.html">Back to Case</a> | <a href="../../../cases.html">All Cases</a> | <a href="../../../index.html">Home</a></p>
    </header>
    <main>
        <section>
            <h2>Prompt Content</h2>
            <pre><code class="language-plaintext"># Instructions

You are being benchmarked. You will see the output of a git log command, and from that must infer the current state of a file. Think carefully, as you must output the exact state of the file to earn full marks.

**Important:** Your goal is to reproduce the file's content *exactly* as it exists at the final commit, even if the code appears broken, buggy, or contains obvious errors. Do **not** try to "fix" the code. Attempting to correct issues will result in a poor score, as this benchmark evaluates your ability to reproduce the precise state of the file based on its history.

# Required Response Format

Wrap the content of the file in triple backticks (```). Any text outside the final closing backticks will be ignored. End your response after outputting the closing backticks.

# Example Response

```python
#!/usr/bin/env python
print('Hello, world!')
```

# File History

> git log -p --cc --topo-order --reverse -- packages/editor/src/lib/TldrawEditor.tsx

commit 29ed921c6745923dcc8daa72ba6f815a5c4b279a
Author: alex <alex@dytry.ch>
Date:   Tue Apr 25 12:01:25 2023 +0100

    transfer-out: transfer out

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
new file mode 100644
index 000000000..cafb9f827
--- /dev/null
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -0,0 +1,325 @@
+import { TLAsset, TLInstance, TLInstanceId, TLStore, TLUser, TLUserId } from '@tldraw/tlschema'
+import { Store } from '@tldraw/tlstore'
+import { annotateError } from '@tldraw/utils'
+import React, { useCallback, useSyncExternalStore } from 'react'
+import { App } from './app/App'
+import { EditorAssetUrls, defaultEditorAssetUrls } from './assetUrls'
+import { OptionalErrorBoundary } from './components/ErrorBoundary'
+
+import { SyncedStore } from './config/SyncedStore'
+import { TldrawEditorConfig } from './config/TldrawEditorConfig'
+
+import { DefaultErrorFallback } from './components/DefaultErrorFallback'
+import { AppContext } from './hooks/useApp'
+import { ContainerProvider, useContainer } from './hooks/useContainer'
+import { useCursor } from './hooks/useCursor'
+import { useDarkMode } from './hooks/useDarkMode'
+import {
+	EditorComponentsProvider,
+	TLEditorComponents,
+	useEditorComponents,
+} from './hooks/useEditorComponents'
+import { useEvent } from './hooks/useEvent'
+import { useForceUpdate } from './hooks/useForceUpdate'
+import { usePreloadAssets } from './hooks/usePreloadAssets'
+import { useSafariFocusOutFix } from './hooks/useSafariFocusOutFix'
+import { useZoomCss } from './hooks/useZoomCss'
+
+/** @public */
+export interface TldrawEditorProps {
+	children?: any
+	/** Overrides for the tldraw components */
+	components?: Partial<TLEditorComponents>
+	/** Whether to display the dark mode. */
+	isDarkMode?: boolean
+	/** A configuration defining major customizations to the app, such as custom shapes and new tools */
+	config?: TldrawEditorConfig
+	/**
+	 * Called when the app has mounted.
+	 *
+	 * @example
+	 *
+	 * ```ts
+	 * function TldrawEditor() {
+	 * 	return <Editor onMount={(app) => app.selectAll()} />
+	 * }
+	 * ```
+	 *
+	 * @param app - The app instance.
+	 */
+	onMount?: (app: App) => void
+	/**
+	 * Called when the app generates a new asset from a file, such as when an image is dropped into
+	 * the canvas.
+	 *
+	 * @example
+	 *
+	 * ```ts
+	 * const app = new App({
+	 * 	onCreateAssetFromFile: (file) => uploadFileAndCreateAsset(file),
+	 * })
+	 * ```
+	 *
+	 * @param file - The file to generate an asset from.
+	 * @param id - The id to be assigned to the resulting asset.
+	 */
+	onCreateAssetFromFile?: (file: File) => Promise<TLAsset>
+
+	/**
+	 * Called when a URL is converted to a bookmark. This callback should return the metadata for the
+	 * bookmark.
+	 *
+	 * @example
+	 *
+	 * ```ts
+	 * app.onCreateBookmarkFromUrl(url, id)
+	 * ```
+	 *
+	 * @param url - The url that was created.
+	 * @public
+	 */
+	onCreateBookmarkFromUrl?: (
+		url: string
+	) => Promise<{ image: string; title: string; description: string }>
+
+	/**
+	 * The Store instance to use for keeping the app's data. This may be prepopulated, e.g. by loading
+	 * from a server or database.
+	 */
+	store?: TLStore | SyncedStore
+	/** The id of the current user. If not given, one will be generated. */
+	userId?: TLUserId
+	/**
+	 * The id of the app instance (e.g. a browser tab if the app will have only one tldraw app per
+	 * tab). If not given, one will be generated.
+	 */
+	instanceId?: TLInstanceId
+	/** Asset URLs */
+	assetUrls?: EditorAssetUrls
+	/** Whether to automatically focus the editor when it mounts. */
+	autoFocus?: boolean
+}
+
+declare global {
+	interface Window {
+		tldrawReady: boolean
+	}
+}
+
+/** @public */
+export function TldrawEditor(props: TldrawEditorProps) {
+	const [container, setContainer] = React.useState<HTMLDivElement | null>(null)
+	const { components, ...rest } = props
+
+	const ErrorFallback =
+		components?.ErrorFallback === undefined ? DefaultErrorFallback : components?.ErrorFallback
+
+	return (
+		<div ref={setContainer} draggable={false} className="rs-container rs-theme__light" tabIndex={0}>
+			<OptionalErrorBoundary
+				fallback={ErrorFallback ? (error) => <ErrorFallback error={error} /> : null}
+				onError={(error) => annotateError(error, { tags: { origin: 'react.tldraw-before-app' } })}
+			>
+				{container && (
+					<ContainerProvider container={container}>
+						<EditorComponentsProvider overrides={components}>
+							<TldrawEditorBeforeLoading {...rest} />
+						</EditorComponentsProvider>
+					</ContainerProvider>
+				)}
+			</OptionalErrorBoundary>
+		</div>
+	)
+}
+
+function TldrawEditorBeforeLoading({
+	config = TldrawEditorConfig.default,
+	userId,
+	instanceId,
+	store,
+	...props
+}: TldrawEditorProps) {
+	const { done: preloadingComplete, error: preloadingError } = usePreloadAssets(
+		props.assetUrls ?? defaultEditorAssetUrls
+	)
+
+	store ??= config.createStore({
+		userId: userId ?? TLUser.createId(),
+		instanceId: instanceId ?? TLInstance.createId(),
+	})
+
+	let loadedStore
+	if (!(store instanceof Store)) {
+		if (store.error) {
+			// for error handling, we fall back to the default error boundary.
+			// if users want to handle this error differently, they can render
+			// their own error screen before the TldrawEditor component
+			throw store.error
+		}
+		if (!store.store) {
+			return <LoadingScreen>Connecting...</LoadingScreen>
+		}
+
+		loadedStore = store.store
+	} else {
+		loadedStore = store
+	}
+
+	if (instanceId && loadedStore.props.instanceId !== instanceId) {
+		console.error(
+			`The store's instanceId (${loadedStore.props.instanceId}) does not match the instanceId prop (${instanceId}). This may cause unexpected behavior.`
+		)
+	}
+
+	if (userId && loadedStore.props.userId !== userId) {
+		console.error(
+			`The store's userId (${loadedStore.props.userId}) does not match the userId prop (${userId}). This may cause unexpected behavior.`
+		)
+	}
+
+	if (preloadingError) {
+		return <ErrorScreen>Could not load assets. Please refresh the page.</ErrorScreen>
+	}
+
+	if (!preloadingComplete) {
+		return <LoadingScreen>Loading assets...</LoadingScreen>
+	}
+
+	return <TldrawEditorAfterLoading {...props} store={loadedStore} config={config} />
+}
+
+function TldrawEditorAfterLoading({
+	onMount,
+	config,
+	isDarkMode,
+	children,
+	onCreateAssetFromFile,
+	onCreateBookmarkFromUrl,
+	store,
+	autoFocus,
+}: Omit<TldrawEditorProps, 'store' | 'config' | 'instanceId' | 'userId'> & {
+	config: TldrawEditorConfig
+	store: TLStore
+}) {
+	const container = useContainer()
+
+	const [app, setApp] = React.useState<App | null>(null)
+	const { ErrorFallback } = useEditorComponents()
+
+	React.useLayoutEffect(() => {
+		const app = new App({
+			store,
+			getContainer: () => container,
+			config,
+		})
+		setApp(app)
+
+		if (autoFocus) {
+			app.focus()
+		}
+		;(window as any).app = app
+		return () => {
+			app.dispose()
+			setApp((prevApp) => (prevApp === app ? null : prevApp))
+		}
+	}, [container, config, store, autoFocus])
+
+	React.useEffect(() => {
+		if (app) {
+			// Overwrite the default onCreateAssetFromFile handler.
+			if (onCreateAssetFromFile) {
+				app.onCreateAssetFromFile = onCreateAssetFromFile
+			}
+
+			if (onCreateBookmarkFromUrl) {
+				app.onCreateBookmarkFromUrl = onCreateBookmarkFromUrl
+			}
+		}
+	}, [app, onCreateAssetFromFile, onCreateBookmarkFromUrl])
+
+	const onMountEvent = useEvent((app: App) => onMount?.(app))
+	React.useEffect(() => {
+		if (app) {
+			// Set the initial theme state.
+			if (isDarkMode !== undefined) {
+				app.updateUserDocumentSettings({ isDarkMode })
+			}
+
+			// Run onMount
+			window.tldrawReady = true
+			onMountEvent(app)
+		}
+	}, [app, onMountEvent, isDarkMode])
+
+	const crashingError = useSyncExternalStore(
+		useCallback(
+			(onStoreChange) => {
+				if (app) {
+					app.on('crash', onStoreChange)
+					return () => app.off('crash', onStoreChange)
+				}
+				return () => {
+					// noop
+				}
+			},
+			[app]
+		),
+		() => app?.crashingError ?? null
+	)
+
+	if (!app) {
+		return null
+	}
+
+	return (
+		// the top-level tldraw component also renders an error boundary almost
+		// identical to this one. the reason we have two is because this one has
+		// access to `App`, which means that here we can enrich errors with data
+		// from app for reporting, and also still attempt to render the user's
+		// document in the event of an error to reassure them that their work is
+		// not lost.
+		<OptionalErrorBoundary
+			fallback={ErrorFallback ? (error) => <ErrorFallback error={error} app={app} /> : null}
+			onError={(error) => app.annotateError(error, { origin: 'react.tldraw', willCrashApp: true })}
+		>
+			{crashingError ? (
+				<Crash crashingError={crashingError} />
+			) : (
+				<AppContext.Provider value={app}>
+					<Layout>{children}</Layout>
+				</AppContext.Provider>
+			)}
+		</OptionalErrorBoundary>
+	)
+}
+
+function Layout({ children }: { children: any }) {
+	useZoomCss()
+	useCursor()
+	useDarkMode()
+	useSafariFocusOutFix()
+	useForceUpdate()
+
+	return children
+}
+
+function Crash({ crashingError }: { crashingError: unknown }): null {
+	throw crashingError
+}
+
+/** @public */
+export function LoadingScreen({ children }: { children: any }) {
+	const { Spinner } = useEditorComponents()
+
+	return (
+		<div className="rs-loading">
+			{Spinner ? <Spinner /> : null}
+			{children}
+		</div>
+	)
+}
+
+/** @public */
+export function ErrorScreen({ children }: { children: any }) {
+	return <div className="rs-loading">{children}</div>
+}

commit dc16ae1b1267b89b85f501ad2e979f618089a89b
Author: Lu[ke] Wilson <l2wilson94@gmail.com>
Date:   Fri May 5 07:14:42 2023 -0700

    remove svg layer, html all the things, rs to tl (#1227)
    
    This PR has been hijacked! 🗑️🦝🦝🦝
    
    The <Canvas> component was previously split into an <SVGLayer> and an
    <HTMLLayer>, mainly due to the complexity around translating SVGs.
    However, this was done before we learned that SVGs can have overflow:
    visible, so it turns out that we don't really need the SVGLayer at all.
    This PR now refactors away SVG Layer.
    
    It also updates the class name prefix in editor from `rs-` to `tl-` and
    does a few other small changes.
    
    ---------
    
    Co-authored-by: Steve Ruiz <steveruizok@gmail.com>

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index cafb9f827..3a1d541ca 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -115,7 +115,7 @@ export function TldrawEditor(props: TldrawEditorProps) {
 		components?.ErrorFallback === undefined ? DefaultErrorFallback : components?.ErrorFallback
 
 	return (
-		<div ref={setContainer} draggable={false} className="rs-container rs-theme__light" tabIndex={0}>
+		<div ref={setContainer} draggable={false} className="tl-container tl-theme__light" tabIndex={0}>
 			<OptionalErrorBoundary
 				fallback={ErrorFallback ? (error) => <ErrorFallback error={error} /> : null}
 				onError={(error) => annotateError(error, { tags: { origin: 'react.tldraw-before-app' } })}
@@ -312,7 +312,7 @@ export function LoadingScreen({ children }: { children: any }) {
 	const { Spinner } = useEditorComponents()
 
 	return (
-		<div className="rs-loading">
+		<div className="tl-loading">
 			{Spinner ? <Spinner /> : null}
 			{children}
 		</div>
@@ -321,5 +321,5 @@ export function LoadingScreen({ children }: { children: any }) {
 
 /** @public */
 export function ErrorScreen({ children }: { children: any }) {
-	return <div className="rs-loading">{children}</div>
+	return <div className="tl-loading">{children}</div>
 }

commit 3437ca89d9e9e9c1397c06896d1768c196954cb6
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Thu May 11 23:14:58 2023 +0100

    [feature] ui events (#1326)
    
    This PR updates the editor events:
    - adds types to the events emitted by the app (by `app.emit`)
    - removes a few events emitted by the app (e.g. `move-to-page`,
    `change-camera`)
    - adds `onEvent` prop to the <TldrawUi> / <Tldraw> components
    - call the `onEvent` when actions occur or tools are selected
    - does some superficial cleanup on editor app APIs
    
    ### Release Note
    
    - Fix layout bug in error dialog
    - (ui) Add `TLEventMap` for types emitted from editor app
    - (editor) Update `crash` event emitted from editor app to include error
    - (editor) Update `change-history` event emitted from editor app
    - (editor) Remove `change-camera` event from editor app
    - (editor) Remove `move-to-page` event from editor app
    - (ui) Add `onEvent` prop and events to <Tldraw> / <TldrawUi>
    - (editor) Replace `app.openMenus` plain Set with computed value
    - (editor) Add `addOpenMenu` method
    - (editor) Add `removeOpenMenu` method
    - (editor) Add `setFocusMode` method
    - (editor) Add `setToolLocked` method
    - (editor) Add `setSnapMode` method
    - (editor) Add `isSnapMode` method
    - (editor) Update `setGridMode` method return type to editor app
    - (editor) Update `setReadOnly` method return type to editor app
    - (editor) Update `setPenMode` method return type to editor app
    - (editor) Update `selectNone` method return type to editor app
    - (editor) Rename `backToContent` to `zoomToContent`
    - (editor) Remove `TLReorderOperation` type
    
    ---------
    
    Co-authored-by: Orange Mug <orangemug@users.noreply.github.com>

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index 3a1d541ca..948845a7c 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -237,7 +237,11 @@ function TldrawEditorAfterLoading({
 		}
 	}, [app, onCreateAssetFromFile, onCreateBookmarkFromUrl])
 
-	const onMountEvent = useEvent((app: App) => onMount?.(app))
+	const onMountEvent = useEvent((app: App) => {
+		onMount?.(app)
+		app.emit('mount')
+	})
+
 	React.useEffect(() => {
 		if (app) {
 			// Set the initial theme state.

commit eb2696413040589b670af18324e5fc3688a2f678
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Wed May 24 11:48:31 2023 +0100

    [refactor] restore createTLSchema (#1444)
    
    This PR restores `createTLSchema`.
    
    It also:
    - removes `TldrawEditorConfig.default`
    - makes `config` a required property of `<TldrawEditor>`, though it's
    created automatically in `<Tldraw>`.
    - makes `config` a required property of `App`
    - removes `TLShapeType` and replaces the rare usage with
    `TLShape["type"]`
    - adds `TLDefaultShape` for a union of our default shapes
    - makes `TLShape` a union of `TLDefaultShape` and `TLUnknownShape`
    
    ### Change Type
    
    - [x] `major` — Breaking Change
    
    ### Release Notes
    
    - [editor] Simplifies custom shape definition
    - [tldraw] Updates props for <TldrawEditor> component to require a
    `TldrawEditorConfig`.

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index 948845a7c..7a55fba6d 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -1,7 +1,7 @@
 import { TLAsset, TLInstance, TLInstanceId, TLStore, TLUser, TLUserId } from '@tldraw/tlschema'
 import { Store } from '@tldraw/tlstore'
 import { annotateError } from '@tldraw/utils'
-import React, { useCallback, useSyncExternalStore } from 'react'
+import React, { useCallback, useEffect, useState, useSyncExternalStore } from 'react'
 import { App } from './app/App'
 import { EditorAssetUrls, defaultEditorAssetUrls } from './assetUrls'
 import { OptionalErrorBoundary } from './components/ErrorBoundary'
@@ -28,12 +28,12 @@ import { useZoomCss } from './hooks/useZoomCss'
 /** @public */
 export interface TldrawEditorProps {
 	children?: any
+	/** A configuration defining major customizations to the app, such as custom shapes and new tools */
+	config: TldrawEditorConfig
 	/** Overrides for the tldraw components */
 	components?: Partial<TLEditorComponents>
 	/** Whether to display the dark mode. */
 	isDarkMode?: boolean
-	/** A configuration defining major customizations to the app, such as custom shapes and new tools */
-	config?: TldrawEditorConfig
 	/**
 	 * Called when the app has mounted.
 	 *
@@ -133,7 +133,7 @@ export function TldrawEditor(props: TldrawEditorProps) {
 }
 
 function TldrawEditorBeforeLoading({
-	config = TldrawEditorConfig.default,
+	config,
 	userId,
 	instanceId,
 	store,
@@ -143,26 +143,43 @@ function TldrawEditorBeforeLoading({
 		props.assetUrls ?? defaultEditorAssetUrls
 	)
 
-	store ??= config.createStore({
-		userId: userId ?? TLUser.createId(),
-		instanceId: instanceId ?? TLInstance.createId(),
+	const [_store, _setStore] = useState<TLStore | SyncedStore>(() => {
+		return (
+			store ??
+			config.createStore({
+				userId: userId ?? TLUser.createId(),
+				instanceId: instanceId ?? TLInstance.createId(),
+			})
+		)
 	})
 
-	let loadedStore
-	if (!(store instanceof Store)) {
-		if (store.error) {
+	useEffect(() => {
+		_setStore(() => {
+			return (
+				store ??
+				config.createStore({
+					userId: userId ?? TLUser.createId(),
+					instanceId: instanceId ?? TLInstance.createId(),
+				})
+			)
+		})
+	}, [store, config, userId, instanceId])
+
+	let loadedStore: TLStore | SyncedStore
+	if (!(_store instanceof Store)) {
+		if (_store.error) {
 			// for error handling, we fall back to the default error boundary.
 			// if users want to handle this error differently, they can render
 			// their own error screen before the TldrawEditor component
-			throw store.error
+			throw _store.error
 		}
-		if (!store.store) {
+		if (!_store.store) {
 			return <LoadingScreen>Connecting...</LoadingScreen>
 		}
 
-		loadedStore = store.store
+		loadedStore = _store.store
 	} else {
-		loadedStore = store
+		loadedStore = _store
 	}
 
 	if (instanceId && loadedStore.props.instanceId !== instanceId) {
@@ -209,8 +226,8 @@ function TldrawEditorAfterLoading({
 	React.useLayoutEffect(() => {
 		const app = new App({
 			store,
-			getContainer: () => container,
 			config,
+			getContainer: () => container,
 		})
 		setApp(app)
 

commit 356a0d1e73000ab94dcf828527eaedb230842096
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Thu May 25 10:54:29 2023 +0100

    [chore] refactor user preferences (#1435)
    
    - Remove TLUser, TLUserPresence
    - Add first-class support for user preferences that persists across
    rooms and tabs
    
    ### Change Type
    
    <!-- 💡 Indicate the type of change your pull request is. -->
    <!-- 🤷‍♀️ If you're not sure, don't select anything -->
    <!-- ✂️ Feel free to delete unselected options -->
    
    <!-- To select one, put an x in the box: [x] -->
    
    - [ ] `patch` — Bug Fix
    - [ ] `minor` — New Feature
    - [x] `major` — Breaking Change
    - [ ] `dependencies` — Dependency Update (publishes a `patch` release,
    for devDependencies use `internal`)
    - [ ] `documentation` — Changes to the documentation only (will not
    publish a new version)
    - [ ] `tests` — Changes to any testing-related code only (will not
    publish a new version)
    - [ ] `internal` — Any other changes that don't affect the published
    package (will not publish a new version)
    
    ### Test Plan
    
    1. Add a step-by-step description of how to test your PR here.
    2.
    
    - [ ] Unit Tests
    - [ ] Webdriver tests
    
    ### Release Notes
    
    - Add a brief release note for your PR here.

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index 7a55fba6d..8ce45956b 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -1,7 +1,7 @@
-import { TLAsset, TLInstance, TLInstanceId, TLStore, TLUser, TLUserId } from '@tldraw/tlschema'
+import { TLAsset, TLInstance, TLInstanceId, TLStore } from '@tldraw/tlschema'
 import { Store } from '@tldraw/tlstore'
 import { annotateError } from '@tldraw/utils'
-import React, { useCallback, useEffect, useState, useSyncExternalStore } from 'react'
+import React, { useCallback, useMemo, useSyncExternalStore } from 'react'
 import { App } from './app/App'
 import { EditorAssetUrls, defaultEditorAssetUrls } from './assetUrls'
 import { OptionalErrorBoundary } from './components/ErrorBoundary'
@@ -87,8 +87,6 @@ export interface TldrawEditorProps {
 	 * from a server or database.
 	 */
 	store?: TLStore | SyncedStore
-	/** The id of the current user. If not given, one will be generated. */
-	userId?: TLUserId
 	/**
 	 * The id of the app instance (e.g. a browser tab if the app will have only one tldraw app per
 	 * tab). If not given, one will be generated.
@@ -132,38 +130,19 @@ export function TldrawEditor(props: TldrawEditorProps) {
 	)
 }
 
-function TldrawEditorBeforeLoading({
-	config,
-	userId,
-	instanceId,
-	store,
-	...props
-}: TldrawEditorProps) {
+function TldrawEditorBeforeLoading({ config, instanceId, store, ...props }: TldrawEditorProps) {
 	const { done: preloadingComplete, error: preloadingError } = usePreloadAssets(
 		props.assetUrls ?? defaultEditorAssetUrls
 	)
 
-	const [_store, _setStore] = useState<TLStore | SyncedStore>(() => {
+	const _store = useMemo<TLStore | SyncedStore>(() => {
 		return (
 			store ??
 			config.createStore({
-				userId: userId ?? TLUser.createId(),
 				instanceId: instanceId ?? TLInstance.createId(),
 			})
 		)
-	})
-
-	useEffect(() => {
-		_setStore(() => {
-			return (
-				store ??
-				config.createStore({
-					userId: userId ?? TLUser.createId(),
-					instanceId: instanceId ?? TLInstance.createId(),
-				})
-			)
-		})
-	}, [store, config, userId, instanceId])
+	}, [store, config, instanceId])
 
 	let loadedStore: TLStore | SyncedStore
 	if (!(_store instanceof Store)) {
@@ -188,12 +167,6 @@ function TldrawEditorBeforeLoading({
 		)
 	}
 
-	if (userId && loadedStore.props.userId !== userId) {
-		console.error(
-			`The store's userId (${loadedStore.props.userId}) does not match the userId prop (${userId}). This may cause unexpected behavior.`
-		)
-	}
-
 	if (preloadingError) {
 		return <ErrorScreen>Could not load assets. Please refresh the page.</ErrorScreen>
 	}
@@ -208,7 +181,6 @@ function TldrawEditorBeforeLoading({
 function TldrawEditorAfterLoading({
 	onMount,
 	config,
-	isDarkMode,
 	children,
 	onCreateAssetFromFile,
 	onCreateBookmarkFromUrl,
@@ -257,20 +229,15 @@ function TldrawEditorAfterLoading({
 	const onMountEvent = useEvent((app: App) => {
 		onMount?.(app)
 		app.emit('mount')
+		window.tldrawReady = true
 	})
 
 	React.useEffect(() => {
 		if (app) {
-			// Set the initial theme state.
-			if (isDarkMode !== undefined) {
-				app.updateUserDocumentSettings({ isDarkMode })
-			}
-
 			// Run onMount
-			window.tldrawReady = true
 			onMountEvent(app)
 		}
-	}, [app, onMountEvent, isDarkMode])
+	}, [app, onMountEvent])
 
 	const crashingError = useSyncExternalStore(
 		useCallback(

commit 3450de5282fd884c1298b9eaef3044fdc1d3e6d6
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Fri May 26 14:37:59 2023 +0100

    [refactor] update record names (#1473)
    
    This PR renames our record types to avoid a type collision with the type
    that they are based on. For example `TLCamera` is both a type and a
    record; after this PR, we use `CameraRecordType` for the camera's record
    type.
    
    ### Change Type
    
    - [x] `major` — Breaking Change
    
    ### Release Notes
    
    - [editor] rename record types

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index 8ce45956b..2f5c57b61 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -1,4 +1,4 @@
-import { TLAsset, TLInstance, TLInstanceId, TLStore } from '@tldraw/tlschema'
+import { InstanceRecordType, TLAsset, TLInstanceId, TLStore } from '@tldraw/tlschema'
 import { Store } from '@tldraw/tlstore'
 import { annotateError } from '@tldraw/utils'
 import React, { useCallback, useMemo, useSyncExternalStore } from 'react'
@@ -139,7 +139,7 @@ function TldrawEditorBeforeLoading({ config, instanceId, store, ...props }: Tldr
 		return (
 			store ??
 			config.createStore({
-				instanceId: instanceId ?? TLInstance.createId(),
+				instanceId: instanceId ?? InstanceRecordType.createId(),
 			})
 		)
 	}, [store, config, instanceId])

commit 0c4174c0b8b0ef1250cc3bd4c4030f99e5204929
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Thu Jun 1 16:47:34 2023 +0100

    [refactor] User-facing APIs (#1478)
    
    This PR updates our user-facing APIs for the Tldraw and TldrawEditor
    components, as well as the Editor (App). It mainly incorporates surface
    changes from #1450 without any changes to validators or migrators,
    incorporating feedback / discussion with @SomeHats and @ds300.
    
    Here we:
    - remove the TldrawEditorConfig
    - bring back a loose version of shape definitions
    - make a separation between "core" shapes and "default" shapes
    - do not allow custom shapes, migrators or validators to overwrite core
    shapes
    - but _do_ allow new shapes
    
    ## `<Tldraw>` component
    
    In this PR, the `Tldraw` component wraps both the `TldrawEditor`
    component and our `TldrawUi` component. It accepts a union of props for
    both components. Previously, this component also added local syncing via
    a `useLocalSyncClient` hook call, however that has been pushed down to
    the `TldrawEditor` component.
    
    ## `<TldrawEditor>` component
    
    The `TldrawEditor` component now more neatly wraps up the different ways
    that the editor can be configured.
    
    ## The store prop (`TldrawEditorProps.store`)
    
    There are three main ways for the `TldrawEditor` component to be run:
    1. with an externally defined store
    2. with an externally defined syncing store (local or remote)
    3. with an internally defined store
    4. with an internally defined locally syncing store
    
    The `store` prop allows for these configurations.
    
    If the `store` prop is defined, it may be defined either as a `TLStore`
    or as a `SyncedStore`. If the store is a `TLStore`, then the Editor will
    assume that the store is ready to go; if it is defined as a SyncedStore,
    then the component will display the loading / error screens as needed,
    or the final editor once the store's status is "synced".
    
    When the store is left undefined, then the `TldrawEditor` will create
    its own internal store using the optional `instanceId`, `initialData`,
    or `shapes` props to define the store / store schema.
    
    If the `persistenceKey` prop is left undefined, then the store will not
    be synced. If the `persistenceKey` is defined, then the store will be
    synced locally. In the future, we may also here accept the API key /
    roomId / etc for creating a remotely synced store.
    
    The `SyncedStore` type has been expanded to also include types used for
    remote syncing, e.g. with `ConnectionStatus`.
    
    ## Tools
    
    By default, the App has two "baked-in" tools: the select tool and the
    zoom tool. These cannot (for now) be replaced or removed. The default
    tools are used by default, but may be replaced by other tools if
    provided.
    
    ## Shapes
    
    By default, the App has a set of "core" shapes:
    - group
    - embed
    - bookmark
    - image
    - video
    - text
    
    That cannot by overwritten because they're created by the app at
    different moments, such as when double clicking on the canvas or via a
    copy and paste event. In follow up PRs, we'll split these out so that
    users can replace parts of the code where these shapes are created.
    
    ### Change Type
    
    - [x] `major` — Breaking Change
    
    ### Test Plan
    
    - [x] Unit Tests

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index 2f5c57b61..2f83c7b65 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -1,15 +1,13 @@
-import { InstanceRecordType, TLAsset, TLInstanceId, TLStore } from '@tldraw/tlschema'
-import { Store } from '@tldraw/tlstore'
+import { TLAsset, TLInstanceId, TLRecord, TLStore } from '@tldraw/tlschema'
+import { Store, StoreSnapshot } from '@tldraw/tlstore'
 import { annotateError } from '@tldraw/utils'
-import React, { useCallback, useMemo, useSyncExternalStore } from 'react'
+import React, { memo, useCallback, useLayoutEffect, useState, useSyncExternalStore } from 'react'
 import { App } from './app/App'
+import { StateNodeConstructor } from './app/statechart/StateNode'
 import { EditorAssetUrls, defaultEditorAssetUrls } from './assetUrls'
-import { OptionalErrorBoundary } from './components/ErrorBoundary'
-
-import { SyncedStore } from './config/SyncedStore'
-import { TldrawEditorConfig } from './config/TldrawEditorConfig'
-
 import { DefaultErrorFallback } from './components/DefaultErrorFallback'
+import { OptionalErrorBoundary } from './components/ErrorBoundary'
+import { ShapeInfo } from './config/createTLStore'
 import { AppContext } from './hooks/useApp'
 import { ContainerProvider, useContainer } from './hooks/useContainer'
 import { useCursor } from './hooks/useCursor'
@@ -21,21 +19,38 @@ import {
 } from './hooks/useEditorComponents'
 import { useEvent } from './hooks/useEvent'
 import { useForceUpdate } from './hooks/useForceUpdate'
+import { useLocalStore } from './hooks/useLocalStore'
 import { usePreloadAssets } from './hooks/usePreloadAssets'
 import { useSafariFocusOutFix } from './hooks/useSafariFocusOutFix'
 import { useZoomCss } from './hooks/useZoomCss'
+import { StoreWithStatus } from './utils/sync/StoreWithStatus'
+import { TAB_ID } from './utils/sync/persistence-constants'
 
 /** @public */
-export interface TldrawEditorProps {
+export type TldrawEditorProps = {
 	children?: any
-	/** A configuration defining major customizations to the app, such as custom shapes and new tools */
-	config: TldrawEditorConfig
-	/** Overrides for the tldraw components */
+	/**
+	 * An array of shape utils to use in the editor.
+	 */
+	shapes?: Record<string, ShapeInfo>
+	/**
+	 * An array of tools to use in the editor.
+	 */
+	tools?: StateNodeConstructor[]
+	/**
+	 * Urls for where to find fonts and other assets.
+	 */
+	assetUrls?: EditorAssetUrls
+	/**
+	 * Whether to automatically focus the editor when it mounts.
+	 */
+	autoFocus?: boolean
+	/**
+	 * Overrides for the tldraw user interface components.
+	 */
 	components?: Partial<TLEditorComponents>
-	/** Whether to display the dark mode. */
-	isDarkMode?: boolean
 	/**
-	 * Called when the app has mounted.
+	 * Called when the editor has mounted.
 	 *
 	 * @example
 	 *
@@ -49,7 +64,7 @@ export interface TldrawEditorProps {
 	 */
 	onMount?: (app: App) => void
 	/**
-	 * Called when the app generates a new asset from a file, such as when an image is dropped into
+	 * Called when the editor generates a new asset from a file, such as when an image is dropped into
 	 * the canvas.
 	 *
 	 * @example
@@ -81,22 +96,31 @@ export interface TldrawEditorProps {
 	onCreateBookmarkFromUrl?: (
 		url: string
 	) => Promise<{ image: string; title: string; description: string }>
-
-	/**
-	 * The Store instance to use for keeping the app's data. This may be prepopulated, e.g. by loading
-	 * from a server or database.
-	 */
-	store?: TLStore | SyncedStore
-	/**
-	 * The id of the app instance (e.g. a browser tab if the app will have only one tldraw app per
-	 * tab). If not given, one will be generated.
-	 */
-	instanceId?: TLInstanceId
-	/** Asset URLs */
-	assetUrls?: EditorAssetUrls
-	/** Whether to automatically focus the editor when it mounts. */
-	autoFocus?: boolean
-}
+} & (
+	| {
+			/**
+			 * The Store instance to use for keeping the editor's data. This may be prepopulated, e.g. by loading
+			 * from a server or database.
+			 */
+			store: TLStore | StoreWithStatus
+	  }
+	| {
+			store?: undefined
+			/**
+			 * The editor's initial data.
+			 */
+			initialData?: StoreSnapshot<TLRecord>
+			/**
+			 * The id of the editor instance (e.g. a browser tab if the editor will have only one tldraw app per
+			 * tab). If not given, one will be generated.
+			 */
+			instanceId?: TLInstanceId
+			/**
+			 * The id under which to sync and persist the editor's data.
+			 */
+			persistenceKey?: string
+	  }
+)
 
 declare global {
 	interface Window {
@@ -105,12 +129,15 @@ declare global {
 }
 
 /** @public */
-export function TldrawEditor(props: TldrawEditorProps) {
+export const TldrawEditor = memo(function TldrawEditor(props: TldrawEditorProps) {
 	const [container, setContainer] = React.useState<HTMLDivElement | null>(null)
-	const { components, ...rest } = props
 
 	const ErrorFallback =
-		components?.ErrorFallback === undefined ? DefaultErrorFallback : components?.ErrorFallback
+		props.components?.ErrorFallback === undefined
+			? DefaultErrorFallback
+			: props.components?.ErrorFallback
+
+	const { store, ...rest } = props
 
 	return (
 		<div ref={setContainer} draggable={false} className="tl-container tl-theme__light" tabIndex={0}>
@@ -120,51 +147,68 @@ export function TldrawEditor(props: TldrawEditorProps) {
 			>
 				{container && (
 					<ContainerProvider container={container}>
-						<EditorComponentsProvider overrides={components}>
-							<TldrawEditorBeforeLoading {...rest} />
+						<EditorComponentsProvider overrides={props.components}>
+							{store ? (
+								store instanceof Store ? (
+									// Store is ready to go, whether externally synced or not
+									<TldrawEditorWithReadyStore {...rest} store={store} />
+								) : (
+									// Store is a synced store, so handle syncing stages internally
+									<TldrawEditorWithLoadingStore {...rest} store={store} />
+								)
+							) : (
+								// We have no store (it's undefined) so create one and possibly sync it
+								<TldrawEditorWithOwnStore {...rest} store={store} />
+							)}
 						</EditorComponentsProvider>
 					</ContainerProvider>
 				)}
 			</OptionalErrorBoundary>
 		</div>
 	)
+})
+
+function TldrawEditorWithOwnStore(props: TldrawEditorProps & { store: undefined }) {
+	const { initialData, instanceId = TAB_ID, shapes, persistenceKey } = props
+
+	const syncedStore = useLocalStore({
+		customShapes: shapes,
+		instanceId,
+		initialData,
+		persistenceKey,
+	})
+
+	return <TldrawEditorWithLoadingStore {...props} store={syncedStore} />
 }
 
-function TldrawEditorBeforeLoading({ config, instanceId, store, ...props }: TldrawEditorProps) {
+const TldrawEditorWithLoadingStore = memo(function TldrawEditorBeforeLoading({
+	store,
+	assetUrls,
+	...rest
+}: TldrawEditorProps & { store: StoreWithStatus }) {
 	const { done: preloadingComplete, error: preloadingError } = usePreloadAssets(
-		props.assetUrls ?? defaultEditorAssetUrls
+		assetUrls ?? defaultEditorAssetUrls
 	)
 
-	const _store = useMemo<TLStore | SyncedStore>(() => {
-		return (
-			store ??
-			config.createStore({
-				instanceId: instanceId ?? InstanceRecordType.createId(),
-			})
-		)
-	}, [store, config, instanceId])
-
-	let loadedStore: TLStore | SyncedStore
-	if (!(_store instanceof Store)) {
-		if (_store.error) {
+	switch (store.status) {
+		case 'error': {
 			// for error handling, we fall back to the default error boundary.
 			// if users want to handle this error differently, they can render
 			// their own error screen before the TldrawEditor component
-			throw _store.error
+			throw store.error
 		}
-		if (!_store.store) {
+		case 'loading': {
 			return <LoadingScreen>Connecting...</LoadingScreen>
 		}
-
-		loadedStore = _store.store
-	} else {
-		loadedStore = _store
-	}
-
-	if (instanceId && loadedStore.props.instanceId !== instanceId) {
-		console.error(
-			`The store's instanceId (${loadedStore.props.instanceId}) does not match the instanceId prop (${instanceId}). This may cause unexpected behavior.`
-		)
+		case 'not-synced': {
+			break
+		}
+		case 'synced-local': {
+			break
+		}
+		case 'synced-remote': {
+			break
+		}
 	}
 
 	if (preloadingError) {
@@ -175,57 +219,56 @@ function TldrawEditorBeforeLoading({ config, instanceId, store, ...props }: Tldr
 		return <LoadingScreen>Loading assets...</LoadingScreen>
 	}
 
-	return <TldrawEditorAfterLoading {...props} store={loadedStore} config={config} />
-}
+	return <TldrawEditorWithReadyStore {...rest} store={store.store} />
+})
 
-function TldrawEditorAfterLoading({
+function TldrawEditorWithReadyStore({
 	onMount,
-	config,
 	children,
 	onCreateAssetFromFile,
 	onCreateBookmarkFromUrl,
 	store,
+	tools,
+	shapes,
 	autoFocus,
-}: Omit<TldrawEditorProps, 'store' | 'config' | 'instanceId' | 'userId'> & {
-	config: TldrawEditorConfig
+}: TldrawEditorProps & {
 	store: TLStore
 }) {
-	const container = useContainer()
-
-	const [app, setApp] = React.useState<App | null>(null)
 	const { ErrorFallback } = useEditorComponents()
+	const container = useContainer()
+	const [app, setApp] = useState<App | null>(null)
 
-	React.useLayoutEffect(() => {
+	useLayoutEffect(() => {
 		const app = new App({
 			store,
-			config,
+			shapes,
+			tools,
 			getContainer: () => container,
 		})
-		setApp(app)
-
-		if (autoFocus) {
-			app.focus()
-		}
 		;(window as any).app = app
+		setApp(app)
 		return () => {
 			app.dispose()
-			setApp((prevApp) => (prevApp === app ? null : prevApp))
 		}
-	}, [container, config, store, autoFocus])
+	}, [container, shapes, tools, store])
 
 	React.useEffect(() => {
-		if (app) {
-			// Overwrite the default onCreateAssetFromFile handler.
-			if (onCreateAssetFromFile) {
-				app.onCreateAssetFromFile = onCreateAssetFromFile
-			}
-
-			if (onCreateBookmarkFromUrl) {
-				app.onCreateBookmarkFromUrl = onCreateBookmarkFromUrl
-			}
+		if (!app) return
+
+		// Overwrite the default onCreateAssetFromFile handler.
+		if (onCreateAssetFromFile) {
+			app.onCreateAssetFromFile = onCreateAssetFromFile
+		}
+
+		if (onCreateBookmarkFromUrl) {
+			app.onCreateBookmarkFromUrl = onCreateBookmarkFromUrl
 		}
 	}, [app, onCreateAssetFromFile, onCreateBookmarkFromUrl])
 
+	React.useLayoutEffect(() => {
+		if (app && autoFocus) app.focus()
+	}, [app, autoFocus])
+
 	const onMountEvent = useEvent((app: App) => {
 		onMount?.(app)
 		app.emit('mount')
@@ -233,10 +276,7 @@ function TldrawEditorAfterLoading({
 	})
 
 	React.useEffect(() => {
-		if (app) {
-			// Run onMount
-			onMountEvent(app)
-		}
+		if (app) onMountEvent(app)
 	}, [app, onMountEvent])
 
 	const crashingError = useSyncExternalStore(

commit 3bc72cb822d3a081df3e0d7c1df5bd83750c9d26
Author: Lu Wilson <l2wilson94@gmail.com>
Date:   Thu Jun 1 19:46:26 2023 +0100

    Add support for project names (#1340)
    
    This PR adds some things that we need for the Project Name feature on
    tldraw.com.
    It should be reviewed alongside
    https://github.com/tldraw/tldraw-lite/pull/1814
    
    
    ## Name Property
    This PR adds a `name` property to `TLDocument`. We use this to store a
    project's name.
    
    <img width="454" alt="Screenshot 2023-05-09 at 15 47 26"
    src="https://github.com/tldraw/tldraw/assets/15892272/f3be438e-aa0f-4dec-8f51-8dfd9f9d0ced">
    
    ## Top Zone
    This PR adds a `topZone` area of the UI that we can add stuff to,
    similar to how `shareZone` works.
    It also adds an example to show where the `topZone` and `shareZone` are:
    
    <img width="1511" alt="Screenshot 2023-05-12 at 10 57 40"
    src="https://github.com/tldraw/tldraw/assets/15892272/f5e1cd33-017e-4aaf-bfee-4d85119e2974">
    
    ## Breakpoints
    This PR change's the UI's breakpoints a little bit.
    It moves the action bar to the bottom a little bit earlier.
    (This gives us more space at the top for the project name).
    
    ![2023-05-12 at 11 08 26 - Fuchsia
    Bison](https://github.com/tldraw/tldraw/assets/15892272/34563cea-b1d1-47be-ac5e-5650ee0ba02d)
    
    ![2023-05-12 at 13 45 04 - Tan
    Mole](https://github.com/tldraw/tldraw/assets/15892272/ab190bd3-51d4-4a8b-88de-c72ab14bcba6)
    
    ## Input Blur
    This PR adds an `onBlur` parameter to `Input`.
    This was needed because 'clicking off' the input wasn't firing
    `onComplete` or `onCancel`.
    
    <img width="620" alt="Screenshot 2023-05-09 at 16 12 58"
    src="https://github.com/tldraw/tldraw/assets/15892272/3b28da74-0a74-4063-8053-e59e47027caf">
    
    ## Create Project Name
    This PR adds an internal `createProjectName` property to
    `TldrawEditorConfig`.
    Similar to `derivePresenceState`, you can pass a custom function to it.
    It lets you control what gets used as the default project name. We use
    it to set different names in our local projects compared to shared
    projects.
    
    In the future, when we add more advanced project features, we could
    handle this better within the UI.
    
    <img width="454" alt="Screenshot 2023-05-09 at 15 47 26"
    src="https://github.com/tldraw/tldraw/assets/15892272/da9a4699-ac32-40d9-a97c-6c682acfac41">
    
    ### Test Plan
    
    1. Gradually reduce the width of the browser window.
    2. Check that the actions menu jumps to the bottom before the style
    panel moves to the bottom.
    
    ---
    
    1. In the examples app, open the `/zones` example.
    2. Check that there's a 'top zone' at the top.
    
    - [ ] Unit Tests
    - [ ] Webdriver tests
    
    ### Release Note
    
    - [dev] Added a `topZone` area where you can put stuff.
    - [dev] Added a `name` property to `TLDocument` - and `app` methods for
    it.
    - [dev] Added an internal `createProjectName` config property for
    controlling the default project name.
    - [dev] Added an `onBlur` parameter to `Input`.
    - Moved the actions bar to the bottom on medium-sized screens.
    
    ---------
    
    Co-authored-by: Steve Ruiz <steveruizok@gmail.com>

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index 2f83c7b65..e16dbe364 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -119,6 +119,10 @@ export type TldrawEditorProps = {
 			 * The id under which to sync and persist the editor's data.
 			 */
 			persistenceKey?: string
+			/**
+			 * The initial document name to use for the new store.
+			 */
+			defaultName?: string
 	  }
 )
 
@@ -169,13 +173,14 @@ export const TldrawEditor = memo(function TldrawEditor(props: TldrawEditorProps)
 })
 
 function TldrawEditorWithOwnStore(props: TldrawEditorProps & { store: undefined }) {
-	const { initialData, instanceId = TAB_ID, shapes, persistenceKey } = props
+	const { defaultName, initialData, instanceId = TAB_ID, shapes, persistenceKey } = props
 
 	const syncedStore = useLocalStore({
 		customShapes: shapes,
 		instanceId,
 		initialData,
 		persistenceKey,
+		defaultName,
 	})
 
 	return <TldrawEditorWithLoadingStore {...props} store={syncedStore} />

commit 735f1c41b79a3fcce14446b6384ec796f0298a31
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Fri Jun 2 16:21:45 2023 +0100

    rename app to editor (#1503)
    
    This PR renames `App`, `app` and all appy names to `Editor`, `editor`,
    and editorry names.
    
    ### Change Type
    
    - [x] `major` — Breaking Change
    
    ### Release Notes
    
    - Rename `App` to `Editor` and many other things that reference `app` to
    `editor`.

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index e16dbe364..59612fd3a 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -2,16 +2,16 @@ import { TLAsset, TLInstanceId, TLRecord, TLStore } from '@tldraw/tlschema'
 import { Store, StoreSnapshot } from '@tldraw/tlstore'
 import { annotateError } from '@tldraw/utils'
 import React, { memo, useCallback, useLayoutEffect, useState, useSyncExternalStore } from 'react'
-import { App } from './app/App'
+import { Editor } from './app/Editor'
 import { StateNodeConstructor } from './app/statechart/StateNode'
 import { EditorAssetUrls, defaultEditorAssetUrls } from './assetUrls'
 import { DefaultErrorFallback } from './components/DefaultErrorFallback'
 import { OptionalErrorBoundary } from './components/ErrorBoundary'
 import { ShapeInfo } from './config/createTLStore'
-import { AppContext } from './hooks/useApp'
 import { ContainerProvider, useContainer } from './hooks/useContainer'
 import { useCursor } from './hooks/useCursor'
 import { useDarkMode } from './hooks/useDarkMode'
+import { EditorContext } from './hooks/useEditor'
 import {
 	EditorComponentsProvider,
 	TLEditorComponents,
@@ -56,13 +56,13 @@ export type TldrawEditorProps = {
 	 *
 	 * ```ts
 	 * function TldrawEditor() {
-	 * 	return <Editor onMount={(app) => app.selectAll()} />
+	 * 	return <Editor onMount={(editor) => editor.selectAll()} />
 	 * }
 	 * ```
 	 *
-	 * @param app - The app instance.
+	 * @param editor - The editor instance.
 	 */
-	onMount?: (app: App) => void
+	onMount?: (editor: Editor) => void
 	/**
 	 * Called when the editor generates a new asset from a file, such as when an image is dropped into
 	 * the canvas.
@@ -70,7 +70,7 @@ export type TldrawEditorProps = {
 	 * @example
 	 *
 	 * ```ts
-	 * const app = new App({
+	 * const editor = new App({
 	 * 	onCreateAssetFromFile: (file) => uploadFileAndCreateAsset(file),
 	 * })
 	 * ```
@@ -87,7 +87,7 @@ export type TldrawEditorProps = {
 	 * @example
 	 *
 	 * ```ts
-	 * app.onCreateBookmarkFromUrl(url, id)
+	 * editor.onCreateBookmarkFromUrl(url, id)
 	 * ```
 	 *
 	 * @param url - The url that was created.
@@ -241,66 +241,67 @@ function TldrawEditorWithReadyStore({
 }) {
 	const { ErrorFallback } = useEditorComponents()
 	const container = useContainer()
-	const [app, setApp] = useState<App | null>(null)
+	const [editor, setEditor] = useState<Editor | null>(null)
 
 	useLayoutEffect(() => {
-		const app = new App({
+		const editor = new Editor({
 			store,
 			shapes,
 			tools,
 			getContainer: () => container,
 		})
-		;(window as any).app = app
-		setApp(app)
+		;(window as any).app = editor
+		;(window as any).editor = editor
+		setEditor(editor)
 		return () => {
-			app.dispose()
+			editor.dispose()
 		}
 	}, [container, shapes, tools, store])
 
 	React.useEffect(() => {
-		if (!app) return
+		if (!editor) return
 
 		// Overwrite the default onCreateAssetFromFile handler.
 		if (onCreateAssetFromFile) {
-			app.onCreateAssetFromFile = onCreateAssetFromFile
+			editor.onCreateAssetFromFile = onCreateAssetFromFile
 		}
 
 		if (onCreateBookmarkFromUrl) {
-			app.onCreateBookmarkFromUrl = onCreateBookmarkFromUrl
+			editor.onCreateBookmarkFromUrl = onCreateBookmarkFromUrl
 		}
-	}, [app, onCreateAssetFromFile, onCreateBookmarkFromUrl])
+	}, [editor, onCreateAssetFromFile, onCreateBookmarkFromUrl])
 
 	React.useLayoutEffect(() => {
-		if (app && autoFocus) app.focus()
-	}, [app, autoFocus])
+		if (editor && autoFocus) editor.focus()
+	}, [editor, autoFocus])
 
-	const onMountEvent = useEvent((app: App) => {
-		onMount?.(app)
-		app.emit('mount')
+	const onMountEvent = useEvent((editor: Editor) => {
+		onMount?.(editor)
+		editor.emit('mount')
 		window.tldrawReady = true
 	})
 
 	React.useEffect(() => {
-		if (app) onMountEvent(app)
-	}, [app, onMountEvent])
+		if (editor) onMountEvent(editor)
+	}, [editor, onMountEvent])
 
 	const crashingError = useSyncExternalStore(
 		useCallback(
 			(onStoreChange) => {
-				if (app) {
-					app.on('crash', onStoreChange)
-					return () => app.off('crash', onStoreChange)
+				if (editor) {
+					editor.on('crash', onStoreChange)
+					return () => editor.off('crash', onStoreChange)
 				}
 				return () => {
 					// noop
 				}
 			},
-			[app]
+			[editor]
 		),
-		() => app?.crashingError ?? null
+		() => editor?.crashingError ?? null
 	)
 
-	if (!app) {
+	if (!editor) {
 		return null
 	}
 
@@ -312,15 +313,17 @@ function TldrawEditorWithReadyStore({
 		// document in the event of an error to reassure them that their work is
 		// not lost.
 		<OptionalErrorBoundary
-			fallback={ErrorFallback ? (error) => <ErrorFallback error={error} app={app} /> : null}
-			onError={(error) => app.annotateError(error, { origin: 'react.tldraw', willCrashApp: true })}
+			fallback={ErrorFallback ? (error) => <ErrorFallback error={error} editor={editor} /> : null}
+			onError={(error) =>
+				editor.annotateError(error, { origin: 'react.tldraw', willCrashApp: true })
+			}
 		>
 			{crashingError ? (
 				<Crash crashingError={crashingError} />
 			) : (
-				<AppContext.Provider value={app}>
+				<EditorContext.Provider value={editor}>
 					<Layout>{children}</Layout>
-				</AppContext.Provider>
+				</EditorContext.Provider>
 			)}
 		</OptionalErrorBoundary>
 	)

commit c1b84bf2468caeb0c6e502f621b19dffe3aa8aba
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Sat Jun 3 09:59:04 2023 +0100

    Rename tlstore to store (#1507)
    
    This PR renames the `@tldraw/tlstore` package to `@tldraw/store`, mainly
    to avoid confusion between `TLStore`. Will be doing the same with other
    packages.
    
    ### Change Type
    
    - [x] `major` — Breaking Change
    
    ### Release Notes
    
    - Replace @tldraw/tlstore with @tldraw/store

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index 59612fd3a..d45a995c6 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -1,5 +1,5 @@
+import { Store, StoreSnapshot } from '@tldraw/store'
 import { TLAsset, TLInstanceId, TLRecord, TLStore } from '@tldraw/tlschema'
-import { Store, StoreSnapshot } from '@tldraw/tlstore'
 import { annotateError } from '@tldraw/utils'
 import React, { memo, useCallback, useLayoutEffect, useState, useSyncExternalStore } from 'react'
 import { Editor } from './app/Editor'

commit 0f893096046acfbbc6870a90796b5574b9ddf91b
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Sun Jun 4 11:38:53 2023 +0100

    Renaming types, shape utils, tools (#1513)
    
    This PR renames all exported types to include the `TL` prefix. It also
    removes the `TL` prefix from things that are not types, including:
    - shape utils (e.g. `TLArrowUtil` becomes `ArrowShapeUtil`)
    - tools (e.g. `TLArrowTool` becomes `ArrowShapeTool`, `TLSelectTool`
    becomes `SelectTool`)
    
    ### Change Type
    
    - [x] `major` — Breaking Change
    
    ### Release Notes
    
    - Renaming of types, shape utils, tools

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index d45a995c6..16a0fd5d9 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -3,11 +3,11 @@ import { TLAsset, TLInstanceId, TLRecord, TLStore } from '@tldraw/tlschema'
 import { annotateError } from '@tldraw/utils'
 import React, { memo, useCallback, useLayoutEffect, useState, useSyncExternalStore } from 'react'
 import { Editor } from './app/Editor'
-import { StateNodeConstructor } from './app/statechart/StateNode'
-import { EditorAssetUrls, defaultEditorAssetUrls } from './assetUrls'
+import { TLStateNodeConstructor } from './app/tools/StateNode'
+import { TLEditorAssetUrls, defaultEditorAssetUrls } from './assetUrls'
 import { DefaultErrorFallback } from './components/DefaultErrorFallback'
 import { OptionalErrorBoundary } from './components/ErrorBoundary'
-import { ShapeInfo } from './config/createTLStore'
+import { TLShapeInfo } from './config/createTLStore'
 import { ContainerProvider, useContainer } from './hooks/useContainer'
 import { useCursor } from './hooks/useCursor'
 import { useDarkMode } from './hooks/useDarkMode'
@@ -23,7 +23,7 @@ import { useLocalStore } from './hooks/useLocalStore'
 import { usePreloadAssets } from './hooks/usePreloadAssets'
 import { useSafariFocusOutFix } from './hooks/useSafariFocusOutFix'
 import { useZoomCss } from './hooks/useZoomCss'
-import { StoreWithStatus } from './utils/sync/StoreWithStatus'
+import { TLStoreWithStatus } from './utils/sync/StoreWithStatus'
 import { TAB_ID } from './utils/sync/persistence-constants'
 
 /** @public */
@@ -32,15 +32,15 @@ export type TldrawEditorProps = {
 	/**
 	 * An array of shape utils to use in the editor.
 	 */
-	shapes?: Record<string, ShapeInfo>
+	shapes?: Record<string, TLShapeInfo>
 	/**
 	 * An array of tools to use in the editor.
 	 */
-	tools?: StateNodeConstructor[]
+	tools?: TLStateNodeConstructor[]
 	/**
 	 * Urls for where to find fonts and other assets.
 	 */
-	assetUrls?: EditorAssetUrls
+	assetUrls?: TLEditorAssetUrls
 	/**
 	 * Whether to automatically focus the editor when it mounts.
 	 */
@@ -102,7 +102,7 @@ export type TldrawEditorProps = {
 			 * The Store instance to use for keeping the editor's data. This may be prepopulated, e.g. by loading
 			 * from a server or database.
 			 */
-			store: TLStore | StoreWithStatus
+			store: TLStore | TLStoreWithStatus
 	  }
 	| {
 			store?: undefined
@@ -190,7 +190,7 @@ const TldrawEditorWithLoadingStore = memo(function TldrawEditorBeforeLoading({
 	store,
 	assetUrls,
 	...rest
-}: TldrawEditorProps & { store: StoreWithStatus }) {
+}: TldrawEditorProps & { store: TLStoreWithStatus }) {
 	const { done: preloadingComplete, error: preloadingError } = usePreloadAssets(
 		assetUrls ?? defaultEditorAssetUrls
 	)

commit f15a8797f04132dc21949f731894b0e2d97a3e14
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Mon Jun 5 15:11:07 2023 +0100

    Independent instance state persistence (#1493)
    
    This PR
    
    - Removes UserDocumentRecordType
      - moving isSnapMode to user preferences
      - moving isGridMode and isPenMode to InstanceRecordType
      - deleting the other properties which are no longer needed.
    
    - Creates a separate pipeline for persisting instance state.
    
    Previously the instance state records were stored alongside the document
    state records, and in order to load the state for a particular instance
    (in our case, a particular tab) you needed to pass the 'instanceId'
    prop. This prop ended up totally pervading the public API and people ran
    into all kinds of issues with it, e.g. using the same instance id in
    multiple editor instances.
    
    There was also an issue whereby it was hard for us to clean up old
    instance state so the idb table ended up bloating over time.
    
    This PR makes it so that rather than passing an instanceId, you load the
    instance state yourself while creating the store. It provides tools to
    make that easy.
    
    - Undoes the assumption that we might have more than one instance's
    state in the store.
    
    - Like `document`, `instance` now has a singleton id
    `instance:instance`.
    - Page state ids and camera ids are no longer random, but rather derive
    from the page they belong to. This is like having a foreign primary key
    in SQL databases. It's something i'd love to support fully as part of
    the RecordType/Store api.
    
    Tests to do
    
    - [x] Test Migrations
    - [x] Test Store.listen filtering
    - [x] Make type sets in Store public and readonly
    - [x] Test RecordType.createId
    - [x] Test Instance state snapshot loading/exporting
    - [x] Manual test File I/O
    - [x] Manual test Vscode extension with multiple tabs
    - [x] Audit usages of store.query
    - [x] Audit usages of changed types: InstanceRecordType, 'instance',
    InstancePageStateRecordType, 'instance_page_state', 'user_document',
    'camera', CameraRecordType, InstancePresenceRecordType,
    'instance_presence'
    - [x] Test user preferences
    - [x] Manual test isSnapMode and isGridMode and isPenMode
    - [ ] Test indexedDb functions
    - [x] Add instanceId stuff back
    
    
    ### Change Type
    
    - [x] `major` — Breaking Change
    
    
    ### Test Plan
    
    1. Add a step-by-step description of how to test your PR here.
    2.
    
    - [ ] Unit Tests
    - [ ] Webdriver tests
    
    ### Release Notes
    
    - Add a brief release note for your PR here.

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index 16a0fd5d9..50cdfae1e 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -1,5 +1,5 @@
 import { Store, StoreSnapshot } from '@tldraw/store'
-import { TLAsset, TLInstanceId, TLRecord, TLStore } from '@tldraw/tlschema'
+import { TLAsset, TLRecord, TLStore } from '@tldraw/tlschema'
 import { annotateError } from '@tldraw/utils'
 import React, { memo, useCallback, useLayoutEffect, useState, useSyncExternalStore } from 'react'
 import { Editor } from './app/Editor'
@@ -24,7 +24,6 @@ import { usePreloadAssets } from './hooks/usePreloadAssets'
 import { useSafariFocusOutFix } from './hooks/useSafariFocusOutFix'
 import { useZoomCss } from './hooks/useZoomCss'
 import { TLStoreWithStatus } from './utils/sync/StoreWithStatus'
-import { TAB_ID } from './utils/sync/persistence-constants'
 
 /** @public */
 export type TldrawEditorProps = {
@@ -111,16 +110,22 @@ export type TldrawEditorProps = {
 			 */
 			initialData?: StoreSnapshot<TLRecord>
 			/**
-			 * The id of the editor instance (e.g. a browser tab if the editor will have only one tldraw app per
-			 * tab). If not given, one will be generated.
+			 * The id under which to sync and persist the editor's data. If none is given tldraw will not sync or persist
+			 * the editor's data.
 			 */
-			instanceId?: TLInstanceId
+			persistenceKey?: string
 			/**
-			 * The id under which to sync and persist the editor's data.
+			 * When tldraw reloads a document from local persistence, it will try to bring back the
+			 * editor UI state (e.g. camera position, which shapes are selected). It does this using a sessionId,
+			 * which by default is unique per browser tab. If you wish to have more fine-grained
+			 * control over this behavior, you can provide your own sessionId.
+			 *
+			 * If it can't find saved UI state for the given sessionId, it will use the most recently saved
+			 * UI state for the given persistenceKey if available.
 			 */
-			persistenceKey?: string
+			sessionId?: string
 			/**
-			 * The initial document name to use for the new store.
+			 * The default initial document name. e.g. 'Untitled Document'
 			 */
 			defaultName?: string
 	  }
@@ -173,13 +178,13 @@ export const TldrawEditor = memo(function TldrawEditor(props: TldrawEditorProps)
 })
 
 function TldrawEditorWithOwnStore(props: TldrawEditorProps & { store: undefined }) {
-	const { defaultName, initialData, instanceId = TAB_ID, shapes, persistenceKey } = props
+	const { defaultName, initialData, shapes, persistenceKey, sessionId } = props
 
 	const syncedStore = useLocalStore({
 		customShapes: shapes,
-		instanceId,
 		initialData,
 		persistenceKey,
+		sessionId,
 		defaultName,
 	})
 

commit 355ed1de72de231232ce61612270f5fc7915690b
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Tue Jun 6 17:01:54 2023 +0100

    rename app folder to editor (#1528)
    
    Turns out there was one last terrible renaming PR to make. This PR
    renames the `@tldraw.editor`'s `app` folder to `editor`. It should not
    effect exports but it will be a gnarly diff.
    
    ### Change Type
    
    - [x] `internal` — Any other changes that don't affect the published
    package (will not publish a new version)

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index 50cdfae1e..0df29b534 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -2,12 +2,12 @@ import { Store, StoreSnapshot } from '@tldraw/store'
 import { TLAsset, TLRecord, TLStore } from '@tldraw/tlschema'
 import { annotateError } from '@tldraw/utils'
 import React, { memo, useCallback, useLayoutEffect, useState, useSyncExternalStore } from 'react'
-import { Editor } from './app/Editor'
-import { TLStateNodeConstructor } from './app/tools/StateNode'
 import { TLEditorAssetUrls, defaultEditorAssetUrls } from './assetUrls'
 import { DefaultErrorFallback } from './components/DefaultErrorFallback'
 import { OptionalErrorBoundary } from './components/ErrorBoundary'
 import { TLShapeInfo } from './config/createTLStore'
+import { Editor } from './editor/Editor'
+import { TLStateNodeConstructor } from './editor/tools/StateNode'
 import { ContainerProvider, useContainer } from './hooks/useContainer'
 import { useCursor } from './hooks/useCursor'
 import { useDarkMode } from './hooks/useDarkMode'

commit 0cc91eec62cc879f1c164d5fc04252a9dfefa91c
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Thu Jun 8 15:53:11 2023 +0100

    `ExternalContentManager` for handling external content (files, images, etc) (#1550)
    
    This PR improves the editor's APIs around creating assets and files.
    This allows end user developers to replace behavior that might occur,
    for example, when pasting images or dragging files onto the canvas.
    
    Here, we:
    - remove `onCreateAssetFromFile` prop
    - remove `onCreateBookmarkFromUrl` prop
    - introduce `onEditorReady` prop
    - introduce `onEditorWillDispose` prop
    - introduce `ExternalContentManager`
    
    The `ExternalContentManager` (ECM) is used in circumstances where we're
    turning external content (text, images, urls, etc) into assets or
    shapes. It is designed to allow certain methods to be overwritten by
    other developers as a kind of weakly supported hack.
    
    For example, when a user drags an image onto the canvas, the event
    handler passes a `TLExternalContent` object to the editor's
    `putExternalContent` method. This method runs the ECM's handler for this
    content type. That handler may in turn run other methods, such as
    `createAssetFromFile` or `createShapesForAssets`, which will lead to the
    image being created on the canvas.
    
    If a developer wanted to change the way that assets are created from
    files, then they could overwrite that method at runtime.
    
    ```ts
    const handleEditorReady = (editor: Editor) => {
      editor.externalContentManager.createAssetFromFile = myHandler
    }
    
    function Example() {
      return <Tldraw onEditorReady={handleEditorReady}/>
    }
    ```
    
    If you wanted to go even deeper, you could override the editor's
    `putExternalContent` method.
    
    ```ts
    const handleEditorReady = (editor: Editor) => {
    const handleExternalContent = (info: TLExternalContent): Promise<void> => {
            if (info.type === 'files') {
               // do something here
            } else {
              // do the normal thing
              editor.externalContentManager.handleContent(info)
            }
    }
    ```
    
    ### Change Type
    
    - [x] `major`
    
    ### Test Plan
    
    1. Drag images, urls, etc. onto the canvas
    2. Use copy and paste for single and multiple files
    3. Use bookmark / embed shapes and convert between eachother
    
    ### Release Notes
    
    - [editor] add `ExternalContentManager` for plopping content onto the
    canvas
    - [editor] remove `onCreateAssetFromFile` prop
    - [editor] remove `onCreateBookmarkFromUrl` prop
    - [editor] introduce `onEditorReady` prop
    - [editor] introduce `onEditorWillDispose` prop
    - [editor] introduce `ExternalContentManager`

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index 0df29b534..bba8fbd70 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -1,5 +1,5 @@
 import { Store, StoreSnapshot } from '@tldraw/store'
-import { TLAsset, TLRecord, TLStore } from '@tldraw/tlschema'
+import { TLRecord, TLStore } from '@tldraw/tlschema'
 import { annotateError } from '@tldraw/utils'
 import React, { memo, useCallback, useLayoutEffect, useState, useSyncExternalStore } from 'react'
 import { TLEditorAssetUrls, defaultEditorAssetUrls } from './assetUrls'
@@ -48,6 +48,7 @@ export type TldrawEditorProps = {
 	 * Overrides for the tldraw user interface components.
 	 */
 	components?: Partial<TLEditorComponents>
+
 	/**
 	 * Called when the editor has mounted.
 	 *
@@ -61,40 +62,7 @@ export type TldrawEditorProps = {
 	 *
 	 * @param editor - The editor instance.
 	 */
-	onMount?: (editor: Editor) => void
-	/**
-	 * Called when the editor generates a new asset from a file, such as when an image is dropped into
-	 * the canvas.
-	 *
-	 * @example
-	 *
-	 * ```ts
-	 * const editor = new App({
-	 * 	onCreateAssetFromFile: (file) => uploadFileAndCreateAsset(file),
-	 * })
-	 * ```
-	 *
-	 * @param file - The file to generate an asset from.
-	 * @param id - The id to be assigned to the resulting asset.
-	 */
-	onCreateAssetFromFile?: (file: File) => Promise<TLAsset>
-
-	/**
-	 * Called when a URL is converted to a bookmark. This callback should return the metadata for the
-	 * bookmark.
-	 *
-	 * @example
-	 *
-	 * ```ts
-	 * editor.onCreateBookmarkFromUrl(url, id)
-	 * ```
-	 *
-	 * @param url - The url that was created.
-	 * @public
-	 */
-	onCreateBookmarkFromUrl?: (
-		url: string
-	) => Promise<{ image: string; title: string; description: string }>
+	onMount?: (editor: Editor) => (() => void) | undefined | void
 } & (
 	| {
 			/**
@@ -235,8 +203,6 @@ const TldrawEditorWithLoadingStore = memo(function TldrawEditorBeforeLoading({
 function TldrawEditorWithReadyStore({
 	onMount,
 	children,
-	onCreateAssetFromFile,
-	onCreateBookmarkFromUrl,
 	store,
 	tools,
 	shapes,
@@ -258,36 +224,25 @@ function TldrawEditorWithReadyStore({
 		;(window as any).app = editor
 		;(window as any).editor = editor
 		setEditor(editor)
+
 		return () => {
 			editor.dispose()
 		}
 	}, [container, shapes, tools, store])
 
-	React.useEffect(() => {
-		if (!editor) return
-
-		// Overwrite the default onCreateAssetFromFile handler.
-		if (onCreateAssetFromFile) {
-			editor.onCreateAssetFromFile = onCreateAssetFromFile
-		}
-
-		if (onCreateBookmarkFromUrl) {
-			editor.onCreateBookmarkFromUrl = onCreateBookmarkFromUrl
-		}
-	}, [editor, onCreateAssetFromFile, onCreateBookmarkFromUrl])
-
 	React.useLayoutEffect(() => {
 		if (editor && autoFocus) editor.focus()
 	}, [editor, autoFocus])
 
 	const onMountEvent = useEvent((editor: Editor) => {
-		onMount?.(editor)
+		const teardown = onMount?.(editor)
 		editor.emit('mount')
 		window.tldrawReady = true
+		return teardown
 	})
 
-	React.useEffect(() => {
-		if (editor) onMountEvent(editor)
+	React.useLayoutEffect(() => {
+		if (editor) return onMountEvent?.(editor)
 	}, [editor, onMountEvent])
 
 	const crashingError = useSyncExternalStore(

commit bacb307badca45430e73fbf0ea2635b2e7a2468f
Author: Mitja Bezenšek <mitja.bezensek@gmail.com>
Date:   Fri Jun 9 13:43:01 2023 +0200

    Asset improvements (#1557)
    
    This PR does the following:
    - Add `selfHosted.js`, which is a great option for users that wish to
    self host the assets. Works well for both self hosting from the public
    folder or via a CDN.
    - Updates the docs for assets. We now have a dedicated page for assets
    where all the options are more clearly explained. I also removed the
    assets explanation from the main docs as the unpkg option should work
    out of the box and setting up the assets is no longer necessary.
    - Cleaned up the `refresh-assets` script. We now use common `types.d.ts`
    file to define our types. All the other options then reuse them.
    - Pulled out the `formatAssetUrl` into it's own file. It's now static an
    no longer generated.
    - `urls.d.ts`, `import.d.ts`, and newly added `selfhosted.d.ts` are now
    also no longer generated as we can import the types from `types.d.ts`.
    - You can now pass a subset of `assetUrls` to `<Tldraw />` and it will
    override the default option with the passed in overrides. This makes it
    easy to only customizes certain assets (only change the draw font as an
    example).
    
    ### Change Type
    
    - [x] `patch` — Bug Fix

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index bba8fbd70..3c2e0e345 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -1,8 +1,8 @@
 import { Store, StoreSnapshot } from '@tldraw/store'
 import { TLRecord, TLStore } from '@tldraw/tlschema'
-import { annotateError } from '@tldraw/utils'
+import { RecursivePartial, annotateError } from '@tldraw/utils'
 import React, { memo, useCallback, useLayoutEffect, useState, useSyncExternalStore } from 'react'
-import { TLEditorAssetUrls, defaultEditorAssetUrls } from './assetUrls'
+import { TLEditorAssetUrls, useDefaultEditorAssetsWithOverrides } from './assetUrls'
 import { DefaultErrorFallback } from './components/DefaultErrorFallback'
 import { OptionalErrorBoundary } from './components/ErrorBoundary'
 import { TLShapeInfo } from './config/createTLStore'
@@ -39,7 +39,7 @@ export type TldrawEditorProps = {
 	/**
 	 * Urls for where to find fonts and other assets.
 	 */
-	assetUrls?: TLEditorAssetUrls
+	assetUrls?: RecursivePartial<TLEditorAssetUrls>
 	/**
 	 * Whether to automatically focus the editor when it mounts.
 	 */
@@ -164,9 +164,8 @@ const TldrawEditorWithLoadingStore = memo(function TldrawEditorBeforeLoading({
 	assetUrls,
 	...rest
 }: TldrawEditorProps & { store: TLStoreWithStatus }) {
-	const { done: preloadingComplete, error: preloadingError } = usePreloadAssets(
-		assetUrls ?? defaultEditorAssetUrls
-	)
+	const assets = useDefaultEditorAssetsWithOverrides(assetUrls)
+	const { done: preloadingComplete, error: preloadingError } = usePreloadAssets(assets)
 
 	switch (store.status) {
 		case 'error': {

commit 1927f8804158ed4bc1df42eb8a08bdc6b305c379
Author: alex <alex@dytry.ch>
Date:   Mon Jun 12 15:04:14 2023 +0100

    mini `defineShape` API (#1563)
    
    Based on #1549, but with a lot of code-structure related changes backed
    out. Shape schemas are still defined in tlschemas with this diff.
    
    Couple differences between this and #1549:
    - This tightens up the relationship between store schemas and editor
    schemas a bit
    - Reduces the number of places we need to remember to include core
    shapes
    - Only `<TLdrawEditor />` sets default shapes by default. If you're
    doing something funky with lower-level APIs, you need to specify
    `defaultShapes` manually
    - Replaces `validator` with `props` for shapes
    
    ### Change Type
    
    - [x] `major` — Breaking Change
    
    ### Test Plan
    
    1. Add a step-by-step description of how to test your PR here.
    2.
    
    - [x] Unit Tests
    - [ ] Webdriver tests
    
    ### Release Notes
    
    [dev-facing, notes to come]

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index 3c2e0e345..688261232 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -1,11 +1,11 @@
 import { Store, StoreSnapshot } from '@tldraw/store'
 import { TLRecord, TLStore } from '@tldraw/tlschema'
-import { RecursivePartial, annotateError } from '@tldraw/utils'
+import { RecursivePartial, Required, annotateError } from '@tldraw/utils'
 import React, { memo, useCallback, useLayoutEffect, useState, useSyncExternalStore } from 'react'
 import { TLEditorAssetUrls, useDefaultEditorAssetsWithOverrides } from './assetUrls'
 import { DefaultErrorFallback } from './components/DefaultErrorFallback'
 import { OptionalErrorBoundary } from './components/ErrorBoundary'
-import { TLShapeInfo } from './config/createTLStore'
+import { AnyTLShapeInfo } from './config/defineShape'
 import { Editor } from './editor/Editor'
 import { TLStateNodeConstructor } from './editor/tools/StateNode'
 import { ContainerProvider, useContainer } from './hooks/useContainer'
@@ -31,11 +31,11 @@ export type TldrawEditorProps = {
 	/**
 	 * An array of shape utils to use in the editor.
 	 */
-	shapes?: Record<string, TLShapeInfo>
+	shapes?: readonly AnyTLShapeInfo[]
 	/**
 	 * An array of tools to use in the editor.
 	 */
-	tools?: TLStateNodeConstructor[]
+	tools?: readonly TLStateNodeConstructor[]
 	/**
 	 * Urls for where to find fonts and other assets.
 	 */
@@ -105,16 +105,28 @@ declare global {
 	}
 }
 
+const EMPTY_SHAPES_ARRAY = [] as const
+const EMPTY_TOOLS_ARRAY = [] as const
+
 /** @public */
-export const TldrawEditor = memo(function TldrawEditor(props: TldrawEditorProps) {
+export const TldrawEditor = memo(function TldrawEditor({
+	store,
+	components,
+	...rest
+}: TldrawEditorProps) {
 	const [container, setContainer] = React.useState<HTMLDivElement | null>(null)
 
 	const ErrorFallback =
-		props.components?.ErrorFallback === undefined
-			? DefaultErrorFallback
-			: props.components?.ErrorFallback
+		components?.ErrorFallback === undefined ? DefaultErrorFallback : components?.ErrorFallback
 
-	const { store, ...rest } = props
+	// apply defaults. if you're using the bare @tldraw/editor package, we
+	// default these to the "tldraw zero" configuration. We have different
+	// defaults applied in @tldraw/tldraw.
+	const withDefaults = {
+		...rest,
+		shapes: rest.shapes ?? EMPTY_SHAPES_ARRAY,
+		tools: rest.tools ?? EMPTY_TOOLS_ARRAY,
+	}
 
 	return (
 		<div ref={setContainer} draggable={false} className="tl-container tl-theme__light" tabIndex={0}>
@@ -124,18 +136,18 @@ export const TldrawEditor = memo(function TldrawEditor(props: TldrawEditorProps)
 			>
 				{container && (
 					<ContainerProvider container={container}>
-						<EditorComponentsProvider overrides={props.components}>
+						<EditorComponentsProvider overrides={components}>
 							{store ? (
 								store instanceof Store ? (
 									// Store is ready to go, whether externally synced or not
-									<TldrawEditorWithReadyStore {...rest} store={store} />
+									<TldrawEditorWithReadyStore {...withDefaults} store={store} />
 								) : (
 									// Store is a synced store, so handle syncing stages internally
-									<TldrawEditorWithLoadingStore {...rest} store={store} />
+									<TldrawEditorWithLoadingStore {...withDefaults} store={store} />
 								)
 							) : (
 								// We have no store (it's undefined) so create one and possibly sync it
-								<TldrawEditorWithOwnStore {...rest} store={store} />
+								<TldrawEditorWithOwnStore {...withDefaults} store={store} />
 							)}
 						</EditorComponentsProvider>
 					</ContainerProvider>
@@ -145,11 +157,13 @@ export const TldrawEditor = memo(function TldrawEditor(props: TldrawEditorProps)
 	)
 })
 
-function TldrawEditorWithOwnStore(props: TldrawEditorProps & { store: undefined }) {
+function TldrawEditorWithOwnStore(
+	props: Required<TldrawEditorProps & { store: undefined }, 'shapes' | 'tools'>
+) {
 	const { defaultName, initialData, shapes, persistenceKey, sessionId } = props
 
 	const syncedStore = useLocalStore({
-		customShapes: shapes,
+		shapes,
 		initialData,
 		persistenceKey,
 		sessionId,
@@ -163,7 +177,7 @@ const TldrawEditorWithLoadingStore = memo(function TldrawEditorBeforeLoading({
 	store,
 	assetUrls,
 	...rest
-}: TldrawEditorProps & { store: TLStoreWithStatus }) {
+}: Required<TldrawEditorProps & { store: TLStoreWithStatus }, 'shapes' | 'tools'>) {
 	const assets = useDefaultEditorAssetsWithOverrides(assetUrls)
 	const { done: preloadingComplete, error: preloadingError } = usePreloadAssets(assets)
 
@@ -206,9 +220,12 @@ function TldrawEditorWithReadyStore({
 	tools,
 	shapes,
 	autoFocus,
-}: TldrawEditorProps & {
-	store: TLStore
-}) {
+}: Required<
+	TldrawEditorProps & {
+		store: TLStore
+	},
+	'shapes' | 'tools'
+>) {
 	const { ErrorFallback } = useEditorComponents()
 	const container = useContainer()
 	const [editor, setEditor] = useState<Editor | null>(null)

commit 439a2ed3bc2661dc661deeab8bbfc8491a9ba698
Author: Mitja Bezenšek <mitja.bezensek@gmail.com>
Date:   Tue Jun 13 10:22:38 2023 +0200

    Move the loading of assets to the TldrawEditorWithReadyStore so that all code paths load the assets. (#1561)
    
    Move the preloading of assets to `TldrawEditorWithReadyStore` which
    makes it sure that all codepaths preload assets. Before that didn't
    happen for cases where we passed in an existing store - snapshots.
    
    
    ### Change Type
    
    - [x] `patch` — Bug Fix
    
    ### Release notes
    - Fix a problem where assets were not loading in some cases (snapshots).

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index 688261232..5625b98a0 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -175,12 +175,8 @@ function TldrawEditorWithOwnStore(
 
 const TldrawEditorWithLoadingStore = memo(function TldrawEditorBeforeLoading({
 	store,
-	assetUrls,
 	...rest
 }: Required<TldrawEditorProps & { store: TLStoreWithStatus }, 'shapes' | 'tools'>) {
-	const assets = useDefaultEditorAssetsWithOverrides(assetUrls)
-	const { done: preloadingComplete, error: preloadingError } = usePreloadAssets(assets)
-
 	switch (store.status) {
 		case 'error': {
 			// for error handling, we fall back to the default error boundary.
@@ -202,14 +198,6 @@ const TldrawEditorWithLoadingStore = memo(function TldrawEditorBeforeLoading({
 		}
 	}
 
-	if (preloadingError) {
-		return <ErrorScreen>Could not load assets. Please refresh the page.</ErrorScreen>
-	}
-
-	if (!preloadingComplete) {
-		return <LoadingScreen>Loading assets...</LoadingScreen>
-	}
-
 	return <TldrawEditorWithReadyStore {...rest} store={store.store} />
 })
 
@@ -220,6 +208,7 @@ function TldrawEditorWithReadyStore({
 	tools,
 	shapes,
 	autoFocus,
+	assetUrls,
 }: Required<
 	TldrawEditorProps & {
 		store: TLStore
@@ -277,6 +266,17 @@ function TldrawEditorWithReadyStore({
 		() => editor?.crashingError ?? null
 	)
 
+	const assets = useDefaultEditorAssetsWithOverrides(assetUrls)
+	const { done: preloadingComplete, error: preloadingError } = usePreloadAssets(assets)
+
+	if (preloadingError) {
+		return <ErrorScreen>Could not load assets. Please refresh the page.</ErrorScreen>
+	}
+
+	if (!preloadingComplete) {
+		return <LoadingScreen>Loading assets...</LoadingScreen>
+	}
+
 	if (!editor) {
 		return null
 	}

commit 3e2f2e0884383ff13fffea474362144d827202ff
Author: Lu Wilson <l2wilson94@gmail.com>
Date:   Wed Jun 14 07:40:10 2023 +0100

    Add tsdocs to Editor methods (#1581)
    
    This PR does a first-pass of adding tsdocs to the methods of the Editor
    class.
    It's a minimal start — just descriptions of them, and their parameters.
    It makes the Editor docs page a lot more fleshed out though, and easier
    to quickly scan.
    There's still a lot more to do!
    
    ### Change Type
    
    - [x] `documentation` — Changes to the documentation only[^2]
    
    ### Release Notes
    
    - [dev] Added initial documentation for the Editor class.
    
    ---------
    
    Co-authored-by: Steve Ruiz <steveruizok@gmail.com>

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index 5625b98a0..4a98e95a0 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -28,38 +28,24 @@ import { TLStoreWithStatus } from './utils/sync/StoreWithStatus'
 /** @public */
 export type TldrawEditorProps = {
 	children?: any
-	/**
-	 * An array of shape utils to use in the editor.
-	 */
+	/** An array of shape utils to use in the editor. */
 	shapes?: readonly AnyTLShapeInfo[]
-	/**
-	 * An array of tools to use in the editor.
-	 */
+	/** An array of tools to use in the editor. */
 	tools?: readonly TLStateNodeConstructor[]
-	/**
-	 * Urls for where to find fonts and other assets.
-	 */
+	/** Urls for where to find fonts and other assets. */
 	assetUrls?: RecursivePartial<TLEditorAssetUrls>
-	/**
-	 * Whether to automatically focus the editor when it mounts.
-	 */
+	/** Whether to automatically focus the editor when it mounts. */
 	autoFocus?: boolean
-	/**
-	 * Overrides for the tldraw user interface components.
-	 */
+	/** Overrides for the tldraw user interface components. */
 	components?: Partial<TLEditorComponents>
-
 	/**
 	 * Called when the editor has mounted.
-	 *
 	 * @example
-	 *
 	 * ```ts
 	 * function TldrawEditor() {
 	 * 	return <Editor onMount={(editor) => editor.selectAll()} />
 	 * }
 	 * ```
-	 *
 	 * @param editor - The editor instance.
 	 */
 	onMount?: (editor: Editor) => (() => void) | undefined | void

commit 86e00105239b265c5996dcad7ff42635f4a77a82
Author: Mitja Bezenšek <mitja.bezensek@gmail.com>
Date:   Thu Jun 15 13:57:19 2023 +0200

    Make sure loading screens use dark mode user preference. (#1552)
    
    We load the user preferences a bit earlier, so that we can make sure
    that the `LoadingScreen` and `ErrorScreen` also use the correct color
    and background color based on the dark mode setting.
    
    There's still a brief flash of white screen, but that's before any of
    our components load, not sure if we can avoid that one.
    
    Solves https://github.com/tldraw/tldraw/issues/1248
    
    ### Change Type
    
    - [x] `patch` — Bug Fix
    
    ### Test Plan
    
    1. Probably best if you throttle your network speed.
    2. Reload the page.
    3. The asset loading screen should use take your dark mode setting into
    account.
    4. Change the dark mode and try again.
    
    ### Release Notes
    
    - Make sure our loading and error screens take dark mode setting into
    account.
    
    ---------
    
    Co-authored-by: Steve Ruiz <steveruizok@gmail.com>

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index 4a98e95a0..c80d3cc9a 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -1,10 +1,18 @@
 import { Store, StoreSnapshot } from '@tldraw/store'
 import { TLRecord, TLStore } from '@tldraw/tlschema'
 import { RecursivePartial, Required, annotateError } from '@tldraw/utils'
-import React, { memo, useCallback, useLayoutEffect, useState, useSyncExternalStore } from 'react'
+import React, {
+	memo,
+	useCallback,
+	useLayoutEffect,
+	useMemo,
+	useState,
+	useSyncExternalStore,
+} from 'react'
 import { TLEditorAssetUrls, useDefaultEditorAssetsWithOverrides } from './assetUrls'
 import { DefaultErrorFallback } from './components/DefaultErrorFallback'
 import { OptionalErrorBoundary } from './components/ErrorBoundary'
+import { TLUser, createTLUser } from './config/createTLUser'
 import { AnyTLShapeInfo } from './config/defineShape'
 import { Editor } from './editor/Editor'
 import { TLStateNodeConstructor } from './editor/tools/StateNode'
@@ -101,6 +109,7 @@ export const TldrawEditor = memo(function TldrawEditor({
 	...rest
 }: TldrawEditorProps) {
 	const [container, setContainer] = React.useState<HTMLDivElement | null>(null)
+	const user = useMemo(() => createTLUser(), [])
 
 	const ErrorFallback =
 		components?.ErrorFallback === undefined ? DefaultErrorFallback : components?.ErrorFallback
@@ -126,14 +135,14 @@ export const TldrawEditor = memo(function TldrawEditor({
 							{store ? (
 								store instanceof Store ? (
 									// Store is ready to go, whether externally synced or not
-									<TldrawEditorWithReadyStore {...withDefaults} store={store} />
+									<TldrawEditorWithReadyStore {...withDefaults} store={store} user={user} />
 								) : (
 									// Store is a synced store, so handle syncing stages internally
-									<TldrawEditorWithLoadingStore {...withDefaults} store={store} />
+									<TldrawEditorWithLoadingStore {...withDefaults} store={store} user={user} />
 								)
 							) : (
 								// We have no store (it's undefined) so create one and possibly sync it
-								<TldrawEditorWithOwnStore {...withDefaults} store={store} />
+								<TldrawEditorWithOwnStore {...withDefaults} store={store} user={user} />
 							)}
 						</EditorComponentsProvider>
 					</ContainerProvider>
@@ -144,9 +153,9 @@ export const TldrawEditor = memo(function TldrawEditor({
 })
 
 function TldrawEditorWithOwnStore(
-	props: Required<TldrawEditorProps & { store: undefined }, 'shapes' | 'tools'>
+	props: Required<TldrawEditorProps & { store: undefined; user: TLUser }, 'shapes' | 'tools'>
 ) {
-	const { defaultName, initialData, shapes, persistenceKey, sessionId } = props
+	const { defaultName, initialData, shapes, persistenceKey, sessionId, user } = props
 
 	const syncedStore = useLocalStore({
 		shapes,
@@ -156,13 +165,23 @@ function TldrawEditorWithOwnStore(
 		defaultName,
 	})
 
-	return <TldrawEditorWithLoadingStore {...props} store={syncedStore} />
+	return <TldrawEditorWithLoadingStore {...props} store={syncedStore} user={user} />
 }
 
 const TldrawEditorWithLoadingStore = memo(function TldrawEditorBeforeLoading({
 	store,
+	user,
 	...rest
-}: Required<TldrawEditorProps & { store: TLStoreWithStatus }, 'shapes' | 'tools'>) {
+}: Required<TldrawEditorProps & { store: TLStoreWithStatus; user: TLUser }, 'shapes' | 'tools'>) {
+	const container = useContainer()
+
+	useLayoutEffect(() => {
+		if (user.userPreferences.value.isDarkMode) {
+			container.classList.remove('tl-theme__light')
+			container.classList.add('tl-theme__dark')
+		}
+	}, [container, user.userPreferences.value.isDarkMode])
+
 	switch (store.status) {
 		case 'error': {
 			// for error handling, we fall back to the default error boundary.
@@ -184,7 +203,7 @@ const TldrawEditorWithLoadingStore = memo(function TldrawEditorBeforeLoading({
 		}
 	}
 
-	return <TldrawEditorWithReadyStore {...rest} store={store.store} />
+	return <TldrawEditorWithReadyStore {...rest} store={store.store} user={user} />
 })
 
 function TldrawEditorWithReadyStore({
@@ -194,10 +213,12 @@ function TldrawEditorWithReadyStore({
 	tools,
 	shapes,
 	autoFocus,
+	user,
 	assetUrls,
 }: Required<
 	TldrawEditorProps & {
 		store: TLStore
+		user: TLUser
 	},
 	'shapes' | 'tools'
 >) {
@@ -211,6 +232,7 @@ function TldrawEditorWithReadyStore({
 			shapes,
 			tools,
 			getContainer: () => container,
+			user,
 		})
 		;(window as any).app = editor
 		;(window as any).editor = editor
@@ -219,7 +241,7 @@ function TldrawEditorWithReadyStore({
 		return () => {
 			editor.dispose()
 		}
-	}, [container, shapes, tools, store])
+	}, [container, shapes, tools, store, user])
 
 	React.useLayoutEffect(() => {
 		if (editor && autoFocus) editor.focus()

commit 83184aaf439079a67b1a1b5199d7af1d8c79e91f
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Tue Jun 20 15:06:28 2023 +0100

    [fix] react component runaways, error boundaries (#1625)
    
    This PR fixes a few components that were updating too often. It changes
    the format of our error boundaries in order to avoid re-rendering them
    as changed props.
    
    ### Change Type
    
    - [x] `major` — Breaking change

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index c80d3cc9a..5fa4bbe1a 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -126,7 +126,7 @@ export const TldrawEditor = memo(function TldrawEditor({
 	return (
 		<div ref={setContainer} draggable={false} className="tl-container tl-theme__light" tabIndex={0}>
 			<OptionalErrorBoundary
-				fallback={ErrorFallback ? (error) => <ErrorFallback error={error} /> : null}
+				fallback={ErrorFallback}
 				onError={(error) => annotateError(error, { tags: { origin: 'react.tldraw-before-app' } })}
 			>
 				{container && (
@@ -297,7 +297,7 @@ function TldrawEditorWithReadyStore({
 		// document in the event of an error to reassure them that their work is
 		// not lost.
 		<OptionalErrorBoundary
-			fallback={ErrorFallback ? (error) => <ErrorFallback error={error} editor={editor} /> : null}
+			fallback={ErrorFallback}
 			onError={(error) =>
 				editor.annotateError(error, { origin: 'react.tldraw', willCrashApp: true })
 			}

commit ed8d4d9e05fd30a1f36b8ca398c4d784470d7990
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Tue Jun 27 13:25:55 2023 +0100

    [improvement] store snapshot types (#1657)
    
    This PR improves the types for the Store.
    
    - renames `StoreSnapshot` to `SerializedStore`, which is the return type
    of `Store.serialize`
    - creates `StoreSnapshot` as a type for the return type of
    `Store.getSnapshot` / the argument type for `Store.loadSnapshot`
    - creates `TLStoreSnapshot` as the type used for the `TLStore`.
    
    This came out of a session I had with a user. This should prevent
    needing to import types from `@tldraw/store` directly.
    
    ### Change Type
    
    - [x] `major` — Breaking change
    
    ### Test Plan
    
    - [x] Unit Tests
    
    ### Release Notes
    
    - [dev] Rename `StoreSnapshot` to `SerializedStore`
    - [dev] Create new `StoreSnapshot` as type related to
    `getSnapshot`/`loadSnapshot`

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index 5fa4bbe1a..abd5d5067 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -1,4 +1,4 @@
-import { Store, StoreSnapshot } from '@tldraw/store'
+import { SerializedStore, Store } from '@tldraw/store'
 import { TLRecord, TLStore } from '@tldraw/tlschema'
 import { RecursivePartial, Required, annotateError } from '@tldraw/utils'
 import React, {
@@ -70,7 +70,7 @@ export type TldrawEditorProps = {
 			/**
 			 * The editor's initial data.
 			 */
-			initialData?: StoreSnapshot<TLRecord>
+			initialData?: SerializedStore<TLRecord>
 			/**
 			 * The id under which to sync and persist the editor's data. If none is given tldraw will not sync or persist
 			 * the editor's data.

commit d99c4a0e9c9997d3c1f60c1f22e81c6628a901ca
Author: Lu Wilson <l2wilson94@gmail.com>
Date:   Fri Jul 7 12:50:47 2023 +0100

    Make some missing tsdocs appear on the docs site (#1706)
    
    🚨 Note 🚨
    This PR has changed! See my [newer
    comment](https://github.com/tldraw/tldraw/pull/1706#issuecomment-1623451709)
    for what the PR does now.
    This description is kept here to show the original intention of the PR.
    
    ---
    
    This PR fixes the tsdocs formatting of `TldrawEditorProps`, so that they
    appears on the docs site.
    
    We have docs already written, but they weren't appearing. There are
    probably others like this too.
    
    
    ![image](https://github.com/tldraw/tldraw/assets/15892272/8d8940b3-983f-48b3-9804-7ac88116ca9d)
    
    ### Change Type
    
    - [x] `documentation` — Changes to the documentation only[^2]
    
    [^1]: publishes a `patch` release, for devDependencies use `internal`
    [^2]: will not publish a new version
    
    ### Test Plan
    
    1. Navigate to `/gen/editor/TldrawEditorProps`
    2. Make sure that that the parameters are listed out with descriptions.
    
    - [ ] Unit Tests
    - [ ] End to end tests
    
    ### Release Notes
    
    - Docs: Fixed some missing docs for the TldrawEditor component.

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index abd5d5067..031382a07 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -9,6 +9,7 @@ import React, {
 	useState,
 	useSyncExternalStore,
 } from 'react'
+
 import { TLEditorAssetUrls, useDefaultEditorAssetsWithOverrides } from './assetUrls'
 import { DefaultErrorFallback } from './components/DefaultErrorFallback'
 import { OptionalErrorBoundary } from './components/ErrorBoundary'
@@ -33,65 +34,78 @@ import { useSafariFocusOutFix } from './hooks/useSafariFocusOutFix'
 import { useZoomCss } from './hooks/useZoomCss'
 import { TLStoreWithStatus } from './utils/sync/StoreWithStatus'
 
-/** @public */
-export type TldrawEditorProps = {
+/**
+ * Props for the {@link @tldraw/tldraw#Tldraw} and {@link TldrawEditor} components.
+ *
+ * @public
+ **/
+export type TldrawEditorProps = TldrawEditorBaseProps &
+	(
+		| {
+				store: TLStore | TLStoreWithStatus
+		  }
+		| {
+				store?: undefined
+				initialData?: SerializedStore<TLRecord>
+				persistenceKey?: string
+				sessionId?: string
+				defaultName?: string
+		  }
+	)
+
+/**
+ * Base props for the {@link @tldraw/tldraw#Tldraw} and {@link TldrawEditor} components.
+ *
+ * @public
+ */
+export interface TldrawEditorBaseProps {
+	/**
+	 * The component's children.
+	 */
 	children?: any
-	/** An array of shape utils to use in the editor. */
+
+	/**
+	 * An array of shapes definitions to make available to the editor.
+	 */
 	shapes?: readonly AnyTLShapeInfo[]
-	/** An array of tools to use in the editor. */
+
+	/**
+	 * An array of tools to add to the editor's state chart.
+	 */
 	tools?: readonly TLStateNodeConstructor[]
-	/** Urls for where to find fonts and other assets. */
+
+	/**
+	 * Urls for the editor to find fonts and other assets.
+	 */
 	assetUrls?: RecursivePartial<TLEditorAssetUrls>
-	/** Whether to automatically focus the editor when it mounts. */
+
+	/**
+	 * Whether to automatically focus the editor when it mounts.
+	 */
 	autoFocus?: boolean
-	/** Overrides for the tldraw user interface components. */
+
+	/**
+	 * Overrides for the editor's components, such as handles, collaborator cursors, etc.
+	 */
 	components?: Partial<TLEditorComponents>
+
 	/**
 	 * Called when the editor has mounted.
-	 * @example
-	 * ```ts
-	 * function TldrawEditor() {
-	 * 	return <Editor onMount={(editor) => editor.selectAll()} />
-	 * }
-	 * ```
-	 * @param editor - The editor instance.
 	 */
-	onMount?: (editor: Editor) => (() => void) | undefined | void
-} & (
-	| {
-			/**
-			 * The Store instance to use for keeping the editor's data. This may be prepopulated, e.g. by loading
-			 * from a server or database.
-			 */
-			store: TLStore | TLStoreWithStatus
-	  }
-	| {
-			store?: undefined
-			/**
-			 * The editor's initial data.
-			 */
-			initialData?: SerializedStore<TLRecord>
-			/**
-			 * The id under which to sync and persist the editor's data. If none is given tldraw will not sync or persist
-			 * the editor's data.
-			 */
-			persistenceKey?: string
-			/**
-			 * When tldraw reloads a document from local persistence, it will try to bring back the
-			 * editor UI state (e.g. camera position, which shapes are selected). It does this using a sessionId,
-			 * which by default is unique per browser tab. If you wish to have more fine-grained
-			 * control over this behavior, you can provide your own sessionId.
-			 *
-			 * If it can't find saved UI state for the given sessionId, it will use the most recently saved
-			 * UI state for the given persistenceKey if available.
-			 */
-			sessionId?: string
-			/**
-			 * The default initial document name. e.g. 'Untitled Document'
-			 */
-			defaultName?: string
-	  }
-)
+	onMount?: TLOnMountHandler
+}
+
+/**
+ * Called when the editor has mounted.
+ * @example
+ * ```ts
+ * <Tldraw onMount={(editor) => editor.selectAll()} />
+ * ```
+ * @param editor - The editor instance.
+ *
+ * @public
+ */
+export type TLOnMountHandler = (editor: Editor) => (() => void) | undefined | void
 
 declare global {
 	interface Window {

commit b7d9c8684cb6cf7bd710af5420135ea3516cc3bf
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Mon Jul 17 22:22:34 2023 +0100

    tldraw zero - package shuffle (#1710)
    
    This PR moves code between our packages so that:
    - @tldraw/editor is a “core” library with the engine and canvas but no
    shapes, tools, or other things
    - @tldraw/tldraw contains everything particular to the experience we’ve
    built for tldraw
    
    At first look, this might seem like a step away from customization and
    configuration, however I believe it greatly increases the configuration
    potential of the @tldraw/editor while also providing a more accurate
    reflection of what configuration options actually exist for
    @tldraw/tldraw.
    
    ## Library changes
    
    @tldraw/editor re-exports its dependencies and @tldraw/tldraw re-exports
    @tldraw/editor.
    
    - users of @tldraw/editor WITHOUT @tldraw/tldraw should almost always
    only import things from @tldraw/editor.
    - users of @tldraw/tldraw should almost always only import things from
    @tldraw/tldraw.
    
    - @tldraw/polyfills is merged into @tldraw/editor
    - @tldraw/indices is merged into @tldraw/editor
    - @tldraw/primitives is merged mostly into @tldraw/editor, partially
    into @tldraw/tldraw
    - @tldraw/file-format is merged into @tldraw/tldraw
    - @tldraw/ui is merged into @tldraw/tldraw
    
    Many (many) utils and other code is moved from the editor to tldraw. For
    example, embeds now are entirely an feature of @tldraw/tldraw. The only
    big chunk of code left in core is related to arrow handling.
    
    ## API Changes
    
    The editor can now be used without tldraw's assets. We load them in
    @tldraw/tldraw instead, so feel free to use whatever fonts or images or
    whatever that you like with the editor.
    
    All tools and shapes (except for the `Group` shape) are moved to
    @tldraw/tldraw. This includes the `select` tool.
    
    You should use the editor with at least one tool, however, so you now
    also need to send in an `initialState` prop to the Editor /
    <TldrawEditor> component indicating which state the editor should begin
    in.
    
    The `components` prop now also accepts `SelectionForeground`.
    
    The complex selection component that we use for tldraw is moved to
    @tldraw/tldraw. The default component is quite basic but can easily be
    replaced via the `components` prop. We pass down our tldraw-flavored
    SelectionFg via `components`.
    
    Likewise with the `Scribble` component: the `DefaultScribble` no longer
    uses our freehand tech and is a simple path instead. We pass down the
    tldraw-flavored scribble via `components`.
    
    The `ExternalContentManager` (`Editor.externalContentManager`) is
    removed and replaced with a mapping of types to handlers.
    
    - Register new content handlers with
    `Editor.registerExternalContentHandler`.
    - Register new asset creation handlers (for files and URLs) with
    `Editor.registerExternalAssetHandler`
    
    ### Change Type
    
    - [x] `major` — Breaking change
    
    ### Test Plan
    
    - [x] Unit Tests
    - [x] End to end tests
    
    ### Release Notes
    
    - [@tldraw/editor] lots, wip
    - [@tldraw/ui] gone, merged to tldraw/tldraw
    - [@tldraw/polyfills] gone, merged to tldraw/editor
    - [@tldraw/primitives] gone, merged to tldraw/editor / tldraw/tldraw
    - [@tldraw/indices] gone, merged to tldraw/editor
    - [@tldraw/file-format] gone, merged to tldraw/tldraw
    
    ---------
    
    Co-authored-by: alex <alex@dytry.ch>

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index 031382a07..c92a7dcac 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -1,6 +1,6 @@
 import { SerializedStore, Store } from '@tldraw/store'
 import { TLRecord, TLStore } from '@tldraw/tlschema'
-import { RecursivePartial, Required, annotateError } from '@tldraw/utils'
+import { Required, annotateError } from '@tldraw/utils'
 import React, {
 	memo,
 	useCallback,
@@ -10,11 +10,11 @@ import React, {
 	useSyncExternalStore,
 } from 'react'
 
-import { TLEditorAssetUrls, useDefaultEditorAssetsWithOverrides } from './assetUrls'
-import { DefaultErrorFallback } from './components/DefaultErrorFallback'
+import { Canvas } from './components/Canvas'
 import { OptionalErrorBoundary } from './components/ErrorBoundary'
+import { DefaultErrorFallback } from './components/default-components/DefaultErrorFallback'
 import { TLUser, createTLUser } from './config/createTLUser'
-import { AnyTLShapeInfo } from './config/defineShape'
+import { TLAnyShapeUtilConstructor } from './config/defaultShapes'
 import { Editor } from './editor/Editor'
 import { TLStateNodeConstructor } from './editor/tools/StateNode'
 import { ContainerProvider, useContainer } from './hooks/useContainer'
@@ -29,7 +29,6 @@ import {
 import { useEvent } from './hooks/useEvent'
 import { useForceUpdate } from './hooks/useForceUpdate'
 import { useLocalStore } from './hooks/useLocalStore'
-import { usePreloadAssets } from './hooks/usePreloadAssets'
 import { useSafariFocusOutFix } from './hooks/useSafariFocusOutFix'
 import { useZoomCss } from './hooks/useZoomCss'
 import { TLStoreWithStatus } from './utils/sync/StoreWithStatus'
@@ -65,20 +64,15 @@ export interface TldrawEditorBaseProps {
 	children?: any
 
 	/**
-	 * An array of shapes definitions to make available to the editor.
+	 * An array of shape utils to use in the editor.
 	 */
-	shapes?: readonly AnyTLShapeInfo[]
+	shapeUtils?: readonly TLAnyShapeUtilConstructor[]
 
 	/**
 	 * An array of tools to add to the editor's state chart.
 	 */
 	tools?: readonly TLStateNodeConstructor[]
 
-	/**
-	 * Urls for the editor to find fonts and other assets.
-	 */
-	assetUrls?: RecursivePartial<TLEditorAssetUrls>
-
 	/**
 	 * Whether to automatically focus the editor when it mounts.
 	 */
@@ -93,6 +87,11 @@ export interface TldrawEditorBaseProps {
 	 * Called when the editor has mounted.
 	 */
 	onMount?: TLOnMountHandler
+
+	/**
+	 * The editor's initial state (usually the id of the first active tool).
+	 */
+	initialState?: string
 }
 
 /**
@@ -113,7 +112,7 @@ declare global {
 	}
 }
 
-const EMPTY_SHAPES_ARRAY = [] as const
+const EMPTY_SHAPE_UTILS_ARRAY = [] as const
 const EMPTY_TOOLS_ARRAY = [] as const
 
 /** @public */
@@ -133,7 +132,7 @@ export const TldrawEditor = memo(function TldrawEditor({
 	// defaults applied in @tldraw/tldraw.
 	const withDefaults = {
 		...rest,
-		shapes: rest.shapes ?? EMPTY_SHAPES_ARRAY,
+		shapeUtils: rest.shapeUtils ?? EMPTY_SHAPE_UTILS_ARRAY,
 		tools: rest.tools ?? EMPTY_TOOLS_ARRAY,
 	}
 
@@ -167,12 +166,12 @@ export const TldrawEditor = memo(function TldrawEditor({
 })
 
 function TldrawEditorWithOwnStore(
-	props: Required<TldrawEditorProps & { store: undefined; user: TLUser }, 'shapes' | 'tools'>
+	props: Required<TldrawEditorProps & { store: undefined; user: TLUser }, 'shapeUtils' | 'tools'>
 ) {
-	const { defaultName, initialData, shapes, persistenceKey, sessionId, user } = props
+	const { defaultName, initialData, shapeUtils, persistenceKey, sessionId, user } = props
 
 	const syncedStore = useLocalStore({
-		shapes,
+		shapeUtils,
 		initialData,
 		persistenceKey,
 		sessionId,
@@ -186,7 +185,10 @@ const TldrawEditorWithLoadingStore = memo(function TldrawEditorBeforeLoading({
 	store,
 	user,
 	...rest
-}: Required<TldrawEditorProps & { store: TLStoreWithStatus; user: TLUser }, 'shapes' | 'tools'>) {
+}: Required<
+	TldrawEditorProps & { store: TLStoreWithStatus; user: TLUser },
+	'shapeUtils' | 'tools'
+>) {
 	const container = useContainer()
 
 	useLayoutEffect(() => {
@@ -225,16 +227,16 @@ function TldrawEditorWithReadyStore({
 	children,
 	store,
 	tools,
-	shapes,
+	shapeUtils,
 	autoFocus,
 	user,
-	assetUrls,
+	initialState,
 }: Required<
 	TldrawEditorProps & {
 		store: TLStore
 		user: TLUser
 	},
-	'shapes' | 'tools'
+	'shapeUtils' | 'tools'
 >) {
 	const { ErrorFallback } = useEditorComponents()
 	const container = useContainer()
@@ -243,10 +245,11 @@ function TldrawEditorWithReadyStore({
 	useLayoutEffect(() => {
 		const editor = new Editor({
 			store,
-			shapes,
+			shapeUtils,
 			tools,
 			getContainer: () => container,
 			user,
+			initialState,
 		})
 		;(window as any).app = editor
 		;(window as any).editor = editor
@@ -255,10 +258,10 @@ function TldrawEditorWithReadyStore({
 		return () => {
 			editor.dispose()
 		}
-	}, [container, shapes, tools, store, user])
+	}, [container, shapeUtils, tools, store, user, initialState])
 
 	React.useLayoutEffect(() => {
-		if (editor && autoFocus) editor.focus()
+		if (editor && autoFocus) editor.isFocused = true
 	}, [editor, autoFocus])
 
 	const onMountEvent = useEvent((editor: Editor) => {
@@ -288,17 +291,6 @@ function TldrawEditorWithReadyStore({
 		() => editor?.crashingError ?? null
 	)
 
-	const assets = useDefaultEditorAssetsWithOverrides(assetUrls)
-	const { done: preloadingComplete, error: preloadingError } = usePreloadAssets(assets)
-
-	if (preloadingError) {
-		return <ErrorScreen>Could not load assets. Please refresh the page.</ErrorScreen>
-	}
-
-	if (!preloadingComplete) {
-		return <LoadingScreen>Loading assets...</LoadingScreen>
-	}
-
 	if (!editor) {
 		return null
 	}
@@ -311,7 +303,7 @@ function TldrawEditorWithReadyStore({
 		// document in the event of an error to reassure them that their work is
 		// not lost.
 		<OptionalErrorBoundary
-			fallback={ErrorFallback}
+			fallback={ErrorFallback as any}
 			onError={(error) =>
 				editor.annotateError(error, { origin: 'react.tldraw', willCrashApp: true })
 			}
@@ -334,7 +326,7 @@ function Layout({ children }: { children: any }) {
 	useSafariFocusOutFix()
 	useForceUpdate()
 
-	return children
+	return children ?? <Canvas />
 }
 
 function Crash({ crashingError }: { crashingError: unknown }): null {

commit 3e31ef2a7d01467ef92ca4f7aed13ee708db73ef
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Tue Jul 18 22:50:23 2023 +0100

    Remove helpers / extraneous API methods. (#1745)
    
    This PR removes several extraneous computed values from the editor. It
    adds some silly instance state onto the instance state record and
    unifies a few methods which were inconsistent. This is fit and finish
    work 🧽
    
    ## Computed Values
    
    In general, where once we had a getter and setter for `isBlahMode`,
    which really masked either an `_isBlahMode` atom on the editor or
    `instanceState.isBlahMode`, these are merged into `instanceState`; they
    can be accessed / updated via `editor.instanceState` /
    `editor.updateInstanceState`.
    
    ## tldraw select tool specific things
    
    This PR also removes some tldraw specific state checks and creates new
    component overrides to allow us to include them in tldraw/tldraw.
    
    ### Change Type
    
    - [x] `major` — Breaking change
    
    ### Test Plan
    
    - [x] Unit Tests
    - [x] End to end tests
    
    ### Release Notes
    
    - [tldraw] rename `useReadonly` to `useReadOnly`
    - [editor] remove `Editor.isDarkMode`
    - [editor] remove `Editor.isChangingStyle`
    - [editor] remove `Editor.isCoarsePointer`
    - [editor] remove `Editor.isDarkMode`
    - [editor] remove `Editor.isFocused`
    - [editor] remove `Editor.isGridMode`
    - [editor] remove `Editor.isPenMode`
    - [editor] remove `Editor.isReadOnly`
    - [editor] remove `Editor.isSnapMode`
    - [editor] remove `Editor.isToolLocked`
    - [editor] remove `Editor.locale`
    - [editor] rename `Editor.pageState` to `Editor.currentPageState`
    - [editor] add `Editor.pageStates`
    - [editor] add `Editor.setErasingIds`
    - [editor] add `Editor.setEditingId`
    - [editor] add several new component overrides

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index c92a7dcac..8b5514885 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -261,7 +261,9 @@ function TldrawEditorWithReadyStore({
 	}, [container, shapeUtils, tools, store, user, initialState])
 
 	React.useLayoutEffect(() => {
-		if (editor && autoFocus) editor.isFocused = true
+		if (editor && autoFocus) {
+			editor.focus()
+		}
 	}, [editor, autoFocus])
 
 	const onMountEvent = useEvent((editor: Editor) => {

commit b22ea7cd4e6c27dcebd6615daa07116ecacbf554
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Wed Jul 19 11:52:21 2023 +0100

    More cleanup, focus bug fixes (#1749)
    
    This PR is another grab bag:
    - renames `readOnly` to `readonly` throughout editor
    - fixes a regression related to focus and keyboard shortcuts
    - adds a small outline for focused editors
    
    ### Change Type
    
    - [x] `major`
    
    ### Test Plan
    
    - [x] End to end tests

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index 8b5514885..d0f126519 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -10,6 +10,7 @@ import React, {
 	useSyncExternalStore,
 } from 'react'
 
+import classNames from 'classnames'
 import { Canvas } from './components/Canvas'
 import { OptionalErrorBoundary } from './components/ErrorBoundary'
 import { DefaultErrorFallback } from './components/default-components/DefaultErrorFallback'
@@ -92,6 +93,11 @@ export interface TldrawEditorBaseProps {
 	 * The editor's initial state (usually the id of the first active tool).
 	 */
 	initialState?: string
+
+	/**
+	 * A classname to pass to the editor's container.
+	 */
+	className?: string
 }
 
 /**
@@ -119,9 +125,10 @@ const EMPTY_TOOLS_ARRAY = [] as const
 export const TldrawEditor = memo(function TldrawEditor({
 	store,
 	components,
+	className,
 	...rest
 }: TldrawEditorProps) {
-	const [container, setContainer] = React.useState<HTMLDivElement | null>(null)
+	const [container, rContainer] = React.useState<HTMLDivElement | null>(null)
 	const user = useMemo(() => createTLUser(), [])
 
 	const ErrorFallback =
@@ -137,7 +144,12 @@ export const TldrawEditor = memo(function TldrawEditor({
 	}
 
 	return (
-		<div ref={setContainer} draggable={false} className="tl-container tl-theme__light" tabIndex={0}>
+		<div
+			ref={rContainer}
+			draggable={false}
+			className={classNames('tl-container tl-theme__light', className)}
+			tabIndex={0}
+		>
 			<OptionalErrorBoundary
 				fallback={ErrorFallback}
 				onError={(error) => annotateError(error, { tags: { origin: 'react.tldraw-before-app' } })}

commit 89914684467c1e18ef06fa702c82ed0f88a2ea09
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Sat Aug 5 12:21:07 2023 +0100

    history options / markId / createPage (#1796)
    
    This PR:
    
    - adds history options to several commands in order to allow them to
    support squashing and ephemeral data (previously, these commands had
    boolean values for squashing / ephemeral)
    
    It also:
    - changes `markId` to return the editor instance rather than the mark id
    passed into the command
    - removes `focus` and `blur` commands
    - changes `createPage` parameters
    - unifies `animateShape` / `animateShapes` options
    
    ### Change Type
    
    - [x] `major` — Breaking change
    
    ### Test Plan
    
    - [x] Unit Tests

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index d0f126519..c0de59759 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -274,7 +274,7 @@ function TldrawEditorWithReadyStore({
 
 	React.useLayoutEffect(() => {
 		if (editor && autoFocus) {
-			editor.focus()
+			editor.getContainer().focus()
 		}
 	}, [editor, autoFocus])
 

commit 3bde22a482f4ad1b362a95dbd9fa4decbac04112
Author: alex <alex@dytry.ch>
Date:   Wed Aug 30 14:26:14 2023 +0100

    Allow setting `user` as a prop (#1832)
    
    Add `user` as a prop to `TldrawEditor`
    
    ### Change Type
    
    - [x] `patch` — Bug fix

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index c0de59759..860bd6e59 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -98,6 +98,11 @@ export interface TldrawEditorBaseProps {
 	 * A classname to pass to the editor's container.
 	 */
 	className?: string
+
+	/**
+	 * The user interacting with the editor.
+	 */
+	user?: TLUser
 }
 
 /**
@@ -126,10 +131,11 @@ export const TldrawEditor = memo(function TldrawEditor({
 	store,
 	components,
 	className,
+	user: _user,
 	...rest
 }: TldrawEditorProps) {
 	const [container, rContainer] = React.useState<HTMLDivElement | null>(null)
-	const user = useMemo(() => createTLUser(), [])
+	const user = useMemo(() => _user ?? createTLUser(), [_user])
 
 	const ErrorFallback =
 		components?.ErrorFallback === undefined ? DefaultErrorFallback : components?.ErrorFallback

commit 930abaf5d726e64b277e29805d794271215691ba
Author: Brian Hung <brianlhung@gmail.com>
Date:   Fri Sep 8 03:47:14 2023 -0700

    avoid pixel rounding / transformation miscalc for overlay items (#1858)
    
    Fixes pixel rounding when calculating css transformations for overlay
    items. Also fixes issue where `editor.instanceState.devicePixelRatio`
    wasn't properly updating.
    
    TLDR; `width * window.devicePixelRatio` should be integer to avoid
    rounding. `--tl-dpr-multiple` is smallest integer to multiply
    `window.devicePixelRatio` such that its product is an integer.
    
    #1852
    #1836
    #1834
    
    ### Change Type
    
    - [x] `patch` — Bug fix
    - [ ] `minor` — New feature
    - [ ] `major` — Breaking change
    - [ ] `dependencies` — Changes to package dependencies[^1]
    - [ ] `documentation` — Changes to the documentation only[^2]
    - [ ] `tests` — Changes to any test code only[^2]
    - [ ] `internal` — Any other changes that don't affect the published
    package[^2]
    - [ ] I don't know
    
    [^1]: publishes a `patch` release, for devDependencies use `internal`
    [^2]: will not publish a new version
    
    ### Test Plan
    
    Would need to add a test checking when `window.devicePixelRatio`
    changes, that `editor.instanceState.devicePixelRatio` is equal.
    
    ---------
    
    Co-authored-by: David Sheldrick <d.j.sheldrick@gmail.com>

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index 860bd6e59..7614243c7 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -20,6 +20,7 @@ import { Editor } from './editor/Editor'
 import { TLStateNodeConstructor } from './editor/tools/StateNode'
 import { ContainerProvider, useContainer } from './hooks/useContainer'
 import { useCursor } from './hooks/useCursor'
+import { useDPRMultiple } from './hooks/useDPRMultiple'
 import { useDarkMode } from './hooks/useDarkMode'
 import { EditorContext } from './hooks/useEditor'
 import {
@@ -345,6 +346,7 @@ function Layout({ children }: { children: any }) {
 	useDarkMode()
 	useSafariFocusOutFix()
 	useForceUpdate()
+	useDPRMultiple()
 
 	return children ?? <Canvas />
 }

commit 0b3e83be52849d01f129e89d479b7a2aaf733d47
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Fri Sep 8 15:48:55 2023 +0100

    Add snapshot prop, examples (#1856)
    
    This PR:
    - adds a `snapshot` prop to the <Tldraw> component. It does basically
    the same thing as calling `loadSnapshot` after creating the store, but
    happens before the editor actually loads.
    - adds a largeish example (including a JSON snapshot) to the examples
    
    We have some very complex ways of juggling serialized data between
    multiplayer, file formats, and the snapshot APIs. I'd like to see these
    simplified, or at least for our documentation to reflect a narrow subset
    of all the options available.
    
    The most common questions seem to be:
    
    Q: How do I serialize data?
    A: Via the `Editor.getSnapshot()` method
    
    Q: How do I restore serialized data?
    A: Via the `Editor.loadSnapshot()` method OR via the `<Tldraw>`
    component's `snapshot` prop
    
    The store has an `initialData` constructor prop, however this is quite
    complex as the store also requires a schema class instance with which to
    migrate the data. In our components (<Tldraw> and <TldrawEditor>) we
    were also accepting `initialData`, however we weren't accepting a
    schema, and either way I think it's unrealistic to also expect users to
    create schemas themselves and pass those in.
    
    AFAIK the `initialData` prop is only used in the file loading, which is
    a good example of how complex it looks like to create a schema and
    migrate data outside of the components.
    
    ### Change Type
    
    - [x] `minor` — New feature

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index 7614243c7..4763c7553 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -1,4 +1,4 @@
-import { SerializedStore, Store } from '@tldraw/store'
+import { SerializedStore, Store, StoreSnapshot } from '@tldraw/store'
 import { TLRecord, TLStore } from '@tldraw/tlschema'
 import { Required, annotateError } from '@tldraw/utils'
 import React, {
@@ -47,6 +47,7 @@ export type TldrawEditorProps = TldrawEditorBaseProps &
 		  }
 		| {
 				store?: undefined
+				snapshot?: StoreSnapshot<TLRecord>
 				initialData?: SerializedStore<TLRecord>
 				persistenceKey?: string
 				sessionId?: string
@@ -187,7 +188,7 @@ export const TldrawEditor = memo(function TldrawEditor({
 function TldrawEditorWithOwnStore(
 	props: Required<TldrawEditorProps & { store: undefined; user: TLUser }, 'shapeUtils' | 'tools'>
 ) {
-	const { defaultName, initialData, shapeUtils, persistenceKey, sessionId, user } = props
+	const { defaultName, snapshot, initialData, shapeUtils, persistenceKey, sessionId, user } = props
 
 	const syncedStore = useLocalStore({
 		shapeUtils,
@@ -195,6 +196,7 @@ function TldrawEditorWithOwnStore(
 		persistenceKey,
 		sessionId,
 		defaultName,
+		snapshot,
 	})
 
 	return <TldrawEditorWithLoadingStore {...props} store={syncedStore} user={user} />

commit 20704ea41768f0746480bd840b008ecda9778627
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Sat Sep 9 10:41:06 2023 +0100

    [fix] iframe losing focus on pointer down (#1848)
    
    This PR fixes a bug that would cause an interactive iframe (e.g. a
    youtube video) to lose its editing state once clicked.
    
    ### Change Type
    
    - [x] `patch` — Bug fix
    
    ### Test Plan
    
    1. Create an interactive iframe.
    2. Begin editing.
    3. Click inside of the iframe

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index 4763c7553..c79438e16 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -22,13 +22,14 @@ import { ContainerProvider, useContainer } from './hooks/useContainer'
 import { useCursor } from './hooks/useCursor'
 import { useDPRMultiple } from './hooks/useDPRMultiple'
 import { useDarkMode } from './hooks/useDarkMode'
-import { EditorContext } from './hooks/useEditor'
+import { EditorContext, useEditor } from './hooks/useEditor'
 import {
 	EditorComponentsProvider,
 	TLEditorComponents,
 	useEditorComponents,
 } from './hooks/useEditorComponents'
 import { useEvent } from './hooks/useEvent'
+import { useFocusEvents } from './hooks/useFocusEvents'
 import { useForceUpdate } from './hooks/useForceUpdate'
 import { useLocalStore } from './hooks/useLocalStore'
 import { useSafariFocusOutFix } from './hooks/useSafariFocusOutFix'
@@ -281,23 +282,6 @@ function TldrawEditorWithReadyStore({
 		}
 	}, [container, shapeUtils, tools, store, user, initialState])
 
-	React.useLayoutEffect(() => {
-		if (editor && autoFocus) {
-			editor.getContainer().focus()
-		}
-	}, [editor, autoFocus])
-
-	const onMountEvent = useEvent((editor: Editor) => {
-		const teardown = onMount?.(editor)
-		editor.emit('mount')
-		window.tldrawReady = true
-		return teardown
-	})
-
-	React.useLayoutEffect(() => {
-		if (editor) return onMountEvent?.(editor)
-	}, [editor, onMountEvent])
-
 	const crashingError = useSyncExternalStore(
 		useCallback(
 			(onStoreChange) => {
@@ -335,19 +319,31 @@ function TldrawEditorWithReadyStore({
 				<Crash crashingError={crashingError} />
 			) : (
 				<EditorContext.Provider value={editor}>
-					<Layout>{children}</Layout>
+					<Layout autoFocus={autoFocus} onMount={onMount}>
+						{children}
+					</Layout>
 				</EditorContext.Provider>
 			)}
 		</OptionalErrorBoundary>
 	)
 }
 
-function Layout({ children }: { children: any }) {
+function Layout({
+	children,
+	onMount,
+	autoFocus = false,
+}: {
+	children: any
+	onMount?: TLOnMountHandler
+	autoFocus?: boolean
+}) {
 	useZoomCss()
 	useCursor()
 	useDarkMode()
 	useSafariFocusOutFix()
 	useForceUpdate()
+	useFocusEvents(autoFocus)
+	useOnMount(onMount)
 	useDPRMultiple()
 
 	return children ?? <Canvas />
@@ -373,3 +369,18 @@ export function LoadingScreen({ children }: { children: any }) {
 export function ErrorScreen({ children }: { children: any }) {
 	return <div className="tl-loading">{children}</div>
 }
+
+function useOnMount(onMount?: TLOnMountHandler) {
+	const editor = useEditor()
+
+	const onMountEvent = useEvent((editor: Editor) => {
+		const teardown = onMount?.(editor)
+		editor.emit('mount')
+		window.tldrawReady = true
+		return teardown
+	})
+
+	React.useLayoutEffect(() => {
+		if (editor) return onMountEvent?.(editor)
+	}, [editor, onMountEvent])
+}

commit 3d30f77ac1035cf6c9ba1d4c47b134a49530a7a9
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Fri Sep 29 16:20:39 2023 +0100

    Make user preferences optional (#1963)
    
    This PR makes it so that user preferences can be in a 'null' state,
    where we use the default values and/or infer from the system
    preferences.
    
    Before this PR it was impossible to allow a user to change their locale
    via their system config rather than selecting an explicit value in the
    tldraw editor menu. Similarly, it was impossible to adapt to changes in
    the user's system preferences for dark/light mode.
    
    That's because we saved the full user preference values the first time
    the user loaded tldraw, and the only way for them to change after that
    is by saving new values.
    
    After this PR, if a value is `null` we will use the 'default' version of
    it, which can be inferred based on the user's system preferences in the
    case of dark mode, locale, and animation speed. Then if the user changes
    their system config and refreshes the page their changes should be
    picked up by tldraw where they previously wouldn't have been.
    
    Dark mode inference is opt-in by setting a prop `inferDarkMode: true` on
    the `Editor` instance (and the `<Tldraw />` components), because we
    don't want it to be a surprise for existing library users.
    
    
    ### Change Type
    
    - [ ] `patch` — Bug fix
    - [ ] `minor` — New feature
    - [x] `major` — Breaking change
    
    [^1]: publishes a `patch` release, for devDependencies use `internal`
    [^2]: will not publish a new version

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index c79438e16..5780ea030 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -106,6 +106,11 @@ export interface TldrawEditorBaseProps {
 	 * The user interacting with the editor.
 	 */
 	user?: TLUser
+
+	/**
+	 * Whether to infer dark mode from the user's OS. Defaults to false.
+	 */
+	inferDarkMode?: boolean
 }
 
 /**
@@ -253,6 +258,7 @@ function TldrawEditorWithReadyStore({
 	autoFocus,
 	user,
 	initialState,
+	inferDarkMode,
 }: Required<
 	TldrawEditorProps & {
 		store: TLStore
@@ -272,6 +278,7 @@ function TldrawEditorWithReadyStore({
 			getContainer: () => container,
 			user,
 			initialState,
+			inferDarkMode,
 		})
 		;(window as any).app = editor
 		;(window as any).editor = editor
@@ -280,7 +287,7 @@ function TldrawEditorWithReadyStore({
 		return () => {
 			editor.dispose()
 		}
-	}, [container, shapeUtils, tools, store, user, initialState])
+	}, [container, shapeUtils, tools, store, user, initialState, inferDarkMode])
 
 	const crashingError = useSyncExternalStore(
 		useCallback(

commit da33179a313f92f8b4f335cca7f45762f9f38075
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Mon Oct 2 12:29:54 2023 +0100

    Remove focus management (#1953)
    
    This PR removes the automatic focus events from the editor.
    
    The `autoFocus` prop is now true by default. When true, the editor will
    begin in a focused state (`editor.instanceState.isFocused` will be
    `true`) and the component will respond to keyboard shortcuts and other
    interactions. When false, the editor will begin in an unfocused state
    and not respond to keyboard interactions.
    
    **It's now up to the developer** using the component to update
    `isFocused` themselves. There's no predictable way to do that on our
    side, so we leave it to the developer to decide when to turn on or off
    focus for a container (for example, using an intersection observer to
    "unfocus" components that are off screen).
    
    ### Change Type
    
    - [x] `major` — Breaking change
    
    ### Test Plan
    
    1. Open the multiple editors example.
    2. Click to focus each editor.
    3. Use the keyboard shortcuts to check that the correct editor is
    focused.
    4. Start editing a shape, then select the other editor. The first
    editing shape should complete.
    
    - [x] Unit Tests
    - [x] End to end tests
    
    ### Release Notes
    
    - [editor] Make autofocus default, remove automatic blur / focus events.
    
    ---------
    
    Co-authored-by: David Sheldrick <d.j.sheldrick@gmail.com>

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index 5780ea030..a838773d4 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -255,9 +255,9 @@ function TldrawEditorWithReadyStore({
 	store,
 	tools,
 	shapeUtils,
-	autoFocus,
 	user,
 	initialState,
+	autoFocus = true,
 	inferDarkMode,
 }: Required<
 	TldrawEditorProps & {
@@ -338,11 +338,11 @@ function TldrawEditorWithReadyStore({
 function Layout({
 	children,
 	onMount,
-	autoFocus = false,
+	autoFocus,
 }: {
 	children: any
+	autoFocus: boolean
 	onMount?: TLOnMountHandler
-	autoFocus?: boolean
 }) {
 	useZoomCss()
 	useCursor()
@@ -353,6 +353,9 @@ function Layout({
 	useOnMount(onMount)
 	useDPRMultiple()
 
+	const editor = useEditor()
+	editor.updateViewportScreenBounds()
+
 	return children ?? <Canvas />
 }
 

commit d715fa3a2e1feb0c0e5043f6429792ae6397882f
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Wed Oct 4 10:01:48 2023 +0100

    [fix] Focus events (actually) (#2015)
    
    This PR restores the controlled nature of focus. Focus allows keyboard
    shortcuts and other interactions to occur. The editor's focus should
    always / entirely be controlled via the autoFocus prop or by manually
    setting `editor.instanceState.isFocused`.
    
    Design note: I'm starting to think that focus is the wrong abstraction,
    and that we should instead use a kind of "disabled" state for editors
    that the user isn't interacting with directly. In a page where multiple
    editors exit (e.g. a notion page), a developer could switch from
    disabled to enabled using a first interaction.
    
    ### Change Type
    
    - [x] `patch` — Bug fix
    
    ### Test Plan
    
    - [x] End to end tests

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index a838773d4..416433c18 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -123,7 +123,7 @@ export interface TldrawEditorBaseProps {
  *
  * @public
  */
-export type TLOnMountHandler = (editor: Editor) => (() => void) | undefined | void
+export type TLOnMountHandler = (editor: Editor) => (() => void | undefined) | undefined | void
 
 declare global {
 	interface Window {
@@ -162,7 +162,7 @@ export const TldrawEditor = memo(function TldrawEditor({
 			ref={rContainer}
 			draggable={false}
 			className={classNames('tl-container tl-theme__light', className)}
-			tabIndex={0}
+			tabIndex={-1}
 		>
 			<OptionalErrorBoundary
 				fallback={ErrorFallback}

commit 3b7acb8997ae2cef0ce0a443685c76b51c112d2f
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Tue Oct 17 14:06:53 2023 +0100

    [fix] Context menu + menus not closing correctly (#2086)
    
    This PR fixes a bug that causes menus not to close correctly when open.
    
    ### Change Type
    
    - [x] `patch` — Bug fix
    
    ### Test Plan
    
    1. On mobile, open the menu.
    2. Tap the canvas—it should close the panel.
    3. Open the mobile style panel.
    4. Tap the canvas—it should close the panel.
    5. Open the mobile style panel.
    6. Tap the mobile style panel button—it should close the panel.
    7. On mobile, long press to open the context menu
    
    ### Release Notes
    
    - [fix] bug with menus

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index 416433c18..34560c835 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -34,6 +34,7 @@ import { useForceUpdate } from './hooks/useForceUpdate'
 import { useLocalStore } from './hooks/useLocalStore'
 import { useSafariFocusOutFix } from './hooks/useSafariFocusOutFix'
 import { useZoomCss } from './hooks/useZoomCss'
+import { stopEventPropagation } from './utils/dom'
 import { TLStoreWithStatus } from './utils/sync/StoreWithStatus'
 
 /**
@@ -162,6 +163,7 @@ export const TldrawEditor = memo(function TldrawEditor({
 			ref={rContainer}
 			draggable={false}
 			className={classNames('tl-container tl-theme__light', className)}
+			onPointerDown={stopEventPropagation}
 			tabIndex={-1}
 		>
 			<OptionalErrorBoundary

commit 5db3c1553e14edd14aa5f7c0fc85fc5efc352335
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Mon Nov 13 11:51:22 2023 +0000

    Replace Atom.value with Atom.get() (#2189)
    
    This PR replaces the `.value` getter for the atom with `.get()`
    
    ### Change Type
    
    - [x] `major` — Breaking change
    
    ---------
    
    Co-authored-by: David Sheldrick <d.j.sheldrick@gmail.com>

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index 34560c835..3959b5900 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -221,11 +221,11 @@ const TldrawEditorWithLoadingStore = memo(function TldrawEditorBeforeLoading({
 	const container = useContainer()
 
 	useLayoutEffect(() => {
-		if (user.userPreferences.value.isDarkMode) {
+		if (user.userPreferences.get().isDarkMode) {
 			container.classList.remove('tl-theme__light')
 			container.classList.add('tl-theme__dark')
 		}
-	}, [container, user.userPreferences.value.isDarkMode])
+	}, [container, user])
 
 	switch (store.status) {
 		case 'error': {

commit dc0f6ae0f25518342de828498998c5c7241da7b0
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Tue Nov 14 16:32:27 2023 +0000

    No impure getters pt8 (#2221)
    
    follow up to #2189
    ### Change Type
    
    - [x] `patch` — Bug fix

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index 3959b5900..f33ed7f3b 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -304,7 +304,7 @@ function TldrawEditorWithReadyStore({
 			},
 			[editor]
 		),
-		() => editor?.crashingError ?? null
+		() => editor?.getCrashingError() ?? null
 	)
 
 	if (!editor) {

commit 14e8d19a713fb21c3f976a15cdbdf0dd05167366
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Wed Nov 15 18:06:02 2023 +0000

    Custom Tools DX + screenshot example (#2198)
    
    This PR adds a custom tool example, the `Screenshot Tool`.
    
    It demonstrates how a user can create a custom tool together with custom
    tool UI.
    
    ### Change Type
    
    - [x] `minor` — New feature
    
    ### Test Plan
    
    1. Use the screenshot example
    
    ### Release Notes
    
    - adds ScreenshotTool custom tool example
    - improvements and new exports related to copying and exporting images /
    files
    - loosens up types around icons and translations
    - moving `StateNode.isActive` into an atom
    - adding `Editor.path`

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index f33ed7f3b..b9be45ef2 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -86,7 +86,7 @@ export interface TldrawEditorBaseProps {
 	/**
 	 * Overrides for the editor's components, such as handles, collaborator cursors, etc.
 	 */
-	components?: Partial<TLEditorComponents>
+	components?: TLEditorComponents
 
 	/**
 	 * Called when the editor has mounted.

commit 39a65b9c96dc89546c31f9b23822ad4aefe742c9
Author: Mitja Bezenšek <mitja.bezensek@gmail.com>
Date:   Fri Dec 1 12:56:08 2023 +0100

    Add connecting screen override. (#2273)
    
    Adds a `LoadingScreen` override option.
    
    Resolves https://github.com/tldraw/tldraw/issues/2269
    
    ### Change Type
    
    - [ ] `patch` — Bug fix
    - [x] `minor` — New feature
    - [ ] `major` — Breaking change
    - [ ] `dependencies` — Changes to package dependencies[^1]
    - [ ] `documentation` — Changes to the documentation only[^2]
    - [ ] `tests` — Changes to any test code only[^2]
    - [ ] `internal` — Any other changes that don't affect the published
    package[^2]
    - [ ] I don't know
    
    [^1]: publishes a `patch` release, for devDependencies use `internal`
    [^2]: will not publish a new version
    
    ### Test Plan
    
    1. Add a step-by-step description of how to test your PR here.
    2.
    
    - [ ] Unit Tests
    - [ ] End to end tests
    
    ### Release Notes
    
    - Allow users to customize the connecting screen.

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index b9be45ef2..383562642 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -14,6 +14,7 @@ import classNames from 'classnames'
 import { Canvas } from './components/Canvas'
 import { OptionalErrorBoundary } from './components/ErrorBoundary'
 import { DefaultErrorFallback } from './components/default-components/DefaultErrorFallback'
+import { DefaultLoadingScreen } from './components/default-components/DefaultLoadingScreen'
 import { TLUser, createTLUser } from './config/createTLUser'
 import { TLAnyShapeUtilConstructor } from './config/defaultShapes'
 import { Editor } from './editor/Editor'
@@ -156,6 +157,7 @@ export const TldrawEditor = memo(function TldrawEditor({
 		...rest,
 		shapeUtils: rest.shapeUtils ?? EMPTY_SHAPE_UTILS_ARRAY,
 		tools: rest.tools ?? EMPTY_TOOLS_ARRAY,
+		components,
 	}
 
 	return (
@@ -235,7 +237,8 @@ const TldrawEditorWithLoadingStore = memo(function TldrawEditorBeforeLoading({
 			throw store.error
 		}
 		case 'loading': {
-			return <LoadingScreen>Connecting...</LoadingScreen>
+			const LoadingScreen = rest.components?.LoadingScreen ?? DefaultLoadingScreen
+			return <LoadingScreen />
 		}
 		case 'not-synced': {
 			break

commit 390c45c7eb61555454b9ce5e3a4d4be1852af870
Author: alex <alex@dytry.ch>
Date:   Fri Dec 1 16:48:30 2023 +0000

    fix vite HMR issue (#2279)
    
    This is an attempt at #1989. The big issue there is when `shapeUtils`
    change when you're relying on tldraw to provide you with the store
    instead of providing your own. Our `useTLStore` component had a bug
    where it would rely on effects & a ref to detect when its options had
    changed whilst still scheduling updates. Fresh opts would come in, but
    they'd be different from the ones in the ref, so we'd schedule an
    update, so the opts would come in again, but they'd still be different
    as we hadn't run effects yet, and we'd schedule an update again (and so
    on).
    
    This diff fixes that by storing the previous opts in state instead of a
    ref, so they're updating in lockstep with the store itself. this
    prevents the update loop.
    
    There are still situations where we can get into loops if the developer
    is passing in custom tools, shapeUtils, or components but not memoising
    them or defining them outside of react. As a DX improvement, we do some
    auto-memoisation of these values using shallow equality to help with
    this issue.
    
    ### Change Type
    
    - [x] `patch` — Bug fix
    
    
    ### Test Plan
    
    - [x] Unit Tests
    
    ### Release Notes
    
    - Fixes a bug that could cause crashes due to a re-render loop with HMR
    #1989

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index 383562642..5e26a4855 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -144,7 +144,7 @@ export const TldrawEditor = memo(function TldrawEditor({
 	user: _user,
 	...rest
 }: TldrawEditorProps) {
-	const [container, rContainer] = React.useState<HTMLDivElement | null>(null)
+	const [container, setContainer] = React.useState<HTMLDivElement | null>(null)
 	const user = useMemo(() => _user ?? createTLUser(), [_user])
 
 	const ErrorFallback =
@@ -162,7 +162,7 @@ export const TldrawEditor = memo(function TldrawEditor({
 
 	return (
 		<div
-			ref={rContainer}
+			ref={setContainer}
 			draggable={false}
 			className={classNames('tl-container tl-theme__light', className)}
 			onPointerDown={stopEventPropagation}

commit 8eba6704df998e21adff0b3a296e29b992492d6e
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Wed Jan 17 10:44:40 2024 +0000

    Prevent overlay content disappearing at some browser zoom levels (#2483)
    
    This essentially reverts the change from #1858 – it seems to be no
    longer necessary after we applied the transforms to each overlay item
    individually rather than applying a single transform to the outer
    container.
    
    This fixes an issue where at certain zoom levels, overlay elements would
    disappear when their parent div/svg (that we use for positioning) went
    offscreen while their overflowing contents (the stuff you could see) did
    not.
    
    todos before merging
    - [ ] test on android and ios
    - [ ] test on windows
    
    
    ### Change Type
    
    - [x] `patch` — Bug fix
    
    [^1]: publishes a `patch` release, for devDependencies use `internal`
    [^2]: will not publish a new version
    
    ### Release Notes
    
    - removes the internal `useDprMultiple` hook

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index 5e26a4855..550440ef5 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -21,7 +21,6 @@ import { Editor } from './editor/Editor'
 import { TLStateNodeConstructor } from './editor/tools/StateNode'
 import { ContainerProvider, useContainer } from './hooks/useContainer'
 import { useCursor } from './hooks/useCursor'
-import { useDPRMultiple } from './hooks/useDPRMultiple'
 import { useDarkMode } from './hooks/useDarkMode'
 import { EditorContext, useEditor } from './hooks/useEditor'
 import {
@@ -356,7 +355,6 @@ function Layout({
 	useForceUpdate()
 	useFocusEvents(autoFocus)
 	useOnMount(onMount)
-	useDPRMultiple()
 
 	const editor = useEditor()
 	editor.updateViewportScreenBounds()

commit 79460cbf3a1084ac5b49e41d1e2570e4eee98e82
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Mon Feb 12 15:03:25 2024 +0000

    Use canvas bounds for viewport bounds (#2798)
    
    This PR changes the way that viewport bounds are calculated by using the
    canvas element as the source of truth, rather than the container. This
    allows for cases where the canvas is not the same dimensions as the
    component. (Given the way our UI and context works, there are cases
    where this is desired, i.e. toolbars and other items overlaid on top of
    the canvas area).
    
    The editor's `getContainer` is now only used for the text measurement.
    It would be good to get that out somehow.
    
    # Pros
    
    We can inset the canvas
    
    # Cons
    
    We can no longer imperatively call `updateScreenBounds`, as we need to
    provide those bounds externally.
    
    ### Change Type
    
    - [x] `major` — Breaking change
    
    ### Test Plan
    
    1. Use the examples, including the new inset canvas example.
    
    - [x] Unit Tests
    
    ### Release Notes
    
    - Changes the source of truth for the viewport page bounds to be the
    canvas instead.

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index 550440ef5..e174a6700 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -356,9 +356,6 @@ function Layout({
 	useFocusEvents(autoFocus)
 	useOnMount(onMount)
 
-	const editor = useEditor()
-	editor.updateViewportScreenBounds()
-
 	return children ?? <Canvas />
 }
 

commit 9fc5f4459f674b121cc177f8ae99efa9fdb442c8
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Mon Feb 19 14:52:43 2024 +0000

    Roundup fixes (#2862)
    
    This one is a roundup of superficial changes, apologies for having them
    in a single PR.
    
    This PR:
    - does some chair re-arranging for one of our hotter paths related to
    updating shapes
    - changes our type exports for editor components
    - adds shape indicator to editor components
    - moves canvas to be an editor component
    - fixes a CSS bug with hinted buttons
    - fixes CSS bugs with the menus
    - fixes bad imports in examples
    
    ### Change Type
    
    - [x] `major`

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index e174a6700..fff13cf47 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -11,7 +11,6 @@ import React, {
 } from 'react'
 
 import classNames from 'classnames'
-import { Canvas } from './components/Canvas'
 import { OptionalErrorBoundary } from './components/ErrorBoundary'
 import { DefaultErrorFallback } from './components/default-components/DefaultErrorFallback'
 import { DefaultLoadingScreen } from './components/default-components/DefaultLoadingScreen'
@@ -309,6 +308,8 @@ function TldrawEditorWithReadyStore({
 		() => editor?.getCrashingError() ?? null
 	)
 
+	const { Canvas } = useEditorComponents()
+
 	if (!editor) {
 		return null
 	}
@@ -331,7 +332,7 @@ function TldrawEditorWithReadyStore({
 			) : (
 				<EditorContext.Provider value={editor}>
 					<Layout autoFocus={autoFocus} onMount={onMount}>
-						{children}
+						{children ?? (Canvas ? <Canvas /> : null)}
 					</Layout>
 				</EditorContext.Provider>
 			)}
@@ -356,7 +357,7 @@ function Layout({
 	useFocusEvents(autoFocus)
 	useOnMount(onMount)
 
-	return children ?? <Canvas />
+	return <>{children}</>
 }
 
 function Crash({ crashingError }: { crashingError: unknown }): null {

commit ad902be5e64ffc771a2d9ef01b6a310f0dd5b30f
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Sun Feb 25 11:16:10 2024 +0000

    Expand props (#2948)
    
    This PR expands the tldraw / tldraweditor component props.
    
    ### Change Type
    
    - [x] `patch` — Bug fix

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index fff13cf47..a42db8b12 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -1,6 +1,6 @@
 import { SerializedStore, Store, StoreSnapshot } from '@tldraw/store'
 import { TLRecord, TLStore } from '@tldraw/tlschema'
-import { Required, annotateError } from '@tldraw/utils'
+import { Expand, Required, annotateError } from '@tldraw/utils'
 import React, {
 	memo,
 	useCallback,
@@ -41,20 +41,22 @@ import { TLStoreWithStatus } from './utils/sync/StoreWithStatus'
  *
  * @public
  **/
-export type TldrawEditorProps = TldrawEditorBaseProps &
-	(
-		| {
-				store: TLStore | TLStoreWithStatus
-		  }
-		| {
-				store?: undefined
-				snapshot?: StoreSnapshot<TLRecord>
-				initialData?: SerializedStore<TLRecord>
-				persistenceKey?: string
-				sessionId?: string
-				defaultName?: string
-		  }
-	)
+export type TldrawEditorProps = Expand<
+	TldrawEditorBaseProps &
+		(
+			| {
+					store: TLStore | TLStoreWithStatus
+			  }
+			| {
+					store?: undefined
+					snapshot?: StoreSnapshot<TLRecord>
+					initialData?: SerializedStore<TLRecord>
+					persistenceKey?: string
+					sessionId?: string
+					defaultName?: string
+			  }
+		)
+>
 
 /**
  * Base props for the {@link @tldraw/tldraw#Tldraw} and {@link TldrawEditor} components.

commit d88ce929eb9ff80eb26a360caf8a431033791d73
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Tue Feb 27 09:30:02 2024 +0000

    [fix] double spinner (#2963)
    
    Fixes a double spinner in the loading component.
    
    ### Change Type
    
    - [x] `patch` — Bug fix

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index a42db8b12..13097665c 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -13,7 +13,6 @@ import React, {
 import classNames from 'classnames'
 import { OptionalErrorBoundary } from './components/ErrorBoundary'
 import { DefaultErrorFallback } from './components/default-components/DefaultErrorFallback'
-import { DefaultLoadingScreen } from './components/default-components/DefaultLoadingScreen'
 import { TLUser, createTLUser } from './config/createTLUser'
 import { TLAnyShapeUtilConstructor } from './config/defaultShapes'
 import { Editor } from './editor/Editor'
@@ -229,6 +228,8 @@ const TldrawEditorWithLoadingStore = memo(function TldrawEditorBeforeLoading({
 		}
 	}, [container, user])
 
+	const { LoadingScreen } = useEditorComponents()
+
 	switch (store.status) {
 		case 'error': {
 			// for error handling, we fall back to the default error boundary.
@@ -237,8 +238,7 @@ const TldrawEditorWithLoadingStore = memo(function TldrawEditorBeforeLoading({
 			throw store.error
 		}
 		case 'loading': {
-			const LoadingScreen = rest.components?.LoadingScreen ?? DefaultLoadingScreen
-			return <LoadingScreen />
+			return LoadingScreen ? <LoadingScreen /> : null
 		}
 		case 'not-synced': {
 			break
@@ -368,14 +368,7 @@ function Crash({ crashingError }: { crashingError: unknown }): null {
 
 /** @public */
 export function LoadingScreen({ children }: { children: any }) {
-	const { Spinner } = useEditorComponents()
-
-	return (
-		<div className="tl-loading">
-			{Spinner ? <Spinner /> : null}
-			{children}
-		</div>
-	)
+	return <div className="tl-loading">{children}</div>
 }
 
 /** @public */

commit ae531da193278560bc6a33c4e8c6ce9c9f7d22e6
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Thu Feb 29 15:42:36 2024 +0000

    Don't add editor / app to window. (#2995)
    
    This PR removes code that would add a reference to the editor to the
    window. This is a feature that we added very early on during testing,
    but which we should have moved out of the library earlier. Adding it
    here as one of our last PRs before release.
    
    If you've relied on this, you'll need to update your use of the library
    to do it manually:
    
    ```ts
    <Tldraw onMount={(editor) => {
      ;(window as any).app = editor
      ;(window as any).editor = editor
    }}/>
    ```
    
    ### Change Type
    
    - [x] `major` — Breaking change
    
    ### Release Notes
    
    - Remove `window.editor` and `window.app` references to editor.

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index 13097665c..4e9dc559b 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -285,8 +285,6 @@ function TldrawEditorWithReadyStore({
 			initialState,
 			inferDarkMode,
 		})
-		;(window as any).app = editor
-		;(window as any).editor = editor
 		setEditor(editor)
 
 		return () => {

commit a0628f9cb2715efa33b57a951d73b77eda961873
Author: alex <alex@dytry.ch>
Date:   Thu Feb 29 16:06:19 2024 +0000

    tldraw_final_v6_final(old version).docx.pdf (#2998)
    
    Rename `@tldraw/tldraw` to just `tldraw`! `@tldraw/tldraw` still exists
    as an alias to `tldraw` for folks who are still using that.
    
    ### Test Plan
    
    - [x] Unit Tests
    - [ ] End to end tests
    
    ### Release Notes
    
    - The `@tldraw/tldraw` package has been renamed to `tldraw`. You can
    keep using the old version if you want though!

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index 4e9dc559b..b4e67ce96 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -36,7 +36,7 @@ import { stopEventPropagation } from './utils/dom'
 import { TLStoreWithStatus } from './utils/sync/StoreWithStatus'
 
 /**
- * Props for the {@link @tldraw/tldraw#Tldraw} and {@link TldrawEditor} components.
+ * Props for the {@link tldraw#Tldraw} and {@link TldrawEditor} components.
  *
  * @public
  **/
@@ -58,7 +58,7 @@ export type TldrawEditorProps = Expand<
 >
 
 /**
- * Base props for the {@link @tldraw/tldraw#Tldraw} and {@link TldrawEditor} components.
+ * Base props for the {@link tldraw#Tldraw} and {@link TldrawEditor} components.
  *
  * @public
  */
@@ -151,7 +151,7 @@ export const TldrawEditor = memo(function TldrawEditor({
 
 	// apply defaults. if you're using the bare @tldraw/editor package, we
 	// default these to the "tldraw zero" configuration. We have different
-	// defaults applied in @tldraw/tldraw.
+	// defaults applied in tldraw.
 	const withDefaults = {
 		...rest,
 		shapeUtils: rest.shapeUtils ?? EMPTY_SHAPE_UTILS_ARRAY,

commit 15c760f7ea9523c7f52aef48c8ca0f1563f774a6
Author: alex <alex@dytry.ch>
Date:   Mon Mar 4 14:48:40 2024 +0000

    children: any -> children: ReactNode (#3061)
    
    We use `children: any` in a bunch of places, but the proper type for
    these is `ReactNode`. This diff fixes those.
    
    ### Change Type
    
    - [x] `patch` — Bug fix

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index b4e67ce96..976415fa5 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -2,6 +2,7 @@ import { SerializedStore, Store, StoreSnapshot } from '@tldraw/store'
 import { TLRecord, TLStore } from '@tldraw/tlschema'
 import { Expand, Required, annotateError } from '@tldraw/utils'
 import React, {
+	ReactNode,
 	memo,
 	useCallback,
 	useLayoutEffect,
@@ -66,7 +67,7 @@ export interface TldrawEditorBaseProps {
 	/**
 	 * The component's children.
 	 */
-	children?: any
+	children?: ReactNode
 
 	/**
 	 * An array of shape utils to use in the editor.
@@ -345,7 +346,7 @@ function Layout({
 	onMount,
 	autoFocus,
 }: {
-	children: any
+	children: ReactNode
 	autoFocus: boolean
 	onMount?: TLOnMountHandler
 }) {
@@ -365,12 +366,12 @@ function Crash({ crashingError }: { crashingError: unknown }): null {
 }
 
 /** @public */
-export function LoadingScreen({ children }: { children: any }) {
+export function LoadingScreen({ children }: { children: ReactNode }) {
 	return <div className="tl-loading">{children}</div>
 }
 
 /** @public */
-export function ErrorScreen({ children }: { children: any }) {
+export function ErrorScreen({ children }: { children: ReactNode }) {
 	return <div className="tl-loading">{children}</div>
 }
 

commit 4f70a4f4e85b278e79a4afadec2eeb08f26879a8
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Mon Apr 15 13:53:42 2024 +0100

    New migrations again (#3220)
    
    Describe what your pull request does. If appropriate, add GIFs or images
    showing the before and after.
    
    ### Change Type
    
    - [x] `sdk` — Changes the tldraw SDK
    - [x] `galaxy brain` — Architectural changes
    
    
    
    ### Test Plan
    
    1. Add a step-by-step description of how to test your PR here.
    2.
    
    - [ ] Unit Tests
    - [ ] End to end tests
    
    ### Release Notes
    
    #### BREAKING CHANGES
    
    - The `Migrations` type is now called `LegacyMigrations`.
    - The serialized schema format (e.g. returned by
    `StoreSchema.serialize()` and `Store.getSnapshot()`) has changed. You
    don't need to do anything about it unless you were reading data directly
    from the schema for some reason. In which case it'd be best to avoid
    that in the future! We have no plans to change the schema format again
    (this time was traumatic enough) but you never know.
    - `compareRecordVersions` and the `RecordVersion` type have both
    disappeared. There is no replacement. These were public by mistake
    anyway, so hopefully nobody had been using it.
    - `compareSchemas` is a bit less useful now. Our migrations system has
    become a little fuzzy to allow for simpler UX when adding/removing
    custom extensions and 3rd party dependencies, and as a result we can no
    longer compare serialized schemas in any rigorous manner. You can rely
    on this function to return `0` if the schemas are the same. Otherwise it
    will return `-1` if the schema on the right _seems_ to be newer than the
    schema on the left, but it cannot guarantee that in situations where
    migration sequences have been removed over time (e.g. if you remove one
    of the builtin tldraw shapes).
    
    Generally speaking, the best way to check schema compatibility now is to
    call `store.schema.getMigrationsSince(persistedSchema)`. This will throw
    an error if there is no upgrade path from the `persistedSchema` to the
    current version.
    
    - `defineMigrations` has been deprecated and will be removed in a future
    release. For upgrade instructions see
    https://tldraw.dev/docs/persistence#Updating-legacy-shape-migrations-defineMigrations
    
    - `migrate` has been removed. Nobody should have been using this but if
    you were you'll need to find an alternative. For migrating tldraw data,
    you should stick to using `schema.migrateStoreSnapshot` and, if you are
    building a nuanced sync engine that supports some amount of backwards
    compatibility, also feel free to use `schema.migratePersistedRecord`.
    - the `Migration` type has changed. If you need the old one for some
    reason it has been renamed to `LegacyMigration`. It will be removed in a
    future release.
    - the `Migrations` type has been renamed to `LegacyMigrations` and will
    be removed in a future release.
    - the `SerializedSchema` type has been augmented. If you need the old
    version specifically you can use `SerializedSchemaV1`
    
    ---------
    
    Co-authored-by: Steve Ruiz <steveruizok@gmail.com>

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index 976415fa5..32e47764d 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -1,4 +1,4 @@
-import { SerializedStore, Store, StoreSnapshot } from '@tldraw/store'
+import { MigrationSequence, SerializedStore, Store, StoreSnapshot } from '@tldraw/store'
 import { TLRecord, TLStore } from '@tldraw/tlschema'
 import { Expand, Required, annotateError } from '@tldraw/utils'
 import React, {
@@ -49,6 +49,7 @@ export type TldrawEditorProps = Expand<
 			  }
 			| {
 					store?: undefined
+					migrations?: readonly MigrationSequence[]
 					snapshot?: StoreSnapshot<TLRecord>
 					initialData?: SerializedStore<TLRecord>
 					persistenceKey?: string

commit 8151e6f586149e4447149d25bd70868a5a4e8838
Author: alex <alex@dytry.ch>
Date:   Wed Apr 24 19:26:10 2024 +0100

    Automatic undo/redo (#3364)
    
    Our undo-redo system before this diff is based on commands. A command
    is:
    - A function that produces some data required to perform and undo a
    change
    - A function that actually performs the change, based on the data
    - Another function that undoes the change, based on the data
    - Optionally, a function to _redo_ the change, although in practice we
    never use this
    
    Each command that gets run is added to the undo/redo stack unless it
    says it shouldn't be.
    
    This diff replaces this system of commands with a new one where all
    changes to the store are automatically recorded in the undo/redo stack.
    You can imagine the new history manager like a tape recorder - it
    automatically records everything that happens to the store in a special
    diff, unless you "pause" the recording and ask it not to. Undo and redo
    rewind/fast-forward the tape to certain marks.
    
    As the command concept is gone, the things that were commands are now
    just functions that manipulate the store.
    
    One other change here is that the store's after-phase callbacks (and the
    after-phase side-effects as a result) are now batched up and called at
    the end of certain key operations. For example, `applyDiff` would
    previously call all the `afterCreate` callbacks before making any
    removals from the diff. Now, it (and anything else that uses
    `store.atomic(fn)` will defer firing any after callbacks until the end
    of an operation. before callbacks are still called part-way through
    operations.
    
    ## Design options
    Automatic recording is a fairly large big semantic change, particularly
    to the standalone `store.put`/`store.remove` etc. commands. We could
    instead make not-recording the default, and make recording opt-in
    instead. However, I think auto-record-by-default is the right choice for
    a few reasons:
    
    1. Switching to a recording-based vs command-based undo-redo model is
    fundamentally a big semantic change. In the past, `store.put` etc. were
    always ignored. Now, regardless of whether we choose record-by-default
    or ignore-by-default, the behaviour of `store.put` is _context_
    dependant.
    2. Switching to ignore-by-default means that either our commands don't
    record undo/redo history any more (unless wrapped in
    `editor.history.record`, a far larger semantic change) or they have to
    always-record/all accept a history options bag. If we choose
    always-record, we can't use commands within `history.ignore` as they'll
    start recording again. If we choose the history options bag, we have to
    accept those options in 10s of methods - basically the entire `Editor`
    api surface.
    
    Overall, given that some breaking semantic change here is unavoidable, I
    think that record-by-default hits the right balance of tradeoffs. I
    think it's a better API going forward, whilst also not being too
    disruptive as the APIs it affects are very "deep" ones that we don't
    typically encourage people to use.
    
    
    
    ### Change Type
    
    - [x] `sdk` — Changes the tldraw SDK
    - [x] `improvement` — Improving existing features
    - [x] `galaxy brain` — Architectural changes
    
    ### Release Note
    #### Breaking changes
    ##### 1. History Options
    Previously, some (not all!) commands accepted a history options object
    with `squashing`, `ephemeral`, and `preserveRedoStack` flags. Squashing
    enabled/disabled a memory optimisation (storing individual commands vs
    squashing them together). Ephemeral stopped a command from affecting the
    undo/redo stack at all. Preserve redo stack stopped commands from wiping
    the redo stack. These flags were never available consistently - some
    commands had them and others didn't.
    
    In this version, most of these flags have been removed. `squashing` is
    gone entirely (everything squashes & does so much faster than before).
    There were a couple of commands that had a special default - for
    example, `updateInstanceState` used to default to being `ephemeral`.
    Those maintain the defaults, but the options look a little different now
    - `{ephemeral: true}` is now `{history: 'ignore'}` and
    `{preserveRedoStack: true}` is now `{history:
    'record-preserveRedoStack'}`.
    
    If you were previously using these options in places where they've now
    been removed, you can use wrap them with `editor.history.ignore(fn)` or
    `editor.history.batch(fn, {history: 'record-preserveRedoStack'})`. For
    example,
    ```ts
    editor.nudgeShapes(..., { ephemeral: true })
    ```
    can now be written as
    ```ts
    editor.history.ignore(() => {
        editor.nudgeShapes(...)
    })
    ```
    
    ##### 2. Automatic recording
    Previously, only commands (e.g. `editor.updateShapes` and things that
    use it) were added to the undo/redo stack. Everything else (e.g.
    `editor.store.put`) wasn't. Now, _everything_ that touches the store is
    recorded in the undo/redo stack (unless it's part of
    `mergeRemoteChanges`). You can use `editor.history.ignore(fn)` as above
    if you want to make other changes to the store that aren't recorded -
    this is short for `editor.history.batch(fn, {history: 'ignore'})`
    
    When upgrading to this version of tldraw, you shouldn't need to change
    anything unless you're using `store.put`, `store.remove`, or
    `store.applyDiff` outside of `store.mergeRemoteChanges`. If you are, you
    can preserve the functionality of those not being recorded by wrapping
    them either in `mergeRemoteChanges` (if they're multiplayer-related) or
    `history.ignore` as appropriate.
    
    ##### 3. Side effects
    Before this diff, any changes in side-effects weren't captured by the
    undo-redo stack. This was actually the motivation for this change in the
    first place! But it's a pretty big change, and if you're using side
    effects we recommend you double-check how they interact with undo/redo
    before/after this change. To get the old behaviour back, wrap your side
    effects in `editor.history.ignore`.
    
    ##### 4. Mark options
    Previously, `editor.mark(id)` accepted two additional boolean
    parameters: `onUndo` and `onRedo`. If these were set to false, then when
    undoing or redoing we'd skip over that mark and keep going until we
    found one with those values set to true. We've removed those options -
    if you're using them, let us know and we'll figure out an alternative!

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index 32e47764d..87ea9b1fe 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -380,8 +380,11 @@ function useOnMount(onMount?: TLOnMountHandler) {
 	const editor = useEditor()
 
 	const onMountEvent = useEvent((editor: Editor) => {
-		const teardown = onMount?.(editor)
-		editor.emit('mount')
+		let teardown: (() => void) | void = undefined
+		editor.history.ignore(() => {
+			teardown = onMount?.(editor)
+			editor.emit('mount')
+		})
 		window.tldrawReady = true
 		return teardown
 	})

commit fabba66c0f4b6c42ece30f409e70eb01e588f8e1
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Sat May 4 18:39:04 2024 +0100

    Camera options (#3282)
    
    This PR implements a camera options API.
    
    - [x] Initial PR
    - [x] Updated unit tests
    - [x] Feedback / review
    - [x] New unit tests
    - [x] Update use-case examples
    - [x] Ship?
    
    ## Public API
    
    A user can provide camera options to the `Tldraw` component via the
    `cameraOptions` prop. The prop is also available on the `TldrawEditor`
    component and the constructor parameters of the `Editor` class.
    
    ```tsx
    export default function CameraOptionsExample() {
            return (
                    <div className="tldraw__editor">
                            <Tldraw cameraOptions={CAMERA_OPTIONS} />
                    </div>
            )
    }
    ```
    
    At runtime, a user can:
    -  get the current camera options with `Editor.getCameraOptions`
    -  update the camera options with `Editor.setCameraOptions`
    
    Setting the camera options automatically applies them to the current
    camera.
    
    ```ts
    editor.setCameraOptions({...editor.getCameraOptions(), isLocked: true })
    ```
    
    A user can get the "camera fit zoom" via `editor.getCameraFitZoom()`.
    
    # Interface
    
    The camera options themselves can look a few different ways depending on
    the `type` provided.
    
    
    ```tsx
    export type TLCameraOptions = {
            /** Whether the camera is locked. */
            isLocked: boolean
            /** The speed of a scroll wheel / trackpad pan. Default is 1. */
            panSpeed: number
            /** The speed of a scroll wheel / trackpad zoom. Default is 1. */
            zoomSpeed: number
            /** The steps that a user can zoom between with zoom in / zoom out. The first and last value will determine the min and max zoom. */
            zoomSteps: number[]
            /** Controls whether the wheel pans or zooms.
             *
             * - `zoom`: The wheel will zoom in and out.
             * - `pan`: The wheel will pan the camera.
             * - `none`: The wheel will do nothing.
             */
            wheelBehavior: 'zoom' | 'pan' | 'none'
            /** The camera constraints. */
            constraints?: {
                    /** The bounds (in page space) of the constrained space */
                    bounds: BoxModel
                    /** The padding inside of the viewport (in screen space) */
                    padding: VecLike
                    /** The origin for placement. Used to position the bounds within the viewport when an axis is fixed or contained and zoom is below the axis fit. */
                    origin: VecLike
                    /** The camera's initial zoom, used also when the camera is reset.
                     *
                     * - `default`: Sets the initial zoom to 100%.
                     * - `fit-x`: The x axis will completely fill the viewport bounds.
                     * - `fit-y`: The y axis will completely fill the viewport bounds.
                     * - `fit-min`: The smaller axis will completely fill the viewport bounds.
                     * - `fit-max`: The larger axis will completely fill the viewport bounds.
                     * - `fit-x-100`: The x axis will completely fill the viewport bounds, or 100% zoom, whichever is smaller.
                     * - `fit-y-100`: The y axis will completely fill the viewport bounds, or 100% zoom, whichever is smaller.
                     * - `fit-min-100`: The smaller axis will completely fill the viewport bounds, or 100% zoom, whichever is smaller.
                     * - `fit-max-100`: The larger axis will completely fill the viewport bounds, or 100% zoom, whichever is smaller.
                     */
                    initialZoom:
                            | 'fit-min'
                            | 'fit-max'
                            | 'fit-x'
                            | 'fit-y'
                            | 'fit-min-100'
                            | 'fit-max-100'
                            | 'fit-x-100'
                            | 'fit-y-100'
                            | 'default'
                    /** The camera's base for its zoom steps.
                     *
                     * - `default`: Sets the initial zoom to 100%.
                     * - `fit-x`: The x axis will completely fill the viewport bounds.
                     * - `fit-y`: The y axis will completely fill the viewport bounds.
                     * - `fit-min`: The smaller axis will completely fill the viewport bounds.
                     * - `fit-max`: The larger axis will completely fill the viewport bounds.
                     * - `fit-x-100`: The x axis will completely fill the viewport bounds, or 100% zoom, whichever is smaller.
                     * - `fit-y-100`: The y axis will completely fill the viewport bounds, or 100% zoom, whichever is smaller.
                     * - `fit-min-100`: The smaller axis will completely fill the viewport bounds, or 100% zoom, whichever is smaller.
                     * - `fit-max-100`: The larger axis will completely fill the viewport bounds, or 100% zoom, whichever is smaller.
                     */
                    baseZoom:
                            | 'fit-min'
                            | 'fit-max'
                            | 'fit-x'
                            | 'fit-y'
                            | 'fit-min-100'
                            | 'fit-max-100'
                            | 'fit-x-100'
                            | 'fit-y-100'
                            | 'default'
                    /** The behavior for the constraints for both axes or each axis individually.
                     *
                     * - `free`: The bounds are ignored when moving the camera.
                     * - 'fixed': The bounds will be positioned within the viewport based on the origin
                     * - `contain`: The 'fixed' behavior will be used when the zoom is below the zoom level at which the bounds would fill the viewport; and when above this zoom, the bounds will use the 'inside' behavior.
                     * - `inside`: The bounds will stay completely within the viewport.
                     * - `outside`: The bounds will stay touching the viewport.
                     */
                    behavior:
                            | 'free'
                            | 'fixed'
                            | 'inside'
                            | 'outside'
                            | 'contain'
                            | {
                                            x: 'free' | 'fixed' | 'inside' | 'outside' | 'contain'
                                            y: 'free' | 'fixed' | 'inside' | 'outside' | 'contain'
                              }
            }
    }
    ```
    
    ### Change Type
    
    - [x] `sdk` — Changes the tldraw SDK
    - [x] `feature` — New feature
    
    ### Test Plan
    
    These features combine in different ways, so we'll want to write some
    more tests to find surprises.
    
    1. Add a step-by-step description of how to test your PR here.
    2.
    
    - [ ] Unit Tests
    
    ### Release Notes
    
    - SDK: Adds camera options.
    
    ---------
    
    Co-authored-by: Mitja Bezenšek <mitja.bezensek@gmail.com>

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index 87ea9b1fe..94a3d587a 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -18,6 +18,7 @@ import { TLUser, createTLUser } from './config/createTLUser'
 import { TLAnyShapeUtilConstructor } from './config/defaultShapes'
 import { Editor } from './editor/Editor'
 import { TLStateNodeConstructor } from './editor/tools/StateNode'
+import { TLCameraOptions } from './editor/types/misc-types'
 import { ContainerProvider, useContainer } from './hooks/useContainer'
 import { useCursor } from './hooks/useCursor'
 import { useDarkMode } from './hooks/useDarkMode'
@@ -114,6 +115,11 @@ export interface TldrawEditorBaseProps {
 	 * Whether to infer dark mode from the user's OS. Defaults to false.
 	 */
 	inferDarkMode?: boolean
+
+	/**
+	 * Camera options for the editor.
+	 */
+	cameraOptions?: Partial<TLCameraOptions>
 }
 
 /**
@@ -266,6 +272,7 @@ function TldrawEditorWithReadyStore({
 	initialState,
 	autoFocus = true,
 	inferDarkMode,
+	cameraOptions,
 }: Required<
 	TldrawEditorProps & {
 		store: TLStore
@@ -286,13 +293,14 @@ function TldrawEditorWithReadyStore({
 			user,
 			initialState,
 			inferDarkMode,
+			cameraOptions,
 		})
 		setEditor(editor)
 
 		return () => {
 			editor.dispose()
 		}
-	}, [container, shapeUtils, tools, store, user, initialState, inferDarkMode])
+	}, [container, shapeUtils, tools, store, user, initialState, inferDarkMode, cameraOptions])
 
 	const crashingError = useSyncExternalStore(
 		useCallback(

commit ebc892a1a6b80556e1dfb7b1f953e206ca05120c
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Tue May 7 11:06:35 2024 +0100

    Camera options followups (#3701)
    
    This PR adds a slideshow example (similar to @TodePond's slides but more
    on rails) as a way to put some pressure on camera controls.
    
    Along the way, it fixes some issues I found with animations and the new
    camera controls.
    
    - forced changes will continue to force through animations
    - animations no longer set unnecessary additional listeners
    - animations end correctly
    - updating camera options does not immediately update the camera (to
    allow for animations, etc.)
    
    It also changes the location of the "in front of the canvas" element so
    that it is not hidden by the hit test blocking element.
    
    ### Change Type
    
    - [x] `sdk` — Changes the tldraw SDK
    - [x] `improvement` — Improving existing features

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index 94a3d587a..a099118a6 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -367,7 +367,22 @@ function Layout({
 	useFocusEvents(autoFocus)
 	useOnMount(onMount)
 
-	return <>{children}</>
+	return (
+		<>
+			{children}
+			<InFrontOfTheCanvasWrapper />
+		</>
+	)
+}
+
+function InFrontOfTheCanvasWrapper() {
+	const { InFrontOfTheCanvas } = useEditorComponents()
+	if (!InFrontOfTheCanvas) return null
+	return (
+		<div className="tl-front">
+			<InFrontOfTheCanvas />
+		</div>
+	)
 }
 
 function Crash({ crashingError }: { crashingError: unknown }): null {

commit da35f2bd75e43fd48d11a9a74f60ee01c84a41d1
Author: alex <alex@dytry.ch>
Date:   Wed May 8 13:37:31 2024 +0100

    Bindings (#3326)
    
    First draft of the new bindings API. We'll follow this up with some API
    refinements, tests, documentation, and examples.
    
    Bindings are a new record type for establishing relationships between
    two shapes so they can update at the same time.
    
    ### Change Type
    
    - [x] `sdk` — Changes the tldraw SDK
    - [x] `feature` — New feature
    
    ### Release Notes
    
    #### Breaking changes
    - The `start` and `end` properties on `TLArrowShape` no longer have
    `type: point | binding`. Instead, they're always a point, which may be
    out of date if a binding exists. To check for & retrieve arrow bindings,
    use `getArrowBindings(editor, shape)` instead.
    - `getArrowTerminalsInArrowSpace` must be passed a `TLArrowBindings` as
    a third argument: `getArrowTerminalsInArrowSpace(editor, shape,
    getArrowBindings(editor, shape))`
    - The following types have been renamed:
        - `ShapeProps` -> `RecordProps`
        - `ShapePropsType` -> `RecordPropsType`
        - `TLShapePropsMigrations` -> `TLPropsMigrations`
        - `SchemaShapeInfo` -> `SchemaPropsInfo`
    
    ---------
    
    Co-authored-by: David Sheldrick <d.j.sheldrick@gmail.com>

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index a099118a6..565a73607 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -15,6 +15,7 @@ import classNames from 'classnames'
 import { OptionalErrorBoundary } from './components/ErrorBoundary'
 import { DefaultErrorFallback } from './components/default-components/DefaultErrorFallback'
 import { TLUser, createTLUser } from './config/createTLUser'
+import { TLAnyBindingUtilConstructor } from './config/defaultBindings'
 import { TLAnyShapeUtilConstructor } from './config/defaultShapes'
 import { Editor } from './editor/Editor'
 import { TLStateNodeConstructor } from './editor/tools/StateNode'
@@ -76,6 +77,11 @@ export interface TldrawEditorBaseProps {
 	 */
 	shapeUtils?: readonly TLAnyShapeUtilConstructor[]
 
+	/**
+	 * An array of binding utils to use in the editor.
+	 */
+	bindingUtils?: readonly TLAnyBindingUtilConstructor[]
+
 	/**
 	 * An array of tools to add to the editor's state chart.
 	 */
@@ -141,6 +147,7 @@ declare global {
 }
 
 const EMPTY_SHAPE_UTILS_ARRAY = [] as const
+const EMPTY_BINDING_UTILS_ARRAY = [] as const
 const EMPTY_TOOLS_ARRAY = [] as const
 
 /** @public */
@@ -163,6 +170,7 @@ export const TldrawEditor = memo(function TldrawEditor({
 	const withDefaults = {
 		...rest,
 		shapeUtils: rest.shapeUtils ?? EMPTY_SHAPE_UTILS_ARRAY,
+		bindingUtils: rest.bindingUtils ?? EMPTY_BINDING_UTILS_ARRAY,
 		tools: rest.tools ?? EMPTY_TOOLS_ARRAY,
 		components,
 	}
@@ -203,12 +211,25 @@ export const TldrawEditor = memo(function TldrawEditor({
 })
 
 function TldrawEditorWithOwnStore(
-	props: Required<TldrawEditorProps & { store: undefined; user: TLUser }, 'shapeUtils' | 'tools'>
+	props: Required<
+		TldrawEditorProps & { store: undefined; user: TLUser },
+		'shapeUtils' | 'bindingUtils' | 'tools'
+	>
 ) {
-	const { defaultName, snapshot, initialData, shapeUtils, persistenceKey, sessionId, user } = props
+	const {
+		defaultName,
+		snapshot,
+		initialData,
+		shapeUtils,
+		bindingUtils,
+		persistenceKey,
+		sessionId,
+		user,
+	} = props
 
 	const syncedStore = useLocalStore({
 		shapeUtils,
+		bindingUtils,
 		initialData,
 		persistenceKey,
 		sessionId,
@@ -225,7 +246,7 @@ const TldrawEditorWithLoadingStore = memo(function TldrawEditorBeforeLoading({
 	...rest
 }: Required<
 	TldrawEditorProps & { store: TLStoreWithStatus; user: TLUser },
-	'shapeUtils' | 'tools'
+	'shapeUtils' | 'bindingUtils' | 'tools'
 >) {
 	const container = useContainer()
 
@@ -268,6 +289,7 @@ function TldrawEditorWithReadyStore({
 	store,
 	tools,
 	shapeUtils,
+	bindingUtils,
 	user,
 	initialState,
 	autoFocus = true,
@@ -278,7 +300,7 @@ function TldrawEditorWithReadyStore({
 		store: TLStore
 		user: TLUser
 	},
-	'shapeUtils' | 'tools'
+	'shapeUtils' | 'bindingUtils' | 'tools'
 >) {
 	const { ErrorFallback } = useEditorComponents()
 	const container = useContainer()
@@ -288,6 +310,7 @@ function TldrawEditorWithReadyStore({
 		const editor = new Editor({
 			store,
 			shapeUtils,
+			bindingUtils,
 			tools,
 			getContainer: () => container,
 			user,
@@ -300,7 +323,17 @@ function TldrawEditorWithReadyStore({
 		return () => {
 			editor.dispose()
 		}
-	}, [container, shapeUtils, tools, store, user, initialState, inferDarkMode, cameraOptions])
+	}, [
+		container,
+		shapeUtils,
+		bindingUtils,
+		tools,
+		store,
+		user,
+		initialState,
+		inferDarkMode,
+		cameraOptions,
+	])
 
 	const crashingError = useSyncExternalStore(
 		useCallback(

commit b4c1f606e18e338b16e2386b3cddfb1d2fc2bcff
Author: Mime Čuvalo <mimecuvalo@gmail.com>
Date:   Fri May 17 09:53:57 2024 +0100

    focus: rework and untangle existing focus management logic in the sdk (#3718)
    
    Focus management is really scattered across the codebase. There's sort
    of a battle between different code paths to make the focus the correct
    desired state. It seemed to grow like a knot and once I started pulling
    on one thread to see if it was still needed you could see underneath
    that it was accounting for another thing underneath that perhaps wasn't
    needed.
    
    The impetus for this PR came but especially during the text label
    rework, now that it's much more easy to jump around from textfield to
    textfield. It became apparent that we were playing whack-a-mole trying
    to preserve the right focus conditions (especially on iOS, ugh).
    
    This tries to remove as many hacks as possible, and bring together in
    place the focus logic (and in the darkness, bind them).
    
    ## Places affected
    - [x] `useEditableText`: was able to remove a bunch of the focus logic
    here. In addition, it doesn't look like we need to save the selection
    range anymore.
    - lingering footgun that needed to be fixed anyway: if there are two
    labels in the same shape, because we were just checking `editingShapeId
    === id`, the two text labels would have just fought each other for
    control
    - [x] `useFocusEvents`: nixed and refactored — we listen to the store in
    `FocusManager` and then take care of autoFocus there
    - [x] `useSafariFocusOutFix`: nixed. not necessary anymore because we're
    not trying to refocus when blurring in `useEditableText`. original PR
    for reference: https://github.com/tldraw/brivate/pull/79
    - [x] `defaultSideEffects`: moved logic to `FocusManager`
    - [x] `PointingShape` focus for `startTranslating`, decided to leave
    this alone actually.
    - [x] `TldrawUIButton`: it doesn't look like this focus bug fix is
    needed anymore, original PR for reference:
    https://github.com/tldraw/tldraw/pull/2630
    - [x] `useDocumentEvents`: left alone its manual focus after the Escape
    key is hit
    - [x] `FrameHeading`: double focus/select doesn't seem necessary anymore
    - [x] `useCanvasEvents`: `onPointerDown` focus logic never happened b/c
    in `Editor.ts` we `clearedMenus` on pointer down
    - [x] `onTouchStart`: looks like `document.body.click()` is not
    necessary anymore
    
    ## Future Changes
    - [ ] a11y: work on having an accessebility focus ring
    - [ ] Page visibility API:
    (https://developer.mozilla.org/en-US/docs/Web/API/Page_Visibility_API)
    events when tab is back in focus vs. background, different kind of focus
    - [ ] Reexamine places we manually dispatch `pointer_down` events to see
    if they're necessary.
    - [ ] Minor: get rid of `useContainer` maybe? Is it really necessary to
    have this hook? you can just do `useEditor` → `editor.getContainer()`,
    feels superfluous.
    
    ## Methodology
    Looked for places where we do:
    - `body.click()`
    - places we do `container.focus()`
    - places we do `container.blur()`
    - places we do `editor.updateInstanceState({ isFocused })`
    - places we do `autofocus`
    - searched for `document.activeElement`
    
    ### Change Type
    
    <!-- ❗ Please select a 'Scope' label ❗️ -->
    
    - [x] `sdk` — Changes the tldraw SDK
    - [ ] `dotcom` — Changes the tldraw.com web app
    - [ ] `docs` — Changes to the documentation, examples, or templates.
    - [ ] `vs code` — Changes to the vscode plugin
    - [ ] `internal` — Does not affect user-facing stuff
    
    <!-- ❗ Please select a 'Type' label ❗️ -->
    
    - [ ] `bugfix` — Bug fix
    - [ ] `feature` — New feature
    - [x] `improvement` — Improving existing features
    - [ ] `chore` — Updating dependencies, other boring stuff
    - [ ] `galaxy brain` — Architectural changes
    - [ ] `tests` — Changes to any test code
    - [ ] `tools` — Changes to infrastructure, CI, internal scripts,
    debugging tools, etc.
    - [ ] `dunno` — I don't know
    
    
    ### Test Plan
    
    - [x] run test-focus.spec.ts
    - [x] check MultipleExample
    - [x] check EditorFocusExample
    - [x] check autoFocus
    - [x] check style panel usage and focus events in general
    - [x] check text editing focus, lots of different devices,
    mobile/desktop
    
    ### Release Notes
    
    - Focus: rework and untangle existing focus management logic in the SDK

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index 565a73607..cb1ce795e 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -30,10 +30,8 @@ import {
 	useEditorComponents,
 } from './hooks/useEditorComponents'
 import { useEvent } from './hooks/useEvent'
-import { useFocusEvents } from './hooks/useFocusEvents'
 import { useForceUpdate } from './hooks/useForceUpdate'
 import { useLocalStore } from './hooks/useLocalStore'
-import { useSafariFocusOutFix } from './hooks/useSafariFocusOutFix'
 import { useZoomCss } from './hooks/useZoomCss'
 import { stopEventPropagation } from './utils/dom'
 import { TLStoreWithStatus } from './utils/sync/StoreWithStatus'
@@ -305,6 +303,7 @@ function TldrawEditorWithReadyStore({
 	const { ErrorFallback } = useEditorComponents()
 	const container = useContainer()
 	const [editor, setEditor] = useState<Editor | null>(null)
+	const [initialAutoFocus] = useState(autoFocus)
 
 	useLayoutEffect(() => {
 		const editor = new Editor({
@@ -315,6 +314,7 @@ function TldrawEditorWithReadyStore({
 			getContainer: () => container,
 			user,
 			initialState,
+			autoFocus: initialAutoFocus,
 			inferDarkMode,
 			cameraOptions,
 		})
@@ -331,6 +331,7 @@ function TldrawEditorWithReadyStore({
 		store,
 		user,
 		initialState,
+		initialAutoFocus,
 		inferDarkMode,
 		cameraOptions,
 	])
@@ -374,30 +375,18 @@ function TldrawEditorWithReadyStore({
 				<Crash crashingError={crashingError} />
 			) : (
 				<EditorContext.Provider value={editor}>
-					<Layout autoFocus={autoFocus} onMount={onMount}>
-						{children ?? (Canvas ? <Canvas /> : null)}
-					</Layout>
+					<Layout onMount={onMount}>{children ?? (Canvas ? <Canvas /> : null)}</Layout>
 				</EditorContext.Provider>
 			)}
 		</OptionalErrorBoundary>
 	)
 }
 
-function Layout({
-	children,
-	onMount,
-	autoFocus,
-}: {
-	children: ReactNode
-	autoFocus: boolean
-	onMount?: TLOnMountHandler
-}) {
+function Layout({ children, onMount }: { children: ReactNode; onMount?: TLOnMountHandler }) {
 	useZoomCss()
 	useCursor()
 	useDarkMode()
-	useSafariFocusOutFix()
 	useForceUpdate()
-	useFocusEvents(autoFocus)
 	useOnMount(onMount)
 
 	return (

commit 29608838ef96c649dfd5d74c5c5d0c2938a3fff7
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Tue May 21 06:05:59 2024 +0100

    Move InFrontOfTheCanvas (#3782)
    
    Our `InFrontOfTheCanvas` UI override component (we don't have a default
    implementation, it's just an entry point for sdk users to insert their
    own UI) was being mounted outside of the UI react context subtree, which
    is an error because it won't have access to important things like
    translations and asset URLs. #3750 made this bug manifest as a thrown
    error in our `context-toolbar` example, as reported in #3773.
    
    To fix this I just moved the injection site of the `InFrontOfTheCanvas`
    component to be within the UI context. It ends up in the same place in
    the DOM.
    
    This PR closes #3773
    
    
    
    ### Change Type
    
    <!-- ❗ Please select a 'Scope' label ❗️ -->
    
    - [x] `sdk` — Changes the tldraw SDK
    - [ ] `dotcom` — Changes the tldraw.com web app
    - [ ] `docs` — Changes to the documentation, examples, or templates.
    - [ ] `vs code` — Changes to the vscode plugin
    - [ ] `internal` — Does not affect user-facing stuff
    
    <!-- ❗ Please select a 'Type' label ❗️ -->
    
    - [x] `bugfix` — Bug fix
    - [ ] `feature` — New feature
    - [ ] `improvement` — Improving existing features
    - [ ] `chore` — Updating dependencies, other boring stuff
    - [ ] `galaxy brain` — Architectural changes
    - [ ] `tests` — Changes to any test code
    - [ ] `tools` — Changes to infrastructure, CI, internal scripts,
    debugging tools, etc.
    - [ ] `dunno` — I don't know
    
    
    ### Test Plan
    
    1. Add a step-by-step description of how to test your PR here.
    2.
    
    - [ ] Unit Tests
    - [ ] End to end tests
    
    ### Release Notes
    
    - Add a brief release note for your PR here.

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index cb1ce795e..7074173d4 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -389,22 +389,7 @@ function Layout({ children, onMount }: { children: ReactNode; onMount?: TLOnMoun
 	useForceUpdate()
 	useOnMount(onMount)
 
-	return (
-		<>
-			{children}
-			<InFrontOfTheCanvasWrapper />
-		</>
-	)
-}
-
-function InFrontOfTheCanvasWrapper() {
-	const { InFrontOfTheCanvas } = useEditorComponents()
-	if (!InFrontOfTheCanvas) return null
-	return (
-		<div className="tl-front">
-			<InFrontOfTheCanvas />
-		</div>
-	)
+	return <>{children}</>
 }
 
 function Crash({ crashingError }: { crashingError: unknown }): null {

commit a457a390819bc15add2b52c77f0908498a8613a6
Author: alex <alex@dytry.ch>
Date:   Tue May 28 15:22:03 2024 +0100

    Move constants to options prop (#3799)
    
    Another go at #3628 & #3783. This moves (most) constants into
    `editor.options`, configurable by the `options` prop on the tldraw
    component.
    
    ### Change Type
    
    - [x] `sdk` — Changes the tldraw SDK
    - [x] `feature` — New feature
    
    ### Release Notes
    
    You can now override many options which were previously hard-coded
    constants. Pass an `options` prop into the tldraw component to change
    the maximum number of pages, grid steps, or other previously hard-coded
    values. See `TldrawOptions` for more

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index 7074173d4..8f30cc481 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -33,6 +33,7 @@ import { useEvent } from './hooks/useEvent'
 import { useForceUpdate } from './hooks/useForceUpdate'
 import { useLocalStore } from './hooks/useLocalStore'
 import { useZoomCss } from './hooks/useZoomCss'
+import { TldrawOptions } from './options'
 import { stopEventPropagation } from './utils/dom'
 import { TLStoreWithStatus } from './utils/sync/StoreWithStatus'
 
@@ -124,6 +125,11 @@ export interface TldrawEditorBaseProps {
 	 * Camera options for the editor.
 	 */
 	cameraOptions?: Partial<TLCameraOptions>
+
+	/**
+	 * Options for the editor.
+	 */
+	options?: Partial<TldrawOptions>
 }
 
 /**
@@ -293,6 +299,7 @@ function TldrawEditorWithReadyStore({
 	autoFocus = true,
 	inferDarkMode,
 	cameraOptions,
+	options,
 }: Required<
 	TldrawEditorProps & {
 		store: TLStore
@@ -317,6 +324,7 @@ function TldrawEditorWithReadyStore({
 			autoFocus: initialAutoFocus,
 			inferDarkMode,
 			cameraOptions,
+			options,
 		})
 		setEditor(editor)
 
@@ -334,6 +342,7 @@ function TldrawEditorWithReadyStore({
 		initialAutoFocus,
 		inferDarkMode,
 		cameraOptions,
+		options,
 	])
 
 	const crashingError = useSyncExternalStore(

commit 19d051c188381e54d7f8a1fd90a2ccd247419909
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Mon Jun 3 16:58:00 2024 +0100

    Snapshots pit of success (#3811)
    
    Lots of people are having a bad time with loading/restoring snapshots
    and there's a few reasons for that:
    
    - It's not clear how to preserve UI state independently of document
    state.
    - Loading a snapshot wipes the instance state, which means we almost
    always need to
      - update the viewport page bounds
      - refocus the editor
      - preserver some other sneaky properties of the `instance` record
    
    ### Change Type
    
    <!-- ❗ Please select a 'Scope' label ❗️ -->
    
    - [x] `sdk` — Changes the tldraw SDK
    - [ ] `dotcom` — Changes the tldraw.com web app
    - [ ] `docs` — Changes to the documentation, examples, or templates.
    - [ ] `vs code` — Changes to the vscode plugin
    - [ ] `internal` — Does not affect user-facing stuff
    
    <!-- ❗ Please select a 'Type' label ❗️ -->
    
    - [ ] `bugfix` — Bug fix
    - [ ] `feature` — New feature
    - [ ] `improvement` — Improving existing features
    - [ ] `chore` — Updating dependencies, other boring stuff
    - [ ] `galaxy brain` — Architectural changes
    - [ ] `tests` — Changes to any test code
    - [ ] `tools` — Changes to infrastructure, CI, internal scripts,
    debugging tools, etc.
    - [ ] `dunno` — I don't know
    
    
    ### Test Plan
    
    1. Add a step-by-step description of how to test your PR here.
    2.
    
    - [ ] Unit Tests
    - [ ] End to end tests
    
    ### Release Notes
    
    - Add a brief release note for your PR here.

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index 8f30cc481..4cac7f21e 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -1,5 +1,5 @@
-import { MigrationSequence, SerializedStore, Store, StoreSnapshot } from '@tldraw/store'
-import { TLRecord, TLStore } from '@tldraw/tlschema'
+import { MigrationSequence, Store } from '@tldraw/store'
+import { TLSerializedStore, TLStore, TLStoreSnapshot } from '@tldraw/tlschema'
 import { Expand, Required, annotateError } from '@tldraw/utils'
 import React, {
 	ReactNode,
@@ -14,6 +14,7 @@ import React, {
 import classNames from 'classnames'
 import { OptionalErrorBoundary } from './components/ErrorBoundary'
 import { DefaultErrorFallback } from './components/default-components/DefaultErrorFallback'
+import { TLEditorSnapshot } from './config/TLEditorSnapshot'
 import { TLUser, createTLUser } from './config/createTLUser'
 import { TLAnyBindingUtilConstructor } from './config/defaultBindings'
 import { TLAnyShapeUtilConstructor } from './config/defaultShapes'
@@ -51,8 +52,8 @@ export type TldrawEditorProps = Expand<
 			| {
 					store?: undefined
 					migrations?: readonly MigrationSequence[]
-					snapshot?: StoreSnapshot<TLRecord>
-					initialData?: SerializedStore<TLRecord>
+					snapshot?: TLEditorSnapshot | TLStoreSnapshot
+					initialData?: TLSerializedStore
 					persistenceKey?: string
 					sessionId?: string
 					defaultName?: string

commit 6c846716c343e1ad40839f0f2bab758f58b4284d
Author: Mime Čuvalo <mimecuvalo@gmail.com>
Date:   Tue Jun 11 15:17:09 2024 +0100

    assets: make option to transform urls dynamically / LOD (#3827)
    
    this is take #2 of this PR https://github.com/tldraw/tldraw/pull/3764
    
    This continues the idea kicked off in
    https://github.com/tldraw/tldraw/pull/3684 to explore LOD and takes it
    in a different direction.
    
    Several things here to call out:
    - our dotcom version would start to use Cloudflare's image transforms
    - we don't rewrite non-image assets
    - we debounce zooming so that we're not swapping out images while
    zooming (it creates jank)
    - we load different images based on steps of .25 (maybe we want to make
    this more, like 0.33). Feels like 0.5 might be a bit too much but we can
    play around with it.
    - we take into account network connection speed. if you're on 3g, for
    example, we have the size of the image.
    - dpr is taken into account - in our case, Cloudflare handles it. But if
    it wasn't Cloudflare, we could add it to our width equation.
    - we use Cloudflare's `fit=scale-down` setting to never scale _up_ an
    image.
    - we don't swap the image in until we've finished loading it
    programatically (to avoid a blank image while it loads)
    
    TODO
    - [x] We need to enable Cloudflare's pricing on image transforms btw
    @steveruizok 😉 - this won't work quite yet until we do that.
    
    
    ### Change Type
    
    <!-- ❗ Please select a 'Scope' label ❗️ -->
    
    - [x] `sdk` — Changes the tldraw SDK
    - [ ] `dotcom` — Changes the tldraw.com web app
    - [ ] `docs` — Changes to the documentation, examples, or templates.
    - [ ] `vs code` — Changes to the vscode plugin
    - [ ] `internal` — Does not affect user-facing stuff
    
    <!-- ❗ Please select a 'Type' label ❗️ -->
    
    - [ ] `bugfix` — Bug fix
    - [x] `feature` — New feature
    - [ ] `improvement` — Improving existing features
    - [ ] `chore` — Updating dependencies, other boring stuff
    - [ ] `galaxy brain` — Architectural changes
    - [ ] `tests` — Changes to any test code
    - [ ] `tools` — Changes to infrastructure, CI, internal scripts,
    debugging tools, etc.
    - [ ] `dunno` — I don't know
    
    
    ### Test Plan
    
    1. Test images on staging, small, medium, large, mega
    2. Test videos on staging
    
    - [x] Unit Tests
    - [ ] End to end tests
    
    ### Release Notes
    
    - Assets: make option to transform urls dynamically to provide different
    sized images on demand.

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index 4cac7f21e..c8f12f023 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -20,7 +20,7 @@ import { TLAnyBindingUtilConstructor } from './config/defaultBindings'
 import { TLAnyShapeUtilConstructor } from './config/defaultShapes'
 import { Editor } from './editor/Editor'
 import { TLStateNodeConstructor } from './editor/tools/StateNode'
-import { TLCameraOptions } from './editor/types/misc-types'
+import { TLAssetOptions, TLCameraOptions } from './editor/types/misc-types'
 import { ContainerProvider, useContainer } from './hooks/useContainer'
 import { useCursor } from './hooks/useCursor'
 import { useDarkMode } from './hooks/useDarkMode'
@@ -127,6 +127,11 @@ export interface TldrawEditorBaseProps {
 	 */
 	cameraOptions?: Partial<TLCameraOptions>
 
+	/**
+	 * Asset options for the editor.
+	 */
+	assetOptions?: Partial<TLAssetOptions>
+
 	/**
 	 * Options for the editor.
 	 */
@@ -300,6 +305,7 @@ function TldrawEditorWithReadyStore({
 	autoFocus = true,
 	inferDarkMode,
 	cameraOptions,
+	assetOptions,
 	options,
 }: Required<
 	TldrawEditorProps & {
@@ -325,6 +331,7 @@ function TldrawEditorWithReadyStore({
 			autoFocus: initialAutoFocus,
 			inferDarkMode,
 			cameraOptions,
+			assetOptions,
 			options,
 		})
 		setEditor(editor)
@@ -343,6 +350,7 @@ function TldrawEditorWithReadyStore({
 		initialAutoFocus,
 		inferDarkMode,
 		cameraOptions,
+		assetOptions,
 		options,
 	])
 

commit 6cb797a07475d7250bffe731174c516c50136a00
Author: alex <alex@dytry.ch>
Date:   Thu Jun 13 14:09:27 2024 +0100

    Better generated docs for react components (#3930)
    
    Before:
    ![Screenshot 2024-06-12 at 12 57
    26](https://github.com/tldraw/tldraw/assets/1489520/2a9f6098-ef2a-4f52-88f5-d6e4311c067d)
    
    After:
    ![Screenshot 2024-06-12 at 12 59
    16](https://github.com/tldraw/tldraw/assets/1489520/51733c2a-a2b4-4084-a89a-85bce5b47672)
    
    React components in docs now list their props, and appear under a new
    "Component" section instead of randomly under either `Function` or
    `Variable`. In order to have our docs generate this, a few criteria need
    to be met:
    1. They need to be tagged with the `@react` tsdoc tag
    2. Their props need to be a simple type alias, typically to an
    interface.
    
    Both of these rules are enforced with a new lint rule - any component
    tagged as `@public` will have these rules enforced.
    
    ### Change Type
    
    - [x] `docs` — Changes to the documentation, examples, or templates.
    - [x] `improvement` — Improving existing features

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index c8f12f023..1d7dce676 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -160,7 +160,7 @@ const EMPTY_SHAPE_UTILS_ARRAY = [] as const
 const EMPTY_BINDING_UTILS_ARRAY = [] as const
 const EMPTY_TOOLS_ARRAY = [] as const
 
-/** @public */
+/** @public @react */
 export const TldrawEditor = memo(function TldrawEditor({
 	store,
 	components,
@@ -415,12 +415,17 @@ function Crash({ crashingError }: { crashingError: unknown }): null {
 }
 
 /** @public */
-export function LoadingScreen({ children }: { children: ReactNode }) {
+export interface LoadingScreenProps {
+	children: ReactNode
+}
+
+/** @public @react */
+export function LoadingScreen({ children }: LoadingScreenProps) {
 	return <div className="tl-loading">{children}</div>
 }
 
-/** @public */
-export function ErrorScreen({ children }: { children: ReactNode }) {
+/** @public @react */
+export function ErrorScreen({ children }: LoadingScreenProps) {
 	return <div className="tl-loading">{children}</div>
 }
 

commit 12aea7ed68e9b349c4eee4b6f2779ec970c7c650
Author: Mitja Bezenšek <mitja.bezensek@gmail.com>
Date:   Mon Jun 17 16:46:04 2024 +0200

    [Experiment] Allow users to use system's appearance (dark / light) mode (#3703)
    
    Allow the users to fully use the same colour scheme as their system.
    Allows the users to either: force dark colour scheme, force light colour
    scheme, or use the system one.
    
    It's reactive to the system changes.
    
    
    https://github.com/tldraw/tldraw/assets/2523721/6d4cef03-9ef0-4098-b299-6bf5d7513e98
    
    
    ### Change Type
    
    <!-- ❗ Please select a 'Scope' label ❗️ -->
    
    - [x] `sdk` — Changes the tldraw SDK
    - [ ] `dotcom` — Changes the tldraw.com web app
    - [ ] `docs` — Changes to the documentation, examples, or templates.
    - [ ] `vs code` — Changes to the vscode plugin
    - [ ] `internal` — Does not affect user-facing stuff
    
    <!-- ❗ Please select a 'Type' label ❗️ -->
    
    - [ ] `bugfix` — Bug fix
    - [ ] `feature` — New feature
    - [x] `improvement` — Improving existing features
    - [ ] `chore` — Updating dependencies, other boring stuff
    - [ ] `galaxy brain` — Architectural changes
    - [ ] `tests` — Changes to any test code
    - [ ] `tools` — Changes to infrastructure, CI, internal scripts,
    debugging tools, etc.
    - [ ] `dunno` — I don't know
    
    
    ### Test Plan
    
    1. Add a step-by-step description of how to test your PR here.
    2.
    
    - [ ] Unit Tests
    - [ ] End to end tests
    
    ### Release Notes
    
    - Add a brief release note for your PR here.
    
    ---------
    
    Co-authored-by: David Sheldrick <d.j.sheldrick@gmail.com>

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index 1d7dce676..1d49cb4f9 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -261,7 +261,7 @@ const TldrawEditorWithLoadingStore = memo(function TldrawEditorBeforeLoading({
 	const container = useContainer()
 
 	useLayoutEffect(() => {
-		if (user.userPreferences.get().isDarkMode) {
+		if (user.userPreferences.get().colorScheme === 'dark') {
 			container.classList.remove('tl-theme__light')
 			container.classList.add('tl-theme__dark')
 		}

commit 2d2a7ea76fc5a6cd22aac4c4b0f77c395ae2111f
Author: alex <alex@dytry.ch>
Date:   Mon Jun 24 13:24:24 2024 +0100

    Fix multiple editor instances issue (#4001)
    
    React's strict mode runs effects twice on mount, but once it's done that
    it'll go forward with the state from the first effect. For example, this
    component:
    
    ```tsx
    let nextId = 1
    function Component() {
            const [state, setState] = useState(null)
            useEffect(() => {
                    const id = nextId++
                    console.log('set up', id)
                    setState(id)
                    return () => console.log('tear down', id)
            }, [])
            if (!state) return
            console.log('render', state)
    }
    ```
    
    Would log something like this when mounting for the first time:
    - `set up 1`
    - `tear down 1`
    - `set up 2`
    - `render 1`
    
    For us, this is a problem: editor 2 is the version that's still running,
    but editor 1 is getting used for render. React talks a bit about this
    issue here: https://github.com/reactwg/react-18/discussions/19
    
    The fix seems to be to keep the editor in a `useRef` instead of a
    `useState`. We need the state to trigger re-renders though, so we sync
    the ref into the state although we don't actually use the state value.
    
    ### Change Type
    
    
    - [x] `sdk` — Changes the tldraw SDK
    - [x] `bugfix` — Bug fix
    
    
    
    ### Release Notes
    
    - Fix a bug causing text shape measurement to work incorrectly when
    using react strict mode

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index 1d49cb4f9..efbebdaaf 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -7,6 +7,7 @@ import React, {
 	useCallback,
 	useLayoutEffect,
 	useMemo,
+	useRef,
 	useState,
 	useSyncExternalStore,
 } from 'react'
@@ -316,7 +317,17 @@ function TldrawEditorWithReadyStore({
 >) {
 	const { ErrorFallback } = useEditorComponents()
 	const container = useContainer()
-	const [editor, setEditor] = useState<Editor | null>(null)
+	const editorRef = useRef<Editor | null>(null)
+	// we need to store the editor instance in a ref so that it persists across strict-mode
+	// remounts, but that won't trigger re-renders, so we use this hook to make sure all child
+	// components get the most up to date editor reference when needed.
+	const [renderEditor, setRenderEditor] = useState<Editor | null>(null)
+
+	const editor = editorRef.current
+	if (renderEditor !== editor) {
+		setRenderEditor(editor)
+	}
+
 	const [initialAutoFocus] = useState(autoFocus)
 
 	useLayoutEffect(() => {
@@ -334,7 +345,9 @@ function TldrawEditorWithReadyStore({
 			assetOptions,
 			options,
 		})
-		setEditor(editor)
+
+		editorRef.current = editor
+		setRenderEditor(editor)
 
 		return () => {
 			editor.dispose()

commit 4ccac5da96d55e3d3fbceb37a7ee65a1901939fc
Author: alex <alex@dytry.ch>
Date:   Mon Jun 24 16:55:46 2024 +0100

    better auto-generated docs for Tldraw and TldrawEditor (#4012)
    
    Simplify the types used by the props of the `Tldraw` and `TldrawEditor`
    components. This doesn't make the docs perfect, but it makes them quite
    a bit better than they were.
    
    
    ![image](https://github.com/tldraw/tldraw/assets/1489520/66c72e0e-c22b-4414-b194-f0598e4a3736)
    
    
    ### Change Type
    
    - [x] `sdk` — Changes the tldraw SDK
    - [x] `docs` — Changes to the documentation, examples, or templates.
    - [x] `improvement` — Improving existing features

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index efbebdaaf..e64985b2c 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -1,6 +1,6 @@
 import { MigrationSequence, Store } from '@tldraw/store'
-import { TLSerializedStore, TLStore, TLStoreSnapshot } from '@tldraw/tlschema'
-import { Expand, Required, annotateError } from '@tldraw/utils'
+import { TLStore, TLStoreSnapshot } from '@tldraw/tlschema'
+import { Required, annotateError } from '@tldraw/utils'
 import React, {
 	ReactNode,
 	memo,
@@ -16,6 +16,7 @@ import classNames from 'classnames'
 import { OptionalErrorBoundary } from './components/ErrorBoundary'
 import { DefaultErrorFallback } from './components/default-components/DefaultErrorFallback'
 import { TLEditorSnapshot } from './config/TLEditorSnapshot'
+import { TLStoreBaseOptions } from './config/createTLStore'
 import { TLUser, createTLUser } from './config/createTLUser'
 import { TLAnyBindingUtilConstructor } from './config/defaultBindings'
 import { TLAnyShapeUtilConstructor } from './config/defaultShapes'
@@ -39,28 +40,59 @@ import { TldrawOptions } from './options'
 import { stopEventPropagation } from './utils/dom'
 import { TLStoreWithStatus } from './utils/sync/StoreWithStatus'
 
+/**
+ * Props for the {@link tldraw#Tldraw} and {@link TldrawEditor} components, when passing in a
+ * {@link store#TLStore} directly. If you would like tldraw to create a store for you, use
+ * {@link TldrawEditorWithoutStoreProps}.
+ *
+ * @public
+ */
+export interface TldrawEditorWithStoreProps {
+	/**
+	 * The store to use in the editor.
+	 */
+	store: TLStore | TLStoreWithStatus
+}
+
+/**
+ * Props for the {@link tldraw#Tldraw} and {@link TldrawEditor} components, when not passing in a
+ * {@link store#TLStore} directly. If you would like to pass in a store directly, use
+ * {@link TldrawEditorWithStoreProps}.
+ *
+ * @public
+ */
+export interface TldrawEditorWithoutStoreProps extends TLStoreBaseOptions {
+	store?: undefined
+
+	/**
+	 * Additional migrations to use in the store
+	 */
+	migrations?: readonly MigrationSequence[]
+
+	/**
+	 * A starting snapshot of data to pre-populate the store. Do not supply both this and
+	 * `initialData`.
+	 */
+	snapshot?: TLEditorSnapshot | TLStoreSnapshot
+
+	/**
+	 * If you would like to persist the store to the browser's local IndexedDB storage and sync it
+	 * across tabs, provide a key here. Each key represents a single tldraw document.
+	 */
+	persistenceKey?: string
+
+	sessionId?: string
+}
+
+/** @public */
+export type TldrawEditorStoreProps = TldrawEditorWithStoreProps | TldrawEditorWithoutStoreProps
+
 /**
  * Props for the {@link tldraw#Tldraw} and {@link TldrawEditor} components.
  *
  * @public
  **/
-export type TldrawEditorProps = Expand<
-	TldrawEditorBaseProps &
-		(
-			| {
-					store: TLStore | TLStoreWithStatus
-			  }
-			| {
-					store?: undefined
-					migrations?: readonly MigrationSequence[]
-					snapshot?: TLEditorSnapshot | TLStoreSnapshot
-					initialData?: TLSerializedStore
-					persistenceKey?: string
-					sessionId?: string
-					defaultName?: string
-			  }
-		)
->
+export type TldrawEditorProps = TldrawEditorBaseProps & TldrawEditorStoreProps
 
 /**
  * Base props for the {@link tldraw#Tldraw} and {@link TldrawEditor} components.

commit baa71289ed6d0b03f693b7f635a631d3192d3d88
Author: Mime Čuvalo <mimecuvalo@gmail.com>
Date:   Tue Jun 25 12:28:26 2024 +0100

    assets: mark assetOptions as internal (#4014)
    
    internal for now until we figure out this PR:
    https://github.com/tldraw/tldraw/pull/3992
    
    ### Change Type
    
    <!-- ❗ Please select a 'Scope' label ❗️ -->
    
    - [x] `sdk` — Changes the tldraw SDK
    - [ ] `dotcom` — Changes the tldraw.com web app
    - [ ] `docs` — Changes to the documentation, examples, or templates.
    - [ ] `vs code` — Changes to the vscode plugin
    - [ ] `internal` — Does not affect user-facing stuff
    
    <!-- ❗ Please select a 'Type' label ❗️ -->
    
    - [ ] `bugfix` — Bug fix
    - [ ] `feature` — New feature
    - [ ] `improvement` — Improving existing features
    - [x] `chore` — Updating dependencies, other boring stuff
    - [ ] `galaxy brain` — Architectural changes
    - [ ] `tests` — Changes to any test code
    - [ ] `tools` — Changes to infrastructure, CI, internal scripts,
    debugging tools, etc.
    - [ ] `dunno` — I don't know

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index e64985b2c..e90ff9484 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -162,6 +162,7 @@ export interface TldrawEditorBaseProps {
 
 	/**
 	 * Asset options for the editor.
+	 * @internal
 	 */
 	assetOptions?: Partial<TLAssetOptions>
 

commit 1bf2820a3fed5fad4064d33d8ba38d9450e8a06a
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Fri Jul 5 11:41:03 2024 +0100

    Add component for `ShapeIndicators` (#4083)
    
    This PR adds a component for `ShapeIndicators` to the UI component
    overrides. It moves the "select tool" state logic up to the new
    `TldrawShapeIndicators` component.
    
    ### Change type
    
    - [ ] `bugfix`
    - [x] `improvement`
    - [ ] `feature`
    - [x] `api`
    - [ ] `other`
    
    ### Release notes
    
    - Added new `ShapeIndicators` component to `components` object.
    - Added new `TldrawShapeIndicators` component.

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index e90ff9484..aaa6ad7e3 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -453,7 +453,7 @@ function Layout({ children, onMount }: { children: ReactNode; onMount?: TLOnMoun
 	useForceUpdate()
 	useOnMount(onMount)
 
-	return <>{children}</>
+	return children
 }
 
 function Crash({ crashingError }: { crashingError: unknown }): null {

commit cf32a0922199d41f8b428565ee3715755bd85bef
Author: alex <alex@dytry.ch>
Date:   Mon Jul 8 11:22:25 2024 +0100

    Fix editor remounting when camera options change (#4089)
    
    Currently, the editor gets recreated whenever the camera options (or
    several other props that are only relevant at initialisation time) get
    changed.
    
    This diff makes it so that:
    - init-only props are kept in a ref so they don't invalidate the editor
    (but are used when the editor _does_ get recreated)
    - camera options are kept up to date in a separate effect
    
    ### Change type
    
    - [x] `bugfix`
    
    ### Release notes
    
    Fix an issue where changing `cameraOptions` via react would cause the
    entire editor to re-render

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index aaa6ad7e3..910e1c8af 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -361,44 +361,60 @@ function TldrawEditorWithReadyStore({
 		setRenderEditor(editor)
 	}
 
-	const [initialAutoFocus] = useState(autoFocus)
+	// props in this ref can be changed without causing the editor to be recreated.
+	const editorOptionsRef = useRef({
+		// for these, it's because they're only used when the editor first mounts:
+		autoFocus,
+		inferDarkMode,
+		initialState,
 
+		// for these, it's because we keep them up to date in a separate effect:
+		cameraOptions,
+	})
 	useLayoutEffect(() => {
-		const editor = new Editor({
-			store,
-			shapeUtils,
-			bindingUtils,
-			tools,
-			getContainer: () => container,
-			user,
-			initialState,
-			autoFocus: initialAutoFocus,
+		editorOptionsRef.current = {
+			autoFocus,
 			inferDarkMode,
+			initialState,
 			cameraOptions,
-			assetOptions,
-			options,
-		})
-
-		editorRef.current = editor
-		setRenderEditor(editor)
+		}
+	}, [autoFocus, inferDarkMode, initialState, cameraOptions])
+
+	useLayoutEffect(
+		() => {
+			const { autoFocus, inferDarkMode, initialState, cameraOptions } = editorOptionsRef.current
+			const editor = new Editor({
+				store,
+				shapeUtils,
+				bindingUtils,
+				tools,
+				getContainer: () => container,
+				user,
+				initialState,
+				autoFocus,
+				inferDarkMode,
+				cameraOptions,
+				assetOptions,
+				options,
+			})
+
+			editorRef.current = editor
+			setRenderEditor(editor)
+
+			return () => {
+				editor.dispose()
+			}
+		},
+		// if any of these change, we need to recreate the editor.
+		[assetOptions, bindingUtils, container, options, shapeUtils, store, tools, user]
+	)
 
-		return () => {
-			editor.dispose()
+	// keep the editor up to date with the latest camera options
+	useLayoutEffect(() => {
+		if (editor && cameraOptions) {
+			editor.setCameraOptions(cameraOptions)
 		}
-	}, [
-		container,
-		shapeUtils,
-		bindingUtils,
-		tools,
-		store,
-		user,
-		initialState,
-		initialAutoFocus,
-		inferDarkMode,
-		cameraOptions,
-		assetOptions,
-		options,
-	])
+	}, [editor, cameraOptions])
 
 	const crashingError = useSyncExternalStore(
 		useCallback(

commit 965bc10997725a7e2e1484767165253d4352b21a
Author: alex <alex@dytry.ch>
Date:   Wed Jul 10 14:00:18 2024 +0100

    [1/4] Blob storage in TLStore (#4068)
    
    Reworks the store to include information about how blob assets
    (images/videos) are stored/retrieved. This replaces the old
    internal-only `assetOptions` prop, and supplements the existing
    `registerExternalAssetHandler` API.
    
    Previously, `registerExternalAssetHandler` had two responsibilities:
    1. Extracting asset metadata
    2. Uploading the asset and returning its URL
    
    Existing `registerExternalAssetHandler` implementation will still work,
    but now uploading is the responsibility of a new `editor.uploadAsset`
    method which calls the new store-based upload method. Our default asset
    handlers extract metadata, then call that new API. I think this is a
    pretty big improvement over what we had before: overriding uploads was a
    pretty common ask, but doing so meant having to copy paste our metadata
    extraction which felt pretty fragile. Just in this codebase, we had a
    bunch of very slightly different metadata extraction code-paths that had
    been copy-pasted around then diverged over time. Now, you can change how
    uploads work without having to mess with metadata extraction and
    vice-versa.
    
    As part of this we also:
    1. merge the old separate asset indexeddb store with the main one.
    because this warrants some pretty big migration stuff, i refactored our
    indexed-db helpers to work around an instance instead of being free
    functions
    2. move our existing asset stuff over to the new approach
    3. add a new hook in `sync-react` to create a demo store with the new
    assets
    
    ### Change type
    
    - [x] `api`
    
    ### Release notes
    
    Introduce a new `assets` option for the store, describing how to save
    and retrieve asset blobs like images & videos from e.g. a user-content
    CDN. These are accessible through `editor.uploadAsset` and
    `editor.resolveAssetUrl`. This supplements the existing
    `registerExternalAssetHandler` API: `registerExternalAssetHandler` is
    for customising metadata extraction, and should call
    `editor.uploadAsset` to save assets. Existing
    `registerExternalAssetHandler` calls will still work, but if you're only
    using them to configure uploads and don't want to customise metadata
    extraction, consider switching to the new `assets` store prop.

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index 910e1c8af..b2138d1d7 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -8,7 +8,6 @@ import React, {
 	useLayoutEffect,
 	useMemo,
 	useRef,
-	useState,
 	useSyncExternalStore,
 } from 'react'
 
@@ -22,7 +21,7 @@ import { TLAnyBindingUtilConstructor } from './config/defaultBindings'
 import { TLAnyShapeUtilConstructor } from './config/defaultShapes'
 import { Editor } from './editor/Editor'
 import { TLStateNodeConstructor } from './editor/tools/StateNode'
-import { TLAssetOptions, TLCameraOptions } from './editor/types/misc-types'
+import { TLCameraOptions } from './editor/types/misc-types'
 import { ContainerProvider, useContainer } from './hooks/useContainer'
 import { useCursor } from './hooks/useCursor'
 import { useDarkMode } from './hooks/useDarkMode'
@@ -35,6 +34,7 @@ import {
 import { useEvent } from './hooks/useEvent'
 import { useForceUpdate } from './hooks/useForceUpdate'
 import { useLocalStore } from './hooks/useLocalStore'
+import { useRefState } from './hooks/useRefState'
 import { useZoomCss } from './hooks/useZoomCss'
 import { TldrawOptions } from './options'
 import { stopEventPropagation } from './utils/dom'
@@ -160,12 +160,6 @@ export interface TldrawEditorBaseProps {
 	 */
 	cameraOptions?: Partial<TLCameraOptions>
 
-	/**
-	 * Asset options for the editor.
-	 * @internal
-	 */
-	assetOptions?: Partial<TLAssetOptions>
-
 	/**
 	 * Options for the editor.
 	 */
@@ -339,7 +333,6 @@ function TldrawEditorWithReadyStore({
 	autoFocus = true,
 	inferDarkMode,
 	cameraOptions,
-	assetOptions,
 	options,
 }: Required<
 	TldrawEditorProps & {
@@ -350,16 +343,8 @@ function TldrawEditorWithReadyStore({
 >) {
 	const { ErrorFallback } = useEditorComponents()
 	const container = useContainer()
-	const editorRef = useRef<Editor | null>(null)
-	// we need to store the editor instance in a ref so that it persists across strict-mode
-	// remounts, but that won't trigger re-renders, so we use this hook to make sure all child
-	// components get the most up to date editor reference when needed.
-	const [renderEditor, setRenderEditor] = useState<Editor | null>(null)
-
-	const editor = editorRef.current
-	if (renderEditor !== editor) {
-		setRenderEditor(editor)
-	}
+
+	const [editor, setEditor] = useRefState<Editor | null>(null)
 
 	// props in this ref can be changed without causing the editor to be recreated.
 	const editorOptionsRef = useRef({
@@ -394,19 +379,17 @@ function TldrawEditorWithReadyStore({
 				autoFocus,
 				inferDarkMode,
 				cameraOptions,
-				assetOptions,
 				options,
 			})
 
-			editorRef.current = editor
-			setRenderEditor(editor)
+			setEditor(editor)
 
 			return () => {
 				editor.dispose()
 			}
 		},
 		// if any of these change, we need to recreate the editor.
-		[assetOptions, bindingUtils, container, options, shapeUtils, store, tools, user]
+		[bindingUtils, container, options, shapeUtils, store, tools, user, setEditor]
 	)
 
 	// keep the editor up to date with the latest camera options

commit 627c84c2af8144401b54c1729111d47a45ffeb8e
Author: alex <alex@dytry.ch>
Date:   Wed Jul 10 14:15:44 2024 +0100

    [2/4] Rename sync hooks, add bookmarks to demo (#4094)
    
    Adds a new `onEditorMount` callback to the store, allowing store
    creators to do things like registering bookmark handlers. We use this in
    the new demo hook.
    
    This also renames `useRemoteSyncClient` to `useMultiplayerSync`, and
    `useRemoteSyncDemo` to `useMultiplayerDemo`.
    
    Closes TLD-2601
    
    ### Change type
    
    - [x] `api`

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index b2138d1d7..8cd406627 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -450,7 +450,15 @@ function Layout({ children, onMount }: { children: ReactNode; onMount?: TLOnMoun
 	useCursor()
 	useDarkMode()
 	useForceUpdate()
-	useOnMount(onMount)
+	useOnMount((editor) => {
+		const teardownStore = editor.store.props.onEditorMount(editor)
+		const teardownCallback = onMount?.(editor)
+
+		return () => {
+			teardownStore?.()
+			teardownCallback?.()
+		}
+	})
 
 	return children
 }
@@ -474,7 +482,8 @@ export function ErrorScreen({ children }: LoadingScreenProps) {
 	return <div className="tl-loading">{children}</div>
 }
 
-function useOnMount(onMount?: TLOnMountHandler) {
+/** @internal */
+export function useOnMount(onMount?: TLOnMountHandler) {
 	const editor = useEditor()
 
 	const onMountEvent = useEvent((editor: Editor) => {

commit 69a1c17b463991882c49d1496d1efedcfa0a730f
Author: Mime Čuvalo <mimecuvalo@gmail.com>
Date:   Thu Jul 11 12:49:18 2024 +0100

    sdk: wires up tldraw to have licensing mechanisms (#4021)
    
    For non-commercial usage of tldraw, this adds a watermark in the corner,
    both for branding purposes and as an incentive for our enterprise
    customers to purchase a license.
    
    For commercial usage of tldraw, you add a license to the `<Tldraw
    licenseKey={YOUR_LICENSE_KEY} />` component so that the watermark
    doesn't show.
    
    The license is a signed key that has various bits of information in it,
    such as:
    - license type
    - hosts that the license is valid for
    - whether it's an internal-only license
    - expiry date
    
    We check the license on load and show a watermark (or throw an error if
    internal-only) if the license is not valid in a production environment.
    
    This is a @MitjaBezensek, @Taha-Hassan-Git, @mimecuvalo joint
    production! 🤜 🤛
    
    ### Change Type
    
    <!-- ❗ Please select a 'Scope' label ❗️ -->
    
    - [x] `sdk` — Changes the tldraw SDK
    - [ ] `dotcom` — Changes the tldraw.com web app
    - [ ] `docs` — Changes to the documentation, examples, or templates.
    - [ ] `vs code` — Changes to the vscode plugin
    - [ ] `internal` — Does not affect user-facing stuff
    
    <!-- ❗ Please select a 'Type' label ❗️ -->
    
    - [ ] `bugfix` — Bug fix
    - [x] `feature` — New feature
    - [ ] `improvement` — Improving existing features
    - [ ] `chore` — Updating dependencies, other boring stuff
    - [ ] `galaxy brain` — Architectural changes
    - [ ] `tests` — Changes to any test code
    - [ ] `tools` — Changes to infrastructure, CI, internal scripts,
    debugging tools, etc.
    - [ ] `dunno` — I don't know
    
    
    ### Test Plan
    
    1. We will be dogfooding on staging.tldraw.com and tldraw.com itself
    before releasing this.
    
    ### Release Notes
    
    - SDK: wires up tldraw to have licensing mechanisms.
    
    ---------
    
    Co-authored-by: Mitja Bezenšek <mitja.bezensek@gmail.com>
    Co-authored-by: Taha <98838967+Taha-Hassan-Git@users.noreply.github.com>
    Co-authored-by: Steve Ruiz <steveruizok@gmail.com>

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index 8cd406627..d8b7fa043 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -164,6 +164,11 @@ export interface TldrawEditorBaseProps {
 	 * Options for the editor.
 	 */
 	options?: Partial<TldrawOptions>
+
+	/**
+	 * The license key.
+	 */
+	licenseKey?: string
 }
 
 /**
@@ -187,6 +192,8 @@ declare global {
 const EMPTY_SHAPE_UTILS_ARRAY = [] as const
 const EMPTY_BINDING_UTILS_ARRAY = [] as const
 const EMPTY_TOOLS_ARRAY = [] as const
+/** @internal */
+export const TL_CONTAINER_CLASS = 'tl-container'
 
 /** @public @react */
 export const TldrawEditor = memo(function TldrawEditor({
@@ -217,7 +224,7 @@ export const TldrawEditor = memo(function TldrawEditor({
 		<div
 			ref={setContainer}
 			draggable={false}
-			className={classNames('tl-container tl-theme__light', className)}
+			className={classNames(`${TL_CONTAINER_CLASS} tl-theme__light`, className)}
 			onPointerDown={stopEventPropagation}
 			tabIndex={-1}
 		>
@@ -334,6 +341,7 @@ function TldrawEditorWithReadyStore({
 	inferDarkMode,
 	cameraOptions,
 	options,
+	licenseKey,
 }: Required<
 	TldrawEditorProps & {
 		store: TLStore
@@ -380,6 +388,7 @@ function TldrawEditorWithReadyStore({
 				inferDarkMode,
 				cameraOptions,
 				options,
+				licenseKey,
 			})
 
 			setEditor(editor)
@@ -389,7 +398,7 @@ function TldrawEditorWithReadyStore({
 			}
 		},
 		// if any of these change, we need to recreate the editor.
-		[bindingUtils, container, options, shapeUtils, store, tools, user, setEditor]
+		[bindingUtils, container, options, shapeUtils, store, tools, user, setEditor, licenseKey]
 	)
 
 	// keep the editor up to date with the latest camera options

commit 01bc73e750a9450eb135ad080a7087f494020b48
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Mon Jul 15 15:10:09 2024 +0100

    Editor.run, locked shapes improvements (#4042)
    
    This PR:
    - creates `Editor.run` (previously `Editor.batch`)
    - deprecates `Editor.batch`
    - introduces a `ignoreShapeLock` option top the `Editor.run` method that
    allows the editor to update and delete locked shapes
    - fixes a bug with `updateShapes` that allowed updating locked shapes
    - fixes a bug with `ungroupShapes` that allowed ungrouping locked shapes
    - makes `Editor.history` private
    - adds `Editor.squashToMark`
    - adds `Editor.clearHistory`
    - removes `History.ignore`
    - removes `History.onBatchComplete`
    - makes `_updateCurrentPageState` private
    
    ```ts
    editor.run(() => {
      editor.updateShape({ ...myLockedShape })
      editor.deleteShape(myLockedShape)
    }, { ignoreShapeLock: true })
    ```
    
    It also:
    
    ## How it works
    
    Normally `updateShape`/`updateShapes` and `deleteShape`/`deleteShapes`
    do not effect locked shapes.
    
    ```ts
    const myLockedShape = editor.getShape(myShapeId)!
    
    // no change from update
    editor.updateShape({ ...myLockedShape, x: 100 })
    expect(editor.getShape(myShapeId)).toMatchObject(myLockedShape)
    
    // no change from delete
    editor.deleteShapes([myLockedShape])
    expect(editor.getShape(myShapeId)).toMatchObject(myLockedShape)
    ```
    
    The new `run` method adds the option to ignore shape lock.
    
    ```ts
    const myLockedShape = editor.getShape(myShapeId)!
    
    // update works
    editor.run(() => { editor.updateShape({ ...myLockedShape, x: 100 }) }, { ignoreShapeLock: true })
    expect(editor.getShape(myShapeId)).toMatchObject({ ...myLockedShape, x: 100 })
    
    // delete works
    editor.run(() => { editor.deleteShapes([myLockedShape]), { ignoreShapeLock: true })
    expect(editor.getShape(myShapeId)).toBeUndefined()
    ```
    
    ## History changes
    
    This is a related but not entirely related change in this PR.
    
    Previously, we had a few ways to run code that ignored the history.
    
    - `editor.history.ignore(() => { ... })`
    - `editor.batch(() => { ... }, { history: "ignore" })`
    - `editor.history.batch(() => { ... }, { history: "ignore" })`
    - `editor.updateCurrentPageState(() => { ... }, { history: "ignore" })`
    
    We now have one way to run code that ignores history:
    
    - `editor.run(() => { ... }, { history: "ignore" })`
    
    ## Design notes
    
    We want a user to be able to update or delete locked shapes
    programmatically.
    
    ### Callback vs. method options?
    
    We could have added a `{ force: boolean }` property to the
    `updateShapes` / `deleteShapes` methods, however there are places where
    those methods are called from other methods (such as
    `distributeShapes`). If we wanted to make these work, we would have also
    had to provide a `force` option / bag to those methods.
    
    Using a wrapper callback allows for "regular" tldraw editor code to work
    while allowing for updates and deletes.
    
    ### Interaction logic?
    
    We don't want this change to effect any of our interaction logic.
    
    A lot of our interaction logic depends on identifying which shapes are
    locked and which shapes aren't. For example, clicking on a locked shape
    will go to the `pointing_canvas` state rather than the `pointing_shape`.
    This PR has no effect on that part of the library.
    
    It only effects the updateShapes and deleteShapes methods. As an example
    of this, when `_force` is set to true by default, the only tests that
    should fail are in `lockedShapes.test.ts`. The "user land" experience of
    locked shapes is identical to what it is now.
    
    ### Change type
    
    - [x] `bugfix`
    - [ ] `improvement`
    - [x] `feature`
    - [x] `api`
    - [ ] `other`
    
    ### Test plan
    
    1. Create a shape
    2. Lock it
    3. From the console, update it
    4. From the console, delete it
    
    - [x] Unit tests
    
    ### Release notes
    
    - SDK: Adds `Editor.force()` to permit updating / deleting locked shapes
    - Fixed a bug that would allow locked shapes to be updated
    programmatically
    - Fixed a bug that would allow locked group shapes to be ungrouped
    programmatically
    
    ---------
    
    Co-authored-by: alex <alex@dytry.ch>

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index d8b7fa043..136fa399c 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -497,10 +497,15 @@ export function useOnMount(onMount?: TLOnMountHandler) {
 
 	const onMountEvent = useEvent((editor: Editor) => {
 		let teardown: (() => void) | void = undefined
-		editor.history.ignore(() => {
-			teardown = onMount?.(editor)
-			editor.emit('mount')
-		})
+		// If the user wants to do something when the editor mounts, we make sure it doesn't effect the history.
+		// todo: is this reeeeally what we want to do, or should we leave it up to the caller?
+		editor.run(
+			() => {
+				teardown = onMount?.(editor)
+				editor.emit('mount')
+			},
+			{ history: 'ignore' }
+		)
 		window.tldrawReady = true
 		return teardown
 	})

commit 48d1f4e0d725b6bf620e957c34d013337c426ac2
Author: alex <alex@dytry.ch>
Date:   Tue Jul 16 14:24:44 2024 +0100

    add version attribute (#4192)
    
    Occasionally I come across tldraw in the wild and want to see what
    version it is.
    
    ### Change type
    
    - [x] `other`

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index 136fa399c..3382e453b 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -12,6 +12,7 @@ import React, {
 } from 'react'
 
 import classNames from 'classnames'
+import { version } from '../version'
 import { OptionalErrorBoundary } from './components/ErrorBoundary'
 import { DefaultErrorFallback } from './components/default-components/DefaultErrorFallback'
 import { TLEditorSnapshot } from './config/TLEditorSnapshot'
@@ -223,6 +224,7 @@ export const TldrawEditor = memo(function TldrawEditor({
 	return (
 		<div
 			ref={setContainer}
+			data-tldraw={version}
 			draggable={false}
 			className={classNames(`${TL_CONTAINER_CLASS} tl-theme__light`, className)}
 			onPointerDown={stopEventPropagation}

commit 146965c2405eb4756c4952b55c61dbf6234d38ed
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Thu Jul 18 12:59:02 2024 +0100

    Watermark II (#4196)
    
    This PR is a second go at the watermark.
    
    ![localhost_5420_develop
    (1)](https://github.com/user-attachments/assets/70757e93-d8e5-4c96-b6ca-30dfbf1c21b1)
    
    It:
    - updates the watermark icon
    - removes the watermark on small devices
    - makes the watermark a react component with inline styles
      - the classname for these styles is based on the current version
    - improves the interactions around the watermark
      - the watermark requires a short delay before accepting events
      - events prior to that delay will be passed to the canvas
      - events after that delay will interact with the link to tldraw.dev
      - prevents interactions with the watermark while a menu is open
      - moves the watermark up when debug mode is active
    
    It also:
    - moves the "is unlicensed" logic into the license manager
    - adds the license manager as a private member of the editor class
    - removes the watermark manager
    
    ## Some thoughts
    
    I couldn't get the interaction we wanted from the watermark manager
    itself. It's important that this just the right amount of disruptive,
    and accidental clicks seemed to be a step too far. After some thinking,
    I think an improved experience is worth a little less security.
    
    Using a React component (with CSS styling) felt acceptable as long as we
    provided our own "inline" style sheet. My previous concern was that we'd
    designed a system where external CSS is acceptable, and so would require
    other users to provide our watermark CSS with any of their own CSS; but
    inline styles fix that.
    
    ### Change type
    
    - [x] `other`
    
    ### Test plan
    
    1. Same as the previous watermark tests.
    
    - [x] Unit tests
    
    ---------
    
    Co-authored-by: Mime Čuvalo <mimecuvalo@gmail.com>

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index 3382e453b..1ca323ac8 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -37,6 +37,8 @@ import { useForceUpdate } from './hooks/useForceUpdate'
 import { useLocalStore } from './hooks/useLocalStore'
 import { useRefState } from './hooks/useRefState'
 import { useZoomCss } from './hooks/useZoomCss'
+import { LicenseProvider } from './license/LicenseProvider'
+import { Watermark } from './license/Watermark'
 import { TldrawOptions } from './options'
 import { stopEventPropagation } from './utils/dom'
 import { TLStoreWithStatus } from './utils/sync/StoreWithStatus'
@@ -235,22 +237,24 @@ export const TldrawEditor = memo(function TldrawEditor({
 				onError={(error) => annotateError(error, { tags: { origin: 'react.tldraw-before-app' } })}
 			>
 				{container && (
-					<ContainerProvider container={container}>
-						<EditorComponentsProvider overrides={components}>
-							{store ? (
-								store instanceof Store ? (
-									// Store is ready to go, whether externally synced or not
-									<TldrawEditorWithReadyStore {...withDefaults} store={store} user={user} />
+					<LicenseProvider licenseKey={rest.licenseKey}>
+						<ContainerProvider container={container}>
+							<EditorComponentsProvider overrides={components}>
+								{store ? (
+									store instanceof Store ? (
+										// Store is ready to go, whether externally synced or not
+										<TldrawEditorWithReadyStore {...withDefaults} store={store} user={user} />
+									) : (
+										// Store is a synced store, so handle syncing stages internally
+										<TldrawEditorWithLoadingStore {...withDefaults} store={store} user={user} />
+									)
 								) : (
-									// Store is a synced store, so handle syncing stages internally
-									<TldrawEditorWithLoadingStore {...withDefaults} store={store} user={user} />
-								)
-							) : (
-								// We have no store (it's undefined) so create one and possibly sync it
-								<TldrawEditorWithOwnStore {...withDefaults} store={store} user={user} />
-							)}
-						</EditorComponentsProvider>
-					</ContainerProvider>
+									// We have no store (it's undefined) so create one and possibly sync it
+									<TldrawEditorWithOwnStore {...withDefaults} store={store} user={user} />
+								)}
+							</EditorComponentsProvider>
+						</ContainerProvider>
+					</LicenseProvider>
 				)}
 			</OptionalErrorBoundary>
 		</div>
@@ -449,7 +453,10 @@ function TldrawEditorWithReadyStore({
 				<Crash crashingError={crashingError} />
 			) : (
 				<EditorContext.Provider value={editor}>
-					<Layout onMount={onMount}>{children ?? (Canvas ? <Canvas /> : null)}</Layout>
+					<Layout onMount={onMount}>
+						{children ?? (Canvas ? <Canvas /> : null)}
+						<Watermark />
+					</Layout>
 				</EditorContext.Provider>
 			)}
 		</OptionalErrorBoundary>

commit f6a352b2aa283de5cdc19d07ceb8719b5dc4c676
Author: alex <alex@dytry.ch>
Date:   Thu Jul 25 12:04:12 2024 +0100

    fix assets prop on tldraw component (#4283)
    
    This wasn't getting passed into `useLocalStore` correctly.
    
    ### Change type
    
    - [x] `bugfix`
    
    ### Release notes
    
    - The `assets` prop on the `<Tldraw />` and `<TldrawEditor />`
    components is now respected.

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index 1ca323ac8..7da7fab71 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -276,6 +276,7 @@ function TldrawEditorWithOwnStore(
 		persistenceKey,
 		sessionId,
 		user,
+		assets,
 	} = props
 
 	const syncedStore = useLocalStore({
@@ -286,6 +287,7 @@ function TldrawEditorWithOwnStore(
 		sessionId,
 		defaultName,
 		snapshot,
+		assets,
 	})
 
 	return <TldrawEditorWithLoadingStore {...props} store={syncedStore} user={user} />

commit c8dd23faa62730b2e9353401057fb12a71af4bae
Author: alex <alex@dytry.ch>
Date:   Tue Jul 30 17:37:53 2024 +0100

    remove onEditorMount prop (#4320)
    
    This was showing up where it shouldn't, so lets rename it to `onMount`
    so it merges with the standard option.
    
    ### Change type
    
    - [x] `api`
    
    ### Release notes
    
    - **Breaking:** the `onEditorMount` option to `createTLStore` is now
    called `onMount`

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index 7da7fab71..37b29935b 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -471,7 +471,7 @@ function Layout({ children, onMount }: { children: ReactNode; onMount?: TLOnMoun
 	useDarkMode()
 	useForceUpdate()
 	useOnMount((editor) => {
-		const teardownStore = editor.store.props.onEditorMount(editor)
+		const teardownStore = editor.store.props.onMount(editor)
 		const teardownCallback = onMount?.(editor)
 
 		return () => {

commit c9ccdc22f1312fa46c9289314f6f833e28b3e66c
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Mon Aug 5 14:18:21 2024 +0100

    Preserve focus search param (#4344)
    
    This PR adds a kinda-secret "preserve focus" mode using the
    `preserveFocus` search param, along with the behavior for handling focus
    in that state.
    
    In many of our examples, we want `autoFocus` to be true. However, in our
    docs site, we want each example's `autoFocus` to be false, and for the
    editor to be focused only when clicked on and blurred when clicking
    away.
    
    One solution, which this PR implements, is to use a search parameter
    that says "if the URL has a `preserveFocus` search parameter, then even
    if `autoFocus` is true, start unfocused`. It also implements that "click
    to focus, click away to blur" behavior.
    
    We could add support via a prop, however I'm not entirely sure about
    this feature so would prefer to keep it internal for now. Either way, we
    would want our docs examples to all use `preserveFocus` routes.
    
    ### Change type
    
    - [ ] `bugfix`
    - [x] `improvement`
    - [ ] `feature`
    - [ ] `api`
    - [ ] `other`
    
    ### Test plan
    
    1. Visit the examples page in our docs.
    2. The example should not have focus. Kbds should not work.
    3. Click on the example to give it focus. Kbds should work.
    4. Click away to blur the editor. Kbds should not work.

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index 37b29935b..f5421ae2f 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -5,6 +5,7 @@ import React, {
 	ReactNode,
 	memo,
 	useCallback,
+	useEffect,
 	useLayoutEffect,
 	useMemo,
 	useRef,
@@ -336,6 +337,8 @@ const TldrawEditorWithLoadingStore = memo(function TldrawEditorBeforeLoading({
 	return <TldrawEditorWithReadyStore {...rest} store={store.store} user={user} />
 })
 
+const noAutoFocus = () => document.location.search.includes('tldraw_preserve_focus')
+
 function TldrawEditorWithReadyStore({
 	onMount,
 	children,
@@ -365,16 +368,17 @@ function TldrawEditorWithReadyStore({
 	// props in this ref can be changed without causing the editor to be recreated.
 	const editorOptionsRef = useRef({
 		// for these, it's because they're only used when the editor first mounts:
-		autoFocus,
+		autoFocus: autoFocus && !noAutoFocus(),
 		inferDarkMode,
 		initialState,
 
 		// for these, it's because we keep them up to date in a separate effect:
 		cameraOptions,
 	})
+
 	useLayoutEffect(() => {
 		editorOptionsRef.current = {
-			autoFocus,
+			autoFocus: autoFocus && !noAutoFocus(),
 			inferDarkMode,
 			initialState,
 			cameraOptions,
@@ -392,6 +396,7 @@ function TldrawEditorWithReadyStore({
 				getContainer: () => container,
 				user,
 				initialState,
+				// we should check for some kind of query parameter that turns off autofocus
 				autoFocus,
 				inferDarkMode,
 				cameraOptions,
@@ -432,6 +437,38 @@ function TldrawEditorWithReadyStore({
 		() => editor?.getCrashingError() ?? null
 	)
 
+	// For our examples site, we want autoFocus to be true on the examples site, but not
+	// when embedded in our docs site. If present, the `tldraw_preserve_focus` search param
+	// overrides the `autoFocus` prop and prevents the editor from focusing immediately,
+	// however here we also add some logic to focus the editor when the user clicks
+	// on it and unfocus it when the user clicks away from it.
+	useEffect(
+		function handleFocusOnPointerDownForPreserveFocusMode() {
+			if (!editor) return
+
+			function handleFocusOnPointerDown() {
+				if (!editor) return
+				editor.focus()
+			}
+
+			function handleBlurOnPointerDown() {
+				if (!editor) return
+				editor.blur()
+			}
+
+			if (autoFocus && noAutoFocus()) {
+				editor.getContainer().addEventListener('pointerdown', handleFocusOnPointerDown)
+				document.body.addEventListener('pointerdown', handleBlurOnPointerDown)
+
+				return () => {
+					editor.getContainer()?.removeEventListener('pointerdown', handleFocusOnPointerDown)
+					document.body.removeEventListener('pointerdown', handleBlurOnPointerDown)
+				}
+			}
+		},
+		[editor, autoFocus]
+	)
+
 	const { Canvas } = useEditorComponents()
 
 	if (!editor) {

commit b0e56ac60289a15e290418ca488f0cc0f8172890
Author: Lukas Wiesehan <45076462+lukaswiesehan@users.noreply.github.com>
Date:   Mon Aug 5 21:02:27 2024 +0200

    Docs Redesign (#4078)
    
    Full redesign of the docs, also adding landing page and blog pages.
    
    ### Change type
    
    - [x] `improvement`
    - [x] `feature`
    
    ---------
    
    Co-authored-by: Steve Ruiz <steveruizok@gmail.com>
    Co-authored-by: alex <alex@dytry.ch>

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index f5421ae2f..41d21a75a 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -337,7 +337,8 @@ const TldrawEditorWithLoadingStore = memo(function TldrawEditorBeforeLoading({
 	return <TldrawEditorWithReadyStore {...rest} store={store.store} user={user} />
 })
 
-const noAutoFocus = () => document.location.search.includes('tldraw_preserve_focus')
+const noAutoFocus = () =>
+	document.location.search.includes('tldraw_preserve_focus') || !document.hasFocus()
 
 function TldrawEditorWithReadyStore({
 	onMount,

commit 6c83dfbaf37fcfbcd5987fd476cfbae5d7111c7a
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Fri Aug 9 17:34:22 2024 +0100

    Remove the document.hasFocus check (#4373)
    
    Unfortunately it doesn't work reliably, at least not in nextjs apps.
    
    ### Change type
    
    - [x] `bugfix`

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index 41d21a75a..ee569e500 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -337,8 +337,7 @@ const TldrawEditorWithLoadingStore = memo(function TldrawEditorBeforeLoading({
 	return <TldrawEditorWithReadyStore {...rest} store={store.store} user={user} />
 })
 
-const noAutoFocus = () =>
-	document.location.search.includes('tldraw_preserve_focus') || !document.hasFocus()
+const noAutoFocus = () => document.location.search.includes('tldraw_preserve_focus') // || !document.hasFocus() // breaks in nextjs
 
 function TldrawEditorWithReadyStore({
 	onMount,

commit 42de01d57230caac87ba34571b77c27e52d37a37
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Tue Aug 13 08:15:41 2024 +0100

    Deep Links (#4333)
    
    Deep Links are URLs which point to a specific part of a document. We
    provide a comprehensive set of tools to help you create and manage deep
    links in your application.
    
    ## The `deepLinks` prop
    
    The highest-level API for managing deep links is the `deepLinks` prop on
    the `<Tldraw />` component. This prop is designed for manipulating
    `window.location` to add a search param which tldraw can use to navigate
    to a specific part of the document.
    
    e.g. `https://my-app.com/document-name?d=v1234.-234.3.21`
    
    If you set `deepLinks` to `true` e.g. `<Tldraw deepLinks />` the
    following default behavior will be enabled:
    
    1. When the editor initializes, before the initial render, it will check
    the current `window.location` for a search param called `d`. If found,
    it will try to parse the value of this param as a deep link and navigate
    to that part of the document.
    2. 500 milliseconds after every time the editor finishes navigating to a
    new part of the document, it will update `window.location` to add the
    latest version of the `d` param.
    
    You can customize this behavior by passing a configuration object as the
    `deepLinks` prop. e.g.
    
    ```tsx
    <Tldraw
            deepLinks={{
                    // change the param name to `page`
                    paramName: 'page',
                    // only link to the current page
                    getTarget(editor) {
                            return { type: 'page', pageId: editor.getCurrentPageId() }
                    },
                    // log the new search params to the console instead of updating `window.location`
                    onChange(url) {
                            console.log('the new search params are', url.searchParams)
                    },
                    // set the debounce interval to 100ms instead of 500ms
                    debounceMs: 100,
            }}
    />
    ```
    
    For full options see the [`TLDeepLinkOptions`](?) API reference.
    
    ## Handling deep links manually
    
    We expose the core functionality for managing deep links as a set of
    methods and utilities. This gives you more control e.g. if you prefer
    not to use search params in the URL.
    
    ### Creating a deep link
    
    You can create an isolated deep link string using the
    [`createDeepLinkString`](?) helper which takes a [`TLDeepLink`](?)
    descriptor object.
    
    ```tsx
    createDeepLinkString({ type: 'page', pageId: 'page:abc123' })
    // => 'pabc123'
    createDeepLinkString({ type: 'shapes', shapeIds: ['shape:foo', 'shape:bar'] })
    // => 'sfoo.bar'
    createDeepLinkString({
            type: 'viewport',
            pageId: 'page:abc123',
            bounds: {
                    x: 0,
                    y: 0,
                    w: 1024,
                    h: 768,
            },
    })
    // => 'v0.0.1024.768.abc123'
    ```
    
    If you do prefer to put this in a URL as a query param, you can use the
    [`Editor#createDeepLink`](?) method.
    
    ```tsx
    editor.createDeepLink({ to: { type: 'page', pageId: 'page:abc123' } })
    // => 'https://my-app.com/document-name?d=pabc123'
    ```
    
    ### Handling a deep link
    
    You can parse a deep link string with [`parseDeepLinkString`](?) which
    returns a [`TLDeepLink`](?) descriptor object.
    
    You can then call [`Editor#handleDeepLink`](?) with this descriptor to
    navigate to the part of the document described by the deep link.
    
    `Editor#handleDeepLink` also can take a plain URL if the deep link is
    encoded as a query param.
    
    ```tsx
    editor.handleDeepLink(parseDeepLinkString('pabc123'))
    // or pass in a url
    editor.handleDeepLink({ url: 'https://my-app.com/document-name?d=pabc123' })
    // or call without options to use the current `window.location`
    editor.handleDeepLink()
    ```
    
    ### Listening for deep link changes
    
    You can listen for deep link changes with the
    [`Editor#registerDeepLinkListener`](?) method, which takes the same
    options as the `deepLinks` prop.
    
    ```tsx
    useEffect(() => {
            const unlisten = editor.registerDeepLinkListener({
                    paramName: 'page',
                    getTarget(editor) {
                            return { type: 'page', pageId: editor.getCurrentPageId() }
                    },
                    onChange(url) {
                            console.log('the new search params are', url.searchParams)
                    },
                    debounceMs: 100,
            })
            return () => {
                    unlisten()
            }
    }, [])
    ```
    
    ### Change type
    
    - [ ] `bugfix`
    - [x] `improvement`
    - [ ] `feature`
    - [x] `api`
    - [ ] `other`
    
    ### Release notes
    
    - Added support for managing deep links.

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index ee569e500..63a7a8aeb 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -13,6 +13,7 @@ import React, {
 } from 'react'
 
 import classNames from 'classnames'
+import { TLDeepLinkOptions } from '..'
 import { version } from '../version'
 import { OptionalErrorBoundary } from './components/ErrorBoundary'
 import { DefaultErrorFallback } from './components/default-components/DefaultErrorFallback'
@@ -35,6 +36,7 @@ import {
 } from './hooks/useEditorComponents'
 import { useEvent } from './hooks/useEvent'
 import { useForceUpdate } from './hooks/useForceUpdate'
+import { useShallowObjectIdentity } from './hooks/useIdentity'
 import { useLocalStore } from './hooks/useLocalStore'
 import { useRefState } from './hooks/useRefState'
 import { useZoomCss } from './hooks/useZoomCss'
@@ -173,6 +175,11 @@ export interface TldrawEditorBaseProps {
 	 * The license key.
 	 */
 	licenseKey?: string
+
+	/**
+	 * Options for syncing the editor's camera state with the URL.
+	 */
+	deepLinks?: true | TLDeepLinkOptions
 }
 
 /**
@@ -353,6 +360,7 @@ function TldrawEditorWithReadyStore({
 	cameraOptions,
 	options,
 	licenseKey,
+	deepLinks: _deepLinks,
 }: Required<
 	TldrawEditorProps & {
 		store: TLStore
@@ -365,6 +373,10 @@ function TldrawEditorWithReadyStore({
 
 	const [editor, setEditor] = useRefState<Editor | null>(null)
 
+	const canvasRef = useRef<HTMLDivElement | null>(null)
+
+	const deepLinks = useShallowObjectIdentity(_deepLinks === true ? {} : _deepLinks)
+
 	// props in this ref can be changed without causing the editor to be recreated.
 	const editorOptionsRef = useRef({
 		// for these, it's because they're only used when the editor first mounts:
@@ -374,6 +386,7 @@ function TldrawEditorWithReadyStore({
 
 		// for these, it's because we keep them up to date in a separate effect:
 		cameraOptions,
+		deepLinks,
 	})
 
 	useLayoutEffect(() => {
@@ -382,12 +395,14 @@ function TldrawEditorWithReadyStore({
 			inferDarkMode,
 			initialState,
 			cameraOptions,
+			deepLinks,
 		}
-	}, [autoFocus, inferDarkMode, initialState, cameraOptions])
+	}, [autoFocus, inferDarkMode, initialState, cameraOptions, deepLinks])
 
 	useLayoutEffect(
 		() => {
-			const { autoFocus, inferDarkMode, initialState, cameraOptions } = editorOptionsRef.current
+			const { autoFocus, inferDarkMode, initialState, cameraOptions, deepLinks } =
+				editorOptionsRef.current
 			const editor = new Editor({
 				store,
 				shapeUtils,
@@ -404,6 +419,20 @@ function TldrawEditorWithReadyStore({
 				licenseKey,
 			})
 
+			editor.updateViewportScreenBounds(canvasRef.current ?? container)
+
+			// Use the ref here because we only want to do this once when the editor is created.
+			// We don't want changes to the urlStateSync prop to trigger creating new editors.
+			if (deepLinks) {
+				if (!deepLinks?.getUrl) {
+					// load the state from window.location
+					editor.navigateToDeepLink(deepLinks)
+				} else {
+					// load the state from the provided URL
+					editor.navigateToDeepLink({ ...deepLinks, url: deepLinks.getUrl(editor) })
+				}
+			}
+
 			setEditor(editor)
 
 			return () => {
@@ -414,6 +443,13 @@ function TldrawEditorWithReadyStore({
 		[bindingUtils, container, options, shapeUtils, store, tools, user, setEditor, licenseKey]
 	)
 
+	useLayoutEffect(() => {
+		if (!editor) return
+		if (deepLinks) {
+			return editor.registerDeepLinkListener(deepLinks)
+		}
+	}, [editor, deepLinks])
+
 	// keep the editor up to date with the latest camera options
 	useLayoutEffect(() => {
 		if (editor && cameraOptions) {
@@ -472,7 +508,7 @@ function TldrawEditorWithReadyStore({
 	const { Canvas } = useEditorComponents()
 
 	if (!editor) {
-		return null
+		return <div className="tl-canvas" ref={canvasRef} />
 	}
 
 	return (

commit 7d0433e91822f9a65a6b5d735918489822849bf0
Author: alex <alex@dytry.ch>
Date:   Wed Sep 4 16:33:26 2024 +0100

    add default <foreignObject> based export for shapes (#4403)
    
    Custom shapes (and our own bookmark shapes) now support SVG exports by
    default! The default implementation isn't the most efficient and won't
    work in all SVG environments, but you can still write your own if
    needed. It's pretty reliable though!
    
    ![Kapture 2024-08-27 at 17 29
    31](https://github.com/user-attachments/assets/3870e82b-b77b-486b-92b0-420921df8d51)
    
    This introduces a couple of new APIs for co-ordinating SVG exports. The
    main one is `useDelaySvgExport`. This is useful when your component
    might take a while to load, and you need to delay the export is until
    everything is ready & rendered. You use it like this:
    ```tsx
    function MyComponent() {
        const exportIsReady = useDelaySvgExport()
        const [dynamicData, setDynamicData] = useState(null)
    
        useEffect(() => {
            loadDynamicData.then((data) => {
                setDynamicData(data)
                exportIsReady()
            })
        })
    
        return <MyList data={data} />
    }
    ```
    
    This is a pretty low-level API that I wouldn't expect most people using
    these exports to need, but it does come in handy for some things.
    
    ### Change type
    
    - [x] `improvement`
    
    ### Release notes
    
    Custom shapes (and our own bookmark shapes) now render in image exports
    by default.
    
    ---------
    
    Co-authored-by: huppy-bot[bot] <128400622+huppy-bot[bot]@users.noreply.github.com>

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index 63a7a8aeb..001d676ae 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -9,6 +9,7 @@ import React, {
 	useLayoutEffect,
 	useMemo,
 	useRef,
+	useState,
 	useSyncExternalStore,
 } from 'react'
 
@@ -214,7 +215,7 @@ export const TldrawEditor = memo(function TldrawEditor({
 	user: _user,
 	...rest
 }: TldrawEditorProps) {
-	const [container, setContainer] = React.useState<HTMLDivElement | null>(null)
+	const [container, setContainer] = useState<HTMLElement | null>()
 	const user = useMemo(() => _user ?? createTLUser(), [_user])
 
 	const ErrorFallback =

commit 028424e941efd35c667c4b06911c5032d812744f
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Mon Sep 16 09:11:46 2024 +0100

    [fix] container null error (#4524)
    
    fixes this
    https://discord.com/channels/859816885297741824/1284393150928125994/1284393150928125994
    (apparently? i wasn't able to reproduce, and a quick search didn't
    reveal how this could happen in any of our own components, so maybe it
    was a custom component?)
    
    ### Change type
    
    - [x] `bugfix`
    
    ### Release notes
    
    - Fixed a minor bug related to useContainer's return value being
    potentially returned from components?

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index 001d676ae..8d90f7840 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -215,7 +215,7 @@ export const TldrawEditor = memo(function TldrawEditor({
 	user: _user,
 	...rest
 }: TldrawEditorProps) {
-	const [container, setContainer] = useState<HTMLElement | null>()
+	const [container, setContainer] = useState<HTMLElement | null>(null)
 	const user = useMemo(() => _user ?? createTLUser(), [_user])
 
 	const ErrorFallback =

commit b33cc2e6b0f2630ec328018f592e3d301b90efaf
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Mon Sep 23 18:07:34 2024 +0100

    [feature] isShapeHidden option (#4446)
    
    This PR adds an option to the Editor that allows people to control the
    visibility of shapes. This has been requested a couple of times for
    different use-cases:
    
    - A layer panel with a visibility toggle per shape
    - A kind-of 'private' drawing mode in a multiplayer app.
    
    So to test this feature out I've implemented both of those in minimal
    ways as examples.
    
    ### Change type
    
    - [x] `feature`
    
    
    ### Test plan
    
    - [x] Unit tests
    
    
    ### Release notes
    
    - Adds an `isShapeHidden` option, which allows you to provide custom
    logic to decide whether or not a shape should be shown on the canvas.

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index 8d90f7840..a7750d60e 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -1,5 +1,5 @@
 import { MigrationSequence, Store } from '@tldraw/store'
-import { TLStore, TLStoreSnapshot } from '@tldraw/tlschema'
+import { TLShape, TLStore, TLStoreSnapshot } from '@tldraw/tlschema'
 import { Required, annotateError } from '@tldraw/utils'
 import React, {
 	ReactNode,
@@ -181,6 +181,15 @@ export interface TldrawEditorBaseProps {
 	 * Options for syncing the editor's camera state with the URL.
 	 */
 	deepLinks?: true | TLDeepLinkOptions
+
+	/**
+	 * Predicate for whether or not a shape should be hidden.
+	 *
+	 * Hidden shapes will not render in the editor, and they will not be eligible for hit test via
+	 * {@link Editor#getShapeAtPoint} and {@link Editor#getShapesAtPoint}. But otherwise they will
+	 * remain in the store and participate in all other operations.
+	 */
+	isShapeHidden?(shape: TLShape, editor: Editor): boolean
 }
 
 /**
@@ -362,6 +371,7 @@ function TldrawEditorWithReadyStore({
 	options,
 	licenseKey,
 	deepLinks: _deepLinks,
+	isShapeHidden,
 }: Required<
 	TldrawEditorProps & {
 		store: TLStore
@@ -418,6 +428,7 @@ function TldrawEditorWithReadyStore({
 				cameraOptions,
 				options,
 				licenseKey,
+				isShapeHidden,
 			})
 
 			editor.updateViewportScreenBounds(canvasRef.current ?? container)
@@ -441,7 +452,18 @@ function TldrawEditorWithReadyStore({
 			}
 		},
 		// if any of these change, we need to recreate the editor.
-		[bindingUtils, container, options, shapeUtils, store, tools, user, setEditor, licenseKey]
+		[
+			bindingUtils,
+			container,
+			options,
+			shapeUtils,
+			store,
+			tools,
+			user,
+			setEditor,
+			licenseKey,
+			isShapeHidden,
+		]
 	)
 
 	useLayoutEffect(() => {

commit d5f4c1d05bb834ab5623d19d418e31e4ab5afa66
Author: alex <alex@dytry.ch>
Date:   Wed Oct 9 15:55:15 2024 +0100

    make sure DOM IDs are globally unique (#4694)
    
    There are a lot of places where we currently derive a DOM ID from a
    shape ID. This works fine (ish) on tldraw.com, but doesn't work for a
    lot of developer use-cases: if there are multiple tldraw instances or
    exports happening, for example. This is because the DOM expects IDs to
    be globally unique. If there are multiple elements with the same ID in
    the dom, only the first is ever used. This can cause issues if e.g.
    
    1. i have a shape with a clip-path determined by the shape ID
    2. i export that shape and add the resulting SVG to the dom. now, there
    are two clip paths with the same ID, but they're the same
    3. I change the shape - and now, the ID is referring to the export, so i
    get weird rendering issues.
    
    This diff attempts to resolve this issue and prevent it from happening
    again by introducing a new `SafeId` type, and helpers for generating and
    working with `SafeId`s. in tldraw, jsx using the `id` attribute will now
    result in a type error if the value isn't a safe ID. This doesn't affect
    library consumers writing JSX.
    
    As part of this, I've removed the ID that were added to certain shapes.
    Instead, all shapes now have a `data-shape-id` attribute on their
    wrapper.
    
    ### Change type
    
    - [x] `bugfix`
    
    ### Release notes
    
    - Exports and other tldraw instances no longer can affect how each other
    are rendered
    - **BREAKING:** the `id` attribute that was present on some shapes in
    the dom has been removed. there's now a data-shape-id attribute on every
    shape wrapper instead though.

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index a7750d60e..cedf706b4 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -29,7 +29,7 @@ import { TLCameraOptions } from './editor/types/misc-types'
 import { ContainerProvider, useContainer } from './hooks/useContainer'
 import { useCursor } from './hooks/useCursor'
 import { useDarkMode } from './hooks/useDarkMode'
-import { EditorContext, useEditor } from './hooks/useEditor'
+import { EditorProvider, useEditor } from './hooks/useEditor'
 import {
 	EditorComponentsProvider,
 	TLEditorComponents,
@@ -550,12 +550,12 @@ function TldrawEditorWithReadyStore({
 			{crashingError ? (
 				<Crash crashingError={crashingError} />
 			) : (
-				<EditorContext.Provider value={editor}>
+				<EditorProvider editor={editor}>
 					<Layout onMount={onMount}>
 						{children ?? (Canvas ? <Canvas /> : null)}
 						<Watermark />
 					</Layout>
-				</EditorContext.Provider>
+				</EditorProvider>
 			)}
 		</OptionalErrorBoundary>
 	)

commit 59cdaea8c4a1f7a57ed9256022ba4735158a9086
Author: alex <alex@dytry.ch>
Date:   Wed Oct 23 15:13:48 2024 +0100

    make options object stable (#4762)
    
    If you write code like `<Tldraw options={{maxPages: 1}} />` that also
    e.g. sets state on mount or otherwise re-renders, getting a fresh
    options object will cause the editor to reload even though the options
    are the same. You have to memoize options, or specify them outside of
    your component.
    
    This diff uses `useShallowObjectIdentity` to stop identical sets of
    options from causing the editor to get recreated.
    
    ### Change type
    
    - [x] `api`
    
    ### Release notes
    
    - Writing `options` inline in the Tldraw component will no longer cause
    re-render loops

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index cedf706b4..a80059710 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -222,6 +222,7 @@ export const TldrawEditor = memo(function TldrawEditor({
 	components,
 	className,
 	user: _user,
+	options: _options,
 	...rest
 }: TldrawEditorProps) {
 	const [container, setContainer] = useState<HTMLElement | null>(null)
@@ -239,6 +240,7 @@ export const TldrawEditor = memo(function TldrawEditor({
 		bindingUtils: rest.bindingUtils ?? EMPTY_BINDING_UTILS_ARRAY,
 		tools: rest.tools ?? EMPTY_TOOLS_ARRAY,
 		components,
+		options: useShallowObjectIdentity(_options),
 	}
 
 	return (

commit ed2113d0c81d8fa0e0e83806e4a36f385d272a96
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Mon Dec 16 11:26:32 2024 +0100

    fix hot reload text measurement bug (#5125)
    
    fixes
    https://github.com/tldraw/tldraw/issues/5047#issuecomment-2544070258
    
    the problem was that during hot reload react was rerendering the
    container elem but the editor wasn't recreated at the same, so the
    sneaky div that the text measurement manager adds was being disconnected
    from the DOM.
    
    ### Change type
    
    - [x] `bugfix`

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index a80059710..b1413336d 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -554,7 +554,7 @@ function TldrawEditorWithReadyStore({
 			) : (
 				<EditorProvider editor={editor}>
 					<Layout onMount={onMount}>
-						{children ?? (Canvas ? <Canvas /> : null)}
+						{children ?? (Canvas ? <Canvas key={editor.contextId} /> : null)}
 						<Watermark />
 					</Layout>
 				</EditorProvider>

commit ed9c077994c4e97d352a59385183686585510e14
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Mon Jan 13 11:26:18 2025 +0000

    pass custom migrations to useLocalStore (#5135)
    
    Fixes
    https://discord.com/channels/859816885297741824/859816885801713728/1318729897958707312
    
    Fixed a bug with locally synced stores where custom migrations were not
    being passed to the store constructor
    
    ### Change type
    
    - [x] `bugfix`
    
    ### Release notes
    
    - Fixed a bug with locally synced stores where custom migrations were
    not being passed to the store constructor.

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index b1413336d..945d693cb 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -297,6 +297,7 @@ function TldrawEditorWithOwnStore(
 		sessionId,
 		user,
 		assets,
+		migrations,
 	} = props
 
 	const syncedStore = useLocalStore({
@@ -308,6 +309,7 @@ function TldrawEditorWithOwnStore(
 		defaultName,
 		snapshot,
 		assets,
+		migrations,
 	})
 
 	return <TldrawEditorWithLoadingStore {...props} store={syncedStore} user={user} />

commit 3bf31007c5a7274f3f7926a84c96c89a4cc2c278
Author: Mime Čuvalo <mimecuvalo@gmail.com>
Date:   Mon Mar 3 14:23:09 2025 +0000

    [feature] add rich text and contextual toolbar (#4895)
    
    We're looking to add rich text to the editor!
    
    We originally started with ProseMirror but it became quickly clear that
    since it's more down-to-the-metal we'd have to rebuild a bunch of
    functionality, effectively managing a rich text editor in addition to a
    2D canvas. Examples of this include behaviors around lists where people
    expect certain behaviors around combination of lists next to each other,
    tabbing, etc.
    On top of those product expectations, we'd need to provide a
    higher-level API that provided better DX around things like
    transactions, switching between lists↔headers, and more.
    
    Given those considerations, a very natural fit was to use TipTap. Much
    like tldraw, they provide a great experience around manipulating a rich
    text editor. And, we want to pass on those product/DX benefits
    downstream to our SDK users.
    
    Some high-level notes:
    - the data is stored as the TipTap stringified JSON, it's lightly
    validated at the moment, but not stringently.
    - there was originally going to be a short-circuit path for plaintext
    but it ended up being error-prone with richtext/plaintext living
    side-by-side. (this meant there were two separate fields)
    - We could still add a way to render faster — I just want to avoid it
    being two separate fields, too many footguns.
    - things like arrow labels are only plain text (debatable though).
    
    Other related efforts:
    - https://github.com/tldraw/tldraw/pull/3051
    - https://github.com/tldraw/tldraw/pull/2825
    
    Todo
    - [ ] figure out whether we should have a migration or not. This is what
    we discussed cc @ds300 and @SomeHats - and whether older clients would
    start messing up newer clients. The data becomes lossy if older clients
    overwrite with plaintext.
    
    <img width="427" alt="Screenshot 2024-12-09 at 14 43 51"
    src="https://github.com/user-attachments/assets/f9dddaee-bfd3-4746-8016-d4247e417e80">
    <img width="378" alt="Screenshot 2024-12-09 at 14 42 59"
    src="https://github.com/user-attachments/assets/95e016d3-ab4d-4d34-afd3-b3ef511d2d77">
    
    Current discussion list:
    - [x] positioning: discuss toolbar position (selection bounds vs cursor
    bounds, toolbar is going in center weirdly sometimes)
    - [x] artificial delay: latest updates make it feel slow/unresponsive?
    e.g. list toggle, changing selection
    - [x] keyboard selection: discuss toolbar logic around "mousing around"
    vs. being present when keyboard selecting (which is annoying)
    - [x] mobile: discuss concerns around mobile toolbar
    - [x] mobile, precision tap: discuss / rm tap into text (and sticky
    notes?) - disable precision editing on mobile
    - [x] discuss
    useContextualToolbar/useContextualToolbarPosition/ContextualToolbar/TldrawUiContextualToolbar
    example
    - [x] existing code: middle alignment for pasted text - keep?
    - [x] existing code: should text replace the shape content when pasted?
    keep?
    - [x] discuss animation, we had it, nixed it, it's back again; why the
    0.08s animation? imperceptible?
    - [x] hide during camera move?
    - [x] short form content - hard to make a different selection b/c
    toolbar is in the way of content
    - [x] check 'overflow: hidden' on tl-text-input (update: this is needed
    to avoid scrollbars)
    - [x] decide on toolbar set: italic, underline, strikethrough, highlight
    - [x] labelColor w/ highlighted text - steve has a commit here to tweak
    highlighting
    
    todos:
    - [x] font rebuild (bold, randomization tweaks) - david looking into
    this
    
    check bugs raised:
    - [x] can't do selection on list item
    - [x] mobile: b/c of the blur/Done logic, doesn't work if you dbl-click
    on geo shape (it's a plaintext problem too)
    - [x] mobile: No cursor when using the text tool - specifically for the
    Text tool — can't repro?
    - [x] VSCode html pasting, whitespace issue?
    - [x] Link toolbar make it extend to the widest size of the current tool
    set
    - [x] code has mutual exclusivity (this is a design choice by the Code
    plugin - we could fork)
    - [x] Text is copied to the clipboard with paragraphs rather than line
    breaks.
    - [x] multi-line plaintext for arrows busted
    
    nixed/outdated
    - [ ] ~link: on mobile should be in modal?~
    - [ ] ~link: back button?~
    - [ ] ~list button toggling? (can't repro)~
    - [ ] ~double/triple-clicking is now wonky with the new logic~
    - [ ] ~move blur() code into useEditableRichText - for Done on iOS~
    - [ ] ~toolbar when shape is rotated~
    - [ ] ~"The "isMousingDown" logic doesn't work, the events aren't
    reaching the window. Not sure how we get those from the editor element."
    (can't repro?)~
    - [ ] ~toolbar position bug when toggling code on and off (can't
    repro?)~
    - [ ] ~some issue around "Something's up with the initial size
    calculated from the text selection bounds."~
    - [ ] ~mobile: Context bar still visible out if user presses "Done" to
    end editing~
    - [ ] ~mobile: toolbar when switching between text fields~
    
    
    ### Change type
    
    - [ ] `bugfix`
    - [ ] `improvement`
    - [x] `feature`
    - [ ] `api`
    - [ ] `other`
    
    ### Test plan
    
    1. TODO: write a bunch more tests
    
    - [x] Unit tests
    - [x] End to end tests
    
    ### Release notes
    
    - Rich text using ProseMirror as a first-class supported option in the
    Editor.
    
    ---------
    
    Co-authored-by: huppy-bot[bot] <128400622+huppy-bot[bot]@users.noreply.github.com>
    Co-authored-by: alex <alex@dytry.ch>
    Co-authored-by: David Sheldrick <d.j.sheldrick@gmail.com>
    Co-authored-by: Steve Ruiz <steveruizok@gmail.com>

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index 945d693cb..db6322c7d 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -14,7 +14,6 @@ import React, {
 } from 'react'
 
 import classNames from 'classnames'
-import { TLDeepLinkOptions } from '..'
 import { version } from '../version'
 import { OptionalErrorBoundary } from './components/ErrorBoundary'
 import { DefaultErrorFallback } from './components/default-components/DefaultErrorFallback'
@@ -44,7 +43,9 @@ import { useZoomCss } from './hooks/useZoomCss'
 import { LicenseProvider } from './license/LicenseProvider'
 import { Watermark } from './license/Watermark'
 import { TldrawOptions } from './options'
+import { TLDeepLinkOptions } from './utils/deepLinks'
 import { stopEventPropagation } from './utils/dom'
+import { TLTextOptions } from './utils/richText'
 import { TLStoreWithStatus } from './utils/sync/StoreWithStatus'
 
 /**
@@ -167,6 +168,11 @@ export interface TldrawEditorBaseProps {
 	 */
 	cameraOptions?: Partial<TLCameraOptions>
 
+	/**
+	 * Text options for the editor.
+	 */
+	textOptions?: TLTextOptions
+
 	/**
 	 * Options for the editor.
 	 */
@@ -190,6 +196,11 @@ export interface TldrawEditorBaseProps {
 	 * remain in the store and participate in all other operations.
 	 */
 	isShapeHidden?(shape: TLShape, editor: Editor): boolean
+
+	/**
+	 * The URLs for the fonts to use in the editor.
+	 */
+	assetUrls?: { fonts?: { [key: string]: string | undefined } }
 }
 
 /**
@@ -372,10 +383,12 @@ function TldrawEditorWithReadyStore({
 	autoFocus = true,
 	inferDarkMode,
 	cameraOptions,
+	textOptions,
 	options,
 	licenseKey,
 	deepLinks: _deepLinks,
 	isShapeHidden,
+	assetUrls,
 }: Required<
 	TldrawEditorProps & {
 		store: TLStore
@@ -430,9 +443,11 @@ function TldrawEditorWithReadyStore({
 				autoFocus,
 				inferDarkMode,
 				cameraOptions,
+				textOptions,
 				options,
 				licenseKey,
 				isShapeHidden,
+				fontAssetUrls: assetUrls?.fonts,
 			})
 
 			editor.updateViewportScreenBounds(canvasRef.current ?? container)
@@ -467,6 +482,8 @@ function TldrawEditorWithReadyStore({
 			setEditor,
 			licenseKey,
 			isShapeHidden,
+			textOptions,
+			assetUrls,
 		]
 	)
 
@@ -532,10 +549,41 @@ function TldrawEditorWithReadyStore({
 		[editor, autoFocus]
 	)
 
-	const { Canvas } = useEditorComponents()
+	const [_fontLoadingState, setFontLoadingState] = useState<{
+		editor: Editor
+		isLoaded: boolean
+	} | null>(null)
+	let fontLoadingState = _fontLoadingState
+	if (editor !== fontLoadingState?.editor) {
+		fontLoadingState = null
+	}
+	useEffect(() => {
+		if (!editor) return
+		let isCancelled = false
+
+		setFontLoadingState({ editor, isLoaded: false })
+
+		editor.fonts
+			.loadRequiredFontsForCurrentPage(editor.options.maxFontsToLoadBeforeRender)
+			.finally(() => {
+				if (isCancelled) return
+				setFontLoadingState({ editor, isLoaded: true })
+			})
+
+		return () => {
+			isCancelled = true
+		}
+	}, [editor])
 
-	if (!editor) {
-		return <div className="tl-canvas" ref={canvasRef} />
+	const { Canvas, LoadingScreen } = useEditorComponents()
+
+	if (!editor || !fontLoadingState?.isLoaded) {
+		return (
+			<>
+				{LoadingScreen && <LoadingScreen />}
+				<div className="tl-canvas" ref={canvasRef} />
+			</>
+		)
 	}
 
 	return (

commit a921cf09a503a0d283b7ab875f36abb768884289
Author: Lu Wilson <l2wilson94@gmail.com>
Date:   Wed Apr 2 10:10:19 2025 +0100

    Disable currently broken docs links (#5778)
    
    Our API reference generator is failing to include some links. This PR
    disables those already-broken links until we fix this.
    
    See: https://github.com/tldraw/tldraw/issues/5769
    See:
    https://linear.app/tldraw/issue/INT-1015/fix-broken-links-in-api-reference
    
    ### Change type
    
    - [ ] `bugfix`
    - [ ] `improvement`
    - [ ] `feature`
    - [ ] `api`
    - [x] `other`

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index db6322c7d..b0340f684 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -50,7 +50,7 @@ import { TLStoreWithStatus } from './utils/sync/StoreWithStatus'
 
 /**
  * Props for the {@link tldraw#Tldraw} and {@link TldrawEditor} components, when passing in a
- * {@link store#TLStore} directly. If you would like tldraw to create a store for you, use
+ * `TLStore` directly. If you would like tldraw to create a store for you, use
  * {@link TldrawEditorWithoutStoreProps}.
  *
  * @public
@@ -64,7 +64,7 @@ export interface TldrawEditorWithStoreProps {
 
 /**
  * Props for the {@link tldraw#Tldraw} and {@link TldrawEditor} components, when not passing in a
- * {@link store#TLStore} directly. If you would like to pass in a store directly, use
+ * `TLStore` directly. If you would like to pass in a store directly, use
  * {@link TldrawEditorWithStoreProps}.
  *
  * @public

commit 71368dc000db19924eec6c4d6d5e23ec3e49d89f
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Thu Apr 3 10:24:59 2025 +0100

    isShapeHidden => getShapeVisibility, to allow children of hidden shapes to be visible (#5762)
    
    This PR was motivated by a very reasonable [discord request
    
    ](https://discord.com/channels/859816885297741824/1353628236487327857/1353628236487327857)
    
    > We are working on a feature where we need to hide all of the shapes
    except for the "focused shape" (we are using isShapeHidden prop) - this
    is largely working as expected, except for one challenge - when the
    "focused shape" is child of a frame/ group shape, then hiding the parent
    shape also hides the "focused shape", which makes sense in general
    context, but we need the ability to hide the parent shape without hiding
    the "focused shape".
    
    Ended up being a fairly small diff.
    
    ![Kapture 2025-03-27 at 12 00
    09](https://github.com/user-attachments/assets/e2423d49-9908-4a7b-bdb0-fed96c3b25f5)
    
    I'm not crazy about this 'force_show' API and would appreciate
    alternative suggestions if you have any.
    
    ### Change type
    
    - [x] `other`
    
    ### Release notes
    
    - Allow the children of a hidden shape to show themselves by returning a
    'force_show' override from the `isShapeHidden` predicate.

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index b0340f684..101caadaf 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -191,11 +191,33 @@ export interface TldrawEditorBaseProps {
 	/**
 	 * Predicate for whether or not a shape should be hidden.
 	 *
+	 * @deprecated Use {@link TldrawEditorBaseProps#getShapeVisibility} instead.
+	 */
+	isShapeHidden?(shape: TLShape, editor: Editor): boolean
+
+	/**
+	 * Provides a way to hide shapes.
+	 *
 	 * Hidden shapes will not render in the editor, and they will not be eligible for hit test via
 	 * {@link Editor#getShapeAtPoint} and {@link Editor#getShapesAtPoint}. But otherwise they will
 	 * remain in the store and participate in all other operations.
+	 *
+	 * @example
+	 * ```ts
+	 * getShapeVisibility={(shape, editor) => shape.meta.hidden ? 'hidden' : 'inherit'}
+	 * ```
+	 *
+	 * - `'inherit' | undefined` - (default) The shape will be visible unless its parent is hidden.
+	 * - `'hidden'` - The shape will be hidden.
+	 * - `'visible'` - The shape will be visible.
+	 *
+	 * @param shape - The shape to check.
+	 * @param editor - The editor instance.
 	 */
-	isShapeHidden?(shape: TLShape, editor: Editor): boolean
+	getShapeVisibility?(
+		shape: TLShape,
+		editor: Editor
+	): 'visible' | 'hidden' | 'inherit' | null | undefined
 
 	/**
 	 * The URLs for the fonts to use in the editor.
@@ -387,7 +409,9 @@ function TldrawEditorWithReadyStore({
 	options,
 	licenseKey,
 	deepLinks: _deepLinks,
+	// eslint-disable-next-line @typescript-eslint/no-deprecated
 	isShapeHidden,
+	getShapeVisibility,
 	assetUrls,
 }: Required<
 	TldrawEditorProps & {
@@ -447,6 +471,7 @@ function TldrawEditorWithReadyStore({
 				options,
 				licenseKey,
 				isShapeHidden,
+				getShapeVisibility,
 				fontAssetUrls: assetUrls?.fonts,
 			})
 
@@ -482,6 +507,7 @@ function TldrawEditorWithReadyStore({
 			setEditor,
 			licenseKey,
 			isShapeHidden,
+			getShapeVisibility,
 			textOptions,
 			assetUrls,
 		]

commit a53f0a3ddf355a787e51bfd58b8e0000d8e60e0e
Author: Mime Čuvalo <mimecuvalo@gmail.com>
Date:   Mon Apr 7 23:36:42 2025 +0100

    a11y: add axe to be able to do audits (#5840)
    
    This is just for dev mode.
    
    ![Screenshot 2025-04-07 at 15 38
    01](https://github.com/user-attachments/assets/45076c3d-6ef8-4163-b1c3-4facae08da05)
    
    
    ### Change type
    
    - [ ] `bugfix`
    - [ ] `improvement`
    - [x] `feature`
    - [ ] `api`
    - [ ] `other`
    
    ### Release notes
    
    - a11y: add axe to be able to do audits

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index 101caadaf..647853cb8 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -284,6 +284,7 @@ export const TldrawEditor = memo(function TldrawEditor({
 			className={classNames(`${TL_CONTAINER_CLASS} tl-theme__light`, className)}
 			onPointerDown={stopEventPropagation}
 			tabIndex={-1}
+			role="application"
 		>
 			<OptionalErrorBoundary
 				fallback={ErrorFallback}

commit 37377fbef46d63ba2e0677a2a2ed0086d3931d74
Author: Mime Čuvalo <mimecuvalo@gmail.com>
Date:   Fri Apr 25 17:40:34 2025 +0100

    a11y: make toolbars more compliant with keyboard navigation (#5872)
    
    The toolbars as they stand right now aren't set up right yet. To be
    compliant, they need to support left/right and setting tabIndex on items
    as you go.
    This requires quite a rework of the toolbars and their buttons.
    
    - [x] add aria-labels to toolbars
    - [x] zoom menu - dropdown
    - [x] zoom menu - keep focus when toggling
    - [x] main toolbar
    - [x] main overflow toolbar
    - [x] top-left toolbar
    - [x] style panel stuff
    - [x] toolbar extra menu
    - [x] loading screen
    - [x] contextual toolbar
    - [x] drive-by fix number shortcuts not working when toolbar selected
    - [x] going to need to override branding instead of tldraw
    - [x] add more aria-labels to a11y tree
    - [x] padding at top of style panel wtf
    - [x] slider left/right/top/bottom
    - [x] sub-menus
    - [x] check dotcom
    - [ ] escape should return back to the original spot
    
    ### Change type
    
    - [ ] `bugfix`
    - [x] `improvement`
    - [ ] `feature`
    - [ ] `api`
    - [ ] `other`
    
    ### Release notes
    
    - a11y: make toolbars more compliant with keyboard navigation

diff --git a/packages/editor/src/lib/TldrawEditor.tsx b/packages/editor/src/lib/TldrawEditor.tsx
index 647853cb8..eefd1264a 100644
--- a/packages/editor/src/lib/TldrawEditor.tsx
+++ b/packages/editor/src/lib/TldrawEditor.tsx
@@ -285,6 +285,7 @@ export const TldrawEditor = memo(function TldrawEditor({
 			onPointerDown={stopEventPropagation}
 			tabIndex={-1}
 			role="application"
+			aria-label={_options?.branding ?? 'tldraw'}
 		>
 			<OptionalErrorBoundary
 				fallback={ErrorFallback}
@@ -669,7 +670,11 @@ export interface LoadingScreenProps {
 
 /** @public @react */
 export function LoadingScreen({ children }: LoadingScreenProps) {
-	return <div className="tl-loading">{children}</div>
+	return (
+		<div className="tl-loading" aria-busy="true" tabIndex={0}>
+			{children}
+		</div>
+	)
 }
 
 /** @public @react */

</code></pre>
        </section>
    </main>
    <footer>
        <p>LoCoDiff-bench - <a href="https://github.com/AbanteAI/LoCoDiff-bench">GitHub Repository</a></p>
    </footer>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            hljs.highlightAll();
        });
    </script>
</body>
</html>
    