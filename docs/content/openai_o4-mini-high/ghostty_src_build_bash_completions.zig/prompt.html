<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prompt: src/build/bash_completions.zig - o4-mini-high</title>
    <link rel="stylesheet" href="../../../../styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/default.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
</head>
<body>
    <header>
        <h1>Prompt: src/build/bash_completions.zig</h1>
        <h2>Model: o4-mini-high</h2>
        <p><a href="../../../cases/openai_o4-mini-high/ghostty_src_build_bash_completions.zig.html">Back to Case</a> | <a href="../../../cases.html">All Cases</a> | <a href="../../../index.html">Home</a></p>
    </header>
    <main>
        <section>
            <h2>Prompt Content</h2>
            <pre><code class="language-plaintext"># Instructions

You are being benchmarked. You will see the output of a git log command, and from that must infer the current state of a file. Think carefully, as you must output the exact state of the file to earn full marks.

**Important:** Your goal is to reproduce the file's content *exactly* as it exists at the final commit, even if the code appears broken, buggy, or contains obvious errors. Do **not** try to "fix" the code. Attempting to correct issues will result in a poor score, as this benchmark evaluates your ability to reproduce the precise state of the file based on its history.

# Required Response Format

Wrap the content of the file in triple backticks (```). Any text outside the final closing backticks will be ignored. End your response after outputting the closing backticks.

# Example Response

```python
#!/usr/bin/env python
print('Hello, world!')
```

# File History

> git log -p --cc --topo-order --reverse -- src/build/bash_completions.zig

commit fddc8809414f3f12dfac7acb0ed3c9e3ef0b8491
Author: Anund <anundm@gmail.com>
Date:   Fri Dec 13 16:54:12 2024 +1100

    bash: add bash completion generation
    
    closes #2053

diff --git a/src/build/bash_completions.zig b/src/build/bash_completions.zig
new file mode 100644
index 00000000..fb8d904e
--- /dev/null
+++ b/src/build/bash_completions.zig
@@ -0,0 +1,278 @@
+const std = @import("std");
+
+const Config = @import("../config/Config.zig");
+const Action = @import("../cli/action.zig").Action;
+
+/// A bash completions configuration that contains all the available commands
+/// and options.
+///
+/// Notes: bash completion support for --<key>=<value> depends on setting the completion
+/// system to _not_ print a space following each successful completion (see -o nospace).
+/// This results leading or tailing spaces being necessary to move onto the next match.
+///
+/// bash completion will read = as it's own completiong word regardless of whether or not
+/// it's part of an on going completion like --<key>=. Working around this requires looking
+/// backward in the command line args to pretend the = is an empty string
+/// see: https://www.gnu.org/software/gnuastro/manual/html_node/Bash-TAB-completion-tutorial.html
+pub const bash_completions = comptimeGenerateBashCompletions();
+
+fn comptimeGenerateBashCompletions() []const u8 {
+    comptime {
+        @setEvalBranchQuota(50000);
+        var counter = std.io.countingWriter(std.io.null_writer);
+        try writeBashCompletions(&counter.writer());
+
+        var buf: [counter.bytes_written]u8 = undefined;
+        var stream = std.io.fixedBufferStream(&buf);
+        try writeBashCompletions(stream.writer());
+        const final = buf;
+        return final[0..stream.getWritten().len];
+    }
+}
+
+fn writeBashCompletions(writer: anytype) !void {
+    const pad1 = "  ";
+    const pad2 = pad1 ++ pad1;
+    const pad3 = pad2 ++ pad1;
+    const pad4 = pad3 ++ pad1;
+
+    try writer.writeAll(
+        \\#!/usr/bin/env bash
+        \\
+        \\# -o nospace requires we add back a space when a completion is finished
+        \\# and not part of a --key= completion
+        \\appendSpaces () {
+        \\  for idx in "${!COMPREPLY[@]}"; do
+        \\    [ -n "${COMPREPLY[idx]}" ] && COMPREPLY[idx]="${COMPREPLY[idx]} ";
+        \\  done
+        \\}
+        \\
+        \\_fonts () {
+        \\  local IFS=$'\n'
+        \\  mapfile -t COMPREPLY < <( compgen -P '"' -S '"' -W "$(ghostty +list-fonts | grep '^[A-Z]' )" -- "$cur")
+        \\}
+        \\
+        \\_themes() {
+        \\  local IFS=$'\n'
+        \\  mapfile -t COMPREPLY < <( compgen -P '"' -S '"' -W "$(ghostty +list-themes | sed -E 's/^(.*) \(.*$/\1/')" -- "$cur")
+        \\}
+        \\
+        \\config="--help"
+        \\config+=" --version"
+        \\
+    );
+
+    for (@typeInfo(Config).Struct.fields) |field| {
+        if (field.name[0] == '_') continue;
+        try writer.writeAll("config+=\" --" ++ field.name ++ "=\"\n");
+    }
+
+    try writer.writeAll(
+        \\
+        \\_handleConfig () {
+        \\  case "$prev" in
+        \\
+    );
+
+    for (@typeInfo(Config).Struct.fields) |field| {
+        if (field.name[0] == '_') continue;
+        try writer.writeAll(pad2 ++ "--" ++ field.name ++ ") ");
+
+        if (std.mem.startsWith(u8, field.name, "font-family"))
+            try writer.writeAll("_fonts ;;")
+        else if (std.mem.eql(u8, "theme", field.name))
+            try writer.writeAll("_themes ;;")
+        else if (std.mem.eql(u8, "working-directory", field.name))
+            try writer.writeAll("mapfile -t COMPREPLY < <( compgen -d -- \"$cur\" ); appendSpaces ;;")
+        else if (field.type == Config.RepeatablePath)
+            try writer.writeAll("mapfile -t COMPREPLY < <( compgen -f -- \"$cur\" ); appendSpaces ;;")
+        else {
+            const compgenPrefix = "mapfile -t COMPREPLY < <( compgen -W \"";
+            const compgenSuffix = "\" -- \"$cur\" ); appendSpaces ;;";
+            switch (@typeInfo(field.type)) {
+                .Bool => try writer.writeAll(compgenPrefix ++ "true false" ++ compgenSuffix),
+                .Enum => |info| {
+                    try writer.writeAll(compgenPrefix);
+                    for (info.fields, 0..) |f, i| {
+                        if (i > 0) try writer.writeAll(" ");
+                        try writer.writeAll(f.name);
+                    }
+                    try writer.writeAll(compgenSuffix);
+                },
+                .Struct => |info| {
+                    if (!@hasDecl(field.type, "parseCLI") and info.layout == .@"packed") {
+                        try writer.writeAll(compgenPrefix);
+                        for (info.fields, 0..) |f, i| {
+                            if (i > 0) try writer.writeAll(" ");
+                            try writer.writeAll(f.name ++ " no-" ++ f.name);
+                        }
+                        try writer.writeAll(compgenSuffix);
+                    } else {
+                        try writer.writeAll("return ;;");
+                    }
+                },
+                else => try writer.writeAll("return ;;"),
+            }
+        }
+
+        try writer.writeAll("\n");
+    }
+
+    try writer.writeAll(
+        \\    *) mapfile -t COMPREPLY < <( compgen -W "$config" -- "$cur" ) ;;
+        \\  esac
+        \\
+        \\  return 0
+        \\}
+        \\
+        \\
+    );
+
+    for (@typeInfo(Action).Enum.fields) |field| {
+        if (std.mem.eql(u8, "help", field.name)) continue;
+        if (std.mem.eql(u8, "version", field.name)) continue;
+
+        const options = @field(Action, field.name).options();
+        // assumes options will never be created with only <_name> members
+        if (@typeInfo(options).Struct.fields.len == 0) continue;
+
+        var buffer: [field.name.len]u8 = undefined;
+        const safeName: []u8 = buffer[0..field.name.len];
+        @memcpy(safeName, field.name);
+
+        std.mem.replaceScalar(u8, safeName, '-', '_');
+        try writer.writeAll(safeName ++ "=\"");
+
+        {
+            var count = 0;
+            for (@typeInfo(options).Struct.fields) |opt| {
+                if (opt.name[0] == '_') continue;
+                if (count > 0) try writer.writeAll(" ");
+                try writer.writeAll("--" ++ opt.name ++ "=");
+                count += 1;
+            }
+        }
+        try writer.writeAll(" --help\"\n");
+    }
+
+    try writer.writeAll(
+        \\
+        \\_handleActions () {
+        \\  case "${COMP_WORDS[1]}" in
+        \\
+    );
+
+    for (@typeInfo(Action).Enum.fields) |field| {
+        if (std.mem.eql(u8, "help", field.name)) continue;
+        if (std.mem.eql(u8, "version", field.name)) continue;
+
+        const options = @field(Action, field.name).options();
+        if (@typeInfo(options).Struct.fields.len == 0) continue;
+
+        // bash doesn't allow variable names containing '-' so replace them
+        var buffer: [field.name.len]u8 = undefined;
+        const safeName: []u8 = buffer[0..field.name.len];
+        _ = std.mem.replace(u8, field.name, "-", "_", safeName);
+
+        try writer.writeAll(pad2 ++ "+" ++ field.name ++ ")\n");
+        try writer.writeAll(pad3 ++ "case $prev in\n");
+        for (@typeInfo(options).Struct.fields) |opt| {
+            if (opt.name[0] == '_') continue;
+
+            try writer.writeAll(pad4 ++ "--" ++ opt.name ++ ") ");
+
+            const compgenPrefix = "mapfile -t COMPREPLY < <( compgen -W \"";
+            const compgenSuffix = "\" -- \"$cur\" ); appendSpaces ;;";
+            switch (@typeInfo(opt.type)) {
+                .Bool => try writer.writeAll(compgenPrefix ++ "true false" ++ compgenSuffix),
+                .Enum => |info| {
+                    try writer.writeAll(compgenPrefix);
+                    for (info.opts, 0..) |f, i| {
+                        if (i > 0) try writer.writeAll(" ");
+                        try writer.writeAll(f.name);
+                    }
+                    try writer.writeAll(compgenSuffix);
+                },
+                else => {
+                    if (std.mem.eql(u8, "config-file", opt.name)) {
+                        try writer.writeAll("mapfile -t COMPREPLY < <( compgen -f -- \"$cur\" ); appendSpaces ;;");
+                    } else try writer.writeAll("return;;");
+                },
+            }
+            try writer.writeAll("\n");
+        }
+        try writer.writeAll(pad4 ++ "*) mapfile -t COMPREPLY < <( compgen -W \"$" ++ safeName ++ "\" -- \"$cur\" ) ;;\n");
+        try writer.writeAll(
+            \\      esac
+            \\    ;;
+            \\
+        );
+    }
+
+    try writer.writeAll(
+        \\    *) mapfile -t COMPREPLY < <( compgen -W "--help" -- "$cur" ) ;;
+        \\  esac
+        \\
+        \\  return 0
+        \\}
+        \\
+        \\topLevel="-e"
+        \\topLevel+=" --help"
+        \\topLevel+=" --version"
+        \\
+    );
+
+    for (@typeInfo(Action).Enum.fields) |field| {
+        if (std.mem.eql(u8, "help", field.name)) continue;
+        if (std.mem.eql(u8, "version", field.name)) continue;
+
+        try writer.writeAll("topLevel+=\" +" ++ field.name ++ "\"\n");
+    }
+
+    try writer.writeAll(
+        \\
+        \\_ghostty () {
+        \\  COMPREPLY=()
+        \\  if [ "$2" = "=" ]; then cur=""
+        \\  else                    cur="$2"
+        \\  fi
+        \\
+        \\  if [ "$3" = "=" ]; then prev="${COMP_WORDS[COMP_CWORD-2]}"
+        \\  else                    prev="${COMP_WORDS[COMP_CWORD-1]}"
+        \\  fi
+        \\
+        \\  if [[ "$2" == \"*\" ]]; then
+        \\    COMPREPLY=( "$cur " );
+        \\    return;
+        \\  fi
+        \\
+        \\  cword=$COMP_CWORD
+        \\
+        \\  case "$cword" in
+        \\    1)
+        \\      case "${COMP_WORDS[1]}" in
+        \\        -e | --help | --version) return 0 ;;
+        \\        --*) _handleConfig ;;
+        \\        *) mapfile -t COMPREPLY < <( compgen -W "${topLevel}" -- "$cur" ); appendSpaces ;;
+        \\      esac
+        \\      ;;
+        \\    *)
+        \\      case "$prev" in
+        \\        -e | --help | --version) return 0 ;;
+        \\        *)
+        \\          case "${COMP_WORDS[1]}" in
+        \\            --*) _handleConfig ;;
+        \\            +*) _handleActions ;;
+        \\          esac
+        \\          ;;
+        \\      esac
+        \\      ;;
+        \\  esac
+        \\
+        \\  return 0
+        \\}
+        \\
+        \\complete -o nospace -o bashdefault -F _ghostty ghostty
+        \\
+    );
+}

commit c02789205e38773a738664e560797d995fe1680e
Author: Anund <anundm@gmail.com>
Date:   Sun Dec 15 18:41:50 2024 +1100

    bash: fix incorrect completion for '--key '

diff --git a/src/build/bash_completions.zig b/src/build/bash_completions.zig
index fb8d904e..c58c1f23 100644
--- a/src/build/bash_completions.zig
+++ b/src/build/bash_completions.zig
@@ -69,7 +69,7 @@ fn writeBashCompletions(writer: anytype) !void {
 
     try writer.writeAll(
         \\
-        \\_handleConfig () {
+        \\_handleConfig() {
         \\  case "$prev" in
         \\
     );
@@ -232,23 +232,23 @@ fn writeBashCompletions(writer: anytype) !void {
     try writer.writeAll(
         \\
         \\_ghostty () {
-        \\  COMPREPLY=()
+        \\  cur=""; prev=""; prevWasEq=false; COMPREPLY=()
+        \\
         \\  if [ "$2" = "=" ]; then cur=""
         \\  else                    cur="$2"
         \\  fi
         \\
-        \\  if [ "$3" = "=" ]; then prev="${COMP_WORDS[COMP_CWORD-2]}"
+        \\  if [ "$3" = "=" ]; then prev="${COMP_WORDS[COMP_CWORD-2]}"; prevWasEq=true;
         \\  else                    prev="${COMP_WORDS[COMP_CWORD-1]}"
         \\  fi
         \\
+        \\  # current completion is double quoted add a space so the curor progresses
         \\  if [[ "$2" == \"*\" ]]; then
         \\    COMPREPLY=( "$cur " );
         \\    return;
         \\  fi
         \\
-        \\  cword=$COMP_CWORD
-        \\
-        \\  case "$cword" in
+        \\  case "$COMP_CWORD" in
         \\    1)
         \\      case "${COMP_WORDS[1]}" in
         \\        -e | --help | --version) return 0 ;;
@@ -260,6 +260,12 @@ fn writeBashCompletions(writer: anytype) !void {
         \\      case "$prev" in
         \\        -e | --help | --version) return 0 ;;
         \\        *)
+        \\          if [[ "=" != "${COMP_WORDS[COMP_CWORD]}" && $prevWasEq != true ]]; then
+        \\            # must be completing with a space after the key eg: '--<key> '
+        \\            # clear out prev so we don't run any of the key specific completions
+        \\            prev=""
+        \\          fi
+        \\        
         \\          case "${COMP_WORDS[1]}" in
         \\            --*) _handleConfig ;;
         \\            +*) _handleActions ;;

commit 361967f721b521c193f88a05c9a7fb704e5f239b
Author: Anund <anundm@gmail.com>
Date:   Sun Dec 15 20:13:45 2024 +1100

    bash: formatting changes, change to reference binary name via variable

diff --git a/src/build/bash_completions.zig b/src/build/bash_completions.zig
index c58c1f23..ddcb8240 100644
--- a/src/build/bash_completions.zig
+++ b/src/build/bash_completions.zig
@@ -37,24 +37,23 @@ fn writeBashCompletions(writer: anytype) !void {
     const pad4 = pad3 ++ pad1;
 
     try writer.writeAll(
-        \\#!/usr/bin/env bash
         \\
         \\# -o nospace requires we add back a space when a completion is finished
         \\# and not part of a --key= completion
-        \\appendSpaces () {
+        \\addSpaces() {
         \\  for idx in "${!COMPREPLY[@]}"; do
         \\    [ -n "${COMPREPLY[idx]}" ] && COMPREPLY[idx]="${COMPREPLY[idx]} ";
         \\  done
         \\}
         \\
-        \\_fonts () {
+        \\_fonts() {
         \\  local IFS=$'\n'
-        \\  mapfile -t COMPREPLY < <( compgen -P '"' -S '"' -W "$(ghostty +list-fonts | grep '^[A-Z]' )" -- "$cur")
+        \\  mapfile -t COMPREPLY < <( compgen -P '"' -S '"' -W "$($ghostty +list-fonts | grep '^[A-Z]' )" -- "$cur")
         \\}
         \\
         \\_themes() {
         \\  local IFS=$'\n'
-        \\  mapfile -t COMPREPLY < <( compgen -P '"' -S '"' -W "$(ghostty +list-themes | sed -E 's/^(.*) \(.*$/\1/')" -- "$cur")
+        \\  mapfile -t COMPREPLY < <( compgen -P '"' -S '"' -W "$($ghostty +list-themes | sed -E 's/^(.*) \(.*$/\1/')" -- "$cur")
         \\}
         \\
         \\config="--help"
@@ -83,12 +82,12 @@ fn writeBashCompletions(writer: anytype) !void {
         else if (std.mem.eql(u8, "theme", field.name))
             try writer.writeAll("_themes ;;")
         else if (std.mem.eql(u8, "working-directory", field.name))
-            try writer.writeAll("mapfile -t COMPREPLY < <( compgen -d -- \"$cur\" ); appendSpaces ;;")
+            try writer.writeAll("mapfile -t COMPREPLY < <( compgen -d -- \"$cur\" ); addSpaces ;;")
         else if (field.type == Config.RepeatablePath)
-            try writer.writeAll("mapfile -t COMPREPLY < <( compgen -f -- \"$cur\" ); appendSpaces ;;")
+            try writer.writeAll("mapfile -t COMPREPLY < <( compgen -f -- \"$cur\" ); addSpaces ;;")
         else {
             const compgenPrefix = "mapfile -t COMPREPLY < <( compgen -W \"";
-            const compgenSuffix = "\" -- \"$cur\" ); appendSpaces ;;";
+            const compgenSuffix = "\" -- \"$cur\" ); addSpaces ;;";
             switch (@typeInfo(field.type)) {
                 .Bool => try writer.writeAll(compgenPrefix ++ "true false" ++ compgenSuffix),
                 .Enum => |info| {
@@ -137,11 +136,11 @@ fn writeBashCompletions(writer: anytype) !void {
         if (@typeInfo(options).Struct.fields.len == 0) continue;
 
         var buffer: [field.name.len]u8 = undefined;
-        const safeName: []u8 = buffer[0..field.name.len];
-        @memcpy(safeName, field.name);
+        const bashName: []u8 = buffer[0..field.name.len];
+        @memcpy(bashName, field.name);
 
-        std.mem.replaceScalar(u8, safeName, '-', '_');
-        try writer.writeAll(safeName ++ "=\"");
+        std.mem.replaceScalar(u8, bashName, '-', '_');
+        try writer.writeAll(bashName ++ "=\"");
 
         {
             var count = 0;
@@ -157,7 +156,7 @@ fn writeBashCompletions(writer: anytype) !void {
 
     try writer.writeAll(
         \\
-        \\_handleActions () {
+        \\_handleActions() {
         \\  case "${COMP_WORDS[1]}" in
         \\
     );
@@ -171,8 +170,8 @@ fn writeBashCompletions(writer: anytype) !void {
 
         // bash doesn't allow variable names containing '-' so replace them
         var buffer: [field.name.len]u8 = undefined;
-        const safeName: []u8 = buffer[0..field.name.len];
-        _ = std.mem.replace(u8, field.name, "-", "_", safeName);
+        const bashName: []u8 = buffer[0..field.name.len];
+        _ = std.mem.replace(u8, field.name, "-", "_", bashName);
 
         try writer.writeAll(pad2 ++ "+" ++ field.name ++ ")\n");
         try writer.writeAll(pad3 ++ "case $prev in\n");
@@ -182,7 +181,7 @@ fn writeBashCompletions(writer: anytype) !void {
             try writer.writeAll(pad4 ++ "--" ++ opt.name ++ ") ");
 
             const compgenPrefix = "mapfile -t COMPREPLY < <( compgen -W \"";
-            const compgenSuffix = "\" -- \"$cur\" ); appendSpaces ;;";
+            const compgenSuffix = "\" -- \"$cur\" ); addSpaces ;;";
             switch (@typeInfo(opt.type)) {
                 .Bool => try writer.writeAll(compgenPrefix ++ "true false" ++ compgenSuffix),
                 .Enum => |info| {
@@ -195,13 +194,13 @@ fn writeBashCompletions(writer: anytype) !void {
                 },
                 else => {
                     if (std.mem.eql(u8, "config-file", opt.name)) {
-                        try writer.writeAll("mapfile -t COMPREPLY < <( compgen -f -- \"$cur\" ); appendSpaces ;;");
+                        try writer.writeAll("mapfile -t COMPREPLY < <( compgen -f -- \"$cur\" ); addSpaces ;;");
                     } else try writer.writeAll("return;;");
                 },
             }
             try writer.writeAll("\n");
         }
-        try writer.writeAll(pad4 ++ "*) mapfile -t COMPREPLY < <( compgen -W \"$" ++ safeName ++ "\" -- \"$cur\" ) ;;\n");
+        try writer.writeAll(pad4 ++ "*) mapfile -t COMPREPLY < <( compgen -W \"$" ++ bashName ++ "\" -- \"$cur\" ) ;;\n");
         try writer.writeAll(
             \\      esac
             \\    ;;
@@ -231,8 +230,9 @@ fn writeBashCompletions(writer: anytype) !void {
 
     try writer.writeAll(
         \\
-        \\_ghostty () {
+        \\_ghostty() {
         \\  cur=""; prev=""; prevWasEq=false; COMPREPLY=()
+        \\  ghostty="$1"
         \\
         \\  if [ "$2" = "=" ]; then cur=""
         \\  else                    cur="$2"
@@ -253,7 +253,7 @@ fn writeBashCompletions(writer: anytype) !void {
         \\      case "${COMP_WORDS[1]}" in
         \\        -e | --help | --version) return 0 ;;
         \\        --*) _handleConfig ;;
-        \\        *) mapfile -t COMPREPLY < <( compgen -W "${topLevel}" -- "$cur" ); appendSpaces ;;
+        \\        *) mapfile -t COMPREPLY < <( compgen -W "${topLevel}" -- "$cur" ); addSpaces ;;
         \\      esac
         \\      ;;
         \\    *)

commit ea181579dfa615c9f2a3abacfd018262993ff715
Author: Anund <anundm@gmail.com>
Date:   Sun Dec 15 23:20:32 2024 +1100

    bash: add _files and _dirs to correctly add spaces to only the final result

diff --git a/src/build/bash_completions.zig b/src/build/bash_completions.zig
index ddcb8240..5d1c4eb0 100644
--- a/src/build/bash_completions.zig
+++ b/src/build/bash_completions.zig
@@ -56,6 +56,30 @@ fn writeBashCompletions(writer: anytype) !void {
         \\  mapfile -t COMPREPLY < <( compgen -P '"' -S '"' -W "$($ghostty +list-themes | sed -E 's/^(.*) \(.*$/\1/')" -- "$cur")
         \\}
         \\
+        \\_files() {
+        \\  mapfile -t COMPREPLY < <( compgen -o filenames -f -- "$cur" )
+        \\  for i in "${!COMPREPLY[@]}"; do
+        \\    if [[ -d "${COMPREPLY[i]}" ]]; then
+        \\      COMPREPLY[i]="${COMPREPLY[i]}/";
+        \\    fi
+        \\    if [[ -f "${COMPREPLY[i]}" ]]; then
+        \\      COMPREPLY[i]="${COMPREPLY[i]} ";
+        \\    fi
+        \\  done
+        \\}
+        \\
+        \\_dirs() {
+        \\  mapfile -t COMPREPLY < <( compgen -o dirnames -d -- "$cur" )
+        \\  for i in "${!COMPREPLY[@]}"; do
+        \\    if [[ -d "${COMPREPLY[i]}" ]]; then
+        \\      COMPREPLY[i]="${COMPREPLY[i]}/";
+        \\    fi
+        \\  done
+        \\  if [[ "${#COMPREPLY[@]}" == 0 && -d "$cur" ]]; then
+        \\    COMPREPLY=( "$cur " )
+        \\  fi
+        \\}
+        \\
         \\config="--help"
         \\config+=" --version"
         \\
@@ -82,9 +106,9 @@ fn writeBashCompletions(writer: anytype) !void {
         else if (std.mem.eql(u8, "theme", field.name))
             try writer.writeAll("_themes ;;")
         else if (std.mem.eql(u8, "working-directory", field.name))
-            try writer.writeAll("mapfile -t COMPREPLY < <( compgen -d -- \"$cur\" ); addSpaces ;;")
+            try writer.writeAll("_dirs ;;")
         else if (field.type == Config.RepeatablePath)
-            try writer.writeAll("mapfile -t COMPREPLY < <( compgen -f -- \"$cur\" ); addSpaces ;;")
+            try writer.writeAll("_files ;;")
         else {
             const compgenPrefix = "mapfile -t COMPREPLY < <( compgen -W \"";
             const compgenSuffix = "\" -- \"$cur\" ); addSpaces ;;";
@@ -194,7 +218,7 @@ fn writeBashCompletions(writer: anytype) !void {
                 },
                 else => {
                     if (std.mem.eql(u8, "config-file", opt.name)) {
-                        try writer.writeAll("mapfile -t COMPREPLY < <( compgen -f -- \"$cur\" ); addSpaces ;;");
+                        try writer.writeAll("_files ;;");
                     } else try writer.writeAll("return;;");
                 },
             }

commit f1728f594a681941b85a8d2fa8a136d625d9b633
Author: Anund <anundm@gmail.com>
Date:   Mon Dec 16 08:22:42 2024 +1100

    bash: remove quoted completions while sorting possible portability issue

diff --git a/src/build/bash_completions.zig b/src/build/bash_completions.zig
index 5d1c4eb0..03694bf8 100644
--- a/src/build/bash_completions.zig
+++ b/src/build/bash_completions.zig
@@ -37,7 +37,6 @@ fn writeBashCompletions(writer: anytype) !void {
     const pad4 = pad3 ++ pad1;
 
     try writer.writeAll(
-        \\
         \\# -o nospace requires we add back a space when a completion is finished
         \\# and not part of a --key= completion
         \\addSpaces() {
@@ -46,40 +45,6 @@ fn writeBashCompletions(writer: anytype) !void {
         \\  done
         \\}
         \\
-        \\_fonts() {
-        \\  local IFS=$'\n'
-        \\  mapfile -t COMPREPLY < <( compgen -P '"' -S '"' -W "$($ghostty +list-fonts | grep '^[A-Z]' )" -- "$cur")
-        \\}
-        \\
-        \\_themes() {
-        \\  local IFS=$'\n'
-        \\  mapfile -t COMPREPLY < <( compgen -P '"' -S '"' -W "$($ghostty +list-themes | sed -E 's/^(.*) \(.*$/\1/')" -- "$cur")
-        \\}
-        \\
-        \\_files() {
-        \\  mapfile -t COMPREPLY < <( compgen -o filenames -f -- "$cur" )
-        \\  for i in "${!COMPREPLY[@]}"; do
-        \\    if [[ -d "${COMPREPLY[i]}" ]]; then
-        \\      COMPREPLY[i]="${COMPREPLY[i]}/";
-        \\    fi
-        \\    if [[ -f "${COMPREPLY[i]}" ]]; then
-        \\      COMPREPLY[i]="${COMPREPLY[i]} ";
-        \\    fi
-        \\  done
-        \\}
-        \\
-        \\_dirs() {
-        \\  mapfile -t COMPREPLY < <( compgen -o dirnames -d -- "$cur" )
-        \\  for i in "${!COMPREPLY[@]}"; do
-        \\    if [[ -d "${COMPREPLY[i]}" ]]; then
-        \\      COMPREPLY[i]="${COMPREPLY[i]}/";
-        \\    fi
-        \\  done
-        \\  if [[ "${#COMPREPLY[@]}" == 0 && -d "$cur" ]]; then
-        \\    COMPREPLY=( "$cur " )
-        \\  fi
-        \\}
-        \\
         \\config="--help"
         \\config+=" --version"
         \\
@@ -102,13 +67,13 @@ fn writeBashCompletions(writer: anytype) !void {
         try writer.writeAll(pad2 ++ "--" ++ field.name ++ ") ");
 
         if (std.mem.startsWith(u8, field.name, "font-family"))
-            try writer.writeAll("_fonts ;;")
+            try writer.writeAll("return ;;")
         else if (std.mem.eql(u8, "theme", field.name))
-            try writer.writeAll("_themes ;;")
+            try writer.writeAll("return ;;")
         else if (std.mem.eql(u8, "working-directory", field.name))
-            try writer.writeAll("_dirs ;;")
+            try writer.writeAll("return ;;")
         else if (field.type == Config.RepeatablePath)
-            try writer.writeAll("_files ;;")
+            try writer.writeAll("return ;;")
         else {
             const compgenPrefix = "mapfile -t COMPREPLY < <( compgen -W \"";
             const compgenSuffix = "\" -- \"$cur\" ); addSpaces ;;";
@@ -218,7 +183,7 @@ fn writeBashCompletions(writer: anytype) !void {
                 },
                 else => {
                     if (std.mem.eql(u8, "config-file", opt.name)) {
-                        try writer.writeAll("_files ;;");
+                        try writer.writeAll("return ;;");
                     } else try writer.writeAll("return;;");
                 },
             }
@@ -266,12 +231,6 @@ fn writeBashCompletions(writer: anytype) !void {
         \\  else                    prev="${COMP_WORDS[COMP_CWORD-1]}"
         \\  fi
         \\
-        \\  # current completion is double quoted add a space so the curor progresses
-        \\  if [[ "$2" == \"*\" ]]; then
-        \\    COMPREPLY=( "$cur " );
-        \\    return;
-        \\  fi
-        \\
         \\  case "$COMP_CWORD" in
         \\    1)
         \\      case "${COMP_WORDS[1]}" in
@@ -284,12 +243,6 @@ fn writeBashCompletions(writer: anytype) !void {
         \\      case "$prev" in
         \\        -e | --help | --version) return 0 ;;
         \\        *)
-        \\          if [[ "=" != "${COMP_WORDS[COMP_CWORD]}" && $prevWasEq != true ]]; then
-        \\            # must be completing with a space after the key eg: '--<key> '
-        \\            # clear out prev so we don't run any of the key specific completions
-        \\            prev=""
-        \\          fi
-        \\        
         \\          case "${COMP_WORDS[1]}" in
         \\            --*) _handleConfig ;;
         \\            +*) _handleActions ;;

commit 79d2f508a9eb767f50ef2c30fbf5282357705e60
Author: Anund <anundm@gmail.com>
Date:   Mon Dec 16 08:23:28 2024 +1100

    bash: support short form boolean options

diff --git a/src/build/bash_completions.zig b/src/build/bash_completions.zig
index 03694bf8..02da91ac 100644
--- a/src/build/bash_completions.zig
+++ b/src/build/bash_completions.zig
@@ -52,7 +52,10 @@ fn writeBashCompletions(writer: anytype) !void {
 
     for (@typeInfo(Config).Struct.fields) |field| {
         if (field.name[0] == '_') continue;
-        try writer.writeAll("config+=\" --" ++ field.name ++ "=\"\n");
+        switch (field.type) {
+            bool, ?bool => try writer.writeAll("config+=\" '--" ++ field.name ++ " '\"\n"),
+            else => try writer.writeAll("config+=\" --" ++ field.name ++ "=\"\n"),
+        }
     }
 
     try writer.writeAll(
@@ -78,7 +81,7 @@ fn writeBashCompletions(writer: anytype) !void {
             const compgenPrefix = "mapfile -t COMPREPLY < <( compgen -W \"";
             const compgenSuffix = "\" -- \"$cur\" ); addSpaces ;;";
             switch (@typeInfo(field.type)) {
-                .Bool => try writer.writeAll(compgenPrefix ++ "true false" ++ compgenSuffix),
+                .Bool => try writer.writeAll("return ;;"),
                 .Enum => |info| {
                     try writer.writeAll(compgenPrefix);
                     for (info.fields, 0..) |f, i| {
@@ -136,7 +139,10 @@ fn writeBashCompletions(writer: anytype) !void {
             for (@typeInfo(options).Struct.fields) |opt| {
                 if (opt.name[0] == '_') continue;
                 if (count > 0) try writer.writeAll(" ");
-                try writer.writeAll("--" ++ opt.name ++ "=");
+                switch (opt.type) {
+                    bool, ?bool => try writer.writeAll("'--" ++ opt.name ++ " '"),
+                    else => try writer.writeAll("--" ++ opt.name ++ "="),
+                }
                 count += 1;
             }
         }
@@ -172,7 +178,7 @@ fn writeBashCompletions(writer: anytype) !void {
             const compgenPrefix = "mapfile -t COMPREPLY < <( compgen -W \"";
             const compgenSuffix = "\" -- \"$cur\" ); addSpaces ;;";
             switch (@typeInfo(opt.type)) {
-                .Bool => try writer.writeAll(compgenPrefix ++ "true false" ++ compgenSuffix),
+                .Bool => try writer.writeAll("return ;;"),
                 .Enum => |info| {
                     try writer.writeAll(compgenPrefix);
                     for (info.opts, 0..) |f, i| {

commit 781670589874276c2f01a49b21e91532a1baebc3
Author: Jeffrey C. Ollie <jeff@ocjtech.us>
Date:   Mon Dec 16 18:03:32 2024 -0600

    build: allow CLI actions to have enum option values
    
    A typo in the fish completions (that was likely copied to the zsh and
    bash completions) prevented CLI actions from using enums as option
    values because the completions tried to access non-existent fields from
    type introspection. This doesn't cause any problems _now_ because no CLI
    action uses an enum as an option value. However as soon as you try and
    add one the completions fail to compile.
    
    This patch fixes the incorrect field reference. It also adds the ability
    to have _optional_ enums as option values.

diff --git a/src/build/bash_completions.zig b/src/build/bash_completions.zig
index 02da91ac..0e27a9be 100644
--- a/src/build/bash_completions.zig
+++ b/src/build/bash_completions.zig
@@ -181,12 +181,29 @@ fn writeBashCompletions(writer: anytype) !void {
                 .Bool => try writer.writeAll("return ;;"),
                 .Enum => |info| {
                     try writer.writeAll(compgenPrefix);
-                    for (info.opts, 0..) |f, i| {
+                    for (info.fields, 0..) |f, i| {
                         if (i > 0) try writer.writeAll(" ");
                         try writer.writeAll(f.name);
                     }
                     try writer.writeAll(compgenSuffix);
                 },
+                .Optional => |optional| {
+                    switch (@typeInfo(optional.child)) {
+                        .Enum => |info| {
+                            try writer.writeAll(compgenPrefix);
+                            for (info.fields, 0..) |f, i| {
+                                if (i > 0) try writer.writeAll(" ");
+                                try writer.writeAll(f.name);
+                            }
+                            try writer.writeAll(compgenSuffix);
+                        },
+                        else => {
+                            if (std.mem.eql(u8, "config-file", opt.name)) {
+                                try writer.writeAll("return ;;");
+                            } else try writer.writeAll("return;;");
+                        },
+                    }
+                },
                 else => {
                     if (std.mem.eql(u8, "config-file", opt.name)) {
                         try writer.writeAll("return ;;");

commit 3f94c84c80787cd51d20bcc79a940db18c676a20
Author: Anund <anundm@gmail.com>
Date:   Sat Dec 21 13:43:41 2024 +1100

    Revert "bash: remove quoted completions while sorting possible portability issue"
    
    This reverts commit f1728f594a681941b85a8d2fa8a136d625d9b633.

diff --git a/src/build/bash_completions.zig b/src/build/bash_completions.zig
index 0e27a9be..e8b6a254 100644
--- a/src/build/bash_completions.zig
+++ b/src/build/bash_completions.zig
@@ -37,6 +37,7 @@ fn writeBashCompletions(writer: anytype) !void {
     const pad4 = pad3 ++ pad1;
 
     try writer.writeAll(
+        \\
         \\# -o nospace requires we add back a space when a completion is finished
         \\# and not part of a --key= completion
         \\addSpaces() {
@@ -45,6 +46,40 @@ fn writeBashCompletions(writer: anytype) !void {
         \\  done
         \\}
         \\
+        \\_fonts() {
+        \\  local IFS=$'\n'
+        \\  mapfile -t COMPREPLY < <( compgen -P '"' -S '"' -W "$($ghostty +list-fonts | grep '^[A-Z]' )" -- "$cur")
+        \\}
+        \\
+        \\_themes() {
+        \\  local IFS=$'\n'
+        \\  mapfile -t COMPREPLY < <( compgen -P '"' -S '"' -W "$($ghostty +list-themes | sed -E 's/^(.*) \(.*$/\1/')" -- "$cur")
+        \\}
+        \\
+        \\_files() {
+        \\  mapfile -t COMPREPLY < <( compgen -o filenames -f -- "$cur" )
+        \\  for i in "${!COMPREPLY[@]}"; do
+        \\    if [[ -d "${COMPREPLY[i]}" ]]; then
+        \\      COMPREPLY[i]="${COMPREPLY[i]}/";
+        \\    fi
+        \\    if [[ -f "${COMPREPLY[i]}" ]]; then
+        \\      COMPREPLY[i]="${COMPREPLY[i]} ";
+        \\    fi
+        \\  done
+        \\}
+        \\
+        \\_dirs() {
+        \\  mapfile -t COMPREPLY < <( compgen -o dirnames -d -- "$cur" )
+        \\  for i in "${!COMPREPLY[@]}"; do
+        \\    if [[ -d "${COMPREPLY[i]}" ]]; then
+        \\      COMPREPLY[i]="${COMPREPLY[i]}/";
+        \\    fi
+        \\  done
+        \\  if [[ "${#COMPREPLY[@]}" == 0 && -d "$cur" ]]; then
+        \\    COMPREPLY=( "$cur " )
+        \\  fi
+        \\}
+        \\
         \\config="--help"
         \\config+=" --version"
         \\
@@ -70,13 +105,13 @@ fn writeBashCompletions(writer: anytype) !void {
         try writer.writeAll(pad2 ++ "--" ++ field.name ++ ") ");
 
         if (std.mem.startsWith(u8, field.name, "font-family"))
-            try writer.writeAll("return ;;")
+            try writer.writeAll("_fonts ;;")
         else if (std.mem.eql(u8, "theme", field.name))
-            try writer.writeAll("return ;;")
+            try writer.writeAll("_themes ;;")
         else if (std.mem.eql(u8, "working-directory", field.name))
-            try writer.writeAll("return ;;")
+            try writer.writeAll("_dirs ;;")
         else if (field.type == Config.RepeatablePath)
-            try writer.writeAll("return ;;")
+            try writer.writeAll("_files ;;")
         else {
             const compgenPrefix = "mapfile -t COMPREPLY < <( compgen -W \"";
             const compgenSuffix = "\" -- \"$cur\" ); addSpaces ;;";
@@ -206,7 +241,7 @@ fn writeBashCompletions(writer: anytype) !void {
                 },
                 else => {
                     if (std.mem.eql(u8, "config-file", opt.name)) {
-                        try writer.writeAll("return ;;");
+                        try writer.writeAll("_files ;;");
                     } else try writer.writeAll("return;;");
                 },
             }
@@ -254,6 +289,12 @@ fn writeBashCompletions(writer: anytype) !void {
         \\  else                    prev="${COMP_WORDS[COMP_CWORD-1]}"
         \\  fi
         \\
+        \\  # current completion is double quoted add a space so the curor progresses
+        \\  if [[ "$2" == \"*\" ]]; then
+        \\    COMPREPLY=( "$cur " );
+        \\    return;
+        \\  fi
+        \\
         \\  case "$COMP_CWORD" in
         \\    1)
         \\      case "${COMP_WORDS[1]}" in
@@ -266,6 +307,12 @@ fn writeBashCompletions(writer: anytype) !void {
         \\      case "$prev" in
         \\        -e | --help | --version) return 0 ;;
         \\        *)
+        \\          if [[ "=" != "${COMP_WORDS[COMP_CWORD]}" && $prevWasEq != true ]]; then
+        \\            # must be completing with a space after the key eg: '--<key> '
+        \\            # clear out prev so we don't run any of the key specific completions
+        \\            prev=""
+        \\          fi
+        \\        
         \\          case "${COMP_WORDS[1]}" in
         \\            --*) _handleConfig ;;
         \\            +*) _handleActions ;;

commit 9c96a80f8b11ecb6c37a529ed675d7fe173f92c8
Author: Anund <anundm@gmail.com>
Date:   Sat Dec 21 14:07:52 2024 +1100

    bash: document COMP_WORDBREAKS interaction

diff --git a/src/build/bash_completions.zig b/src/build/bash_completions.zig
index e8b6a254..06d42e70 100644
--- a/src/build/bash_completions.zig
+++ b/src/build/bash_completions.zig
@@ -37,7 +37,6 @@ fn writeBashCompletions(writer: anytype) !void {
     const pad4 = pad3 ++ pad1;
 
     try writer.writeAll(
-        \\
         \\# -o nospace requires we add back a space when a completion is finished
         \\# and not part of a --key= completion
         \\addSpaces() {
@@ -281,6 +280,11 @@ fn writeBashCompletions(writer: anytype) !void {
         \\  cur=""; prev=""; prevWasEq=false; COMPREPLY=()
         \\  ghostty="$1"
         \\
+        \\  # script assumes default COMP_WORDBREAKS of roughly $' \t\n"\'><=;|&(:'
+        \\  # if = is missing this script will degrade to matching on keys only.
+        \\  # eg: --key=
+        \\  # this can be improved if needed see: https://github.com/ghostty-org/ghostty/discussions/2994
+        \\
         \\  if [ "$2" = "=" ]; then cur=""
         \\  else                    cur="$2"
         \\  fi

commit e8d79ed035390e05d1df5a6c0acc1766f441b414
Author: Anund <anundm@gmail.com>
Date:   Sun Dec 22 11:29:35 2024 +1100

    bash: move functions and variables out of global scope

diff --git a/src/build/bash_completions.zig b/src/build/bash_completions.zig
index 06d42e70..6649bcb0 100644
--- a/src/build/bash_completions.zig
+++ b/src/build/bash_completions.zig
@@ -35,73 +35,76 @@ fn writeBashCompletions(writer: anytype) !void {
     const pad2 = pad1 ++ pad1;
     const pad3 = pad2 ++ pad1;
     const pad4 = pad3 ++ pad1;
+    const pad5 = pad4 ++ pad1;
 
     try writer.writeAll(
-        \\# -o nospace requires we add back a space when a completion is finished
-        \\# and not part of a --key= completion
-        \\addSpaces() {
-        \\  for idx in "${!COMPREPLY[@]}"; do
-        \\    [ -n "${COMPREPLY[idx]}" ] && COMPREPLY[idx]="${COMPREPLY[idx]} ";
-        \\  done
-        \\}
+        \\_ghostty() {
         \\
-        \\_fonts() {
-        \\  local IFS=$'\n'
-        \\  mapfile -t COMPREPLY < <( compgen -P '"' -S '"' -W "$($ghostty +list-fonts | grep '^[A-Z]' )" -- "$cur")
-        \\}
+        \\  # -o nospace requires we add back a space when a completion is finished
+        \\  # and not part of a --key= completion
+        \\  _add_spaces() {
+        \\    for idx in "${!COMPREPLY[@]}"; do
+        \\      [ -n "${COMPREPLY[idx]}" ] && COMPREPLY[idx]="${COMPREPLY[idx]} ";
+        \\    done
+        \\  }
         \\
-        \\_themes() {
-        \\  local IFS=$'\n'
-        \\  mapfile -t COMPREPLY < <( compgen -P '"' -S '"' -W "$($ghostty +list-themes | sed -E 's/^(.*) \(.*$/\1/')" -- "$cur")
-        \\}
+        \\  _fonts() {
+        \\    local IFS=$'\n'
+        \\    mapfile -t COMPREPLY < <( compgen -P '"' -S '"' -W "$($ghostty +list-fonts | grep '^[A-Z]' )" -- "$cur")
+        \\  }
         \\
-        \\_files() {
-        \\  mapfile -t COMPREPLY < <( compgen -o filenames -f -- "$cur" )
-        \\  for i in "${!COMPREPLY[@]}"; do
-        \\    if [[ -d "${COMPREPLY[i]}" ]]; then
-        \\      COMPREPLY[i]="${COMPREPLY[i]}/";
-        \\    fi
-        \\    if [[ -f "${COMPREPLY[i]}" ]]; then
-        \\      COMPREPLY[i]="${COMPREPLY[i]} ";
-        \\    fi
-        \\  done
-        \\}
+        \\  _themes() {
+        \\    local IFS=$'\n'
+        \\    mapfile -t COMPREPLY < <( compgen -P '"' -S '"' -W "$($ghostty +list-themes | sed -E 's/^(.*) \(.*$/\1/')" -- "$cur")
+        \\  }
         \\
-        \\_dirs() {
-        \\  mapfile -t COMPREPLY < <( compgen -o dirnames -d -- "$cur" )
-        \\  for i in "${!COMPREPLY[@]}"; do
-        \\    if [[ -d "${COMPREPLY[i]}" ]]; then
-        \\      COMPREPLY[i]="${COMPREPLY[i]}/";
+        \\  _files() {
+        \\    mapfile -t COMPREPLY < <( compgen -o filenames -f -- "$cur" )
+        \\    for i in "${!COMPREPLY[@]}"; do
+        \\      if [[ -d "${COMPREPLY[i]}" ]]; then
+        \\        COMPREPLY[i]="${COMPREPLY[i]}/";
+        \\      fi
+        \\      if [[ -f "${COMPREPLY[i]}" ]]; then
+        \\        COMPREPLY[i]="${COMPREPLY[i]} ";
+        \\      fi
+        \\    done
+        \\  }
+        \\
+        \\  _dirs() {
+        \\    mapfile -t COMPREPLY < <( compgen -o dirnames -d -- "$cur" )
+        \\    for i in "${!COMPREPLY[@]}"; do
+        \\      if [[ -d "${COMPREPLY[i]}" ]]; then
+        \\        COMPREPLY[i]="${COMPREPLY[i]}/";
+        \\      fi
+        \\    done
+        \\    if [[ "${#COMPREPLY[@]}" == 0 && -d "$cur" ]]; then
+        \\      COMPREPLY=( "$cur " )
         \\    fi
-        \\  done
-        \\  if [[ "${#COMPREPLY[@]}" == 0 && -d "$cur" ]]; then
-        \\    COMPREPLY=( "$cur " )
-        \\  fi
-        \\}
+        \\  }
         \\
-        \\config="--help"
-        \\config+=" --version"
+        \\  _handle_config() {
+        \\    local config="--help"
+        \\    config+=" --version"
         \\
     );
 
     for (@typeInfo(Config).Struct.fields) |field| {
         if (field.name[0] == '_') continue;
         switch (field.type) {
-            bool, ?bool => try writer.writeAll("config+=\" '--" ++ field.name ++ " '\"\n"),
-            else => try writer.writeAll("config+=\" --" ++ field.name ++ "=\"\n"),
+            bool, ?bool => try writer.writeAll(pad2 ++ "config+=\" '--" ++ field.name ++ " '\"\n"),
+            else => try writer.writeAll(pad2 ++ "config+=\" --" ++ field.name ++ "=\"\n"),
         }
     }
 
     try writer.writeAll(
         \\
-        \\_handleConfig() {
-        \\  case "$prev" in
+        \\    case "$prev" in
         \\
     );
 
     for (@typeInfo(Config).Struct.fields) |field| {
         if (field.name[0] == '_') continue;
-        try writer.writeAll(pad2 ++ "--" ++ field.name ++ ") ");
+        try writer.writeAll(pad3 ++ "--" ++ field.name ++ ") ");
 
         if (std.mem.startsWith(u8, field.name, "font-family"))
             try writer.writeAll("_fonts ;;")
@@ -113,7 +116,7 @@ fn writeBashCompletions(writer: anytype) !void {
             try writer.writeAll("_files ;;")
         else {
             const compgenPrefix = "mapfile -t COMPREPLY < <( compgen -W \"";
-            const compgenSuffix = "\" -- \"$cur\" ); addSpaces ;;";
+            const compgenSuffix = "\" -- \"$cur\" ); _add_spaces ;;";
             switch (@typeInfo(field.type)) {
                 .Bool => try writer.writeAll("return ;;"),
                 .Enum => |info| {
@@ -144,12 +147,13 @@ fn writeBashCompletions(writer: anytype) !void {
     }
 
     try writer.writeAll(
-        \\    *) mapfile -t COMPREPLY < <( compgen -W "$config" -- "$cur" ) ;;
-        \\  esac
+        \\      *) mapfile -t COMPREPLY < <( compgen -W "$config" -- "$cur" ) ;;
+        \\    esac
         \\
-        \\  return 0
-        \\}
+        \\    return 0
+        \\  }
         \\
+        \\  _handle_actions() {
         \\
     );
 
@@ -166,7 +170,7 @@ fn writeBashCompletions(writer: anytype) !void {
         @memcpy(bashName, field.name);
 
         std.mem.replaceScalar(u8, bashName, '-', '_');
-        try writer.writeAll(bashName ++ "=\"");
+        try writer.writeAll(pad2 ++ "local " ++ bashName ++ "=\"");
 
         {
             var count = 0;
@@ -185,8 +189,7 @@ fn writeBashCompletions(writer: anytype) !void {
 
     try writer.writeAll(
         \\
-        \\_handleActions() {
-        \\  case "${COMP_WORDS[1]}" in
+        \\    case "${COMP_WORDS[1]}" in
         \\
     );
 
@@ -202,15 +205,15 @@ fn writeBashCompletions(writer: anytype) !void {
         const bashName: []u8 = buffer[0..field.name.len];
         _ = std.mem.replace(u8, field.name, "-", "_", bashName);
 
-        try writer.writeAll(pad2 ++ "+" ++ field.name ++ ")\n");
-        try writer.writeAll(pad3 ++ "case $prev in\n");
+        try writer.writeAll(pad3 ++ "+" ++ field.name ++ ")\n");
+        try writer.writeAll(pad4 ++ "case $prev in\n");
         for (@typeInfo(options).Struct.fields) |opt| {
             if (opt.name[0] == '_') continue;
 
-            try writer.writeAll(pad4 ++ "--" ++ opt.name ++ ") ");
+            try writer.writeAll(pad5 ++ "--" ++ opt.name ++ ") ");
 
             const compgenPrefix = "mapfile -t COMPREPLY < <( compgen -W \"";
-            const compgenSuffix = "\" -- \"$cur\" ); addSpaces ;;";
+            const compgenSuffix = "\" -- \"$cur\" ); _add_spaces ;;";
             switch (@typeInfo(opt.type)) {
                 .Bool => try writer.writeAll("return ;;"),
                 .Enum => |info| {
@@ -246,24 +249,25 @@ fn writeBashCompletions(writer: anytype) !void {
             }
             try writer.writeAll("\n");
         }
-        try writer.writeAll(pad4 ++ "*) mapfile -t COMPREPLY < <( compgen -W \"$" ++ bashName ++ "\" -- \"$cur\" ) ;;\n");
+        try writer.writeAll(pad5 ++ "*) mapfile -t COMPREPLY < <( compgen -W \"$" ++ bashName ++ "\" -- \"$cur\" ) ;;\n");
         try writer.writeAll(
-            \\      esac
-            \\    ;;
+            \\        esac
+            \\      ;;
             \\
         );
     }
 
     try writer.writeAll(
-        \\    *) mapfile -t COMPREPLY < <( compgen -W "--help" -- "$cur" ) ;;
-        \\  esac
+        \\      *) mapfile -t COMPREPLY < <( compgen -W "--help" -- "$cur" ) ;;
+        \\    esac
         \\
-        \\  return 0
-        \\}
+        \\    return 0
+        \\  }
         \\
-        \\topLevel="-e"
-        \\topLevel+=" --help"
-        \\topLevel+=" --version"
+        \\  # begin main logic
+        \\  local topLevel="-e"
+        \\  topLevel+=" --help"
+        \\  topLevel+=" --version"
         \\
     );
 
@@ -271,14 +275,13 @@ fn writeBashCompletions(writer: anytype) !void {
         if (std.mem.eql(u8, "help", field.name)) continue;
         if (std.mem.eql(u8, "version", field.name)) continue;
 
-        try writer.writeAll("topLevel+=\" +" ++ field.name ++ "\"\n");
+        try writer.writeAll(pad1 ++ "topLevel+=\" +" ++ field.name ++ "\"\n");
     }
 
     try writer.writeAll(
         \\
-        \\_ghostty() {
-        \\  cur=""; prev=""; prevWasEq=false; COMPREPLY=()
-        \\  ghostty="$1"
+        \\  local cur=""; local prev=""; local prevWasEq=false; COMPREPLY=()
+        \\  local ghostty="$1"
         \\
         \\  # script assumes default COMP_WORDBREAKS of roughly $' \t\n"\'><=;|&(:'
         \\  # if = is missing this script will degrade to matching on keys only.
@@ -303,8 +306,8 @@ fn writeBashCompletions(writer: anytype) !void {
         \\    1)
         \\      case "${COMP_WORDS[1]}" in
         \\        -e | --help | --version) return 0 ;;
-        \\        --*) _handleConfig ;;
-        \\        *) mapfile -t COMPREPLY < <( compgen -W "${topLevel}" -- "$cur" ); addSpaces ;;
+        \\        --*) _handle_config ;;
+        \\        *) mapfile -t COMPREPLY < <( compgen -W "${topLevel}" -- "$cur" ); _add_spaces ;;
         \\      esac
         \\      ;;
         \\    *)
@@ -318,8 +321,8 @@ fn writeBashCompletions(writer: anytype) !void {
         \\          fi
         \\        
         \\          case "${COMP_WORDS[1]}" in
-        \\            --*) _handleConfig ;;
-        \\            +*) _handleActions ;;
+        \\            --*) _handle_config ;;
+        \\            +*) _handle_actions ;;
         \\          esac
         \\          ;;
         \\      esac

commit 8bf5c4ed7f8e39ca6dcadd036c8c72924590b200
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Tue Jan 7 07:14:32 2025 -0800

    This is a major refactor of `build.zig`.
    
    The major idea behind the refactor is to split the `build.zig` file up into
    distinct `src/build/*.zig` files. By doing so, we can improve readability of
    the primary `build.zig` while also enabling better reuse of steps. Our
    `build.zig` is now less than 150 lines of code (of course, it calls into a lot
    more lines but they're neatly organized now).
    
    Improvements:
    
      * `build.zig` is less than 150 lines of readable code.
      * Help strings and unicode table generators are only run once when multiple
        artifacts are built since the results are the same regardless of target.
      * Metal lib is only built once per architecture (rather than once per artifact)
      * Resources (shell integration, terminfo, etc.) and docs are only
        built/installed for artifacts that need them
    
    Breaking changes:
    
      * Removed broken wasm build (@gabydd will re-add)
      * Removed conformance files, shell scripts are better and we don't run
        these anymore
      * Removed macOS app bundle creation, we don't use this anymore since we
        use Xcode
    
    ## Some History
    
    Our `build.zig` hasn't been significantly refactored since the project started,
    when Zig was _version 0.10_. Since then, the build system has changed
    significantly. We've only ever duct taped the `build.zig` as we needed to
    support new Zig versions, new features, etc. It was a mess.
    
    The major improvement is adapting the entire Ghostty `build.zig` to the Step
    and LazyPath changes introduced way back in Zig 0.12. This lets us better take
    advantage of parallelism and the dependency graph so that steps are only
    executed as they're needed.
    
    As such, you can see in the build.zig that we initialize a lot of things, but
    unless a final target (i.e. install, run) references those steps, _they'll
    never be executed_. This lets us clean up a lot.

diff --git a/src/build/bash_completions.zig b/src/build/bash_completions.zig
index 6649bcb0..86c2dc3c 100644
--- a/src/build/bash_completions.zig
+++ b/src/build/bash_completions.zig
@@ -14,7 +14,7 @@ const Action = @import("../cli/action.zig").Action;
 /// it's part of an on going completion like --<key>=. Working around this requires looking
 /// backward in the command line args to pretend the = is an empty string
 /// see: https://www.gnu.org/software/gnuastro/manual/html_node/Bash-TAB-completion-tutorial.html
-pub const bash_completions = comptimeGenerateBashCompletions();
+pub const completions = comptimeGenerateBashCompletions();
 
 fn comptimeGenerateBashCompletions() []const u8 {
     comptime {
@@ -319,7 +319,7 @@ fn writeBashCompletions(writer: anytype) !void {
         \\            # clear out prev so we don't run any of the key specific completions
         \\            prev=""
         \\          fi
-        \\        
+        \\
         \\          case "${COMP_WORDS[1]}" in
         \\            --*) _handle_config ;;
         \\            +*) _handle_actions ;;

commit 7e2286eb8c603ade782a3970911531595d57e280
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Tue Mar 11 14:33:33 2025 -0700

    Zig 0.14

diff --git a/src/build/bash_completions.zig b/src/build/bash_completions.zig
index 86c2dc3c..ad62ff97 100644
--- a/src/build/bash_completions.zig
+++ b/src/build/bash_completions.zig
@@ -88,7 +88,7 @@ fn writeBashCompletions(writer: anytype) !void {
         \\
     );
 
-    for (@typeInfo(Config).Struct.fields) |field| {
+    for (@typeInfo(Config).@"struct".fields) |field| {
         if (field.name[0] == '_') continue;
         switch (field.type) {
             bool, ?bool => try writer.writeAll(pad2 ++ "config+=\" '--" ++ field.name ++ " '\"\n"),
@@ -102,7 +102,7 @@ fn writeBashCompletions(writer: anytype) !void {
         \\
     );
 
-    for (@typeInfo(Config).Struct.fields) |field| {
+    for (@typeInfo(Config).@"struct".fields) |field| {
         if (field.name[0] == '_') continue;
         try writer.writeAll(pad3 ++ "--" ++ field.name ++ ") ");
 
@@ -118,8 +118,8 @@ fn writeBashCompletions(writer: anytype) !void {
             const compgenPrefix = "mapfile -t COMPREPLY < <( compgen -W \"";
             const compgenSuffix = "\" -- \"$cur\" ); _add_spaces ;;";
             switch (@typeInfo(field.type)) {
-                .Bool => try writer.writeAll("return ;;"),
-                .Enum => |info| {
+                .bool => try writer.writeAll("return ;;"),
+                .@"enum" => |info| {
                     try writer.writeAll(compgenPrefix);
                     for (info.fields, 0..) |f, i| {
                         if (i > 0) try writer.writeAll(" ");
@@ -127,7 +127,7 @@ fn writeBashCompletions(writer: anytype) !void {
                     }
                     try writer.writeAll(compgenSuffix);
                 },
-                .Struct => |info| {
+                .@"struct" => |info| {
                     if (!@hasDecl(field.type, "parseCLI") and info.layout == .@"packed") {
                         try writer.writeAll(compgenPrefix);
                         for (info.fields, 0..) |f, i| {
@@ -157,13 +157,13 @@ fn writeBashCompletions(writer: anytype) !void {
         \\
     );
 
-    for (@typeInfo(Action).Enum.fields) |field| {
+    for (@typeInfo(Action).@"enum".fields) |field| {
         if (std.mem.eql(u8, "help", field.name)) continue;
         if (std.mem.eql(u8, "version", field.name)) continue;
 
         const options = @field(Action, field.name).options();
         // assumes options will never be created with only <_name> members
-        if (@typeInfo(options).Struct.fields.len == 0) continue;
+        if (@typeInfo(options).@"struct".fields.len == 0) continue;
 
         var buffer: [field.name.len]u8 = undefined;
         const bashName: []u8 = buffer[0..field.name.len];
@@ -174,7 +174,7 @@ fn writeBashCompletions(writer: anytype) !void {
 
         {
             var count = 0;
-            for (@typeInfo(options).Struct.fields) |opt| {
+            for (@typeInfo(options).@"struct".fields) |opt| {
                 if (opt.name[0] == '_') continue;
                 if (count > 0) try writer.writeAll(" ");
                 switch (opt.type) {
@@ -193,12 +193,12 @@ fn writeBashCompletions(writer: anytype) !void {
         \\
     );
 
-    for (@typeInfo(Action).Enum.fields) |field| {
+    for (@typeInfo(Action).@"enum".fields) |field| {
         if (std.mem.eql(u8, "help", field.name)) continue;
         if (std.mem.eql(u8, "version", field.name)) continue;
 
         const options = @field(Action, field.name).options();
-        if (@typeInfo(options).Struct.fields.len == 0) continue;
+        if (@typeInfo(options).@"struct".fields.len == 0) continue;
 
         // bash doesn't allow variable names containing '-' so replace them
         var buffer: [field.name.len]u8 = undefined;
@@ -207,7 +207,7 @@ fn writeBashCompletions(writer: anytype) !void {
 
         try writer.writeAll(pad3 ++ "+" ++ field.name ++ ")\n");
         try writer.writeAll(pad4 ++ "case $prev in\n");
-        for (@typeInfo(options).Struct.fields) |opt| {
+        for (@typeInfo(options).@"struct".fields) |opt| {
             if (opt.name[0] == '_') continue;
 
             try writer.writeAll(pad5 ++ "--" ++ opt.name ++ ") ");
@@ -215,8 +215,8 @@ fn writeBashCompletions(writer: anytype) !void {
             const compgenPrefix = "mapfile -t COMPREPLY < <( compgen -W \"";
             const compgenSuffix = "\" -- \"$cur\" ); _add_spaces ;;";
             switch (@typeInfo(opt.type)) {
-                .Bool => try writer.writeAll("return ;;"),
-                .Enum => |info| {
+                .bool => try writer.writeAll("return ;;"),
+                .@"enum" => |info| {
                     try writer.writeAll(compgenPrefix);
                     for (info.fields, 0..) |f, i| {
                         if (i > 0) try writer.writeAll(" ");
@@ -224,9 +224,9 @@ fn writeBashCompletions(writer: anytype) !void {
                     }
                     try writer.writeAll(compgenSuffix);
                 },
-                .Optional => |optional| {
+                .optional => |optional| {
                     switch (@typeInfo(optional.child)) {
-                        .Enum => |info| {
+                        .@"enum" => |info| {
                             try writer.writeAll(compgenPrefix);
                             for (info.fields, 0..) |f, i| {
                                 if (i > 0) try writer.writeAll(" ");
@@ -271,7 +271,7 @@ fn writeBashCompletions(writer: anytype) !void {
         \\
     );
 
-    for (@typeInfo(Action).Enum.fields) |field| {
+    for (@typeInfo(Action).@"enum".fields) |field| {
         if (std.mem.eql(u8, "help", field.name)) continue;
         if (std.mem.eql(u8, "version", field.name)) continue;
 

</code></pre>
        </section>
    </main>
    <footer>
        <p>LoCoDiff-bench - <a href="https://github.com/AbanteAI/LoCoDiff-bench">GitHub Repository</a></p>
    </footer>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            hljs.highlightAll();
        });
    </script>
</body>
</html>
    