<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prompt: packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx - Claude Opus 4.1</title>
    <link rel="stylesheet" href="../../../../styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/default.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
</head>
<body>
    <header>
        <h1>Prompt: packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx</h1>
        <h2>Model: Claude Opus 4.1</h2>
        <p><a href="../../../cases/anthropic_claude-opus-4.1/tldraw_packages_tldraw_src_lib_shapes_note_NoteShapeUtil.tsx.html">Back to Case</a> | <a href="../../../cases.html">All Cases</a> | <a href="../../../index.html">Home</a></p>
    </header>
    <main>
        <section>
            <h2>Prompt Content</h2>
            <pre><code class="language-plaintext"># Instructions

You are being benchmarked. You will see the output of a git log command, and from that must infer the current state of a file. Think carefully, as you must output the exact state of the file to earn full marks.

**Important:** Your goal is to reproduce the file's content *exactly* as it exists at the final commit, even if the code appears broken, buggy, or contains obvious errors. Do **not** try to "fix" the code. Attempting to correct issues will result in a poor score, as this benchmark evaluates your ability to reproduce the precise state of the file based on its history.

# Required Response Format

Wrap the content of the file in triple backticks (```). Any text outside the final closing backticks will be ignored. End your response after outputting the closing backticks.

# Example Response

```python
#!/usr/bin/env python
print('Hello, world!')
```

# File History

> git log -p --cc --topo-order --reverse -- packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx

commit b7d9c8684cb6cf7bd710af5420135ea3516cc3bf
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Mon Jul 17 22:22:34 2023 +0100

    tldraw zero - package shuffle (#1710)
    
    This PR moves code between our packages so that:
    - @tldraw/editor is a “core” library with the engine and canvas but no
    shapes, tools, or other things
    - @tldraw/tldraw contains everything particular to the experience we’ve
    built for tldraw
    
    At first look, this might seem like a step away from customization and
    configuration, however I believe it greatly increases the configuration
    potential of the @tldraw/editor while also providing a more accurate
    reflection of what configuration options actually exist for
    @tldraw/tldraw.
    
    ## Library changes
    
    @tldraw/editor re-exports its dependencies and @tldraw/tldraw re-exports
    @tldraw/editor.
    
    - users of @tldraw/editor WITHOUT @tldraw/tldraw should almost always
    only import things from @tldraw/editor.
    - users of @tldraw/tldraw should almost always only import things from
    @tldraw/tldraw.
    
    - @tldraw/polyfills is merged into @tldraw/editor
    - @tldraw/indices is merged into @tldraw/editor
    - @tldraw/primitives is merged mostly into @tldraw/editor, partially
    into @tldraw/tldraw
    - @tldraw/file-format is merged into @tldraw/tldraw
    - @tldraw/ui is merged into @tldraw/tldraw
    
    Many (many) utils and other code is moved from the editor to tldraw. For
    example, embeds now are entirely an feature of @tldraw/tldraw. The only
    big chunk of code left in core is related to arrow handling.
    
    ## API Changes
    
    The editor can now be used without tldraw's assets. We load them in
    @tldraw/tldraw instead, so feel free to use whatever fonts or images or
    whatever that you like with the editor.
    
    All tools and shapes (except for the `Group` shape) are moved to
    @tldraw/tldraw. This includes the `select` tool.
    
    You should use the editor with at least one tool, however, so you now
    also need to send in an `initialState` prop to the Editor /
    <TldrawEditor> component indicating which state the editor should begin
    in.
    
    The `components` prop now also accepts `SelectionForeground`.
    
    The complex selection component that we use for tldraw is moved to
    @tldraw/tldraw. The default component is quite basic but can easily be
    replaced via the `components` prop. We pass down our tldraw-flavored
    SelectionFg via `components`.
    
    Likewise with the `Scribble` component: the `DefaultScribble` no longer
    uses our freehand tech and is a simple path instead. We pass down the
    tldraw-flavored scribble via `components`.
    
    The `ExternalContentManager` (`Editor.externalContentManager`) is
    removed and replaced with a mapping of types to handlers.
    
    - Register new content handlers with
    `Editor.registerExternalContentHandler`.
    - Register new asset creation handlers (for files and URLs) with
    `Editor.registerExternalAssetHandler`
    
    ### Change Type
    
    - [x] `major` — Breaking change
    
    ### Test Plan
    
    - [x] Unit Tests
    - [x] End to end tests
    
    ### Release Notes
    
    - [@tldraw/editor] lots, wip
    - [@tldraw/ui] gone, merged to tldraw/tldraw
    - [@tldraw/polyfills] gone, merged to tldraw/editor
    - [@tldraw/primitives] gone, merged to tldraw/editor / tldraw/tldraw
    - [@tldraw/indices] gone, merged to tldraw/editor
    - [@tldraw/file-format] gone, merged to tldraw/tldraw
    
    ---------
    
    Co-authored-by: alex <alex@dytry.ch>

diff --git a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
new file mode 100644
index 000000000..92e6a7b92
--- /dev/null
+++ b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
@@ -0,0 +1,231 @@
+import {
+	Box2d,
+	DefaultFontFamilies,
+	Editor,
+	ShapeUtil,
+	SvgExportContext,
+	TLNoteShape,
+	TLOnEditEndHandler,
+	Vec2d,
+	getDefaultColorTheme,
+	noteShapeMigrations,
+	noteShapeProps,
+	toDomPrecision,
+} from '@tldraw/editor'
+import { HyperlinkButton } from '../shared/HyperlinkButton'
+import { useDefaultColorTheme } from '../shared/ShapeFill'
+import { TextLabel } from '../shared/TextLabel'
+import { FONT_FAMILIES, LABEL_FONT_SIZES, TEXT_PROPS } from '../shared/default-shape-constants'
+import { getFontDefForExport } from '../shared/defaultStyleDefs'
+import { getTextLabelSvgElement } from '../shared/getTextLabelSvgElement'
+
+const NOTE_SIZE = 200
+
+/** @public */
+export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
+	static override type = 'note' as const
+	static override props = noteShapeProps
+	static override migrations = noteShapeMigrations
+
+	override canEdit = () => true
+	override hideResizeHandles = () => true
+	override hideSelectionBoundsBg = () => true
+	override hideSelectionBoundsFg = () => true
+
+	getDefaultProps(): TLNoteShape['props'] {
+		return {
+			color: 'black',
+			size: 'm',
+			text: '',
+			font: 'draw',
+			align: 'middle',
+			verticalAlign: 'middle',
+			growY: 0,
+			url: '',
+		}
+	}
+
+	getHeight(shape: TLNoteShape) {
+		return NOTE_SIZE + shape.props.growY
+	}
+
+	getBounds(shape: TLNoteShape) {
+		const height = this.getHeight(shape)
+		return new Box2d(0, 0, NOTE_SIZE, height)
+	}
+
+	override getOutline(shape: TLNoteShape) {
+		return this.editor.getBounds(shape).corners
+	}
+
+	override getCenter(_shape: TLNoteShape) {
+		return new Vec2d(NOTE_SIZE / 2, this.getHeight(_shape) / 2)
+	}
+
+	component(shape: TLNoteShape) {
+		const {
+			id,
+			type,
+			props: { color, font, size, align, text, verticalAlign },
+		} = shape
+
+		// eslint-disable-next-line react-hooks/rules-of-hooks
+		const theme = useDefaultColorTheme()
+		const adjustedColor = color === 'black' ? 'yellow' : color
+
+		return (
+			<>
+				<div
+					style={{
+						position: 'absolute',
+						width: NOTE_SIZE,
+						height: this.getHeight(shape),
+					}}
+				>
+					<div
+						className="tl-note__container tl-hitarea-fill"
+						style={{
+							color: theme[adjustedColor].solid,
+							backgroundColor: theme[adjustedColor].solid,
+						}}
+					>
+						<div className="tl-note__scrim" />
+						<TextLabel
+							id={id}
+							type={type}
+							font={font}
+							size={size}
+							align={align}
+							verticalAlign={verticalAlign}
+							text={text}
+							labelColor="black"
+							wrap
+						/>
+					</div>
+				</div>
+				{'url' in shape.props && shape.props.url && (
+					<HyperlinkButton url={shape.props.url} zoomLevel={this.editor.zoomLevel} />
+				)}
+			</>
+		)
+	}
+
+	indicator(shape: TLNoteShape) {
+		return (
+			<rect
+				rx="7"
+				width={toDomPrecision(NOTE_SIZE)}
+				height={toDomPrecision(this.getHeight(shape))}
+			/>
+		)
+	}
+
+	override toSvg(shape: TLNoteShape, ctx: SvgExportContext) {
+		ctx.addExportDef(getFontDefForExport(shape.props.font))
+		const theme = getDefaultColorTheme(this.editor)
+		const bounds = this.getBounds(shape)
+
+		const g = document.createElementNS('http://www.w3.org/2000/svg', 'g')
+
+		const adjustedColor = shape.props.color === 'black' ? 'yellow' : shape.props.color
+
+		const rect1 = document.createElementNS('http://www.w3.org/2000/svg', 'rect')
+		rect1.setAttribute('rx', '10')
+		rect1.setAttribute('width', NOTE_SIZE.toString())
+		rect1.setAttribute('height', bounds.height.toString())
+		rect1.setAttribute('fill', theme[adjustedColor].solid)
+		rect1.setAttribute('stroke', theme[adjustedColor].solid)
+		rect1.setAttribute('stroke-width', '1')
+		g.appendChild(rect1)
+
+		const rect2 = document.createElementNS('http://www.w3.org/2000/svg', 'rect')
+		rect2.setAttribute('rx', '10')
+		rect2.setAttribute('width', NOTE_SIZE.toString())
+		rect2.setAttribute('height', bounds.height.toString())
+		rect2.setAttribute('fill', theme.background)
+		rect2.setAttribute('opacity', '.28')
+		g.appendChild(rect2)
+
+		const textElm = getTextLabelSvgElement({
+			editor: this.editor,
+			shape,
+			font: DefaultFontFamilies[shape.props.font],
+			bounds,
+		})
+
+		textElm.setAttribute('fill', theme.text)
+		textElm.setAttribute('stroke', 'none')
+		g.appendChild(textElm)
+
+		return g
+	}
+
+	override onBeforeCreate = (next: TLNoteShape) => {
+		return getGrowY(this.editor, next, next.props.growY)
+	}
+
+	override onBeforeUpdate = (prev: TLNoteShape, next: TLNoteShape) => {
+		if (
+			prev.props.text === next.props.text &&
+			prev.props.font === next.props.font &&
+			prev.props.size === next.props.size
+		) {
+			return
+		}
+
+		return getGrowY(this.editor, next, prev.props.growY)
+	}
+
+	override onEditEnd: TLOnEditEndHandler<TLNoteShape> = (shape) => {
+		const {
+			id,
+			type,
+			props: { text },
+		} = shape
+
+		if (text.trimEnd() !== shape.props.text) {
+			this.editor.updateShapes([
+				{
+					id,
+					type,
+					props: {
+						text: text.trimEnd(),
+					},
+				},
+			])
+		}
+	}
+}
+
+function getGrowY(editor: Editor, shape: TLNoteShape, prevGrowY = 0) {
+	const PADDING = 17
+
+	const nextTextSize = editor.textMeasure.measureText(shape.props.text, {
+		...TEXT_PROPS,
+		fontFamily: FONT_FAMILIES[shape.props.font],
+		fontSize: LABEL_FONT_SIZES[shape.props.size],
+		width: NOTE_SIZE - PADDING * 2 + 'px',
+	})
+
+	const nextHeight = nextTextSize.h + PADDING * 2
+
+	let growY: number | null = null
+
+	if (nextHeight > NOTE_SIZE) {
+		growY = nextHeight - NOTE_SIZE
+	} else {
+		if (prevGrowY) {
+			growY = 0
+		}
+	}
+
+	if (growY !== null) {
+		return {
+			...shape,
+			props: {
+				...shape.props,
+				growY,
+			},
+		}
+	}
+}

commit 3e31ef2a7d01467ef92ca4f7aed13ee708db73ef
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Tue Jul 18 22:50:23 2023 +0100

    Remove helpers / extraneous API methods. (#1745)
    
    This PR removes several extraneous computed values from the editor. It
    adds some silly instance state onto the instance state record and
    unifies a few methods which were inconsistent. This is fit and finish
    work 🧽
    
    ## Computed Values
    
    In general, where once we had a getter and setter for `isBlahMode`,
    which really masked either an `_isBlahMode` atom on the editor or
    `instanceState.isBlahMode`, these are merged into `instanceState`; they
    can be accessed / updated via `editor.instanceState` /
    `editor.updateInstanceState`.
    
    ## tldraw select tool specific things
    
    This PR also removes some tldraw specific state checks and creates new
    component overrides to allow us to include them in tldraw/tldraw.
    
    ### Change Type
    
    - [x] `major` — Breaking change
    
    ### Test Plan
    
    - [x] Unit Tests
    - [x] End to end tests
    
    ### Release Notes
    
    - [tldraw] rename `useReadonly` to `useReadOnly`
    - [editor] remove `Editor.isDarkMode`
    - [editor] remove `Editor.isChangingStyle`
    - [editor] remove `Editor.isCoarsePointer`
    - [editor] remove `Editor.isDarkMode`
    - [editor] remove `Editor.isFocused`
    - [editor] remove `Editor.isGridMode`
    - [editor] remove `Editor.isPenMode`
    - [editor] remove `Editor.isReadOnly`
    - [editor] remove `Editor.isSnapMode`
    - [editor] remove `Editor.isToolLocked`
    - [editor] remove `Editor.locale`
    - [editor] rename `Editor.pageState` to `Editor.currentPageState`
    - [editor] add `Editor.pageStates`
    - [editor] add `Editor.setErasingIds`
    - [editor] add `Editor.setEditingId`
    - [editor] add several new component overrides

diff --git a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
index 92e6a7b92..c5198bcff 100644
--- a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
+++ b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
@@ -122,7 +122,7 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
 
 	override toSvg(shape: TLNoteShape, ctx: SvgExportContext) {
 		ctx.addExportDef(getFontDefForExport(shape.props.font))
-		const theme = getDefaultColorTheme(this.editor)
+		const theme = getDefaultColorTheme({ isDarkMode: this.editor.user.isDarkMode })
 		const bounds = this.getBounds(shape)
 
 		const g = document.createElementNS('http://www.w3.org/2000/svg', 'g')

commit d750da8f40efda4b011a91962ef8f30c63d1e5da
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Tue Jul 25 17:10:15 2023 +0100

    `ShapeUtil.getGeometry`, selection rewrite (#1751)
    
    This PR is a significant rewrite of our selection / hit testing logic.
    
    It
    - replaces our current geometric helpers (`getBounds`, `getOutline`,
    `hitTestPoint`, and `hitTestLineSegment`) with a new geometry API
    - moves our hit testing entirely to JS using geometry
    - improves selection logic, especially around editing shapes, groups and
    frames
    - fixes many minor selection bugs (e.g. shapes behind frames)
    - removes hit-testing DOM elements from ShapeFill etc.
    - adds many new tests around selection
    - adds new tests around selection
    - makes several superficial changes to surface editor APIs
    
    This PR is hard to evaluate. The `selection-omnibus` test suite is
    intended to describe all of the selection behavior, however all existing
    tests are also either here preserved and passing or (in a few cases
    around editing shapes) are modified to reflect the new behavior.
    
    ## Geometry
    
    All `ShapeUtils` implement `getGeometry`, which returns a single
    geometry primitive (`Geometry2d`). For example:
    
    ```ts
    class BoxyShapeUtil {
      getGeometry(shape: BoxyShape) {
        return new Rectangle2d({
            width: shape.props.width,
            height: shape.props.height,
            isFilled: true,
            margin: shape.props.strokeWidth
          })
        }
    }
    ```
    
    This geometric primitive is used for all bounds calculation, hit
    testing, intersection with arrows, etc.
    
    There are several geometric primitives that extend `Geometry2d`:
    - `Arc2d`
    - `Circle2d`
    - `CubicBezier2d`
    - `CubicSpline2d`
    - `Edge2d`
    - `Ellipse2d`
    - `Group2d`
    - `Polygon2d`
    - `Rectangle2d`
    - `Stadium2d`
    
    For shapes that have more complicated geometric representations, such as
    an arrow with a label, the `Group2d` can accept other primitives as its
    children.
    
    ## Hit testing
    
    Previously, we did all hit testing via events set on shapes and other
    elements. In this PR, I've replaced those hit tests with our own
    calculation for hit tests in JavaScript. This removed the need for many
    DOM elements, such as hit test area borders and fills which only existed
    to trigger pointer events.
    
    ## Selection
    
    We now support selecting "hollow" shapes by clicking inside of them.
    This involves a lot of new logic but it should work intuitively. See
    `Editor.getShapeAtPoint` for the (thoroughly commented) implementation.
    
    ![Kapture 2023-07-23 at 23 27
    27](https://github.com/tldraw/tldraw/assets/23072548/a743275c-acdb-42d9-a3fe-b3e20dce86b6)
    
    every sunset is actually the sun hiding in fear and respect of tldraw's
    quality of interactions
    
    This PR also fixes several bugs with scribble selection, in particular
    around the shift key modifier.
    
    ![Kapture 2023-07-24 at 23 34
    07](https://github.com/tldraw/tldraw/assets/23072548/871d67d0-8d06-42ae-a2b2-021effba37c5)
    
    ...as well as issues with labels and editing.
    
    There are **over 100 new tests** for selection covering groups, frames,
    brushing, scribbling, hovering, and editing. I'll add a few more before
    I feel comfortable merging this PR.
    
    ## Arrow binding
    
    Using the same "hollow shape" logic as selection, arrow binding is
    significantly improved.
    
    ![Kapture 2023-07-22 at 07 46
    25](https://github.com/tldraw/tldraw/assets/23072548/5aa724b3-b57d-4fb7-92d0-80e34246753c)
    
    a thousand wise men could not improve on this
    
    ## Moving focus between editing shapes
    
    Previously, this was handled in the `editing_shapes` state. This is
    moved to `useEditableText`, and should generally be considered an
    advanced implementation detail on a shape-by-shape basis. This addresses
    a bug that I'd never noticed before, but which can be reproduced by
    selecting an shape—but not focusing its input—while editing a different
    shape. Previously, the new shape became the editing shape but its input
    did not focus.
    
    ![Kapture 2023-07-23 at 23 19
    09](https://github.com/tldraw/tldraw/assets/23072548/a5e157fb-24a8-42bd-a692-04ce769b1a9c)
    
    In this PR, you can select a shape by clicking on its edge or body, or
    select its input to transfer editing / focus.
    
    ![Kapture 2023-07-23 at 23 22
    21](https://github.com/tldraw/tldraw/assets/23072548/7384e7ea-9777-4e1a-8f63-15de2166a53a)
    
    tldraw, glorious tldraw
    
    ### Change Type
    
    - [x] `major` — Breaking change
    
    ### Test Plan
    
    1. Erase shapes
    2. Select shapes
    3. Calculate their bounding boxes
    
    - [ ] Unit Tests // todo
    - [ ] End to end tests // todo
    
    ### Release Notes
    
    - [editor] Remove `ShapeUtil.getBounds`, `ShapeUtil.getOutline`,
    `ShapeUtil.hitTestPoint`, `ShapeUtil.hitTestLineSegment`
    - [editor] Add `ShapeUtil.getGeometry`
    - [editor] Add `Editor.getShapeGeometry`

diff --git a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
index c5198bcff..411c3110b 100644
--- a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
+++ b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
@@ -1,12 +1,11 @@
 import {
-	Box2d,
 	DefaultFontFamilies,
 	Editor,
+	Rectangle2d,
 	ShapeUtil,
 	SvgExportContext,
 	TLNoteShape,
 	TLOnEditEndHandler,
-	Vec2d,
 	getDefaultColorTheme,
 	noteShapeMigrations,
 	noteShapeProps,
@@ -29,7 +28,6 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
 
 	override canEdit = () => true
 	override hideResizeHandles = () => true
-	override hideSelectionBoundsBg = () => true
 	override hideSelectionBoundsFg = () => true
 
 	getDefaultProps(): TLNoteShape['props'] {
@@ -49,17 +47,9 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
 		return NOTE_SIZE + shape.props.growY
 	}
 
-	getBounds(shape: TLNoteShape) {
+	getGeometry(shape: TLNoteShape) {
 		const height = this.getHeight(shape)
-		return new Box2d(0, 0, NOTE_SIZE, height)
-	}
-
-	override getOutline(shape: TLNoteShape) {
-		return this.editor.getBounds(shape).corners
-	}
-
-	override getCenter(_shape: TLNoteShape) {
-		return new Vec2d(NOTE_SIZE / 2, this.getHeight(_shape) / 2)
+		return new Rectangle2d({ width: NOTE_SIZE, height, isFilled: true })
 	}
 
 	component(shape: TLNoteShape) {
@@ -83,7 +73,7 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
 					}}
 				>
 					<div
-						className="tl-note__container tl-hitarea-fill"
+						className="tl-note__container"
 						style={{
 							color: theme[adjustedColor].solid,
 							backgroundColor: theme[adjustedColor].solid,
@@ -123,7 +113,7 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
 	override toSvg(shape: TLNoteShape, ctx: SvgExportContext) {
 		ctx.addExportDef(getFontDefForExport(shape.props.font))
 		const theme = getDefaultColorTheme({ isDarkMode: this.editor.user.isDarkMode })
-		const bounds = this.getBounds(shape)
+		const bounds = this.editor.getGeometry(shape).bounds
 
 		const g = document.createElementNS('http://www.w3.org/2000/svg', 'g')
 

commit bf277435951a1e7fa5689414670ff1866e721b50
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Wed Aug 2 19:12:25 2023 +0100

    Rename shapes apis (#1787)
    
    This PR updates APIs related to shapes in the Editor.
    
    - removes the requirement for an `id` when creating shapes
    - `shapesOnCurrentPage` -> `currentPageShapes`
    - `findAncestor` -> `findShapeAncestor`
    - `findCommonAncestor` -> `findCommonShapeAncestor`
    - Adds `getCurrentPageShapeIds`
    - `getAncestors` -> `getShapeAncestors`
    - `getClipPath` -> `getShapeClipPath`
    - `getGeometry` -> `getShapeGeometry`
    - `getHandles` -> `getShapeHandles`
    - `getTransform` -> `getShapeLocalTransform`
    - `getPageTransform` -> `getShapePageTransform`
    - `getOutlineSegments` -> `getShapeOutlineSegments`
    - `getPageBounds` -> `getShapePageBounds`
    - `getPageTransform` -> `getShapePageTransform`
    - `getParentTransform` -> `getShapeParentTransform`
    - `selectionBounds` -> `selectionRotatedPageBounds`
    
    ### Change Type
    
    - [x] `major` — Breaking change
    
    ### Test Plan
    
    - [x] Unit Tests

diff --git a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
index 411c3110b..fdac856ad 100644
--- a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
+++ b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
@@ -113,7 +113,7 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
 	override toSvg(shape: TLNoteShape, ctx: SvgExportContext) {
 		ctx.addExportDef(getFontDefForExport(shape.props.font))
 		const theme = getDefaultColorTheme({ isDarkMode: this.editor.user.isDarkMode })
-		const bounds = this.editor.getGeometry(shape).bounds
+		const bounds = this.editor.getShapeGeometry(shape).bounds
 
 		const g = document.createElementNS('http://www.w3.org/2000/svg', 'g')
 

commit f73bf9a7fea4ca6922b8effa10412fbb9f77c288
Author: Taha <98838967+Taha-Hassan-Git@users.noreply.github.com>
Date:   Mon Oct 2 12:30:53 2023 +0100

    Fix text-wrapping on Safari (#1980)
    
    Co-authored-by: Alex Alex@dytry.ch
    
    closes [#1978](https://github.com/tldraw/tldraw/issues/1978)
    
    Text was wrapping on Safari because the measure text div was rendered
    differently on different browsers. Interestingly, when forcing the
    text-measure div to be visible and on-screen in Chrome, the same
    text-wrapping behaviour was apparent. By setting white-space to 'pre'
    when width hasn't been set by the user, we can ensure that only line
    breaks the user has inputted are rendered by default on all browsers.
    
    ### Change Type
    
    - [x] `patch` — Bug fix
    - [ ] `minor` — New feature
    - [ ] `major` — Breaking change
    - [ ] `dependencies` — Changes to package dependencies[^1]
    - [ ] `documentation` — Changes to the documentation only[^2]
    - [ ] `tests` — Changes to any test code only[^2]
    - [ ] `internal` — Any other changes that don't affect the published
    package[^2]
    - [ ] I don't know
    
    [^1]: publishes a `patch` release, for devDependencies use `internal`
    [^2]: will not publish a new version
    
    ### Test Plan
    
    1. On Safari
    2. Make a new text shape and start typing
    3. At a certain point the text starts to wrap without the width having
    been set
    
    
    ### Release Notes
    
    - Fix text wrapping differently on Safari and Chrome/Firefox
    
    Before/After
    
    <image width="350"
    src="https://github.com/tldraw/tldraw/assets/98838967/320171b4-61e0-4a41-b8d3-830bd90bea65">
    <image width="350"
    src="https://github.com/tldraw/tldraw/assets/98838967/b42d7156-0ce9-4894-9692-9338dc931b79">

diff --git a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
index fdac856ad..cc9df1973 100644
--- a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
+++ b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
@@ -194,7 +194,7 @@ function getGrowY(editor: Editor, shape: TLNoteShape, prevGrowY = 0) {
 		...TEXT_PROPS,
 		fontFamily: FONT_FAMILIES[shape.props.font],
 		fontSize: LABEL_FONT_SIZES[shape.props.size],
-		width: NOTE_SIZE - PADDING * 2 + 'px',
+		width: NOTE_SIZE - PADDING * 2,
 	})
 
 	const nextHeight = nextTextSize.h + PADDING * 2

commit 92886e1f40670018589d2c14dced119e47f8e6d1
Author: alex <alex@dytry.ch>
Date:   Tue Oct 3 15:26:13 2023 +0100

    fix text in geo shapes not causing its container to grow (#2003)
    
    We got things sliggghhhtly wrong in #1980. That diff was attempting to
    fix a bug where the text measurement element would refuse to go above
    the viewport size in safari. This was most obvious in the case where
    there was no fixed width on a text shape, and that diff fixed that case,
    but it was also happening when a fixed width text shape was wider than
    viewport - which wasn't covered by that fix. It turned out that that fix
    also introduced a bug where shapes would no longer grow along the y-axis
    - in part because the relationship between `width`, `maxWidth`, and
    `minWidth` is very confusing.
    
    The one-liner fix is to just use `max-content` instead of `fit-content`
    - that way, the div ignores the size of its container. But I also
    cleared up the API for text measurement to remove the `width` property
    entirely in favour of `maxWidth`. I think this makes things much clearer
    and as far as I can tell doesn't affect anything.
    
    Closes #1998
    
    ### Change Type
    
    - [x] `patch` — Bug fix
    
    ### Test Plan
    
    1. Create an arrow & geo shape with labels, plus a note and text shape
    2. Try to break text measurement - overflow the bounds, make very wide
    text, experiment with fixed/auto-size text, etc.

diff --git a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
index cc9df1973..f4c9f3fd2 100644
--- a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
+++ b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
@@ -194,7 +194,7 @@ function getGrowY(editor: Editor, shape: TLNoteShape, prevGrowY = 0) {
 		...TEXT_PROPS,
 		fontFamily: FONT_FAMILIES[shape.props.font],
 		fontSize: LABEL_FONT_SIZES[shape.props.size],
-		width: NOTE_SIZE - PADDING * 2,
+		maxWidth: NOTE_SIZE - PADDING * 2,
 	})
 
 	const nextHeight = nextTextSize.h + PADDING * 2

commit 6f872c796afd6cf538ce81d35c5a40dcccbe7013
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Tue Nov 14 11:57:43 2023 +0000

    No impure getters pt6 (#2218)
    
    follow up to #2189
    
    ### Change Type
    
    - [x] `patch` — Bug fix

diff --git a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
index f4c9f3fd2..da6beadef 100644
--- a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
+++ b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
@@ -94,7 +94,7 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
 					</div>
 				</div>
 				{'url' in shape.props && shape.props.url && (
-					<HyperlinkButton url={shape.props.url} zoomLevel={this.editor.zoomLevel} />
+					<HyperlinkButton url={shape.props.url} zoomLevel={this.editor.getZoomLevel()} />
 				)}
 			</>
 		)

commit d683cc09432197e89bddacf2b706b5eaad40e399
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Tue Nov 14 17:07:35 2023 +0000

    No impure getters pt9 (#2222)
    
    follow up to #2189
    
    ### Change Type
    
    - [x] `patch` — Bug fix

diff --git a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
index da6beadef..aabc8091c 100644
--- a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
+++ b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
@@ -112,7 +112,7 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
 
 	override toSvg(shape: TLNoteShape, ctx: SvgExportContext) {
 		ctx.addExportDef(getFontDefForExport(shape.props.font))
-		const theme = getDefaultColorTheme({ isDarkMode: this.editor.user.isDarkMode })
+		const theme = getDefaultColorTheme({ isDarkMode: this.editor.user.getIsDarkMode() })
 		const bounds = this.editor.getShapeGeometry(shape).bounds
 
 		const g = document.createElementNS('http://www.w3.org/2000/svg', 'g')

commit d31fecd3d5863010fdc65f8f0b114bb72e41aa03
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Wed Jan 31 14:04:24 2024 +0000

    [Fix] Note shape border radius (#2696)
    
    This PR fixes a border radius on the note shape.
    
    Before
    <img width="382" alt="image"
    src="https://github.com/tldraw/tldraw/assets/23072548/5cb95dbd-c935-4f1f-901c-eca294836c96">
    
    After
    <img width="436" alt="image"
    src="https://github.com/tldraw/tldraw/assets/23072548/0cce7ccf-2f7b-40dd-a27c-08c251cb4715">
    
    
    ### Change Type
    
    - [x] `patch` — Bug fix
    
    ### Release Notes
    
    - Fixes a bad border radius

diff --git a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
index aabc8091c..f178dffc5 100644
--- a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
+++ b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
@@ -103,7 +103,7 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
 	indicator(shape: TLNoteShape) {
 		return (
 			<rect
-				rx="7"
+				rx="6"
 				width={toDomPrecision(NOTE_SIZE)}
 				height={toDomPrecision(this.getHeight(shape))}
 			/>

commit 212eb88480bd66b5b2930768e1594f814b8da150
Author: Lu Wilson <l2wilson94@gmail.com>
Date:   Fri Feb 16 13:54:48 2024 +0000

    Add component for viewing an image of a snapshot  (#2804)
    
    This PR adds the `TldrawImage` component that displays a tldraw snapshot
    as an SVG image.
    
    ![2024-02-15 at 12 29 52 - Coral
    Cod](https://github.com/tldraw/tldraw/assets/15892272/14140e9e-7d6d-4dd3-88a3-86a6786325c5)
    
    ## Why
    
    We've seen requests for this kind of thing from users. eg: GitBook, and
    on discord:
    
    <img width="710" alt="image"
    src="https://github.com/tldraw/tldraw/assets/15892272/3d3a3e9d-66b9-42e7-81de-a70aa7165bdc">
    
    The component provides a way to do that.
    This PR also untangles various bits of editor state from image
    exporting, which makes it easier for library users to export images more
    agnostically. (ie: they can now export any shapes on any page in any
    theme. previously, they had to change the user's state to do that).
    
    ## What else
    
    - This PR also adds an **Image snapshot** example to demonstrate the new
    component.
    - We now pass an `isDarkMode` property to the `toSvg` method (inside the
    `ctx` argument). This means that `toSvg` doesn't have to rely on editor
    state anymore. I updated all our `toSvg` methods to use it.
    - See code comments for more info.
    
    ## Any issues?
    
    When you toggle to editing mode in the new example, text measurements
    are initially wrong (until you edit the size of a text shape). Click on
    the text shape to see how its indicator is wrong. Not sure why this is,
    or if it's even related. Does it ring a bell with anyone? If not, I'll
    take a closer look. (fixed, see comments --steve)
    
    ## Future work
    
    Now that we've untangled image exporting from editor state, we could
    expose some more helpful helpers for making this easier.
    
    Fixes tld-2122
    
    ### Change Type
    
    - [x] `minor` — New feature
    
    [^1]: publishes a `patch` release, for devDependencies use `internal`
    [^2]: will not publish a new version
    
    ### Test Plan
    
    1. Open the **Image snapshot** example.
    2. Try editing the image, saving the image, and making sure the image
    updates.
    
    - [ ] Unit Tests
    - [ ] End to end tests
    
    ### Release Notes
    
    - Dev: Added the `TldrawImage` component.
    
    ---------
    
    Co-authored-by: Steve Ruiz <steveruizok@gmail.com>

diff --git a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
index f178dffc5..d4446a94b 100644
--- a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
+++ b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
@@ -112,7 +112,7 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
 
 	override toSvg(shape: TLNoteShape, ctx: SvgExportContext) {
 		ctx.addExportDef(getFontDefForExport(shape.props.font))
-		const theme = getDefaultColorTheme({ isDarkMode: this.editor.user.getIsDarkMode() })
+		const theme = getDefaultColorTheme({ isDarkMode: ctx.isDarkMode })
 		const bounds = this.editor.getShapeGeometry(shape).bounds
 
 		const g = document.createElementNS('http://www.w3.org/2000/svg', 'g')

commit 05f58f7c2a16ba3860471f8188beba930567c818
Author: alex <alex@dytry.ch>
Date:   Mon Mar 25 14:16:55 2024 +0000

    React-powered SVG exports (#3117)
    
    ## Migration path
    1. If any of your shapes implement `toSvg` for exports, you'll need to
    replace your implementation with a new version that returns JSX (it's a
    react component) instead of manually constructing SVG DOM nodes
    2. `editor.getSvg` is deprecated. It still works, but will be going away
    in a future release. If you still need SVGs as DOM elements rather than
    strings, use `new DOMParser().parseFromString(svgString,
    'image/svg+xml').firstElementChild`
    
    ## The change in detail
    At the moment, our SVG exports very carefully try to recreate the
    visuals of our shapes by manually constructing SVG DOM nodes. On its own
    this is really painful, but it also results in a lot of duplicated logic
    between the `component` and `getSvg` methods of shape utils.
    
    In #3020, we looked at using string concatenation & DOMParser to make
    this a bit less painful. This works, but requires specifying namespaces
    everywhere, is still pretty painful (no syntax highlighting or
    formatting), and still results in all that duplicated logic.
    
    I briefly experimented with creating my own version of the javascript
    language that let you embed XML like syntax directly. I was going to
    call it EXTREME JAVASCRIPT or XJS for short, but then I noticed that we
    already wrote the whole of tldraw in this thing called react and a (imo
    much worse named) version of the javascript xml thing already existed.
    
    Given the entire library already depends on react, what would it look
    like if we just used react directly for these exports? Turns out things
    get a lot simpler! Take a look at lmk what you think
    
    This diff was intended as a proof of concept, but is actually pretty
    close to being landable. The main thing is that here, I've deliberately
    leant into this being a big breaking change to see just how much code we
    could delete (turns out: lots). We could if we wanted to make this
    without making it a breaking change at all, but it would add back a lot
    of complexity on our side and run a fair bit slower
    
    ---------
    
    Co-authored-by: huppy-bot[bot] <128400622+huppy-bot[bot]@users.noreply.github.com>

diff --git a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
index d4446a94b..131a2f7d3 100644
--- a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
+++ b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
@@ -1,5 +1,4 @@
 import {
-	DefaultFontFamilies,
 	Editor,
 	Rectangle2d,
 	ShapeUtil,
@@ -13,10 +12,10 @@ import {
 } from '@tldraw/editor'
 import { HyperlinkButton } from '../shared/HyperlinkButton'
 import { useDefaultColorTheme } from '../shared/ShapeFill'
+import { SvgTextLabel } from '../shared/SvgTextLabel'
 import { TextLabel } from '../shared/TextLabel'
 import { FONT_FAMILIES, LABEL_FONT_SIZES, TEXT_PROPS } from '../shared/default-shape-constants'
 import { getFontDefForExport } from '../shared/defaultStyleDefs'
-import { getTextLabelSvgElement } from '../shared/getTextLabelSvgElement'
 
 const NOTE_SIZE = 200
 
@@ -112,42 +111,34 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
 
 	override toSvg(shape: TLNoteShape, ctx: SvgExportContext) {
 		ctx.addExportDef(getFontDefForExport(shape.props.font))
+		if (shape.props.text) ctx.addExportDef(getFontDefForExport(shape.props.font))
 		const theme = getDefaultColorTheme({ isDarkMode: ctx.isDarkMode })
 		const bounds = this.editor.getShapeGeometry(shape).bounds
-
-		const g = document.createElementNS('http://www.w3.org/2000/svg', 'g')
-
 		const adjustedColor = shape.props.color === 'black' ? 'yellow' : shape.props.color
 
-		const rect1 = document.createElementNS('http://www.w3.org/2000/svg', 'rect')
-		rect1.setAttribute('rx', '10')
-		rect1.setAttribute('width', NOTE_SIZE.toString())
-		rect1.setAttribute('height', bounds.height.toString())
-		rect1.setAttribute('fill', theme[adjustedColor].solid)
-		rect1.setAttribute('stroke', theme[adjustedColor].solid)
-		rect1.setAttribute('stroke-width', '1')
-		g.appendChild(rect1)
-
-		const rect2 = document.createElementNS('http://www.w3.org/2000/svg', 'rect')
-		rect2.setAttribute('rx', '10')
-		rect2.setAttribute('width', NOTE_SIZE.toString())
-		rect2.setAttribute('height', bounds.height.toString())
-		rect2.setAttribute('fill', theme.background)
-		rect2.setAttribute('opacity', '.28')
-		g.appendChild(rect2)
-
-		const textElm = getTextLabelSvgElement({
-			editor: this.editor,
-			shape,
-			font: DefaultFontFamilies[shape.props.font],
-			bounds,
-		})
-
-		textElm.setAttribute('fill', theme.text)
-		textElm.setAttribute('stroke', 'none')
-		g.appendChild(textElm)
-
-		return g
+		return (
+			<>
+				<rect
+					rx={10}
+					width={NOTE_SIZE}
+					height={bounds.h}
+					fill={theme[adjustedColor].solid}
+					stroke={theme[adjustedColor].solid}
+					strokeWidth={1}
+				/>
+				<rect rx={10} width={NOTE_SIZE} height={bounds.h} fill={theme.background} opacity={0.28} />
+				<SvgTextLabel
+					fontSize={LABEL_FONT_SIZES[shape.props.size]}
+					font={shape.props.font}
+					align={shape.props.align}
+					verticalAlign={shape.props.verticalAlign}
+					text={shape.props.text}
+					labelColor="black"
+					bounds={bounds}
+					stroke={false}
+				/>
+			</>
+		)
 	}
 
 	override onBeforeCreate = (next: TLNoteShape) => {

commit d76d53db95146c24d35caeca41c2f6d348dbcc06
Author: Mime Čuvalo <mimecuvalo@gmail.com>
Date:   Wed Mar 27 09:33:48 2024 +0000

    textfields [1 of 3]: add text into speech bubble; also add rich text example (#3050)
    
    This is the first of three textfield changes. This starts with making
    the speech bubble actually have text. Also, it creates a TipTap example
    and how that would be wired up.
    
    🎵 this is dangerous, I walk through textfields so watch your head rock 🎵
    
    ### Change Type
    
    - [x] `minor` — New feature
    
    ### Release Notes
    
    - Refactor textfields be composable/swappable.

diff --git a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
index 131a2f7d3..76dca8ec6 100644
--- a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
+++ b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
@@ -83,7 +83,8 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
 							id={id}
 							type={type}
 							font={font}
-							size={size}
+							fontSize={LABEL_FONT_SIZES[size]}
+							lineHeight={TEXT_PROPS.lineHeight}
 							align={align}
 							verticalAlign={verticalAlign}
 							text={text}

commit 41601ac61ec7d4fad715bd67a9df077ee1576a7b
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Sun Apr 14 19:40:02 2024 +0100

    Stickies: release candidate (#3249)
    
    This PR is the target for the stickies PRs that are moving forward. It
    should collect changes.
    
    - [x] New icon
    - [x] Improved shadows
    - [x] Shadow LOD
    - [x] New colors / theme options
    - [x] Shrink text size to avoid word breaks on the x axis
    - [x] Hide indicator whilst typing (reverted)
    - [x] Adjacent note positions
      - [x] buttons / clone handles
      - [x] position helpers for creating / translating (pits)
    - [x] keyboard shortcuts: (Tab, Shift+tab (RTL aware), Cmd-Enter,
    Shift+Cmd+enter)
      - [x] multiple shape translating
    - [x] Text editing
      - [x] Edit on type (feature flagged)
      - [x] click goes in correct place
    - [x] Notes as parents (reverted)
    - [x] Update colors
    - [x] Update SVG appearance
    
    ### Change Type
    
    - [x] `sdk` — Changes the tldraw SDK
    - [x] `feature` — New feature
    
    ### Test Plan
    
    Todo: fold in test plans for child PRs
    
    ### Unit tests:
    
    - [ ] Shrink text size to avoid word breaks on the x axis
    - [x] Adjacent notes
      - [x] buttons (clone handles)
      - [x] position helpers (pits)
    - [x] keyboard shortcuts: (Tab, Shift+tab (RTL aware), Cmd-Enter,
    Shift+Cmd+enter)
    - [ ] Text editing
      - [ ] Edit on type
      - [ ] click goes in correct place
    
    ### Release Notes
    
    - Improves sticky notes (see list)
    
    ---------
    
    Signed-off-by: dependabot[bot] <support@github.com>
    Co-authored-by: Mime Čuvalo <mimecuvalo@gmail.com>
    Co-authored-by: alex <alex@dytry.ch>
    Co-authored-by: Mitja Bezenšek <mitja.bezensek@gmail.com>
    Co-authored-by: dependabot[bot] <49699333+dependabot[bot]@users.noreply.github.com>
    Co-authored-by: github-actions[bot] <github-actions[bot]@users.noreply.github.com>
    Co-authored-by: Lu[ke] Wilson <l2wilson94@gmail.com>
    Co-authored-by: huppy-bot[bot] <128400622+huppy-bot[bot]@users.noreply.github.com>

diff --git a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
index 76dca8ec6..b6824633f 100644
--- a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
+++ b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
@@ -1,23 +1,49 @@
 import {
 	Editor,
+	Group2d,
+	IndexKey,
 	Rectangle2d,
 	ShapeUtil,
 	SvgExportContext,
+	TLHandle,
 	TLNoteShape,
 	TLOnEditEndHandler,
+	TLShape,
+	TLShapeId,
+	Vec,
+	WeakMapCache,
 	getDefaultColorTheme,
 	noteShapeMigrations,
 	noteShapeProps,
+	rng,
 	toDomPrecision,
+	useEditor,
+	useValue,
 } from '@tldraw/editor'
+import { useCallback } from 'react'
+import { useCurrentTranslation } from '../../ui/hooks/useTranslation/useTranslation'
+import { isRightToLeftLanguage } from '../../utils/text/text'
 import { HyperlinkButton } from '../shared/HyperlinkButton'
 import { useDefaultColorTheme } from '../shared/ShapeFill'
 import { SvgTextLabel } from '../shared/SvgTextLabel'
 import { TextLabel } from '../shared/TextLabel'
-import { FONT_FAMILIES, LABEL_FONT_SIZES, TEXT_PROPS } from '../shared/default-shape-constants'
+import {
+	FONT_FAMILIES,
+	LABEL_FONT_SIZES,
+	LABEL_PADDING,
+	TEXT_PROPS,
+} from '../shared/default-shape-constants'
 import { getFontDefForExport } from '../shared/defaultStyleDefs'
 
-const NOTE_SIZE = 200
+import { startEditingShapeWithLabel } from '../../tools/SelectTool/selectHelpers'
+import { useForceSolid } from '../shared/useForceSolid'
+import {
+	ADJACENT_NOTE_MARGIN,
+	CLONE_HANDLE_MARGIN,
+	NOTE_CENTER_OFFSET,
+	NOTE_SIZE,
+	getNoteShapeForAdjacentPosition,
+} from './noteHelpers'
 
 /** @public */
 export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
@@ -27,7 +53,7 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
 
 	override canEdit = () => true
 	override hideResizeHandles = () => true
-	override hideSelectionBoundsFg = () => true
+	override hideSelectionBoundsFg = () => false
 
 	getDefaultProps(): TLNoteShape['props'] {
 		return {
@@ -38,60 +64,135 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
 			align: 'middle',
 			verticalAlign: 'middle',
 			growY: 0,
+			fontSizeAdjustment: 0,
 			url: '',
 		}
 	}
 
-	getHeight(shape: TLNoteShape) {
-		return NOTE_SIZE + shape.props.growY
+	getGeometry(shape: TLNoteShape) {
+		const noteHeight = getNoteHeight(shape)
+		const { labelHeight, labelWidth } = getLabelSize(this.editor, shape)
+
+		return new Group2d({
+			children: [
+				new Rectangle2d({ width: NOTE_SIZE, height: noteHeight, isFilled: true }),
+				new Rectangle2d({
+					x:
+						shape.props.align === 'start'
+							? 0
+							: shape.props.align === 'end'
+								? NOTE_SIZE - labelWidth
+								: (NOTE_SIZE - labelWidth) / 2,
+					y:
+						shape.props.verticalAlign === 'start'
+							? 0
+							: shape.props.verticalAlign === 'end'
+								? noteHeight - labelHeight
+								: (noteHeight - labelHeight) / 2,
+					width: labelWidth,
+					height: labelHeight,
+					isFilled: true,
+					isLabel: true,
+				}),
+			],
+		})
 	}
 
-	getGeometry(shape: TLNoteShape) {
-		const height = this.getHeight(shape)
-		return new Rectangle2d({ width: NOTE_SIZE, height, isFilled: true })
+	override getHandles(shape: TLNoteShape): TLHandle[] {
+		const zoom = this.editor.getZoomLevel()
+		const offset = CLONE_HANDLE_MARGIN / zoom
+		const noteHeight = getNoteHeight(shape)
+
+		if (zoom < 0.25) return []
+
+		return [
+			{
+				id: 'top',
+				index: 'a1' as IndexKey,
+				type: 'clone',
+				x: NOTE_SIZE / 2,
+				y: -offset,
+			},
+			{
+				id: 'right',
+				index: 'a2' as IndexKey,
+				type: 'clone',
+				x: NOTE_SIZE + offset,
+				y: noteHeight / 2,
+			},
+			{
+				id: 'bottom',
+				index: 'a3' as IndexKey,
+				type: 'clone',
+				x: NOTE_SIZE / 2,
+				y: noteHeight + offset,
+			},
+			{
+				id: 'left',
+				index: 'a4' as IndexKey,
+				type: 'clone',
+				x: -offset,
+				y: noteHeight / 2,
+			},
+		]
 	}
 
 	component(shape: TLNoteShape) {
 		const {
 			id,
 			type,
-			props: { color, font, size, align, text, verticalAlign },
+			props: { color, font, size, align, text, verticalAlign, fontSizeAdjustment },
 		} = shape
 
+		// eslint-disable-next-line react-hooks/rules-of-hooks
+		const handleKeyDown = useNoteKeydownHandler(id)
+
 		// eslint-disable-next-line react-hooks/rules-of-hooks
 		const theme = useDefaultColorTheme()
-		const adjustedColor = color === 'black' ? 'yellow' : color
+		const noteHeight = getNoteHeight(shape)
+
+		// eslint-disable-next-line react-hooks/rules-of-hooks
+		const rotation = useValue(
+			'shape rotation',
+			() => this.editor.getShapePageTransform(id)?.rotation() ?? 0,
+			[this.editor]
+		)
+
+		// todo: consider hiding shadows on dark mode if they're invisible anyway
+		// eslint-disable-next-line react-hooks/rules-of-hooks
+		const hideShadows = useForceSolid()
+
+		const isSelected = shape.id === this.editor.getOnlySelectedShapeId()
 
 		return (
 			<>
 				<div
+					id={id}
+					className="tl-note__container"
 					style={{
-						position: 'absolute',
 						width: NOTE_SIZE,
-						height: this.getHeight(shape),
+						height: noteHeight,
+						backgroundColor: theme[color].note.fill,
+						borderBottom: hideShadows ? `3px solid rgb(15, 23, 31, .2)` : `none`,
+						boxShadow: hideShadows ? 'none' : getNoteShadow(shape.id, rotation),
 					}}
 				>
-					<div
-						className="tl-note__container"
-						style={{
-							color: theme[adjustedColor].solid,
-							backgroundColor: theme[adjustedColor].solid,
-						}}
-					>
-						<div className="tl-note__scrim" />
-						<TextLabel
-							id={id}
-							type={type}
-							font={font}
-							fontSize={LABEL_FONT_SIZES[size]}
-							lineHeight={TEXT_PROPS.lineHeight}
-							align={align}
-							verticalAlign={verticalAlign}
-							text={text}
-							labelColor="black"
-							wrap
-						/>
-					</div>
+					<TextLabel
+						id={id}
+						type={type}
+						font={font}
+						fontSize={fontSizeAdjustment || LABEL_FONT_SIZES[size]}
+						lineHeight={TEXT_PROPS.lineHeight}
+						align={align}
+						verticalAlign={verticalAlign}
+						text={text}
+						isNote
+						isSelected={isSelected}
+						labelColor={theme[color].note.text}
+						disableTab
+						wrap
+						onKeyDown={handleKeyDown}
+					/>
 				</div>
 				{'url' in shape.props && shape.props.url && (
 					<HyperlinkButton url={shape.props.url} zoomLevel={this.editor.getZoomLevel()} />
@@ -103,9 +204,9 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
 	indicator(shape: TLNoteShape) {
 		return (
 			<rect
-				rx="6"
+				rx="1"
 				width={toDomPrecision(NOTE_SIZE)}
-				height={toDomPrecision(this.getHeight(shape))}
+				height={toDomPrecision(getNoteHeight(shape))}
 			/>
 		)
 	}
@@ -115,26 +216,22 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
 		if (shape.props.text) ctx.addExportDef(getFontDefForExport(shape.props.font))
 		const theme = getDefaultColorTheme({ isDarkMode: ctx.isDarkMode })
 		const bounds = this.editor.getShapeGeometry(shape).bounds
-		const adjustedColor = shape.props.color === 'black' ? 'yellow' : shape.props.color
-
 		return (
 			<>
+				<rect x={5} y={5} rx={1} width={NOTE_SIZE - 10} height={bounds.h} fill="rgba(0,0,0,.1)" />
 				<rect
-					rx={10}
+					rx={1}
 					width={NOTE_SIZE}
 					height={bounds.h}
-					fill={theme[adjustedColor].solid}
-					stroke={theme[adjustedColor].solid}
-					strokeWidth={1}
+					fill={theme[shape.props.color].note.fill}
 				/>
-				<rect rx={10} width={NOTE_SIZE} height={bounds.h} fill={theme.background} opacity={0.28} />
 				<SvgTextLabel
-					fontSize={LABEL_FONT_SIZES[shape.props.size]}
+					fontSize={shape.props.fontSizeAdjustment || LABEL_FONT_SIZES[shape.props.size]}
 					font={shape.props.font}
 					align={shape.props.align}
 					verticalAlign={shape.props.verticalAlign}
 					text={shape.props.text}
-					labelColor="black"
+					labelColor={theme[shape.props.color].note.text}
 					bounds={bounds}
 					stroke={false}
 				/>
@@ -143,7 +240,7 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
 	}
 
 	override onBeforeCreate = (next: TLNoteShape) => {
-		return getGrowY(this.editor, next, next.props.growY)
+		return getNoteSizeAdjustments(this.editor, next)
 	}
 
 	override onBeforeUpdate = (prev: TLNoteShape, next: TLNoteShape) => {
@@ -155,7 +252,7 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
 			return
 		}
 
-		return getGrowY(this.editor, next, prev.props.growY)
+		return getNoteSizeAdjustments(this.editor, next)
 	}
 
 	override onEditEnd: TLOnEditEndHandler<TLNoteShape> = (shape) => {
@@ -179,35 +276,148 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
 	}
 }
 
-function getGrowY(editor: Editor, shape: TLNoteShape, prevGrowY = 0) {
-	const PADDING = 17
-
-	const nextTextSize = editor.textMeasure.measureText(shape.props.text, {
-		...TEXT_PROPS,
-		fontFamily: FONT_FAMILIES[shape.props.font],
-		fontSize: LABEL_FONT_SIZES[shape.props.size],
-		maxWidth: NOTE_SIZE - PADDING * 2,
-	})
-
-	const nextHeight = nextTextSize.h + PADDING * 2
+/**
+ * Get the growY and fontSizeAdjustment for a shape.
+ */
+function getNoteSizeAdjustments(editor: Editor, shape: TLNoteShape) {
+	const { labelHeight, fontSizeAdjustment } = getLabelSize(editor, shape)
+	// When the label height is more than the height of the shape, we add extra height to it
+	const growY = Math.max(0, labelHeight - NOTE_SIZE)
 
-	let growY: number | null = null
-
-	if (nextHeight > NOTE_SIZE) {
-		growY = nextHeight - NOTE_SIZE
-	} else {
-		if (prevGrowY) {
-			growY = 0
-		}
-	}
-
-	if (growY !== null) {
+	if (growY !== shape.props.growY || fontSizeAdjustment !== shape.props.fontSizeAdjustment) {
 		return {
 			...shape,
 			props: {
 				...shape.props,
 				growY,
+				fontSizeAdjustment,
 			},
 		}
 	}
 }
+
+/**
+ * Get the label size for a note.
+ */
+function getNoteLabelSize(editor: Editor, shape: TLNoteShape) {
+	const text = shape.props.text
+
+	if (!text) {
+		const minHeight = LABEL_FONT_SIZES[shape.props.size] * TEXT_PROPS.lineHeight + LABEL_PADDING * 2
+		return { labelHeight: minHeight, labelWidth: 100, fontSizeAdjustment: 0 }
+	}
+
+	const unadjustedFontSize = LABEL_FONT_SIZES[shape.props.size]
+
+	let fontSizeAdjustment = 0
+	let iterations = 0
+	let labelHeight = NOTE_SIZE
+	let labelWidth = NOTE_SIZE
+
+	// We slightly make the font smaller if the text is too big for the note, width-wise.
+	do {
+		fontSizeAdjustment = Math.min(unadjustedFontSize, unadjustedFontSize - iterations)
+		const nextTextSize = editor.textMeasure.measureText(text, {
+			...TEXT_PROPS,
+			fontFamily: FONT_FAMILIES[shape.props.font],
+			fontSize: fontSizeAdjustment,
+			maxWidth: NOTE_SIZE - LABEL_PADDING * 2,
+			disableOverflowWrapBreaking: true,
+		})
+
+		labelHeight = nextTextSize.h + LABEL_PADDING * 2
+		labelWidth = nextTextSize.w + LABEL_PADDING * 2
+
+		if (fontSizeAdjustment <= 14) {
+			// Too small, just rely now on CSS `overflow-wrap: break-word`
+			// We need to recalculate the text measurement here with break-word enabled.
+			const nextTextSizeWithOverflowBreak = editor.textMeasure.measureText(text, {
+				...TEXT_PROPS,
+				fontFamily: FONT_FAMILIES[shape.props.font],
+				fontSize: fontSizeAdjustment,
+				maxWidth: NOTE_SIZE - LABEL_PADDING * 2,
+			})
+			labelHeight = nextTextSizeWithOverflowBreak.h + LABEL_PADDING * 2
+			labelWidth = nextTextSizeWithOverflowBreak.w + LABEL_PADDING * 2
+			break
+		}
+
+		if (nextTextSize.scrollWidth.toFixed(0) === nextTextSize.w.toFixed(0)) {
+			break
+		}
+	} while (iterations++ < 50)
+
+	return {
+		labelHeight,
+		labelWidth,
+		fontSizeAdjustment,
+	}
+}
+
+const labelSizesForNote = new WeakMapCache<TLShape, ReturnType<typeof getNoteLabelSize>>()
+
+function getLabelSize(editor: Editor, shape: TLNoteShape) {
+	return labelSizesForNote.get(shape, () => getNoteLabelSize(editor, shape))
+}
+
+function useNoteKeydownHandler(id: TLShapeId) {
+	const editor = useEditor()
+	const translation = useCurrentTranslation()
+
+	return useCallback(
+		(e: React.KeyboardEvent<HTMLTextAreaElement>) => {
+			const shape = editor.getShape<TLNoteShape>(id)
+			if (!shape) return
+
+			const isTab = e.key === 'Tab'
+			const isCmdEnter = (e.metaKey || e.ctrlKey) && e.key === 'Enter'
+			if (isTab || isCmdEnter) {
+				e.preventDefault()
+
+				const pageTransform = editor.getShapePageTransform(id)
+				const pageRotation = pageTransform.rotation()
+
+				// Based on the inputs, calculate the offset to the next note
+				// tab controls x axis (shift inverts direction set by RTL)
+				// cmd enter is the y axis (shift inverts direction)
+				const isRTL = !!(translation.dir === 'rtl' || isRightToLeftLanguage(shape.props.text))
+
+				const offsetLength =
+					NOTE_SIZE +
+					ADJACENT_NOTE_MARGIN +
+					// If we're growing down, we need to account for the current shape's growY
+					(isCmdEnter && !e.shiftKey ? shape.props.growY : 0)
+
+				const adjacentCenter = new Vec(
+					isTab ? (e.shiftKey != isRTL ? -1 : 1) : 0,
+					isCmdEnter ? (e.shiftKey ? -1 : 1) : 0
+				)
+					.mul(offsetLength)
+					.add(NOTE_CENTER_OFFSET)
+					.rot(pageRotation)
+					.add(pageTransform.point())
+
+				const newNote = getNoteShapeForAdjacentPosition(editor, shape, adjacentCenter, pageRotation)
+
+				if (newNote) {
+					editor.mark('editing adjacent shape')
+					startEditingShapeWithLabel(editor, newNote, true /* selectAll */)
+				}
+			}
+		},
+		[id, editor, translation.dir]
+	)
+}
+
+function getNoteHeight(shape: TLNoteShape) {
+	return NOTE_SIZE + shape.props.growY
+}
+
+function getNoteShadow(id: string, rotation: number) {
+	const random = rng(id) // seeded based on id
+	const lift = Math.abs(random()) + 0.5 // 0 to 1.5
+	const oy = Math.cos(rotation)
+	return `0px ${5 - lift}px 5px -5px rgba(15, 23, 31, .6),
+	0px ${(4 + lift * 7) * Math.max(0, oy)}px ${6 + lift * 7}px -${4 + lift * 6}px rgba(15, 23, 31, ${(0.3 + lift * 0.1).toFixed(2)}), 
+	0px 48px 10px -10px inset rgba(15, 23, 44, ${((0.022 + random() * 0.005) * ((1 + oy) / 2)).toFixed(2)})`
+}

commit 98598fa7d6b1be83fc94bad3bb39ac54904a569c
Author: Mime Čuvalo <mimecuvalo@gmail.com>
Date:   Tue Apr 16 11:56:54 2024 +0100

    stickies: hide clone handles on mobile (#3478)
    
    ### Change Type
    
    <!-- ❗ Please select a 'Scope' label ❗️ -->
    
    - [x] `sdk` — Changes the tldraw SDK
    - [ ] `dotcom` — Changes the tldraw.com web app
    - [ ] `docs` — Changes to the documentation, examples, or templates.
    - [ ] `vs code` — Changes to the vscode plugin
    - [ ] `internal` — Does not affect user-facing stuff
    
    <!-- ❗ Please select a 'Type' label ❗️ -->
    
    - [x] `bugfix` — Bug fix
    - [ ] `feature` — New feature
    - [ ] `improvement` — Improving existing features
    - [ ] `chore` — Updating dependencies, other boring stuff
    - [ ] `galaxy brain` — Architectural changes
    - [ ] `tests` — Changes to any test code
    - [ ] `tools` — Changes to infrastructure, CI, internal scripts,
    debugging tools, etc.
    - [ ] `dunno` — I don't know

diff --git a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
index b6824633f..f9df09cfd 100644
--- a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
+++ b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
@@ -102,8 +102,9 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
 		const zoom = this.editor.getZoomLevel()
 		const offset = CLONE_HANDLE_MARGIN / zoom
 		const noteHeight = getNoteHeight(shape)
+		const isCoarsePointer = this.editor.getInstanceState().isCoarsePointer
 
-		if (zoom < 0.25) return []
+		if (zoom < 0.25 || isCoarsePointer) return []
 
 		return [
 			{

commit 1f09a6e26286ea04d7e27b2704da4b4ba8dd521c
Author: Mime Čuvalo <mimecuvalo@gmail.com>
Date:   Tue Apr 16 15:37:20 2024 +0100

    stickies: a bit of fuzziness when calculating certain text (#3493)
    
    Fixes
    https://linear.app/tldraw/issue/TLD-2402/long-words-in-stickies-sometimes-wrap-before-the-font-size-shrinks
    
    
    https://github.com/tldraw/tldraw/assets/15892272/0b6f6d3c-d21d-430b-97d0-7c9b5abefa0b
    
    ### Change Type
    
    <!-- ❗ Please select a 'Scope' label ❗️ -->
    
    - [x] `sdk` — Changes the tldraw SDK
    - [ ] `dotcom` — Changes the tldraw.com web app
    - [ ] `docs` — Changes to the documentation, examples, or templates.
    - [ ] `vs code` — Changes to the vscode plugin
    - [ ] `internal` — Does not affect user-facing stuff
    
    <!-- ❗ Please select a 'Type' label ❗️ -->
    
    - [x] `bugfix` — Bug fix
    - [ ] `feature` — New feature
    - [ ] `improvement` — Improving existing features
    - [ ] `chore` — Updating dependencies, other boring stuff
    - [ ] `galaxy brain` — Architectural changes
    - [ ] `tests` — Changes to any test code
    - [ ] `tools` — Changes to infrastructure, CI, internal scripts,
    debugging tools, etc.
    - [ ] `dunno` — I don't know

diff --git a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
index f9df09cfd..4a0e1144f 100644
--- a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
+++ b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
@@ -315,6 +315,12 @@ function getNoteLabelSize(editor: Editor, shape: TLNoteShape) {
 	let labelHeight = NOTE_SIZE
 	let labelWidth = NOTE_SIZE
 
+	// N.B. For some note shapes with text like 'hjhjhjhjhjhjhjhj', you'll run into
+	// some text measurement fuzziness where the browser swears there's no overflow (scrollWidth === width)
+	// but really there is when you enable overflow-wrap again. This helps account for that little bit
+	// of give.
+	const FUZZ = 1
+
 	// We slightly make the font smaller if the text is too big for the note, width-wise.
 	do {
 		fontSizeAdjustment = Math.min(unadjustedFontSize, unadjustedFontSize - iterations)
@@ -322,7 +328,7 @@ function getNoteLabelSize(editor: Editor, shape: TLNoteShape) {
 			...TEXT_PROPS,
 			fontFamily: FONT_FAMILIES[shape.props.font],
 			fontSize: fontSizeAdjustment,
-			maxWidth: NOTE_SIZE - LABEL_PADDING * 2,
+			maxWidth: NOTE_SIZE - LABEL_PADDING * 2 - FUZZ,
 			disableOverflowWrapBreaking: true,
 		})
 
@@ -336,7 +342,7 @@ function getNoteLabelSize(editor: Editor, shape: TLNoteShape) {
 				...TEXT_PROPS,
 				fontFamily: FONT_FAMILIES[shape.props.font],
 				fontSize: fontSizeAdjustment,
-				maxWidth: NOTE_SIZE - LABEL_PADDING * 2,
+				maxWidth: NOTE_SIZE - LABEL_PADDING * 2 - FUZZ,
 			})
 			labelHeight = nextTextSizeWithOverflowBreak.h + LABEL_PADDING * 2
 			labelWidth = nextTextSizeWithOverflowBreak.w + LABEL_PADDING * 2

commit 34ad856873d1749698b75fd1b45ba7906fd92f40
Author: Mime Čuvalo <mimecuvalo@gmail.com>
Date:   Wed Apr 17 12:11:08 2024 +0100

    textfields: nix disableTab option; make TextShapes have custom Tab behavior as intended (#3506)
    
    We shouldn't be making this something you have to negate everytime you
    use `useEditableText`. The TextShape can just have its custom behavior
    since that's the intended usecase. (although I think that Tab there
    doesn't do much anyway, but whatevs)
    
    ### Change Type
    
    <!-- ❗ Please select a 'Scope' label ❗️ -->
    
    - [x] `sdk` — Changes the tldraw SDK
    - [ ] `dotcom` — Changes the tldraw.com web app
    - [ ] `docs` — Changes to the documentation, examples, or templates.
    - [ ] `vs code` — Changes to the vscode plugin
    - [ ] `internal` — Does not affect user-facing stuff
    
    <!-- ❗ Please select a 'Type' label ❗️ -->
    
    - [ ] `bugfix` — Bug fix
    - [ ] `feature` — New feature
    - [ ] `improvement` — Improving existing features
    - [x] `chore` — Updating dependencies, other boring stuff
    - [ ] `galaxy brain` — Architectural changes
    - [ ] `tests` — Changes to any test code
    - [ ] `tools` — Changes to infrastructure, CI, internal scripts,
    debugging tools, etc.
    - [ ] `dunno` — I don't know

diff --git a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
index 4a0e1144f..89ae4a330 100644
--- a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
+++ b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
@@ -190,7 +190,6 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
 						isNote
 						isSelected={isSelected}
 						labelColor={theme[color].note.text}
-						disableTab
 						wrap
 						onKeyDown={handleKeyDown}
 					/>

commit e82b0a6c8f3f8f119209f3cc76da1ad0788f06b8
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Tue Apr 23 11:23:01 2024 +0100

    Make note handles show only one when zoomed out (#3562)
    
    This PR will only show the bottom handle on a sticky note when zoomed
    out.
    
    ### Change Type
    
    - [x] `sdk` — Changes the tldraw SDK
    - [x] `improvement` — Improving existing features
    
    ### Test Plan
    
    1. Zoom out to 45%.
    2. The bottom handle should be visible.
    3. The bottom handle should work as expected.
    
    ### Release Notes
    
    - Show only the bottom handle on notes when zoomed between .25 and .5

diff --git a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
index 89ae4a330..5c8ed5825 100644
--- a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
+++ b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
@@ -106,6 +106,18 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
 
 		if (zoom < 0.25 || isCoarsePointer) return []
 
+		if (zoom < 0.5) {
+			return [
+				{
+					id: 'bottom',
+					index: 'a3' as IndexKey,
+					type: 'clone',
+					x: NOTE_SIZE / 2,
+					y: noteHeight + offset,
+				},
+			]
+		}
+
 		return [
 			{
 				id: 'top',

commit a77154967045e395ba2a270e49b5454e73305b6b
Author: Mime Čuvalo <mimecuvalo@gmail.com>
Date:   Sat Apr 27 12:12:35 2024 +0100

    stickies: make pit/pack distance the same (#3606)
    
    Tweak default gap value to be consistent with sticky note gaps.
    Fixes https://github.com/tldraw/tldraw/issues/3591
    
    ### Change Type
    
    <!-- ❗ Please select a 'Scope' label ❗️ -->
    
    - [x] `sdk` — Changes the tldraw SDK
    - [ ] `dotcom` — Changes the tldraw.com web app
    - [ ] `docs` — Changes to the documentation, examples, or templates.
    - [ ] `vs code` — Changes to the vscode plugin
    - [ ] `internal` — Does not affect user-facing stuff
    
    <!-- ❗ Please select a 'Type' label ❗️ -->
    
    - [x] `bugfix` — Bug fix
    - [ ] `feature` — New feature
    - [ ] `improvement` — Improving existing features
    - [ ] `chore` — Updating dependencies, other boring stuff
    - [ ] `galaxy brain` — Architectural changes
    - [ ] `tests` — Changes to any test code
    - [ ] `tools` — Changes to infrastructure, CI, internal scripts,
    debugging tools, etc.
    - [ ] `dunno` — I don't know
    
    
    ### Release Notes
    
    - Shapes: tweak default gap value to be consistent with sticky note
    gaps.

diff --git a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
index 5c8ed5825..109caf08e 100644
--- a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
+++ b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
@@ -36,9 +36,9 @@ import {
 import { getFontDefForExport } from '../shared/defaultStyleDefs'
 
 import { startEditingShapeWithLabel } from '../../tools/SelectTool/selectHelpers'
+import { ADJACENT_SHAPE_MARGIN } from '../../ui/constants'
 import { useForceSolid } from '../shared/useForceSolid'
 import {
-	ADJACENT_NOTE_MARGIN,
 	CLONE_HANDLE_MARGIN,
 	NOTE_CENTER_OFFSET,
 	NOTE_SIZE,
@@ -402,7 +402,7 @@ function useNoteKeydownHandler(id: TLShapeId) {
 
 				const offsetLength =
 					NOTE_SIZE +
-					ADJACENT_NOTE_MARGIN +
+					ADJACENT_SHAPE_MARGIN +
 					// If we're growing down, we need to account for the current shape's growY
 					(isCmdEnter && !e.shiftKey ? shape.props.growY : 0)
 

commit 91903c97614f3645dcbdcf6986fd5e4ca3dd95dc
Author: alex <alex@dytry.ch>
Date:   Thu May 9 10:48:01 2024 +0100

    Move arrow helpers from editor to tldraw (#3721)
    
    With the new work on bindings, we no longer need to keep any arrows
    stuff hard-coded in `editor`, so let's move it to `tldraw` with the rest
    of the shapes.
    
    Couple other changes as part of this:
    - We had two different types of `WeakMap` backed cache, but we now only
    have one
    - There's a new free-standing version of `createComputedCache` that
    doesn't need access to the editor/store in order to create the cache.
    instead, it returns a `{get(editor, id)}` object and instantiates the
    cache on a per-editor basis for each call.
    - Fixed a bug in `createSelectedComputedCache` where the selector
    derivation would get re-created on every call to `get`
    
    ### Change Type
    
    - [x] `sdk` — Changes the tldraw SDK
    - [x] `improvement` — Improving existing features
    
    ### Release Notes
    
    #### Breaking changes
    - `editor.getArrowInfo(shape)` has been replaced with
    `getArrowInfo(editor, shape)`
    - `editor.getArrowsBoundTo(shape)` has been removed. Instead, use
    `editor.getBindingsToShape(shape, 'arrow')` and follow the `fromId` of
    each binding to the corresponding arrow shape
    - These types have moved from `@tldraw/editor` to `tldraw`:
        - `TLArcInfo`
        - `TLArrowInfo`
        - `TLArrowPoint`
    - `WeakMapCache` has been removed

diff --git a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
index 109caf08e..670d4965f 100644
--- a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
+++ b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
@@ -11,7 +11,7 @@ import {
 	TLShape,
 	TLShapeId,
 	Vec,
-	WeakMapCache,
+	WeakCache,
 	getDefaultColorTheme,
 	noteShapeMigrations,
 	noteShapeProps,
@@ -372,7 +372,7 @@ function getNoteLabelSize(editor: Editor, shape: TLNoteShape) {
 	}
 }
 
-const labelSizesForNote = new WeakMapCache<TLShape, ReturnType<typeof getNoteLabelSize>>()
+const labelSizesForNote = new WeakCache<TLShape, ReturnType<typeof getNoteLabelSize>>()
 
 function getLabelSize(editor: Editor, shape: TLNoteShape) {
 	return labelSizesForNote.get(shape, () => getNoteLabelSize(editor, shape))

commit a457a390819bc15add2b52c77f0908498a8613a6
Author: alex <alex@dytry.ch>
Date:   Tue May 28 15:22:03 2024 +0100

    Move constants to options prop (#3799)
    
    Another go at #3628 & #3783. This moves (most) constants into
    `editor.options`, configurable by the `options` prop on the tldraw
    component.
    
    ### Change Type
    
    - [x] `sdk` — Changes the tldraw SDK
    - [x] `feature` — New feature
    
    ### Release Notes
    
    You can now override many options which were previously hard-coded
    constants. Pass an `options` prop into the tldraw component to change
    the maximum number of pages, grid steps, or other previously hard-coded
    values. See `TldrawOptions` for more

diff --git a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
index 670d4965f..ed6ee03ef 100644
--- a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
+++ b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
@@ -36,7 +36,6 @@ import {
 import { getFontDefForExport } from '../shared/defaultStyleDefs'
 
 import { startEditingShapeWithLabel } from '../../tools/SelectTool/selectHelpers'
-import { ADJACENT_SHAPE_MARGIN } from '../../ui/constants'
 import { useForceSolid } from '../shared/useForceSolid'
 import {
 	CLONE_HANDLE_MARGIN,
@@ -402,7 +401,7 @@ function useNoteKeydownHandler(id: TLShapeId) {
 
 				const offsetLength =
 					NOTE_SIZE +
-					ADJACENT_SHAPE_MARGIN +
+					editor.options.adjacentShapeMargin +
 					// If we're growing down, we need to account for the current shape's growY
 					(isCmdEnter && !e.shiftKey ? shape.props.growY : 0)
 

commit ac149c1014fb5f0539d7c55f0f10ce2a05a23f74
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Sun Jun 16 19:58:13 2024 +0300

    Dynamic size mode + fill fill (#3835)
    
    This PR adds a user preference for "dynamic size mode" where the scale
    of shapes (text size, stroke width) is relative to the current zoom
    level. This means that the stroke width in screen pixels (or text size
    in screen pixels) is identical regardless of zoom level.
    
    ![Kapture 2024-05-27 at 05 23
    21](https://github.com/tldraw/tldraw/assets/23072548/f247ecce-bfcd-4f85-b7a5-d7677b38e4d8)
    
    - [x] Draw shape
    - [x] Text shape
    - [x] Highlighter shape
    - [x] Geo shape
    - [x] Arrow shape
    - [x] Note shape
    - [x] Line shape
    
    Embed shape?
    
    ### Change Type
    
    - [x] `sdk` — Changes the tldraw SDK
    - [x] `feature` — New feature
    
    ### Test Plan
    
    1. Use the tools.
    2. Change zoom
    
    - [ ] Unit Tests
    
    ### Release Notes
    
    - Adds a dynamic size user preferences.
    - Removes double click to reset scale on text shapes.
    - Removes double click to reset autosize on text shapes.
    
    ---------
    
    Co-authored-by: Taha <98838967+Taha-Hassan-Git@users.noreply.github.com>
    Co-authored-by: huppy-bot[bot] <128400622+huppy-bot[bot]@users.noreply.github.com>

diff --git a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
index ed6ee03ef..5de6d3bae 100644
--- a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
+++ b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
@@ -1,4 +1,6 @@
+/* eslint-disable react-hooks/rules-of-hooks */
 import {
+	Box,
 	Editor,
 	Group2d,
 	IndexKey,
@@ -24,7 +26,6 @@ import { useCallback } from 'react'
 import { useCurrentTranslation } from '../../ui/hooks/useTranslation/useTranslation'
 import { isRightToLeftLanguage } from '../../utils/text/text'
 import { HyperlinkButton } from '../shared/HyperlinkButton'
-import { useDefaultColorTheme } from '../shared/ShapeFill'
 import { SvgTextLabel } from '../shared/SvgTextLabel'
 import { TextLabel } from '../shared/TextLabel'
 import {
@@ -35,8 +36,8 @@ import {
 } from '../shared/default-shape-constants'
 import { getFontDefForExport } from '../shared/defaultStyleDefs'
 
+import { useDefaultColorTheme } from '../../..'
 import { startEditingShapeWithLabel } from '../../tools/SelectTool/selectHelpers'
-import { useForceSolid } from '../shared/useForceSolid'
 import {
 	CLONE_HANDLE_MARGIN,
 	NOTE_CENTER_OFFSET,
@@ -65,31 +66,37 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
 			growY: 0,
 			fontSizeAdjustment: 0,
 			url: '',
+			scale: 1,
 		}
 	}
 
 	getGeometry(shape: TLNoteShape) {
-		const noteHeight = getNoteHeight(shape)
 		const { labelHeight, labelWidth } = getLabelSize(this.editor, shape)
+		const { scale } = shape.props
+
+		const lh = labelHeight * scale
+		const lw = labelWidth * scale
+		const nw = NOTE_SIZE * scale
+		const nh = getNoteHeight(shape)
 
 		return new Group2d({
 			children: [
-				new Rectangle2d({ width: NOTE_SIZE, height: noteHeight, isFilled: true }),
+				new Rectangle2d({ width: nw, height: nh, isFilled: true }),
 				new Rectangle2d({
 					x:
 						shape.props.align === 'start'
 							? 0
 							: shape.props.align === 'end'
-								? NOTE_SIZE - labelWidth
-								: (NOTE_SIZE - labelWidth) / 2,
+								? nw - lw
+								: (nw - lw) / 2,
 					y:
 						shape.props.verticalAlign === 'start'
 							? 0
 							: shape.props.verticalAlign === 'end'
-								? noteHeight - labelHeight
-								: (noteHeight - labelHeight) / 2,
-					width: labelWidth,
-					height: labelHeight,
+								? nh - lh
+								: (nh - lh) / 2,
+					width: lw,
+					height: lh,
 					isFilled: true,
 					isLabel: true,
 				}),
@@ -98,21 +105,25 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
 	}
 
 	override getHandles(shape: TLNoteShape): TLHandle[] {
-		const zoom = this.editor.getZoomLevel()
-		const offset = CLONE_HANDLE_MARGIN / zoom
-		const noteHeight = getNoteHeight(shape)
+		const { scale } = shape.props
 		const isCoarsePointer = this.editor.getInstanceState().isCoarsePointer
+		if (isCoarsePointer) return []
+
+		const zoom = this.editor.getZoomLevel()
+		if (zoom * scale < 0.25) return []
 
-		if (zoom < 0.25 || isCoarsePointer) return []
+		const nh = getNoteHeight(shape)
+		const nw = NOTE_SIZE * scale
+		const offset = (CLONE_HANDLE_MARGIN / zoom) * scale
 
-		if (zoom < 0.5) {
+		if (zoom * scale < 0.5) {
 			return [
 				{
 					id: 'bottom',
 					index: 'a3' as IndexKey,
 					type: 'clone',
-					x: NOTE_SIZE / 2,
-					y: noteHeight + offset,
+					x: nw / 2,
+					y: nh + offset,
 				},
 			]
 		}
@@ -122,29 +133,29 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
 				id: 'top',
 				index: 'a1' as IndexKey,
 				type: 'clone',
-				x: NOTE_SIZE / 2,
+				x: nw / 2,
 				y: -offset,
 			},
 			{
 				id: 'right',
 				index: 'a2' as IndexKey,
 				type: 'clone',
-				x: NOTE_SIZE + offset,
-				y: noteHeight / 2,
+				x: nw + offset,
+				y: nh / 2,
 			},
 			{
 				id: 'bottom',
 				index: 'a3' as IndexKey,
 				type: 'clone',
-				x: NOTE_SIZE / 2,
-				y: noteHeight + offset,
+				x: nw / 2,
+				y: nh + offset,
 			},
 			{
 				id: 'left',
 				index: 'a4' as IndexKey,
 				type: 'clone',
 				x: -offset,
-				y: noteHeight / 2,
+				y: nh / 2,
 			},
 		]
 	}
@@ -153,17 +164,15 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
 		const {
 			id,
 			type,
-			props: { color, font, size, align, text, verticalAlign, fontSizeAdjustment },
+			props: { scale, color, font, size, align, text, verticalAlign, fontSizeAdjustment },
 		} = shape
 
-		// eslint-disable-next-line react-hooks/rules-of-hooks
 		const handleKeyDown = useNoteKeydownHandler(id)
 
-		// eslint-disable-next-line react-hooks/rules-of-hooks
 		const theme = useDefaultColorTheme()
-		const noteHeight = getNoteHeight(shape)
+		const nw = NOTE_SIZE * scale
+		const nh = getNoteHeight(shape)
 
-		// eslint-disable-next-line react-hooks/rules-of-hooks
 		const rotation = useValue(
 			'shape rotation',
 			() => this.editor.getShapePageTransform(id)?.rotation() ?? 0,
@@ -171,8 +180,11 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
 		)
 
 		// todo: consider hiding shadows on dark mode if they're invisible anyway
-		// eslint-disable-next-line react-hooks/rules-of-hooks
-		const hideShadows = useForceSolid()
+
+		const hideShadows = useValue('zoom', () => this.editor.getZoomLevel() < 0.35 / scale, [
+			scale,
+			this.editor,
+		])
 
 		const isSelected = shape.id === this.editor.getOnlySelectedShapeId()
 
@@ -182,18 +194,18 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
 					id={id}
 					className="tl-note__container"
 					style={{
-						width: NOTE_SIZE,
-						height: noteHeight,
+						width: nw,
+						height: nh,
 						backgroundColor: theme[color].note.fill,
-						borderBottom: hideShadows ? `3px solid rgb(15, 23, 31, .2)` : `none`,
-						boxShadow: hideShadows ? 'none' : getNoteShadow(shape.id, rotation),
+						borderBottom: hideShadows ? `${3 * scale}px solid rgb(15, 23, 31, .2)` : `none`,
+						boxShadow: hideShadows ? 'none' : getNoteShadow(shape.id, rotation, scale),
 					}}
 				>
 					<TextLabel
 						id={id}
 						type={type}
 						font={font}
-						fontSize={fontSizeAdjustment || LABEL_FONT_SIZES[size]}
+						fontSize={(fontSizeAdjustment || LABEL_FONT_SIZES[size]) * scale}
 						lineHeight={TEXT_PROPS.lineHeight}
 						align={align}
 						verticalAlign={verticalAlign}
@@ -202,6 +214,7 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
 						isSelected={isSelected}
 						labelColor={theme[color].note.text}
 						wrap
+						padding={16 * scale}
 						onKeyDown={handleKeyDown}
 					/>
 				</div>
@@ -213,10 +226,11 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
 	}
 
 	indicator(shape: TLNoteShape) {
+		const { scale } = shape.props
 		return (
 			<rect
-				rx="1"
-				width={toDomPrecision(NOTE_SIZE)}
+				rx={scale}
+				width={toDomPrecision(NOTE_SIZE * scale)}
 				height={toDomPrecision(getNoteHeight(shape))}
 			/>
 		)
@@ -226,7 +240,8 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
 		ctx.addExportDef(getFontDefForExport(shape.props.font))
 		if (shape.props.text) ctx.addExportDef(getFontDefForExport(shape.props.font))
 		const theme = getDefaultColorTheme({ isDarkMode: ctx.isDarkMode })
-		const bounds = this.editor.getShapeGeometry(shape).bounds
+		const bounds = getBoundsForSVG(shape)
+
 		return (
 			<>
 				<rect x={5} y={5} rx={1} width={NOTE_SIZE - 10} height={bounds.h} fill="rgba(0,0,0,.1)" />
@@ -311,7 +326,7 @@ function getNoteSizeAdjustments(editor: Editor, shape: TLNoteShape) {
  * Get the label size for a note.
  */
 function getNoteLabelSize(editor: Editor, shape: TLNoteShape) {
-	const text = shape.props.text
+	const { text } = shape.props
 
 	if (!text) {
 		const minHeight = LABEL_FONT_SIZES[shape.props.size] * TEXT_PROPS.lineHeight + LABEL_PADDING * 2
@@ -365,9 +380,9 @@ function getNoteLabelSize(editor: Editor, shape: TLNoteShape) {
 	} while (iterations++ < 50)
 
 	return {
-		labelHeight,
-		labelWidth,
-		fontSizeAdjustment,
+		labelHeight: labelHeight,
+		labelWidth: labelWidth,
+		fontSizeAdjustment: fontSizeAdjustment,
 	}
 }
 
@@ -400,17 +415,18 @@ function useNoteKeydownHandler(id: TLShapeId) {
 				const isRTL = !!(translation.dir === 'rtl' || isRightToLeftLanguage(shape.props.text))
 
 				const offsetLength =
-					NOTE_SIZE +
-					editor.options.adjacentShapeMargin +
-					// If we're growing down, we need to account for the current shape's growY
-					(isCmdEnter && !e.shiftKey ? shape.props.growY : 0)
+					(NOTE_SIZE +
+						editor.options.adjacentShapeMargin +
+						// If we're growing down, we need to account for the current shape's growY
+						(isCmdEnter && !e.shiftKey ? shape.props.growY : 0)) *
+					shape.props.scale
 
 				const adjacentCenter = new Vec(
 					isTab ? (e.shiftKey != isRTL ? -1 : 1) : 0,
 					isCmdEnter ? (e.shiftKey ? -1 : 1) : 0
 				)
 					.mul(offsetLength)
-					.add(NOTE_CENTER_OFFSET)
+					.add(NOTE_CENTER_OFFSET.clone().mul(shape.props.scale))
 					.rot(pageRotation)
 					.add(pageTransform.point())
 
@@ -427,14 +443,23 @@ function useNoteKeydownHandler(id: TLShapeId) {
 }
 
 function getNoteHeight(shape: TLNoteShape) {
-	return NOTE_SIZE + shape.props.growY
+	return (NOTE_SIZE + shape.props.growY) * shape.props.scale
 }
 
-function getNoteShadow(id: string, rotation: number) {
+function getNoteShadow(id: string, rotation: number, scale: number) {
 	const random = rng(id) // seeded based on id
 	const lift = Math.abs(random()) + 0.5 // 0 to 1.5
 	const oy = Math.cos(rotation)
-	return `0px ${5 - lift}px 5px -5px rgba(15, 23, 31, .6),
-	0px ${(4 + lift * 7) * Math.max(0, oy)}px ${6 + lift * 7}px -${4 + lift * 6}px rgba(15, 23, 31, ${(0.3 + lift * 0.1).toFixed(2)}), 
-	0px 48px 10px -10px inset rgba(15, 23, 44, ${((0.022 + random() * 0.005) * ((1 + oy) / 2)).toFixed(2)})`
+	const a = 5 * scale
+	const b = 4 * scale
+	const c = 6 * scale
+	const d = 7 * scale
+	return `0px ${a - lift}px ${a}px -${a}px rgba(15, 23, 31, .6),
+	0px ${(b + lift * d) * Math.max(0, oy)}px ${c + lift * d}px -${b + lift * c}px rgba(15, 23, 31, ${(0.3 + lift * 0.1).toFixed(2)}), 
+	0px ${48 * scale}px ${10 * scale}px -${10 * scale}px inset rgba(15, 23, 44, ${((0.022 + random() * 0.005) * ((1 + oy) / 2)).toFixed(2)})`
+}
+
+function getBoundsForSVG(shape: TLNoteShape) {
+	// When rendering the SVG we don't want to adjust for scale
+	return new Box(0, 0, NOTE_SIZE, NOTE_SIZE + shape.props.growY)
 }

commit c1fe8ec99aa96a7f355c587d7ce97afdc66bab45
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Wed Jul 3 15:10:54 2024 +0100

    put sync stuff in bemo worker (#4060)
    
    this PR puts sync stuff in the bemo worker, and sets up a temporary
    dev-only page in dotcom for testing bemo stuff
    
    
    ### Change type
    
    - [ ] `bugfix`
    - [ ] `improvement`
    - [x] `feature`
    - [ ] `api`
    - [ ] `other`
    
    ### Test plan
    
    1. Create a shape...
    2.
    
    - [ ] Unit tests
    - [ ] End to end tests
    
    ### Release notes
    
    - Fixed a bug with...

diff --git a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
index 5de6d3bae..25a932432 100644
--- a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
+++ b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
@@ -36,8 +36,8 @@ import {
 } from '../shared/default-shape-constants'
 import { getFontDefForExport } from '../shared/defaultStyleDefs'
 
-import { useDefaultColorTheme } from '../../..'
 import { startEditingShapeWithLabel } from '../../tools/SelectTool/selectHelpers'
+import { useDefaultColorTheme } from '../shared/useDefaultColorTheme'
 import {
 	CLONE_HANDLE_MARGIN,
 	NOTE_CENTER_OFFSET,

commit 89d7438ca35ac6f73238fdc603c6548d6a7b8426
Author: Mitja Bezenšek <mitja.bezensek@gmail.com>
Date:   Wed Jul 10 10:58:47 2024 +0200

    Remove duplicate code (#4128)
    
    Looks like some leftovers since we are conditionally doing the same
    thing on the next line. I might be missing something though.
    
    ### Change type
    
    - [ ] `bugfix`
    - [x] `improvement`
    - [ ] `feature`
    - [ ] `api`
    - [ ] `other`
    
    ### Release notes
    
    - Remove some duplicate code which should make some of the exports a bit
    smaller.

diff --git a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
index 25a932432..a4d9df24c 100644
--- a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
+++ b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
@@ -237,7 +237,6 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
 	}
 
 	override toSvg(shape: TLNoteShape, ctx: SvgExportContext) {
-		ctx.addExportDef(getFontDefForExport(shape.props.font))
 		if (shape.props.text) ctx.addExportDef(getFontDefForExport(shape.props.font))
 		const theme = getDefaultColorTheme({ isDarkMode: ctx.isDarkMode })
 		const bounds = getBoundsForSVG(shape)

commit 2458db7a4e0936a3d954e05171a63335652b4691
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Fri Jul 26 14:18:24 2024 +0100

    Deprecate editor.mark, fix cropping tests (#4250)
    
    So it turns out `editor.mark(id)` is a bit problematic unless you always
    pass in unique id, because it's quite easy to create situations where
    you will call `bailToMark(id)` but the mark that you were _intending_ to
    bail to has already been popped off the stack due to another previous
    call to `bailToMark`.
    
    I always suspected this might be the case (the original late 2022
    history api was designed to avoid this, but it got changed at some
    point) and indeed I ran into this bug while investigating a cropping
    undo/redo test error.
    
    To prevent issues for ourselves and our users, let's force people to use
    a randomly generated mark ID.
    
    Also `editor.mark` is a bad name. `mark` could mean a million things,
    even in the context of `editor.history.mark` it's a pretty bad name.
    Let's help people out and make it more descriptive.
    
    This PR deprecates the `editor.mark(id)` in favor of `id =
    editor.markHistoryStoppingPoint(name)`.
    
    I converted a couple of usages of editor.mark over but there's a lot
    left to do so I only want to do it if you don't object @steveruizok
    
    ### Change type
    
    - [ ] `bugfix`
    - [ ] `improvement`
    - [ ] `feature`
    - [x] `api`
    - [ ] `other`
    
    ### Test plan
    
    1. Create a shape...
    2.
    
    - [ ] Unit tests
    - [ ] End to end tests
    
    ### Release notes
    
    This deprecates `Editor.mark()` in favour of
    `Editor.markHistoryStoppingPoint()`.
    
    This was done because calling `editor.mark(id)` is a potential footgun
    unless you always provide a random ID. So
    `editor.markHistoryStoppingPoint()` always returns a random id.

diff --git a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
index a4d9df24c..1210c6034 100644
--- a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
+++ b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
@@ -432,7 +432,7 @@ function useNoteKeydownHandler(id: TLShapeId) {
 				const newNote = getNoteShapeForAdjacentPosition(editor, shape, adjacentCenter, pageRotation)
 
 				if (newNote) {
-					editor.mark('editing adjacent shape')
+					editor.markHistoryStoppingPoint('editing adjacent shape')
 					startEditingShapeWithLabel(editor, newNote, true /* selectAll */)
 				}
 			}

commit f05d102cd44ec3ab3ac84b51bf8669ef3b825481
Author: Mitja Bezenšek <mitja.bezensek@gmail.com>
Date:   Mon Jul 29 15:40:18 2024 +0200

    Move from function properties to methods (#4288)
    
    Things left to do
    - [x] Update docs (things like the [tools
    page](https://tldraw-docs-fqnvru1os-tldraw.vercel.app/docs/tools),
    possibly more)
    - [x] Write a list of breaking changes and how to upgrade.
    - [x] Do another pass and check if we can update any lines that have
    `@typescript-eslint/method-signature-style` and
    `local/prefer-class-methods` disabled
    - [x] Thinks about what to do with `TLEventHandlers`. Edit: Feels like
    keeping them is the best way to go.
    - [x] Remove `override` keyword where it's not needed. Not sure if it's
    worth the effort. Edit: decided not to spend time here.
    - [ ] What about possible detached / destructured uses?
    
    Fixes https://github.com/tldraw/tldraw/issues/2799
    
    ### Change type
    
    - [ ] `bugfix`
    - [ ] `improvement`
    - [ ] `feature`
    - [x] `api`
    - [ ] `other`
    
    ### Test plan
    
    1. Create a shape...
    2.
    
    - [ ] Unit tests
    - [ ] End to end tests
    
    ### Release notes
    
    - Adds eslint rules for enforcing the use of methods instead of function
    properties and fixes / disables all the resulting errors.
    
    # Breaking changes
    
    This change affects the syntax of how the event handlers for shape tools
    and utils are defined.
    
    ## Shape utils
    **Before**
    ```ts
    export class CustomShapeUtil extends ShapeUtil<CustomShape> {
       // Defining flags
       override canEdit = () => true
    
       // Defining event handlers
       override onResize: TLOnResizeHandler<CustomShape> = (shape, info) => {
          ...
       }
    }
    ```
    
    
    **After**
    ```ts
    export class CustomShapeUtil extends ShapeUtil<CustomShape> {
       // Defining flags
       override canEdit() {
          return true
       }
    
       // Defining event handlers
       override onResize(shape: CustomShape, info: TLResizeInfo<CustomShape>) {
          ...
       }
    }
    ```
    
    ## Tools
    
    **Before**
    ```ts
    export class CustomShapeTool extends StateNode {
       // Defining child states
       static override children = (): TLStateNodeConstructor[] => [Idle, Pointing]
    
       // Defining event handlers
       override onKeyDown: TLEventHandlers['onKeyDown'] = (info) => {
          ...
       }
    }
    ```
    
    
    **After**
    ```ts
    export class CustomShapeTool extends StateNode {
       // Defining child states
       static override children(): TLStateNodeConstructor[] {
          return [Idle, Pointing]
       }
    
       // Defining event handlers
       override onKeyDown(info: TLKeyboardEventInfo) {
          ...
       }
    }
    ```
    
    ---------
    
    Co-authored-by: David Sheldrick <d.j.sheldrick@gmail.com>
    Co-authored-by: Steve Ruiz <steveruizok@gmail.com>

diff --git a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
index 1210c6034..5f024d892 100644
--- a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
+++ b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
@@ -9,7 +9,6 @@ import {
 	SvgExportContext,
 	TLHandle,
 	TLNoteShape,
-	TLOnEditEndHandler,
 	TLShape,
 	TLShapeId,
 	Vec,
@@ -51,9 +50,15 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
 	static override props = noteShapeProps
 	static override migrations = noteShapeMigrations
 
-	override canEdit = () => true
-	override hideResizeHandles = () => true
-	override hideSelectionBoundsFg = () => false
+	override canEdit() {
+		return true
+	}
+	override hideResizeHandles() {
+		return true
+	}
+	override hideSelectionBoundsFg() {
+		return false
+	}
 
 	getDefaultProps(): TLNoteShape['props'] {
 		return {
@@ -264,11 +269,11 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
 		)
 	}
 
-	override onBeforeCreate = (next: TLNoteShape) => {
+	override onBeforeCreate(next: TLNoteShape) {
 		return getNoteSizeAdjustments(this.editor, next)
 	}
 
-	override onBeforeUpdate = (prev: TLNoteShape, next: TLNoteShape) => {
+	override onBeforeUpdate(prev: TLNoteShape, next: TLNoteShape) {
 		if (
 			prev.props.text === next.props.text &&
 			prev.props.font === next.props.font &&
@@ -280,7 +285,7 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
 		return getNoteSizeAdjustments(this.editor, next)
 	}
 
-	override onEditEnd: TLOnEditEndHandler<TLNoteShape> = (shape) => {
+	override onEditEnd(shape: TLNoteShape) {
 		const {
 			id,
 			type,

commit e0f36407d9b8297ed77e5507c52b88949cdfc745
Author: Mitja Bezenšek <mitja.bezensek@gmail.com>
Date:   Thu Aug 1 16:47:01 2024 +0200

    [Feature, Example] Text search example and `getText` API (#4306)
    
    Motivated by #3495
    
    An example of how to add custom search via`⌘+f` keyboard shortcuts. This
    also adds `getText` method to `ShapeUtil`, which allows the users to
    query the shapes for text.
    
    Down the line we could choose to add something like `getShapesWithText`
    to the editor and maybe even add some UI to dotcom. For now, let's just
    expose the API.
    
    
    https://github.com/user-attachments/assets/5631301c-a02a-4b66-8dbf-09571e67a46c
    
    ### Change type
    
    - [ ] `bugfix`
    - [ ] `improvement`
    - [x] `feature`
    - [ ] `api`
    - [ ] `other`
    
    ### Release notes
    
    - Adds `getText` to the `ShapeUtil` api so that we can allow searching
    for text in a nicely extensible way.
    - Adds an example of how to add text search.

diff --git a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
index 5f024d892..1e5056f64 100644
--- a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
+++ b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
@@ -165,6 +165,10 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
 		]
 	}
 
+	override getText(shape: TLNoteShape) {
+		return shape.props.text
+	}
+
 	component(shape: TLNoteShape) {
 		const {
 			id,

commit 46fec0b2ee8230c3f943e8f26ffaacf45aa21f17
Author: Taha <98838967+Taha-Hassan-Git@users.noreply.github.com>
Date:   Sat Aug 3 13:06:02 2024 +0100

    Interpolation: draw/highlight points, discrete props (#4241)
    
    Draw shapes and highlighter shape points now animate between states.
    
    ![2024-07-22 at 13 44 45 - Teal
    Sparrow](https://github.com/user-attachments/assets/92de6f2c-7b84-415e-b81b-94264a1341d9)
    
    There is some repetition of logic between the function that animates
    draw points and the one that animates lines. However, I felt that the
    structure of draw shapes and lines is different enough that generalising
    the function would add complexity and sacrifice readability, and didn't
    seem worth it just to remove a small amount of repetition. Very happy to
    change that should anyone disagree.
    
    Image shape crop property animates to the new position
    
    ![2024-07-22 at 15 39 30 - Purple
    Cattle](https://github.com/user-attachments/assets/fb108a48-6ed0-4f49-a232-fa806c78aa97)
    
    
    Discrete props (props that don't have continuous values to animate
    along) now change in the middle of the animation. It's likely that
    continuous animation will be happening at the same time, making the
    change in the middle of that movement helps smooth over the abruptness
    of that change.
    
    This is what it looks like if they change at the start:
    
    ![2024-07-18 at 13 11 32 - Amaranth
    Primate](https://github.com/user-attachments/assets/50570507-0b0a-4f61-a710-a180b7ddb00f)
    
    
    This is what it looks like when the props change halfway:
    
    ![2024-07-18 at 13 12 40 - Teal
    Gerbil](https://github.com/user-attachments/assets/48a28e62-901a-45db-8d30-4a5a18b5960f)
    
    
    The text usually changes at the halfway mark, but if there's no text to
    begin with, then any text in the end shape is streamed in:
    
    ![2024-07-18 at 15 18 34 - Tan
    Catshark](https://github.com/user-attachments/assets/ed59122c-7f52-4f57-94d5-9382ff8d62b1)
    
    Question: Do we want tests for this?
    
    ### Change type
    
    - [ ] `bugfix`
    - [x] `improvement`
    - [ ] `feature`
    - [x] `api`
    - [ ] `other`
    
    ### Test plan
    
    1. Animate a shape between different states
    2. It should change its discrete props at the midway point of the
    animation, and animate smoothly for continuous values such as dimension
    or position.
    
    ### Release notes
    
    - Added getInterpolated props method for all shapes, including draw and
    highlighter.
    
    ---------
    
    Co-authored-by: Steve Ruiz <steveruizok@gmail.com>

diff --git a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
index 1e5056f64..f2b82e5e4 100644
--- a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
+++ b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
@@ -9,11 +9,13 @@ import {
 	SvgExportContext,
 	TLHandle,
 	TLNoteShape,
+	TLNoteShapeProps,
 	TLShape,
 	TLShapeId,
 	Vec,
 	WeakCache,
 	getDefaultColorTheme,
+	lerp,
 	noteShapeMigrations,
 	noteShapeProps,
 	rng,
@@ -36,6 +38,7 @@ import {
 import { getFontDefForExport } from '../shared/defaultStyleDefs'
 
 import { startEditingShapeWithLabel } from '../../tools/SelectTool/selectHelpers'
+
 import { useDefaultColorTheme } from '../shared/useDefaultColorTheme'
 import {
 	CLONE_HANDLE_MARGIN,
@@ -308,6 +311,16 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
 			])
 		}
 	}
+	override getInterpolatedProps(
+		startShape: TLNoteShape,
+		endShape: TLNoteShape,
+		t: number
+	): TLNoteShapeProps {
+		return {
+			...(t > 0.5 ? endShape.props : startShape.props),
+			scale: lerp(startShape.props.scale, endShape.props.scale, t),
+		}
+	}
 }
 
 /**

commit d5f4c1d05bb834ab5623d19d418e31e4ab5afa66
Author: alex <alex@dytry.ch>
Date:   Wed Oct 9 15:55:15 2024 +0100

    make sure DOM IDs are globally unique (#4694)
    
    There are a lot of places where we currently derive a DOM ID from a
    shape ID. This works fine (ish) on tldraw.com, but doesn't work for a
    lot of developer use-cases: if there are multiple tldraw instances or
    exports happening, for example. This is because the DOM expects IDs to
    be globally unique. If there are multiple elements with the same ID in
    the dom, only the first is ever used. This can cause issues if e.g.
    
    1. i have a shape with a clip-path determined by the shape ID
    2. i export that shape and add the resulting SVG to the dom. now, there
    are two clip paths with the same ID, but they're the same
    3. I change the shape - and now, the ID is referring to the export, so i
    get weird rendering issues.
    
    This diff attempts to resolve this issue and prevent it from happening
    again by introducing a new `SafeId` type, and helpers for generating and
    working with `SafeId`s. in tldraw, jsx using the `id` attribute will now
    result in a type error if the value isn't a safe ID. This doesn't affect
    library consumers writing JSX.
    
    As part of this, I've removed the ID that were added to certain shapes.
    Instead, all shapes now have a `data-shape-id` attribute on their
    wrapper.
    
    ### Change type
    
    - [x] `bugfix`
    
    ### Release notes
    
    - Exports and other tldraw instances no longer can affect how each other
    are rendered
    - **BREAKING:** the `id` attribute that was present on some shapes in
    the dom has been removed. there's now a data-shape-id attribute on every
    shape wrapper instead though.

diff --git a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
index f2b82e5e4..16860b401 100644
--- a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
+++ b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
@@ -214,7 +214,7 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
 					}}
 				>
 					<TextLabel
-						id={id}
+						shapeId={id}
 						type={type}
 						font={font}
 						fontSize={(fontSizeAdjustment || LABEL_FONT_SIZES[size]) * scale}

commit 29d7ecaa7c0d2bc67190f20efd5c1ba47305ce14
Author: Mime Čuvalo <mimecuvalo@gmail.com>
Date:   Sat Oct 12 16:12:12 2024 +0100

    lod: memoize media assets so that zoom level doesn't re-render constantly (#4659)
    
    Related to a discussion on Discord:
    https://discord.com/channels/859816885297741824/1290992999186169898/1291681011758792756
    
    This works to memoize the rendering of the core part of the image/video
    react components b/c the `useValue` hook inside `useAsset` is called so
    often. If there's a better way to do this @SomeHats I'm all ears!
    
    ### Change type
    
    - [ ] `bugfix`
    - [x] `improvement`
    - [ ] `feature`
    - [ ] `api`
    - [ ] `other`
    
    ### Release notes
    
    - Improve performance of image/video rendering.
    
    ---------
    
    Co-authored-by: Steve Ruiz <steveruizok@gmail.com>

diff --git a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
index 16860b401..5ba5ad6e0 100644
--- a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
+++ b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
@@ -230,9 +230,7 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
 						onKeyDown={handleKeyDown}
 					/>
 				</div>
-				{'url' in shape.props && shape.props.url && (
-					<HyperlinkButton url={shape.props.url} zoomLevel={this.editor.getZoomLevel()} />
-				)}
+				{'url' in shape.props && shape.props.url && <HyperlinkButton url={shape.props.url} />}
 			</>
 		)
 	}

commit 983e89288471432830137c9c3f6fcfaeabee0789
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Fri Oct 18 13:59:13 2024 +0100

    Add labelColor for notes. (#4724)
    
    This PR adds `labelColor` for note shapes. We don't use it on tldraw.com
    but other shapes support it.
    
    ### Change type
    
    - [ ] `bugfix`
    - [ ] `improvement`
    - [x] `feature`
    - [ ] `api`
    - [ ] `other`
    
    ### Test plan
    
    1. Create a shape...
    2.
    
    - [ ] Unit tests
    - [ ] End to end tests
    
    ### Release notes
    
    - Adds `labelColor` for Note shapes.

diff --git a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
index 5ba5ad6e0..09047ab3d 100644
--- a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
+++ b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
@@ -71,6 +71,7 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
 			font: 'draw',
 			align: 'middle',
 			verticalAlign: 'middle',
+			labelColor: 'black',
 			growY: 0,
 			fontSizeAdjustment: 0,
 			url: '',
@@ -176,7 +177,17 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
 		const {
 			id,
 			type,
-			props: { scale, color, font, size, align, text, verticalAlign, fontSizeAdjustment },
+			props: {
+				labelColor,
+				scale,
+				color,
+				font,
+				size,
+				align,
+				text,
+				verticalAlign,
+				fontSizeAdjustment,
+			},
 		} = shape
 
 		const handleKeyDown = useNoteKeydownHandler(id)
@@ -224,7 +235,7 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
 						text={text}
 						isNote
 						isSelected={isSelected}
-						labelColor={theme[color].note.text}
+						labelColor={labelColor === 'black' ? theme[color].note.text : theme[labelColor].fill}
 						wrap
 						padding={16 * scale}
 						onKeyDown={handleKeyDown}

commit 5f0ddf48971061b0e45f5030f0127cee975fd31f
Author: Mitja Bezenšek <mitja.bezensek@gmail.com>
Date:   Tue Nov 19 11:28:44 2024 +0100

    Improve panning performance when we have many not shapes and when we are zoomed out (#4935)
    
    When zoomed out we switched from using a shadow to using a border with
    opacity. This caused significant perf drop of rendering the note shapes.
    
    Fixes #4923
    
    ###  Before
    
    ![image](https://github.com/user-attachments/assets/e9084b9c-70ad-4206-931b-9d053c7e4a21)
    
    ### After
    ![CleanShot 2024-11-18 at 10 50
    46](https://github.com/user-attachments/assets/e4a34693-98c6-42ca-aa54-752b88a34ab3)
    
    ### Change type
    
    - [ ] `bugfix`
    - [x] `improvement`
    - [ ] `feature`
    - [ ] `api`
    - [ ] `other`
    
    ### Test plan
    
    1. Create many note shapes
    2. Zoom out past 35%
    3. Pan around.
    4. It should be much smoother than on main.
    
    ### Release notes
    
    - Improve performance of rendering note shapes when zoomed out past 35%.
    
    ---------
    
    Co-authored-by: Steve Ruiz <steveruizok@gmail.com>

diff --git a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
index 09047ab3d..7ddf844fe 100644
--- a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
+++ b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
@@ -209,6 +209,8 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
 			this.editor,
 		])
 
+		const isDarkMode = useValue('dark mode', () => this.editor.user.getIsDarkMode(), [this.editor])
+
 		const isSelected = shape.id === this.editor.getOnlySelectedShapeId()
 
 		return (
@@ -220,7 +222,11 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
 						width: nw,
 						height: nh,
 						backgroundColor: theme[color].note.fill,
-						borderBottom: hideShadows ? `${3 * scale}px solid rgb(15, 23, 31, .2)` : `none`,
+						borderBottom: hideShadows
+							? isDarkMode
+								? `${2 * scale}px solid rgb(20, 20, 20)`
+								: `${2 * scale}px solid rgb(144, 144, 144)`
+							: 'none',
 						boxShadow: hideShadows ? 'none' : getNoteShadow(shape.id, rotation, scale),
 					}}
 				>

commit 0370480992065ccc4cc586568e4dc4d69f2d452f
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Tue Jan 28 14:27:15 2025 +0000

    Add editor option to allow sticky note resizing by scale (#5273)
    
    This PR adds an option to resize sticky notes. There are a few ways that
    sticky notes _could_ resize however these are all a bit more complicated
    and would take time to unpick This PR only adds "scale" resizing while
    leaving some doors open for other options in the future.
    
    This PR also:
    - fixes a bug with `getNoteForPit`
    - changes the zIndex of handles to be in front of selection foreground
    
    ### Change type
    
    - [ ] `bugfix`
    - [ ] `improvement`
    - [ ] `feature`
    - [x] `api`
    - [ ] `other`
    
    ### Test plan
    
    1. Visit the "resize note shape" example
    2. Resize a note shape
    
    - [x] Unit tests
    
    ### Release notes
    
    - Added `options.noteShapeResizeMode` editor option to control how note
    shapes resize.

diff --git a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
index 7ddf844fe..4c798b216 100644
--- a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
+++ b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
@@ -10,14 +10,17 @@ import {
 	TLHandle,
 	TLNoteShape,
 	TLNoteShapeProps,
+	TLResizeInfo,
 	TLShape,
 	TLShapeId,
 	Vec,
 	WeakCache,
+	exhaustiveSwitchError,
 	getDefaultColorTheme,
 	lerp,
 	noteShapeMigrations,
 	noteShapeProps,
+	resizeScaled,
 	rng,
 	toDomPrecision,
 	useEditor,
@@ -57,8 +60,24 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
 		return true
 	}
 	override hideResizeHandles() {
-		return true
+		const { noteShapeResizeMode } = this.editor.options
+		switch (noteShapeResizeMode) {
+			case 'none': {
+				return true
+			}
+			case 'scale': {
+				return false
+			}
+			default: {
+				throw exhaustiveSwitchError(noteShapeResizeMode)
+			}
+		}
+	}
+
+	override isAspectRatioLocked() {
+		return this.editor.options.noteShapeResizeMode === 'scale'
 	}
+
 	override hideSelectionBoundsFg() {
 		return false
 	}
@@ -169,6 +188,21 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
 		]
 	}
 
+	override onResize(shape: any, info: TLResizeInfo<any>) {
+		const { noteShapeResizeMode: noteShapeResizeMode } = this.editor.options
+		switch (noteShapeResizeMode) {
+			case 'none': {
+				return undefined
+			}
+			case 'scale': {
+				return resizeScaled(shape, info)
+			}
+			default: {
+				throw exhaustiveSwitchError(noteShapeResizeMode)
+			}
+		}
+	}
+
 	override getText(shape: TLNoteShape) {
 		return shape.props.text
 	}

commit 3f23e0d4c9138d22cc842f1f8df7fec0dec383ca
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Fri Feb 7 19:42:24 2025 +0000

    Shape options (#5349)
    
    This PR moves shape-specific options into shape utils as static objects.
    
    I'd initially added shape options to the `options` prop, however like
    many other options, they aren't really options to the editor.
    
    By comparison, adding static options to shape utils is less discoverable
    but easier to scale and document.
    
    The only negative that I can think of, apart from discoverability, is
    that static changes like this effect all editors. This probably doesn't
    matter: I can't imagine a single app with two editors, one of which
    allows notes to resize and the other which does not.
    
    ```tsx
    import { NoteShapeUtil, Tldraw } from 'tldraw'
    import 'tldraw/tldraw.css'
    
    NoteShapeUtil.options.resizeMode = 'scale'
    
    export default function ResizeNoteExample() {
            return (
                    <>
                            <div className="tldraw__editor">
                                    <Tldraw persistenceKey="resize-note"></Tldraw>
                            </div>
                    </>
            )
    }
    ```
    
    ### Change type
    
    - [ ] `bugfix`
    - [ ] `improvement`
    - [ ] `feature`
    - [x] `api`
    - [ ] `other`
    
    ### Release Notes
    - introduces shape options
    - moves (unreleased) `noteShapeResizeMode` to
    `NoteShapeOptions.resizeMode`
    - moves `maxDrawShapePoints` to `DrawShapeOptions.maxPoints`
    - adds `maxPoints` to `HighlightShapeOptions.maxPoints`
    - 💥 breaking change if someone was using `options.maxDrawShapePoints`.

diff --git a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
index 4c798b216..9d9e1e3b9 100644
--- a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
+++ b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
@@ -50,18 +50,31 @@ import {
 	getNoteShapeForAdjacentPosition,
 } from './noteHelpers'
 
+/** @public */
+export interface NoteShapeOptions {
+	/**
+	 * How should the note shape resize? By default it does not resize (except automatically based on its text content),
+	 * but you can set it to be user-resizable using scale.
+	 */
+	resizeMode: 'none' | 'scale'
+}
+
 /** @public */
 export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
 	static override type = 'note' as const
 	static override props = noteShapeProps
 	static override migrations = noteShapeMigrations
 
+	static options: NoteShapeOptions = {
+		resizeMode: 'none',
+	}
+
 	override canEdit() {
 		return true
 	}
 	override hideResizeHandles() {
-		const { noteShapeResizeMode } = this.editor.options
-		switch (noteShapeResizeMode) {
+		const { resizeMode } = NoteShapeUtil.options
+		switch (resizeMode) {
 			case 'none': {
 				return true
 			}
@@ -69,13 +82,13 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
 				return false
 			}
 			default: {
-				throw exhaustiveSwitchError(noteShapeResizeMode)
+				throw exhaustiveSwitchError(resizeMode)
 			}
 		}
 	}
 
 	override isAspectRatioLocked() {
-		return this.editor.options.noteShapeResizeMode === 'scale'
+		return NoteShapeUtil.options.resizeMode === 'scale'
 	}
 
 	override hideSelectionBoundsFg() {
@@ -189,8 +202,8 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
 	}
 
 	override onResize(shape: any, info: TLResizeInfo<any>) {
-		const { noteShapeResizeMode: noteShapeResizeMode } = this.editor.options
-		switch (noteShapeResizeMode) {
+		const { resizeMode } = NoteShapeUtil.options
+		switch (resizeMode) {
 			case 'none': {
 				return undefined
 			}
@@ -198,7 +211,7 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
 				return resizeScaled(shape, info)
 			}
 			default: {
-				throw exhaustiveSwitchError(noteShapeResizeMode)
+				throw exhaustiveSwitchError(resizeMode)
 			}
 		}
 	}

commit 9ba9ef2308bf7b3d41842f4f945e61e4d5f8c6a7
Author: alex <alex@dytry.ch>
Date:   Mon Feb 10 18:02:12 2025 +0000

    ShapeUtil.configure for shape options (#5399)
    
    This diff tweaks the shape options API added in #5349 so that it's no
    longer global. Instead, shape utils have a `.configure()` method, which
    accepts a partial of their options and returns a new shape util with
    those options applied.
    
    We also tweak the behaviour of passing in custom shape utils to play
    nicer with this: previously, if you passed in a shape util with type
    "arrow", an error would be thrown complaining about duplicate shape
    utils because the default one was already specified. Now, we won't try
    to include the default arrow util because we can see you using a custom
    one. If you pass two utils with the type "arrow", you'll still get an
    error.
    
    ### Change type
    - [x] `api`
    
    ### Release notes
    
    - introduces shape options & `ShapeUtil.configure`, a utility for
    passing options to a shape util
    - moves (unreleased) noteShapeResizeMode to NoteShapeOptions.resizeMode
    - If you pass tldraw a shape util with the same type as a default, it'll
    now replace the default rather than crash
    - **BREAKING** `options.maxDrawShapePoints` should now be specified with
    `DrawShapeUtil.configure({maxPoints})` and
    `HighlightShapeUtil.configure({maxPoints})`

diff --git a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
index 9d9e1e3b9..33696c093 100644
--- a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
+++ b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
@@ -65,7 +65,7 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
 	static override props = noteShapeProps
 	static override migrations = noteShapeMigrations
 
-	static options: NoteShapeOptions = {
+	override options: NoteShapeOptions = {
 		resizeMode: 'none',
 	}
 
@@ -73,7 +73,7 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
 		return true
 	}
 	override hideResizeHandles() {
-		const { resizeMode } = NoteShapeUtil.options
+		const { resizeMode } = this.options
 		switch (resizeMode) {
 			case 'none': {
 				return true
@@ -88,7 +88,7 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
 	}
 
 	override isAspectRatioLocked() {
-		return NoteShapeUtil.options.resizeMode === 'scale'
+		return this.options.resizeMode === 'scale'
 	}
 
 	override hideSelectionBoundsFg() {
@@ -202,7 +202,7 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
 	}
 
 	override onResize(shape: any, info: TLResizeInfo<any>) {
-		const { resizeMode } = NoteShapeUtil.options
+		const { resizeMode } = this.options
 		switch (resizeMode) {
 			case 'none': {
 				return undefined

commit 3bf31007c5a7274f3f7926a84c96c89a4cc2c278
Author: Mime Čuvalo <mimecuvalo@gmail.com>
Date:   Mon Mar 3 14:23:09 2025 +0000

    [feature] add rich text and contextual toolbar (#4895)
    
    We're looking to add rich text to the editor!
    
    We originally started with ProseMirror but it became quickly clear that
    since it's more down-to-the-metal we'd have to rebuild a bunch of
    functionality, effectively managing a rich text editor in addition to a
    2D canvas. Examples of this include behaviors around lists where people
    expect certain behaviors around combination of lists next to each other,
    tabbing, etc.
    On top of those product expectations, we'd need to provide a
    higher-level API that provided better DX around things like
    transactions, switching between lists↔headers, and more.
    
    Given those considerations, a very natural fit was to use TipTap. Much
    like tldraw, they provide a great experience around manipulating a rich
    text editor. And, we want to pass on those product/DX benefits
    downstream to our SDK users.
    
    Some high-level notes:
    - the data is stored as the TipTap stringified JSON, it's lightly
    validated at the moment, but not stringently.
    - there was originally going to be a short-circuit path for plaintext
    but it ended up being error-prone with richtext/plaintext living
    side-by-side. (this meant there were two separate fields)
    - We could still add a way to render faster — I just want to avoid it
    being two separate fields, too many footguns.
    - things like arrow labels are only plain text (debatable though).
    
    Other related efforts:
    - https://github.com/tldraw/tldraw/pull/3051
    - https://github.com/tldraw/tldraw/pull/2825
    
    Todo
    - [ ] figure out whether we should have a migration or not. This is what
    we discussed cc @ds300 and @SomeHats - and whether older clients would
    start messing up newer clients. The data becomes lossy if older clients
    overwrite with plaintext.
    
    <img width="427" alt="Screenshot 2024-12-09 at 14 43 51"
    src="https://github.com/user-attachments/assets/f9dddaee-bfd3-4746-8016-d4247e417e80">
    <img width="378" alt="Screenshot 2024-12-09 at 14 42 59"
    src="https://github.com/user-attachments/assets/95e016d3-ab4d-4d34-afd3-b3ef511d2d77">
    
    Current discussion list:
    - [x] positioning: discuss toolbar position (selection bounds vs cursor
    bounds, toolbar is going in center weirdly sometimes)
    - [x] artificial delay: latest updates make it feel slow/unresponsive?
    e.g. list toggle, changing selection
    - [x] keyboard selection: discuss toolbar logic around "mousing around"
    vs. being present when keyboard selecting (which is annoying)
    - [x] mobile: discuss concerns around mobile toolbar
    - [x] mobile, precision tap: discuss / rm tap into text (and sticky
    notes?) - disable precision editing on mobile
    - [x] discuss
    useContextualToolbar/useContextualToolbarPosition/ContextualToolbar/TldrawUiContextualToolbar
    example
    - [x] existing code: middle alignment for pasted text - keep?
    - [x] existing code: should text replace the shape content when pasted?
    keep?
    - [x] discuss animation, we had it, nixed it, it's back again; why the
    0.08s animation? imperceptible?
    - [x] hide during camera move?
    - [x] short form content - hard to make a different selection b/c
    toolbar is in the way of content
    - [x] check 'overflow: hidden' on tl-text-input (update: this is needed
    to avoid scrollbars)
    - [x] decide on toolbar set: italic, underline, strikethrough, highlight
    - [x] labelColor w/ highlighted text - steve has a commit here to tweak
    highlighting
    
    todos:
    - [x] font rebuild (bold, randomization tweaks) - david looking into
    this
    
    check bugs raised:
    - [x] can't do selection on list item
    - [x] mobile: b/c of the blur/Done logic, doesn't work if you dbl-click
    on geo shape (it's a plaintext problem too)
    - [x] mobile: No cursor when using the text tool - specifically for the
    Text tool — can't repro?
    - [x] VSCode html pasting, whitespace issue?
    - [x] Link toolbar make it extend to the widest size of the current tool
    set
    - [x] code has mutual exclusivity (this is a design choice by the Code
    plugin - we could fork)
    - [x] Text is copied to the clipboard with paragraphs rather than line
    breaks.
    - [x] multi-line plaintext for arrows busted
    
    nixed/outdated
    - [ ] ~link: on mobile should be in modal?~
    - [ ] ~link: back button?~
    - [ ] ~list button toggling? (can't repro)~
    - [ ] ~double/triple-clicking is now wonky with the new logic~
    - [ ] ~move blur() code into useEditableRichText - for Done on iOS~
    - [ ] ~toolbar when shape is rotated~
    - [ ] ~"The "isMousingDown" logic doesn't work, the events aren't
    reaching the window. Not sure how we get those from the editor element."
    (can't repro?)~
    - [ ] ~toolbar position bug when toggling code on and off (can't
    repro?)~
    - [ ] ~some issue around "Something's up with the initial size
    calculated from the text selection bounds."~
    - [ ] ~mobile: Context bar still visible out if user presses "Done" to
    end editing~
    - [ ] ~mobile: toolbar when switching between text fields~
    
    
    ### Change type
    
    - [ ] `bugfix`
    - [ ] `improvement`
    - [x] `feature`
    - [ ] `api`
    - [ ] `other`
    
    ### Test plan
    
    1. TODO: write a bunch more tests
    
    - [x] Unit tests
    - [x] End to end tests
    
    ### Release notes
    
    - Rich text using ProseMirror as a first-class supported option in the
    Editor.
    
    ---------
    
    Co-authored-by: huppy-bot[bot] <128400622+huppy-bot[bot]@users.noreply.github.com>
    Co-authored-by: alex <alex@dytry.ch>
    Co-authored-by: David Sheldrick <d.j.sheldrick@gmail.com>
    Co-authored-by: Steve Ruiz <steveruizok@gmail.com>

diff --git a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
index 33696c093..617885d95 100644
--- a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
+++ b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
@@ -7,6 +7,7 @@ import {
 	Rectangle2d,
 	ShapeUtil,
 	SvgExportContext,
+	TLFontFace,
 	TLHandle,
 	TLNoteShape,
 	TLNoteShapeProps,
@@ -17,12 +18,14 @@ import {
 	WeakCache,
 	exhaustiveSwitchError,
 	getDefaultColorTheme,
+	getFontsFromRichText,
 	lerp,
 	noteShapeMigrations,
 	noteShapeProps,
 	resizeScaled,
 	rng,
 	toDomPrecision,
+	toRichText,
 	useEditor,
 	useValue,
 } from '@tldraw/editor'
@@ -30,18 +33,21 @@ import { useCallback } from 'react'
 import { useCurrentTranslation } from '../../ui/hooks/useTranslation/useTranslation'
 import { isRightToLeftLanguage } from '../../utils/text/text'
 import { HyperlinkButton } from '../shared/HyperlinkButton'
-import { SvgTextLabel } from '../shared/SvgTextLabel'
-import { TextLabel } from '../shared/TextLabel'
+import { RichTextLabel, RichTextSVG } from '../shared/RichTextLabel'
 import {
 	FONT_FAMILIES,
 	LABEL_FONT_SIZES,
 	LABEL_PADDING,
 	TEXT_PROPS,
 } from '../shared/default-shape-constants'
-import { getFontDefForExport } from '../shared/defaultStyleDefs'
 
 import { startEditingShapeWithLabel } from '../../tools/SelectTool/selectHelpers'
 
+import isEqual from 'lodash.isequal'
+import {
+	renderHtmlFromRichTextForMeasurement,
+	renderPlaintextFromRichText,
+} from '../../utils/text/richText'
 import { useDefaultColorTheme } from '../shared/useDefaultColorTheme'
 import {
 	CLONE_HANDLE_MARGIN,
@@ -98,8 +104,8 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
 	getDefaultProps(): TLNoteShape['props'] {
 		return {
 			color: 'black',
+			richText: toRichText(''),
 			size: 'm',
-			text: '',
 			font: 'draw',
 			align: 'middle',
 			verticalAlign: 'middle',
@@ -217,7 +223,15 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
 	}
 
 	override getText(shape: TLNoteShape) {
-		return shape.props.text
+		return renderPlaintextFromRichText(this.editor, shape.props.richText)
+	}
+
+	override getFontFaces(shape: TLNoteShape): TLFontFace[] {
+		return getFontsFromRichText(this.editor, shape.props.richText, {
+			family: `tldraw_${shape.props.font}`,
+			weight: 'normal',
+			style: 'normal',
+		})
 	}
 
 	component(shape: TLNoteShape) {
@@ -231,7 +245,7 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
 				font,
 				size,
 				align,
-				text,
+				richText,
 				verticalAlign,
 				fontSizeAdjustment,
 			},
@@ -277,7 +291,7 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
 						boxShadow: hideShadows ? 'none' : getNoteShadow(shape.id, rotation, scale),
 					}}
 				>
-					<TextLabel
+					<RichTextLabel
 						shapeId={id}
 						type={type}
 						font={font}
@@ -285,12 +299,11 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
 						lineHeight={TEXT_PROPS.lineHeight}
 						align={align}
 						verticalAlign={verticalAlign}
-						text={text}
-						isNote
+						richText={richText}
 						isSelected={isSelected}
 						labelColor={labelColor === 'black' ? theme[color].note.text : theme[labelColor].fill}
 						wrap
-						padding={16 * scale}
+						padding={LABEL_PADDING * scale}
 						onKeyDown={handleKeyDown}
 					/>
 				</div>
@@ -311,10 +324,22 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
 	}
 
 	override toSvg(shape: TLNoteShape, ctx: SvgExportContext) {
-		if (shape.props.text) ctx.addExportDef(getFontDefForExport(shape.props.font))
 		const theme = getDefaultColorTheme({ isDarkMode: ctx.isDarkMode })
 		const bounds = getBoundsForSVG(shape)
 
+		const textLabel = (
+			<RichTextSVG
+				fontSize={shape.props.fontSizeAdjustment || LABEL_FONT_SIZES[shape.props.size]}
+				font={shape.props.font}
+				align={shape.props.align}
+				verticalAlign={shape.props.verticalAlign}
+				richText={shape.props.richText}
+				labelColor={theme[shape.props.color].note.text}
+				bounds={bounds}
+				padding={LABEL_PADDING * shape.props.scale}
+			/>
+		)
+
 		return (
 			<>
 				<rect x={5} y={5} rx={1} width={NOTE_SIZE - 10} height={bounds.h} fill="rgba(0,0,0,.1)" />
@@ -324,16 +349,7 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
 					height={bounds.h}
 					fill={theme[shape.props.color].note.fill}
 				/>
-				<SvgTextLabel
-					fontSize={shape.props.fontSizeAdjustment || LABEL_FONT_SIZES[shape.props.size]}
-					font={shape.props.font}
-					align={shape.props.align}
-					verticalAlign={shape.props.verticalAlign}
-					text={shape.props.text}
-					labelColor={theme[shape.props.color].note.text}
-					bounds={bounds}
-					stroke={false}
-				/>
+				{textLabel}
 			</>
 		)
 	}
@@ -344,7 +360,7 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
 
 	override onBeforeUpdate(prev: TLNoteShape, next: TLNoteShape) {
 		if (
-			prev.props.text === next.props.text &&
+			isEqual(prev.props.richText, next.props.richText) &&
 			prev.props.font === next.props.font &&
 			prev.props.size === next.props.size
 		) {
@@ -354,25 +370,6 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
 		return getNoteSizeAdjustments(this.editor, next)
 	}
 
-	override onEditEnd(shape: TLNoteShape) {
-		const {
-			id,
-			type,
-			props: { text },
-		} = shape
-
-		if (text.trimEnd() !== shape.props.text) {
-			this.editor.updateShapes([
-				{
-					id,
-					type,
-					props: {
-						text: text.trimEnd(),
-					},
-				},
-			])
-		}
-	}
 	override getInterpolatedProps(
 		startShape: TLNoteShape,
 		endShape: TLNoteShape,
@@ -409,9 +406,9 @@ function getNoteSizeAdjustments(editor: Editor, shape: TLNoteShape) {
  * Get the label size for a note.
  */
 function getNoteLabelSize(editor: Editor, shape: TLNoteShape) {
-	const { text } = shape.props
+	const { richText } = shape.props
 
-	if (!text) {
+	if (!renderPlaintextFromRichText(editor, richText)) {
 		const minHeight = LABEL_FONT_SIZES[shape.props.size] * TEXT_PROPS.lineHeight + LABEL_PADDING * 2
 		return { labelHeight: minHeight, labelWidth: 100, fontSizeAdjustment: 0 }
 	}
@@ -432,7 +429,8 @@ function getNoteLabelSize(editor: Editor, shape: TLNoteShape) {
 	// We slightly make the font smaller if the text is too big for the note, width-wise.
 	do {
 		fontSizeAdjustment = Math.min(unadjustedFontSize, unadjustedFontSize - iterations)
-		const nextTextSize = editor.textMeasure.measureText(text, {
+		const html = renderHtmlFromRichTextForMeasurement(editor, richText)
+		const nextTextSize = editor.textMeasure.measureHtml(html, {
 			...TEXT_PROPS,
 			fontFamily: FONT_FAMILIES[shape.props.font],
 			fontSize: fontSizeAdjustment,
@@ -446,7 +444,8 @@ function getNoteLabelSize(editor: Editor, shape: TLNoteShape) {
 		if (fontSizeAdjustment <= 14) {
 			// Too small, just rely now on CSS `overflow-wrap: break-word`
 			// We need to recalculate the text measurement here with break-word enabled.
-			const nextTextSizeWithOverflowBreak = editor.textMeasure.measureText(text, {
+			const html = renderHtmlFromRichTextForMeasurement(editor, richText)
+			const nextTextSizeWithOverflowBreak = editor.textMeasure.measureHtml(html, {
 				...TEXT_PROPS,
 				fontFamily: FONT_FAMILIES[shape.props.font],
 				fontSize: fontSizeAdjustment,
@@ -480,7 +479,7 @@ function useNoteKeydownHandler(id: TLShapeId) {
 	const translation = useCurrentTranslation()
 
 	return useCallback(
-		(e: React.KeyboardEvent<HTMLTextAreaElement>) => {
+		(e: KeyboardEvent) => {
 			const shape = editor.getShape<TLNoteShape>(id)
 			if (!shape) return
 
@@ -495,7 +494,10 @@ function useNoteKeydownHandler(id: TLShapeId) {
 				// Based on the inputs, calculate the offset to the next note
 				// tab controls x axis (shift inverts direction set by RTL)
 				// cmd enter is the y axis (shift inverts direction)
-				const isRTL = !!(translation.dir === 'rtl' || isRightToLeftLanguage(shape.props.text))
+				const isRTL = !!(
+					translation.dir === 'rtl' ||
+					isRightToLeftLanguage(renderPlaintextFromRichText(editor, shape.props.richText))
+				)
 
 				const offsetLength =
 					(NOTE_SIZE +

commit f0072703bfd4beb7af22ec1eb2058a7473d8fdde
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Wed Mar 19 12:57:24 2025 +0000

    [Fix] Rich text perf issue (#5658)
    
    This PR improves the performance of the app with regard to text.
    
    
    https://github.com/user-attachments/assets/3c468587-0cc1-4e72-8979-61fe14f6a0dc
    
    The `renderPlaintextFromRichText` method is slow. It depends on TipTap's
    `getText` method. This parses the rich text and flattens it to plain
    text. As usual, we can improve performance by:
    
    1. making `renderPlaintextFromRichText` faster
    2. not calling `renderPlaintextFromRichText`
    
    ## Making it faster
    
    We can make it faster by using a weak cache so that we don't need to
    re-flatten text if we've flattened it before. We can also make it faster
    by skipping the flatten if the text content is empty. This can be done
    very quickly without using `getText`.
    
    ## Avoiding it entirely
    
    It turns out that most of the places where we call
    `renderPlaintextFromRichText` are checks against empty text, meaning we
    don't need to call `renderPlaintextFromRichText` at all. In these cases
    we _just_ check whether the text is empty and continue based on that
    result.
    
    ### Change type
    
    - [ ] `bugfix`
    - [x] `improvement`
    - [ ] `feature`
    - [ ] `api`
    - [ ] `other`
    
    ### Release notes
    
    - Improved performance related to rich text.
    
    ---------
    
    Co-authored-by: Mime Čuvalo <mimecuvalo@gmail.com>

diff --git a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
index 617885d95..31ab49411 100644
--- a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
+++ b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
@@ -45,6 +45,7 @@ import { startEditingShapeWithLabel } from '../../tools/SelectTool/selectHelpers
 
 import isEqual from 'lodash.isequal'
 import {
+	isEmptyRichText,
 	renderHtmlFromRichTextForMeasurement,
 	renderPlaintextFromRichText,
 } from '../../utils/text/richText'
@@ -408,7 +409,7 @@ function getNoteSizeAdjustments(editor: Editor, shape: TLNoteShape) {
 function getNoteLabelSize(editor: Editor, shape: TLNoteShape) {
 	const { richText } = shape.props
 
-	if (!renderPlaintextFromRichText(editor, richText)) {
+	if (isEmptyRichText(richText)) {
 		const minHeight = LABEL_FONT_SIZES[shape.props.size] * TEXT_PROPS.lineHeight + LABEL_PADDING * 2
 		return { labelHeight: minHeight, labelWidth: 100, fontSizeAdjustment: 0 }
 	}
@@ -496,6 +497,7 @@ function useNoteKeydownHandler(id: TLShapeId) {
 				// cmd enter is the y axis (shift inverts direction)
 				const isRTL = !!(
 					translation.dir === 'rtl' ||
+					// todo: can we check a partial of the text, so that we don't have to render the whole thing?
 					isRightToLeftLanguage(renderPlaintextFromRichText(editor, shape.props.richText))
 				)
 

commit 26d0418ecfdc9a9c2bfb255105240ae84d95ea4b
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Mon Mar 24 12:15:21 2025 +0000

    When editing a text shape, don't mount the text editor for non-editing empty shapes unless they're hovered (#5734)
    
    This PR improves text editing.
    
    ## The bug
    
    Previously, we would mount all of the text editors for all of the
    text-editable shapes when the user began editing any text-editable
    shape. For large projects this would block the main thread as all of
    those text editors were mounted. Even on my Very Fast Laptop this would
    introduce ~200-500ms of lag between when I press "Enter" to begin
    editing a shape and when the app would begin responding to my key
    strokes. This often dropped the first letter of whatever I was typing.
    
    ## The fix
    
    We now mount the text editor for a shape if it's:
    - editing; or
    - has text; or
    - is hovered
    
    If a shape is neither of those, then we don't mount the text editor
    until the user hovers the shape. From a user perspective, the
    interactions are identical to what they were before.
    
    ## Proof
    
    Before: (starting to edit a shape with ~1000 empty shapes on the page)
    
    <img width="1334" alt="image"
    src="https://github.com/user-attachments/assets/820908a2-21f0-4a3e-a5b9-5083e4ef6d66"
    />
    
    After:
    
    There's nothing to see, we don't drop any frames.
    
    ### Change type
    
    - [x] `bugfix`
    - [ ] `improvement`
    - [ ] `feature`
    - [ ] `api`
    - [ ] `other`
    
    ### Test plan
    
    1. Create many empty shapes
    2. Begin editing any shape.
    
    ### Release notes
    
    - Fixed a bug causing a performance delay when editing text.
    
    ---------
    
    Co-authored-by: Mime Čuvalo <mimecuvalo@gmail.com>

diff --git a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
index 31ab49411..a79e57bc4 100644
--- a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
+++ b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
@@ -50,6 +50,7 @@ import {
 	renderPlaintextFromRichText,
 } from '../../utils/text/richText'
 import { useDefaultColorTheme } from '../shared/useDefaultColorTheme'
+import { useIsReadyForEditing } from '../shared/useEditablePlainText'
 import {
 	CLONE_HANDLE_MARGIN,
 	NOTE_CENTER_OFFSET,
@@ -275,6 +276,9 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
 
 		const isSelected = shape.id === this.editor.getOnlySelectedShapeId()
 
+		const isReadyForEditing = useIsReadyForEditing(this.editor, shape.id)
+		const isEmpty = isEmptyRichText(richText)
+
 		return (
 			<>
 				<div
@@ -292,21 +296,23 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
 						boxShadow: hideShadows ? 'none' : getNoteShadow(shape.id, rotation, scale),
 					}}
 				>
-					<RichTextLabel
-						shapeId={id}
-						type={type}
-						font={font}
-						fontSize={(fontSizeAdjustment || LABEL_FONT_SIZES[size]) * scale}
-						lineHeight={TEXT_PROPS.lineHeight}
-						align={align}
-						verticalAlign={verticalAlign}
-						richText={richText}
-						isSelected={isSelected}
-						labelColor={labelColor === 'black' ? theme[color].note.text : theme[labelColor].fill}
-						wrap
-						padding={LABEL_PADDING * scale}
-						onKeyDown={handleKeyDown}
-					/>
+					{(isSelected || isReadyForEditing || !isEmpty) && (
+						<RichTextLabel
+							shapeId={id}
+							type={type}
+							font={font}
+							fontSize={(fontSizeAdjustment || LABEL_FONT_SIZES[size]) * scale}
+							lineHeight={TEXT_PROPS.lineHeight}
+							align={align}
+							verticalAlign={verticalAlign}
+							richText={richText}
+							isSelected={isSelected}
+							labelColor={labelColor === 'black' ? theme[color].note.text : theme[labelColor].fill}
+							wrap
+							padding={LABEL_PADDING * scale}
+							onKeyDown={handleKeyDown}
+						/>
+					)}
 				</div>
 				{'url' in shape.props && shape.props.url && <HyperlinkButton url={shape.props.url} />}
 			</>

commit 52e2314962c1a6e1eaa8f5b56fdf3bf41fd62f3f
Author: Mime Čuvalo <mimecuvalo@gmail.com>
Date:   Tue Apr 15 15:45:41 2025 +0100

    stickies: make sure our custom tab behavior takes over the rich text behavior (#5908)
    
    our stickies custom tab/shift+tab behavior is getting mixed up with
    indentation behavior in rich text, oops.
    
    
    
    https://github.com/user-attachments/assets/753cc4f3-eaa1-4262-a47d-b2d8c0e1d058
    
    
    
    ### Change type
    
    - [x] `bugfix`
    - [ ] `improvement`
    - [ ] `feature`
    - [ ] `api`
    - [ ] `other`
    
    ### Release notes
    
    - Fix tab behavior with stickies not playing nicely with rich text.

diff --git a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
index a79e57bc4..e342beec3 100644
--- a/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
+++ b/packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx
@@ -310,6 +310,7 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {
 							labelColor={labelColor === 'black' ? theme[color].note.text : theme[labelColor].fill}
 							wrap
 							padding={LABEL_PADDING * scale}
+							hasCustomTabBehavior
 							onKeyDown={handleKeyDown}
 						/>
 					)}

</code></pre>
        </section>
    </main>
    <footer>
        <p>LoCoDiff-bench - <a href="https://github.com/AbanteAI/LoCoDiff-bench">GitHub Repository</a></p>
    </footer>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            hljs.highlightAll();
        });
    </script>
</body>
</html>
    