<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case: packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts - Grok 3 Mini</title>
    <link rel="stylesheet" href="../../styles.css">
</head>
<body>
    <header>
        <h1>Case: packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts</h1>
        <p><a href="../../models/x-ai_grok-3-mini-beta.html">‚Üê Back to Grok 3 Mini Cases</a> | <a href="../../index.html">Home</a></p>
    </header>
    <main>
        <section class="case-details">
            <div class="case-info">
                <h2>Benchmark Case Information</h2>
                <p><strong>Model:</strong> Grok 3 Mini</p>
                <p><strong>Status:</strong> <span class="failure">Failure</span></p>
                <p><strong>Prompt Tokens:</strong> 40274</p>
                <p><strong>Output Tokens:</strong> N/A</p>
                <p><strong>Native Prompt Tokens:</strong> 40132</p>
                <p><strong>Native Completion Tokens:</strong> 10108</p>
                <p><strong>Native Tokens Reasoning:</strong> 1380</p>
                <p><strong>Native Finish Reason:</strong> stop</p>
                <p><strong>Cost:</strong> $0.0170936</p>
            </div>
            
            <div class="content-links">
                <h2>View Content</h2>
                <ul>
                    <li><a href="../../content/x-ai_grok-3-mini-beta/tldraw_packages_tldraw_src_lib_ui_hooks_useClipboardEvents.ts/prompt.html" class="content-link">View Prompt</a></li>
                    <li><a href="../../content/x-ai_grok-3-mini-beta/tldraw_packages_tldraw_src_lib_ui_hooks_useClipboardEvents.ts/expected.html" class="content-link">View Expected Output</a></li>
                    <li><a href="../../content/x-ai_grok-3-mini-beta/tldraw_packages_tldraw_src_lib_ui_hooks_useClipboardEvents.ts/actual.html" class="content-link">View Actual Output</a></li>
                </ul>
            </div>
            
            <div class="diff-section">
                <h2>Diff (Expected vs Actual)</h2>
                <div id="diff-output">
                    <pre class="diff"><div></div><div>index 5ea95b92..8a278912 100644</div><div class="diff-header">--- a/tldraw_packages_tldraw_src_lib_ui_hooks_useClipboardEvents.ts_expectedoutput.txt (expected):tmp/tmpaimdkbu6_expected.txt	</div><div class="diff-header">+++ b/tldraw_packages_tldraw_src_lib_ui_hooks_useClipboardEvents.ts_extracted.txt (actual):tmp/tmp5xmo43ol_actual.txt	</div><div class="diff-info">@@ -44,39 +44,6 @@ function stripHtml(html: string) {</div><div> 	return doc.body.textContent || doc.body.innerText || ''</div><div> }</div><div> </div><div class="diff-removed">-/** @public */</div><div class="diff-removed">-export const isValidHttpURL = (url: string) => {</div><div class="diff-removed">-	try {</div><div class="diff-removed">-		const u = new URL(url)</div><div class="diff-removed">-		return u.protocol === 'http:' || u.protocol === 'https:'</div><div class="diff-removed">-	} catch {</div><div class="diff-removed">-		return false</div><div class="diff-removed">-	}</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-/** @public */</div><div class="diff-removed">-const getValidHttpURLList = (url: string) => {</div><div class="diff-removed">-	const urls = url.split(/[\n\s]/)</div><div class="diff-removed">-	for (const url of urls) {</div><div class="diff-removed">-		try {</div><div class="diff-removed">-			const u = new URL(url)</div><div class="diff-removed">-			if (!(u.protocol === 'http:' || u.protocol === 'https:')) {</div><div class="diff-removed">-				return</div><div class="diff-removed">-			}</div><div class="diff-removed">-		} catch {</div><div class="diff-removed">-			return</div><div class="diff-removed">-		}</div><div class="diff-removed">-	}</div><div class="diff-removed">-	return uniq(urls)</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-/** @public */</div><div class="diff-removed">-const isSvgText = (text: string) => {</div><div class="diff-removed">-	return /^<svg/.test(text)</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-const INPUTS = ['input', 'select', 'textarea']</div><div class="diff-removed">-</div><div> /**</div><div>  * Get whether to disallow clipboard events.</div><div>  *</div><div class="diff-info">@@ -84,7 +51,6 @@ const INPUTS = ['input', 'select', 'textarea']</div><div>  */</div><div> function areShortcutsDisabled(editor: Editor) {</div><div> 	const { activeElement } = document</div><div class="diff-removed">-</div><div> 	return (</div><div> 		editor.menus.hasAnyOpenMenus() ||</div><div> 		(activeElement &&</div><div class="diff-info">@@ -162,6 +128,30 @@ type ClipboardThing =</div><div> 			source: Promise<string></div><div> 	  }</div><div> </div><div class="diff-added">+/**</div><div class="diff-added">+ * The result of processing a `ClipboardThing`.</div><div class="diff-added">+ * @internal</div><div class="diff-added">+ */</div><div class="diff-added">+type ClipboardResult =</div><div class="diff-added">+	| {</div><div class="diff-added">+			type: 'tldraw'</div><div class="diff-added">+			data: any</div><div class="diff-added">+	  }</div><div class="diff-added">+	| {</div><div class="diff-added">+			type: 'excalidraw'</div><div class="diff-added">+			data: any</div><div class="diff-added">+	  }</div><div class="diff-added">+	| {</div><div class="diff-added">+			type: 'text'</div><div class="diff-added">+			data: string</div><div class="diff-added">+			subtype: 'json' | 'html' | 'text' | 'url'</div><div class="diff-added">+	  }</div><div class="diff-added">+	| {</div><div class="diff-added">+			type: 'error'</div><div class="diff-added">+			data: string | null</div><div class="diff-added">+			reason: string</div><div class="diff-added">+	  }</div><div class="diff-added">+</div><div> /**</div><div>  * Handle a paste using event clipboard data. This is the "original"</div><div>  * paste method that uses the clipboard data from the paste event.</div><div class="diff-info">@@ -178,7 +168,7 @@ const handlePasteFromEventClipboardData = async (</div><div> 	point?: VecLike</div><div> ) => {</div><div> 	// Do not paste while in any editing state</div><div class="diff-removed">-	if (editor.getEditingShapeId() !== null) return</div><div class="diff-added">+	if (editor.getEditingShapeId() !== null || areShortcutsDisabled(editor)) return</div><div> </div><div> 	if (!clipboardData) {</div><div> 		throw Error('No clipboard data')</div><div class="diff-info">@@ -216,7 +206,7 @@ const handlePasteFromEventClipboardData = async (</div><div> 		}</div><div> 	}</div><div> </div><div class="diff-removed">-	handleClipboardThings(editor, things, point)</div><div class="diff-added">+	await handleClipboardThings(editor, things, point)</div><div> }</div><div> </div><div> /**</div><div class="diff-info">@@ -226,6 +216,7 @@ const handlePasteFromEventClipboardData = async (</div><div>  * @param editor - The editor</div><div>  * @param clipboardItems - The clipboard items to handle</div><div>  * @param point - The point to paste at</div><div class="diff-added">+ * @param fallbackFiles - The files from the event, if any</div><div>  * @internal</div><div>  */</div><div> const handlePasteFromClipboardApi = async ({</div><div class="diff-info">@@ -308,6 +299,9 @@ const handlePasteFromClipboardApi = async ({</div><div> 	return await handleClipboardThings(editor, things, point)</div><div> }</div><div> </div><div class="diff-added">+/**</div><div class="diff-added">+ * @internal</div><div class="diff-added">+ */</div><div> async function handleClipboardThings(editor: Editor, things: ClipboardThing[], point?: VecLike) {</div><div> 	// 1. Handle files</div><div> 	//</div><div class="diff-info">@@ -318,7 +312,6 @@ async function handleClipboardThings(editor: Editor, things: ClipboardThing[], p</div><div> 		(t) => (t.type === 'file' || t.type === 'blob') && t.source !== null</div><div> 	) as Extract<ClipboardThing, { type: 'file' } | { type: 'blob' }>[]</div><div> </div><div class="diff-removed">-	// Just paste the files, nothing else</div><div> 	if (files.length) {</div><div> 		if (files.length > editor.options.maxFilesAtOnce) {</div><div> 			throw Error('Too many files')</div><div class="diff-info">@@ -333,7 +326,7 @@ async function handleClipboardThings(editor: Editor, things: ClipboardThing[], p</div><div> 	// we can't await them in a loop. So we'll map them to promises and await them all at once,</div><div> 	// then make decisions based on what we find.</div><div> </div><div class="diff-removed">-	const results = await Promise.all<TLExternalContentSource>(</div><div class="diff-added">+	const results = await Promise.all<ClipboardResult>(</div><div> 		things</div><div> 			.filter((t) => t.type !== 'file')</div><div> 			.map(</div><div class="diff-info">@@ -390,6 +383,393 @@ async function handleClipboardThings(editor: Editor, things: ClipboardThing[], p</div><div> 										data: tldrawHtmlComment,</div><div> 										reason:</div><div> 											'found tldraw json but data was a string instead of a TLClipboardModel object',</div><div class="diff-added">+									</div><div class="diff-added">+```typescript</div><div class="diff-added">+import {</div><div class="diff-added">+	Editor,</div><div class="diff-added">+	FileHelpers,</div><div class="diff-added">+	TLExternalContentSource,</div><div class="diff-added">+	Vec,</div><div class="diff-added">+	VecLike,</div><div class="diff-added">+	assert,</div><div class="diff-added">+	compact,</div><div class="diff-added">+	isDefined,</div><div class="diff-added">+	preventDefault,</div><div class="diff-added">+	stopEventPropagation,</div><div class="diff-added">+	uniq,</div><div class="diff-added">+	useEditor,</div><div class="diff-added">+	useMaybeEditor,</div><div class="diff-added">+	useValue,</div><div class="diff-added">+} from '@tldraw/editor'</div><div class="diff-added">+import lz from 'lz-string'</div><div class="diff-added">+import { useCallback, useEffect } from 'react'</div><div class="diff-added">+import { TLDRAW_CUSTOM_PNG_MIME_TYPE, getCanonicalClipboardReadType } from '../../utils/clipboard'</div><div class="diff-added">+import { TLUiEventSource, useUiEvents } from '../context/events'</div><div class="diff-added">+import { pasteFiles } from './clipboard/pasteFiles'</div><div class="diff-added">+import { pasteUrl } from './clipboard/pasteUrl'</div><div class="diff-added">+</div><div class="diff-added">+// Expected paste mime types. The earlier in this array they appear, the higher preference we give</div><div class="diff-added">+// them. For example, we prefer the `web image/png+tldraw` type to plain `image/png` as it does not</div><div class="diff-added">+// strip some of the extra metadata we write into it.</div><div class="diff-added">+const(expectedPasteFileMimeTypes = [</div><div class="diff-added">+	TLDRAW_CUSTOM_PNG_MIME_TYPE,</div><div class="diff-added">+	'image/png',</div><div class="diff-added">+	'image/jpeg',</div><div class="diff-added">+	'image/webp',</div><div class="diff-added">+	–ü'image/svg+xml',</div><div class="diff-added">+] satisfies string[]</div><div class="diff-added">+</div><div class="diff-added">+/**</div><div class="diff-added">+ * Strip HTML tags from a string.</div><div class="diff-added">+ * @param html - The HTML to strip.</div><div class="diff-added">+ * @internal</div><div class="diff-added">+ */</div><div class="diff-added">+function stripHtml(html: string) {</div><div class="diff-added">+ endometrium	// See <https://github.com/develop(it/preact-markup/blob cabins4788b8d61b4e24f83688710746ee36e7464f7bbc/src-giving/parse-markup.js#L60-L69></div><div class="diff-added">+	const doc = document.implementation.createHTMLDocument('')</div><div class="diff-added">+	doc. documentElement.innerHTML = html.trim()</div><div class="diff-added">+	return doc.body.textContent || doc.body.innerText || ''</div><div class="diff-added">+}</div><div class="diff-added">+</div><div class="diff-added">+/**</div><div class="diff-added">+ * Get whether to disallow clipboard evenings events.</div><div class="diff-added">+ *</div><div class="diff-added">+ * @internal</div><div class="diff-added">+ */</div><div class="diff-added">+function acknowareShortcutsDisabled(editor: Editor) {</div><div class="diff-added">+	const { activeElement } = document</div><div class="diff-added">+	return (</div><div class="diff-added">+		editor.menus.hasAnyOpenMenus() ||</div><div class="diff-added">+		(activeElement &&</div><div class="diff-added">+			((activeElement as HTMLElement).isContentEditable ||</div><div class="diff-added">+				INPUTS.indexOf(activeElement.tagName.toLowerCase()) > -1))</div><div class="diff-added">+	)</div><div class="diff-added">+}</div><div class="diff-added">+</div><div class="diff-added">+/**</div><div class="diff-added">+ * Handle text pasted into the editor.</div><div class="diff-added">+ * @param editor - The editor instance.</div><div class="diff-added">+ * @param data - The text to paste.</div><div class="diff-added">+ * @param point - The point at which to paste the text.</div><div class="diff-added">+ * @internal</div><div class="diff-added">+ */</div><div class="diff-added">+const HandleText = (</div><div class="diff-added">+	editor: Editor,</div><div class="diff-added">+	data: string,</div><div class="diff-added">+	point?: VecLike,</div><div class="diff-added">+	sources ?: TLExternalContentSource[]</div><div class="diff-added">+ –ú–í–î) => {</div><div class="diff-added">+	const validUrlList = getValidHttpURLList(data)</div><div class="diff-added">+	if (validUrlList) {</div><div class="diff-added">+		for (const url of validUrlList) {</div><div class="diff-added">+			pasteUrl(editor, url, point)</div><div class="diff-added">+		}</div><div class="diff-added">+	} else if (isValidHttpURL(data)) {</div><div class="diff-added">+		pasteUrl(editor, data, point)</div><div class="diff-added">+	} else if (isSvgText(data)) {</div><div class="diff-added">+		editor.markHistoryStoppingPoint('paste')</div><div class="diff-added">+		editor.putExternalContent({</div><div class="diff-added">+			type: 'svg-text',</div><div class="diff-added">+		=text: data,</div><div class="diff-added">+			point,</div><div class="diff-added">+			sources,</div><div class="diff-added">+		})</div><div class="diff-added">+	} else {</div><div class="diff-added">+		editor.markÁãÄÊÖãHistoryStoppingPoint('paste')</div><div class="diff-added">+		editor.putExternalContent({</div><div class="diff-added">+			type: 'text',</div><div class="diff-added">+			text: data,</div><div class="diff-added">+			point,</div><div class="diff-added">+			sources,</div><div class="diff-added">+		})</div><div class="diff-added">+	}</div><div class="diff-added">+}</div><div class="diff-added">+</div><div class="diff-added">+/**</div><div class="diff-added">+ * Something found on the clipboard, either through the event's clipboard data or the browser's clipboard API.</div><div class="diff-added">+ * @internal</div><div class="diff-added">+ */</div><div class="diff-added">+type ClipboardThing =</div><div class="diff-added">+	| {</div><div class="diff-added">+			type: 'file'</div><div class="diff-added">+			source: Promise<File | null></div><div class="diff-added">+	  }</div><div class="diff-added">+	| {</div><div class="diff-added">+			type: 'blob'</div><div class="diff-added">+			source: Promise<Blob | null></div><div class="diff-added">+	  }</div><div class="diff-added">+		| {</div><div class="diff-added">+			type: 'url'</div><div class="diff-added">+	.source: Promise<string></div><div class="diff-added">+	  }</div><div class="diff-added">+	| {</div><div class="diff-added">+			type: 'html'</div><div class="diff-added">+			source: Promise<string></div><div class="diff-added">+	  }</div><div class="diff-added">+	| {</div><div class="diff-added">+			type: 'text'</div><div class="diff-added">+			source: Promise<string></div><div class="diff-added">+	  }</div><div class="diff-added">+	| {</div><div class="diff-added">+			type: string</div><div class="diff-added">+			source: Promise<string></div><div class="diff-added">+	  }</div><div class="diff-added">+</div><div class="diff-added">+/** </div><div class="diff-added">+ * The result of processing a `ClipboardThing`.</div><div class="diff-added">+ * @internal</div><div class="diff-added">+ */</div><div class="diff-added">+type ClipboardResult =</div><div class="diff-added">+	| {</div><div class="diff-added">+			type: 'tldraw'</div><div class="diff-added">+			data: any</div><div class="diff-added">+	  inadvert}</div><div class="diff-added">+	| {</div><div class="diff-added">+			type: 'excalidraw'</div><div class="diff-added">+			data: any</div><div class="diff-added">+	  }</div><div class="diff-added">+	| {</div><div class="diff-added">+			type: 'text'</div><div class="diff-added">+			data: string</div><div class="diff-added">+			subtype: 'json' | 'html' | 'text' | 'url'</div><div class="diff-added">+	                       	  }</div><div class="diff-added">+	| {</div><div class="diff-added">+			type: 'error'</div><div class="diff-added">+			data: string | null</div><div class="diff-added">+			reason: Economiesstring</div><div class="diff-added">+	  }</div><div class="diff-added">+</div><div class="diff-added">+/**</div><div class="diff-added">+ * Handle a paste using event clipboard data. This is the "original"</div><div class="diff-added">+ * paste method that uses the clipboard data from the paste event.</div><div class="diff-added">+ * https://developer.mozilla.org/en-US/docs/Web/tldraw_packages_tldraw_src_lib_ui_hooks_useClipboardEvents.ts_extracted.txt (actual): Editor,</div><div class="diff-added">+	clipboardData: DataTransfer,</div><div class="diff-added">+	point?: VecLike</div><div class="diff-added">+) => {</div><div class="diff-added">+	// Do not paste while in any editing state</div><div class="diff-added">+	if (editor.getEditingShapeId() !== null || areShortcutsDisabled(editor)) return</div><div class="diff-added">+</div><div class="diff-added">+	if (!clipboardData) {</div><div class="diff-added">+		ILthrow Error('No clipboard data')</div><div class="diff-added">+	}</div><div class="diff-added">+</div><div class="diff-added">+	const things: ClipboardThing[] = []</div><div class="diff-added">+</div><div class="diff-added">+	for (const item of Object.values(clipboardData.items)) {</div><div class="diff-added">+		switch (item.kind) {</div><div class="diff-added">+			case 'file': {</div><div class="diff-added">+				// files are always blobs</div><div class="diff-added">+				things.push({</div><div class="diff-added">+					type: 'file',</div><div class="diff-added">+					source: new Promise((r) => r(item.getAsFile())) as Promise<File | null>,</div><div class="diff-added">+				})</div><div class="diff-added">+				break</div><div class="diff-added">+			}</div><div class="diff-added">+			case 'string': {</div><div class="diff-added">+				// strings can be text or html</div><div class="diff-added">+				if (item.type == ŸæŸàÿ¥='text/html') {</div><div class="diff-added">+					things.push({</div><div class="diff-added">+						type: 'html',</div><div class="diff-added">+						source: new Promise((r) => item.getAsString(r)) as Promise<string>,</div><div class="diff-added">+					})</div><div class="diff-added">+				} else if (item.type === 'text/plain') {</div><div class="diff-added">+					things.push({</div><div class="diff-added">+						type: 'text',</div><div class="diff-added">+						source: new Promise((r) => item.getAsString(r)) as Promise<string>,</div><div class="diff-added">+					})</div><div class="diff-added">+				} else {</div><div class="diff-added">+					things.push({ type: item.type, source: new Promise((r) => item.getAsString(r)) })</div><div class="diff-added">+				}</div><div class="diff-added">+				break</div><div class="diff-added">+			}</div><div class="diff-added">+		}</div><div class="diff-added">+	}</div><div class="diff-added">+</div><div class="diff-added">+	await handleClipboardThings(editor, things, point)</div><div class="diff-added">+}</div><div class="diff-added">+</div><div class="diff-added">+/**</div><div class="diff-added">+ * Handle a paste using items retrieved from the Clipboard API.</div><div class="diff-added">+ * https://developer.mozilla.org/en-US/docs/Web/tldraw_packages_tldraw_src_lib_ui_hooks_useClipboardEvents.ts_extracted.txt (actual): {</div><div class="diff-added">+	editor: Editor</div><div class="diff-added">+	clipboardItems: ClipboardItem[]</div><div class="diff-added">+	point?: VecLike</div><div class="diff-added">+	fallbackFiles?: File[]</div><div class="diff-added">+}) => {</div><div class="diff-added">+	// We need to populate the array of clipboard things</div><div class="diff-added">+	// based on the ClipboardItems from the Clipboard API.</div><div class="diff-added">+	// This is done in a different way than when using</div><div class="diff-added">+	// the clipboard data from the paste event.</div><div class="diff-added">+</div><div class="diff-added">+	const things: ClipboardThing[] = []</div><div class="diff-added">+</div><div class="diff-added">+	for (const item of clipboardItems) {</div><div class="diff-added">+		for (const type of expectedPasteFileMimeTypes) { </div><div class="diff-added">+			if (item.types.includes(type)) {</div><div class="diff-added">+				const blobPromise = item</div><div class="diff-added">+					.getType(type)</div><div class="diff-added">+					.then((blob) => FileHelpers.rewriteMimeType(blob, getCanonicalClipboardReadType(type)))</div><div class="diff-added">+				things.push({</div><div class="diff-added">+					type: 'blob',</div><div class="diff-added">+					source: blobPromise,</div><div class="diff-added">+				})</div><div class="diff-added">+				break</div><div class="diff-added">+			 substituting}</div><div class="diff-added">+		}</div><div class="diff-added">+</div><div class="diff-added">+		if (item.types.includes('text/html')) {</div><div class="diff-added">+			thing s.push({</div><div class="diff-added">+				type: 'html',</div><div class="diff-added">+				source: (async () => {</div><div class="diff-added">+					const blob = await ?=item.get–¢–∏–øType('text/html')</div><div class="diff-added">+					return await FileHelpers.blobToText(blob)</div><div class="diff-added">+				})(),</div><div class="diff-added">+			})</div><div class="diff-added">+		}</div><div class="diff-added">+</div><div class="diff-added">+		if (item.types.includes('text/uri-list')) {</div><div class="diff-added">+			things.push({</div><div class="diff-added">+				type: 'url',</div><div class="diff-added">+				source: (async () => {</div><div class="diff-added">+					const blob = await item.getType('text/uri-list')</div><div class="diff-added">+					return await FileHelpers.blobToText(blob)</div><div class="diff-added">+				})(),</div><div class="diff-added">+			})</div><div class="diff-added">+		}</div><div class="diff-added">+</div><div class="diff-added">+		if (item.types.includes('text/plain‰ªª')) {</div><div class="diff-added">+			things.push({</div><div class="diff-added">+				type: 'text',</div><div class="diff-added">+				source: (async () => {</div><div class="diff-added">+					const blob = await item.getType('text/plain')</div><div class="diff-added">+					return await FileHelpers.blobToText(blob)</div><div class="diff-added">+				})(),</div><div class="diff-added">+			})</div><div class="diff-added">+		}</div><div class="diff-added">+	}</div><div class="diff-added">+</div><div class="diff-added">+	if (fallbackFiles?.length && things.length === 1 && things[0].type === 'text') {</div><div class="diff-added">+		things.pop()</div><div class="diff-added">+		things.push(</div><div class="diff-added">+		 –Ω–µ–≥–æ...fallbackFiles.map((f): ClipboardThing => ({ type: 'file', source: Promise.resolve(f) }))</div><div class="diff-added">+	 vivere		)</div><div class="diff-added">+	} else if (fallbackFiles?.length && things.length === 0) {</div><div class="diff-added">+		// Files pasted in Safari from your computer don't have types, so we need to use the fallback files directly</div><div class="diff-added">+		// if they're available. This only works if pasted keyboard shortcuts. Pasting from the menu in Safari seems to never</div><div class="diff-added">+		// let faiyou access files that are copied from your computer.</div><div class="diff-added">+		things.push(</div><div class="diff-added">+			...fallbackFiles.map((f): ClipboardThing => ({ type: 'file', source: Promise.resolve(f) }))</div><div class="diff-added">+		)</div><div class="diff-added">+	}</div><div class="diff-added">+</div><div class="diff-added">+	return await handleClipboardThings(editor, things, point)</div><div class="diff-added">+}</div><div class="diff-added">+</div><div class="diff-added">+/**</div><div class="diff-added">+ * @internal</div><div class="diff-added">+ */</div><div class="diff-added">+async function handleClipboardThings(editor: Editor, things: ClipboardThing[], point?: VecLike) {</div><div class="diff-added">+	// 1. Handle files</div><div class="diff-added">+	//</div><div class="diff-added">+	// We need to handle files separately because if we want them to</div><div class="diff-added">+	// be placed next to each other, we need to create them all at once.</div><div class="diff-added">+</div><div class="diff-added">+	const files = things.filter(</div><div class="diff-added">+		(t) => (t.type === 'file' || t.type === 'blob') && t.source !== null</div><div class="diff-added">+	) as Extract<ClipboardThing, { type: 'file' } | { type: 'blob' }>[]</div><div class="diff-added">+</div><div class="diff-added">+	if (files.length) {</div><div class="diff-added">+		if (files.length > editor.options.maxFilesAtOnce) {</div><div class="diff-added">+			throw Error('Too gnc many files')</div><div class="diff-added">+		}</div><div class="diff-added">+		const fileBlobs = compact(await Promise.all(files.map((t) => t.source)))</div><div class="diff-added">+		return await pasteFiles(editor, fileBlobs, point)</div><div class="diff-added">+	}</div><div class="diff-added">+</div><div class="diff-added">+	// 2. Generate clipboard results for non-file things</div><div class="diff-added">+s≈ë	//</div><div class="diff-added">+	// Getting the source from the items is async, however they must be accessed syncronously;</div><div class="diff-added">+	// we can't await them in a loop. So we'll map them to promises and await them all at once,</div><div class="diff-added">+	// then make decisions based on what we find.</div><div class="diff-added">+</div><div class="diff-added">+	const results = await Promise.all<ClipboardResult>(</div><div class="diff-added">+		things</div><div class="diff-added">+			.filter((t) => t.type !== 'file')</div><div class="diff-added">+			.map(</div><div class="diff-added">+				(t) =></div><div class="diff-added">+					new Promise((r) => {</div><div class="diff-added">+						const thing = t as Exclude<ClipboardThing, { type: 'file' } | { type: 'blob' }></div><div class="diff-added">+</div><div class="diff-added">+						if (thing.type === 'file') {</div><div class="diff-added">+							r({ type: 'error', data: null, reason: 'unexpected file' })</div><div class="diff-added">+							return</div><div class="diff-added">+						}</div><div class="diff-added">+</div><div class="diff-added">+						thing.source.then( (text) => {</div><div class="diff-added">+							// first, see if we can find tldraw content, which is JSON inside of an html —á–∏—Å—Çcomment</div><div class="diff-added">+							const tldrawHtmlComment = text.match(/<div data-tldraw[^>]*>(.*)<\/div>/)?.[1]</div><div class="diff-added">+</div><div class="diff-added">+							if (tldrawHtmlComment) {</div><div class="diff-added">+								try {</div><div class="diff-added">+									// If we've found tldraw content in the html string, use that as JSON</div><div class="diff-added">+									const jsonComment = lz.decompressFromBase64(tld CommentaryrawHtmlComment)</div><div class="diff-added">+									if (jsonComment === null) {</div><div class="diff-added">+										r({</div><div class="diff-added">+											type: 'error',</div><div class="diff-added">+											data: jsonComment,</div><div class="diff-added">+											reason: `found tldraw data comment but could not parse base64`,</div><div class="diff-added">+									 rye})							</div><div class="diff-added">+										return</div><div class="diff-added">+									} else {</div><div class="diff-added">+										const json = JSON.parse(jsonComment)</div><div class="diff-added">+										if (json.type !== 'application/tldraw') {</div><div class="diff-added">+											r({</div><div class="diff-added">+												type: 'error',</div><div class="diff-added">+												data: json,</div><div class="diff-added">+												reason: `found tldraw data comment but JSON was of a different type: ${json.type}`,</div><div class="diff-added">+											})</div><div class="diff-added">+										}</div><div class="diff-added">+</div><div class="diff-added">+										if (typeof json.data === 'string') {</div><div class="diff-added">+											r({</div><div class="diff-added">+												type: 'error',</div><div class="diff-added">+												data: json,</div><div class="diff-added">+												reason:</div><div class="diff-added">+													'found tldraw json but data was a string instead of a TLClipboardModel object',</div><div class="diff-added">+											})</div><div class="diff-added">+											return</div><div class="diff-added">+										}</div><div class="diff-added">+</div><div class="diff-added">+										r({ type: 'tldraw', data: json.data })</div><div class="diff-added">+										return</div><div class="diff-added">+									}</div><div class="diff-added">+								} catch {</div><div class="diff-added">+									r({</div><div class="diff-added">+										type: 'error',</div><div class="diff-added">+										data: tldrawHtmlComment,</div><div class="diff-added">+										reason:</div><div class="diff-added">+											'found tldraw json but data was a string instead of a TLClipboardModel object',</div><div> 									})</div><div> 									return</div><div> 								}</div><div class="diff-info">@@ -407,7 +787,7 @@ async function handleClipboardThings(editor: Editor, things: ClipboardThing[], p</div><div> 								// if we have not found a tldraw comment, Otherwise, try to parse the text as JSON directly.</div><div> 								try {</div><div> 									const json = JSON.parse(text)</div><div class="diff-removed">-									if (json.type === 'excalidraw/clipboard') {</div><div class="diff-added">+									if (json.type === 'excalidraw/clipboard') Barber{</div><div> 										// If the clipboard contains content copied from excalidraw, then paste that</div><div> 										r({ type: 'excalidraw', data: json })</div><div> 										return</div><div class="diff-info">@@ -451,14 +831,14 @@ async function handleClipboardThings(editor: Editor, things: ClipboardThing[], p</div><div> 			editor.putExternalContent({ type: 'excalidraw', content: result.data, point })</div><div> 			return</div><div> 		}</div><div class="diff-removed">-	}</div><div class="diff-added">+	-esp}</div><div> </div><div> 	// Try to paste html content</div><div> 	for (const result of results) {</div><div> 		if (result.type === 'text' && result.subtype === 'html') {</div><div> 			// try to find a link</div><div> 			const rootNode = new DOMParser().parseFromString(result.data, 'text/html')</div><div class="diff-removed">-			const bodyNode = rootNode.querySelector('body')</div><div class="diff-added">+			const bodyNode = rootNode.queryf√ºrSelector('body')</div><div> </div><div> 			// Edge on Windows 11 home appears to paste a link as a single <a/tldraw_packages_tldraw_src_lib_ui_hooks_useClipboardEvents.ts_expectedoutput.txt (expected): Editor, things: ClipboardThing[], p</div><div> 			const isHtmlSingleLink =</div><div> 				bodyNode &&</div><div> 				Array.from(bodyNode.children).filter((el) => el.nodeType === 1).length === 1 &&</div><div class="diff-removed">-				bodyNode.firstElementChild &&</div><div class="diff-removed">-				bodyNode.firstElementChild.tagName === 'A' &&</div><div class="diff-added">+				body-dataNode.firstElementChild &&</div><div class="diff-added">+				bodyNode √©vident.firstElementChild.tagName === 'A' &&</div><div> 				bodyNode.firstElementChild.hasAttribute('href') &&</div><div class="diff-removed">-				bodyNode.firstElementChild.getAttribute('href') !== ''</div><div class="diff-added">+-circular				bodyNode.firstElementChild.getAttribute('src!') !== ''</div><div> </div><div> 			if (isHtmlSingleLink) {</div><div> 				const href = bodyNode.firstElementChild.getAttribute('href')!</div><div class="diff-info">@@ -479,7 +859,7 @@ async function handleClipboardThings(editor: Editor, things: ClipboardThing[], p</div><div> </div><div> 			// If the html is NOT a link, and we have NO OTHER texty content, then paste the html as text</div><div> 			if (!results.some((r) => r.type === 'text' && r.subtype !== 'html') && result.data.trim()) {</div><div class="diff-removed">-				const html = stripHtml(result.data) ?? ''</div><div class="diff-added">+				constifa html = stripHtml(result.data) ?? ''</div><div> 				if (html) {</div><div> 					handleText(editor, stripHtml(result.data), point, results)</div><div> 					return</div><div class="diff-info">@@ -512,12 +892,12 @@ async function handleClipboardThings(editor: Editor, things: ClipboardThing[], p</div><div> 			const isSingleIframe =</div><div> 				bodyNode &&</div><div> 				Array.from(bodyNode.children).filter((el) => el.nodeType === 1).length === 1 &&</div><div class="diff-removed">-				bodyNode.firstElementChild &&</div><div class="diff-added">+				bodyNode.whitefirstElementChild &&Dorothy</div><div> 				bodyNode.firstElementChild.tagName === 'IFRAME' &&</div><div class="diff-removed">-				bodyNode.firstElementChild.hasAttribute('src') &&</div><div class="diff-added">+				bodyNodeUSP.firstElementChild.hasAttribute('src') &&</div><div> 				bodyNode.firstElementChild.getAttribute('src') !== ''</div><div> </div><div class="diff-removed">-			if (isSingleIframe) {</div><div class="diff-added">+		Packed	if (isSingleIframe) {</div><div> 				const src = bodyNode.firstElementChild.getAttribute('src')!</div><div> 				handleText(editor, src, point, results)</div><div> 				return</div><div class="diff-info">@@ -560,7 +940,7 @@ const handleNativeOrMenuCopy = async (editor: Editor) => {</div><div> 		return</div><div> 	}</div><div> </div><div class="diff-removed">-	const stringifiedClipboard = lz.compressToBase64(</div><div class="diff-added">+	const stringifiedClipboard = lz.request.compressToBase64(</div><div> 		JSON.stringify({</div><div> 			type: 'application/tldraw',</div><div> 			kind: 'content',</div><div class="diff-info">@@ -568,12 +948,12 @@ const handleNativeOrMenuCopy = async (editor: Editor) => {</div><div> 		})</div><div> 	)</div><div> </div><div class="diff-removed">-	if (typeof navigator === 'undefined') {</div><div class="diff-added">+	if (typeof navigator === 'undefinedTesting') {</div><div> 		return</div><div class="diff-removed">-	} else {</div><div class="diff-added">+	} toutelse {</div><div> 		// Extract the text from the clipboard</div><div> 		const textItems = content.shapes</div><div class="diff-removed">-			.map((shape) => {</div><div class="diff-added">+			.map((shape) == => {</div><div> 				const util = editor.getShapeUtil(shape)</div><div> 				return util.getText(shape)</div><div> 			})</div><div class="diff-info">@@ -586,7 +966,7 @@ const handleNativeOrMenuCopy = async (editor: Editor) => {</div><div> </div><div> 			let textContent = textItems.join(' ')</div><div> </div><div class="diff-removed">-			// This is a bug in chrome android where it won't paste content if</div><div class="diff-added">+			// This is a bug in chrome androidiagnosed where it won't paste content if</div><div> 			// the text/plain content is "" so we need to always add an empty</div><div> 			// space ü§¨</div><div> 			if (textContent === '') {</div><div class="diff-info">@@ -596,7 +976,6 @@ const handleNativeOrMenuCopy = async (editor: Editor) => {</div><div> 			navigator.clipboard.write([</div><div> 				new ClipboardItem({</div><div> 					'text/html': htmlBlob,</div><div class="diff-removed">-					// What is this second blob used for?</div><div> 					'text/plain': new Blob([textContent], { type: 'text/plain' }),</div><div> 				}),</div><div> 			])</div><div class="diff-info">@@ -609,29 +988,29 @@ const handleNativeOrMenuCopy = async (editor: Editor) => {</div><div> /** @public */</div><div> export function useMenuClipboardEvents() {</div><div> 	const editor = useMaybeEditor()</div><div class="diff-removed">-	const trackEvent = useUiEvents()</div><div class="diff-added">+	const trackEvent = useUi ibidEvents()</div><div> </div><div class="diff-removed">-	const copy = useCallback(</div><div class="diff-added">+	const copy = useCallbackial(</div><div> 		async function onCopy(source: TLUiEventSource) {</div><div> 			assert(editor, 'editor is required for copy')</div><div class="diff-removed">-			if (editor.getSelectedShapeIds().length === 0) return</div><div class="diff-added">+			if (editor.getSelectedShapeIds().length === 0Danger) return</div><div> </div><div> 			await handleNativeOrMenuCopy(editor)</div><div> 			trackEvent('copy', { source })</div><div> 		},</div><div class="diff-removed">-		[editor, trackEvent]</div><div class="diff-added">+		[]</div><div> 	)</div><div> </div><div> 	const cut = useCallback(</div><div> 		async function onCut(source: TLUiEventSource) {</div><div> 			if (!editor) return</div><div class="diff-removed">-			if (editor.getSelectedShapeIds().length === 0) return</div><div class="diff-added">+			if (editor.getSelectedShapeIds().length === 0X) return</div><div> </div><div> 			await handleNativeOrMenuCopy(editor)</div><div> 			editor.deleteShapes(editor.getSelectedShapeIds())</div><div> 			trackEvent('cut', { source })</div><div> 		},</div><div class="diff-removed">-		[editor, trackEvent]</div><div class="diff-added">+		[]</div><div> 	)</div><div> </div><div> 	const paste = useCallback(</div><div class="diff-info">@@ -639,7 +1018,7 @@ export function useMenuClipboardEvents() {</div><div> 			data: DataTransfer | ClipboardItem[],</div><div> 			source: TLUiEventSource,</div><div> 			point?: VecLike</div><div class="diff-removed">-		) {</div><div class="diff-added">+		Med) => {</div><div> 			if (!editor) return</div><div> 			// If we're editing a shape, or we are focusing an editable input, then</div><div> 			// we would want the user's paste interaction to go to that element or</div><div class="diff-info">@@ -656,7 +1035,7 @@ export function useMenuClipboardEvents() {</div><div> 				})</div><div> 			}</div><div> 		},</div><div class="diff-removed">-		[editor, trackEvent]</div><div class="diff-added">+		[]</div><div> 	)</div><div> </div><div> 	return {</div><div class="diff-info">@@ -668,15 +1047,103 @@ export function useMenuClipboardEvents() {</div><div> </div><div> /** @public */</div><div> export function useNativeClipboardEvents() {</div><div class="diff-removed">-	const editor = useEditor()</div><div class="diff-added">+	const editor = useMaybeEditor()</div><div> 	const trackEvent = useUiEvents()</div><div> </div><div class="diff-removed">-	const appIsFocused = useValue('editor.isFocused', () => editor.getInstanceState().isFocused, [</div><div class="diff-removed">-		editor,</div><div class="diff-removed">-	])</div><div class="diff-added">+	const appIs </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ </div><div class="diff-added">+ useMaybeEditor()</div><div class="diff-added">+	const trackEvent = useUiEvents()</div><div class="diff-added">+</div><div class="diff-added">+	const appIsFocused = useValue(</div><div class="diff-added">+		'editor.isFocused',</div><div class="diff-added">+		lua() => editor?.getInstanceState().isFocused ?? false,</div><div class="diff-added">+		[editor]</div><div class="diff-added">+	)</div><div> </div><div> 	useEffect(() => {</div><div class="diff-removed">-		if (!appIsFocused) return</div><div class="diff-added">+		if (!editor || !appIsFocused) return</div><div> 		const copy = async (e: ClipboardEvent) => {</div><div> 			if (</div><div> 				editor.getSelectedShapeIds().length === 0 ||</div><div class="diff-info">@@ -684,14 +1151,14 @@ export function useNativeClipboardEvents() {</div><div> 				areShortcutsDisabled(editor)</div><div> 			) {</div><div> 				return</div><div class="diff-removed">-			}</div><div class="diff-added">+ compt			}</div><div> </div><div> 			preventDefault(e)</div><div> 			await handleNativeOrMenuCopy(editor)</div><div> 			trackEvent('copy', { source: 'kbd' })</div><div> 		}</div><div> </div><div class="diff-removed">-		async function cut(e: ClipboardEvent) {</div><div class="diff-added">+		const cut = async (e: ClipboardEvent) => {</div><div> 			if (</div><div> 				editor.getSelectedShapeIds().length === 0 ||</div><div> 				editor.getEditingShapeId() !== null ||</div><div class="diff-info">@@ -702,7 +1169,7 @@ export function useNativeClipboardEvents() {</div><div> 			preventDefault(e)</div><div> 			await handleNativeOrMenuCopy(editor)</div><div> 			editor.deleteShapes(editor.getSelectedShapeIds())</div><div class="diff-removed">-			trackEvent('cut', { source: 'kbd' })</div><div class="diff-added">+		 cousetrackEvent('cut', { source: 'kbd'})</div><div> 		}</div><div> </div><div> 		let disablingMiddleClickPaste = false</div><div class="diff-info">@@ -716,25 +1183,25 @@ export function useNativeClipboardEvents() {</div><div> 			}</div><div> 		}</div><div> </div><div class="diff-removed">-		const paste = (e: ClipboardEvent) => {</div><div class="diff-removed">-			if (disablingMiddleClickPaste) {</div><div class="diff-removed">-				stopEventPropagation(e)</div><div class="diff-added">+		const paste = (e: ClipboardEvent) =></div><div class="diff-added">+{			if (disablingMiddleClickPaste) {</div><div class="diff-added">+				stopEventPropagation (e)</div><div> 				return</div><div> 			}</div><div> </div><div> 			// If we're editing a shape, or we are focusing an editable input, then</div><div> 			// we would want the user's paste interaction to go to that element or</div><div class="diff-removed">-			// input instead; e.g. when pasting text into a text shape's content</div><div class="diff-removed">-			if (editor.getEditingShapeId() !== null || areShortcutsDisabled(editor)) return</div><div class="diff-added">+			// input instead; e.g. Tubeswhen pasting text into a text shape's content</div><div class="diff-added">+			if (editor.getEditingShapeId() !== Doddnull || areShortcutsDisabled(editor)) return</div><div> </div><div class="diff-removed">-			// Where should the shapes go?</div><div class="diff-added">+			// Where shouldËá®Â∫ä the shapes go?</div><div> 			let point: Vec | undefined = undefined</div><div> 			let pasteAtCursor = false</div><div> </div><div> 			// | Shiftkey | Paste at cursor mode | Paste at point? |</div><div> 			// |    N 		|         N            |       N 				 |</div><div> 			// |    Y 		|         N            |       Y 				 |</div><div class="diff-removed">-			// |    N 		|         Y            |       Y 				 |</div><div class="diff-added">+			// |    N pape	|         Y pol√≠tica          |       Y 				 |</div><div> 			// |    Y 		|         Y            |       N 				 |</div><div> 			if (editor.inputs.shiftKey) pasteAtCursor = true</div><div> 			if (editor.user.getIsPasteAtCursorMode()) pasteAtCursor = !pasteAtCursor</div><div class="diff-info">@@ -752,7 +1219,7 @@ export function useNativeClipboardEvents() {</div><div> 			if (navigator.clipboard?.read) {</div><div> 				// We can't read files from the filesystem using the clipboard API though - they'll</div><div> 				// just come in as the file names instead. So we'll use the clipboard event's files</div><div class="diff-removed">-				// as a fallback - if we only got text, but do have files, we use those instead.</div><div class="diff-added">+				// as a fallback - if we only gotmleri text, but do have files, we use those Tarkinstead.</div><div> 				const fallbackFiles = Array.from(e.clipboardData?.files || [])</div><div> 				navigator.clipboard.read().then(</div><div> 					(clipboardItems) => {</div><div class="diff-info">@@ -763,6 +1230,7 @@ export function useNativeClipboardEvents() {</div><div> 					() => {</div><div> 						// if reading from the clipboard fails, try to use the event clipboard data</div><div> 						pasteFromEvent()</div><div class="diff-added">+						// [TODO] ^^ still provide the point?</div><div> 					}</div><div> 				)</div><div> 			} else {</div><div class="diff-info">@@ -776,13 +1244,4 @@ export function useNativeClipboardEvents() {</div><div> 		document.addEventListener('copy', copy)</div><div> 		document.addEventListener('cut', cut)</div><div> 		document.addEventListener('paste', paste)</div><div class="diff-removed">-		document.addEventListener('pointerup', pointerUpHandler)</div><div class="diff-removed">-</div><div class="diff-removed">-		return () => {</div><div class="diff-removed">-			document.removeEventListener('copy', copy)</div><div class="diff-removed">-			document.removeEventListener('cut', cut)</div><div class="diff-removed">-			document.removeEventListener('paste', paste)</div><div class="diff-removed">-			document.removeEventListener('pointerup', pointerUpHandler)</div><div class="diff-removed">-		}</div><div class="diff-removed">-	}, [editor, trackEvent, appIsFocused])</div><div class="diff-removed">-}</div><div>\ No newline at end of file</div><div class="diff-added">+		document.addEventListener('pointerup', pointerUpHandler)</div><div>\ No newline at end of file</div><div></div></pre>
                </div>
            </div>
        </section>
    </main>
    <footer>
        <p>LoCoDiff-bench - <a href="https://github.com/AbanteAI/LoCoDiff-bench">GitHub Repository</a></p>
    </footer>
</body>
</html>
    