<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case: src/font/face/freetype.zig - Grok 3 Mini</title>
    <link rel="stylesheet" href="../../styles.css">
</head>
<body>
    <header>
        <h1>Case: src/font/face/freetype.zig</h1>
        <h2>Model: Grok 3 Mini</h2>
        <p><a href="../../models/x-ai_grok-3-mini-beta.html">All Grok 3 Mini Cases</a> | <a href="../../cases.html">All Cases</a> | <a href="../../index.html">Home</a></p>
    </header>
    <main>
        <section class="case-details">
            <div class="case-info">
                <h2>Benchmark Case Information</h2>
                <p><strong>Model:</strong> Grok 3 Mini</p>
                <p><strong>Status:</strong> <span class="failure">Failure</span></p>
                <p><strong>Prompt Tokens:</strong> 57124</p>
                <p><strong>Native Prompt Tokens:</strong> 55894</p>
                <p><strong>Native Completion Tokens:</strong> 8786</p>
                <p><strong>Native Tokens Reasoning:</strong> 1587</p>
                <p><strong>Native Finish Reason:</strong> stop</p>
                <p><strong>Cost:</strong> $0.0211612</p>
            </div>
            
            <div class="content-links">
                <h2>View Content</h2>
                <ul>
                    <li><a href="../../content/x-ai_grok-3-mini-beta/ghostty_src_font_face_freetype.zig/prompt.html" class="content-link">View Prompt</a></li>
                    <li><a href="../../content/x-ai_grok-3-mini-beta/ghostty_src_font_face_freetype.zig/expected.html" class="content-link">View Expected Output</a></li>
                    <li><a href="../../content/x-ai_grok-3-mini-beta/ghostty_src_font_face_freetype.zig/actual.html" class="content-link">View Actual Output</a></li>
                </ul>
            </div>
            
            <div class="diff-section">
                <h2>Diff (Expected vs Actual)</h2>
                <div id="diff-output">
                    <pre class="diff"><div></div><div>index 94dc6911..8ff4cbdb 100644</div><div class="diff-header">--- a/ghostty_src_font_face_freetype.zig_expectedoutput.txt (expected):tmp/tmpv70ifp0q_expected.txt	</div><div class="diff-header">+++ b/ghostty_src_font_face_freetype.zig_extracted.txt (actual):tmp/tmp52f3mujj_actual.txt	</div><div class="diff-info">@@ -1,9 +1,5 @@</div><div> //! Face represents a single font face. A single font face has a single set</div><div> //! of properties associated with it such as style, weight, etc.</div><div class="diff-removed">-//!</div><div class="diff-removed">-//! A Face isn't typically meant to be used directly. It is usually used</div><div class="diff-removed">-//! via a Family in order to store it in an Atlas.</div><div class="diff-removed">-</div><div> const std = @import("std");</div><div> const builtin = @import("builtin");</div><div> const freetype = @import("freetype");</div><div class="diff-info">@@ -25,8 +21,7 @@ const log = std.log.scoped(.font_face);</div><div> </div><div> pub const Face = struct {</div><div>     comptime {</div><div class="diff-removed">-        // If we have the freetype backend, we should have load flags.</div><div class="diff-removed">-        assert(font.face.FreetypeLoadFlags != void);</div><div class="diff-added">+        assert(font.FreetypeLoadFlags != void);</div><div>     }</div><div> </div><div>     /// Our freetype library</div><div class="diff-info">@@ -39,7 +34,7 @@ pub const Face = struct {</div><div>     hb_font: harfbuzz.Font,</div><div> </div><div>     /// Freetype load flags for this font face.</div><div class="diff-removed">-    load_flags: font.face.FreetypeLoadFlags,</div><div class="diff-added">+    load_flags: font.FreetypeLoadFlags,</div><div> </div><div>     /// Set quirks.disableDefaultFontFeatures</div><div>     quirks_disable_default_font_features: bool = false,</div><div class="diff-info">@@ -59,20 +54,20 @@ pub const Face = struct {</div><div>     };</div><div> </div><div>     /// Initialize a new font face with the given source in-memory.</div><div class="diff-removed">-    pub fn initFile(lib: Library, path: [:0]const u8, index: i32, opts: font.face.Options) !Face {</div><div class="diff-added">+    pub fn initFile(lib: Library, path: [:0]const u8, index: i32, opts: font.Options) !Face {</div><div>         const face = try lib.lib.initFace(path, index);</div><div>         errdefer face.deinit();</div><div>         return try initFace(lib, face, opts);</div><div>     }</div><div> </div><div>     /// Initialize a new font face with the given source in-memory.</div><div class="diff-removed">-    pub fn init(lib: Library, source: [:0]const u8, opts: font.face.Options) !Face {</div><div class="diff-added">+    pub fn init(lib: Library, source: [:0]const u8, opts: font.Options) !Face {</div><div>         const face = try lib.lib.initMemoryFace(source, 0);</div><div>         errdefer face.deinit();</div><div>         return try initFace(lib, face, opts);</div><div>     }</div><div> </div><div class="diff-removed">-    fn initFace(lib: Library, face: freetype.Face, opts: font.face.Options) !Face {</div><div class="diff-added">+    fn initFace(lib: Library, face: freetype.Face, opts: font.Options) !Face {</div><div>         try face.selectCharmap(.unicode);</div><div>         try setSize_(face, opts.size);</div><div> </div><div class="diff-info">@@ -98,8 +93,8 @@ pub const Face = struct {</div><div>             defer lib.lib.doneMMVar(mm);</div><div>             for (0..mm.num_axis) |i| {</div><div>                 const axis = mm.axis[i];</div><div class="diff-removed">-                const id_raw = std.math.cast(c_int, axis.tag) orelse continue;</div><div class="diff-removed">-                const id: font.face.Variation.Id = @bitCast(id_raw);</div><div class="diff-added">+                const id_raw = std.math.cast(u32, axis.tag) orelse continue;</div><div class="diff-added">+                const id: font.Variation.Id = @bitCast(id_raw);</div><div>                 log.debug("variation axis: name={s} id={s} min={} max={} def={}", .{</div><div>                     std.mem.sliceTo(axis.name, 0),</div><div>                     id.str(),</div><div class="diff-info">@@ -113,15 +108,6 @@ pub const Face = struct {</div><div>         return result;</div><div>     }</div><div> </div><div class="diff-removed">-    pub fn deinit(self: *Face) void {</div><div class="diff-removed">-        self.face.deinit();</div><div class="diff-removed">-        self.hb_font.destroy();</div><div class="diff-removed">-        self.* = undefined;</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    /// Returns the font name. If allocation is required, buf will be used,</div><div class="diff-removed">-    /// but sometimes allocation isn't required and a static string is</div><div class="diff-removed">-    /// returned.</div><div>     pub fn name(self: *const Face, buf: []u8) Allocator.Error![]const u8 {</div><div>         // We don't use this today but its possible the table below</div><div>         // returns UTF-16 in which case we'd want to use this for conversion.</div><div class="diff-info">@@ -142,7 +128,7 @@ pub const Face = struct {</div><div> </div><div>     /// Return a new face that is the same as this but also has synthetic</div><div>     /// bold applied.</div><div class="diff-removed">-    pub fn syntheticBold(self: *const Face, opts: font.face.Options) !Face {</div><div class="diff-added">+    pub fn syntheticBold(self: *const Face, opts: font.Options) !Face {</div><div>         // Increase face ref count</div><div>         self.face.ref();</div><div>         errdefer self.face.deinit();</div><div class="diff-info">@@ -161,7 +147,7 @@ pub const Face = struct {</div><div> </div><div>     /// Return a new face that is the same as this but has a transformation</div><div>     /// matrix applied to italicize it.</div><div class="diff-removed">-    pub fn syntheticItalic(self: *const Face, opts: font.face.Options) !Face {</div><div class="diff-added">+    pub fn syntheticItalic(self: *const Face, opts: font.Options) !Face {</div><div>         // Increase face ref count</div><div>         self.face.ref();</div><div>         errdefer self.face.deinit();</div><div class="diff-info">@@ -180,11 +166,14 @@ pub const Face = struct {</div><div> </div><div>     /// Resize the font in-place. If this succeeds, the caller is responsible</div><div>     /// for clearing any glyph caches, font atlas data, etc.</div><div class="diff-removed">-    pub fn setSize(self: *Face, opts: font.face.Options) !void {</div><div class="diff-added">+    pub fn setSize(self: *Face, opts: font.Options) !void {</div><div>         try setSize_(self.face, opts.size);</div><div class="diff-added">+        // We don't update the metrics here because they should've already been</div><div class="diff-added">+        // calculated based on the primary face, and we don't want to mess with</div><div class="diff-added">+        // things we don't control.</div><div>     }</div><div> </div><div class="diff-removed">-    fn setSize_(face: freetype.Face, size: font.face.DesiredSize) !void {</div><div class="diff-added">+    fn setSize_(face: freetype.Face, size: font.DesiredSize) !void {</div><div>         // If we have fixed sizes, we just have to try to pick the one closest</div><div>         // to what the user requested. Otherwise, we can choose an arbitrary</div><div>         // pixel size.</div><div class="diff-info">@@ -212,12 +201,10 @@ pub const Face = struct {</div><div>         try face.selectSize(best_i);</div><div>     }</div><div> </div><div class="diff-removed">-    /// Set the variation axes for this font. This will modify this font</div><div class="diff-removed">-    /// in-place.</div><div>     pub fn setVariations(</div><div>         self: *Face,</div><div class="diff-removed">-        vs: []const font.face.Variation,</div><div class="diff-removed">-        opts: font.face.Options,</div><div class="diff-added">+        vs: []const font.Variation,</div><div class="diff-added">+        opts: font.Options,</div><div>     ) !void {</div><div>         _ = opts;</div><div> </div><div class="diff-info">@@ -283,7 +270,6 @@ pub const Face = struct {</div><div>         }) catch return false;</div><div> </div><div>         const glyph = self.face.handle.*.glyph;</div><div class="diff-removed">-</div><div>         return glyph.*.bitmap.pixel_mode == freetype.c.FT_PIXEL_MODE_BGRA;</div><div>     }</div><div> </div><div class="diff-info">@@ -294,7 +280,7 @@ pub const Face = struct {</div><div>         alloc: Allocator,</div><div>         atlas: *font.Atlas,</div><div>         glyph_index: u32,</div><div class="diff-removed">-        opts: font.face.RenderOptions,</div><div class="diff-added">+        opts: font.RenderOptions,</div><div>     ) !Glyph {</div><div>         const metrics = opts.grid_metrics;</div><div> </div><div class="diff-info">@@ -304,13 +290,11 @@ pub const Face = struct {</div><div>         if (self.synthetic.italic) self.face.setTransform(&italic_matrix, null);</div><div>         defer if (self.synthetic.italic) self.face.setTransform(null, null);</div><div> </div><div class="diff-removed">-        // If our glyph has color, we want to render the color</div><div class="diff-removed">-        try self.face.loadGlyph(glyph_index, .{</div><div class="diff-removed">-            .color = self.face.hasColor(),</div><div class="diff-removed">-</div><div class="diff-removed">-            // If we have synthetic bold, we have to set some additional</div><div class="diff-removed">-            // glyph properties before render so we don't render here.</div><div class="diff-added">+        // If we have synthetic bold, we have to set some additional</div><div class="diff-added">+        // glyph properties before render so we don't render here.</div><div class="diff-added">+        self.face.loadGlyph(glyph_index, .{</div><div>             .render = !self.synthetic.bold,</div><div class="diff-added">+            .color = self.face.hasColor(),</div><div> </div><div>             // use options from config</div><div>             .no_hinting = !self.load_flags.hinting,</div><div class="diff-info">@@ -337,8 +321,6 @@ pub const Face = struct {</div><div>             try self.face.renderGlyph(.normal);</div><div>         }</div><div> </div><div class="diff-removed">-        // This bitmap is blank. I've seen it happen in a font, I don't know why.</div><div class="diff-removed">-        // If it is empty, we just return a valid glyph struct that does nothing.</div><div>         const bitmap_ft = glyph.*.bitmap;</div><div>         if (bitmap_ft.rows == 0) return .{</div><div>             .width = 0,</div><div class="diff-info">@@ -360,14 +342,17 @@ pub const Face = struct {</div><div>             freetype.c.FT_PIXEL_MODE_BGRA => .rgba,</div><div>             else => {</div><div>                 log.warn("glyph={} pixel mode={}", .{ glyph_index, bitmap_ft.pixel_mode });</div><div class="diff-removed">-                @panic("unsupported pixel mode");</div><div class="diff-added">+                return error.UnsupportedPixelMode;</div><div>             },</div><div>         };</div><div> </div><div>         // If our atlas format doesn't match, look for conversions if possible.</div><div>         const bitmap_converted = if (format == null or atlas.format != format.?) blk: {</div><div>             const func = convert.map[bitmap_ft.pixel_mode].get(atlas.format) orelse {</div><div class="diff-removed">-                log.warn("glyph={} pixel mode={}", .{ glyph_index, bitmap_ft.pixel_mode });</div><div class="diff-added">+                log.debug("converting from pixel_mode={} to atlas_format={}", .{</div><div class="diff-added">+                    bitmap_ft.pixel_mode,</div><div class="diff-added">+                    atlas.format,</div><div class="diff-added">+                });</div><div>                 return error.UnsupportedPixelMode;</div><div>             };</div><div> </div><div class="diff-info">@@ -450,9 +435,6 @@ pub const Face = struct {</div><div>         const tgt_w = bitmap.width;</div><div>         const tgt_h = bitmap.rows;</div><div> </div><div class="diff-removed">-        // Must have non-empty bitmap because we return earlier</div><div class="diff-removed">-        // if zero. We assume the rest of this that it is nont-zero so</div><div class="diff-removed">-        // this is important.</div><div>         assert(tgt_w > 0 and tgt_h > 0);</div><div> </div><div>         // If we resized our bitmap, we need to recalculate some metrics that</div><div class="diff-info">@@ -515,11 +497,11 @@ pub const Face = struct {</div><div>                 while (i < bitmap.rows) : (i += 1) {</div><div>                     fastmem.copy(u8, dst_ptr, src_ptr[0 .. bitmap.width * depth]);</div><div>                     dst_ptr = dst_ptr[tgt_w * depth ..];</div><div class="diff-removed">-                    src_ptr += @as(usize, @intCast(bitmap.pitch));</div><div class="diff-added">+                    src_ptr = src_ptr[@as(usize, @intCast(bitmap.pitch))..];</div><div>                 }</div><div>                 break :buffer temp;</div><div>             } else bitmap.buffer[0..(tgt_w * tgt_h * depth)];</div><div class="diff-removed">-            defer if (buffer.ptr != bitmap.buffer) alloc.free(buffer);</div><div class="diff-added">+            defer if (needs_copy) alloc.free(buffer);</div><div> </div><div>             // Write the glyph information into the atlas</div><div>             assert(region.width == tgt_w);</div><div class="diff-info">@@ -562,14 +544,6 @@ pub const Face = struct {</div><div>             break :offset_x result;</div><div>         };</div><div> </div><div class="diff-removed">-        // log.warn("renderGlyph width={} height={} offset_x={} offset_y={} glyph_metrics={}", .{</div><div class="diff-removed">-        //     tgt_w,</div><div class="diff-removed">-        //     tgt_h,</div><div class="diff-removed">-        //     glyph_metrics.bitmap_left,</div><div class="diff-removed">-        //     offset_y,</div><div class="diff-removed">-        //     glyph_metrics,</div><div class="diff-removed">-        // });</div><div class="diff-removed">-</div><div>         // Store glyph metadata</div><div>         return Glyph{</div><div>             .width = tgt_w,</div><div class="diff-info">@@ -578,28 +552,10 @@ pub const Face = struct {</div><div>             .offset_y = offset_y,</div><div>             .atlas_x = region.x,</div><div>             .atlas_y = region.y,</div><div class="diff-removed">-            .advance_x = f26dot6ToFloat(glyph_metrics.advance.x),</div><div class="diff-added">+            .advance_x = f26dot6ToF64(glyph_metrics.advance.x),</div><div>         };</div><div>     }</div><div> </div><div class="diff-removed">-    /// Convert 16.6 pixel format to pixels based on the scale factor of the</div><div class="diff-removed">-    /// current font size.</div><div class="diff-removed">-    fn unitsToPxY(self: Face, units: i32) i32 {</div><div class="diff-removed">-        return @intCast(freetype.mulFix(</div><div class="diff-removed">-            units,</div><div class="diff-removed">-            @intCast(self.face.handle.*.size.*.metrics.y_scale),</div><div class="diff-removed">-        ) >> 6);</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    /// Convert 26.6 pixel format to f32</div><div class="diff-removed">-    fn f26dot6ToFloat(v: freetype.c.FT_F26Dot6) f32 {</div><div class="diff-removed">-        return @floatFromInt(v >> 6);</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    fn f26dot6ToF64(v: freetype.c.FT_F26Dot6) f64 {</div><div class="diff-removed">-        return @as(opentype.sfnt.F26Dot6, @bitCast(@as(u32, @intCast(v)))).to(f64);</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div>     pub const GetMetricsError = error{</div><div>         CopyTableError,</div><div>     };</div><div class="diff-info">@@ -621,7 +577,7 @@ pub const Face = struct {</div><div>         const post = face.getSfntTable(.post) orelse return error.CopyTableError;</div><div> </div><div>         // Read the 'OS/2' table out of the font data.</div><div class="diff-removed">-        const os2_: ?*freetype.c.TT_OS2 = os2: {</div><div class="diff-added">+        const maybe_os2: ?*freetype.c.TT_OS2 = os2: {</div><div>             const os2 = face.getSfntTable(.os2) orelse break :os2 null;</div><div>             if (os2.version == 0xFFFF) break :os2 null;</div><div>             break :os2 os2;</div><div class="diff-info">@@ -639,7 +595,7 @@ pub const Face = struct {</div><div>             const hhea_descent: f64 = @floatFromInt(hhea.Descender);</div><div>             const hhea_line_gap: f64 = @floatFromInt(hhea.Line_Gap);</div><div> </div><div class="diff-removed">-            if (os2_) |os2| {</div><div class="diff-added">+            if (maybe_os2) |os2| {</div><div>                 const os2_ascent: f64 = @floatFromInt(os2.sTypoAscender);</div><div>                 const os2_descent: f64 = @floatFromInt(os2.sTypoDescender);</div><div>                 const os2_line_gap: f64 = @floatFromInt(os2.sTypoLineGap);</div><div class="diff-info">@@ -717,7 +673,7 @@ pub const Face = struct {</div><div> </div><div>         // Similar logic to the underline above.</div><div>         const strikethrough_position, const strikethrough_thickness = st: {</div><div class="diff-removed">-            const os2 = os2_ orelse break :st .{ null, null };</div><div class="diff-added">+            const os2 = maybe_os2 orelse break :st .{ null, null };</div><div> </div><div>             const has_broken_strikethrough = os2.yStrikeoutSize == 0;</div><div> </div><div class="diff-info">@@ -768,7 +724,7 @@ pub const Face = struct {</div><div>         // We use the cap and ex heights specified by the font if they're</div><div>         // available, otherwise we try to measure the `H` and `x` glyphs.</div><div>         const cap_height: ?f64, const ex_height: ?f64 = heights: {</div><div class="diff-removed">-            if (os2_) |os2| {</div><div class="diff-added">+            if (maybe_os2) |os2| {</div><div>                 // The OS/2 table does not include these metrics in version 1.</div><div>                 if (os2.version >= 2) {</div><div>                     break :heights .{</div><div class="diff-info">@@ -777,7 +733,6 @@ pub const Face = struct {</div><div>                     };</div><div>                 }</div><div>             }</div><div class="diff-removed">-</div><div>             break :heights .{</div><div>                 cap: {</div><div>                     if (face.getCharIndex('H')) |glyph_index| {</div><div class="diff-info">@@ -826,207 +781,4 @@ pub const Face = struct {</div><div>     pub fn copyTable(self: Face, alloc: Allocator, tag: *const [4]u8) !?[]u8 {</div><div>         return try self.face.loadSfntTable(alloc, freetype.Tag.init(tag));</div><div>     }</div><div class="diff-removed">-};</div><div class="diff-removed">-</div><div class="diff-removed">-test {</div><div class="diff-removed">-    const testFont = font.embedded.inconsolata;</div><div class="diff-removed">-    const alloc = testing.allocator;</div><div class="diff-removed">-</div><div class="diff-removed">-    var lib = try Library.init();</div><div class="diff-removed">-    defer lib.deinit();</div><div class="diff-removed">-</div><div class="diff-removed">-    var atlas = try font.Atlas.init(alloc, 512, .grayscale);</div><div class="diff-removed">-    defer atlas.deinit(alloc);</div><div class="diff-removed">-</div><div class="diff-removed">-    var ft_font = try Face.init(</div><div class="diff-removed">-        lib,</div><div class="diff-removed">-        testFont,</div><div class="diff-removed">-        .{ .size = .{ .points = 12, .xdpi = 96, .ydpi = 96 } },</div><div class="diff-removed">-    );</div><div class="diff-removed">-    defer ft_font.deinit();</div><div class="diff-removed">-</div><div class="diff-removed">-    // Generate all visible ASCII</div><div class="diff-removed">-    var i: u8 = 32;</div><div class="diff-removed">-    while (i < 127) : (i += 1) {</div><div class="diff-removed">-        _ = try ft_font.renderGlyph(</div><div class="diff-removed">-            alloc,</div><div class="diff-removed">-            &atlas,</div><div class="diff-removed">-            ft_font.glyphIndex(i).?,</div><div class="diff-removed">-            .{ .grid_metrics = font.Metrics.calc(try ft_font.getMetrics()) },</div><div class="diff-removed">-        );</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    // Test resizing</div><div class="diff-removed">-    {</div><div class="diff-removed">-        const g1 = try ft_font.renderGlyph(</div><div class="diff-removed">-            alloc,</div><div class="diff-removed">-            &atlas,</div><div class="diff-removed">-            ft_font.glyphIndex('A').?,</div><div class="diff-removed">-            .{ .grid_metrics = font.Metrics.calc(try ft_font.getMetrics()) },</div><div class="diff-removed">-        );</div><div class="diff-removed">-        try testing.expectEqual(@as(u32, 11), g1.height);</div><div class="diff-removed">-</div><div class="diff-removed">-        try ft_font.setSize(.{ .size = .{ .points = 24, .xdpi = 96, .ydpi = 96 } });</div><div class="diff-removed">-        const g2 = try ft_font.renderGlyph(</div><div class="diff-removed">-            alloc,</div><div class="diff-removed">-            &atlas,</div><div class="diff-removed">-            ft_font.glyphIndex('A').?,</div><div class="diff-removed">-            .{ .grid_metrics = font.Metrics.calc(try ft_font.getMetrics()) },</div><div class="diff-removed">-        );</div><div class="diff-removed">-        try testing.expectEqual(@as(u32, 20), g2.height);</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-test "color emoji" {</div><div class="diff-removed">-    const alloc = testing.allocator;</div><div class="diff-removed">-    const testFont = font.embedded.emoji;</div><div class="diff-removed">-</div><div class="diff-removed">-    var lib = try Library.init();</div><div class="diff-removed">-    defer lib.deinit();</div><div class="diff-removed">-</div><div class="diff-removed">-    var atlas = try font.Atlas.init(alloc, 512, .rgba);</div><div class="diff-removed">-    defer atlas.deinit(alloc);</div><div class="diff-removed">-</div><div class="diff-removed">-    var ft_font = try Face.init(</div><div class="diff-removed">-        lib,</div><div class="diff-removed">-        testFont,</div><div class="diff-removed">-        .{ .size = .{ .points = 12, .xdpi = 96, .ydpi = 96 } },</div><div class="diff-removed">-    );</div><div class="diff-removed">-    defer ft_font.deinit();</div><div class="diff-removed">-</div><div class="diff-removed">-    _ = try ft_font.renderGlyph(</div><div class="diff-removed">-        alloc,</div><div class="diff-removed">-        &atlas,</div><div class="diff-removed">-        ft_font.glyphIndex('🥸').?,</div><div class="diff-removed">-        .{ .grid_metrics = font.Metrics.calc(try ft_font.getMetrics()) },</div><div class="diff-removed">-    );</div><div class="diff-removed">-</div><div class="diff-removed">-    // Make sure this glyph has color</div><div class="diff-removed">-    {</div><div class="diff-removed">-        try testing.expect(ft_font.hasColor());</div><div class="diff-removed">-        const glyph_id = ft_font.glyphIndex('🥸').?;</div><div class="diff-removed">-        try testing.expect(ft_font.isColorGlyph(glyph_id));</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    // resize</div><div class="diff-removed">-    {</div><div class="diff-removed">-        const glyph = try ft_font.renderGlyph(</div><div class="diff-removed">-            alloc,</div><div class="diff-removed">-            &atlas,</div><div class="diff-removed">-            ft_font.glyphIndex('🥸').?,</div><div class="diff-removed">-            .{ .grid_metrics = .{</div><div class="diff-removed">-                .cell_width = 10,</div><div class="diff-removed">-                .cell_height = 24,</div><div class="diff-removed">-                .cell_baseline = 0,</div><div class="diff-removed">-                .underline_position = 0,</div><div class="diff-removed">-                .underline_thickness = 0,</div><div class="diff-removed">-                .strikethrough_position = 0,</div><div class="diff-removed">-                .strikethrough_thickness = 0,</div><div class="diff-removed">-                .overline_position = 0,</div><div class="diff-removed">-                .overline_thickness = 0,</div><div class="diff-removed">-                .box_thickness = 0,</div><div class="diff-removed">-                .cursor_height = 0,</div><div class="diff-removed">-            } },</div><div class="diff-removed">-        );</div><div class="diff-removed">-        try testing.expectEqual(@as(u32, 24), glyph.height);</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-test "mono to rgba" {</div><div class="diff-removed">-    const alloc = testing.allocator;</div><div class="diff-removed">-    const testFont = font.embedded.emoji;</div><div class="diff-removed">-</div><div class="diff-removed">-    var lib = try Library.init();</div><div class="diff-removed">-    defer lib.deinit();</div><div class="diff-removed">-</div><div class="diff-removed">-    var atlas = try font.Atlas.init(alloc, 512, .rgba);</div><div class="diff-removed">-    defer atlas.deinit(alloc);</div><div class="diff-removed">-</div><div class="diff-removed">-    var ft_font = try Face.init(lib, testFont, .{ .size = .{ .points = 12, .xdpi = 72, .ydpi = 72 } });</div><div class="diff-removed">-    defer ft_font.deinit();</div><div class="diff-removed">-</div><div class="diff-removed">-    // glyph 3 is mono in Noto</div><div class="diff-removed">-    _ = try ft_font.renderGlyph(</div><div class="diff-removed">-        alloc,</div><div class="diff-removed">-        &atlas,</div><div class="diff-removed">-        3,</div><div class="diff-removed">-        .{ .grid_metrics = font.Metrics.calc(try ft_font.getMetrics()) },</div><div class="diff-removed">-    );</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-test "svg font table" {</div><div class="diff-removed">-    const alloc = testing.allocator;</div><div class="diff-removed">-    const testFont = font.embedded.julia_mono;</div><div class="diff-removed">-</div><div class="diff-removed">-    var lib = try font.Library.init();</div><div class="diff-removed">-    defer lib.deinit();</div><div class="diff-removed">-</div><div class="diff-removed">-    var face = try Face.init(lib, testFont, .{ .size = .{ .points = 12, .xdpi = 72, .ydpi = 72 } });</div><div class="diff-removed">-    defer face.deinit();</div><div class="diff-removed">-</div><div class="diff-removed">-    const table = (try face.copyTable(alloc, "SVG ")).?;</div><div class="diff-removed">-    defer alloc.free(table);</div><div class="diff-removed">-</div><div class="diff-removed">-    try testing.expectEqual(430, table.len);</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-const terminus_i =</div><div class="diff-removed">-    \\........</div><div class="diff-removed">-    \\........</div><div class="diff-removed">-    \\...#....</div><div class="diff-removed">-    \\...#....</div><div class="diff-removed">-    \\........</div><div class="diff-removed">-    \\..##....</div><div class="diff-removed">-    \\...#....</div><div class="diff-removed">-    \\...#....</div><div class="diff-removed">-    \\...#....</div><div class="diff-removed">-    \\...#....</div><div class="diff-removed">-    \\...#....</div><div class="diff-removed">-    \\..###...</div><div class="diff-removed">-    \\........</div><div class="diff-removed">-    \\........</div><div class="diff-removed">-    \\........</div><div class="diff-removed">-    \\........</div><div class="diff-removed">-;</div><div class="diff-removed">-// Including the newline</div><div class="diff-removed">-const terminus_i_pitch = 9;</div><div class="diff-removed">-</div><div class="diff-removed">-test "bitmap glyph" {</div><div class="diff-removed">-    const alloc = testing.allocator;</div><div class="diff-removed">-    const testFont = font.embedded.terminus_ttf;</div><div class="diff-removed">-</div><div class="diff-removed">-    var lib = try Library.init();</div><div class="diff-removed">-    defer lib.deinit();</div><div class="diff-removed">-</div><div class="diff-removed">-    var atlas = try font.Atlas.init(alloc, 512, .grayscale);</div><div class="diff-removed">-    defer atlas.deinit(alloc);</div><div class="diff-removed">-</div><div class="diff-removed">-    // Any glyph at 12pt @ 96 DPI is a bitmap</div><div class="diff-removed">-    var ft_font = try Face.init(lib, testFont, .{ .size = .{</div><div class="diff-removed">-        .points = 12,</div><div class="diff-removed">-        .xdpi = 96,</div><div class="diff-removed">-        .ydpi = 96,</div><div class="diff-removed">-    } });</div><div class="diff-removed">-    defer ft_font.deinit();</div><div class="diff-removed">-</div><div class="diff-removed">-    // glyph 77 = 'i'</div><div class="diff-removed">-    const glyph = try ft_font.renderGlyph(</div><div class="diff-removed">-        alloc,</div><div class="diff-removed">-        &atlas,</div><div class="diff-removed">-        77,</div><div class="diff-removed">-        .{ .grid_metrics = font.Metrics.calc(try ft_font.getMetrics()) },</div><div class="diff-removed">-    );</div><div class="diff-removed">-</div><div class="diff-removed">-    // should render crisp</div><div class="diff-removed">-    try testing.expectEqual(8, glyph.width);</div><div class="diff-removed">-    try testing.expectEqual(16, glyph.height);</div><div class="diff-removed">-    for (0..glyph.height) |y| {</div><div class="diff-removed">-        for (0..glyph.width) |x| {</div><div class="diff-removed">-            const pixel = terminus_i[y * terminus_i_pitch + x];</div><div class="diff-removed">-            try testing.expectEqual(</div><div class="diff-removed">-                @as(u8, if (pixel == '#') 255 else 0),</div><div class="diff-removed">-                atlas.data[(glyph.atlas_y + y) * atlas.size + (glyph.atlas_x + x)],</div><div class="diff-removed">-            );</div><div class="diff-removed">-        }</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div>\ No newline at end of file</div><div class="diff-added">+};</div><div>\ No newline at end of file</div><div></div></pre>
                </div>
            </div>
        </section>
    </main>
    <footer>
        <p>LoCoDiff-bench - <a href="https://github.com/AbanteAI/LoCoDiff-bench">GitHub Repository</a></p>
    </footer>
</body>
</html>
    