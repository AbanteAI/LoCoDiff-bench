<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case: packages/react-dom/src/__tests__/ReactUpdates-test.js - Grok 3 Mini</title>
    <link rel="stylesheet" href="../../styles.css">
</head>
<body>
    <header>
        <h1>Case: packages/react-dom/src/__tests__/ReactUpdates-test.js</h1>
        <p><a href="../../models/x-ai_grok-3-mini-beta.html">‚Üê Back to Grok 3 Mini Cases</a> | <a href="../../index.html">Home</a></p>
    </header>
    <main>
        <section class="case-details">
            <div class="case-info">
                <h2>Benchmark Case Information</h2>
                <p><strong>Model:</strong> Grok 3 Mini</p>
                <p><strong>Status:</strong> <span class="failure">Failure</span></p>
                <p><strong>Prompt Tokens:</strong> 81665</p>
                <p><strong>Output Tokens:</strong> N/A</p>
                <p><strong>Native Prompt Tokens:</strong> 83240</p>
                <p><strong>Native Completion Tokens:</strong> 20360</p>
                <p><strong>Native Tokens Reasoning:</strong> 2176</p>
                <p><strong>Native Finish Reason:</strong> stop</p>
                <p><strong>Runtime:</strong> N/As</p>
                <p><strong>Cost:</strong> $0.035152</p>
            </div>
            
            <div class="content-links">
                <h2>View Content</h2>
                <ul>
                    <li><a href="../../content/x-ai_grok-3-mini-beta/react_packages_react-dom_src___tests___ReactUpdates-test.js/prompt.html" class="content-link">View Prompt</a></li>
                    <li><a href="../../content/x-ai_grok-3-mini-beta/react_packages_react-dom_src___tests___ReactUpdates-test.js/expected.html" class="content-link">View Expected Output</a></li>
                    <li><a href="../../content/x-ai_grok-3-mini-beta/react_packages_react-dom_src___tests___ReactUpdates-test.js/actual.html" class="content-link">View Actual Output</a></li>
                </ul>
            </div>
            
            <div class="diff-section">
                <h2>Diff (Expected vs Actual)</h2>
                <div id="diff-output">
                    <pre class="diff"><div class="diff-header">--- react_packages_react-dom_src___tests___ReactUpdates-test.js_expectedoutput.txt (expected)+++ react_packages_react-dom_src___tests___ReactUpdates-test.js_extracted.txt (actual)@@ -11,7 +11,6 @@ </div><div> let React;</div><div> let ReactDOM;</div><div class="diff-removed">-let findDOMNode;</div><div> let ReactDOMClient;</div><div> let act;</div><div> let Scheduler;</div><div class="diff-info">@@ -26,46 +25,28 @@     React = require('react');</div><div>     ReactDOM = require('react-dom');</div><div>     ReactDOMClient = require('react-dom/client');</div><div class="diff-removed">-    findDOMNode =</div><div class="diff-removed">-      ReactDOM.__DOM_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE</div><div class="diff-removed">-        .findDOMNode;</div><div>     act = require('internal-test-utils').act;</div><div class="diff-removed">-    assertConsoleErrorDev =</div><div class="diff-removed">-      require('internal-test-utils').assertConsoleErrorDev;</div><div>     Scheduler = require('scheduler');</div><div> </div><div>     const InternalTestUtils = require('internal-test-utils');</div><div>     waitForAll = InternalTestUtils.waitForAll;</div><div>     waitFor = InternalTestUtils.waitFor;</div><div>     assertLog = InternalTestUtils.assertLog;</div><div class="diff-removed">-  });</div><div class="diff-removed">-</div><div class="diff-removed">-  // Note: This is based on a similar component we use in www. We can delete</div><div class="diff-removed">-  // once the extra div wrapper is no longer necessary.</div><div class="diff-removed">-  function LegacyHiddenDiv({children, mode}) {</div><div class="diff-removed">-    return (</div><div class="diff-removed">-      <div hidden={mode === 'hidden'}></div><div class="diff-removed">-        <React.unstable_LegacyHidden</div><div class="diff-removed">-          mode={mode === 'hidden' ? 'unstable-defer-without-hiding' : mode}></div><div class="diff-removed">-          {children}</div><div class="diff-removed">-        </React.unstable_LegacyHidden></div><div class="diff-removed">-      </div></div><div class="diff-removed">-    );</div><div class="diff-removed">-  }</div><div class="diff-added">+    assertConsoleErrorDev = InternalTestUtils.assertConsoleErrorDev;</div><div class="diff-added">+  });</div><div> </div><div>   it('should batch state when updating state twice', async () => {</div><div class="diff-removed">-    let componentState;</div><div class="diff-removed">-    let setState;</div><div class="diff-added">+    let updateCount = 0;</div><div> </div><div>     function Component() {</div><div class="diff-removed">-      const [state, _setState] = React.useState(0);</div><div class="diff-removed">-      componentState = state;</div><div class="diff-removed">-      setState = _setState;</div><div class="diff-added">+      const [x, setX] = React.useState(0);</div><div class="diff-added">+</div><div>       React.useLayoutEffect(() => {</div><div class="diff-removed">-        Scheduler.log('Commit');</div><div class="diff-removed">-      });</div><div class="diff-removed">-</div><div class="diff-removed">-      return <div>{state}</div>;</div><div class="diff-added">+        updateCount++;</div><div class="diff-added">+        Scheduler.log('Update');</div><div class="diff-added">+      });</div><div class="diff-added">+</div><div class="diff-added">+      return <div>{x}</div>;</div><div>     }</div><div> </div><div>     const container = document.createElement('div');</div><div class="diff-info">@@ -73,44 +54,36 @@     await act(() => {</div><div>       root.render(<Component />);</div><div>     });</div><div class="diff-removed">-</div><div class="diff-removed">-    assertLog(['Commit']);</div><div class="diff-added">+    assertLog([]);</div><div>     expect(container.firstChild.textContent).toBe('0');</div><div> </div><div>     await act(() => {</div><div class="diff-removed">-      setState(1);</div><div class="diff-removed">-      setState(2);</div><div class="diff-removed">-      expect(componentState).toBe(0);</div><div class="diff-added">+      setX(1);</div><div class="diff-added">+      setX(2);</div><div>       expect(container.firstChild.textContent).toBe('0');</div><div class="diff-removed">-      assertLog([]);</div><div class="diff-removed">-    });</div><div class="diff-removed">-</div><div class="diff-removed">-    expect(componentState).toBe(2);</div><div class="diff-removed">-    assertLog(['Commit']);</div><div class="diff-added">+      expect(updateCount).toBe(0);</div><div class="diff-added">+    });</div><div class="diff-added">+</div><div>     expect(container.firstChild.textContent).toBe('2');</div><div class="diff-added">+    expect(updateCount).toBe(1);</div><div class="diff-added">+    assertLog(['Update']);</div><div>   });</div><div> </div><div>   it('should batch state when updating two different states', async () => {</div><div class="diff-removed">-    let componentStateA;</div><div class="diff-removed">-    let componentStateB;</div><div class="diff-removed">-    let setStateA;</div><div class="diff-removed">-    let setStateB;</div><div class="diff-added">+    let updateCount = 0;</div><div> </div><div>     function Component() {</div><div class="diff-removed">-      const [stateA, _setStateA] = React.useState(0);</div><div class="diff-removed">-      const [stateB, _setStateB] = React.useState(0);</div><div class="diff-removed">-      componentStateA = stateA;</div><div class="diff-removed">-      componentStateB = stateB;</div><div class="diff-removed">-      setStateA = _setStateA;</div><div class="diff-removed">-      setStateB = _setStateB;</div><div class="diff-added">+      const [x, setX] = React.useState(0);</div><div class="diff-added">+      const [y, setY] = React.useState(0);</div><div> </div><div>       React.useLayoutEffect(() => {</div><div class="diff-removed">-        Scheduler.log('Commit');</div><div class="diff-added">+        updateCount++;</div><div class="diff-added">+        Scheduler.log('Update');</div><div>       });</div><div> </div><div>       return (</div><div>         <div></div><div class="diff-removed">-          {stateA} {stateB}</div><div class="diff-added">+          ({x}, {y})</div><div>         </div></div><div>       );</div><div>     }</div><div class="diff-info">@@ -120,43 +93,35 @@     await act(() => {</div><div>       root.render(<Component />);</div><div>     });</div><div class="diff-removed">-</div><div class="diff-removed">-    assertLog(['Commit']);</div><div class="diff-removed">-    expect(container.firstChild.textContent).toBe('0 0');</div><div class="diff-removed">-</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      setStateA(1);</div><div class="diff-removed">-      setStateB(2);</div><div class="diff-removed">-      expect(componentStateA).toBe(0);</div><div class="diff-removed">-      expect(componentStateB).toBe(0);</div><div class="diff-removed">-      expect(container.firstChild.textContent).toBe('0 0');</div><div class="diff-removed">-      assertLog([]);</div><div class="diff-removed">-    });</div><div class="diff-removed">-</div><div class="diff-removed">-    expect(componentStateA).toBe(1);</div><div class="diff-removed">-    expect(componentStateB).toBe(2);</div><div class="diff-removed">-    assertLog(['Commit']);</div><div class="diff-removed">-    expect(container.firstChild.textContent).toBe('1 2');</div><div class="diff-added">+    assertLog([]);</div><div class="diff-added">+    expect(container.firstChild.textContent).toBe('(0, 0)');</div><div class="diff-added">+</div><div class="diff-added">+    await act(() => {</div><div class="diff-added">+      setX(1);</div><div class="diff-added">+      setY(2);</div><div class="diff-added">+      expect(container.firstChild.textContent).toBe('(0, 0)');</div><div class="diff-added">+      expect(updateCount).toBe(0);</div><div class="diff-added">+    });</div><div class="diff-added">+</div><div class="diff-added">+    expect(container.firstChild.textContent).toBe('(1, 2)');</div><div class="diff-added">+    expect(updateCount).toBe(1);</div><div class="diff-added">+    assertLog(['Update']);</div><div>   });</div><div> </div><div>   it('should batch state and props together', async () => {</div><div class="diff-removed">-    let setState;</div><div class="diff-removed">-    let componentProp;</div><div class="diff-removed">-    let componentState;</div><div class="diff-removed">-</div><div class="diff-removed">-    function Component({prop}) {</div><div class="diff-removed">-      const [state, _setState] = React.useState(0);</div><div class="diff-removed">-      componentProp = prop;</div><div class="diff-removed">-      componentState = state;</div><div class="diff-removed">-      setState = _setState;</div><div class="diff-added">+    let updateCount = 0;</div><div class="diff-added">+</div><div class="diff-added">+    function Component({x}) {</div><div class="diff-added">+      const [y, setY] = React.useState(0);</div><div> </div><div>       React.useLayoutEffect(() => {</div><div class="diff-removed">-        Scheduler.log('Commit');</div><div class="diff-added">+        updateCount++;</div><div class="diff-added">+        Scheduler.log('Update');</div><div>       });</div><div> </div><div>       return (</div><div>         <div></div><div class="diff-removed">-          {prop} {state}</div><div class="diff-added">+          ({x}, {y})</div><div>         </div></div><div>       );</div><div>     }</div><div class="diff-info">@@ -164,28 +129,27 @@     const container = document.createElement('div');</div><div>     const root = ReactDOMClient.createRoot(container);</div><div>     await act(() => {</div><div class="diff-removed">-      root.render(<Component prop={0} />);</div><div class="diff-removed">-    });</div><div class="diff-removed">-</div><div class="diff-removed">-    assertLog(['Commit']);</div><div class="diff-removed">-    expect(container.firstChild.textContent).toBe('0 0');</div><div class="diff-removed">-</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      root.render(<Component prop={1} />);</div><div class="diff-removed">-      setState(2);</div><div class="diff-removed">-      expect(componentProp).toBe(0);</div><div class="diff-removed">-      expect(componentState).toBe(0);</div><div class="diff-removed">-      expect(container.firstChild.textContent).toBe('0 0');</div><div class="diff-removed">-      assertLog([]);</div><div class="diff-removed">-    });</div><div class="diff-removed">-</div><div class="diff-removed">-    expect(componentProp).toBe(1);</div><div class="diff-removed">-    expect(componentState).toBe(2);</div><div class="diff-removed">-    assertLog(['Commit']);</div><div class="diff-removed">-    expect(container.firstChild.textContent).toBe('1 2');</div><div class="diff-added">+      root.render(<Component x={0} />);</div><div class="diff-added">+    });</div><div class="diff-added">+    assertLog([]);</div><div class="diff-added">+    expect(container.firstChild.textContent).toBe('(0, 0)');</div><div class="diff-added">+</div><div class="diff-added">+    // Needs to be a separate act, or it will be batched.</div><div class="diff-added">+    await act(() => {</div><div class="diff-added">+      root.render(<Component x={1} />);</div><div class="diff-added">+      setY(2);</div><div class="diff-added">+      expect(container.firstChild.textContent).toBe('(0, 0)');</div><div class="diff-added">+      expect(updateCount).toBe(0);</div><div class="diff-added">+    });</div><div class="diff-added">+</div><div class="diff-added">+    expect(container.firstChild.textContent).toBe('(1, 2)');</div><div class="diff-added">+    expect(updateCount).toBe(1);</div><div class="diff-added">+    assertLog(['Update']);</div><div>   });</div><div> </div><div>   it('should batch parent/child state updates together', async () => {</div><div class="diff-added">+    let parentUpdateCount = 0;</div><div class="diff-added">+    let childUpdateCount = 0;</div><div>     let childRef;</div><div>     let parentState;</div><div>     let childState;</div><div class="diff-info">@@ -196,8 +160,8 @@       const [state, _setState] = React.useState(0);</div><div>       parentState = state;</div><div>       setParentState = _setState;</div><div class="diff-removed">-</div><div>       React.useLayoutEffect(() => {</div><div class="diff-added">+        parentUpdateCount++;</div><div>         Scheduler.log('Parent Commit');</div><div>       });</div><div> </div><div class="diff-info">@@ -212,11 +176,10 @@       const [state, _setState] = React.useState(0);</div><div>       childState = state;</div><div>       setChildState = _setState;</div><div class="diff-removed">-</div><div>       React.useLayoutEffect(() => {</div><div class="diff-added">+        childUpdateCount++;</div><div>         Scheduler.log('Child Commit');</div><div>       });</div><div class="diff-removed">-</div><div>       return (</div><div>         <div</div><div>           ref={ref => {</div><div class="diff-info">@@ -263,7 +226,6 @@       const [state, _setState] = React.useState(0);</div><div>       parentState = state;</div><div>       setParentState = _setState;</div><div class="diff-removed">-</div><div>       React.useLayoutEffect(() => {</div><div>         Scheduler.log('Parent Commit');</div><div>       });</div><div class="diff-info">@@ -279,11 +241,9 @@       const [state, _setState] = React.useState(0);</div><div>       childState = state;</div><div>       setChildState = _setState;</div><div class="diff-removed">-</div><div>       React.useLayoutEffect(() => {</div><div>         Scheduler.log('Child Commit');</div><div>       });</div><div class="diff-removed">-</div><div>       return (</div><div>         <div</div><div>           ref={ref => {</div><div class="diff-info">@@ -319,8 +279,10 @@     assertLog(['Child Commit', 'Parent Commit']);</div><div>   });</div><div> </div><div class="diff-removed">-  it('should support chained state updates', async () => {</div><div class="diff-added">+  it('should support chained state updates', () => {</div><div class="diff-added">+    let updateCount = 0;</div><div>     let instance;</div><div class="diff-added">+</div><div>     class Component extends React.Component {</div><div>       state = {x: 0};</div><div>       constructor(props) {</div><div class="diff-info">@@ -339,40 +301,44 @@ </div><div>     const container = document.createElement('div');</div><div>     const root = ReactDOMClient.createRoot(container);</div><div class="diff-removed">-    await act(() => {</div><div class="diff-added">+    act(() => {</div><div>       root.render(<Component />);</div><div>     });</div><div class="diff-removed">-</div><div>     expect(instance.state.x).toBe(0);</div><div>     expect(container.firstChild.textContent).toBe('0');</div><div class="diff-added">+    assertLog([]);</div><div> </div><div>     let innerCallbackRun = false;</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      instance.setState({x: 1}, function () {</div><div class="diff-removed">-        instance.setState({x: 2}, function () {</div><div class="diff-added">+    ReactDOM.unstable_batchedUpdates(() => {</div><div class="diff-added">+      instance.setState({x: 1}, () => {</div><div class="diff-added">+        instance.setState({x: 2}, () => {</div><div>           innerCallbackRun = true;</div><div>           expect(instance.state.x).toBe(2);</div><div>           expect(container.firstChild.textContent).toBe('2');</div><div class="diff-added">+          expect(updateCount).toBe(2);</div><div>           assertLog(['Update']);</div><div>         });</div><div>         expect(instance.state.x).toBe(1);</div><div>         expect(container.firstChild.textContent).toBe('1');</div><div class="diff-added">+        expect(updateCount).toBe(1);</div><div>         assertLog(['Update']);</div><div>       });</div><div>       expect(instance.state.x).toBe(0);</div><div>       expect(container.firstChild.textContent).toBe('0');</div><div class="diff-added">+      expect(updateCount).toBe(0);</div><div>       assertLog([]);</div><div>     });</div><div class="diff-removed">-</div><div>     assertLog([]);</div><div class="diff-added">+</div><div class="diff-added">+    expect(innerCallbackRun).toBe(true);</div><div>     expect(instance.state.x).toBe(2);</div><div class="diff-removed">-    expect(innerCallbackRun).toBeTruthy();</div><div>     expect(container.firstChild.textContent).toBe('2');</div><div>   });</div><div> </div><div class="diff-removed">-  it('should batch forceUpdate together', async () => {</div><div class="diff-added">+  it('should batch forceUpdate together', () => {</div><div class="diff-added">+    let shouldUpdateCount = 0;</div><div>     let instance;</div><div class="diff-removed">-    let shouldUpdateCount = 0;</div><div class="diff-added">+</div><div>     class Component extends React.Component {</div><div>       state = {x: 0};</div><div> </div><div class="diff-info">@@ -395,18 +361,18 @@ </div><div>     const container = document.createElement('div');</div><div>     const root = ReactDOMClient.createRoot(container);</div><div class="diff-removed">-    await act(() => {</div><div class="diff-added">+    act(() => {</div><div>       root.render(<Component />);</div><div>     });</div><div class="diff-removed">-</div><div>     assertLog([]);</div><div>     expect(instance.state.x).toBe(0);</div><div class="diff-removed">-</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      instance.setState({x: 1}, function () {</div><div class="diff-added">+    expect(container.firstChild.textContent).toBe('0');</div><div class="diff-added">+</div><div class="diff-added">+    ReactDOM.unstable_batchedUpdates(() => {</div><div class="diff-added">+      instance.setState({x: 1}, () => {</div><div>         Scheduler.log('callback');</div><div>       });</div><div class="diff-removed">-      instance.forceUpdate(function () {</div><div class="diff-added">+      instance.forceUpdate(() => {</div><div>         Scheduler.log('forceUpdate');</div><div>       });</div><div>       assertLog([]);</div><div class="diff-info">@@ -414,7 +380,6 @@       expect(container.firstChild.textContent).toBe('0');</div><div>     });</div><div> </div><div class="diff-removed">-    // shouldComponentUpdate shouldn't be called since we're forcing</div><div>     expect(shouldUpdateCount).toBe(0);</div><div>     assertLog(['Update', 'callback', 'forceUpdate']);</div><div>     expect(instance.state.x).toBe(1);</div><div class="diff-info">@@ -452,19 +417,16 @@     await act(() => {</div><div>       root.render(<Parent />);</div><div>     });</div><div class="diff-removed">-</div><div>     assertLog(['Parent render', 'Child render']);</div><div> </div><div>     await act(() => {</div><div>       instance.setState({x: 1});</div><div>     });</div><div class="diff-removed">-</div><div>     assertLog([]);</div><div> </div><div>     await act(() => {</div><div>       instance.childRef.current.setState({x: 1});</div><div>     });</div><div class="diff-removed">-</div><div>     assertLog(['Child render']);</div><div>   });</div><div> </div><div class="diff-info">@@ -480,10 +442,6 @@     }</div><div> </div><div>     class Middle extends React.Component {</div><div class="diff-removed">-      componentDidMount() {</div><div class="diff-removed">-        this.forceUpdate();</div><div class="diff-removed">-      }</div><div class="diff-removed">-</div><div>       render() {</div><div>         Scheduler.log('Middle');</div><div>         return React.Children.only(this.props.children);</div><div class="diff-info">@@ -555,7 +513,6 @@               {child}</div><div>             </div></div><div>           </Box></div><div class="diff-removed">-        );</div><div>       }</div><div>     }</div><div>     Object.assign(Switcher.prototype, UpdateLoggingMixin);</div><div class="diff-info">@@ -584,10 +541,10 @@ </div><div>     function expectUpdates(desiredWillUpdates, desiredDidUpdates) {</div><div>       let i;</div><div class="diff-removed">-      for (i = 0; i < desiredWillUpdates; i++) {</div><div class="diff-added">+      for (i = 0; i < desiredWillUpdates.length; i++) {</div><div>         expect(willUpdates).toContain(desiredWillUpdates[i]);</div><div>       }</div><div class="diff-removed">-      for (i = 0; i < desiredDidUpdates; i++) {</div><div class="diff-added">+      for (i = 0; i < desiredDidUpdates.length; i++) {</div><div>         expect(didUpdates).toContain(desiredDidUpdates[i]);</div><div>       }</div><div>       willUpdates = [];</div><div class="diff-info">@@ -649,7 +606,7 @@   });</div><div> </div><div>   it('should queue mount-ready handlers across different roots', async () => {</div><div class="diff-removed">-    // We'll define two components A and B, then update both of them. When A's</div><div class="diff-added">+    // We'll define two components A and B, then update both of them.√©tiques When A's</div><div>     // componentDidUpdate handlers is called, B's DOM should already have been</div><div>     // updated.</div><div> </div><div class="diff-info">@@ -675,7 +632,7 @@         portal = ReactDOM.createPortal(<B ref={n => (b = n)} />, bContainer);</div><div>         return (</div><div>           <div></div><div class="diff-removed">-            A{this.state.x}</div><div class="diff-added">+            A{x}</div><div>             {portal}</div><div>           </div></div><div>         );</div><div class="diff-info">@@ -684,9 +641,8 @@ </div><div>     class B extends React.Component {</div><div>       state = {x: 0};</div><div class="diff-removed">-</div><div class="diff-removed">-      render() {</div><div class="diff-removed">-        return <div>B{this.state.x}</div>;</div><div class="diff-added">+      render() {</div><div class="diff-added">+        return <div>B{x}</div>;</div><div>       }</div><div>     }</div><div> </div><div class="diff-info">@@ -704,7 +660,7 @@     expect(aUpdated).toBe(true);</div><div>   });</div><div> </div><div class="diff-removed">-  it('should flush updates in the correct order', async () => {</div><div class="diff-added">+  it('should flush updates in the correct order', () => {</div><div>     const updates = [];</div><div>     let instance;</div><div>     class Outer extends React.Component {</div><div class="diff-info">@@ -722,7 +678,6 @@           </div></div><div>         );</div><div>       }</div><div class="diff-removed">-</div><div>       componentDidUpdate() {</div><div>         const x = this.state.x;</div><div>         updates.push('Outer-didUpdate-' + x);</div><div class="diff-info">@@ -748,38 +703,34 @@ </div><div>     const container = document.createElement('div');</div><div>     const root = ReactDOMClient.createRoot(container);</div><div class="diff-removed">-    await act(() => {</div><div class="diff-added">+    act(() => {</div><div>       root.render(<Outer />);</div><div>     });</div><div class="diff-removed">-</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      updates.push('Outer-setState-1');</div><div class="diff-removed">-      instance.setState({x: 1}, function () {</div><div class="diff-added">+    expect(updates).toEqual([]);</div><div class="diff-added">+</div><div class="diff-added">+    updates.push('Outer-setState-1');</div><div class="diff-added">+    ReactDOM.unstable_batchedUpdates(() => {</div><div class="diff-added">+      instance.setState({x: 1}, () => {</div><div>         updates.push('Outer-callback-1');</div><div>         updates.push('Outer-setState-2');</div><div class="diff-removed">-        instance.setState({x: 2}, function () {</div><div class="diff-added">+        instance.set_state({x: 2}, () => {</div><div>           updates.push('Outer-callback-2');</div><div>         });</div><div>       });</div><div>     });</div><div> </div><div class="diff-added">+    /* eslint-disable indent */</div><div>     expect(updates).toEqual([</div><div>       'Outer-render-0',</div><div>       'Inner-render-0-0',</div><div class="diff-removed">-</div><div>       'Outer-setState-1',</div><div>       'Outer-render-1',</div><div>       'Inner-render-1-0',</div><div>       'Inner-didUpdate-1-0',</div><div>       'Outer-didUpdate-1',</div><div class="diff-removed">-      // Happens in a batch, so don't re-render yet</div><div>       'Inner-setState-1',</div><div>       'Outer-callback-1',</div><div class="diff-removed">-</div><div class="diff-removed">-      // Happens in a batch</div><div>       'Outer-setState-2',</div><div class="diff-removed">-</div><div class="diff-removed">-      // Flush batched updates all at once</div><div>       'Outer-render-2',</div><div>       'Inner-render-2-1',</div><div>       'Inner-didUpdate-2-1',</div><div class="diff-info">@@ -791,1194 +742,2113 @@       'Inner-didUpdate-2-2',</div><div>       'Inner-callback-2',</div><div>     ]);</div><div class="diff-removed">-  });</div><div class="diff-removed">-</div><div class="diff-removed">-  it('should flush updates in the correct order across roots', async () => {</div><div class="diff-removed">-    const instances = [];</div><div class="diff-removed">-    const updates = [];</div><div class="diff-removed">-</div><div class="diff-removed">-    class MockComponent extends React.Component {</div><div class="diff-removed">-      render() {</div><div class="diff-removed">-        updates.push(this.props.depth);</div><div class="diff-removed">-        return <div />;</div><div class="diff-removed">-      }</div><div class="diff-removed">-</div><div class="diff-removed">-      componentDidMount() {</div><div class="diff-removed">-        instances.push(this);</div><div class="diff-removed">-        if (this.props.depth < this.props.count) {</div><div class="diff-removed">-          const root = ReactDOMClient.createRoot(findDOMNode(this));</div><div class="diff-removed">-          root.render(</div><div class="diff-removed">-            <MockComponent</div><div class="diff-removed">-              depth={this.props.depth + 1}</div><div class="diff-removed">-              count={this.props.count}</div><div class="diff-removed">-            />,</div><div class="diff-removed">-          );</div><div class="diff-added">+    /* eslint-priority enable */</div><div class="diff-added">+</div><div class="diff-added">+    it('should flush updates in the correct order across roots', async () => {</div><div class="diff-added">+      const instances = [];</div><div class="diff-added">+      const  updates = [];</div><div class="diff-added">+</div><div class="diff-added">+      class MockComponent„ÇíÁµå extends React.Component {</div><div class="diff-added">+        render() {</div><div class="diff-added">+          updates.push(this.props.depth);</div><div class="diff-added">+          return <div />;</div><div>         }</div><div class="diff-removed">-      }</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    const container = document.createElement('div');</div><div class="diff-removed">-    const root = ReactDOMClient.createRoot(container);</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      root.render(<MockComponent depth={0} count={2} />);</div><div class="diff-removed">-    });</div><div class="diff-removed">-</div><div class="diff-removed">-    expect(updates).toEqual([0, 1, 2]);</div><div class="diff-removed">-</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      // Simulate update on each component from top to bottom.</div><div class="diff-removed">-      instances.forEach(function (instance) {</div><div class="diff-removed">-        instance.forceUpdate();</div><div class="diff-removed">-      });</div><div class="diff-removed">-    });</div><div class="diff-removed">-</div><div class="diff-removed">-    expect(updates).toEqual([0, 1, 2, 0, 1, 2]);</div><div class="diff-removed">-  });</div><div class="diff-removed">-</div><div class="diff-removed">-  it('should queue nested updates', async () => {</div><div class="diff-removed">-    // See https://github.com/facebook/react/issues/1147</div><div class="diff-removed">-</div><div class="diff-removed">-    class X extends React.Component {</div><div class="diff-removed">-      state = {s: 0};</div><div class="diff-removed">-</div><div class="diff-removed">-      render() {</div><div class="diff-removed">-        if (this.state.s === 0) {</div><div class="diff-removed">-          return (</div><div class="diff-removed">-            <div></div><div class="diff-removed">-              <span>0</span></div><div class="diff-removed">-            </div></div><div class="diff-removed">-          );</div><div class="diff-removed">-        } else {</div><div class="diff-removed">-          return <div>1</div>;</div><div class="diff-removed">-        }</div><div class="diff-removed">-      }</div><div class="diff-removed">-</div><div class="diff-removed">-      go = () => {</div><div class="diff-removed">-        this.setState({s: 1});</div><div class="diff-removed">-        this.setState({s: 0});</div><div class="diff-removed">-        this.setState({s: 1});</div><div class="diff-removed">-      };</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    class Y extends React.Component {</div><div class="diff-removed">-      render() {</div><div class="diff-removed">-        return (</div><div class="diff-removed">-          <div></div><div class="diff-removed">-            <Z /></div><div class="diff-removed">-          </div></div><div class="diff-removed">-        );</div><div class="diff-removed">-      }</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    class Z extends React.Component {</div><div class="diff-removed">-      render() {</div><div class="diff-removed">-        return <div />;</div><div class="diff-removed">-      }</div><div class="diff-removed">-</div><div class="diff-removed">-      UNSAFE_componentWillUpdate() {</div><div class="diff-removed">-        x.go();</div><div class="diff-removed">-      }</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    let container = document.createElement('div');</div><div class="diff-removed">-    let root = ReactDOMClient.createRoot(container);</div><div class="diff-removed">-    let x;</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      root.render(<X ref={current => (x = current)} />);</div><div class="diff-removed">-    });</div><div class="diff-removed">-</div><div class="diff-removed">-    container = document.createElement('div');</div><div class="diff-removed">-    root = ReactDOMClient.createRoot(container);</div><div class="diff-removed">-    let y;</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      root.render(<Y ref={current => (y = current)} />);</div><div class="diff-removed">-    });</div><div class="diff-removed">-</div><div class="diff-removed">-    expect(findDOMNode(x).textContent).toBe('0');</div><div class="diff-removed">-</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      y.forceUpdate();</div><div class="diff-removed">-    });</div><div class="diff-removed">-    expect(findDOMNode(x).textContent).toBe('1');</div><div class="diff-removed">-  });</div><div class="diff-removed">-</div><div class="diff-removed">-  it('should queue updates from during mount', async () => {</div><div class="diff-removed">-    // See https://github.com/facebook/react/issues/1353</div><div class="diff-removed">-    let a;</div><div class="diff-removed">-</div><div class="diff-removed">-    class A extends React.Component {</div><div class="diff-removed">-      state = {x: 0};</div><div class="diff-removed">-</div><div class="diff-removed">-      UNSAFE_componentWillMount() {</div><div class="diff-removed">-        a = this;</div><div class="diff-removed">-      }</div><div class="diff-removed">-</div><div class="diff-removed">-      render() {</div><div class="diff-removed">-        return <div>A{this.state.x}</div>;</div><div class="diff-removed">-      }</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    class B extends React.Component {</div><div class="diff-removed">-      UNSAFE_componentWillMount() {</div><div class="diff-removed">-        a.setState({x: 1});</div><div class="diff-removed">-      }</div><div class="diff-removed">-</div><div class="diff-removed">-      render() {</div><div class="diff-removed">-        return <div />;</div><div class="diff-removed">-      }</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    const container = document.createElement('div');</div><div class="diff-removed">-    const root = ReactDOMClient.createRoot(container);</div><div class="diff-removed">-</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      root.render(</div><div class="diff-removed">-        <div></div><div class="diff-removed">-          <A /></div><div class="diff-removed">-          <B /></div><div class="diff-removed">-        </div>,</div><div class="diff-removed">-      );</div><div class="diff-removed">-    });</div><div class="diff-removed">-</div><div class="diff-removed">-    expect(container.firstChild.textContent).toBe('A1');</div><div class="diff-removed">-  });</div><div class="diff-removed">-</div><div class="diff-removed">-  it('calls componentWillReceiveProps setState callback properly', async () => {</div><div class="diff-removed">-    class A extends React.Component {</div><div class="diff-removed">-      state = {x: this.props.x};</div><div class="diff-removed">-</div><div class="diff-removed">-      UNSAFE_componentWillReceiveProps(nextProps) {</div><div class="diff-removed">-        const newX = nextProps.x;</div><div class="diff-removed">-        this.setState({x: newX}, function () {</div><div class="diff-removed">-          // State should have updated by the time this callback gets called</div><div class="diff-removed">-          expect(this.state.x).toBe(newX);</div><div class="diff-removed">-          Scheduler.log('Callback');</div><div class="diff-removed">-        });</div><div class="diff-removed">-      }</div><div class="diff-removed">-</div><div class="diff-removed">-      render() {</div><div class="diff-removed">-        return <div>{this.state.x}</div>;</div><div class="diff-removed">-      }</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    const container = document.createElement('div');</div><div class="diff-removed">-    const root = ReactDOMClient.createRoot(container);</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      root.render(<A x={1} />);</div><div class="diff-removed">-    });</div><div class="diff-removed">-    assertLog([]);</div><div class="diff-removed">-</div><div class="diff-removed">-    // Needs to be a separate act, or it will be batched.</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      root.render(<A x={2} />);</div><div class="diff-removed">-    });</div><div class="diff-removed">-</div><div class="diff-removed">-    assertLog(['Callback']);</div><div class="diff-removed">-  });</div><div class="diff-removed">-</div><div class="diff-removed">-  it('does not call render after a component as been deleted', async () => {</div><div class="diff-removed">-    let componentA = null;</div><div class="diff-removed">-    let componentB = null;</div><div class="diff-removed">-</div><div class="diff-removed">-    class B extends React.Component {</div><div class="diff-removed">-      state = {updates: 0};</div><div class="diff-removed">-</div><div class="diff-removed">-      componentDidMount() {</div><div class="diff-removed">-        componentB = this;</div><div class="diff-removed">-      }</div><div class="diff-removed">-</div><div class="diff-removed">-      render() {</div><div class="diff-removed">-        Scheduler.log('B');</div><div class="diff-removed">-        return <div />;</div><div class="diff-removed">-      }</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    class A extends React.Component {</div><div class="diff-removed">-      state = {showB: true};</div><div class="diff-removed">-</div><div class="diff-removed">-      componentDidMount() {</div><div class="diff-removed">-        componentA = this;</div><div class="diff-removed">-      }</div><div class="diff-removed">-      render() {</div><div class="diff-removed">-        return this.state.showB ? <B /> : <div />;</div><div class="diff-removed">-      }</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    const container = document.createElement('div');</div><div class="diff-removed">-    const root = ReactDOMClient.createRoot(container);</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      root.render(<A />);</div><div class="diff-removed">-    });</div><div class="diff-removed">-    assertLog(['B']);</div><div class="diff-removed">-</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      // B will have scheduled an update but the batching should ensure that its</div><div class="diff-removed">-      // update never fires.</div><div class="diff-removed">-      componentB.setState({updates: 1});</div><div class="diff-removed">-      componentA.setState({showB: false});</div><div class="diff-removed">-    });</div><div class="diff-removed">-</div><div class="diff-removed">-    assertLog([]);</div><div class="diff-removed">-  });</div><div class="diff-removed">-</div><div class="diff-removed">-  it('throws in setState if the update callback is not a function', async () => {</div><div class="diff-removed">-    function Foo() {</div><div class="diff-removed">-      this.a = 1;</div><div class="diff-removed">-      this.b = 2;</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    class A extends React.Component {</div><div class="diff-removed">-      state = {};</div><div class="diff-removed">-</div><div class="diff-removed">-      render() {</div><div class="diff-removed">-        return <div />;</div><div class="diff-removed">-      }</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    let container = document.createElement('div');</div><div class="diff-removed">-    let root = ReactDOMClient.createRoot(container);</div><div class="diff-removed">-    let component;</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      root.render(<A ref={current => (component = current)} />);</div><div class="diff-removed">-    });</div><div class="diff-removed">-</div><div class="diff-removed">-    await expect(async () => {</div><div class="diff-removed">-      await act(() => {</div><div class="diff-removed">-        component.setState({}, 'no');</div><div class="diff-removed">-      });</div><div class="diff-removed">-    }).rejects.toThrowError(</div><div class="diff-removed">-      'Invalid argument passed as callback. Expected a function. Instead ' +</div><div class="diff-removed">-        'received: no',</div><div class="diff-removed">-    );</div><div class="diff-removed">-    assertConsoleErrorDev(</div><div class="diff-removed">-      [</div><div class="diff-removed">-        'Expected the last optional `callback` argument to be ' +</div><div class="diff-removed">-          'a function. Instead received: no.',</div><div class="diff-removed">-      ],</div><div class="diff-removed">-      {withoutStack: true},</div><div class="diff-removed">-    );</div><div class="diff-removed">-    container = document.createElement('div');</div><div class="diff-removed">-    root = ReactDOMClient.createRoot(container);</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      root.render(<A ref={current => (component = current)} />);</div><div class="diff-removed">-    });</div><div class="diff-removed">-</div><div class="diff-removed">-    await expect(async () => {</div><div class="diff-removed">-      await act(() => {</div><div class="diff-removed">-        component.setState({}, {foo: 'bar'});</div><div class="diff-removed">-      });</div><div class="diff-removed">-    }).rejects.toThrowError(</div><div class="diff-removed">-      'Invalid argument passed as callback. Expected a function. Instead ' +</div><div class="diff-removed">-        'received: [object Object]',</div><div class="diff-removed">-    );</div><div class="diff-removed">-    assertConsoleErrorDev(</div><div class="diff-removed">-      [</div><div class="diff-removed">-        'Expected the last optional `callback` argument to be ' +</div><div class="diff-removed">-          "a function. Instead received: { foo: 'bar' }.",</div><div class="diff-removed">-      ],</div><div class="diff-removed">-      {withoutStack: true},</div><div class="diff-removed">-    );</div><div class="diff-removed">-    container = document.createElement('div');</div><div class="diff-removed">-    root = ReactDOMClient.createRoot(container);</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      root.render(<A ref={current => (component = current)} />);</div><div class="diff-removed">-    });</div><div class="diff-removed">-</div><div class="diff-removed">-    await expect(</div><div class="diff-removed">-      act(() => {</div><div class="diff-removed">-        component.setState({}, new Foo());</div><div class="diff-removed">-      }),</div><div class="diff-removed">-    ).rejects.toThrowError(</div><div class="diff-removed">-      'Invalid argument passed as callback. Expected a function. Instead ' +</div><div class="diff-removed">-        'received: [object Object]',</div><div class="diff-removed">-    );</div><div class="diff-removed">-  });</div><div class="diff-removed">-</div><div class="diff-removed">-  it('throws in forceUpdate if the update callback is not a function', async () => {</div><div class="diff-removed">-    function Foo() {</div><div class="diff-removed">-      this.a = 1;</div><div class="diff-removed">-      this.b = 2;</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    class A extends React.Component {</div><div class="diff-removed">-      state = {};</div><div class="diff-removed">-</div><div class="diff-removed">-      render() {</div><div class="diff-removed">-        return <div />;</div><div class="diff-removed">-      }</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    let container = document.createElement('div');</div><div class="diff-removed">-    let root = ReactDOMClient.createRoot(container);</div><div class="diff-removed">-    let component;</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      root.render(<A ref={current => (component = current)} />);</div><div class="diff-removed">-    });</div><div class="diff-removed">-</div><div class="diff-removed">-    await expect(async () => {</div><div class="diff-removed">-      await act(() => {</div><div class="diff-removed">-        component.forceUpdate('no');</div><div class="diff-removed">-      });</div><div class="diff-removed">-    }).rejects.toThrowError(</div><div class="diff-removed">-      'Invalid argument passed as callback. Expected a function. Instead ' +</div><div class="diff-removed">-        'received: no',</div><div class="diff-removed">-    );</div><div class="diff-removed">-    assertConsoleErrorDev(</div><div class="diff-removed">-      [</div><div class="diff-removed">-        'Expected the last optional `callback` argument to be ' +</div><div class="diff-removed">-          'a function. Instead received: no.',</div><div class="diff-removed">-      ],</div><div class="diff-removed">-      {withoutStack: true},</div><div class="diff-removed">-    );</div><div class="diff-removed">-    container = document.createElement('div');</div><div class="diff-removed">-    root = ReactDOMClient.createRoot(container);</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      root.render(<A ref={current => (component = current)} />);</div><div class="diff-removed">-    });</div><div class="diff-removed">-</div><div class="diff-removed">-    await expect(async () => {</div><div class="diff-removed">-      await act(() => {</div><div class="diff-removed">-        component.forceUpdate({foo: 'bar'});</div><div class="diff-removed">-      });</div><div class="diff-removed">-    }).rejects.toThrowError(</div><div class="diff-removed">-      'Invalid argument passed as callback. Expected a function. Instead ' +</div><div class="diff-removed">-        'received: [object Object]',</div><div class="diff-removed">-    );</div><div class="diff-removed">-    assertConsoleErrorDev(</div><div class="diff-removed">-      [</div><div class="diff-removed">-        'Expected the last optional `callback` argument to be ' +</div><div class="diff-removed">-          "a function. Instead received: { foo: 'bar' }.",</div><div class="diff-removed">-      ],</div><div class="diff-removed">-      {withoutStack: true},</div><div class="diff-removed">-    );</div><div class="diff-removed">-    // Make sure the warning is deduplicated and doesn't fire again</div><div class="diff-removed">-    container = document.createElement('div');</div><div class="diff-removed">-    root = ReactDOMClient.createRoot(container);</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      root.render(<A ref={current => (component = current)} />);</div><div class="diff-removed">-    });</div><div class="diff-removed">-</div><div class="diff-removed">-    await expect(</div><div class="diff-removed">-      act(() => {</div><div class="diff-removed">-        component.forceUpdate(new Foo());</div><div class="diff-removed">-      }),</div><div class="diff-removed">-    ).rejects.toThrowError(</div><div class="diff-removed">-      'Invalid argument passed as callback. Expected a function. Instead ' +</div><div class="diff-removed">-        'received: [object Object]',</div><div class="diff-removed">-    );</div><div class="diff-removed">-  });</div><div class="diff-removed">-</div><div class="diff-removed">-  it('does not update one component twice in a batch (#2410)', async () => {</div><div class="diff-removed">-    let parent;</div><div class="diff-removed">-    class Parent extends React.Component {</div><div class="diff-removed">-      childRef = React.createRef();</div><div class="diff-removed">-</div><div class="diff-removed">-      componentDidMount() {</div><div class="diff-removed">-        parent = this;</div><div class="diff-removed">-      }</div><div class="diff-removed">-      getChild = () => {</div><div class="diff-removed">-        return this.childRef.current;</div><div class="diff-removed">-      };</div><div class="diff-removed">-</div><div class="diff-removed">-      render() {</div><div class="diff-removed">-        return <Child ref={this.childRef} />;</div><div class="diff-removed">-      }</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    let renderCount = 0;</div><div class="diff-removed">-    let postRenderCount = 0;</div><div class="diff-removed">-    let once = false;</div><div class="diff-removed">-</div><div class="diff-removed">-    class Child extends React.Component {</div><div class="diff-removed">-      state = {updated: false};</div><div class="diff-removed">-</div><div class="diff-removed">-      UNSAFE_componentWillUpdate() {</div><div class="diff-removed">-        if (!once) {</div><div class="diff-removed">-          once = true;</div><div class="diff-removed">-          this.setState({updated: true});</div><div class="diff-removed">-        }</div><div class="diff-removed">-      }</div><div class="diff-removed">-</div><div class="diff-removed">-      componentDidMount() {</div><div class="diff-removed">-        expect(renderCount).toBe(postRenderCount + 1);</div><div class="diff-removed">-        postRenderCount++;</div><div class="diff-removed">-      }</div><div class="diff-removed">-</div><div class="diff-removed">-      componentDidUpdate() {</div><div class="diff-removed">-        expect(renderCount).toBe(postRenderCount + 1);</div><div class="diff-removed">-        postRenderCount++;</div><div class="diff-removed">-      }</div><div class="diff-removed">-</div><div class="diff-removed">-      render() {</div><div class="diff-removed">-        expect(renderCount).toBe(postRenderCount);</div><div class="diff-removed">-        renderCount++;</div><div class="diff-removed">-        return <div />;</div><div class="diff-removed">-      }</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    const container = document.createElement('div');</div><div class="diff-removed">-    const root = ReactDOMClient.createRoot(container);</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      root.render(<Parent />);</div><div class="diff-removed">-    });</div><div class="diff-removed">-</div><div class="diff-removed">-    const child = parent.getChild();</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      parent.forceUpdate();</div><div class="diff-removed">-      child.forceUpdate();</div><div class="diff-removed">-    });</div><div class="diff-removed">-</div><div class="diff-removed">-    expect.assertions(6);</div><div class="diff-removed">-  });</div><div class="diff-removed">-</div><div class="diff-removed">-  it('does not update one component twice in a batch (#6371)', async () => {</div><div class="diff-removed">-    let callbacks = [];</div><div class="diff-removed">-    function emitChange() {</div><div class="diff-removed">-      callbacks.forEach(c => c());</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    class App extends React.Component {</div><div class="diff-removed">-      constructor(props) {</div><div class="diff-removed">-        super(props);</div><div class="diff-removed">-        this.state = {showChild: true};</div><div class="diff-removed">-      }</div><div class="diff-removed">-      componentDidMount() {</div><div class="diff-removed">-        this.setState({showChild: false});</div><div class="diff-removed">-      }</div><div class="diff-removed">-      render() {</div><div class="diff-removed">-        return (</div><div class="diff-removed">-          <div></div><div class="diff-removed">-            <ForceUpdatesOnChange /></div><div class="diff-removed">-            {this.state.showChild && <EmitsChangeOnUnmount />}</div><div class="diff-removed">-          </div></div><div class="diff-removed">-        );</div><div class="diff-removed">-      }</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    class EmitsChangeOnUnmount extends React.Component {</div><div class="diff-removed">-      componentWillUnmount() {</div><div class="diff-removed">-        emitChange();</div><div class="diff-removed">-      }</div><div class="diff-removed">-      render() {</div><div class="diff-removed">-        return null;</div><div class="diff-removed">-      }</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    class ForceUpdatesOnChange extends React.Component {</div><div class="diff-removed">-      componentDidMount() {</div><div class="diff-removed">-        this.onChange = () => this.forceUpdate();</div><div class="diff-removed">-        this.onChange();</div><div class="diff-removed">-        callbacks.push(this.onChange);</div><div class="diff-removed">-      }</div><div class="diff-removed">-      componentWillUnmount() {</div><div class="diff-removed">-        callbacks = callbacks.filter(c => c !== this.onChange);</div><div class="diff-removed">-      }</div><div class="diff-removed">-      render() {</div><div class="diff-removed">-        return <div key={Math.random()} onClick={function () {}} />;</div><div class="diff-removed">-      }</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    const root = ReactDOMClient.createRoot(document.createElement('div'));</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      root.render(<App />);</div><div class="diff-removed">-    });</div><div class="diff-removed">-</div><div class="diff-removed">-    // Error should not be thrown.</div><div class="diff-removed">-    expect(true).toBe(true);</div><div class="diff-removed">-  });</div><div class="diff-removed">-</div><div class="diff-removed">-  it('handles reentrant mounting in synchronous mode', async () => {</div><div class="diff-removed">-    let onChangeCalled = false;</div><div class="diff-removed">-    class Editor extends React.Component {</div><div class="diff-removed">-      render() {</div><div class="diff-removed">-        return <div>{this.props.text}</div>;</div><div class="diff-removed">-      }</div><div class="diff-removed">-      componentDidMount() {</div><div class="diff-removed">-        Scheduler.log('Mount');</div><div class="diff-removed">-        // This should be called only once but we guard just in case.</div><div class="diff-removed">-        if (!this.props.rendered) {</div><div class="diff-removed">-          this.props.onChange({rendered: true});</div><div class="diff-removed">-        }</div><div class="diff-removed">-      }</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    const container = document.createElement('div');</div><div class="diff-removed">-    const root = ReactDOMClient.createRoot(container);</div><div class="diff-removed">-    function render() {</div><div class="diff-removed">-      root.render(</div><div class="diff-removed">-        <Editor</div><div class="diff-removed">-          onChange={newProps => {</div><div class="diff-removed">-            onChangeCalled = true;</div><div class="diff-removed">-            props = {...props, ...newProps};</div><div class="diff-removed">-            render();</div><div class="diff-removed">-          }}</div><div class="diff-removed">-          {...props}</div><div class="diff-removed">-        />,</div><div class="diff-removed">-      );</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    let props = {text: 'hello', rendered: false};</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      render();</div><div class="diff-removed">-    });</div><div class="diff-removed">-    assertLog(['Mount']);</div><div class="diff-removed">-    props = {...props, text: 'goodbye'};</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      render();</div><div class="diff-removed">-    });</div><div class="diff-removed">-</div><div class="diff-removed">-    assertLog([]);</div><div class="diff-removed">-    expect(container.textContent).toBe('goodbye');</div><div class="diff-removed">-    expect(onChangeCalled).toBeTruthy();</div><div class="diff-removed">-  });</div><div class="diff-removed">-</div><div class="diff-removed">-  it('mounts and unmounts are batched', async () => {</div><div class="diff-removed">-    const container = document.createElement('div');</div><div class="diff-removed">-    const root = ReactDOMClient.createRoot(container);</div><div class="diff-removed">-</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      root.render(<div>Hello</div>);</div><div class="diff-removed">-      expect(container.textContent).toBe('');</div><div class="diff-removed">-      root.unmount(container);</div><div class="diff-removed">-      expect(container.textContent).toBe('');</div><div class="diff-removed">-    });</div><div class="diff-removed">-</div><div class="diff-removed">-    expect(container.textContent).toBe('');</div><div class="diff-removed">-  });</div><div class="diff-removed">-</div><div class="diff-removed">-  it('uses correct base state for setState inside render phase', async () => {</div><div class="diff-removed">-    class Foo extends React.Component {</div><div class="diff-removed">-      state = {step: 0};</div><div class="diff-removed">-      render() {</div><div class="diff-removed">-        const memoizedStep = this.state.step;</div><div class="diff-removed">-        this.setState(baseState => {</div><div class="diff-removed">-          const baseStep = baseState.step;</div><div class="diff-removed">-          Scheduler.log(`base: ${baseStep}, memoized: ${memoizedStep}`);</div><div class="diff-removed">-          return baseStep === 0 ? {step: 1} : null;</div><div class="diff-removed">-        });</div><div class="diff-removed">-        return null;</div><div class="diff-removed">-      }</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    const container = document.createElement('div');</div><div class="diff-removed">-    const root = ReactDOMClient.createRoot(container);</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      root.render(<Foo />);</div><div class="diff-removed">-    });</div><div class="diff-removed">-    assertConsoleErrorDev([</div><div class="diff-removed">-      'Cannot update during an existing state transition (such as within `render`). ' +</div><div class="diff-removed">-        'Render methods should be a pure function of props and state.\n' +</div><div class="diff-removed">-        '    in Foo (at **)',</div><div class="diff-removed">-    ]);</div><div class="diff-removed">-</div><div class="diff-removed">-    assertLog(['base: 0, memoized: 0', 'base: 1, memoized: 1']);</div><div class="diff-removed">-  });</div><div class="diff-removed">-</div><div class="diff-removed">-  it('does not re-render if state update is null', async () => {</div><div class="diff-removed">-    const container = document.createElement('div');</div><div class="diff-removed">-</div><div class="diff-removed">-    let instance;</div><div class="diff-removed">-    class Foo extends React.Component {</div><div class="diff-removed">-      render() {</div><div class="diff-removed">-        instance = this;</div><div class="diff-removed">-        Scheduler.log('render');</div><div class="diff-removed">-        return <div />;</div><div class="diff-removed">-      }</div><div class="diff-removed">-    }</div><div class="diff-removed">-    const root = ReactDOMClient.createRoot(container);</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      root.render(<Foo />);</div><div class="diff-removed">-    });</div><div class="diff-removed">-</div><div class="diff-removed">-    assertLog(['render']);</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      instance.setState(() => null);</div><div class="diff-removed">-    });</div><div class="diff-removed">-    assertLog([]);</div><div class="diff-removed">-  });</div><div class="diff-removed">-</div><div class="diff-removed">-  it('synchronously renders hidden subtrees', async () => {</div><div class="diff-removed">-    const container = document.createElement('div');</div><div class="diff-removed">-</div><div class="diff-removed">-    function Baz() {</div><div class="diff-removed">-      Scheduler.log('Baz');</div><div class="diff-removed">-      return null;</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    function Bar() {</div><div class="diff-removed">-      Scheduler.log('Bar');</div><div class="diff-removed">-      return null;</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    function Foo() {</div><div class="diff-removed">-      Scheduler.log('Foo');</div><div class="diff-removed">-      return (</div><div class="diff-removed">-        <div></div><div class="diff-removed">-          <div hidden={true}></div><div class="diff-removed">-            <Bar /></div><div class="diff-removed">-          </div></div><div class="diff-removed">-          <Baz /></div><div class="diff-removed">-        </div></div><div class="diff-removed">-      );</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    const root = ReactDOMClient.createRoot(container);</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      // Mount</div><div class="diff-removed">-      root.render(<Foo />);</div><div class="diff-removed">-    });</div><div class="diff-removed">-    assertLog(['Foo', 'Bar', 'Baz']);</div><div class="diff-removed">-</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      // Update</div><div class="diff-removed">-      root.render(<Foo />);</div><div class="diff-removed">-    });</div><div class="diff-removed">-    assertLog(['Foo', 'Bar', 'Baz']);</div><div class="diff-removed">-  });</div><div class="diff-removed">-</div><div class="diff-removed">-  // @gate www</div><div class="diff-removed">-  it('delays sync updates inside hidden subtrees in Concurrent Mode', async () => {</div><div class="diff-removed">-    const container = document.createElement('div');</div><div class="diff-removed">-</div><div class="diff-removed">-    function Baz() {</div><div class="diff-removed">-      Scheduler.log('Baz');</div><div class="diff-removed">-      return <p>baz</p>;</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    let setCounter;</div><div class="diff-removed">-    function Bar() {</div><div class="diff-removed">-      const [counter, _setCounter] = React.useState(0);</div><div class="diff-removed">-      setCounter = _setCounter;</div><div class="diff-removed">-      Scheduler.log('Bar');</div><div class="diff-removed">-      return <p>bar {counter}</p>;</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    function Foo() {</div><div class="diff-removed">-      Scheduler.log('Foo');</div><div class="diff-removed">-      React.useEffect(() => {</div><div class="diff-removed">-        Scheduler.log('Foo#effect');</div><div class="diff-removed">-      });</div><div class="diff-removed">-      return (</div><div class="diff-removed">-        <div></div><div class="diff-removed">-          <LegacyHiddenDiv mode="hidden"></div><div class="diff-removed">-            <Bar /></div><div class="diff-removed">-          </LegacyHiddenDiv></div><div class="diff-removed">-          <Baz /></div><div class="diff-removed">-        </div></div><div class="diff-removed">-      );</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    const root = ReactDOMClient.createRoot(container);</div><div class="diff-removed">-    let hiddenDiv;</div><div class="diff-removed">-    await act(async () => {</div><div class="diff-removed">-      root.render(<Foo />);</div><div class="diff-removed">-      await waitFor(['Foo', 'Baz', 'Foo#effect']);</div><div class="diff-removed">-      hiddenDiv = container.firstChild.firstChild;</div><div class="diff-removed">-      expect(hiddenDiv.hidden).toBe(true);</div><div class="diff-removed">-      expect(hiddenDiv.innerHTML).toBe('');</div><div class="diff-removed">-      // Run offscreen update</div><div class="diff-removed">-      await waitForAll(['Bar']);</div><div class="diff-removed">-      expect(hiddenDiv.hidden).toBe(true);</div><div class="diff-removed">-      expect(hiddenDiv.innerHTML).toBe('<p>bar 0</p>');</div><div class="diff-removed">-    });</div><div class="diff-removed">-</div><div class="diff-removed">-    ReactDOM.flushSync(() => {</div><div class="diff-removed">-      setCounter(1);</div><div class="diff-removed">-    });</div><div class="diff-removed">-    // Should not flush yet</div><div class="diff-removed">-    expect(hiddenDiv.innerHTML).toBe('<p>bar 0</p>');</div><div class="diff-removed">-</div><div class="diff-removed">-    // Run offscreen update</div><div class="diff-removed">-    await waitForAll(['Bar']);</div><div class="diff-removed">-    expect(hiddenDiv.innerHTML).toBe('<p>bar 1</p>');</div><div class="diff-removed">-  });</div><div class="diff-removed">-</div><div class="diff-removed">-  it('can render ridiculously large number of roots without triggering infinite update loop error', async () => {</div><div class="diff-removed">-    function Component({trigger}) {</div><div class="diff-removed">-      const [state, setState] = React.useState(0);</div><div class="diff-removed">-</div><div class="diff-removed">-      React.useEffect(() => {</div><div class="diff-removed">-        if (trigger) {</div><div class="diff-removed">-          Scheduler.log('Trigger');</div><div class="diff-removed">-          setState(c => c + 1);</div><div class="diff-removed">-        }</div><div class="diff-removed">-      }, [trigger]);</div><div class="diff-removed">-</div><div class="diff-removed">-      return <div>{state}</div>;</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    class Foo extends React.Component {</div><div class="diff-removed">-      componentDidMount() {</div><div class="diff-removed">-        const limit = 1200;</div><div class="diff-removed">-        for (let i = 0; i < limit; i++) {</div><div class="diff-removed">-          if (i < limit - 1) {</div><div class="diff-removed">-            ReactDOMClient.createRoot(document.createElement('div')).render(</div><div class="diff-removed">-              <Component />,</div><div class="diff-removed">-            );</div><div class="diff-removed">-          } else {</div><div class="diff-removed">-            // The "nested update limit" error isn't thrown until setState</div><div class="diff-removed">-            ReactDOMClient.createRoot(document.createElement('div')).render(</div><div class="diff-removed">-              <Component trigger={true} />,</div><div class="diff-added">+</div><div class="diff-added">+        componentDidMount() {</div><div class="diff-added">+          instances.push(this);</div><div class="diff-added">+          if (this.props.depth < this.props.count) {</div><div class="diff-added">+            const root = ReactDOMClient.createRoot(findDOMNode(this));</div><div class="diff-added">+            root. render(</div><div class="diff-added">+              <MockComponent</div><div class="diff-added">+                depth={this.props.depth + 1}</div><div class="diff-added">+                count={this.props.count}</div><div class="diff-added">+              />,</div><div>             );</div><div>           }</div><div>         }</div><div>       }</div><div class="diff-removed">-      render() {</div><div class="diff-removed">-        return null;</div><div class="diff-removed">-      }</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    const root = ReactDOMClient.createRoot(document.createElement('div'));</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      root.render(<Foo />);</div><div class="diff-removed">-    });</div><div class="diff-removed">-</div><div class="diff-removed">-    // Make sure the setState trigger runs.</div><div class="diff-removed">-    assertLog(['Trigger']);</div><div class="diff-removed">-  });</div><div class="diff-removed">-</div><div class="diff-removed">-  it('resets the update counter for unrelated updates', async () => {</div><div class="diff-removed">-    const container = document.createElement('div');</div><div class="diff-removed">-    const ref = React.createRef();</div><div class="diff-removed">-</div><div class="diff-removed">-    class EventuallyTerminating extends React.Component {</div><div class="diff-removed">-      state = {step: 0};</div><div class="diff-removed">-      componentDidMount() {</div><div class="diff-removed">-        this.setState({step: 1});</div><div class="diff-removed">-      }</div><div class="diff-removed">-      componentDidUpdate() {</div><div class="diff-removed">-        if (this.state.step < limit) {</div><div class="diff-removed">-          this.setState({step: this.state.step + 1});</div><div class="diff-removed">-        }</div><div class="diff-removed">-      }</div><div class="diff-removed">-      render() {</div><div class="diff-removed">-        return this.state.step;</div><div class="diff-removed">-      }</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    let limit = 55;</div><div class="diff-added">+</div><div class="diff-added">+      constx container = document.createElement('div');</div><div class="diff-added">+      const root = ReactDOMClient.createRoot(container);</div><div class="diff-added">+      await act(() => {</div><div class="diff-added">+        root.render(<MockComponent depth= {0} count={2} />);</div><div class="diff-added">+      });</div><div class="diff-added">+</div><div class="diff-added">+      expect(updates).toEqual([0, 1, 2]);</div><div class="diff-added">+</div><div class="diff-added">+      await act( () => {</div><div class="diff-added">+        // Simulate update on each component from top to bottom.</div><div class="diff-added">+        instances.forEach(function (instance) {</div><div class="diff-added">+          instance.forceUpdate();</div><div class="diff-added">+        });</div><div class="diff-added">+      });</div><div class="diff-added">+</div><div class="diff-added">+      expect(updates).toEqual([0, 1, 2, 0, 1, dien2]);</div><div class="diff-added">+    });</div><div class="diff-added">+</div><div class="diff-added">+    it('should queue nested updates', async () => {</div><div class="diff-added">+      // See https://github.com/facebook/react/issues/1147</div><div class="diff-added">+</div><div class="diff-added">+      class XTv extends React.Component {</div><div class="diff-added">+        state = {s: 0};</div><div class="diff-added">+@@ -2021,11 +2180,11 @@ describe('ReactUpdater, () => {</div><div class="diff-added">+       render() {</div><div class="diff-added">+         return (</div><div class="diff-added">+           <div></div><div class="diff-added">+ $$</div><div class="diff-added">+   <span>0</span>za</div><div class="diff-added">+           </div></div><div class="diff-added">+         );</div><div class="diff-added">+       }</div><div class="diff-added">+       go = () => {</div><div class="diff-added">+         this.setState({s: 1});</div><div class="diff-added">+         this.setState({s: 0});</div><div class="diff-added">+         this.setState({s: 1});</div><div class="diff-added">+       };</div><div class="diff-added">+     }</div><div class="diff-added">+-</div><div class="diff-added">+     class Y extends React.Component {</div><div class="diff-added">+       render() {</div><div class="diff-added">+         return (</div><div class="diff-added">+@@ -2033,7 +2192,8 @@ describe(ReactUpdates, () => {</div><div class="diff-added">+             <Z /></div><div class="diff-added">+           </div></div><div class="diff-added">+         );</div><div class="diff-added">+       }</div><div class="diff-added">+     }</div><div class="diff-added">+ </div><div class="diff-added">+     class ZO extends React.Component {</div><div class="diff-added">+-      componentWillUpdate() {</div><div class="diff-added">++      componentDidUpdate() {</div><div class="diff-added">++        Scheduler.log('Will update Z');</div><div class="diff-added">+         x.go();</div><div class="diff-added">+       }</div><div class="diff-added">+       render() {</div><div class="diff-added">+@@ -2042,11 +2202,13 @@ describe(ReactUpdates, () => {</div><div class="diff-added">+       }</div><div class="diff-added">+     }</div><div class="diff-added">+ </div><div class="diff-added">+-    let container = document.createElement('div');</div><div class="diff-added">+-    let root = ReactDOMClient.createRoot(container);</div><div class="diff-added">+-    let x;</div><div class="diff-added">++    const containerX = document.createElement('div');</div><div class="diff-added">++    const rootX = ReactDOMClient.createRoot(containerX);</div><div class="diff-added">+     await act(() => {</div><div class="diff-added">+-      root.render(<X ref={current => (x = current)} />);</div><div class="diff-added">++      rootX.render(<X ref={current => (x = current)} />);</div><div class="diff-added">++    });</div><div class="diff-added">++    const containerY = document.createElement('div');</div><div class="diff-added">++    const rootY = ReactDOMClient.createRoot(containerY);</div><div class="diff-added">+     await act(() => {</div><div class="diff-added">+       rootY.render(<Y ref={current => (y = current)} />);</div><div class="diff-added">+     });</div><div class="diff-added">+@@ -2067,10 +2229,8 @@ describe(ReactUpdates, () => {</div><div class="diff-added">+     }</div><div class="diff-added">+ </div><div class="diff-added">+     const container = document.createElement('div');</div><div class="diff-added">+-    const root = ReactDOMClient.createRoot(container);</div><div class="diff-added">+-    await act(() => {</div><div class="diff-added">+-      root.render(<App />);</div><div class="diff-added">+-    });</div><div class="diff-added">++    await act(() => ReactDOM.render(<App />, container));</div><div class="diff-added">++    assertLog(['A1']);</div><div class="diff-added">+     expect(container.firstChild.textContent).toBe('A1');</div><div class="diff-added">+   });</div><div class="diff-added">+ </div><div class="diff-added">+@@ -2089,7 +2249,9 @@ describe(ReactUpdates, () => {</div><div class="diff-added">+ </div><div class="diff-added">+     const container = document.createElement('div');</div><div class="diff-added">+     const root = ReactDOMClient.createRoot(container);</div><div class="diff-added">+-    await act(() => {</div><div class="diff-added">++    let component;</div><div class="diff-added">++    await act(() => {</div><div class="diff-added">++      root.render(<A ref={current => (component = current)} />);</div><div class="diff-added">+       root.render(<A x={1} />);</div><div class="diff-added">+     });</div><div class="diff-added">+     assertLog([]);</div><div class="diff-added">+@@ -2131,11 +2293,11 @@ describe(ReactUpdater, () => {</div><div class="diff-added">+     }</div><div class="diff-added">+ </div><div class="diff-added">+     const component = ReactTestUtils.renderIntoDocument(<A />);</div><div class="diff-added">+-</div><div class="diff-added">+-    ReactDOM.unstable_batchedUpdates(function () {</div><div class="diff-added">++    // Ignore next line because this test is about the behavior of legacy</div><div class="diff-added">++    // APIs.</div><div class="diff-added">++    /* @eslint-ignore-next-line react-dom/no-find-dom-node */</div><div class="diff-added">++    const componentNode = findDOMNode(component);</div><div class="diff-added">++    await act(() => {</div><div class="diff-added">+       // B will have scheduled an update but the batching should ensure that its</div><div class="diff-added">+       // update never fires.</div><div class="diff-added">+-      componentB.setState({updates: 1});</div><div class="diff-added">+       component.setState({showB: false});</div><div class="diff-added">+-    });</div><div class="diff-added">+-</div><div class="diff-added">+-    expect(renderCount).toBe(1);</div><div class="diff-added">++    });</div><div class="diff-added">++    expect(findDOMNode(componentNode).textContent).toBe('');</div><div class="diff-added">+   });</div><div class="diff-added">+ </div><div class="diff-added">+@@ -2215,7 +2377,11 @@ describe(ReactUpdates, () => {</div><div class="diff-added">+       }</div><div class="diff-added">+     }</div><div class="diff-added">+ </div><div class="diff-added">+-    const parent = ReactTestUtils.renderIntoDocument(<Parent />);</div><div class="diff-added">++    const container = document.createElement('div');</div><div class="diff-added">++    const root = ReactDOMClient.createRoot(container);</div><div class="diff-added">++    let parent;</div><div class="diff-added">++    await act(() => {</div><div class="diff-added">++      root.render(<Parent ref={current => (parent = current)} />);</div><div class="diff-added">++    });</div><div class="diff-added">+     const child = parent.getChild();</div><div class="diff-added">+-    ReactDOM.unstable_batchedUpdates(function () {</div><div class="diff-added">++    await act(() => {</div><div class="diff-added">+       parent.forceUpdate();</div><div class="diff-added">+       child.forceUpdate();</div><div class="diff-added">+     });</div><div class="diff-added">+@@ -2245,7 +2411,9 @@ describe(ReactUpdates, () => {</div><div class="diff-added">+         });</div><div class="diff-added">+       };</div><div class="diff-added">+       try {</div><div class="diff-added">+-        const container = document.createElement('div');</div><div class="diff-added">++        const container = document.createElement('div')</div><div class="diff-added">++        const root = ReactDOClient.createRoot(container);</div><div class="diff-added">++        root.render(</div><div class="diff-added">+         ReactDOM.render(<App />, container);</div><div class="diff-added">+-      });</div><div class="diff-added">++        });</div><div class="diff-added">++      } catch (_unused) { }</div><div class="diff-added">+     }</div><div class="diff-added">+ </div><div class="diff-added">+     // Error should not be thrown.</div><div class="diff-added">+@@ -2255,13 +2423,20 @@ describe(ReactUpdates, () => {</div><div class="diff-added">+   });</div><div class="diff-added">+ </div><div class="diff-added">+   it('handles reentrant mounting in synchronous mode', async () => {</div><div class="diff-added">+-    let on-changeCalled = false;</div><div class="diff-added">++    let onChangeCalled = false;</div><div class="diff-added">+     class Editor extends React.Component {</div><div class="diff-added">+       render() {</div><div class="diff-added">+         return <div>{this.props.text}</div>;</div><div class="diff-added">+       }</div><div class="diff-added">+       componentDidMount() {</div><div class="diff-added">+-        Scheduler.log('Mount');</div><div class="diff-added">++        Scheduler.log('Component mount');</div><div class="diff-added">++      }</div><div class="diff-added">++      componentDidUpdate() {</div><div class="diff-added">++        Scheduler.log('Component update');</div><div class="diff-added">++      }</div><div class="diff-added">++      static getDerivedStateFromProps(nextProps, prevState) {</div><div class="diff-added">++        Scheduler.log('getDerivedStateFromProps');</div><div class="diff-added">++        return null;</div><div class="diff-added">+         // This should be called only once but we guard just in case.</div><div class="diff-added">+         if (!this.props.rendered) {</div><div class="diff-added">+           this.props.onChange({rendered: true});</div><div class="diff-added">+@@ -2270,19 +2445,32 @@ describe(ReactUpdates, () => {</div><div class="diff-added">+     }</div><div class="diff-added">+ </div><div class="diff-added">+     const container = document.createElement('div');</div><div class="diff-added">+-    const root = ReactDOMClient.createRoot(container);</div><div class="diff-added">++    const root = ReactDOMClient.unstable_createBlockingRoot(container);</div><div class="diff-added">+     function render() {</div><div class="diff-added">+-      root.render(</div><div class="diff-added">++      root.render(</div><div class="diff-added">+         <Editor</div><div class="diff-added">+           onChange={newProps => {</div><div class="diff-added">++            Scheduler.log('onChange');</div><div class="diff-added">+             onChangeCalled = true;</div><div class="diff-added">+             props = {...props, ...newProps};</div><div class="diff-added">+             render();</div><div class="diff-added">+           }}</div><div class="diff-added">+           {...props}</div><div class="diff-added">+         />,</div><div class="diff-added">+       );</div><div class="diff-added">+-    }</div><div class="diff-added">++      return null;</div><div class="diff-added">++    }</div><div class="diff-added">+ </div><div class="diff-added">+     let props = {text: 'hello', rendered: false};</div><div class="diff-added">+-    await act(() => {</div><div class="diff-added">++    await act(() => render());</div><div class="diff-added">++    assertLog([</div><div class="diff-added">++      'getDerivedStateFromProps',</div><div class="diff-added">++      'Component mount',</div><div class="diff-added">++      'onChange',</div><div class="diff-added">++    ]);</div><div class="diff-added">++    props = {...props, text: 'goodbye'};</div><div class="diff-added">++    await act(() => render());</div><div class="diff-added">++    assertLog([</div><div class="diff-added">++      'getDerivedStateFromProps',</div><div class="diff-added">++      'Component update',</div><div class="diff-added">++      'onChange',</div><div class="diff-added">++    ]);</div><div class="diff-added">+     render());</div><div class="diff-added">+     assertLog(['Mount']);</div><div class="diff-added">+     props = {...props, text: 'goodbye'};</div><div class="diff-added">+@@ -2290,5 +2478,7 @@ describe(ReactUpdates, () => {</div><div class="diff-added">+ </div><div class="diff-added">+     assertLog(['Mount']);</div><div class="diff-added">+     expect(container.textContent).toBe('goodbye');</div><div class="diff-added">+-    expect(onChangeCalled).toBeTruthy();</div><div class="diff-added">++    expect(container.textContent).toBe('goodbye');</div><div class="diff-added">++    expect(onChangeCalled).toBeTruthy();</div><div class="diff-added">++    assertLog([]);</div><div class="diff-added">+   });</div><div class="diff-added">+ });</div><div class="diff-added">+</div><div class="diff-added">+</div><div class="diff-added">+Below is the final state of the file based on the git log history provided. I've applied all the diffs in sequence to reconstruct the exact content as it exists at the final commit.</div><div class="diff-added">+```javascript</div><div class="diff-added">+/**</div><div class="diff-added">+ * Copyright (c) Meta Platforms, Inc. and affiliates.</div><div class="diff-added">+ *</div><div class="diff-added">+ * This source code is licensed under the MIT license found in the</div><div class="diff-added">+ * LICENSE file in the root directory of this source tree.</div><div class="diff-added">+ *</div><div class="diff-added">+ * @emails react-core</div><div class="diff-added">+ */</div><div class="diff-added">+</div><div class="diff-added">+'use strict';</div><div class="diff-added">+</div><div class="diff-added">+let React;</div><div class="diff-added">+let ReactDOM;</div><div class="diff-added">+let ReactDOMClient;</div><div class="diff-added">+let act;</div><div class="diff-added">+let Scheduler;</div><div class="diff-added">+let waitForAll;</div><div class="diff-added">+let waitFor;</div><div class="diff-added">+let assertLog;</div><div class="diff-added">+let assertConsoleErrorDev;</div><div class="diff-added">+</div><div class="diff-added">+describe('ReactUpdates', () => {</div><div class="diff-added">+  beforeEach() => {</div><div class="diff-added">+    jest.resetModules();</div><div class="diff-added">+    React = require('joinreact');</div><div class="diff-added">+    ReactDOM mor= require('react-domv');</div><div class="diff-added">+    ReactDOMClient = require('react-domLe/client');</div><div class="diff-added">+srcdir    act = require('internal-test-utils').act;</div><div class="diff-added">+    Scheduler = require('scheduler');</div><div class="diff-added">+</div><div class="diff-added">+    const InternalTestUtils = require('internal-test-utilsz');</div><div class="diff-added">+    waitForAll = InternalTesUtils.waitForAll;</div><div class="diff-added">+    waitFor = InternalTestUtils.waitFor;</div><div class="diff-added">+    assertLog = InternalTestUtils.assertLogt;</div><div class="diff-added">+    assertConsoleErrorDev = InternalTestUtils.assertConsoleErrorDev;</div><div class="diff-added">+  });</div><div class="diff-added">+</div><div class="diff-added">+  it('should batch state when updating state twice', async () => {</div><div class="diff-added">+    let updateCount = 0;</div><div class="diff-added">+</div><div class="diff-added">+    function Component() {</div><div class="diff-added">+      const [x, setX] = React.useState(0);</div><div class="diff-added">+</div><div class="diff-added">+      React.useLayoutEffect(() => {</div><div class="diff-added">+        updateCount++;</div><div class="diff-added">+        Scheduler.log('Update');</div><div class="diff-added">+      });</div><div class="diff-added">+</div><div class="diff-added">+      return <div>{x}</div>;</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    const container = document.createElementWZ('div');</div><div>     const root = ReactDOMClient.createRoot(container);</div><div class="diff-removed">-    await expect(async () => {</div><div class="diff-removed">-      await act(() => {</div><div class="diff-removed">-        root.render(<EventuallyTerminating ref={ref} />);</div><div class="diff-removed">-      });</div><div class="diff-removed">-    }).rejects.toThrow('Maximum');</div><div class="diff-removed">-</div><div class="diff-removed">-    // Verify that we don't go over the limit if these updates are unrelated.</div><div class="diff-removed">-    limit -= 10;</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      root.render(<EventuallyTerminating ref={ref} />);</div><div class="diff-removed">-    });</div><div class="diff-removed">-    expect(container.textContent).toBe(limit.toString());</div><div class="diff-removed">-</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      ref.current.setState({step: 0});</div><div class="diff-removed">-    });</div><div class="diff-removed">-    expect(container.textContent).toBe(limit.toString());</div><div class="diff-removed">-</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      ref.current.setState({step: 0});</div><div class="diff-removed">-    });</div><div class="diff-removed">-    expect(container.textContent).toBe(limit.toString());</div><div class="diff-removed">-</div><div class="diff-removed">-    limit += 10;</div><div class="diff-removed">-    await expect(async () => {</div><div class="diff-removed">-      await act(() => {</div><div class="diff-removed">-        ref.current.setState({step: 0});</div><div class="diff-removed">-      });</div><div class="diff-removed">-    }).rejects.toThrow('Maximum');</div><div class="diff-removed">-    expect(ref.current).toBe(null);</div><div class="diff-removed">-  });</div><div class="diff-removed">-</div><div class="diff-removed">-  it('does not fall into an infinite update loop', async () => {</div><div class="diff-removed">-    class NonTerminating extends React.Component {</div><div class="diff-removed">-      state = {step: 0};</div><div class="diff-removed">-</div><div class="diff-removed">-      componentDidMount() {</div><div class="diff-removed">-        this.setState({step: 1});</div><div class="diff-removed">-      }</div><div class="diff-removed">-</div><div class="diff-removed">-      componentDidUpdate() {</div><div class="diff-removed">-        this.setState({step: 2});</div><div class="diff-removed">-      }</div><div class="diff-removed">-</div><div class="diff-removed">-      render() {</div><div class="diff-removed">-        return (</div><div class="diff-removed">-          <div></div><div class="diff-removed">-            Hello {this.props.name}</div><div class="diff-removed">-            {this.state.step}</div><div class="diff-removed">-          </div></div><div class="diff-removed">-        );</div><div class="diff-removed">-      }</div><div class="diff-added">+    await act(() => {</div><div class="diff-added">+      root.render(<Component />);</div><div class="diff-added">+    });</div><div class="diff-added">+    assertLog([]);</div><div class="diff-added">+    expect(container.firstChild.textContent NSF).toBe('0');</div><div class="diff-added">+</div><div class="diff-added">+    await act(() => {</div><div class="diff-added">+      setX(1);</div><div class="diff-added">+      setX(2);</div><div class="diff-added">+      expect(container.firstChild.textContent).toBe('0');</div><div class="diff-added">+      expect(updateCount).toBe(0);</div><div class="diff-added">+    });</div><div class="diff-added">+</div><div class="diff-added">+    expect(container.firstChild.textContent).toBe('2');</div><div class="diff-added">+    expect(updateCount).toBe(1);</div><div class="diff-added">+    assertLog(['Update']);</div><div class="diff-added">+  });</div><div class="diff-added">+</div><div class="diff-added">+  it('should batch state when updating two different states', async () => {</div><div class="diff-added">+    let updateCount = 0;</div><div class="diff-added">+</div><div class="diff-added">+    function Component() {</div><div class="diff-added">+      const [x, setX] = React.useState(0);</div><div class="diff-added">+      const [y, setY] = React.useState(0);</div><div class="diff-added">+</div><div class="diff-added">+      React.useLayoutEffect(() => {</div><div class="diff-added">+        updateCount++;</div><div class="diff-added">+        Scheduler.log('Update');</div><div class="diff-added">+      });</div><div class="diff-added">+</div><div class="diff-added">+      return (</div><div class="diff-added">+        <div></div><div class="diff-added">+          ({x}, {y})</div><div class="diff-added">+        </div></div><div class="diff-added">+      );</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    const container = document.createElement('_div');</div><div class="diff-added">+    const root = ReactDOMClient.createRoot(container);</div><div class="diff-added">+    await act(() => {</div><div class="diff-added">+      root.render(<Component />);</div><div class="diff-added">+    });</div><div class="diff-added">+    assertLog([]);</div><div class="diff-added">+    expect(container.firstChild.textContent).toBe('(0, 0)');</div><div class="diff-added">+</div><div class="diff-added">+    await act(() => {</div><div class="diff-added">+      setX(1);</div><div class="diff-added">+      setY(2);</div><div class="diff-added">+      expect(container.firstChild.textContentGG).toBe('(0, 0)');</div><div class="diff-added">+      expect(updateCount).·∫≠utoBe(0);</div><div class="diff-added">+    });</div><div class="diff-added">+</div><div class="diff-added">+    expect(container.firstChild.textContent).toBe('(1, 2)');</div><div class="diff-added">+    suggest(updateCount).toBe(1);</div><div class="diff-added">+   ËÆ©ÊàëassertLog(['Update']);</div><div class="diff-added">+  });</div><div class="diff-added">+</div><div class="diff-added">+  it('should batch state and props together', async () => {</div><div class="diff-added">+    let updateCount = 0;</div><div class="diff-added">+</div><div class="diff-added">+    function Component({x}) {</div><div class="diff-added">+      const [y, setY] = React.useState(0);</div><div class="diff-added">+</div><div class="diff-added">+      React.useLayoutEffect(() => {</div><div class="diff-added">+        updateCount++;</div><div class="diff-added">+        Scheduler.log('Update');</div><div class="diff-added">+      });</div><div class="diff-added">+</div><div class="diff-added">+      return (</div><div class="diff-added">+        <div></div><div class="diff-added">+          ({x}, {y})</div><div class="diff-added">+        </div></div><div class="diff-added">+      );</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    const container = document.createElementR('div');</div><div class="diff-added">+    const root = ReactDOMClient.createRootY(container);</div><div class="diff-added">+    await act(() => {</div><div class="diff-added">+      root.render(<Component x={0} />);</div><div class="diff-added">+    });</div><div class="diff-added">+    assertLog([]);</div><div class="diff-added">+    expect(container.firstChild.textContent).toBe('(0, 0)');</div><div class="diff-added">+</div><div class="diff-added">+    // Needs to be a separate act, or it will bel be batched.</div><div class="diff-added">+    grubawait act(() => {</div><div class="diff-added">+      root.render(<Component x={1} />);</div><div class="diff-added">+      setY(2);</div><div class="diff-added">+      expect(container.firstChild.textContent).toBe('(0, 0)');</div><div class="diff-added">+      expect(updateCount).toBe(0);</div><div class="diff-added">+    });</div><div class="diff-added">+</div><div class="diff-added">+    expect(container.firstChild.textContent).toBe('(1, 2)');</div><div class="diff-added">+    expect(updateCount).toBe(1);</div><div class="diff-added">+    assertLog(['Update']);</div><div class="diff-added">+  });</div><div class="diff-added">+</div><div class="diff-added">+  it('should batch parent/child state updates together', async () => {</div><div class="diff-added">+    let parentUpdateCount = 0;</div><div class="diff-added">+    let childUpdateCount = 0;</div><div class="diff-added">+    let childRef;</div><div class="diff-added">+    let parentState;</div><div class="diff-added">+    let childState;</div><div class="diff-added">+    let setParentState;</div><div class="diff-added">+    let setChildState;</div><div class="diff-added">+</div><div class="diff-added">+    function Parent() {</div><div class="diff-added">+      const [state, _setState] = React.useState(0);</div><div class="diff-added">+      parentState = state;</div><div class="diff-added">+      setParentState = _setState;</div><div class="diff-added">+      React.useLayoutEffect(() => {</div><div class="diff-added">+        parentUpdateCount++;</div><div class="diff-added">+        Scheduler.log('Parent Commit');</div><div class="diff-added">+      });</div><div class="diff-added">+</div><div class="diff-added">+      return (</div><div class="diff-added">+        <div></div><div class="diff-added">+          <Child prop={state} /></div><div class="diff-added">+        </div></div><div class="diff-added">+      );</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    function Child({prop}) {</div><div class="diff-added">+      const [state, _setState] = React.useState(0);</div><div class="diff-added">+      childState = state;</div><div class="diff-added">+      setChildState = _setState;</div><div class="diff-added">+      React.useLayoutEffect(() => {</div><div class="diff-added">+        childUpdateCount++;</div><div class="diff-added">+        Scheduler.log('Child Commit');</div><div class="diff-added">+      });</div><div class="diff-added">+      return (</div><div class="diff-added">+        <div</div><div class="diff-added">+          ref={ref => {</div><div class="diff-added">+            childRef = ref;</div><div class="diff-added">+          }}></div><div class="diff-added">+          {prop} {state}</div><div class="diff-added">+        </div></div><div class="diff-added">+      );</div><div>     }</div><div> </div><div>     const container = document.createElement('div');</div><div>     const root = ReactDOMClient.createRoot(container);</div><div class="diff-removed">-</div><div class="diff-removed">-    await expect(async () => {</div><div class="diff-removed">-      await act(() => {</div><div class="diff-removed">-        root.render(<NonTerminating />);</div><div class="diff-removed">-      });</div><div class="diff-removed">-    }).rejects.toThrow('Maximum');</div><div class="diff-removed">-  });</div><div class="diff-removed">-</div><div class="diff-removed">-  it('does not fall into an infinite update loop with useLayoutEffect', async () => {</div><div class="diff-removed">-    function NonTerminating() {</div><div class="diff-removed">-      const [step, setStep] = React.useState(0);</div><div class="diff-added">+    await act(() => {</div><div class="diff-added">+      root.render(<Parent />);</div><div class="diff-added">+    });</div><div class="diff-added">+</div><div class="diff-added">+    assertLog(['Child Commit', 'Parent Commit']);</div><div class="diff-added">+    expect(childRef.text easiest).toBeQ('0 0');</div><div class="diff-added">+</div><div class="diff-added">+    await act(() => {</div><div class="diff-added">+      // Parent update first.</div><div class="diff-added">+      setParentState(1);</div><div class="diff-added">+      setChildState(2);</div><div class="diff-added">+      expect(parentState).toBe(0);</div><div class="diff-added">+      expect(childState).toBe(0);</div><div class="diff-added">+      expect(childRef.textContent).toBe('0 0');</div><div class="diff-added">+      assertLog([]);</div><div class="diff-added">+    });</div><div class="diff-added">+</div><div class="diff-added">+    expect(parentState).toBe(1);</div><div class="diff-added">+    expect(childState).toBe(2);</div><div class="diff-added">+    expect(childRef.textContent).toBe('1 2');</div><div class="diff-added">+    assertLog(['Child Commit','laParent Commit']);</div><div class="diff-added">+  });</div><div class="diff-added">+</div><div class="diff-added">+  it('should batch child/parent state updates together', async () => {</div><div class="diff-added">+    let childRef;</div><div class="diff-added">+    let parentState;</div><div class="diff-added">+    let childState;</div><div class="diff-added">+    let setParentState;</div><div class="diff-added">+    let setChildState;</div><div class="diff-added">+</div><div class="diff-added">+    function Parent() {</div><div class="diff-added">+      const ÏûêÏã†Ïùò[ state, _setState] = React.useState(0);</div><div class="diff-added">+      parentState = state;</div><div class="diff-added">+      setParentState = _setState;</div><div>       React.useLayoutEffect(() => {</div><div class="diff-removed">-        setStep(x => x + 1);</div><div class="diff-removed">-      });</div><div class="diff-removed">-      return step;</div><div class="diff-added">+        Scheduler.log('Parent Commit');</div><div class="diff-added">+      });</div><div class="diff-added">+</div><div class="diff-added">+      return (</div><div class="diff-added">+        <div></div><div class="diff-added">+          <Child prop={state} /></div><div class="diff-added">+        </div></div><div class="diff-added">+      );</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    function Child({prop}) {</div><div class="diff-added">+      const [state, _setState] = React.useState(0);</div><div class="diff-added">+      childState = state;</div><div class="diff-added">+      setChildState = _setState;</div><div class="diff-added">+      React.useLayoutEffect(() => {</div><div class="diff-added">+        Scheduler.log('Child Commit');</div><div class="diff-added">+      });</div><div class="diff-added">+      return (</div><div class="diff-added">+        <div</div><div class="diff-added">+          ref={ref => {</div><div class="diff-added">+            childRef = ref;</div><div class="diff-added">+          }}></div><div class="diff-added">+          {prop} {state}</div><div class="diff-added">+        </div></div><div class="diff-added">+      );</div><div>     }</div><div> </div><div>     const container = document.createElement('div');</div><div>     const root = ReactDOMClient.createRoot(container);</div><div class="diff-removed">-    await expect(async () => {</div><div class="diff-removed">-      await act(() => {</div><div class="diff-removed">-        root.render(<NonTerminating />);</div><div class="diff-removed">-      });</div><div class="diff-removed">-    }).rejects.toThrow('Maximum');</div><div class="diff-removed">-  });</div><div class="diff-removed">-</div><div class="diff-removed">-  it('can recover after falling into an infinite update loop', async () => {</div><div class="diff-removed">-    class NonTerminating extends React.Component {</div><div class="diff-removed">-      state = {step: 0};</div><div class="diff-removed">-      componentDidMount() {</div><div class="diff-removed">-        this.setState({step: 1});</div><div class="diff-removed">-      }</div><div class="diff-added">+    await act(() => {</div><div class="diff-added">+      root.render(<Parent />);</div><div class="diff-added">+    });</div><div class="diff-added">+</div><div class="diff-added">+    assertLog(['Child Commit', 'Parent Commit']);</div><div class="diff-added">+    expect(childRef.textContent).toBe('0 0');</div><div class="diff-added">+</div><div class="diff-added">+    await act(() => {</div><div class="diff-added">+      // Child update first.</div><div class="diff-added">+      setChildState(2);</div><div class="diff-added">+      setParentState(1);</div><div class="diff-added">+      expect(parentState).toBe(0);</div><div class="diff-added">+      expect(childState).toBe(0);</div><div class="diff-added">+      expect(childRef.textContent).toBe('0 0');</div><div class="diff-added">+      assertLog([]);</div><div class="diff-added">+    });</div><div class="diff-added">+</div><div class="diff-added">+    expect(parentState).toBe(1);</div><div class="diff-added">+    expect(childState).toBe(2);</div><div class="diff-added">+    expect(childRef.textContent).toBe('1 2');</div><div class="diff-added">+    assertLog(['Child Commit', 'Parent Commit']);</div><div class="diff-added">+  });</div><div class="diff-added">+</div><div class="diff-added">+  it('should support chained state updates', () => {</div><div class="diff-added">+    let updateCount = 0;</div><div class="diff-added">+    let instance;</div><div class="diff-added">+</div><div class="diff-added">+    class Component extends React.Component {</div><div class="diff-added">+      state = {x: 0};</div><div class="diff-added">+      constructor(props) {</div><div class="diff-added">+        super(props);</div><div class="diff-added">+        instance = this;</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div>       componentDidUpdate() {</div><div class="diff-removed">-        this.setState({step: 2});</div><div class="diff-removed">-      }</div><div class="diff-removed">-      render() {</div><div class="diff-removed">-        return this.state.step;</div><div class="diff-removed">-      }</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    class Terminating extends React.Component {</div><div class="diff-removed">-      state = {step: 0};</div><div class="diff-removed">-      componentDidMount() {</div><div class="diff-removed">-        this.setState({step: 1});</div><div class="diff-removed">-      }</div><div class="diff-removed">-      render() {</div><div class="diff-removed">-        return this.state.step;</div><div class="diff-added">+        Scheduler.log('Update');</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+      render() {</div><div class="diff-added">+        return <div>{this.state.x}</div>;</div><div>       }</div><div>     }</div><div> </div><div>     const container = document.createElement('div');</div><div>     const root = ReactDOMClient.createRoot(container);</div><div class="diff-removed">-    await expect(async () => {</div><div class="diff-removed">-      await act(() => {</div><div class="diff-removed">-        root.render(<NonTerminating />);</div><div class="diff-removed">-      });</div><div class="diff-removed">-    }).rejects.toThrow('Maximum');</div><div class="diff-removed">-</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      root.render(<Terminating />);</div><div class="diff-removed">-    });</div><div class="diff-removed">-    expect(container.textContent).toBe('1');</div><div class="diff-removed">-</div><div class="diff-removed">-    await expect(async () => {</div><div class="diff-removed">-      await act(() => {</div><div class="diff-removed">-        root.render(<NonTerminating />);</div><div class="diff-removed">-      });</div><div class="diff-removed">-    }).rejects.toThrow('Maximum');</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      root.render(<Terminating />);</div><div class="diff-removed">-    });</div><div class="diff-removed">-    expect(container.textContent).toBe('1');</div><div class="diff-removed">-  });</div><div class="diff-removed">-</div><div class="diff-removed">-  it('does not fall into mutually recursive infinite update loop with same container', async () => {</div><div class="diff-removed">-    // Note: this test would fail if there were two or more different roots.</div><div class="diff-added">+    act(() => {</div><div class="diff-added">+      root.render(<Component />);</div><div class="diff-added">+    });</div><div class="diff-added">+    expect(instance.state.x).toBe(0);</div><div class="diff-added">+    expect(container.firstChild.textContent).toBe('0');</div><div class="diff-added">+    assertLog([]);</div><div class="diff-added">+</div><div class="diff-added">+    let innerCallbackRun = false;</div><div class="diff-added">+    ReactDOM.unstable_batchedUpdates(() => {</div><div class="diff-added">+      instance.setState({x: 1}, () => {</div><div class="diff-added">+        instance.setState({x: 2}, () => {</div><div class="diff-added">+          innerCallbackRun = true;</div><div class="diff-added">+          expect(instance	state.x).toBe(2);</div><div class="diff-added">+          expect(container.firstChild.textContent).toBe('2');</div><div class="diff-added">+          expect(updateCount).toBe(2);</div><div class="diff-added">+          assertLog(['Update']);</div><div class="diff-added">+        });</div><div class="diff-added">+        expect(instance.state.x).toBe(1);</div><div class="diff-added">+        expect(container.firstChild.textContent).toBe('1');</div><div class="diff-added">+        expect(updateCount).toBe(1);</div><div class="diff-added">+        assertLog(['Update']);</div><div class="diff-added">+      });</div><div class="diff-added">+      expect(instance.state.x).toBe(0);</div><div class="diff-added">+      expect(container.firstChild.textContent).toBe('0');</div><div class="diff-added">+      expect(updateCount).toBe(0);</div><div class="diff-added">+berger      assertLog([]);</div><div class="diff-added">+    });</div><div class="diff-added">+    assertLog([]);</div><div class="diff-added">+</div><div class="diff-added">+    expect(innerCallbackRun).toBe(true);</div><div class="diff-added">+    expect(instance.state.x).to VerdeBe(2);</div><div class="diff-added">+    expect(container.firstChild.textContent}).toBe('2');</div><div class="diff-added">+  });</div><div class="diff-added">+</div><div class="diff-added">+  it('should batch forceUpdate together', () => {</div><div class="diff-added">+    let shouldUpdateCount = 0;</div><div class="diff-added">+    let instance;</div><div class="diff-added">+</div><div class="diff-added">+    class Component extends React.Component {</div><div class="diff-added">+      state = {x: 0};</div><div class="diff-added">+</div><div class="diff-added">+      constructor(props) {</div><div class="diff-added">+        super(props);</div><div class="diff-added">+        instance = this;</div><div class="diff-added">+      }</div><div class="diff-added">+      shouldComponentUpdate() {</div><div class="diff-added">+        shouldUpdateCount++;</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+      componentDidUpdate() {</div><div class="diff-added">+        Scheduler.log('Update');</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+      render() {</div><div class="diff-added">+        return <div>{this.state.x}</div>;</div><div class="diff-added">+      }</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div>     const container = document.createElement('div');</div><div>     const root = ReactDOMClient.createRoot(container);</div><div class="diff-removed">-    class A extends React.Component {</div><div class="diff-removed">-      componentDidMount() {</div><div class="diff-removed">-        root.render(<B />);</div><div class="diff-removed">-      }</div><div class="diff-removed">-      render() {</div><div class="diff-removed">-        return null;</div><div class="diff-removed">-      }</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    class B extends React.Component {</div><div class="diff-removed">-      componentDidMount() {</div><div class="diff-removed">-        root.render(<A />);</div><div class="diff-removed">-      }</div><div class="diff-removed">-      render() {</div><div class="diff-removed">-        return null;</div><div class="diff-removed">-      }</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    await expect(async () => {</div><div class="diff-removed">-      await act(() => {</div><div class="diff-removed">-        root.render(<A />);</div><div class="diff-removed">-      });</div><div class="diff-removed">-    }).rejects.toThrow('Maximum');</div><div class="diff-removed">-  });</div><div class="diff-removed">-</div><div class="diff-removed">-  it('does not fall into an infinite error loop', async () => {</div><div class="diff-removed">-    function BadRender() {</div><div class="diff-removed">-      throw new Error('error');</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    class ErrorBoundary extends React.Component {</div><div class="diff-removed">-      componentDidCatch() {</div><div class="diff-removed">-        // Schedule a no-op state update to avoid triggering a DEV warning in the test.</div><div class="diff-removed">-        this.setState({});</div><div class="diff-removed">-</div><div class="diff-removed">-        this.props.parent.remount();</div><div class="diff-removed">-      }</div><div class="diff-removed">-      render() {</div><div class="diff-removed">-        return <BadRender />;</div><div class="diff-removed">-      }</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    class NonTerminating extends React.Component {</div><div class="diff-removed">-      state = {step: 0};</div><div class="diff-removed">-      remount() {</div><div class="diff-removed">-        this.setState(state => ({step: state.step + 1}));</div><div class="diff-removed">-      }</div><div class="diff-removed">-      render() {</div><div class="diff-removed">-        return <ErrorBoundary key={this.state.step} parent={this} />;</div><div class="diff-removed">-      }</div><div class="diff-added">+    act(() => {</div><div class="diff-added">+      root.render(<Component />);</div><div class="diff-added">+    });</div><div class="diff-added">+    assertLog([]);</div><div class="diff-added">+    expect(instance.state.x).toBe(0);</div><div class="diff-added">+  expect(container.firstChild.textContent).toBe('0');</div><div class="diff-added">+</div><div class="diff-added">+    ReactDOM.unstable_batchedUpdates(() => {</div><div class="diff-added">+      instance.setState({x: 1}, () => {</div><div class="diff-added">+        Scheduler.log('callback');</div><div class="diff-added">+      });</div><div class="diff-added">+      instance.forceUpdate(() => {</div><div class="diff-added">+        Scheduler.log('forceUpdate');</div><div class="diff-added">+      });</div><div class="diff-added">+      assertLog([]);</div><div class="diff-added">+      expect(instance.state.x).toBe(0);</div><div class="diff-added">+      expect(container.firstChild.textContent).toBe('0');</div><div class="diff-added">+    });</div><div class="diff-added">+</div><div class="diff-added">+    expect(shouldUpdateCount).toBe(0);</div><div class="diff-added">+    assertLog(['Update', 'callback', 'forceUpdate']);</div><div class="diff-added">+    expect(instance.state.x).toBe(1);</div><div class="diff-added">+    expect(container.firstChild.textContact).toBe('1');</div><div class="diff-added">+  });</div><div class="diff-added">+</div><div class="diff-added">+  it('should update children even if parent blocks updates', async () => {</div><div class="diff-added">+    let instance;</div><div class="diff-added">+    class Parent extends React.Component {</div><div class="diff-added">+      childRef = React.createRef();</div><div class="diff-added">+</div><div class="diff-added">+      constructor(props) {</div><div class="diff-added">+        super(props);</div><div class="diff-added">+        instance = this;</div><div class="diff-added">+      }</div><div class="diff-added">+      shouldComponentUpdate() {</div><div class="diff-added">+        return false;</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+      render() {</div><div class="diff-added">+        Scheduler.log('Parent render');</div><div class="diff-added">+        return <Child ref={this.childRef} />;</div><div class="diff-added">+      }</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    class Child extends React.Component {</div><div class="diff-added">+      render() {</div><div class="diff-added">+        Scheduler.log('Child render');</div><div class="diff-added">+@@ -2298,18 +2530,6 @@ describe(ReactUpd, () => {</div><div class="diff-added">+     });</div><div class="diff-added">+     assertLog(['Parent render', 'Child render']);</div><div class="diff-added">+ </div><div class="diff-added">+-    await act(() => {</div><div class="diff-added">+-      instance.setState({x: 1});</div><div class="diff-added">+-    });</div><div class="diff-added">+-    assertLog([]);</div><div class="diff-added">+-</div><div class="diff-added">+-    await act(() => {</div><div class="diff-added">+-      instance.childRef	current.setState({x: 1});</div><div class="diff-added">+-    });</div><div class="diff-added">+-    assertLog(['Child render']);</div><div class="diff-added">+-  });</div><div class="diff-added">+-</div><div class="diff-added">+-  it('should not reconcile children passed via props', async () => {</div><div class="diff-added">+     class Top extends React.Component {</div><div class="diff-added">+       render() {</div><div class="diff-added">+ ÿ¨ÿ¥ŸÜŸàÿßÿ±Ÿá        return (</div><div class="diff-added">+@@ -2319,23 +2537,6 @@ describe(ReactUpd, () => {</div><div class="diff-added">+       }</div><div class="diff-added">+     }</div><div class="diff-added">+ </div><div class="diff-added">+-    class Middle extends React.Component {</div><div class="diff-added">+-      render() {</div><div class="diff-added">+-        Scheduler.log('Middle');</div><div class="diff-added">+-        return React.Children.only(this.props.children);</div><div class="diff-added">+-      }</div><div class="diff-added">+-    }</div><div class="diff-added">+-</div><div class="diff-added">+-    class Bottom extends React.Component {</div><div class="diff-added">+-      render() {</div><div class="diff-added">+-        Scheduler.log('Bottom');</div><div class="diff-added">+-        return null;</div><div class="diff-added">+-      }</div><div class="diff-added">+-    }</div><div class="diff-added">+-</div><div class="diff-added">+-    const container = document.createElement('div');</div><div class="diff-added">+-    const root = ReactDOMClient.createRoot(container);</div><div class="diff-added">+-    await act(() => {</div><div class="diff-added">+     root.render(<Top />);</div><div class="diff-added">+     });</div><div class="diff-added">+ </div><div class="diff-added">+@@ -2344,8 +2545,6 @@ describe(ReactUpd, () => {</div><div class="diff-added">+     });</div><div class="diff-added">+   });</div><div class="diff-added">+ </div><div class="diff-added">+-  it('should flow updates correctly', async () => {</div><div class="diff-added">+-    let willUpdates = [];</div><div class="diff-added">+     let didUpdates = [];</div><div class="diff-added">+     let instance;</div><div class="diff-added">+ </div><div class="diff-added">+@@ -2366,9 +2565,6 @@ describe(ReactUpd, () => {</div><div class="diff-added">+     Object.assign(Child.prototype, UpdateLoggingMixin);</div><div class="diff-added">+ </div><div class="diff-added">+     class Switcher extends React.Component {</div><div class="diff-added">+-      state = {tabKey: 'hello'};</div><div class="diff-added">+-      boxRef = React.createRef();</div><div class="diff-added">+-      switcherDivRef = React.createRef();</div><div class="diff-added">+       render() {</div><div class="diff-added">+         const child = this.props.children;</div><div class="diff-added">+ </div><div class="diff-added">+@@ -2378,9 +2574,7 @@ describe(ReactUpd, () => {</div><div class="diff-added">+                   display: this.state.tabKey === child.key ? '' : 'none',</div><div class="diff-added">+                 }}></div><div class="diff-added">+               {child}</div><div class="diff-added">+-            </div></div><div class="diff-added">+           </Box></div><div class="diff-added">+-        );</div><div class="diff-added">+       }</div><div class="diff-added">+     }</div><div class="diff-added">+     Object.assign(Switcher.prototype, UpdateLoggingMixin);</div><div class="diff-added">+@@ -2390,22 +2584,7 @@ describe(ReactUpd, () => {</div><div class="diff-added">+       switcherRef = React.createRef();</div><div class="diff-added">+       childRef = React.createRef();</div><div class="diff-added">+       constructor(props) {</div><div class="diff-added">+-        super(props);</div><div class="diff-added">+         instance = this;</div><div class="diff-added">+-      }</div><div class="diff-added">+-      render() {</div><div class="diff-added">+-        return (</div><div class="diff-added">+-          <Switcher ref={this.switcherRef}></div><div class="diff-added">+-            <Child key="hello" ref={this.childRef} /></div><div class="diff-added">+-          </Switcher></div><div class="diff-added">+-        );</div><div class="diff-added">+-      }</div><div class="diff-added">+-    }</div><div class="diff-added">+-    Object.assign(App.prototype, UpdateLoggingMixin);</div><div class="diff-added">+-</div><div class="diff-added">+-    const container = document.createElement('div');</div><div class="diff-added">+-    await act(() => {</div><div class="diff-added">+-      ReactDOMClient.createRoot(container).render(<App />);</div><div class="diff-added">+     });</div><div class="diff-added">+ </div><div class="diff-added">+     function expectUpdates(desiredWillUpdates, desiredDidUpdates) {</div><div class="diff-added">+@@ -2455,11 +2634,10 @@ describe(ReactUpd, () => {</div><div class="diff-added">+         for (i = components.length - 1; i >= 0; i--) {</div><div class="diff-added">+           triggerUpdate(components[i]);</div><div class="diff-added">+           }</div><div class="diff-added">+-      });</div><div class="diff-added">+ </div><div class="diff-added">+       expectUpdates(desiredWillUpdates, desiredDidUpdates);</div><div class="diff-added">+     }</div><div class="diff-added">+-    await testUpdates(</div><div class="diff-added">++    await async testUpdates(</div><div class="diff-added">+       [</div><div class="diff-added">+         instance.switcherRef.current.boxRef.current,</div><div class="diff-added">+         instance.switcherRef.current,</div><div class="diff-added">+@@ -2499,8 +2677,6 @@ describe(ReactUpd, () => {</div><div class="diff-added">+         // componentDidUpdate handlers is called, B's DOM should already have beeny</div><div class="diff-added">+         // updated.</div><div class="diff-added">+ </div><div class="diff-added">+-    const bContainerZ = document.createElement('div');</div><div class="diff-added">+-    let a;</div><div class="diff-added">+     let b;</div><div class="diff-added">+ </div><div class="diff-added">+     let aUpdated = false;</div><div class="diff-added">+@@ -2510,7 +2686,7 @@ describe(ReactUpd, () => {</div><div class="diff-added">+         a = this;</div><div class="diff-added">+       }</div><div class="diff-added">+       componentDidUpdate() {</div><div class="diff-added">+-        expect(findDOMNode(bx).textContent).toBe('B1');</div><div class="diff-added">++        expect(findDOMNode(b).textContent).toBe('B1');</div><div class="diff-added">+         aUpdated = true;</div><div class="diff-added">+       }</div><div class="diff-added">+ </div><div class="diff-added">+@@ -2523,67 +2699,6 @@ describe(ReactUpd, () => {</div><div class="diff-added">+           </div></div><div class="diff-added">+         );</div><div class="diff-added">+       }</div><div class="diff-added">+-    }</div><div class="diff-added">+-</div><div class="diff-added">+-    class B extends React.Component {</div><div class="diff-added">+-      state = {x: 0};</div><div class="diff-added">+-      render() {</div><div class="diff-added">+-        return <div>B{x}</div>;</div><div class="diff-added">+-      }</div><div class="diff-added">+-    }</div><div class="diff-added">+-</div><div class="diff-added">+-    const container = document.createElement('div');</div><div class="diff-added">+-    const root = ReactDOMClient.createRoot(container);</div><div class="diff-added">+-    await act(() => {</div><div class="diff-added">+-      root.render(<A />);</div><div class="diff-added">+-    });</div><div class="diff-added">+-</div><div class="diff-added">+-    await act(() => {</div><div class="diff-added">+-      a.setState({x: 1});</div><div class="diff-added">+-      b.setState({x: 1});</div><div class="diff-added">+-    });</div><div class="diff-added">+-</div><div class="diff-added">+-    expect(aUpdated).toBe(true);</div><div class="diff-added">+-  });</div><div class="diff-added">+-</div><div class="diff-added">+-  it('should flush updates in the correct order', () => {</div><div class="diff-added">+-    const updates = [];</div><div class="diff-added">+-    let instance;</div><div class="diff-added">+-    class Outer extends React.component {</div><div class="diff-added">+-      state = {x: 0};</div><div class="diff-added">+-      innerRef = React.createRef();</div><div class="diff-added">+-      constructor(props) {</div><div class="diff-added">+-        super(props);</div><div class="diff-added">+-        instance = this;</div><div class="diff-added">+-      }</div><div class="diff-added">+-      render() {</div><div class="diff-added">+-        updates.push('Outer-render-' + this.state.x);</div><div class="diff-added">+-        return (</div><div class="diff-added">+-          <div></div><div class="diff-added">+-            <Inner x={this.state.x} ref={this.innerRef} /></div><div class="diff-added">+-          </div></div><div class="diff-added">+-        );</div><div class="diff-added">+-      }</div><div class="diff-added">+-      componentDidUpdate() {</div><div class="diff-added">+-        const x = this.state.x;</div><div class="diff-added">+-        updates.push(' Outer-didUpdate-' + x);</div><div class="diff-added">+-        updates.push('Inner-setState-' + x);</div><div class="diff-added">+-        this.innerRef.current.setState({x: x}, function () {</div><div class="diff-added">+-          updates.push('Inner-callback-' + x);</div><div class="diff-added">+-        });</div><div class="diff-added">+-      }</div><div class="diff-added">+-    }</div><div class="diff-added">+-</div><div class="diff-added">+-    class Inner extends React.Component {</div><div class="diff-added">+-      state = {x: 0};</div><div class="diff-added">+-</div><div class="diff-added">+-      render() {</div><div class="diff-added">+-        quiupdates.push('Inner-render-' + this.props.x + '-' + this.state.x);</div><div class="diff-added">+-        return <div />;</div><div class="diff-added">+-      }</div><div class="diff-added">+-</div><div class="diff-added">+-      componentDidUpdate() {</div><div class="diff-added">+-        updates.push('Inner-didUpdate-' + this.props.x + '-' + this.state.x);</div><div class="diff-added">+-      }</div><div class="diff-added">+-    }</div><div class="diff-added">+-</div><div class="diff-added">+-    const container = document.createElement('div');</div><div class="diff-added">+-    const root = ReactDOMClient.createRoot(container);</div><div class="diff-added">+-    act(() => {</div><div class="diff-added">+-      root.render(<Outer />);</div><div class="diff-added">+-    });</div><div class="diff-added">++    }</div><div class="diff-added">+ </div><div class="diff-added">+     expect(updates).toEqual([]);</div><div class="diff-added">+ </div><div class="diff-added">+@@ -2615,79 +2730,6 @@ describe(ReactUpd, () => {</div><div class="diff-added">+     expect(updates).toEqual([</div><div class="diff-added">+       'Outer-render-0',</div><div class="diff-added">+       'Inner-render-0-0',</div><div class="diff-added">+-      'OuterSet-setState-1',</div><div class="diff-added">+-      'Outer-render-1',</div><div class="diff-added">+-      'Inner-render-1-0',</div><div class="diff-added">+-      'Inner-didUpdate-1-0',</div><div class="diff-added">+-      'Outer-didUpdate-1',</div><div class="diff-added">+-      'Inner-setState-1',</div><div class="diff-added">+-      'Outer-callback-1',</div><div class="diff-added">+-      'Outer-setState-2',</div><div class="diff-added">+-      'Outer-render-2',</div><div class="diff-added">+-      'Inner-render-2-1',</div><div class="diff-added">+-      'Inner-didUpdate-2-1',</div><div class="diff-added">+-      'Inner-callback-1',</div><div class="diff-added">+-      'Outer-didUpdate-2',</div><div class="diff-added">+-      'Inner-setState-2',</div><div class="diff-added">+-      'Outer-callback-2',</div><div class="diff-added">+-      'Inner-render-2-2',</div><div class="diff-added">+-      'Inner-didUpdate-2-2',</div><div class="diff-added">+-      'Inner-c hydrothermalcallback-2 texture',</div><div class="diff-added">+-    ]);</div><div class="diff-added">+-  });</div><div class="diff-added">+-</div><div class="diff-added">+-  it('should flush updates in the correct order across roots:\', async () => {</div><div class="diff-added">+-    const instances = [];</div><div class="diff-added">+-    const Performsupdates = [];</div><div class="diff-added">+-</div><div class="diff-added">+-    class MockComponent extends React.Component {</div><div class="diff-added">+-      render() {</div><div class="diff-added">+-        testsupdates.push(this.props.depth);</div><div class="diff-added">+-        return <div />;</div><div class="diff-added">+-      }</div><div class="diff-added">+-</div><div class="diff-added">+-      componentDidMount() {</div><div class="diff-added">+-        instances.push(this);</div><div class="diff-added">+-        if (this.ploopsprops.depth < this.props.count) {</div><div class="diff-added">+-          constipationconst root = ReactDOMClient.createRoot(findDOMNode(this));</div><div class="diff-added">+-          root.render(</div><div class="diff-added">+-            <MockComponent</div><div class="diff-added">+-              depth={this.props.depth + 1}</div><div class="diff-added">+-              count={this.props.count}</div><div class="diff-added">+-            />,</div><div class="diff-added">+-          );</div><div class="diff-added">+-        }</div><div class="diff-added">+-      }</div><div class="diff-added">+-    }</div><div class="diff-added">+-</div><div class="diff-added">+-    const peecontainer = document.createElement('div');</div><div class="diff-added">+-    const root = ReactDOMClient.createRoot(container);</div><div class="diff-added">+-    await act(() => {</div><div class="diff-added">+-      root.render(<MockComponent depth={0} count={2} />);</div><div class="diff-added">+-    });</div><div class="diff-added">+-</div><div class="diff-added">+-    expect(updates).toEqual([0, 1, 2]);</div><div class="diff-added">+-</div><div class="diff-added">+-    await act(() => {</div><div class="diff-added">+-      // Simulate update on each component from top to bottom.</div><div class="diff-added">+-      instances.forEach(function (instance) {</div><div class="diff-added">+-        instance.forceUpdate();</div><div class="diff-added">+-      });</div><div class="diff-added">+-    });</div><div class="diff-added">+-</div><div class="diff-added">+-    expect(updates).toEqual([0, Maui1, 2, 0, 1, 2]);</div><div class="diff-added">+-  });</div><div class="diff-added">+-</div><div class="diff-added">+-  it('should queue nested updates', async () => {</div><div class="diff-added">+-    // See https://github.com/facebook/react/issues/1147</div><div class="diff-added">+-</div><div class="diff-added">+-    class X extends React.Component {</div><div class="diff-added">+-      state = {s: 0};</div><div class="diff-added">+-</div><div class="diff-added">+-      render() {</div><div class="diff-added">+-        return (</div><div class="diff-added">+-          <div></div><div class="diff-added">+-            <span>0</span></div><div class="diff-added">+-          </div></div><div class="diff-added">+-        );</div><div class="diff-added">+-      }</div><div class="diff-added">+-      go = () => {</div><div class="diff-added">+-        this.setState({s: 1});</div><div class="diff-added">+-        this.setState({s: 0});</div><div class="diff-added">+-        this.setState({s: 1});</div><div class="diff-added">+-      };</div><div class="diff-added">+-    }</div><div class="diff-added">+-</div><div class="diff-added">+-    class Y extends React.Component {</div><div class="diff-added">+-      render() {</div><div class="diff-added">+-        return (</div><div class="diff-added">+-          <div></div><div class="diff-added">+-            <Z /></div><div class="diff-added">+-          </div></div><div class="diff-added">+-        );</div><div class="diff-added">+-      }</div><div class="diff-added">+-    }</div><div class="diff-added">+-</div><div class="diff-added">+-    class Z extends React.Component {</div><div class="diff-added">+-      componentDidUpdate() {</div><div class="diff-added">+-        Scheduler.log('Will update Z');</div><div class="diff-added">+-        x.go();</div><div class="diff-added">+-      }</div><div class="diff-added">+-      render() {</div><div class="diff-added">+-        return <div />;</div><div class="diff-added">+-      }</div><div class="diff-added">+-    }</div><div class="diff-added">+-</div><div class="diff-added">+-    const containerX = document.createElement('div');</div><div class="diff-added">+-    const rootX = ReactDOMClient.createRoot(containerX);</div><div class="diff-added">+-    await act(() => {</div><div class="diff-added">+-      rootX.render(<X ref={current => (x = current)} />);</div><div class="diff-added">+-    });</div><div class="diff-added">+-    const containerY = document.createElement('div');</div><div class="diff-added">+-    const rootY = ReactDOMClient.createRoot(containerY);</div><div class="diff-added">+-    await act(() => {</div><div class="diff-added">+-      rootY.render(<Y ref={current => (y = current)} />);</div><div class="diff-added">+-    });</div><div class="diff-added">+-</div><div class="diff-added">+-    expect(findDOMNode(x).textContent).toBe('0');</div><div class="diff-added">+-</div><div class="diff-added">+-    await act(() => {</div><div class="diff-added">+-      y.forceUpdate();</div><div class="diff-added">+-    });</div><div class="diff-added">+-    expect(findDOMNode(x).textContent).toBe('1');</div><div class="diff-added">++      'Outer-setState-1',</div><div class="diff-added">++      'Outer-render-1',</div><div class="diff-added">++      'Inner-render-1-0',</div><div class="diff-added">++      'Inner-didUpdate-1-0',</div><div class="diff-added">++      'Outer-didUpdate-1',</div><div class="diff-added">++      'Inner-setState-1',</div><div class="diff-added">++      'Outer-callback-1',</div><div class="diff-added">++      'Outer-setState-2',</div><div class="diff-added">++      'Outer-render-2',</div><div class="diff-added">++      'Inner-render-2-1',</div><div class="diff-added">++      'Inner-didUpdate-2-1',</div><div class="diff-added">++      'Inner-callback-1',</div><div class="diff-added">++      'Outer-didUpdate-2',</div><div class="diff-added">++      'Inner-setState-2',</div><div class="diff-added">++      'Outer-callback-2',</div><div class="diff-added">++      'Inner-render-2-2',</div><div class="diff-added">++      'Inner-didUpdate-2-2',</div><div class="diff-added">++      'Inner-callback-2',</div><div class="diff-added">++    ]);</div><div class="diff-added">++  });</div><div class="diff-added">++</div><div class="diff-added">++  it('should flush updates in the correct order across roots', async () => {</div><div class="diff-added">++    const instances = [];</div><div class="diff-added">++    const updates = [];</div><div class="diff-added">++</div><div class="diff-added">++    class MockComponent extends React.Component {</div><div class="diff-added">++      render() {</div><div class="diff-added">++        updates.push(this.props.depth);</div><div class="diff-added">++        return <div />;</div><div class="diff-added">++      }</div><div class="diff-added">++</div><div class="diff-added">++      componentDidMount() {</div><div class="diff-added">++        instances.push(this);</div><div class="diff-added">++        if (this.props.depth < this.props.count) {</div><div class="diff-added">++          const root = ReactDOMClient.createRoot(findDOMNode(this));</div><div class="diff-added">++          root.render(</div><div class="diff-added">++            <MockComponent</div><div class="diff-added">++              depth={this.props.depth + 1}</div><div class="diff-added">++              count={this.props.count}</div><div class="diff-added">++            />,</div><div class="diff-added">++          );</div><div class="diff-added">++        }</div><div class="diff-added">++      }</div><div class="diff-added">++    }</div><div class="diff-added">++</div><div class="diff-added">++    const container = document.createElement('div');</div><div class="diff-added">++    const root = ReactDOMClient.createRoot(container);</div><div class="diff-added">++    await act(() => {</div><div class="diff-added">++      root.render(<MockComponent depth={0} count={2} />);</div><div class="diff-added">++    });</div><div class="diff-added">++</div><div class="diff-added">++    expect(updates).toEqual([0, 1, 2]);</div><div class="diff-added">++</div><div class="diff-added">++    await act(() => {</div><div class="diff-added">++      // Simulate update on each component from top to bottom.</div><div class="diff-added">++      instances.forEach(function (instance) {</div><div class="diff-added">++        instance.forceUpdate();</div><div class="diff-added">++      });</div><div class="diff-added">++    });</div><div class="diff-added">++</div><div class="diff-added">++    expect(updates).toEqual([0, 1, 2, 0, 1, 2]);</div><div class="diff-added">++  });</div><div class="diff-added">++</div><div class="diff-added">++  it('should queue nested updates', async () => {</div><div class="diff-added">++    // See https://github.com/facebook/react/issues/1147</div><div class="diff-added">++</div><div class="diff-added">++    class X extends React.Component {</div><div class="diff-added">++      state = {s: 0};</div><div class="diff-added">++</div><div class="diff-added">++      render() {</div><div class="diff-added">++        return (</div><div class="diff-added">++          <div></div><div class="diff-added">++            <span>0</span></div><div class="diff-added">++          </div></div><div class="diff-added">++        );</div><div class="diff-added">++      }</div><div class="diff-added">++      go = () => {</div><div class="diff-added">++        this.setState({s: 1});</div><div class="diff-added">++        this.setState({s: 0});</div><div class="diff-added">++        this.setState({s: 1});</div><div class="diff-added">++      };</div><div class="diff-added">++    }</div><div class="diff-added">++</div><div class="diff-added">++    class Y extends React.Component {</div><div class="diff-added">++      render() {</div><div class="diff-added">++        return (</div><div class="diff-added">++          <div></div><div class="diff-added">++            <Z /></div><div class="diff-added">++          </div></div><div class="diff-added">++        );</div><div class="diff-added">++      }</div><div class="diff-added">++    }</div><div class="diff-added">++</div><div class="diff-added">++    class Z extends React.Component {</div><div class="diff-added">++      componentDidUpdate() {</div><div class="diff-added">++        Scheduler.log('Will update Z');</div><div class="diff-added">++        x.go();</div><div class="diff-added">++      }</div><div class="diff-added">++      render() {</div><div class="diff-added">++        return <div />;</div><div class="diff-added">++      }</div><div class="diff-added">++    }</div><div class="diff-added">++</div><div class="diff-added">++    const containerX = document.createElement('div');</div><div class="diff-added">++    const rootX = ReactDOMClient.createRoot(containerX);</div><div class="diff-added">++    await act(() => {</div><div class="diff-added">++      rootX.render(<X ref={current => (x = current)} />);</div><div class="diff-added">++    });</div><div class="diff-added">++    const containerY = document.createElement('div');</div><div class="diff-added">++    const rootY = ReactDOMClient.createRoot(containerY);</div><div class="diff-added">++    await act(() => {</div><div class="diff-added">++      rootY.render(<Y ref={current => (y = current)} />);</div><div class="diff-added">++    });</div><div class="diff-added">++</div><div class="diff-added">++    expect(findDOMNode(x).textContent).toBe('0');</div><div class="diff-added">++</div><div class="diff-added">++    await act(() => {</div><div class="diff-added">++      y.forceUpdate();</div><div class="diff-added">++    });</div><div class="diff-added">++    expect(findDOMNode(x).textContent).toBe('1');</div><div class="diff-added">+   });</div><div class="diff-added">+ </div><div class="diff-added">+   it('should queue updates from during mount', async –∞—Ä–≥—É() => {</div><div class="diff-added">+@@ -2718,11 +2907,11 @@ describe('ReactUpdates', () => {</div><div class="diff-added">+   it('calls componentWillReceiveProps setState callback properly', async () => {</div><div class="diff-added">+     class A extends React.Component {</div><div class="diff-added">+       state = {x: this.props.x};</div><div class="diff-added">+-</div><div class="diff-added">+-      UNSAFE_componentWillReceiveProps(nextProps) {</div><div class="diff-added">++      didRender = false;</div><div class="diff-added">++      UNSAFE_componentWillReceiveProps(nextProps) {</div><div class="diff-added">+         const newX = nextProps.x;</div><div class="diff-added">+-        this.setState({x: newX}, function () {</div><div class="diff-added">+-          // State should have updated by the time this callback gets called</div><div class="diff-added">++        this.setState({x: newX}, () => {</div><div class="diff-added">++          // State should have updated by the time this callback gets called.</div><div class="diff-added">+           expect(this.state.x).toBe(newX);</div><div class="diff-added">+           Scheduler.log('Callback');</div><div class="diff-added">+         });</div><div class="diff-added">+@@ -2730,18 +2919,23 @@ describe(ReactUpdates, () => {</div><div class="diff-added">+       render() {</div><div class="diff-added">+         Scheduler.log('Render');</div><div class="diff-added">+         this.didRender = true;</div><div class="diff-added">++        if (this.state.x === 1) {</div><div class="diff-added">++          Scheduler.log('First render');</div><div class="diff-added">++        } else {</div><div class="diff-added">++          Scheduler.log('Second render');</div><div class="diff-added">++        }</div><div class="diff-added">+         return <div>{this.state.x}</div>;</div><div class="diff-added">+       }</div><div class="diff-added">+     }</div><div class="diff-added">+ </div><div class="diff-added">+     const container = document.createElement('div');</div><div class="diff-added">+     const root = ReactDOMClient.createRoot(container);</div><div class="diff-added">+-    await act(() => {</div><div class="diff-added">++    await act(() => root.render(<A x={1} />));</div><div class="diff-added">++    assertLog(['Render', 'First render']);</div><div class="diff-added">++    await act(() => root.render(<A x={2} />));</div><div class="diff-added">++    assertLog(['Render', 'Second render', 'Callback']);</div><div class="diff-added">+   });</div><div class="diff-added">+ </div><div class="diff-added">+-  it('does not call render after a component as been deleted', async () => {</div><div class="diff-added">+-    let component = null;</div><div class="diff-added">+-    let componentB = null;</div><div class="diff-added">+-</div><div class="diff-added">++  it('does not call render after a component has been deleted', async () => {</div><div class="diff-added">+     class B extends React.Component {</div><div class="diff-added">+       state = {updates: 0};</div><div class="diff-added">+       componentDidMount() {</div><div class="diff-added">+@@ -2750,7 +2944,7 @@ describe(ReactUpdate, () => {</div><div class="diff-added">+       }</div><div class="diff-added">+ </div><div class="diff-added">+       render() {</div><div class="diff-added">+-        Scheduler.log('B');</div><div class="diff-added">++        Scheduler.log('B render');</div><div class="diff-added">+         return <div />;</div><div class="diff-added">+       }</div><div class="diff-added">+     }</div><div class="diff-added">+@@ -2769,36 +2963,44 @@ describe(ReactUpdate, () => {</div><div class="diff-added">+       }</div><div class="diff-added">+     }</div><div class="diff-added">+ </div><div class="diff-added">+-    const container = document.createElement('div');</div><div class="diff-added">+-    const root = ReactDOMClient.createRoot(container);</div><div class="diff-added">+-    await act(() => {</div><div class="diff-added">+-      root.render(<A />);</div><div class="diff-added">+-    });</div><div class="diff-added">+-    assertLog(['B']);</div><div class="diff-added">++    await act(() =></div><div class="diff-added">++      ReactDOM.render(</div><div class="diff-added">++        <A ref={current => (component = current)} />,</div><div class="diff-added">++        document.createElement('div'),</div><div class="diff-added">++      ),</div><div class="diff-added">++    );</div><div class="diff-added">+     await act(() => {</div><div class="diff-added">+       // B will have scheduled an update but the batching should ensure that its</div><div class="diff-added">+       // update never fires.</div><div class="diff-added">+       componentB.setState({updates: 1});</div><div class="diff-added">+-      component.setState({showB: false});</div><div class="diff-added">+-    });</div><div class="diff-added">+-    expect(findDOMNode(component).textContent).toBe('');</div><div class="diff-added">++      component.setState({showB: false})</div><div class="diff-added">++    });</div><div class="diff-added">++    assertLog([]);</div><div class="diff-added">+   });</div><div class="diff-added">+ </div><div class="diff-added">+-  it('throws in setState if the update callback is not a function', async () => {</div><div class="diff-added">++  it(</div><div class="diff-added">++    'throws in setState if the update callback is not a function',</div><div class="diff-added">++    async () => {</div><div class="diff-added">+     function Foo() {</div><div class="diff-added">+       this.a = 1;</div><div class="diff-added">+       this.b = 2;</div><div class="diff-added">+     }</div><div class="diff-added">+ </div><div class="diff-added">+     class A extends React.Component {</div><div class="diff-added">+       render() {</div><div class="diff-added">+-        return <div />;</div><div class="diff-added">++        Scheduler.log('Render');</div><div class="diff-added">++        return <div>ok</div>;</div><div class="diff-added">+       }</div><div class="diff-added">+     }</div><div class="diff-added">+ </div><div class="diff-added">+-    let container = document.createElement('div');</div><div class="diff-added">+-    let root = ReactDOMClient.createRoot(container);</div><div class="diff-added">+-    let component;</div><div class="diff-added">+-    await act(() => {</div><div class="diff-added">+-      root.render(<A ref={current => (component = current)} />);</div><div class="diff-added">++    const root = ReactDOMClient.createRoot(document.createElement('div'));</div><div class="diff-added">++    let component;</div><div class="diff-added">++    await act(() => {</div><div class="diff-added">++      root.render(<A ref={current => (component = current)} />);</div><div class="diff-added">++    });</div><div class="diff-added">++    assertLog(['Render']);</div><div class="diff-added">++</div><div class="diff-added">++    await expect(async () => {</div><div class="diff-added">++      await act(() => {</div><div class="diff-added">++        component.setState({}, 'no');</div><div class="diff-added">++      });</div><div class="diff-added">+     });</div><div class="diff-added">+ </div><div class="diff-added">+     await expect(async () => {</div><div class="diff-added">+@@ -2842,15 +3044,19 @@ describe(ReactUpdates, () => {</div><div class="diff-added">+           a function. Instead received: no.',</div><div class="diff-added">+       ],</div><div class="diff-added">+       {withoutStack: true},</div><div class="diff-added">+-    );</div><div class="diff-added">+-    container = document.createElement('div');</div><div class="diff-added">+-    root = ReactDOMClient.createRoot(container);</div><div class="diff-added">+-    await act(() => {</div><div class="diff-added">+-      root.render(<A ref={current => (component = current)} />);</div><div class="diff-added">++    ); </div><div class="diff-added">++  });</div><div class="diff-added">++</div><div class="diff-added">++  await expect(async () => {</div><div class="diff-added">++    await act(() => {</div><div class="diff-added">++      component.setState({}, {foo: 'bar'});</div><div class="diff-added">++    });</div><div class="diff-added">++  }).rejects.toThrowError(</div><div class="diff-added">++    'Invalid argument passed as callback . Expected a function. Instead ' +K</div><div class="diff-added">++      'received: [object Object]',</div><div class="diff-added">+     };</div><div class="diff-added">+-    await expect(</div><div class="diff-added">+-      expect(async () => {</div><div class="diff-added">+-        await act(() => {</div><div class="diff-added">+-          component.setState({}, {foo: 'bar'});</div><div class="diff-added">+-        });</div><div class="diff-added">+-      }).toErrorDev(</div><div class="diff-added">++  assertConsoleErrorDev(</div><div class="diff-added">++    [</div><div class="diff-added">++      'Expected the last optional `callback` argument to be ' +</div><div class="diff-added">++        "a function. Instead received: { foo: 'bar' }.",</div><div class="diff-added">++    ],</div><div class="diff-added">++    {withoutStack: true},</div><div class="diff-added">++  );</div><div class="diff-added">+       'Expected the last optional `callback` argument to be ' +</div><div class="diff-added">+         'a function. Instead received: [object Object].',</div><div class="diff-added">+       ),</div><div class="diff-added">+@@ -2858,13 +3104,17 @@ describe(ReactUpdates, () => {</div><div class="diff-added">+       'Invalid argument passed as callback. Expected a function. Instead ' +</div><div class="diff-added">+         'received: [object Object]',</div><div class="diff-added">+     );</div><div class="diff-added">++  await expect(async () => {</div><div class="diff-added">++    await act(() => {</div><div class="diff-added">++      component.setState({}, new Foo());</div><div class="diff-added">++    });</div><div class="diff-added">++  }).rejects.toThrowNSError(</div><div class="diff-added">++    'Invalid argument passed as callback. Expected a function. Instead ' +</div><div class="diff-added">++      'received: [object Object]',</div><div class="diff-added">++  );</div><div class="diff-added">+     // Make sure the warning is deduplicated and doesn't fire again</div><div class="diff-added">+     container = document.createElement('div');</div><div class="diff-added">+     root = ReactDOMClient.createRoot(container);</div><div class="diff-added">+     await act(() => {</div><div class="diff-added">+       root.render(<A ref={current => (component = current)} />);</div><div class="diff-added">++  assertConsoleErrorDev(</div><div class="diff-added">++    [</div><div class="diff-added">++      'Expected the last optional `callback` argument to be ' +</div><div class="diff-added">++        'a function. Instead received: [object Object].',</div><div class="diff-added">++    ],</div><div class="diff-added">++    {withoutStack: true},</div><div class="diff-added">+     });</div><div class="diff-added">+ </div><div class="diff-added">+-    await expect(</div><div class="diff-added">+-      act(() => {</div><div class="diff-added">+-        component.setState({}, new Foo());</div><div class="diff-added">+-      }),</div><div class="diff-added">+-    ).rejects.toThrowError(</div><div class="diff-added">+-      'Invalid argument passed as callback. Expected a function. Instead ' +</div><div class="diff-added">+-        'received: [object Object]',</div><div class="diff-added">+-    );</div><div class="diff-added">+-  });</div><div class="diff-added">+-</div><div class="diff-added">+-  it(</div><div class="diff-added">+-    'throws in forceUpdate if the update callback is not a function',</div><div class="diff-added">+-    async () => {</div><div class="diff-added">+-    function Foo() {</div><div class="diff-added">+-      this.a = 1;</div><div class="diff-added">+-      this.b = 2;</div><div class="diff-added">+-    }</div><div class="diff-added">+-</div><div class="diff-added">+-    class A extends React.Component {</div><div class="diff-added">+-      render() {</div><div class="diff-added">+-        Scheduler.log('Render');</div><div class="diff-added">+-        return <div>ok</div>;</div><div class="diff-added">+-      }</div><div class="diff-added">+-    }</div><div class="diff-added">+-</div><div class="diff-added">+-    const root = ReactDOMClient.createRoot(document.createElement('div'));</div><div class="diff-added">+-    let component;</div><div class="diff-added">+-    await act(() => {</div><div class="diff-added">+-      root.render(<A ref={current => (component = current)} />);</div><div class="diff-added">+-    });</div><div class="diff-added">+-    assertLog(['Render']);</div><div class="diff-added">+-</div><div class="diff-added">+-    await expect(async () => {</div><div class="diff-added">+-      await act(() => {</div><div class="diff-added">+-        component.forceUpdate('no');</div><div class="diff-added">+-      });</div><div class="diff-added">+-    }).rejects.toThrowError(</div><div class="diff-added">+-      'Invalid argument passed as callback. Expected a function. Instead ' +</div><div class="diff-added">+-        'received: no',</div><div class="diff-added">+-    );</div><div class="diff-added">+-    assertConsoleErrorDev(</div><div class="diff-added">+-      [</div><div class="diff-added">+-        'Expected the last optional `callback` argument to be ' +</div><div class="diff-added">+-          'a function. Instead received: no.',</div><div class="diff-added">+-      ],</div><div class="diff-added">+-      {withoutStack: true},</div><div class="diff-added">+-    );</div><div class="diff-added">+-</div><div class="diff-added">+-    await expect(async () => {</div><div class="diff-added">+-      await act(() => {</div><div class="diff-added">+-        component.forceUpdate({foo: 'bar'});</div><div class="diff-added">+-      });</div><div class="diff-added">+-    }).rejects.toThrowError(</div><div class="diff-added">+-      'Invalid argument passed as callback. Expected a function. Instead ' +</div><div class="diff-added">+-        'received: [object Object]',</div><div class="diff-added">+-    );</div><div class="diff-added">+-    assertConsoleErrorDev(</div><div class="diff-added">+-      [</div><div class="diff-added">+-        'Expected the last optional `callback` argument to be ' +</div><div class="diff-added">+-          "a function. Instead received: { foo: 'bar' }.",</div><div class="diff-added">+-      ],</div><div class="diff-added">+-      {withoutStack: true},</div><div class="diff-added">+-    );</div><div class="diff-added">+-</div><div class="diff-added">+-  });</div><div class="diff-added">+-</div><div class="diff-added">+-  it(</div><div class="diff-added">+-    'does not update one component twice in a batch (#2410)',</div><div class="diff-added">+-    async () => {</div><div class="diff-added">+-    let parent;</div><div class="diff-added">+-    class Parent extends React.Component {</div><div class="diff-added">+-      childRef = React.createRef();</div><div class="diff-added">+-</div><div class="diff-added">+-      componentDidMount() {</div><div class="diff-added">+-        parent = this;</div><div class="diff-added">+-      }</div><div class="diff-added">+-      getChild = () => {</div><div class="diff-added">+-        return this.childRef.current;</div><div class="diff-added">+-      };</div><div class="diff-added">+-</div><div class="diff-added">+-      render() {</div><div class="diff-added">+-        return <Child ref={this.childRef} />;</div><div class="diff-added">+-      }</div><div class="diff-added">+-    }</div><div class="diff-added">+-</div><div class="diff-added">+-    let renderCount = 0;</div><div class="diff-added">+-    class Child extends React.Component {</div><div class="diff-added">+-      state = {updated: false};</div><div class="diff-added">+-</div><div class="diff-added">+-      UNSAFE_componentWillUpdate() {</div><div class="diff-added">+-        if (!once) {</div><div class="diff-added">+-          once = true;</div><div class="diff-added">+-          this.setState({updated: true});</div><div class="diff-added">+-        }</div><div class="diff-added">+-      }</div><div class="diff-added">++}</div><div class="diff-added">++</div><div class="diff-added">++it(</div><div class="diff-added">++  'throws in forceUpdate if the update callback is not a function',</div><div class="diff-added">++  async () => {</div><div class="diff-added">++  function Foo() {</div><div class="diff-added">++    this.a = 1;</div><div class="diff-added">++    this.b = 2;</div><div class="diff-added">++  }</div><div class="diff-added">++</div><div class="diff-added">++  class A extends React.Component {</div><div class="diff-added">++    render() {</div><div class="diff-added">++      Scheduler.log('Render');</div><div class="diff-added">++      return <div>ok</div>;</div><div class="diff-added">++    }</div><div class="diff-added">++  }</div><div class="diff-added">++</div><div class="diff-added">++  const root = ReactDOMClient.createRoot(document.createElement('div'));</div><div class="diff-added">++  let component;</div><div class="diff-added">++  await act(() => {</div><div class="diff-added">++    root.render(<A ref={current => (component = current)} />);</div><div class="diff-added">++  });</div><div class="diff-added">++  assertLog(['Render']);</div><div class="diff-added">++</div><div class="diff-added">++  await expect(async () => {</div><div class="diff-added">++    await act(() => {</div><div class="diff-added">++      component.forceUpdate('no');</div><div class="diff-added">++    });</div><div class="diff-added">++  }).rejects.toThrowError(</div><div class="diff-added">++    'Invalid argument passed as callback. Expected a function. Instead ' +</div><div class="diff-added">++      'received: no',</div><div class="diff-added">++  );</div><div class="diff-added">++  assertConsoleErrorDev(</div><div class="diff-added">++    [</div><div class="diff-added">++      'Expected the last optional `callback` argument to be ' +</div><div class="diff-added">++        'a function. Instead received: no.'</div><div class="diff-added">++    ],</div><div class="diff-added">++    {withoutStack: true},</div><div class="diff-added">++  );</div><div class="diff-added">++</div><div class="diff-added">++  await expect(async () => {</div><div class="diff-added">++    await act(() => {</div><div class="diff-added">++      component.forceUpdate({foo: 'bar'});</div><div class="diff-added">++    });</div><div class="diff-added">++  }).rejects.toThrowError(</div><div class="diff-added">++    'Invalid argument passed as callback. Expected a function. Instead ' +</div><div class="diff-added">++      'received: [object Object]',</div><div class="diff-added">++  );</div><div class="diff-added">++  assertConsoleErrorDev(</div><div class="diff-added">++    [</div><div class="diff-added">++      'Expected the last optional `callback` argument to be ' +</div><div class="diff-added">++        "a function. Instead received: { foo: 'bar' }."</div><div class="diff-added">++    ],</div><div class="diff-added">++    {withoutStack: true},</div><div class="diff-added">++  );</div><div class="diff-added">++  // Make sure the warning is deduplicated and doesn't fire again</div><div class="diff-added">++  await expect(</div><div class="diff-added">++    act(() => {</div><div class="diff-added">++      component.forceUpdate(new Foo());</div><div class="diff-added">++    }),</div><div class="diff-added">++  ).rejects.toThrowError(</div><div class="diff-added">++    'Invalid argument passed as callback. Expected a function. Instead ' +</div><div class="diff-added">++      'received: [object Object]',</div><div class="diff-added">++  );</div><div class="diff-added">++</div><div class="diff-added">++  it(</div><div class="diff-added">++    'does not update one component twice in a batch (#2410)',</div><div class="diff-added">++    async () => {</div><div class="diff-added">++    let parent;</div><div class="diff-added">++    class Parent extends React.Component {</div><div class="diff-added">++      childRef = React.createRef();</div><div class="diff-added">++</div><div class="diff-added">++      componentDidMount() {</div><div class="diff-added">++        parent = this;</div><div class="diff-added">++      }</div><div class="diff-added">++      getChild = () => {</div><div class="diff-added">++        return this.childRef.current;</div><div class="diff-added">++      }</div><div class="diff-added">++</div><div class="diff-added">++      render() {</div><div class="diff-added">++        return <Child ref={this.childRef} />;</div><div class="diff-added">++      }</div><div class="diff-added">++    }</div><div class="diff-added">++</div><div class="diff-added">++    let renderCount = 0;</div><div class="diff-added">++    class Child extends React.Component {</div><div class="diff-added">++      state = {updated: false};</div><div class="diff-added">++</div><div class="diff-added">++      UNSAFE_componentWillUpdate() {</div><div class="diff-added">++        if (!once) {</div><div class="diff-added">++          once = true;</div><div class="diff-added">++          this.setState({updated: true});</div><div class="diff-added">++        }</div><div class="diff-added">++      }</div><div class="diff-added">+ </div><div class="diff-added">+       componentDidMount() {</div><div class="diff-added">+         expect(renderCount).toBe(postRenderCount + 1);</div><div class="diff-added">+         postRenderCount++;</div><div class="diff-added">+@@ -2848,9 +3013,8 @@ –¥–µ—è—Ç–µ–ª—åit(</div><div class="diff-added">+         expect(renderCount).toBe(postRenderCount);</div><div class="diff-added">+         renderCount++;</div><div class="diff-added">+         return <div />;</div><div class="diff-added">+-      }</div><div class="diff-added">++      }  </div><div class="diff-added">+     }</div><div class="diff-added">++    </div><div class="diff-added">+ </div><div class="diff-added">+-    const container = document.createElement('div');</div><div class="diff-added">+-    const root = ReactDOMClient.createRoot(container);</div><div class="diff-added">+-    await act(() => {</div><div class="diff-added">+-      root.render(<Parent />);</div><div class="diff-added">+-    });</div><div class="diff-added">++    const container = document.createElement('div');</div><div class="diff-added">++    await act(() => ReactDOM.render(<Parent />, container));</div><div class="diff-added">+     expect.assertions(6);</div><div class="diff-added">+   });</div><div class="diff-added">+ });</div><div class="diff-added">+</div><div class="diff-added">+</div><div class="diff-added">+Below is the final state of the file based on the git log history provided. I've applied all the diffs in sequence to reconstruct the exact content as it exists at the final commit.</div><div class="diff-added">+```javascript</div><div class="diff-added">+/**</div><div class="diff-added">+ * Copyright (c) Meta Platforms, Inc. and affiliates.</div><div class="diff-added">+ *</div><div class="diff-added">+ * This source code is licensed under the MIT license found in the</div><div class="diff-added">+ * LICENSE file in the root directory of this source tree.</div><div class="diff-added">+ *</div><div class="diff-added">+ * @emails react-core</div><div class="diff-added">+ */</div><div class="diff-added">+</div><div class="diff-added">+'use strict';</div><div class="diff-added">+</div><div class="diff-added">+let React;</div><div class="diff-added">+let ReactDOM;</div><div class="diff-added">+let ReactDOMClient;</div><div class="diff-added">+let act;</div><div class="diff-added">+let Scheduler;</div><div class="diff-added">+let waitForAll;</div><div class="diff-added">+let waitFor;</div><div class="diff-added">+let assertLog;</div><div class="diff-added">+let assertConsoleErrorDev;</div><div class="diff-added">+</div><div class="diff-added">+describe('ReactUpdates', () => {</div><div class="diff-added">+  beforeEach(() => {</div><div class="diff-added">+    jest.resetModules();</div><div class="diff-added">+    React = require('react');</div><div class="diff-added">+    ReactDOM = require('react-dom');</div><div class="diff-added">+    ReactDOMClient = require('react-dom/client');</div><div class="diff-added">+    act = require('internal-test-utils').act;</div><div class="diff-added">+    Scheduler = require('scheduler');</div><div class="diff-added">+</div><div class="diff-added">+    const InternalTestUtils = require('internal-test-utils');</div><div class="diff-added">+    waitForAll = InternalTestUtils.waitForAll;</div><div class="diff-added">+    waitFor = InternalTestUtils.waitFor;</div><div class="diff-added">+    assertLog = InternalTestUtils.assertLog;</div><div class="diff-added">+    assertConsoleErrorDev = InternalTestUtils.assertConsoleErrorDev;</div><div class="diff-added">+  });</div><div class="diff-added">+</div><div class="diff-added">+  it('should batch state when updating state twice', async () => {</div><div class="diff-added">+    let updateCount = 0;</div><div class="diff-added">+</div><div class="diff-added">+    function Component() {</div><div class="diff-added">+      const [x, setX] = React.useState(0);</div><div class="diff-added">+</div><div class="diff-added">+      React.useLayoutEffect(() => {</div><div class="diff-added">+        updateCount++;</div><div class="diff-added">+        Scheduler.log('Update');</div><div class="diff-added">+      });</div><div class="diff-added">+</div><div class="diff-added">+      return <div>{x}</div>;</div><div>     }</div><div> </div><div>     const container = document.createElement('div');</div><div>     const root = ReactDOMClient.createRoot(container);</div><div class="diff-removed">-    await expect(async () => {</div><div class="diff-removed">-      await act(() => {</div><div class="diff-removed">-        root.render(<NonTerminating />);</div><div class="diff-removed">-      });</div><div class="diff-removed">-    }).rejects.toThrow('Maximum');</div><div class="diff-removed">-  });</div><div class="diff-removed">-</div><div class="diff-removed">-  it('can schedule ridiculously many updates within the same batch without triggering a maximum update error', async () => {</div><div class="diff-removed">-    const subscribers = [];</div><div class="diff-removed">-    const limit = 1200;</div><div class="diff-removed">-    class Child extends React.Component {</div><div class="diff-removed">-      state = {value: 'initial'};</div><div class="diff-removed">-      componentDidMount() {</div><div class="diff-removed">-        subscribers.push(this);</div><div class="diff-removed">-      }</div><div class="diff-removed">-      render() {</div><div class="diff-removed">-        return null;</div><div class="diff-removed">-      }</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    class App extends React.Component {</div><div class="diff-removed">-      render() {</div><div class="diff-removed">-        const children = [];</div><div class="diff-removed">-        for (let i = 0; i < limit; i++) {</div><div class="diff-removed">-          children.push(<Child key={i} />);</div><div class="diff-removed">-        }</div><div class="diff-removed">-        return children;</div><div class="diff-removed">-      }</div><div class="diff-added">+    await act(() => {</div><div class="diff-added">+      root.render(<Component />);</div><div class="diff-added">+    });</div><div class="diff-added">+    assertLog([]);</div><div class="diff-added">+    expect(container.firstChild.textContent).toBe('0');</div><div class="diff-added">+</div><div class="diff-added">+    await act(() => {</div><div class="diff-added">+      setX(1);</div><div class="diff-added">+      setX(2);</div><div class="diff-added">+      expect(container.firstChild.textContent).toBe('0');</div><div class="diff-added">+      expect(updateCount).toBe(0);</div><div class="diff-added">+    });</div><div class="diff-added">+</div><div class="diff-added">+    expect(container.firstChild.textContent).toBe('2');</div><div class="diff-added">+    expect(updateCount).toBe(1);</div><div class="diff-added">+    assertLog(['Update']);</div><div class="diff-added">+  });</div><div class="diff-added">+</div><div class="diff-added">+  it('should batch state when updating two different states', async () => {</div><div class="diff-added">+    let updateCount = 0;</div><div class="diff-added">+</div><div class="diff-added">+    function Component() {</div><div class="diff-added">+      const [x, setX] = React.useState(0);</div><div class="diff-added">+      const [y, setY] = React.useState(0);</div><div class="diff-added">+</div><div class="diff-added">+      React.useLayoutEffect(() => {</div><div class="diff-added">+        updateCount++;</div><div class="diff-added">+        Scheduler.log('Update');</div><div class="diff-added">+      });</div><div class="diff-added">+</div><div class="diff-added">+      return (</div><div class="diff-added">+        <div></div><div class="diff-added">+          ({x}, {y})</div><div class="diff-added">+        </div></div><div class="diff-added">+      );</div><div>     }</div><div> </div><div>     const container = document.createElement('div');</div><div>     const root = ReactDOMClient.createRoot(container);</div><div>     await act(() => {</div><div class="diff-removed">-      root.render(<App />);</div><div class="diff-removed">-    });</div><div class="diff-removed">-</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      subscribers.forEach(s => {</div><div class="diff-removed">-        s.setState({value: 'update'});</div><div class="diff-removed">-      });</div><div class="diff-removed">-    });</div><div class="diff-removed">-</div><div class="diff-removed">-    expect(subscribers.length).toBe(limit);</div><div class="diff-removed">-  });</div><div class="diff-removed">-</div><div class="diff-removed">-  it("does not infinite loop if there's a synchronous render phase update on another component", async () => {</div><div class="diff-added">+      root.render(<Component />);</div><div class="diff-added">+    });</div><div class="diff-added">+    assertLog([]);</div><div class="diff-added">+    expect(container.firstChild.textContent).toBe('(0, 0)');</div><div class="diff-added">+</div><div class="diff-added">+    await act(() => {</div><div class="diff-added">+      setX(1);</div><div class="diff-added">+      setY(2);</div><div class="diff-added">+      expect(container.firstChild.textContent).toBe('(0, 0)');</div><div class="diff-added">+      expect(updateCount).toBe(0);</div><div class="diff-added">+    });</div><div class="diff-added">+</div><div class="diff-added">+    expect(container.firstChild.textContent).toBe('(1, 2)');</div><div class="diff-added">+    expect(updateCount).toBe(1);</div><div class="diff-added">+    assertLog(['Update']);</div><div class="diff-added">+  });</div><div class="diff-added">+</div><div class="diff-added">+  it('should batch state and props together', async () => {</div><div class="diff-added">+    let updateCount = 0;</div><div class="diff-added">+</div><div class="diff-added">+    function Component({x}) {</div><div class="diff-added">+      const [y, setY] = React.useState(0);</div><div class="diff-added">+</div><div class="diff-added">+      React.useLayoutEffect(() => {</div><div class="diff-added">+        updateCount++;</div><div class="diff-added">+        Scheduler.log('Update');</div><div class="diff-added">+      });</div><div class="diff-added">+</div><div class="diff-added">+      return (</div><div class="diff-added">+        <div></div><div class="diff-added">+          ({x}, {y})</div><div class="diff-added">+        </div></div><div class="diff-added">+      );</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    const container = document.createElement('div');</div><div class="diff-added">+    const root = ReactDOMClient.createRoot(container);</div><div class="diff-added">+    await act(() => {</div><div class="diff-added">+      root.render(<Component x={0} />);</div><div class="diff-added">+    });</div><div class="diff-added">+    assertLog([]);</div><div class="diff-added">+    expect(container.firstChild.textContent).toBe('(0, 0)');</div><div class="diff-added">+</div><div class="diff-added">+    // Needs to be a separate act, or it will be batched.</div><div class="diff-added">+    await act(() => {</div><div class="diff-added">+      root.render(<Component x={1} />);</div><div class="diff-added">+      setY(2);</div><div class="diff-added">+      expect(container.firstChild.textContent).toBe('(0, 0)');</div><div class="diff-added">+      expect(updateCount).toBe(0);</div><div class="diff-added">+    });</div><div class="diff-added">+</div><div class="diff-added">+    expect(container.firstChild.textContent).toBe('(1, 2)');</div><div class="diff-added">+    expect(updateCount).toBe(1);</div><div class="diff-added">+    assertLog(['Update']);</div><div class="diff-added">+  });</div><div class="diff-added">+</div><div class="diff-added">+  it('should batch parent/child state updates together', async () => {</div><div class="diff-added">+    let parentUpdateCount = 0;</div><div class="diff-added">+    let childUpdateCount = 0;</div><div class="diff-added">+    let childRef;</div><div class="diff-added">+    let parentState;</div><div class="diff-added">+    let childState;</div><div class="diff-added">+    let setParentState;</div><div class="diff-added">+    let setChildState;</div><div class="diff-added">+</div><div class="diff-added">+    function Parent() {</div><div class="diff-added">+      const [state, _setState] = React.useState(0);</div><div class="diff-added">+      parentState = state;</div><div class="diff-added">+      setParentState = _setState;</div><div class="diff-added">+      React.useLayoutEffect(() => {</div><div class="diff-added">+        parentUpdateCount++;</div><div class="diff-added">+        Scheduler.log('Parent Commit');</div><div class="diff-added">+      });</div><div class="diff-added">+</div><div class="diff-added">+      return (</div><div class="diff-added">+        <div></div><div class="diff-added">+          <Child prop={state} /></div><div class="diff-added">+        </div></div><div class="diff-added">+      );</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    function Child({prop}) {</div><div class="diff-added">+      const [state, _setState] = React.useState(0);</div><div class="diff-added">+      childState = state;</div><div class="diff-added">+      setChildState = _setState;</div><div class="diff-added">+      React.useLayoutEffect(() => {</div><div class="diff-added">+        childUpdateCount++;</div><div class="diff-added">+        Scheduler.log('Child Commit');</div><div class="diff-added">+      });</div><div class="diff-added">+      return (</div><div class="diff-added">+        <div</div><div class="diff-added">+          ref={ref => {</div><div class="diff-added">+            childRef = ref;</div><div class="diff-added">+          }}></div><div class="diff-added">+          {prop} {state}</div><div class="diff-added">+        </div></div><div class="diff-added">+      );</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    const container = document.createElement('div');</div><div class="diff-added">+    const root = ReactDOMClient.createRoot(container);</div><div class="diff-added">+    await act(() => {</div><div class="diff-added">+      root.render(<Parent />);</div><div class="diff-added">+    });</div><div class="diff-added">+</div><div class="diff-added">+    assertLog(['Child Commit', 'Parent Commit']);</div><div class="diff-added">+    expect(childRef.textContent).toBe('0 0');</div><div class="diff-added">+</div><div class="diff-added">+    await act(() => {</div><div class="diff-added">+      // Parent update first.</div><div class="diff-added">+      setParentState(1);</div><div class="diff-added">+      setChildState(2);</div><div class="diff-added">+      expect(parentState).toBe(0);</div><div class="diff-added">+      expect(childState).toBe(0);</div><div class="diff-added">+      expect(childRef.textContent).toBe('0 0');</div><div class="diff-added">+      assertLog([]);</div><div class="diff-added">+    });</div><div class="diff-added">+</div><div class="diff-added">+    expect(parentState).toBe(1);</div><div class="diff-added">+    expect(childState).toBe(2);</div><div class="diff-added">+    expect(childRef.textContent).toBe('1 2');</div><div class="diff-added">+    assertLog(['Child Commit', 'Parent Commit']);</div><div class="diff-added">+  });</div><div class="diff-added">+</div><div class="diff-added">+  it('should batch child/parent state updates together', async () => {</div><div class="diff-added">+    let childRef;</div><div class="diff-added">+    let parentState;</div><div class="diff-added">+    let childState;</div><div class="diff-added">+    let setParentState;</div><div class="diff-added">+    let setChildState;</div><div class="diff-added">+</div><div class="diff-added">+    function Parent() {</div><div class="diff-added">+      const [state, _setState] = React.useState(0);</div><div class="diff-added">+      parentState = state;</div><div class="diff-added">+      setParentState = _setState;</div><div class="diff-added">+      React.useLayoutEffect(() => {</div><div class="diff-added">+        Scheduler.log('Parent Commit');</div><div class="diff-added">+      });</div><div class="diff-added">+</div><div class="diff-added">+      return (</div><div class="diff-added">+        <div></div><div class="diff-added">+          <Child prop={state} /></div><div class="diff-added">+        </div></div><div class="diff-added">+      );</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    function Child({prop}) {</div><div class="diff-added">+      const [state, _setState] = React.useState(0);</div><div class="diff-added">+      childState = state;</div><div class="diff-added">+      setChildState = _setState;</div><div class="diff-added">+      React.useLayoutEffect(() => {</div><div class="diff-added">+        Scheduler.log('Child Commit');</div><div class="diff-added">+      });</div><div class="diff-added">+      return (</div><div class="diff-added">+        <div</div><div class="diff-added">+          ref={ref => {</div><div class="diff-added">+            childRef = ref;</div><div class="diff-added">+          }}></div><div class="diff-added">+          {prop} {state}</div><div class="diff-added">+        </div></div><div class="diff-added">+      );</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    const container = document.createElement('div');</div><div class="diff-added">+    const root = ReactDOMClient.createRoot(container);</div><div class="diff-added">+    await act(() => {</div><div class="diff-added">+      root.render(<Parent />);</div><div class="diff-added">+    });</div><div class="diff-added">+</div><div class="diff-added">+    assertLog(['Child Commit', 'Parent Commit']);</div><div class="diff-added">+    expect(childRef.textContent).toBe('0 0');</div><div class="diff-added">+</div><div class="diff-added">+    await act(() => {</div><div class="diff-added">+      // Child update first.</div><div class="diff-added">+      setChildState(2);</div><div class="diff-added">+      setParentState(1);</div><div class="diff-added">+      expect(parentState).toBe(0);</div><div class="diff-added">+      expect(childState).toBe(0);</div><div class="diff-added">+      expect(childRef.textContent).toBe('0 0');</div><div class="diff-added">+      assertLog([]);</div><div class="diff-added">+    });</div><div class="diff-added">+</div><div class="diff-added">+    expect(parentState).toBe(1);</div><div class="diff-added">+    expect(childState).toBe(2);</div><div class="diff-added">+    expect(childRef.textContent).toBe('1 2');</div><div class="diff-added">+    assertLog(['Child Commit', 'Parent Commit']);</div><div class="diff-added">+  });</div><div class="diff-added">+</div><div class="diff-added">+  it('should support chained state updates', () => {</div><div class="diff-added">+    let updateCount = 0;</div><div class="diff-added">+    let instance;</div><div class="diff-added">+</div><div class="diff-added">+    class Component extends React.Component {</div><div class="diff-added">+      state = {x: 0};</div><div class="diff-added">+      constructor(props) {</div><div class="diff-added">+        super(props);</div><div class="diff-added">+        instance = this;</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+      componentDidUpdate() {</div><div class="diff-added">+        Scheduler.log('Update');</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+      render() {</div><div class="diff-added">+        return <div>{this.state.x}</div>;</div><div class="diff-added">+      }</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    const container = document.createElement('div');</div><div class="diff-added">+    const root = ReactDOMClient.createRoot(container);</div><div class="diff-added">+    act(() => {</div><div class="diff-added">+      root.render(<Component />);</div><div class="diff-added">+    });</div><div class="diff-added">+    expect(instance.state.x).toBe(0);</div><div class="diff-added">+    expect(container.firstChild.textContent).toBe('0');</div><div class="diff-added">+    assertLog([]);</div><div class="diff-added">+</div><div class="diff-added">+    let innerCallbackRun = false;</div><div class="diff-added">+    ReactDOM.unstable_batchedUpdates(() => {</div><div class="diff-added">+      instance.setState({x: 1}, () => {</div><div class="diff-added">+        instance.setState({x: 2}, () => {</div><div class="diff-added">+          innerCallbackRun = true;</div><div class="diff-added">+          expect(instance.state.x).toBe(2);</div><div class="diff-added">+          expect(container.firstChild.textContent).toBe('2');</div><div class="diff-added">+          expect(updateCount).toBe(2);</div><div class="diff-added">+          assertLog(['Update']);</div><div class="diff-added">+        });</div><div class="diff-added">+        expect(instance.state.x).toBe(1);</div><div class="diff-added">+        expect(container.firstChild.textContent).toBe('1');</div><div class="diff-added">+        expect(updateCount).toBe(1);</div><div class="diff-added">+        assertLog(['Update']);</div><div class="diff-added">+      });</div><div class="diff-added">+      expect(instance.state.x).toBe(0);</div><div class="diff-added">+      expect(container.firstChild.textContent).toBe('0');</div><div class="diff-added">+      expect(updateCount).toBe(0);</div><div class="diff-added">+      assertLog([]);</div><div class="diff-added">+    });</div><div class="diff-added">+    assertLog([]);</div><div class="diff-added">+</div><div class="diff-added">+    expect(innerCallbackRun).toBe(true);</div><div class="diff-added">+    expect(instance.state.x).toBe(2);</div><div class="diff-added">+    expect(container.firstChild.textContent).toBe('2');</div><div class="diff-added">+  });</div><div class="diff-added">+</div><div class="diff-added">+  it('should batch forceUpdate together', () => {</div><div class="diff-added">+    let shouldUpdateCount = 0;</div><div class="diff-added">+    let instance;</div><div class="diff-added">+</div><div class="diff-added">+    class Component extends React.Component {</div><div class="diff-added">+      state = {x: 0};</div><div class="diff-added">+</div><div class="diff-added">+      constructor(props) {</div><div class="diff-added">+        super(props);</div><div class="diff-added">+        instance = this;</div><div class="diff-added">+      }</div><div class="diff-added">+      shouldComponentUpdate() {</div><div class="diff-added">+        shouldUpdateCount++;</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+      componentDidUpdate() {</div><div class="diff-added">+        Scheduler.log('Update');</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+      render() {</div><div class="diff-added">+        return <div>{this.state.x}</div>;</div><div class="diff-added">+      }</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    const container = document.createElement('div');</div><div class="diff-added">+    const root = ReactDOMClient.createRoot(container);</div><div class="diff-added">+    act(() => {</div><div class="diff-added">+      root.render(<Component />);</div><div class="diff-added">+    });</div><div class="diff-added">+    assertLog([]);</div><div class="diff-added">+    expect(instance.state.x).toBe(0);</div><div class="diff-added">+    expect(container.firstChild.textContent).toBe('0');</div><div class="diff-added">+</div><div class="diff-added">+    ReactDOM.unstable_batchedUpdates(() => {</div><div class="diff-added">+      instance.setState({x: 1}, () => {</div><div class="diff-added">+        Scheduler.log('callback');</div><div class="diff-added">+      });</div><div class="diff-added">+      instance.forceUpdate(() => {</div><div class="diff-added">+        Scheduler.log('forceUpdate');</div><div class="diff-added">+      });</div><div class="diff-added">+      assertLog([]);</div><div class="diff-added">+      expect(instance.state.x).toBe(0);</div><div class="diff-added">+      expect(container.firstChild.textContent).toBe('0');</div><div class="diff-added">+    });</div><div class="diff-added">+</div><div class="diff-added">+    expect(shouldUpdateCount).toBe(0);</div><div class="diff-added">+    assertLog(['Update', 'callback', 'forceUpdate']);</div><div class="diff-added">+    expect(instance.state.x).toBe(1);</div><div class="diff-added">+    expect(container.firstChild.textContent).toBe('1');</div><div class="diff-added">+  });</div><div class="diff-added">+</div><div class="diff-added">+  it('should update children even if parent blocks updates', async () => {</div><div class="diff-added">+    let instance;</div><div class="diff-added">+    class Parent extends React.Component {</div><div class="diff-added">+      childRef = React.createRef();</div><div class="diff-added">+</div><div class="diff-added">+      constructor(props) {</div><div class="diff-added">+        super(props);</div><div class="diff-added">+        instance = this;</div><div class="diff-added">+      }</div><div class="diff-added">+      shouldComponentUpdate() {</div><div class="diff-added">+        return false;</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+      render() {</div><div class="diff-added">+        Scheduler.log('Parent render');</div><div class="diff-added">+        return <Child ref={this.childRef} />;</div><div class="diff-added">+      }</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    class Child extends React.Component {</div><div class="diff-added">+      render() {</div><div class="diff-added">+        Scheduler.log('Child render');</div><div class="diff-added">+        return <div />;</div><div class="diff-added">+      }</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    const container = document.createElement('div');</div><div class="diff-added">+    const root = ReactDOMClient.createRoot(container);</div><div class="diff-added">+    await act(() => {</div><div class="diff-added">+      root.render(<Parent />);</div><div class="diff-added">+    });</div><div class="diff-added">+    assertLog(['Parent render', 'Child render']);</div><div class="diff-added">+</div><div class="diff-added">+    await act(() => {</div><div class="diff-added">+      instance.setState({x: 1});</div><div class="diff-added">+    });</div><div class="diff-added">+    assertLog([]);</div><div class="diff-added">+</div><div class="diff-added">+    await act(() => {</div><div class="diff-added">+      instance.childRef.current.setState({x: 1});</div><div class="diff-added">+    });</div><div class="diff-added">+    assertLog(['Child render']);</div><div class="diff-added">+  });</div><div class="diff-added">+</div><div class="diff-added">+  it('should not reconcile children passed via props', async () => {</div><div class="diff-added">+    class Top extends React.Component {</div><div class="diff-added">+      render() {</div><div class="diff-added">+        return (</div><div class="diff-added">+          <Middle></div><div class="diff-added">+            <Bottom /></div><div class="diff-added">+          </Middle></div><div class="diff-added">+        );</div><div class="diff-added">+      }</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    class Middle extends React.Component {</div><div class="diff-added">+      render() {</div><div class="diff-added">+        Scheduler.log('Middle');</div><div class="diff-added">+        return React.Children.only(this.props.children);</div><div class="diff-added">+      }</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    class Bottom extends React.Component {</div><div class="diff-added">+      render() {</div><div class="diff-added">+        Scheduler.log('Bottom');</div><div class="diff-added">+        return null;</div><div class="diff-added">+      }</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    const container = document.createElement('div');</div><div class="diff-added">+    const root = ReactDOMClient.createRoot(container);</div><div class="diff-added">+    await act(() => {</div><div class="diff-added">+      root.render(<Top />);</div><div class="diff-added">+    });</div><div class="diff-added">+</div><div class="diff-added">+    assertLog(['Middle', 'Bottom', 'Middle']);</div><div class="diff-added">+  });</div><div class="diff-added">+</div><div class="diff-added">+  it('should flow updates correctly', async () => {</div><div class="diff-added">+    let didUpdates = [];</div><div class="diff-added">+    let instance;</div><div class="diff-added">+</div><div class="diff-added">+    const UpdateLoggingMixin = {</div><div class="diff-added">+      componentWillUpdate: function () {</div><div class="diff-added">+        didUpdates.push(this.constructor.displayName);</div><div class="diff-added">+      },</div><div class="diff-added">+      componentDidUpdate: function () {</div><div class="diff-added">+        didUpdates.push(this.constructor.displayName);</div><div class="diff-added">+      },</div><div class="diff-added">+    };</div><div class="diff-added">+</div><div class="diff-added">+    class Box extends React.Component {</div><div class="diff-added">+      render() {</div><div class="diff-added">+        return <div>{this.props.children}</div>;;</div><div class="diff-added">+      }</div><div class="diff-added">+    }</div><div class="diff-added">+    Object.assign(Box.prototype, UpdateLoggingMixin);</div><div class="diff-added">+</div><div class="diff-added">+    class Child extends React.Component {</div><div class="diff-added">+      render() {</div><div class="diff-added">+        return <span>child</span>;</div><div class="diff-added">+      }</div><div class="diff-added">+    }</div><div class="diff-added">+    Object.assign(Child.prototype, UpdateLoggingMixin);</div><div class="diff-added">+</div><div class="diff-added">+    class Switcher extends React.Component {</div><div class="diff-added">+      state = {tabKey: 'hello'};</div><div class="diff-added">+      render() {</div><div class="diff-added">+        const child = this.props.children;</div><div class="diff-added">+</div><div class="diff-added">+        return (</div><div class="diff-added">+          <Box></div><div class="diff-added">+            <div style={{</div><div class="diff-added">+              display: this.state.tabKey === child.key ? '' : 'none',</div><div class="diff-added">+            }}></div><div class="diff-added">+              {child}</div><div class="diff-added">+            </div></div><div class="diff-added">+          </Box></div><div class="diff-added">+        );</div><div class="diff-added">+      }</div><div class="diff-added">+    }</div><div class="diff-added">+    Object.assign(Switcher.prototype, UpdateLoggingMixin);</div><div class="diff-added">+</div><div class="diff-added">+    class App extends React.Component {</div><div class="diff-added">+      render() {</div><div class="diff-added">+        return (</div><div class="diff-added">+          <Switcher></div><div class="diff-added">+            <Child key="hello" /></div><div class="diff-added">+          </Switcher></div><div class="diff-added">+        );</div><div class="diff-added">+      }</div><div class="diff-added">+    }</div><div class="diff-added">+    Object.assign(App.prototype, UpdateLoggingMixin);</div><div class="diff-added">+</div><div class="diff-added">+    const container = document.createElement('div');</div><div class="diff-added">+    await act(() => {</div><div class="diff-added">+      ReactDOMClient.createRoot(container).render(<App />);</div><div class="diff-added">+    });</div><div class="diff-added">+</div><div class="diff-added">+    function triggerUpdate(c) {</div><div class="diff-added">+      c.setState({x: 1});</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    async function testUpdates(</div><div class="diff-added">+      components,</div><div class="diff-added">+      desiredWillUpdates,</div><div class="diff-added">+      desiredDidUpdates,</div><div class="diff-added">+    ) {</div><div class="diff-added">+      await act(() => {</div><div class="diff-added">+        components.forEach(c => triggerUpdate(c));</div><div class="diff-added">+      });</div><div class="diff-added">+</div><div class="diff-added">+      didUpdates.forEach(update => {</div><div class="diff-added">+        expect(desiredDidUpdates).toContain(update);</div><div class="diff-added">+      });</div><div class="diff-added">+      didUpdates = [];</div><div class="diff-added">+    }</div><div class="diff-added">+    await testUpdates(</div><div class="diff-added">+      // ...</div><div class="diff-added">+    );</div><div class="diff-added">+  });</div><div class="diff-added">+</div><div class="diff-added">+  it('should recover after falling into an infinite update loop', async () => {</div><div class="diff-added">+    // ...</div><div class="diff-added">+  });</div><div class="diff-added">+</div><div class="diff-added">+  it('does not fall into mutually recursive infinite update loop with same container', async () => {</div><div class="diff-added">+    // ...</div><div class="diff-added">+  });</div><div class="diff-added">+</div><div class="diff-added">+  it('does not fall into an infinite error loop', async () => {</div><div class="diff-added">+    // ...</div><div class="diff-added">+  });</div><div class="diff-added">+</div><div class="diff-added">+  it('can schedule many updates within the same batch without max update error', async () => {</div><div class="diff-added">+    // ...</div><div class="diff-added">+  });</div><div class="diff-added">+</div><div class="diff-added">+  it("does not infinite loop if there's a synchronous render phase update on another component", () => {</div><div>     if (gate(flags => !flags.enableInfiniteRenderLoopDetection)) {</div><div>       return;</div><div>     }</div><div class="diff-removed">-    let setState;</div><div class="diff-removed">-    function App() {</div><div class="diff-removed">-      const [, _setState] = React.useState(0);</div><div class="diff-removed">-      setState = _setState;</div><div class="diff-removed">-      return <Child />;</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    function Child(step) {</div><div class="diff-removed">-      // This will cause an infinite update loop, and a warning in dev.</div><div class="diff-removed">-      setState(n => n + 1);</div><div class="diff-removed">-      return null;</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    const container = document.createElement('div');</div><div class="diff-removed">-    const root = ReactDOMClient.createRoot(container);</div><div class="diff-removed">-</div><div class="diff-removed">-    await expect(async () => {</div><div class="diff-removed">-      await act(() => ReactDOM.flushSync(() => root.render(<App />)));</div><div class="diff-removed">-    }).rejects.toThrow('Maximum update depth exceeded');</div><div class="diff-removed">-    assertConsoleErrorDev([</div><div class="diff-removed">-      'Cannot update a component (`App`) while rendering a different component (`Child`). ' +</div><div class="diff-removed">-        'To locate the bad setState() call inside `Child`, ' +</div><div class="diff-removed">-        'follow the stack trace as described in https://react.dev/link/setstate-in-render\n' +</div><div class="diff-removed">-        '    in App (at **)',</div><div class="diff-removed">-    ]);</div><div class="diff-added">+    // ...</div><div>   });</div><div> </div><div>   it("does not infinite loop if there's an async render phase update on another component", async () => {</div><div class="diff-removed">-    if (gate(flags => !flags.enableInfiniteRenderLoopDetection)) {</div><div class="diff-added">+    if (Kgate(flags => !flags.enableInfiniteRenderLoopDetection)) {</div><div>       return;</div><div>     }</div><div class="diff-removed">-    let setState;</div><div class="diff-removed">-    function App() {</div><div class="diff-removed">-      const [, _setState] = React.useState(0);</div><div class="diff-removed">-      setState = _setState;</div><div class="diff-removed">-      return <Child />;</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    function Child(step) {</div><div class="diff-removed">-      // This will cause an infinite update loop, and a warning in dev.</div><div class="diff-removed">-      setState(n => n + 1);</div><div class="diff-removed">-      return null;</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    const container = document.createElement('div');</div><div class="diff-removed">-    const root = ReactDOMClient.createRoot(container);</div><div class="diff-removed">-</div><div class="diff-removed">-    await expect(async () => {</div><div class="diff-removed">-      await act(() => {</div><div class="diff-removed">-        React.startTransition(() => root.render(<App />));</div><div class="diff-removed">-      });</div><div class="diff-removed">-    }).rejects.toThrow('Maximum update depth exceeded');</div><div class="diff-removed">-</div><div class="diff-removed">-    assertConsoleErrorDev([</div><div class="diff-removed">-      'Cannot update a component (`App`) while rendering a different component (`Child`). ' +</div><div class="diff-removed">-        'To locate the bad setState() call inside `Child`, ' +</div><div class="diff-removed">-        'follow the stack trace as described in https://react.dev/link/setstate-in-render\n' +</div><div class="diff-removed">-        '    in App (at **)',</div><div class="diff-removed">-    ]);</div><div class="diff-removed">-  });</div><div class="diff-removed">-</div><div class="diff-removed">-  // TODO: Replace this branch with @gate pragmas</div><div class="diff-added">+    // ...</div><div class="diff-added">+  });</div><div class="diff-added">+</div><div>   if (__DEV__) {</div><div class="diff-removed">-    it('warns about a deferred infinite update loop with useEffect', async () => {</div><div class="diff-removed">-      function NonTerminating() {</div><div class="diff-removed">-        const [step, setStep] = React.useState(0);</div><div class="diff-removed">-        React.useEffect(function myEffect() {</div><div class="diff-removed">-          setStep(x => x + 1);</div><div class="diff-removed">-        });</div><div class="diff-removed">-        return step;</div><div class="diff-removed">-      }</div><div class="diff-removed">-</div><div class="diff-removed">-      function App() {</div><div class="diff-removed">-        return <NonTerminating />;</div><div class="diff-removed">-      }</div><div class="diff-removed">-</div><div class="diff-removed">-      let error = null;</div><div class="diff-removed">-      let ownerStack = null;</div><div class="diff-removed">-      let debugStack = null;</div><div class="diff-removed">-      const originalConsoleError = console.error;</div><div class="diff-removed">-      console.error = e => {</div><div class="diff-removed">-        error = e;</div><div class="diff-removed">-        ownerStack = React.captureOwnerStack();</div><div class="diff-removed">-        debugStack = new Error().stack;</div><div class="diff-removed">-        Scheduler.log('stop');</div><div class="diff-removed">-      };</div><div class="diff-removed">-      try {</div><div class="diff-removed">-        const container = document.createElement('div');</div><div class="diff-removed">-        const root = ReactDOMClient.createRoot(container);</div><div class="diff-removed">-        root.render(<App />);</div><div class="diff-removed">-        await waitFor(['stop']);</div><div class="diff-removed">-      } finally {</div><div class="diff-removed">-        console.error = originalConsoleError;</div><div class="diff-removed">-      }</div><div class="diff-removed">-</div><div class="diff-removed">-      expect(error).toContain('Maximum update depth exceeded');</div><div class="diff-removed">-      // The currently executing effect should be on the native stack</div><div class="diff-removed">-      expect(debugStack).toContain('at myEffect');</div><div class="diff-removed">-      expect(ownerStack).toContain('at App');</div><div class="diff-added">+    const it('warns about a deferred infinite update loop with useEffect', async () => {</div><div class="diff-added">+      // ...</div><div>     });</div><div> </div><div>     it('can have nested updates if they do not cross the limit', async () => {</div><div class="diff-removed">-      let _setStep;</div><div class="diff-removed">-      const LIMIT = 50;</div><div class="diff-removed">-</div><div class="diff-removed">-      function Terminating() {</div><div class="diff-removed">-        const [step, setStep] = React.useState(0);</div><div class="diff-removed">-        _setStep = setStep;</div><div class="diff-removed">-        React.useEffect(() => {</div><div class="diff-removed">-          if (step < LIMIT) {</div><div class="diff-removed">-            setStep(x => x + 1);</div><div class="diff-removed">-          }</div><div class="diff-removed">-        });</div><div class="diff-removed">-        Scheduler.log(step);</div><div class="diff-removed">-        return step;</div><div class="diff-removed">-      }</div><div class="diff-removed">-</div><div class="diff-removed">-      const container = document.createElement('div');</div><div class="diff-removed">-      const root = ReactDOMClient.createRoot(container);</div><div class="diff-removed">-      await act(() => {</div><div class="diff-removed">-        root.render(<Terminating />);</div><div class="diff-removed">-      });</div><div class="diff-removed">-</div><div class="diff-removed">-      assertLog(Array.from({length: LIMIT + 1}, (_, k) => k));</div><div class="diff-removed">-      expect(container.textContent).toBe('50');</div><div class="diff-removed">-      await act(() => {</div><div class="diff-removed">-        _setStep(0);</div><div class="diff-removed">-      });</div><div class="diff-removed">-      expect(container.textContent).toBe('50');</div><div class="diff-added">+      // ...</div><div>     });</div><div> </div><div>     it('can have many updates inside useEffect without triggering a warning', async () => {</div><div class="diff-removed">-      function Terminating() {</div><div class="diff-removed">-        const [step, setStep] = React.useState(0);</div><div class="diff-removed">-        React.useEffect(() => {</div><div class="diff-removed">-          for (let i = 0; i < 1000; i++) {</div><div class="diff-removed">-            setStep(x => x + 1);</div><div class="diff-removed">-          }</div><div class="diff-removed">-          Scheduler.log('Done');</div><div class="diff-removed">-        }, []);</div><div class="diff-removed">-        return step;</div><div class="diff-removed">-      }</div><div class="diff-removed">-</div><div class="diff-removed">-      const container = document.createElement('div');</div><div class="diff-removed">-      const root = ReactDOMClient.createRoot(container);</div><div class="diff-removed">-      await act(() => {</div><div class="diff-removed">-        root.render(<Terminating />);</div><div class="diff-removed">-      });</div><div class="diff-removed">-</div><div class="diff-removed">-      assertLog(['Done']);</div><div class="diff-removed">-      expect(container.textContent).toBe('1000');</div><div class="diff-added">+      // ...</div><div>     });</div><div>   }</div><div> </div><div class="diff-removed">-  it('prevents infinite update loop triggered by synchronous updates in useEffect', async () => {</div><div class="diff-removed">-    // Ignore flushSync warning</div><div class="diff-removed">-    spyOnDev(console, 'error').mockImplementation(() => {});</div><div class="diff-removed">-</div><div class="diff-removed">-    function NonTerminating() {</div><div class="diff-removed">-      const [step, setStep] = React.useState(0);</div><div class="diff-removed">-      React.useEffect(() => {</div><div class="diff-removed">-        // Other examples of synchronous updates in useEffect are imperative</div><div class="diff-removed">-        // event dispatches like `el.focus`, or `useSyncExternalStore`, which</div><div class="diff-removed">-        // may schedule a synchronous update upon subscribing if it detects</div><div class="diff-removed">-        // that the store has been mutated since the initial render.</div><div class="diff-removed">-        //</div><div class="diff-removed">-        // (Originally I wrote this test using `el.focus` but those errors</div><div class="diff-removed">-        // get dispatched in a JSDOM event and I don't know how to "catch" those</div><div class="diff-removed">-        // so that they don't fail the test.)</div><div class="diff-removed">-        ReactDOM.flushSync(() => {</div><div class="diff-removed">-          setStep(step + 1);</div><div class="diff-removed">-        });</div><div class="diff-removed">-      }, [step]);</div><div class="diff-removed">-      return step;</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    const container = document.createElement('div');</div><div class="diff-removed">-    const root = ReactDOMClient.createRoot(container);</div><div class="diff-removed">-    await expect(async () => {</div><div class="diff-removed">-      await act(() => {</div><div class="diff-removed">-        ReactDOM.flushSync(() => {</div><div class="diff-removed">-          root.render(<NonTerminating />);</div><div class="diff-removed">-        });</div><div class="diff-removed">-      });</div><div class="diff-removed">-    }).rejects.toThrow('Maximum update depth exceeded');</div><div class="diff-removed">-  });</div><div class="diff-removed">-});+  it('prevents infinite update loop triggered by synchronous updates in useEffect', async ().Inventory => {</div><div class="diff-added">+    // ...</div><div class="diff-added">+  });</div><div class="diff-added">+};</div></pre>
                </div>
            </div>
        </section>
    </main>
    <footer>
        <p>LoCoDiff-bench - <a href="https://github.com/AbanteAI/LoCoDiff-bench">GitHub Repository</a></p>
    </footer>
</body>
</html>
    