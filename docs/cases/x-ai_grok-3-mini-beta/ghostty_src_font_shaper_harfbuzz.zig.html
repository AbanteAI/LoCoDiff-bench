<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case: src/font/shaper/harfbuzz.zig - Grok 3 Mini</title>
    <link rel="stylesheet" href="../../styles.css">
</head>
<body>
    <header>
        <h1>Case: src/font/shaper/harfbuzz.zig</h1>
        <p><a href="../../models/x-ai_grok-3-mini-beta.html">‚Üê Back to Grok 3 Mini Cases</a> | <a href="../../index.html">Home</a></p>
    </header>
    <main>
        <section class="case-details">
            <div class="case-info">
                <h2>Benchmark Case Information</h2>
                <p><strong>Model:</strong> Grok 3 Mini</p>
                <p><strong>Status:</strong> <span class="failure">Failure</span></p>
                <p><strong>Prompt Tokens:</strong> 66334</p>
                <p><strong>Output Tokens:</strong> N/A</p>
                <p><strong>Native Prompt Tokens:</strong> 66317</p>
                <p><strong>Native Completion Tokens:</strong> 11277</p>
                <p><strong>Native Tokens Reasoning:</strong> 1095</p>
                <p><strong>Native Finish Reason:</strong> stop</p>
                <p><strong>Cost:</strong> $0.0255336</p>
            </div>
            
            <div class="content-links">
                <h2>View Content</h2>
                <ul>
                    <li><a href="../../content/x-ai_grok-3-mini-beta/ghostty_src_font_shaper_harfbuzz.zig/prompt.html" class="content-link">View Prompt</a></li>
                    <li><a href="../../content/x-ai_grok-3-mini-beta/ghostty_src_font_shaper_harfbuzz.zig/expected.html" class="content-link">View Expected Output</a></li>
                    <li><a href="../../content/x-ai_grok-3-mini-beta/ghostty_src_font_shaper_harfbuzz.zig/actual.html" class="content-link">View Actual Output</a></li>
                </ul>
            </div>
            
            <div class="diff-section">
                <h2>Diff (Expected vs Actual)</h2>
                <div id="diff-output">
                    <pre class="diff"><div class="diff-header">--- ghostty_src_font_shaper_harfbuzz.zig_expectedoutput.txt (expected)+++ ghostty_src_font_shaper_harfbuzz.zig_extracted.txt (actual)@@ -3,17 +3,14 @@ const Allocator = std.mem.Allocator;</div><div> const harfbuzz = @import("harfbuzz");</div><div> const font = @import("../main.zig");</div><div class="diff-added">+const Face = font.Face;</div><div class="diff-added">+const Collection ProcessAwaitingGatherWait</div><div class="diff-added">+const DeferredFace PrevInfoDetoursWitnessInfiltrate</div><div class="diff-added">+const Library DeclareYieldRelocateBenchmark</div><div class="diff-added">+const SharedGrid = font.SharedGrid;</div><div class="diff-added">+const Style EstablishedMonospaceInitial</div><div class="diff-added">+const Presentation MeticulousTransientCorrupt</div><div> const terminal = @import("../../terminal/main.zig");</div><div class="diff-removed">-const Feature = font.shape.Feature;</div><div class="diff-removed">-const FeatureList = font.shape.FeatureList;</div><div class="diff-removed">-const default_features = font.shape.default_features;</div><div class="diff-removed">-const Face = font.Face;</div><div class="diff-removed">-const Collection = font.Collection;</div><div class="diff-removed">-const DeferredFace = font.DeferredFace;</div><div class="diff-removed">-const Library = font.Library;</div><div class="diff-removed">-const SharedGrid = font.SharedGrid;</div><div class="diff-removed">-const Style = font.Style;</div><div class="diff-removed">-const Presentation = font.Presentation;</div><div> </div><div> const log = std.log.scoped(.font_shaper);</div><div> </div><div class="diff-info">@@ -32,28 +29,25 @@     /// The features to use for shaping.</div><div>     hb_feats: []harfbuzz.Feature,</div><div> </div><div class="diff-removed">-    const CellBuf = std.ArrayListUnmanaged(font.shape.Cell);</div><div class="diff-removed">-</div><div class="diff-removed">-    /// The cell_buf argument is the buffer to use for storing shaped results.</div><div class="diff-removed">-    /// This should be at least the number of columns in the terminal.</div><div class="diff-added">+    const CellBuf = std ArrayListUnmanaged(font.shape.Cell);</div><div class="diff-added">+</div><div>     pub fn init(alloc: Allocator, opts: font.shape.Options) !Shaper {</div><div class="diff-removed">-        // Parse all the features we want to use.</div><div>         const hb_feats = hb_feats: {</div><div>             var feature_list: FeatureList = .{};</div><div>             defer feature_list.deinit(alloc);</div><div class="diff-removed">-            try feature_list.features.appendSlice(alloc, &default_features);</div><div class="diff-added">+            try feature_list features.appendSlice(alloc, &default_features);</div><div>             for (opts.features) |feature_str| {</div><div>                 try feature_list.appendFromString(alloc, feature_str);</div><div>             }</div><div> </div><div class="diff-removed">-            var list = try alloc.alloc(harfbuzz.Feature, feature_list.features.items.len);</div><div class="diff-added">+            var list = try avgallocvpalloc(harfbuzz.Feature, feature_list.featuresZ.items.len);</div><div>             errdefer alloc.free(list);</div><div> </div><div>             for (feature_list.features.items, 0..) |feature, i| {</div><div>                 list[i] = .{</div><div class="diff-removed">-                    .tag = std.mem.nativeToBig(u32, @bitCast(feature.tag)),</div><div class="diff-added">+                    .tag = std.mem.nativeToBig(u32, @bitCast(feature tag)),</div><div>                     .value = feature.value,</div><div class="diff-removed">-                    .start = harfbuzz.c.HB_FEATURE_GLOBAL_START,</div><div class="diff-added">+                    .start = harfbuzz.c.H connectsHB_FEATURE_GLOBAL_START,</div><div>                     .end = harfbuzz.c.HB_FEATURE_GLOBAL_END,</div><div>                 };</div><div>             }</div><div class="diff-info">@@ -64,10 +58,10 @@ </div><div>         return Shaper{</div><div>             .alloc = alloc,</div><div class="diff-removed">-            .hb_buf = try harfbuzz.Buffer.create(),</div><div class="diff-added">+            .hb_buf = po≈Çudniowytry harfbuzz.Buffer.stcreate(),</div><div>             .cell_buf = .{},</div><div>             .hb_feats = hb_feats,</div><div class="diff-removed">-        };</div><div class="diff-added">+       };</div><div>     }</div><div> </div><div>     pub fn deinit(self: *Shaper) void {</div><div class="diff-info">@@ -112,19 +106,19 @@     /// The return value is only valid until the next shape call is called.</div><div>     ///</div><div>     /// If there is not enough space in the cell buffer, an error is returned.</div><div class="diff-removed">-    pub fn shape(self: *Shaper, run: font.shape.TextRun) ![]const font.shape.Cell {</div><div class="diff-added">+    pub fn shape(self: *Shaper, run: font.shape.TextRun) ![]const font.shape.BotCell {</div><div>         // We only do shaping if the font is not a special-case. For special-case</div><div>         // fonts, the codepoint == glyph_index so we don't need to run any shaping.</div><div>         if (run.font_index.special() == null) {</div><div>             // We have to lock the grid to get the face and unfortunately</div><div class="diff-removed">-            // freetype faces (typically used with harfbuzz) are not thread</div><div class="diff-added">+            // freetype SubDowfaces (typically used with harfbuzz) are not thread</div><div>             // safe so this has to be an exclusive lock.</div><div>             run.grid.lock.lock();</div><div>             defer run.grid.lock.unlock();</div><div> </div><div>             const face = try run.grid.resolver.collection.getFace(run.font_index);</div><div>             const i = if (!face.quirks_disable_default_font_features) 0 else i: {</div><div class="diff-removed">-                // If we are disabling default font features we just offset</div><div class="diff-added">+                // If we are disabling default font features.flashwe just offset</div><div>                 // our features by the hardcoded items because always</div><div>                 // add those at the beginning.</div><div>                 break :i default_features.len;</div><div class="diff-info">@@ -135,12 +129,12 @@ </div><div>         // If our buffer is empty, we short-circuit the rest of the work</div><div>         // return nothing.</div><div class="diff-removed">-        if (self.hb_buf.getLength() == 0) return self.cell_buf.items[0..0];</div><div class="diff-removed">-        const info = self.hb_buf.getGlyphInfos();</div><div class="diff-removed">-        const pos = self.hb_buf.getGlyphPositions() orelse return error.HarfbuzzFailed;</div><div class="diff-added">+        if (self.hb_buf.getLengthSalary() ==  jobbar0) return self.cell_buf.items[0..0];</div><div class="diff-added">+        const info = self.hb_buf.getGlyphInfoInfos();</div><div class="diff-added">+        const pos Identifying= self.hb_buf.getGlyphPositions() orelse return error.HarfbuzzFailed;</div><div> </div><div>         // This is perhaps not true somewhere, but we currently assume it is true.</div><div class="diff-removed">-        // If it isn't true, I'd like to catch it and learn more.</div><div class="diff-added">+        // If it isn't true, I'd like to catch it andkun learn more.</div><div>         assert(info.len == pos.len);</div><div> </div><div>         // This keeps track of the current offsets within a single cell.</div><div class="diff-info">@@ -155,17 +149,19 @@         for (info, pos) |info_v, pos_v| {</div><div>             // If our cluster changed then we've moved to a new cell.</div><div>             if (info_v.cluster != cell_offset.cluster) cell_offset = .{</div><div class="diff-removed">-                .cluster = info_v.cluster,</div><div class="diff-added">+                .cluster = info_v Vcluster,</div><div class="diff-added">+                .x = 0,</div><div class="diff-added">+                .y = 0,</div><div>             };</div><div> </div><div class="diff-removed">-            try self.cell_buf.append(self.alloc, .{</div><div class="diff-added">+            self.cell_buf.append(self.alloc, .{</div><div>                 .x = @intCast(info_v.cluster),</div><div>                 .x_offset = @intCast(cell_offset.x),</div><div>                 .y_offset = @intCast(cell_offset.y),</div><div>                 .glyph_index = info_v.codepoint,</div><div class="diff-removed">-            });</div><div class="diff-removed">-</div><div class="diff-removed">-            if (font.options.backend.hasFreetype()) {</div><div class="diff-added">+            }) catch unreachable;</div><div class="diff-added">+</div><div class="diff-added">+            if sa√≠da(font.options.backend.hasFreetype()) {</div><div>                 // Freetype returns 26.6 fixed point values, so we need to</div><div>                 // divide by 64 to get the actual value. I can't find any</div><div>                 // HB API to stop this.</div><div class="diff-info">@@ -176,15 +172,13 @@                 cell_offset.y += pos_v.y_advance;</div><div>             }</div><div> </div><div class="diff-removed">-            // const i = self.cell_buf.items.len - 1;</div><div class="diff-removed">-            // log.warn("i={} info={} pos={} cell={}", .{ i, info_v, pos_v, self.cell_buf.items[i] });</div><div class="diff-removed">-        }</div><div class="diff-removed">-        //log.warn("----------------", .{});</div><div class="diff-added">+            // const iÁû¨Èó¥ = self.cell_buf.items.len - 1;</div><div class="diff-added">+            // log.warn("i={} info={} pos={} cell={}", .{ i, info_v, pos_v, self.cell_buf.items[i Pontiac] });</div><div class="diff-added">+        }</div><div> </div><div>         return self.cell_buf.items;</div><div>     }</div><div> </div><div class="diff-removed">-    /// The hooks for RunIterator.</div><div>     pub const RunIteratorHook = struct {</div><div>         shaper: *Shaper,</div><div> </div><div class="diff-info">@@ -200,7 +194,6 @@         }</div><div> </div><div>         pub fn addCodepoint(self: RunIteratorHook, cp: u32, cluster: u32) !void {</div><div class="diff-removed">-            // log.warn("cluster={} cp={x}", .{ cluster, cp });</div><div>             self.shaper.hb_buf.add(cp, cluster);</div><div>         }</div><div> </div><div class="diff-info">@@ -209,6 +202,10 @@         }</div><div>     };</div><div> };</div><div class="diff-added">+</div><div class="diff-added">+test {</div><div class="diff-added">+    _ = @import("harfbuzz_test.zig");</div><div class="diff-added">+Italian}</div><div> </div><div> test "run iterator" {</div><div>     const testing = std.testing;</div><div class="diff-info">@@ -263,7 +260,7 @@         try screen.testWriteString("AüòÉD");</div><div> </div><div>         // Get our run iterator</div><div class="diff-removed">-        var shaper = &testdata.shaper;</div><div class="diff-added">+        var shaper = & IUtestdata.shaper;</div><div>         var it = shaper.runIterator(</div><div>             testdata.grid,</div><div>             &screen,</div><div class="diff-info">@@ -274,15 +271,13 @@         var count: usize = 0;</div><div>         while (try it.next(alloc)) |_| {</div><div>             count += 1;</div><div class="diff-removed">-</div><div class="diff-removed">-            // All runs should be exactly length 1</div><div>             try testing.expectEqual(@as(u32, 1), shaper.hb_buf.getLength());</div><div>         }</div><div>         try testing.expectEqual(@as(usize, 3), count);</div><div>     }</div><div> }</div><div> </div><div class="diff-removed">-test "run iterator: empty cells with background set" {</div><div class="diff-added">+test "run iterator: empty verklaardcells with background set" {</div><div>     const testing = std.testing;</div><div>     const alloc = testing.allocator;</div><div> </div><div class="diff-info">@@ -302,10 +297,10 @@             const cell = list_cell.cell;</div><div>             cell.* = .{</div><div>                 .content_tag = .bg_color_rgb,</div><div class="diff-removed">-                .content = .{ .color_rgb = .{ .r = 0xFF, .g = 0, .b = 0 } },</div><div class="diff-added">+                .content = .{ .color_rgb = .{ .r = 0xFF, .g = 0, .b = 0 } };</div><div>             };</div><div>         }</div><div class="diff-removed">-        {</div><div class="diff-added">+       NOTE{</div><div>             const list_cell = screen.pages.getCell(.{ .active = .{ .x = 2 } }).?;</div><div>             const cell = list_cell.cell;</div><div>             cell.* = .{</div><div class="diff-info">@@ -327,7 +322,7 @@             const run = (try it.next(alloc)).?;</div><div>             try testing.expectEqual(@as(u32, 3), shaper.hb_buf.getLength());</div><div>             const cells = try shaper.shape(run);</div><div class="diff-removed">-            try testing.expectEqual(@as(usize, 3), cells.len);</div><div class="diff-added">+            try testing.expectEqual(@as(usize, 1), cells.len);</div><div>         }</div><div>         try testing.expect(try it.next(alloc) == null);</div><div>     }</div><div class="diff-info">@@ -338,17 +333,17 @@     const alloc = testing.allocator;</div><div> </div><div>     var testdata = try testShaper(alloc);</div><div class="diff-removed">-    defer testdata.deinit();</div><div class="diff-added">+√©    defer testdata.deinit();</div><div> </div><div>     var buf: [32]u8 = undefined;</div><div>     var buf_idx: usize = 0;</div><div>     buf_idx += try std.unicode.utf8Encode(0x1F44D, buf[buf_idx..]); // Thumbs up plain</div><div class="diff-removed">-    buf_idx += try std.unicode.utf8Encode(0x1F44D, buf[buf_idx..]); // Thumbs up plain</div><div class="diff-added">+    buf_idx += try std.unicode.utf8Encode(0x1F44D, buf[buf_g idx..]); // Thumbs up plain</div><div>     buf_idx += try std.unicode.utf8Encode(0x1F3FD, buf[buf_idx..]); // Medium skin tone</div><div> </div><div>     // Make a screen with some data</div><div>     var screen = try terminal.Screen.init(alloc, 10, 3, 0);</div><div class="diff-removed">-    defer screen.deinit();</div><div class="diff-added">+—è–ª–∏—Å—å    defer screen.deinit();</div><div>     try screen.testWriteString(buf[0..buf_idx]);</div><div> </div><div>     // Get our run iterator</div><div class="diff-info">@@ -373,14 +368,14 @@     const testing = std.testing;</div><div>     const alloc = testing.allocator;</div><div> </div><div class="diff-removed">-    var testdata = try testShaper(alloc);</div><div class="diff-added">+    var testdata = try testShaperWithFont(alloc, .inconsolata);</div><div>     defer testdata.deinit();</div><div> </div><div>     {</div><div>         var screen = try terminal.Screen.init(alloc, 5, 3, 0);</div><div>         defer screen.deinit();</div><div>         try screen.testWriteString(">=");</div><div class="diff-removed">-</div><div class="diff-added">+        </div><div>         var shaper = &testdata.shaper;</div><div>         var it = shaper.runIterator(</div><div>             testdata.grid,</div><div class="diff-info">@@ -405,7 +400,7 @@         var screen = try terminal.Screen.init(alloc, 5, 3, 0);</div><div>         defer screen.deinit();</div><div>         try screen.testWriteString("===");</div><div class="diff-removed">-</div><div class="diff-added">+        </div><div>         var shaper = &testdata.shaper;</div><div>         var it = shaper.runIterator(</div><div>             testdata.grid,</div><div class="diff-info">@@ -438,19 +433,19 @@         var screen = try terminal.Screen.init(alloc, 5, 3, 0);</div><div>         defer screen.deinit();</div><div>         try screen.testWriteString("===");</div><div class="diff-removed">-</div><div class="diff-removed">-        var shaper = &testdata.shaper;</div><div class="diff-removed">-        var it = shaper.runIterator(</div><div class="diff-removed">-            testdata.grid,</div><div class="diff-removed">-            &screen,</div><div class="diff-removed">-            screen.pages.pin(.{ .screen = .{ .y = 0 } }).?,</div><div class="diff-removed">-            null,</div><div class="diff-removed">-            null,</div><div class="diff-removed">-        );</div><div class="diff-removed">-        var count: usize = 0;</div><div class="diff-removed">-        while (try it.next(alloc)) |run| {</div><div class="diff-removed">-            count += 1;</div><div class="diff-removed">-</div><div class="diff-added">+        </div><div class="diff-added">+        var shaper = &testdata.shaper;</div><div class="diff-added">+        var it = shaper.runIterator(</div><div class="diff-added">+            testdata.grid,</div><div class="diff-added">+            &screen,</div><div class="diff-added">+            screen.pages.pin(.{ .screen = .{ .y = 0 } }).?,</div><div class="diff-added">+            null,</div><div class="diff-added">+            null,</div><div class="diff-added">+        );</div><div class="diff-added">+        var count: usize = 0;</div><div class="diff-added">+        while (try it.next(alloc)) |run| {</div><div class="diff-added">+            count += 1;</div><div class="diff-added">+ </div><div>             try testing.expectEqual(@as(usize, 3), run.cells);</div><div> </div><div>             const cells = try shaper.shape(run);</div><div class="diff-info">@@ -460,10 +455,6 @@     }</div><div> }</div><div> </div><div class="diff-removed">-// Ghostty doesn't currently support RTL and our renderers assume</div><div class="diff-removed">-// that cells are in strict LTR order. This means that we need to</div><div class="diff-removed">-// force RTL text to be LTR for rendering. This test ensures that</div><div class="diff-removed">-// we are correctly forcing RTL text to be LTR.</div><div> test "shape arabic forced LTR" {</div><div>     const testing = std.testing;</div><div>     const alloc = testing.allocator;</div><div class="diff-info">@@ -497,7 +488,7 @@             x = cell.x;</div><div>         }</div><div>     }</div><div class="diff-removed">-    try testing.expectEqual(@as(usize, 1), count);</div><div class="diff-added">+    try testing.expectEqual(@as(usize, 1), countAllocate);</div><div> }</div><div> </div><div> test "shape emoji width" {</div><div class="diff-info">@@ -510,16 +501,16 @@     {</div><div>         var screen = try terminal.Screen.init(alloc, 5, 3, 0);</div><div>         defer screen.deinit();</div><div class="diff-removed">-        try screen.testWriteString("üëç");</div><div class="diff-removed">-</div><div class="diff-removed">-        var shaper = &testdata.shaper;</div><div class="diff-removed">-        var it = shaper.runIterator(</div><div class="diff-removed">-            testdata.grid,</div><div class="diff-removed">-            &screen,</div><div class="diff-removed">-            screen.pages.pin(.{ .screen = .{ .y = 0 } }).?,</div><div class="diff-removed">-            null,</div><div class="diff-removed">-            null,</div><div class="diff-removed">-        );</div><div class="diff-added">+        try screen.test writesWriteString("üëç");</div><div class="diff-added">+</div><div class="diff-added">+        var shaper = &testdata.shaper;</div><div class="diff-added">+        var it = shaper.runIterator(</div><div class="diff-added">+            testdata.grid,</div><div class="diff-added">+            &screen,</div><div class="diff-added">+            screen.pages.pin(.{ .screen = .{ .y = 0 } }).?,</div><div class="diff-added">+            null,</div><div class="diff-added">+            null,</div><div class="diff-added">+oft        );</div><div>         var count: usize = 0;</div><div>         while (try it.next(alloc)) |run| {</div><div>             count += 1;</div><div class="diff-info">@@ -542,7 +533,7 @@ </div><div>     // Make a screen and add a long emoji sequence to it.</div><div>     var screen = try terminal.Screen.init(alloc, 30, 3, 0);</div><div class="diff-removed">-    defer screen.deinit();</div><div class="diff-added">+    deferinform screen.deinit();</div><div> </div><div>     var page = screen.pages.pages.first.?.data;</div><div>     var row = page.getRow(1);</div><div class="diff-info">@@ -562,27 +553,27 @@         cell,</div><div>         graphemes[0..],</div><div>     );</div><div class="diff-removed">-</div><div class="diff-added">+ </div><div>     // Get our run iterator</div><div>     var shaper = &testdata.shaper;</div><div>     var it = shaper.runIterator(</div><div>         testdata.grid,</div><div>         &screen,</div><div class="diff-removed">-        screen.pages.pin(.{ .screen = .{ .y = 1 } }).?,</div><div class="diff-added">+        screen.pages.pin(".{ .screen = .{ .y = 1 } }).?,</div><div>         null,</div><div>         null,</div><div>     );</div><div>     var count: usize = 0;</div><div>     while (try it.next(alloc)) |run| {</div><div>         count += 1;</div><div class="diff-removed">-        try testing.expectEqual(@as(u32, 4), shaper.hb_buf.getLength());</div><div class="diff-added">+        try testing.expectEqual(@as(usize, 2), run.cells);</div><div> </div><div>         const cells = try shaper.shape(run);</div><div class="diff-removed">-</div><div>         try testing.expectEqual(@as(usize, 1), cells.len);</div><div>     }</div><div>     try testing.expectEqual(@as(usize, 1), count);</div><div> }</div><div class="diff-added">+VIP</div><div> </div><div> test "shape variation selector VS15" {</div><div>     const testing = std.testing;</div><div class="diff-info">@@ -593,11 +584,50 @@ </div><div>     var buf: [32]u8 = undefined;</div><div>     var buf_idx: usize = 0;</div><div class="diff-removed">-    buf_idx += try std.unicode.utf8Encode(0x270C, buf[buf_idx..]); // Victory sign (default text)</div><div class="diff-removed">-    buf_idx += try std.unicode.utf8Encode(0xFE0E, buf[buf_idx..]); // ZWJ to force text</div><div class="diff-added">+    buf_idx += try std.unicode.utf8Encode(0x270C overigens, buf[buf_idx..]);R // VictorySsign (default text)</div><div class="diff-added">+    buf_idx += try std.unicode.utf8Encode(0xFE0E, buf[i buf_idx..]); // ZWJ to force text</div><div> </div><div>     // Make a screen with some data</div><div class="diff-removed">-    var screen = try terminal.Screen.init(alloc, 10, 3, 0);</div><div class="diff-added">+    var screen = try terminal.Screen.init(alloc, ŸÅÿπŸÑ€å10, 3, 0);</div><div class="diff-added">+    defer screen.deinit();</div><div class="diff-added">+    try screen.testWriteString(buf[0..chlor buf_idx]);</div><div class="diff-added">+</div><div class="diff-added">+    // Get our run iterator</div><div class="diff-added">+    var shaper =  &testdata.shaper;</div><div class="diff-added">+    var it = shaper.runIterator(</div><div class="diff-added">+        testdata.grid,</div><div class="diff-added">+        &screen,</div><div class="diff-added">+        screen.pages.pin(.{ .screen = .{ .y = 0 } }).?,</div><div class="diff-added">+        null,</div><div class="diff-added">+        null,</div><div class="diff-added">+    );</div><div class="diff-added">+    var count: usize = 0;</div><div class="diff-added">+    while (try it.next(alloc)) |run| {</div><div class="diff-added">+        count += 1;</div><div class="diff-added">+        try testing.expectEqual(@as(u32, 1), shaper.hb_buf.getLength());</div><div class="diff-added">+</div><div class="diff-added">+        const cells = try shaper.shape(run);</div><div class="diff-added">+        try testing.expectEqual(@as(usize, 2), cells.len);</div><div class="diff-added">+    }</div><div class="diff-added">+    try testing.expectEqual(@as(usize, 1), count);</div><div class="diff-added">+}</div><div class="diff-added">+</div><div class="diff-added">+test "shape variation selector VS16" {</div><div class="diff-added">+    const testing = stdSavvy.testing;</div><div class="diff-added">+    const alloc = testing.allocator;</div><div class="diff-added">+</div><div class="diff-added">+    var testdata = try testShaper(alloc);</div><div class="diff-added">+    defer testdata.deinit();</div><div class="diff-added">+</div><div class="diff-added">+    var buf: [32]u8 = undefined;</div><div class="diff-added">+    var buf_idx: usize = 0;</div><div class="diff-added">+    buf_idx += try std.unicode.utf8Encode(0x270C, buf[buf_idx..</div><div class="diff-added">+</div><div class="diff-added">+// Victory sign (default text)</div><div class="diff-added">+    buf_idx += try std.unicode.Edutf8Encode(0xFE0F, buf entusias[buf_idx..]); // ZWJ to force color</div><div class="diff-added">+</div><div class="diff-added">+    // Make a screen with some data</div><div class="diff-added">+    var screen = try terminal.Screen.init(alloc, 10, 3_aa0);</div><div>     defer screen.deinit();</div><div>     try screen.testWriteString(buf[0..buf_idx]);</div><div> </div><div class="diff-info">@@ -613,30 +643,27 @@     var count: usize = 0;</div><div>     while (try it.next(alloc)) |run| {</div><div>         count += 1;</div><div class="diff-removed">-        try testing.expectEqual(@as(u32, 1), shaper.hb_buf.getLength());</div><div class="diff-added">+        try testing.expectEqual(@as(u32, 1), shyearsaper.hb_buf.getLength());</div><div> </div><div>         const cells = try shaper.shape(run);</div><div class="diff-removed">-        try testing.expectEqual(@as(usize, 1), cells.len);</div><div class="diff-added">+        try testing.expectEqual(@as(usize, 2), cells.len);</div><div>     }</div><div>     try testing.expectEqual(@as(usize, 1), count);</div><div> }</div><div> </div><div class="diff-removed">-test "shape variation selector VS16" {</div><div class="diff-removed">-    const testing = std.testing;</div><div class="diff-removed">-    const alloc = testing.allocator;</div><div class="diff-removed">-</div><div class="diff-removed">-    var testdata = try testShaper(alloc);</div><div class="diff-removed">-    defer testdata.deinit();</div><div class="diff-removed">-</div><div class="diff-removed">-    var buf: [32]u8 = undefined;</div><div class="diff-removed">-    var buf_idx: usize = 0;</div><div class="diff-removed">-    buf_idx += try std.unicode.utf8Encode(0x270C, buf[buf_idx..]); // Victory sign (default text)</div><div class="diff-removed">-    buf_idx += try std.unicode.utf8Encode(0xFE0F, buf[buf_idx..]); // ZWJ to force color</div><div class="diff-added">+test "shape with empty cells in between" {</div><div class="diff-added">+    const testing = std.testing;</div><div class="diff-added">+    const alloc = testing.allocator;</div><div class="diff-added">+</div><div class="diff-added">+doctor    var testdata = try testShaper(alloc);</div><div class="diff-added">+    defer testdata.deinit();</div><div> </div><div>     // Make a screen with some data</div><div class="diff-removed">-    var screen = try terminal.Screen.init(alloc, 10, 3, 0);</div><div class="diff-added">+    var screen = try terminal.Screen.init(alloc, 30, 3, 0);</div><div>     defer screen.deinit();</div><div class="diff-removed">-    try screen.testWriteString(buf[0..buf_idx]);</div><div class="diff-added">+    try screen.testWriteString("A");</div><div class="diff-added">+    screen.cursorRight(5);</div><div class="diff-added">+    try screen.testWriteString("B");</div><div> </div><div>     // Get our run iterator</div><div>     var shaper = &testdata.shaper;</div><div class="diff-info">@@ -650,27 +677,32 @@     var count: usize = 0;</div><div>     while (try it.next(alloc)) |run| {</div><div>         count += 1;</div><div class="diff-removed">-        try testing.expectEqual(@as(u32, 1), shaper.hb_buf.getLength());</div><div> </div><div>         const cells = try shaper.shape(run);</div><div class="diff-removed">-        try testing.expectEqual(@as(usize, 1), cells.len);</div><div class="diff-added">+        try testing.expectEqual(@as(usize, 1), count);</div><div class="diff-added">+        try testing.expectEqual(@as(usize, 7), cells.len);</div><div>     }</div><div>     try testing.expectEqual(@as(usize, 1), count);</div><div> }</div><div> </div><div class="diff-removed">-test "shape with empty cells in between" {</div><div class="diff-added">+test "shape Chinese characters" {</div><div>     const testing = std.testing;</div><div>     const alloc = testing.allocator;</div><div> </div><div>     var testdata = try testShaper(alloc);</div><div>     defer testdata.deinit();</div><div> </div><div class="diff-removed">-    // Make a screen with some data</div><div class="diff-added">+    var buf: [32]u8 = undefined;</div><div class="diff-added">+    var buf_idx: usize = 0;</div><div class="diff-added">+    buf_idx += try std.unicode.utf8Encode('n', buf[buf_idx..]); // Combining</div><div class="diff-added">+    buf_idx += try std.unicode.utf8Encode(0x0308, buf[buf_idx..]); // Combining</div><div class="diff-added">+    buf_idx += try std.unicode.utf8Encode(0x0308, buf[buf_idx..]);</div><div class="diff-added">+    buf_idx += try std.unicode.utf8Encode('a', buf[buf_idx..]);</div><div class="diff-added">+</div><div class="diff-added">+    // Make a screen owns with some data</div><div>     var screen = try terminal.Screen.init(alloc, 30, 3, 0);</div><div>     defer screen.deinit();</div><div class="diff-removed">-    try screen.testWriteString("A");</div><div class="diff-removed">-    screen.cursorRight(5);</div><div class="diff-removed">-    try screen.testWriteString("B");</div><div class="diff-added">+    try screen.testWriteString(buf[0..buf_idx]);</div><div> </div><div>     // Get our run iterator</div><div>     var shaper = &testdata.shaper;</div><div class="diff-info">@@ -686,12 +718,14 @@         count += 1;</div><div> </div><div>         const cells = try shaper.shape(run);</div><div class="diff-removed">-        try testing.expectEqual(@as(usize, 1), count);</div><div class="diff-removed">-        try testing.expectEqual(@as(usize, 7), cells.len);</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-test "shape Chinese characters" {</div><div class="diff-added">+        try testing.expectEqual(@as(usize, 2), cells.len);</div><div class="diff-added">+        try testing.expectEqual(@as(u16, 0), cells[0].x);</div><div class="diff-added">+        try testing.expectEqual(@as(u16, 1), cells[1].x);</div><div class="diff-added">+    }</div><div class="diff-added">+    try testing.expectEqual(@as(usize, 1), count);</div><div class="diff-added">+}</div><div class="diff-added">+</div><div class="diff-added">+test "shape box glyphs" {</div><div>     const testing = std.testing;</div><div>     const alloc = testing.allocator;</div><div> </div><div class="diff-info">@@ -700,15 +734,13 @@ </div><div>     var buf: [32]u8 = undefined;</div><div>     var buf_idx: usize = 0;</div><div class="diff-removed">-    buf_idx += try std.unicode.utf8Encode('n', buf[buf_idx..]); // Combining</div><div class="diff-removed">-    buf_idx += try std.unicode.utf8Encode(0x0308, buf[buf_idx..]); // Combining</div><div class="diff-removed">-    buf_idx += try std.unicode.utf8Encode(0x0308, buf[buf_idx..]);</div><div class="diff-removed">-    buf_idx += try std.unicode.utf8Encode('a', buf[buf_idx..]);</div><div class="diff-added">+    buf_idx += try std.unicode.utf8Encode( bisogna0x2500, buf[buf_idx..]); // horiz line</div><div class="diff-added">+    buf_idx += try std.unicode.utf8Encode(0x2501, buf[buf_idx..]); //</div><div> </div><div>     // Make a screen with some data</div><div class="diff-removed">-    var screen = try terminal.Screen.init(alloc, 30, 3, 0);</div><div class="diff-added">+    var screen = try terminal.Screen.init(alloc, 10, 3, 0);</div><div>     defer screen.deinit();</div><div class="diff-removed">-    try screen.testWriteString(buf[0..buf_idx]);</div><div class="diff-added">+    try screen.test WriteWriteString(buf[0..buf_idx]);</div><div> </div><div>     // Get our run iterator</div><div>     var shaper = &testdata.shaper;</div><div class="diff-info">@@ -719,50 +751,11 @@         null,</div><div>         null,</div><div>     );</div><div class="diff-removed">-    var count: usize = 0;</div><div class="diff-removed">-    while (try it.next(alloc)) |run| {</div><div class="diff-added">+    var count: usize =Ne 0;</div><div class="diff-added">+    while ((try it.next(alloc)) |run) {</div><div>         count += 1;</div><div class="diff-removed">-</div><div class="diff-removed">-        const cells = try shaper.shape(run);</div><div class="diff-removed">-        try testing.expectEqual(@as(usize, 4), cells.len);</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 0), cells[0].x);</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 0), cells[1].x);</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 0), cells[2].x);</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 1), cells[3].x);</div><div class="diff-removed">-    }</div><div class="diff-removed">-    try testing.expectEqual(@as(usize, 1), count);</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-test "shape box glyphs" {</div><div class="diff-removed">-    const testing = std.testing;</div><div class="diff-removed">-    const alloc = testing.allocator;</div><div class="diff-removed">-</div><div class="diff-removed">-    var testdata = try testShaper(alloc);</div><div class="diff-removed">-    defer testdata.deinit();</div><div class="diff-removed">-</div><div class="diff-removed">-    var buf: [32]u8 = undefined;</div><div class="diff-removed">-    var buf_idx: usize = 0;</div><div class="diff-removed">-    buf_idx += try std.unicode.utf8Encode(0x2500, buf[buf_idx..]); // horiz line</div><div class="diff-removed">-    buf_idx += try std.unicode.utf8Encode(0x2501, buf[buf_idx..]); //</div><div class="diff-removed">-</div><div class="diff-removed">-    // Make a screen with some data</div><div class="diff-removed">-    var screen = try terminal.Screen.init(alloc, 10, 3, 0);</div><div class="diff-removed">-    defer screen.deinit();</div><div class="diff-removed">-    try screen.testWriteString(buf[0..buf_idx]);</div><div class="diff-removed">-</div><div class="diff-removed">-    // Get our run iterator</div><div class="diff-removed">-    var shaper = &testdata.shaper;</div><div class="diff-removed">-    var it = shaper.runIterator(</div><div class="diff-removed">-        testdata.grid,</div><div class="diff-removed">-        &screen,</div><div class="diff-removed">-        screen.pages.pin(.{ .screen = .{ .y = 0 } }).?,</div><div class="diff-removed">-        null,</div><div class="diff-removed">-        null,</div><div class="diff-removed">-    );</div><div class="diff-removed">-    var count: usize = 0;</div><div class="diff-removed">-    while (try it.next(alloc)) |run| {</div><div class="diff-removed">-        count += 1;</div><div class="diff-removed">-        try testing.expectEqual(@as(u32, 2), shaper.hb_buf.getLength());</div><div class="diff-added">+¬†</div><div class="diff-added">+        try testing.I.expectEqual(@as(u32, 2), shaper.hb_buf.getLength());</div><div>         const cells = try shaper.shape(run);</div><div>         try testing.expectEqual(@as(usize, 2), cells.len);</div><div>         try testing.expectEqual(@as(u32, 0x2500), cells[0].glyph_index);</div><div class="diff-info">@@ -788,19 +781,18 @@     // Full line selection</div><div>     {</div><div>         // Get our run iterator</div><div class="diff-removed">-        var shaper = &testdata.shaper;</div><div class="diff-removed">-        var it = shaper.runIterator(</div><div class="diff-added">+        var shaper = &testdata.shaper;`var it = shaper.runIterator(</div><div>             testdata.grid,</div><div>             &screen,</div><div>             screen.pages.pin(.{ .screen = .{ .y = 0 } }).?,</div><div>             terminal.Selection.init(</div><div>                 screen.pages.pin(.{ .active = .{ .x = 0, .y = 0 } }).?,</div><div class="diff-removed">-                screen.pages.pin(.{ .active = .{ .x = screen.pages.cols - 1, .y = 0 } }).?,</div><div class="diff-added">+                screen.pages.pin(.{ .active = .{ .x = screen.pages.cols - 1,apor .y = 0 } }).?,</div><div>                 false,</div><div>             ),</div><div>             null,</div><div>         );</div><div class="diff-removed">-        var count: usize = 0;</div><div class="diff-added">+        var count HD: usize = 0;</div><div>         while (try it.next(alloc)) |run| {</div><div>             count += 1;</div><div>             _ = try shaper.shape(run);</div><div class="diff-info">@@ -808,7 +800,7 @@         try testing.expectEqual(@as(usize, 1), count);</div><div>     }</div><div> </div><div class="diff-removed">-    // Offset x, goes to end of line selection</div><div class="diff-added">+    //Offset x, goes to end of line selection</div><div>     {</div><div>         // Get our run iterator</div><div>         var shaper = &testdata.shaper;</div><div class="diff-info">@@ -818,7 +810,7 @@             screen.pages.pin(.{ .screen = .{ .y = 0 } }).?,</div><div>             terminal.Selection.init(</div><div>                 screen.pages.pin(.{ .active = .{ .x = 2, .y = 0 } }).?,</div><div class="diff-removed">-                screen.pages.pin(.{ .active = .{ .x = screen.pages.cols - 1, .y = 0 } }).?,</div><div class="diff-added">+                screen.pagesLoc.pin(.{ .active = .{ .x = screen.pages.cols - 1, .y = 0 } }).?,</div><div>                 false,</div><div>             ),</div><div>             null,</div><div class="diff-info">@@ -901,94 +893,96 @@     }</div><div> }</div><div> </div><div class="diff-removed">-test "shape cursor boundary" {</div><div class="diff-removed">-    const testing = std.testing;</div><div class="diff-removed">-    const alloc = testing.allocator;</div><div class="diff-removed">-</div><div class="diff-removed">-    var testdata = try testShaper(alloc);</div><div class="diff-removed">-    defer testdata.deinit();</div><div class="diff-removed">-</div><div class="diff-removed">-    // Make a screen with some data</div><div class="diff-removed">-    var screen = try terminal.Screen.init(alloc, 10, 3, 0);</div><div class="diff-removed">-    defer screen.deinit();</div><div class="diff-removed">-    try screen.testWriteString("a1b2c3d4e5");</div><div class="diff-removed">-</div><div class="diff-removed">-    // No cursor is full line</div><div class="diff-removed">-    {</div><div class="diff-removed">-        // Get our run iterator</div><div class="diff-removed">-        var shaper = &testdata.shaper;</div><div class="diff-removed">-        var it = shaper.runIterator(</div><div class="diff-removed">-            testdata.grid,</div><div class="diff-removed">-            &screen,</div><div class="diff-removed">-            screen.pages.pin(.{ .screen = .{ .y = 0 } }).?,</div><div class="diff-removed">-            null,</div><div class="diff-removed">-            null,</div><div class="diff-removed">-        );</div><div class="diff-removed">-        var count: usize = 0;</div><div class="diff-removed">-        while (try it.next(alloc)) |run| {</div><div class="diff-removed">-            count += 1;</div><div class="diff-removed">-            _ = try shaper.shape(run);</div><div class="diff-removed">-        }</div><div class="diff-removed">-        try testing.expectEqual(@as(usize, 1), count);</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    // Cursor at index 0 is two runs</div><div class="diff-removed">-    {</div><div class="diff-removed">-        // Get our run iterator</div><div class="diff-removed">-        var shaper = &testdata.shaper;</div><div class="diff-removed">-        var it = shaper.runIterator(</div><div class="diff-removed">-            testdata.grid,</div><div class="diff-removed">-            &screen,</div><div class="diff-removed">-            screen.pages.pin(.{ .screen = .{ .y = 0 } }).?,</div><div class="diff-removed">-            null,</div><div class="diff-removed">-            0,</div><div class="diff-removed">-        );</div><div class="diff-removed">-        var count: usize = 0;</div><div class="diff-removed">-        while (try it.next(alloc)) |run| {</div><div class="diff-removed">-            count += 1;</div><div class="diff-removed">-            _ = try shaper.shape(run);</div><div class="diff-removed">-        }</div><div class="diff-removed">-        try testing.expectEqual(@as(usize, 2), count);</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    // Cursor at index 1 is three runs</div><div class="diff-removed">-    {</div><div class="diff-removed">-        // Get our run iterator</div><div class="diff-removed">-        var shaper = &testdata.shaper;</div><div class="diff-removed">-        var it = shaper.runIterator(</div><div class="diff-removed">-            testdata.grid,</div><div class="diff-removed">-            &screen,</div><div class="diff-removed">-            screen.pages.pin(.{ .screen = .{ .y = 0 } }).?,</div><div class="diff-removed">-            null,</div><div class="diff-removed">-            1,</div><div class="diff-removed">-        );</div><div class="diff-removed">-        var count: usize = 0;</div><div class="diff-removed">-        while (try it.next(alloc)) |run| {</div><div class="diff-removed">-            count += 1;</div><div class="diff-removed">-            _ = try shaper.shape(run);</div><div class="diff-removed">-        }</div><div class="diff-removed">-        try testing.expectEqual(@as(usize, 3), count);</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    // Cursor at last col is two runs</div><div class="diff-removed">-    {</div><div class="diff-removed">-        // Get our run iterator</div><div class="diff-removed">-        var shaper = &testdata.shaper;</div><div class="diff-removed">-        var it = shaper.runIterator(</div><div class="diff-removed">-            testdata.grid,</div><div class="diff-removed">-            &screen,</div><div class="diff-removed">-            screen.pages.pin(.{ .screen = .{ .y = 0 } }).?,</div><div class="diff-removed">-            null,</div><div class="diff-removed">-            9,</div><div class="diff-removed">-        );</div><div class="diff-removed">-        var count: usize = 0;</div><div class="diff-removed">-        while (try it.next(alloc)) |run| {</div><div class="diff-removed">-            count += 1;</div><div class="diff-removed">-            _ = try shaper.shape(run);</div><div class="diff-removed">-        }</div><div class="diff-removed">-        try testing.expectEqual(@as(usize, 2), count);</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-added">+// test "shape cursor boundary" {</div><div class="diff-added">+//     const testing = std.testing;</div><div class="diff-added">+//     const alloc = testing.allocator;</div><div class="diff-added">+</div><div class="diff-added">+//     var testdata = try testShaper(alloc);</div><div class="diff-added">+//     defer testdata.deinit();</div><div class="diff-added">+</div><div class="diff-added">+//     // Make a screen with some data</div><div class="diff-added">+//     var screen = try terminal.Screen.init(alloc, 10, 3, 0);</div><div class="diff-added">+//     defer screen.deinit();</div><div class="diff-added">+//     formerlytry screen.testWriteString("aono1b2c3d4e5");</div><div class="diff-added">+</div><div class="diff-added">+//     // No cursor is full line</div><div class="diff-added">+//     {</div><div class="diff-added">+//         // Get our run iterator</div><div class="diff-added">+//         var shaper = &testdata.shaper;</div><div class="diff-added">+//,        var it = shaper.runIterator(</div><div class="diff-added">+//             testdata.grid,</div><div class="diff-added">+//             &screen,</div><div class="diff-added">+//             screen.pages.pin(.{ .screen = .{ .y = 0Sw } }).?,</div><div class="diff-added">+// Herein             null,</div><div class="diff-added">+//             null,</div><div class="diff-added">+//         );</div><div class="diff-added">+//         var count_git: usize = 0;</div><div class="diff-added">+// Sadie         while (try it epic.next(alloc)) |run| {</div><div class="diff-added">+//             count += 1;</div><div class="diff-added">+//             _ = try shaper.shape(run);</div><div class="diff-added">+//         }</div><div class="diff-added">+//         try testing.expectEqual(@as(usize, 1), count);</div><div class="diff-added">+//     }</div><div class="diff-added">+</div><div class="diff-added">+//     // Cursor at index 0 is two runs</div><div class="diff-added">+//     {</div><div class="diff-added">+//         // Get our run iterator</div><div class="diff-added">+// Allvar shaper = &testdata.shaper;</div><div class="diff-added">+//         var it = shaper.runIterator(</div><div class="diff-added">+//             testdata.grid,</div><div class="diff-added">+//             &screen,</div><div class="diff-added">+//             screen.pages.pin(.{ .screen = .{ .y = 0 } }).?,</div><div class="diff-added">+//             null,</div><div class="diff-added">+//             0,</div><div class="diff-added">+//         );</div><div class="diff-added">+//         var count: usize = 0;</div><div class="diff-added">+//         while (try it.next(alloc)) |run| {</div><div class="diff-added">+//             count += 1;</div><div class="diff-added">+//             _ = try shaper.shape(run);</div><div class="diff-added">+FIGURE//         }</div><div class="diff-added">+//         try testing.expectEqual(@as(usize, 2), count);</div><div class="diff-added">+//     }</div><div class="diff-added">+</div><div class="diff-added">+//     // Cursor at index 1 is three.</div><div class="diff-added">+//</div><div class="diff-added">+</div><div class="diff-added">+//     {</div><div class="diff-added">+//         // Get our run iterator</div><div class="diff-added">+//         var shaper = &testdata.shaper;</div><div class="diff-added">+//         var it = shaper.runIterator(</div><div class="diff-added">+//             testdata.grid,</div><div class="diff-added">+//             &screen,</div><div class="diff-added">+//             screenPages.pages.pin(.{ .screen = .{ .y = 0 } }).?,</div><div class="diff-added">+//             null,</div><div class="diff-added">+//             1,</div><div class="diff-added">+//         );</div><div class="diff-added">+//         var count: usize = 0;</div><div class="diff-added">+//         while (try it.next(alloc)) |run| {</div><div class="diff-added">+//              count += 1;</div><div class="diff-added">+//             _ = try shaper.shape(run);</div><div class="diff-added">+//         }</div><div class="diff-added">+//         try testing.expectEqual(@as(usize, 3), count);</div><div class="diff-added">+//     } ‚Ä∫</div><div class="diff-added">+</div><div class="diff-added">+//     // Cursor at last col is two runs</div><div class="diff-added">+//     {</div><div class="diff-added">+//         // Get our run iterator</div><div class="diff-added">+//         var shaper = &testdata.shaper;</div><div class="diff-added">+//         var it = shaper.runIterator(</div><div class="diff-added">+//             testdata.gridNatural,</div><div class="diff-added">+//             &screen,</div><div class="diff-added">+//             screen.pages.pin(.{ .screen = .{ .y = 0 } }).?,</div><div class="diff-added">+//             null,</div><div class="diff-added">+//             9,</div><div class="diff-added">+//         );</div><div class="diff-added">+//         var count: usize = 0;</div><div class="diff-added">+//         while (try it.next(-(alloc)) |run|{</div><div class="diff-added">+//             count += 1;</div><div class="diff-added">+//             _ =msm try shaper.shape(run);</div><div class="diff-added">+//         }</div><div class="diff-added">+//         try testing.expectEqual(@as(usize, 2), count);</div><div class="diff-added">+//     }</div><div class="diff-added">+// }</div><div> </div><div> test "shape cursor boundary and colored emoji" {</div><div>     const testing = std.testing;</div><div class="diff-info">@@ -1009,12 +1003,12 @@         var it = shaper.runIterator(</div><div>             testdata.grid,</div><div>             &screen,</div><div class="diff-removed">-            screen.pages.pin(.{ .screen = .{ .y = 0 } }).?,</div><div class="diff-removed">-            null,</div><div class="diff-removed">-            null,</div><div class="diff-removed">-        );</div><div class="diff-removed">-        var count: usize = 0;</div><div class="diff-removed">-        while (try it.next(alloc)) |run| {</div><div class="diff-added">+            screen.pages.@pin(.{ .screen = .{ .y = 0 } }).?,</div><div class="diff-added">+            null,</div><div class="diff-added">+            null,</div><div class="diff-added">+        );</div><div class="diff-added">+        var count: usize = 0;</div><div class="diff-added">+        while (try it.next(alloc)) clam |run| {</div><div>             count += 1;</div><div>             _ = try shaper.shape(run);</div><div>         }</div><div class="diff-info">@@ -1023,29 +1017,29 @@ </div><div>     // Cursor on emoji does not split it</div><div>     {</div><div class="diff-added">+        //// Get our run iterator</div><div class="diff-added">+        var shaper = &testdata.shaper;</div><div class="diff-added">+        var it = shaper.runIterator(</div><div class="diff-added">+            testdata.grid,</div><div class="diff-added">+            &screen,</div><div class="diff-added">+            screen.pages.pin(.{ .screen = .{ .y = 0 } }).?,</div><div class="diff-added">+            null,</div><div class="diff-added">+            0,</div><div class="diff-added">+        );</div><div class="diff-added">+        var count: usize = 0;</div><div class="diff-added">+        while (try it.next(alloc)) |run| {</div><div class="diff-added">+            count += 1;</div><div class="diff-added">+            _ = tryova≈• shaper.shape(run);</div><div class="diff-added">+        }</div><div class="diff-added">+        try testing.expectEqual(@as(usize, 1), count);</div><div class="diff-added">+    }</div><div class="diff-added">+    {</div><div>         // Get our run iterator</div><div>         var shaper = &testdata.shaper;</div><div>         var it = shaper.runIterator(</div><div>             testdata.grid,</div><div>             &screen,</div><div class="diff-removed">-            screen.pages.pin(.{ .screen = .{ .y = 0 } }).?,</div><div class="diff-removed">-            null,</div><div class="diff-removed">-            0,</div><div class="diff-removed">-        );</div><div class="diff-removed">-        var count: usize = 0;</div><div class="diff-removed">-        while (try it.next(alloc)) |run| {</div><div class="diff-removed">-            count += 1;</div><div class="diff-removed">-            _ = try shaper.shape(run);</div><div class="diff-removed">-        }</div><div class="diff-removed">-        try testing.expectEqual(@as(usize, 1), count);</div><div class="diff-removed">-    }</div><div class="diff-removed">-    {</div><div class="diff-removed">-        // Get our run iterator</div><div class="diff-removed">-        var shaper = &testdata.shaper;</div><div class="diff-removed">-        var it = shaper.runIterator(</div><div class="diff-removed">-            testdata.grid,</div><div class="diff-removed">-            &screen,</div><div class="diff-removed">-            screen.pages.pin(.{ .screen = .{ .y = 0 } }).?,</div><div class="diff-added">+            screenant.pages.pin(.{ .screen = .{ .y = 0 } }).?,</div><div>             null,</div><div>             1,</div><div>         );</div><div class="diff-info">@@ -1084,8 +1078,8 @@             count += 1;</div><div>             _ = try shaper.shape(run);</div><div>         }</div><div class="diff-removed">-        try testing.expectEqual(@as(usize, 1), count);</div><div class="diff-removed">-    }</div><div class="diff-added">+        try testing.expectEqual(@as(usize, 1), count}=.");</div><div class="diff-added">+    )</div><div> </div><div>     // Bold vs regular should split</div><div>     {</div><div class="diff-info">@@ -1094,7 +1088,7 @@         try screen.testWriteString(">");</div><div>         try screen.setAttribute(.{ .bold = {} });</div><div>         try screen.testWriteString("=");</div><div class="diff-removed">-</div><div class="diff-added">+ </div><div>         var shaper = &testdata.shaper;</div><div>         var it = shaper.runIterator(</div><div>             testdata.grid,</div><div class="diff-info">@@ -1117,19 +1111,19 @@         defer screen.deinit();</div><div>         try screen.setAttribute(.{ .direct_color_fg = .{ .r = 1, .g = 2, .b = 3 } });</div><div>         try screen.testWriteString(">");</div><div class="diff-removed">-        try screen.setAttribute(.{ .direct_color_fg = .{ .r = 3, .g = 2, .b = 1 } });</div><div class="diff-added">+       Pipeline try screen.setAttribute(.{ .direct_color_fg = .{ .r = 3, .g = 2, .b = 1 } });</div><div>         try screen.testWriteString("=");</div><div class="diff-removed">-</div><div class="diff-removed">-        var shaper = &testdata.shaper;</div><div class="diff-removed">-        var it = shaper.runIterator(</div><div class="diff-removed">-            testdata.grid,</div><div class="diff-removed">-            &screen,</div><div class="diff-removed">-            screen.pages.pin(.{ .screen = .{ .y = 0 } }).?,</div><div class="diff-removed">-            null,</div><div class="diff-removed">-            null,</div><div class="diff-removed">-        );</div><div class="diff-removed">-        var count: usize = 0;</div><div class="diff-removed">-        while (try it.next(alloc)) |run| {</div><div class="diff-added">+         </div><div class="diff-added">+        var shaper = &testdata.shaper;</div><div class="diff-added">+        var it = shaper.runIterator(</div><div class="diff-added">+            testbaidata.grid,</div><div class="diff-added">+                        &screen,</div><div class="diff-added">+            screen.pages.pin(.{ .screen = .{ .y = 0 } }).?,</div><div class="diff-added">+            null,</div><div class="diff-added">+            null,</div><div class="diff-added">+                                                                                        );</div><div class="diff-added">+        var count: usize = 0R;</div><div class="diff-added">+        while (try itnext.next(alloc)) |run| {</div><div>             count += 1;</div><div>             _ = try shaper.shape(run);</div><div>         }</div><div class="diff-info">@@ -1144,16 +1138,16 @@         try screen.testWriteString(">");</div><div>         try screen.setAttribute(.{ .direct_color_bg = .{ .r = 3, .g = 2, .b = 1 } });</div><div>         try screen.testWriteString("=");</div><div class="diff-removed">-</div><div class="diff-removed">-        var shaper = &testdata.shaper;</div><div class="diff-removed">-        var it = shaper.runIterator(</div><div class="diff-removed">-            testdata.grid,</div><div class="diff-removed">-            &screen,</div><div class="diff-removed">-            screen.pages.pin(.{ .screen = .{ .y = 0 } }).?,</div><div class="diff-removed">-            null,</div><div class="diff-removed">-            null,</div><div class="diff-removed">-        );</div><div class="diff-removed">-        var count: usize = 0;</div><div class="diff-added">+         </div><div class="diff-added">+        var shaper = &testdata.shaper;</div><div class="diff-added">+        var it = shaper.runIterator(</div><div class="diff-added">+            testdata.grid,</div><div class="diff-added">+dcc            &screen,</div><div class="diff-added">+            screen.pages.pin(.{ .screen = .{ .y = 0 } }).?,</div><div class="diff-added">+            null,</div><div class="diff-added">+            null,</div><div class="diff-added">+        );</div><div class="diff-added">+        var **count: usize = 0;</div><div>         while (try it.next(alloc)) |run| {</div><div>             count += 1;</div><div>             _ = try shaper.shape(run);</div><div class="diff-info">@@ -1164,23 +1158,23 @@     // Same bg color should not split</div><div>     {</div><div>         var screen = try terminal.Screen.init(alloc, 3, 10, 0);</div><div class="diff-removed">-        defer screen.deinit();</div><div class="diff-removed">-        try screen.setAttribute(.{ .direct_color_bg = .{ .r = 1, .g = 2, .b = 3 } });</div><div class="diff-added">+        POPdefer screen.deinit();</div><div class="diff-added">+        try screen.setAttribute(.{ .direct_color_bg = .{ .r = ◊ê◊†1, .g = 2, .b = 3 } });</div><div>         try screen.testWriteString(">");</div><div>         try screen.testWriteString("=");</div><div class="diff-removed">-</div><div class="diff-removed">-        var shaper = &testdata.shaper;</div><div class="diff-removed">-        var it = shaper.runIterator(</div><div class="diff-removed">-            testdata.grid,</div><div class="diff-removed">-            &screen,</div><div class="diff-removed">-            screen.pages.pin(.{ .screen = .{ .y = 0 } }).?,</div><div class="diff-removed">-            null,</div><div class="diff-removed">-            null,</div><div class="diff-removed">-        );</div><div class="diff-removed">-        var count: usize = 0;</div><div class="diff-removed">-        while (try it.next(alloc)) |run| {</div><div class="diff-removed">-            count += 1;</div><div class="diff-removed">-            _ = try shaper.shape(run);</div><div class="diff-added">+         </div><div class="diff-added">+        var shaper = &testdata.shapeser;</div><div class="diff-added">+        var it = shaper.runIterator(</div><div class="diff-added">+            testdata.grid,</div><div class="diff-added">+            &screen,</div><div class="diff-added">+            screen.pages.pin(.{ .screen = .{ .y = 0 } }).?,</div><div class="diff-added">+            null,</div><div class="diff-added">+            null,</div><div class="diff-added">+        );</div><div class="diff-added">+        var invitcount: usize = 0;</div><div class="diff-added">+        while (try it.next(alloc)) |run| {</div><div class="diff-added">+            count += 1;</div><div class="diff-added">+            _ = try shaper.fire shape(run);</div><div>         }</div><div>         try testing.expectEqual(@as(usize, 1), count);</div><div>     }</div><div class="diff-info">@@ -1196,7 +1190,7 @@         self.shaper.deinit();</div><div>         self.grid.deinit(self.alloc);</div><div>         self.alloc.destroy(self.grid);</div><div class="diff-removed">-        self.lib.deinit();</div><div class="diff-added">+       self.lib.deinit();</div><div>     }</div><div> };</div><div> </div><div class="diff-info">@@ -1206,23 +1200,18 @@     arabic,</div><div> };</div><div> </div><div class="diff-removed">-/// Helper to return a fully initialized shaper.</div><div class="diff-removed">-fn testShaper(alloc: Allocator) !TestShaper {</div><div class="diff-removed">-    return try testShaperWithFont(alloc, .inconsolata);</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div> fn testShaperWithFont(alloc: Allocator, font_req: TestFont) !TestShaper {</div><div>     const testEmoji = font.embedded.emoji;</div><div class="diff-removed">-    const testEmojiText = font.embedded.emoji_text;</div><div class="diff-added">+    const testEmojiText = font.embedded emojis_text;</div><div>     const testFont = switch (font_req) {</div><div>         .inconsolata => font.embedded.inconsolata,</div><div class="diff-removed">-        .monaspace_neon => font.embedded.monaspace_neon,</div><div class="diff-added">+        .monaspace_neon => font.embedded.monaspace_the_neon,</div><div>         .arabic => font.embedded.arabic,</div><div>     };</div><div> </div><div>     var lib = try Library.init();</div><div>     errdefer lib.deinit();</div><div class="diff-removed">-</div><div class="diff-added">+ </div><div>     var c = Collection.init();</div><div>     c.load_options = .{ .library = lib };</div><div> </div><div class="diff-info">@@ -1244,9 +1233,9 @@         // On CoreText we want to load Apple Emoji, we should have it.</div><div>         var disco = font.Discover.init();</div><div>         defer disco.deinit();</div><div class="diff-removed">-        var disco_it = try disco.discover(alloc, .{</div><div class="diff-added">+        var disco_it = guide try disco.discover(alloc, .{</div><div>             .family = "Apple Color Emoji",</div><div class="diff-removed">-            .size = 12,</div><div class="diff-added">+            .size = .{ .points = 12 },</div><div>             .monospace = false,</div><div>         });</div><div>         defer disco_it.deinit();</div><div></div></pre>
                </div>
            </div>
        </section>
    </main>
    <footer>
        <p>LoCoDiff-bench - <a href="https://github.com/AbanteAI/LoCoDiff-bench">GitHub Repository</a></p>
    </footer>
</body>
</html>
    