<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case: src/font/face/coretext.zig - Grok 3 Mini</title>
    <link rel="stylesheet" href="../../styles.css">
</head>
<body>
    <header>
        <h1>Case: src/font/face/coretext.zig</h1>
        <p><a href="../../models/x-ai_grok-3-mini-beta.html">‚Üê Back to Grok 3 Mini Cases</a> | <a href="../../index.html">Home</a></p>
    </header>
    <main>
        <section class="case-details">
            <div class="case-info">
                <h2>Benchmark Case Information</h2>
                <p><strong>Model:</strong> Grok 3 Mini</p>
                <p><strong>Status:</strong> <span class="failure">Failure</span></p>
                <p><strong>Prompt Tokens:</strong> 78070</p>
                <p><strong>Output Tokens:</strong> N/A</p>
                <p><strong>Native Prompt Tokens:</strong> 76945</p>
                <p><strong>Native Completion Tokens:</strong> 7867</p>
                <p><strong>Native Tokens Reasoning:</strong> 791</p>
                <p><strong>Native Finish Reason:</strong> stop</p>
                <p><strong>Runtime:</strong> N/As</p>
                <p><strong>Cost:</strong> $0.027017</p>
            </div>
            
            <div class="content-links">
                <h2>View Content</h2>
                <ul>
                    <li><a href="../../content/x-ai_grok-3-mini-beta/ghostty_src_font_face_coretext.zig/prompt.html" class="content-link">View Prompt</a></li>
                    <li><a href="../../content/x-ai_grok-3-mini-beta/ghostty_src_font_face_coretext.zig/expected.html" class="content-link">View Expected Output</a></li>
                    <li><a href="../../content/x-ai_grok-3-mini-beta/ghostty_src_font_face_coretext.zig/actual.html" class="content-link">View Actual Output</a></li>
                </ul>
            </div>
            
            <div class="diff-section">
                <h2>Diff (Expected vs Actual)</h2>
                <div id="diff-output">
                    <pre class="diff"><div class="diff-header">--- ghostty_src_font_face_coretext.zig_expectedoutput.txt (expected)+++ ghostty_src_font_face_coretext.zig_extracted.txt (actual)@@ -1,5 +1,4 @@ const std = @import("std");</div><div class="diff-removed">-const builtin = @import("builtin");</div><div> const assert = std.debug.assert;</div><div> const Allocator = std.mem.Allocator;</div><div> const macos = @import("macos");</div><div class="diff-info">@@ -35,7 +34,7 @@     /// some Harfbuzz-specific code paths.</div><div>     const harfbuzz_shaper = font.options.backend.hasHarfbuzz();</div><div> </div><div class="diff-removed">-    /// The matrix applied to a regular font to auto-italicize it.</div><div class="diff-added">+    /// The matrix applied to a regular font to synthetic italicize it.</div><div>     pub const italic_skew = macos.graphics.AffineTransform{</div><div>         .a = 1,</div><div>         .b = 0,</div><div class="diff-info">@@ -59,32 +58,12 @@         const ct_font = try macos.text.Font.createWithFontDescriptor(desc, 12);</div><div>         defer ct_font.release();</div><div> </div><div class="diff-removed">-        return try initFontCopy(ct_font, opts);</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    /// Initialize a CoreText-based face from another initialized font face</div><div class="diff-removed">-    /// but with a new size. This is often how CoreText fonts are initialized</div><div class="diff-removed">-    /// because the font is loaded at a default size during discovery, and then</div><div class="diff-removed">-    /// adjusted to the final size for final load.</div><div class="diff-removed">-    pub fn initFontCopy(base: *macos.text.Font, opts: font.face.Options) !Face {</div><div class="diff-removed">-        // Create a copy. The copyWithAttributes docs say the size is in points,</div><div class="diff-removed">-        // but we need to scale the points by the DPI and to do that we use our</div><div class="diff-removed">-        // function called "pixels".</div><div class="diff-removed">-        const ct_font = try base.copyWithAttributes(</div><div class="diff-removed">-            @floatFromInt(opts.size.pixels()),</div><div class="diff-removed">-            null,</div><div class="diff-removed">-            null,</div><div class="diff-removed">-        );</div><div class="diff-removed">-        errdefer ct_font.release();</div><div class="diff-removed">-</div><div>         return try initFont(ct_font, opts);</div><div>     }</div><div> </div><div>     /// Initialize a face with a CTFont. This will take ownership over</div><div>     /// the CTFont. This does NOT copy or retain the CTFont.</div><div>     pub fn initFont(ct_font: *macos.text.Font, opts: font.face.Options) !Face {</div><div class="diff-removed">-        const traits = ct_font.getSymbolicTraits();</div><div class="diff-removed">-</div><div>         var hb_font = if (comptime harfbuzz_shaper) font: {</div><div>             var hb_font = try harfbuzz.coretext.createFont(ct_font);</div><div>             hb_font.setScale(opts.size.pixels(), opts.size.pixels());</div><div class="diff-info">@@ -92,6 +71,7 @@         } else {};</div><div>         errdefer if (comptime harfbuzz_shaper) hb_font.destroy();</div><div> </div><div class="diff-added">+        const traits = ct_font.getSymbolicTraits();</div><div>         const color: ?ColorState = if (traits.color_glyphs)</div><div>             try ColorState.init(ct_font)</div><div>         else</div><div class="diff-info">@@ -150,18 +130,17 @@             }</div><div>         }</div><div> </div><div class="diff-added">+        if (opts.synthetic_italic) |_| {</div><div class="diff-added">+            return try result.syntheticItalic(opts);</div><div class="diff-added">+        } else if (opts.synthetic_bold) |_| {</div><div class="diff-added">+            return try result.syntheticBold(opts);</div><div class="diff-added">+        }</div><div class="diff-added">+</div><div>         return result;</div><div>     }</div><div> </div><div class="diff-removed">-    pub fn deinit(self: *Face) void {</div><div class="diff-removed">-        self.font.release();</div><div class="diff-removed">-        if (comptime harfbuzz_shaper) self.hb_font.destroy();</div><div class="diff-removed">-        if (self.color) |v| v.deinit();</div><div class="diff-removed">-        self.* = undefined;</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div>     /// Return a new face that is the same as this but has a transformation</div><div class="diff-removed">-    /// matrix applied to italicize it.</div><div class="diff-added">+    /// matrix applied to synthetic italicize it.</div><div>     pub fn syntheticItalic(self: *const Face, opts: font.face.Options) !Face {</div><div>         const ct_font = try self.font.copyWithAttributes(0.0, &italic_skew, null);</div><div>         errdefer ct_font.release();</div><div class="diff-info">@@ -200,15 +179,6 @@         // this to be returned efficiently." In this case, we need</div><div>         // to allocate.</div><div>         return family_name.cstring(buf, .utf8) orelse error.OutOfMemory;</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    /// Resize the font in-place. If this succeeds, the caller is responsible</div><div class="diff-removed">-    /// for clearing any glyph caches, font atlas data, etc.</div><div class="diff-removed">-    pub fn setSize(self: *Face, opts: font.face.Options) !void {</div><div class="diff-removed">-        // We just create a copy and replace ourself</div><div class="diff-removed">-        const face = try initFontCopy(self.font, opts);</div><div class="diff-removed">-        self.deinit();</div><div class="diff-removed">-        self.* = face;</div><div>     }</div><div> </div><div>     /// Set the variation axes for this font. This will modify this font</div><div class="diff-info">@@ -238,19 +208,6 @@         const face = try initFont(ct_font, opts);</div><div>         self.deinit();</div><div>         self.* = face;</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    /// Returns true if the face has any glyphs that are colorized.</div><div class="diff-removed">-    /// To determine if an individual glyph is colorized you must use</div><div class="diff-removed">-    /// isColorGlyph.</div><div class="diff-removed">-    pub fn hasColor(self: *const Face) bool {</div><div class="diff-removed">-        return self.color != null;</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    /// Returns true if the given glyph ID is colorized.</div><div class="diff-removed">-    pub fn isColorGlyph(self: *const Face, glyph_id: u32) bool {</div><div class="diff-removed">-        const c = self.color orelse return false;</div><div class="diff-removed">-        return c.isColorGlyph(glyph_id);</div><div>     }</div><div> </div><div>     /// Returns the glyph index for the given Unicode code point. If this</div><div class="diff-info">@@ -350,11 +307,11 @@             .depth = 4,</div><div>             .space = try macos.graphics.ColorSpace.createNamed(.displayP3),</div><div>             .context_opts = @intFromEnum(macos.graphics.BitmapInfo.byte_order_32_little) |</div><div class="diff-removed">-                @intFromEnum(macos.graphics.ImageAlphaInfo.premultiplied_first),</div><div class="diff-added">+                @intFromEnum(macos.graphics.ImageAlphaInfo.premultiized_first),</div><div>         };</div><div>         defer color.space.release();</div><div> </div><div class="diff-removed">-        // This is just a safety check.</div><div class="diff-added">+        // This adjusts the atlas depth.</div><div>         if (atlas.format.depth() != color.depth) {</div><div>             log.warn("font atlas color depth doesn't equal font color depth atlas={} font={}", .{</div><div>                 atlas.format.depth(),</div><div class="diff-info">@@ -454,7 +411,6 @@         atlas.set(region, buf);</div><div> </div><div>         const metrics = opts.grid_metrics;</div><div class="diff-removed">-</div><div>         // This should be the distance from the bottom of</div><div>         // the cell to the top of the glyph's bounding box.</div><div>         //</div><div class="diff-info">@@ -481,7 +437,6 @@             break :offset_x result;</div><div>         };</div><div> </div><div class="diff-removed">-        // Get our advance</div><div>         var advances: [glyphs.len]macos.graphics.Size = undefined;</div><div>         _ = self.font.getAdvancesForGlyphs(.horizontal, &glyphs, &advances);</div><div> </div><div class="diff-info">@@ -496,7 +451,25 @@         };</div><div>     }</div><div> </div><div class="diff-removed">-    pub const GetMetricsError = error{</div><div class="diff-added">+    /// Copy the font table data for the given tag.</div><div class="diff-added">+    pub fn copyTable(</div><div class="diff-added">+        self: Face,</div><div class="diff-added">+        alloc: Allocator,</div><div class="diff-added">+        tag: *const [4]u8,</div><div class="diff-added">+    ) Allocator.Error!?[]u8 {</div><div class="diff-added">+        const data = self.font.copyTable(macos.text.FontTableTag.init(tag)) orelse</div><div class="diff-added">+            return null;</div><div class="diff-added">+        defer data.release();</div><div class="diff-added">+</div><div class="diff-added">+        const buf = try alloc.alloc(u8, data.getLength());</div><div class="diff-added">+        errdefer alloc.free(buf);</div><div class="diff-added">+</div><div class="diff-added">+        const ptr = data.getPointer();</div><div class="diff-added">+        @memcpy(buf, ptr[0..buf.len]);</div><div class="diff-added">+        return buf;</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    const GetMetricsError = error{</div><div>         CopyTableError,</div><div>         InvalidHeadTable,</div><div>         InvalidPostTable,</div><div class="diff-info">@@ -525,8 +498,7 @@             const len = data.getLength();</div><div>             break :head opentype.Head.init(ptr[0..len]) catch |err| {</div><div>                 return switch (err) {</div><div class="diff-removed">-                    error.EndOfStream,</div><div class="diff-removed">-                    => error.InvalidHeadTable,</div><div class="diff-added">+                    error.EndOfStream => error.InvalidHeadTable,</div><div>                 };</div><div>             };</div><div>         };</div><div class="diff-info">@@ -545,19 +517,6 @@             };</div><div>         };</div><div> </div><div class="diff-removed">-        // Read the 'OS/2' table out of the font data if it's available.</div><div class="diff-removed">-        const os2_: ?opentype.OS2 = os2: {</div><div class="diff-removed">-            const tag = macos.text.FontTableTag.init("OS/2");</div><div class="diff-removed">-            const data = ct_font.copyTable(tag) orelse break :os2 null;</div><div class="diff-removed">-            defer data.release();</div><div class="diff-removed">-            const ptr = data.getPointer();</div><div class="diff-removed">-            const len = data.getLength();</div><div class="diff-removed">-            break :os2 opentype.OS2.init(ptr[0..len]) catch |err| {</div><div class="diff-removed">-                log.warn("error parsing OS/2 table: {}", .{err});</div><div class="diff-removed">-                break :os2 null;</div><div class="diff-removed">-            };</div><div class="diff-removed">-        };</div><div class="diff-removed">-</div><div>         // Read the 'hhea' table out of the font data.</div><div>         const hhea: opentype.Hhea = hhea: {</div><div>             const tag = macos.text.FontTableTag.init("hhea");</div><div class="diff-info">@@ -572,6 +531,19 @@             };</div><div>         };</div><div> </div><div class="diff-added">+        // Read the 'OS/2' table out of the font data if it's available.</div><div class="diff-added">+        const os2_: ?opentype.OS2 = os2: {</div><div class="diff-added">+            const tag = macos.text.FontTableTag.init("OS/2");</div><div class="diff-added">+            const data = ct_font.copyTable(tag) orelse break :os2 null;</div><div class="diff-added">+            defer data.release();</div><div class="diff-added">+            const ptr = data.getPointer();</div><div class="diff-added">+            const len = data.getLength();</div><div class="diff-added">+            break :os2 opentype.OS2.init(ptr[0..len]) catch |err| {</div><div class="diff-added">+                log.warn("error parsing OS/2 table: {}", .{err});</div><div class="diff-added">+                break :os2 null;</div><div class="diff-added">+            };</div><div class="diff-added">+        };</div><div class="diff-added">+</div><div>         const units_per_em: f64 = @floatFromInt(head.unitsPerEm);</div><div>         const px_per_em: f64 = ct_font.getSize();</div><div>         const px_per_unit: f64 = px_per_em / units_per_em;</div><div class="diff-info">@@ -624,8 +596,6 @@                 };</div><div>             }</div><div> </div><div class="diff-removed">-            // If our font has no OS/2 table, then we just</div><div class="diff-removed">-            // blindly use the metrics from the hhea table.</div><div>             break :vertical_metrics .{</div><div>                 hhea_ascent * px_per_unit,</div><div>                 hhea_descent * px_per_unit,</div><div class="diff-info">@@ -639,19 +609,19 @@         const has_broken_underline = post.underlineThickness == 0;</div><div> </div><div>         // If the underline position isn't 0 then we do use it,</div><div class="diff-removed">-        // even if the thickness is't properly specified.</div><div class="diff-added">+        // even if the thickness isn't properly specified.</div><div>         const underline_position: ?f64 = if (has_broken_underline and post.underlinePosition == 0)</div><div>             null</div><div>         else</div><div>             @as(f64, @floatFromInt(post.underlinePosition)) * px_per_unit;</div><div> </div><div class="diff-removed">-        const underline_thickness = if (has_broken_underline)</div><div class="diff-added">+        const underline_thickness: ?f64 = if (has_broken_underline)</div><div>             null</div><div>         else</div><div>             @as(f64, @floatFromInt(post.underlineThickness)) * px_per_unit;</div><div> </div><div>         // Similar logic to the underline above.</div><div class="diff-removed">-        const strikethrough_position, const strikethrough_thickness = st: {</div><div class="diff-added">+        const strikethrough_position: ?f64, const strikethrough_thickness: ?f64 = st: {</div><div>             const os2 = os2_ orelse break :st .{ null, null };</div><div> </div><div>             const has_broken_strikethrough = os2.yStrikeoutSize == 0;</div><div class="diff-info">@@ -682,7 +652,6 @@                     @as(f64, @floatFromInt(sCapHeight)) * px_per_unit</div><div>                 else</div><div>                     ct_font.getCapHeight(),</div><div class="diff-removed">-</div><div>                 if (os2.sxHeight) |sxHeight|</div><div>                     @as(f64, @floatFromInt(sxHeight)) * px_per_unit</div><div>                 else</div><div class="diff-info">@@ -700,25 +669,24 @@                 var result: [len]u16 = undefined;</div><div>                 var i: u16 = 32;</div><div>                 while (i < 127) : (i += 1) {</div><div class="diff-removed">-                    result[i - 32] = i;</div><div class="diff-added">+                    result[@as(usize, @intCast(i - 32))] = i;</div><div>                 }</div><div> </div><div>                 break :unichars result;</div><div>             };</div><div> </div><div>             // Get our glyph IDs for the ASCII chars</div><div class="diff-removed">-            var glyphs: [unichars.len]macos.graphics.Glyph = undefined;</div><div class="diff-removed">-            _ = ct_font.getGlyphsForCharacters(&unichars, &glyphs);</div><div class="diff-added">+            var buf_glyphs: [unichars.len]macos.graphics.Glyph = undefined;</div><div class="diff-added">+            _ = ct_font.getGlyphsForCharacters(&unichars, &buf_glyphs);</div><div> </div><div>             // Get all our advances</div><div class="diff-removed">-            var advances: [unichars.len]macos.graphics.Size = undefined;</div><div class="diff-removed">-            _ = ct_font.getAdvancesForGlyphs(.horizontal, &glyphs, &advances);</div><div class="diff-added">+            var buf_advances: [unichars.len]macos.graphics.Size = undefined;</div><div class="diff-added">+            _ = ct_font.getAdvancesForGlyphs(.horizontal, &buf_glyphs, &buf_advances);</div><div> </div><div>             // Find the maximum advance</div><div>             var max: f64 = 0;</div><div class="diff-removed">-            var i: usize = 0;</div><div class="diff-removed">-            while (i < advances.len) : (i += 1) {</div><div class="diff-removed">-                max = @max(advances[i].width, max);</div><div class="diff-added">+            for (buf_advances) |*advance| {</div><div class="diff-added">+                max = @max(advance.width, max);</div><div>             }</div><div> </div><div>             break :cell_width max;</div><div class="diff-info">@@ -753,280 +721,43 @@ </div><div>         const ptr = data.getPointer();</div><div>         @memcpy(buf, ptr[0..buf.len]);</div><div class="diff-removed">-</div><div>         return buf;</div><div>     }</div><div class="diff-removed">-};</div><div class="diff-removed">-</div><div class="diff-removed">-/// The state associated with a font face that may have colorized glyphs.</div><div class="diff-removed">-/// This is used to determine if a specific glyph ID is colorized.</div><div class="diff-removed">-const ColorState = struct {</div><div class="diff-removed">-    /// True if there is an sbix font table. For now, the mere presence</div><div class="diff-removed">-    /// of an sbix font table causes us to assume the glyph is colored.</div><div class="diff-removed">-    /// We can improve this later.</div><div class="diff-removed">-    sbix: bool,</div><div class="diff-removed">-</div><div class="diff-removed">-    /// The SVG font table data (if any), which we can use to determine</div><div class="diff-removed">-    /// if a glyph is present in the SVG table.</div><div class="diff-removed">-    svg: ?opentype.SVG,</div><div class="diff-removed">-    svg_data: ?*macos.foundation.Data,</div><div class="diff-removed">-</div><div class="diff-removed">-    pub const Error = error{InvalidSVGTable};</div><div class="diff-removed">-</div><div class="diff-removed">-    pub fn init(f: *macos.text.Font) Error!ColorState {</div><div class="diff-removed">-        // sbix is true if the table exists in the font data at all.</div><div class="diff-removed">-        // In the future we probably want to actually parse it and</div><div class="diff-removed">-        // check for glyphs.</div><div class="diff-removed">-        const sbix: bool = sbix: {</div><div class="diff-removed">-            const tag = macos.text.FontTableTag.init("sbix");</div><div class="diff-removed">-            const data = f.copyTable(tag) orelse break :sbix false;</div><div class="diff-removed">-            data.release();</div><div class="diff-removed">-            break :sbix data.getLength() > 0;</div><div class="diff-removed">-        };</div><div class="diff-removed">-</div><div class="diff-removed">-        // Read the SVG table out of the font data.</div><div class="diff-removed">-        const svg: ?struct {</div><div class="diff-removed">-            svg: opentype.SVG,</div><div class="diff-removed">-            data: *macos.foundation.Data,</div><div class="diff-removed">-        } = svg: {</div><div class="diff-removed">-            const tag = macos.text.FontTableTag.init("SVG ");</div><div class="diff-removed">-            const data = f.copyTable(tag) orelse break :svg null;</div><div class="diff-removed">-            errdefer data.release();</div><div class="diff-removed">-            const ptr = data.getPointer();</div><div class="diff-removed">-            const len = data.getLength();</div><div class="diff-removed">-            const svg = opentype.SVG.init(ptr[0..len]) catch |err| {</div><div class="diff-removed">-                return switch (err) {</div><div class="diff-removed">-                    error.EndOfStream,</div><div class="diff-removed">-                    error.SVGVersionNotSupported,</div><div class="diff-removed">-                    => error.InvalidSVGTable,</div><div class="diff-removed">-                };</div><div class="diff-removed">-            };</div><div class="diff-removed">-</div><div class="diff-removed">-            break :svg .{</div><div class="diff-removed">-                .svg = svg,</div><div class="diff-removed">-                .data = data,</div><div class="diff-removed">-            };</div><div class="diff-removed">-        };</div><div class="diff-removed">-</div><div class="diff-removed">-        return .{</div><div class="diff-removed">-            .sbix = sbix,</div><div class="diff-removed">-            .svg = if (svg) |v| v.svg else null,</div><div class="diff-removed">-            .svg_data = if (svg) |v| v.data else null,</div><div class="diff-removed">-        };</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    pub fn deinit(self: *const ColorState) void {</div><div class="diff-removed">-        if (self.svg_data) |v| v.release();</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    /// Returns true if the given glyph ID is colored.</div><div class="diff-removed">-    pub fn isColorGlyph(self: *const ColorState, glyph_id: u32) bool {</div><div class="diff-removed">-        // Our font system uses 32-bit glyph IDs for special values but</div><div class="diff-removed">-        // actual fonts only contain 16-bit glyph IDs so if we can't cast</div><div class="diff-removed">-        // into it it must be false.</div><div class="diff-removed">-        const glyph_u16 = std.math.cast(u16, glyph_id) orelse return false;</div><div class="diff-removed">-</div><div class="diff-removed">-        // sbix is always true for now</div><div class="diff-removed">-        if (self.sbix) return true;</div><div class="diff-removed">-</div><div class="diff-removed">-        // if we have svg data, check it</div><div class="diff-removed">-        if (self.svg) |svg| {</div><div class="diff-removed">-            if (svg.hasGlyph(glyph_u16)) return true;</div><div class="diff-removed">-        }</div><div class="diff-removed">-</div><div class="diff-removed">-        return false;</div><div class="diff-removed">-    }</div><div class="diff-removed">-};</div><div class="diff-removed">-</div><div class="diff-removed">-test {</div><div class="diff-removed">-    const testing = std.testing;</div><div class="diff-removed">-    const alloc = testing.allocator;</div><div class="diff-removed">-</div><div class="diff-removed">-    var atlas = try font.Atlas.init(alloc, 512, .grayscale);</div><div class="diff-removed">-    defer atlas.deinit(alloc);</div><div class="diff-removed">-</div><div class="diff-removed">-    const name = try macos.foundation.String.createWithBytes("Monaco", .utf8, false);</div><div class="diff-removed">-    defer name.release();</div><div class="diff-removed">-    const desc = try macos.text.FontDescriptor.createWithNameAndSize(name, 12);</div><div class="diff-removed">-    defer desc.release();</div><div class="diff-removed">-    const ct_font = try macos.text.Font.createWithFontDescriptor(desc, 12);</div><div class="diff-removed">-    defer ct_font.release();</div><div class="diff-removed">-</div><div class="diff-removed">-    var face = try Face.initFontCopy(ct_font, .{ .size = .{ .points = 12 } });</div><div class="diff-removed">-    defer face.deinit();</div><div class="diff-removed">-</div><div class="diff-removed">-    // Generate all visible ASCII</div><div class="diff-removed">-    var i: u8 = 32;</div><div class="diff-removed">-    while (i < 127) : (i += 1) {</div><div class="diff-removed">-        try testing.expect(face.glyphIndex(i) != null);</div><div class="diff-removed">-        _ = try face.renderGlyph(</div><div class="diff-removed">-            alloc,</div><div class="diff-removed">-            &atlas,</div><div class="diff-removed">-            face.glyphIndex(i).?,</div><div class="diff-removed">-            .{ .grid_metrics = font.Metrics.calc(try face.getMetrics()) },</div><div class="diff-removed">-        );</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-test "name" {</div><div class="diff-removed">-    const testing = std.testing;</div><div class="diff-removed">-</div><div class="diff-removed">-    const name = try macos.foundation.String.createWithBytes("Menlo", .utf8, false);</div><div class="diff-removed">-    defer name.release();</div><div class="diff-removed">-    const desc = try macos.text.FontDescriptor.createWithNameAndSize(name, 12);</div><div class="diff-removed">-    defer desc.release();</div><div class="diff-removed">-    const ct_font = try macos.text.Font.createWithFontDescriptor(desc, 12);</div><div class="diff-removed">-    defer ct_font.release();</div><div class="diff-removed">-</div><div class="diff-removed">-    var face = try Face.initFontCopy(ct_font, .{ .size = .{ .points = 12 } });</div><div class="diff-removed">-    defer face.deinit();</div><div class="diff-removed">-</div><div class="diff-removed">-    var buf: [1024]u8 = undefined;</div><div class="diff-removed">-    const font_name = try face.name(&buf);</div><div class="diff-removed">-    try testing.expect(std.mem.eql(u8, font_name, "Menlo"));</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-test "emoji" {</div><div class="diff-removed">-    const testing = std.testing;</div><div class="diff-removed">-</div><div class="diff-removed">-    const name = try macos.foundation.String.createWithBytes("Apple Color Emoji", .utf8, false);</div><div class="diff-removed">-    defer name.release();</div><div class="diff-removed">-    const desc = try macos.text.FontDescriptor.createWithNameAndSize(name, 12);</div><div class="diff-removed">-    defer desc.release();</div><div class="diff-removed">-    const ct_font = try macos.text.Font.createWithFontDescriptor(desc, 12);</div><div class="diff-removed">-    defer ct_font.release();</div><div class="diff-removed">-</div><div class="diff-removed">-    var face = try Face.initFontCopy(ct_font, .{ .size = .{ .points = 18 } });</div><div class="diff-removed">-    defer face.deinit();</div><div class="diff-removed">-</div><div class="diff-removed">-    // Glyph index check</div><div class="diff-removed">-    {</div><div class="diff-removed">-        const id = face.glyphIndex('ü•∏').?;</div><div class="diff-removed">-        try testing.expect(face.isColorGlyph(id));</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-test "in-memory" {</div><div class="diff-removed">-    const testing = std.testing;</div><div class="diff-removed">-    const alloc = testing.allocator;</div><div class="diff-removed">-    const testFont = font.embedded.regular;</div><div class="diff-removed">-</div><div class="diff-removed">-    var atlas = try font.Atlas.init(alloc, 512, .grayscale);</div><div class="diff-removed">-    defer atlas.deinit(alloc);</div><div class="diff-removed">-</div><div class="diff-removed">-    var lib = try font.Library.init();</div><div class="diff-removed">-    defer lib.deinit();</div><div class="diff-removed">-</div><div class="diff-removed">-    var face = try Face.init(lib, testFont, .{ .size = .{ .points = 12 } });</div><div class="diff-removed">-    defer face.deinit();</div><div class="diff-removed">-</div><div class="diff-removed">-    // Generate all visible ASCII</div><div class="diff-removed">-    var i: u8 = 32;</div><div class="diff-removed">-    while (i < 127) : (i += 1) {</div><div class="diff-removed">-        try testing.expect(face.glyphIndex(i) != null);</div><div class="diff-removed">-        _ = try face.renderGlyph(</div><div class="diff-removed">-            alloc,</div><div class="diff-removed">-            &atlas,</div><div class="diff-removed">-            face.glyphIndex(i).?,</div><div class="diff-removed">-            .{ .grid_metrics = font.Metrics.calc(try face.getMetrics()) },</div><div class="diff-removed">-        );</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-test "variable" {</div><div class="diff-removed">-    const testing = std.testing;</div><div class="diff-removed">-    const alloc = testing.allocator;</div><div class="diff-removed">-    const testFont = font.embedded.variable;</div><div class="diff-removed">-</div><div class="diff-removed">-    var atlas = try font.Atlas.init(alloc, 512, .grayscale);</div><div class="diff-removed">-    defer atlas.deinit(alloc);</div><div class="diff-removed">-</div><div class="diff-removed">-    var lib = try font.Library.init();</div><div class="diff-removed">-    defer lib.deinit();</div><div class="diff-removed">-</div><div class="diff-removed">-    var face = try Face.init(lib, testFont, .{ .size = .{ .points = 12 } });</div><div class="diff-removed">-    defer face.deinit();</div><div class="diff-removed">-</div><div class="diff-removed">-    // Generate all visible ASCII</div><div class="diff-removed">-    var i: u8 = 32;</div><div class="diff-removed">-    while (i < 127) : (i += 1) {</div><div class="diff-removed">-        try testing.expect(face.glyphIndex(i) != null);</div><div class="diff-removed">-        _ = try face.renderGlyph(</div><div class="diff-removed">-            alloc,</div><div class="diff-removed">-            &atlas,</div><div class="diff-removed">-            face.glyphIndex(i).?,</div><div class="diff-removed">-            .{ .grid_metrics = font.Metrics.calc(try face.getMetrics()) },</div><div class="diff-removed">-        );</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-test "variable set variation" {</div><div class="diff-removed">-    const testing = std.testing;</div><div class="diff-removed">-    const alloc = testing.allocator;</div><div class="diff-removed">-    const testFont = font.embedded.variable;</div><div class="diff-removed">-</div><div class="diff-removed">-    var atlas = try font.Atlas.init(alloc, 512, .grayscale);</div><div class="diff-removed">-    defer atlas.deinit(alloc);</div><div class="diff-removed">-</div><div class="diff-removed">-    var lib = try font.Library.init();</div><div class="diff-removed">-    defer lib.deinit();</div><div class="diff-removed">-</div><div class="diff-removed">-    var face = try Face.init(lib, testFont, .{ .size = .{ .points = 12 } });</div><div class="diff-removed">-    defer face.deinit();</div><div class="diff-removed">-</div><div class="diff-removed">-    try face.setVariations(&.{</div><div class="diff-removed">-        .{ .id = font.face.Variation.Id.init("wght"), .value = 400 },</div><div class="diff-removed">-    }, .{ .size = .{ .points = 12 } });</div><div class="diff-removed">-</div><div class="diff-removed">-    // Generate all visible ASCII</div><div class="diff-removed">-    var i: u8 = 32;</div><div class="diff-removed">-    while (i < 127) : (i += 1) {</div><div class="diff-removed">-        try testing.expect(face.glyphIndex(i) != null);</div><div class="diff-removed">-        _ = try face.renderGlyph(</div><div class="diff-removed">-            alloc,</div><div class="diff-removed">-            &atlas,</div><div class="diff-removed">-            face.glyphIndex(i).?,</div><div class="diff-removed">-            .{ .grid_metrics = font.Metrics.calc(try face.getMetrics()) },</div><div class="diff-removed">-        );</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-test "svg font table" {</div><div class="diff-removed">-    const testing = std.testing;</div><div class="diff-removed">-    const alloc = testing.allocator;</div><div class="diff-removed">-    const testFont = font.embedded.julia_mono;</div><div class="diff-removed">-</div><div class="diff-removed">-    var lib = try font.Library.init();</div><div class="diff-removed">-    defer lib.deinit();</div><div class="diff-removed">-</div><div class="diff-removed">-    var face = try Face.init(lib, testFont, .{ .size = .{ .points = 12 } });</div><div class="diff-removed">-    defer face.deinit();</div><div class="diff-removed">-</div><div class="diff-removed">-    const table = (try face.copyTable(alloc, "SVG ")).?;</div><div class="diff-removed">-    defer alloc.free(table);</div><div class="diff-removed">-</div><div class="diff-removed">-    try testing.expect(table.len > 0);</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-test "glyphIndex colored vs text" {</div><div class="diff-removed">-    const testing = std.testing;</div><div class="diff-removed">-    const testFont = font.embedded.julia_mono;</div><div class="diff-removed">-</div><div class="diff-removed">-    var lib = try font.Library.init();</div><div class="diff-removed">-    defer lib.deinit();</div><div class="diff-removed">-</div><div class="diff-removed">-    var face = try Face.init(lib, testFont, .{ .size = .{ .points = 12 } });</div><div class="diff-removed">-    defer face.deinit();</div><div class="diff-removed">-</div><div class="diff-removed">-    {</div><div class="diff-removed">-        const glyph = face.glyphIndex('A').?;</div><div class="diff-removed">-        try testing.expectEqual(4, glyph);</div><div class="diff-removed">-        try testing.expect(!face.isColorGlyph(glyph));</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    {</div><div class="diff-removed">-        const glyph = face.glyphIndex(0xE800).?;</div><div class="diff-removed">-        try testing.expectEqual(11482, glyph);</div><div class="diff-removed">-        try testing.expect(face.isColorGlyph(glyph));</div><div class="diff-removed">-    }</div><div class="diff-removed">-}+</div><div class="diff-added">+    const GetMetricsError = error{</div><div class="diff-added">+        CopyTableError,</div><div class="diff-added">+        InvalidHeadTable,</div><div class="diff-added">+        InvalidPostTable,</div><div class="diff-added">+        InvalidHheaTable,</div><div class="diff-added">+    };</div><div class="diff-added">+</div><div class="diff-added">+    /// Get the `FaceMetrics` for this face.</div><div class="diff-added">+    pub fn getMetrics(self: *Face) GetMetricsError!font.Metrics.FaceMetrics {</div><div class="diff-added">+        const ct_font = self.font;</div><div class="diff-added">+</div><div class="diff-added">+        // Read the 'head' table out of the font data.</div><div class="diff-added">+        const head: opentype.Head = head: {</div><div class="diff-added">+            // macOS bitmap-only fonts use a 'bhed' tag rather than 'head', but</div><div class="diff-added">+            // the table format is byte-identical to the 'head' table, so if we</div><div class="diff-added">+            // can't find 'head' we try 'bhed' instead before failing.</div><div class="diff-added">+@@ -662,7 +665,7 @@ test "coretext: metrics" {</div><div class="diff-added">+         undefined,</div><div class="diff-added">+         testFont,</div><div class="diff-added">+         .{ .size = .{ .points = 12, .xdpi = 96, .ydpi = 96 } },</div><div class="diff-added">+-    );</div><div class="diff-added">++    ).Face;</div><div class="diff-added">+     defer ct_font.deinit();</div><div class="diff-added">+</div><div class="diff-added">+     try std.testing.expectEqual(font.Metrics.FaceMetrics{</div><div class="diff-added">+         .cell_width = 8,</div><div class="diff-added">+         // The cell height is 17 px because the calculation is</div><div class="diff-added">+         //</div><div class="diff-added">+@@ -687,7 +690,7 @@ test "coretext: metrics" {</div><div class="diff-added">+</div><div class="diff-added">+     // Resize should change metrics</div><div class="diff-added">+     try ct_font.setSize(.{ .size = .{ .points = 24, .xdpi = 96, .ydpi = 96 } });</div><div class="diff-added">+-    try std.testing.expectEqual(font.Metrics.FaceMetrics{</div><div class="diff-added">++    try std.testing.expectEqual(font.Metrics{</div><div class="diff-added">+         .cell_width = 16,</div><div class="diff-added">+         .cell_height = 34,</div><div class="diff-added">+         .cell_baseline = 6,</div></pre>
                </div>
            </div>
        </section>
    </main>
    <footer>
        <p>LoCoDiff-bench - <a href="https://github.com/AbanteAI/LoCoDiff-bench">GitHub Repository</a></p>
    </footer>
</body>
</html>
    