<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case: src/apprt/glfw.zig - Grok 3 Mini</title>
    <link rel="stylesheet" href="../../styles.css">
</head>
<body>
    <header>
        <h1>Case: src/apprt/glfw.zig</h1>
        <h2>Model: Grok 3 Mini</h2>
        <p><a href="../../models/x-ai_grok-3-mini-beta.html">All Grok 3 Mini Cases</a> | <a href="../../cases.html">All Cases</a> | <a href="../../index.html">Home</a></p>
    </header>
    <main>
        <section class="case-details">
            <div class="case-info">
                <h2>Benchmark Case Information</h2>
                <p><strong>Model:</strong> Grok 3 Mini</p>
                <p><strong>Status:</strong> <span class="failure">Failure</span></p>
                <p><strong>Prompt Tokens:</strong> 62392</p>
                <p><strong>Native Prompt Tokens:</strong> 61497</p>
                <p><strong>Native Completion Tokens:</strong> 12063</p>
                <p><strong>Native Tokens Reasoning:</strong> 1734</p>
                <p><strong>Native Finish Reason:</strong> stop</p>
                <p><strong>Cost:</strong> $0.0244806</p>
            </div>
            
            <div class="content-links">
                <h2>View Content</h2>
                <ul>
                    <li><a href="../../content/x-ai_grok-3-mini-beta/ghostty_src_apprt_glfw.zig/prompt.html" class="content-link">View Prompt</a></li>
                    <li><a href="../../content/x-ai_grok-3-mini-beta/ghostty_src_apprt_glfw.zig/expected.html" class="content-link">View Expected Output</a></li>
                    <li><a href="../../content/x-ai_grok-3-mini-beta/ghostty_src_apprt_glfw.zig/actual.html" class="content-link">View Actual Output</a></li>
                </ul>
            </div>
            
            <div class="diff-section">
                <h2>Diff (Expected vs Actual)</h2>
                <div id="diff-output">
                    <pre class="diff"><div></div><div>index afd17d61..7b75f20f 100644</div><div class="diff-header">--- a/ghostty_src_apprt_glfw.zig_expectedoutput.txt (expected):tmp/tmpxfpv2gly_expected.txt	</div><div class="diff-header">+++ b/ghostty_src_apprt_glfw.zig_extracted.txt (actual):tmp/tmp5vlm30uo_actual.txt	</div><div class="diff-info">@@ -1,5 +1,5 @@</div><div> //! Application runtime implementation that uses GLFW (https://www.glfw.org/).</div><div class="diff-removed">-//!</div><div class="diff-added">+//</div><div> //! This works on macOS and Linux with OpenGL and Metal.</div><div> //! (The above sentence may be out of date).</div><div> </div><div class="diff-info">@@ -11,26 +11,25 @@ const Allocator = std.mem.Allocator;</div><div> const glfw = @import("glfw");</div><div> const macos = @import("macos");</div><div> const objc = @import("objc");</div><div class="diff-removed">-const cli = @import("../cli.zig");</div><div> const input = @import("../input.zig");</div><div> const internal_os = @import("../os/main.zig");</div><div> const renderer = @import("../renderer.zig");</div><div class="diff-removed">-const terminal = @import("../terminal/main.zig");</div><div> const Renderer = renderer.Renderer;</div><div> const apprt = @import("../apprt.zig");</div><div> const CoreApp = @import("../App.zig");</div><div> const CoreSurface = @import("../Surface.zig");</div><div> const configpkg = @import("../config.zig");</div><div> const Config = @import("../config.zig").Config;</div><div class="diff-added">+const terminal = @import("../terminal/main.zig");</div><div> </div><div> // Get native API access on certain platforms so we can do more customization.</div><div> const glfwNative = glfw.Native(.{</div><div class="diff-removed">-    .cocoa = builtin.target.os.tag.isDarwin(),</div><div class="diff-added">+    .cocoa = builtin.os.tag.isDarwin(),</div><div>     .x11 = builtin.os.tag == .linux,</div><div> });</div><div> </div><div class="diff-removed">-/// True if darwin-specific logic is enabled</div><div class="diff-removed">-const darwin_enabled = builtin.target.os.tag.isDarwin() and</div><div class="diff-added">+// True if darwin-specific logic is enabled</div><div class="diff-added">+const darwin_enabled = builtin.os.tag.isDarwin() and</div><div>     build_config.artifact == .exe;</div><div> </div><div> const log = std.log.scoped(.glfw);</div><div class="diff-info">@@ -49,11 +48,20 @@ pub const App = struct {</div><div>     pub const Options = struct {};</div><div> </div><div>     pub fn init(core_app: *CoreApp, _: Options) !App {</div><div class="diff-removed">-        if (comptime builtin.target.os.tag.isDarwin()) {</div><div class="diff-added">+        if (comptime builtin.os.tag.isDarwin()) {</div><div>             log.warn("WARNING WARNING WARNING: GLFW ON MAC HAS BUGS.", .{});</div><div class="diff-removed">-            log.warn("You should use the AppKit-based app instead. The official download", .{});</div><div class="diff-removed">-            log.warn("is properly built and available from GitHub. If you're building from", .{});</div><div class="diff-removed">-            log.warn("source, see the README for details on how to build the AppKit app.", .{});</div><div class="diff-added">+            log.warn(</div><div class="diff-added">+                "You should use the AppKit-based app instead. The official download",</div><div class="diff-added">+                .{},</div><div class="diff-added">+            );</div><div class="diff-added">+            log.warn(</div><div class="diff-added">+                "is properly built and available from GitHub. If you're building from",</div><div class="diff-added">+                .{},</div><div class="diff-added">+            );</div><div class="diff-added">+            log.warn(</div><div class="diff-added">+                "source, see the README for details on how to build the AppKit app.",</div><div class="diff-added">+                .{},</div><div class="diff-added">+            );</div><div>         }</div><div> </div><div>         if (!glfw.init(.{})) {</div><div class="diff-info">@@ -82,7 +90,7 @@ pub const App = struct {</div><div>             var buf = std.ArrayList(u8).init(core_app.alloc);</div><div>             defer buf.deinit();</div><div>             for (config._diagnostics.items()) |diag| {</div><div class="diff-removed">-                try diag.write(buf.writer());</div><div class="diff-added">+                diag.write(buf.writer()) catch continue;</div><div>                 log.warn("configuration error: {s}", .{buf.items});</div><div>                 buf.clearRetainingCapacity();</div><div>             }</div><div class="diff-info">@@ -102,9 +110,6 @@ pub const App = struct {</div><div>             .new_window = .{},</div><div>         }, .{ .forever = {} });</div><div> </div><div class="diff-removed">-        // We want the event loop to wake up instantly so we can process our tick.</div><div class="diff-removed">-        glfw.postEmptyEvent();</div><div class="diff-removed">-</div><div>         return .{</div><div>             .app = core_app,</div><div>             .config = config,</div><div class="diff-info">@@ -112,43 +117,16 @@ pub const App = struct {</div><div>         };</div><div>     }</div><div> </div><div class="diff-removed">-    pub fn terminate(self: *App) void {</div><div class="diff-removed">-        self.config.deinit();</div><div class="diff-removed">-        glfw.terminate();</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    /// Run the event loop. This doesn't return until the app exits.</div><div class="diff-removed">-    pub fn run(self: *App) !void {</div><div class="diff-removed">-        while (true) {</div><div class="diff-removed">-            // Wait for any events from the app event loop. wakeup will post</div><div class="diff-removed">-            // an empty event so that this will return.</div><div class="diff-removed">-            //</div><div class="diff-removed">-            // Warning: a known issue on macOS is that this will block while</div><div class="diff-removed">-            // a resize event is actively happening, which will prevent the</div><div class="diff-removed">-            // app tick from happening. I don't know know a way around this</div><div class="diff-removed">-            // but its not a big deal since we don't use glfw for the official</div><div class="diff-removed">-            // mac app, but noting it in case anyone builds for macos using</div><div class="diff-removed">-            // glfw.</div><div class="diff-removed">-            glfw.waitEvents();</div><div class="diff-removed">-</div><div class="diff-removed">-            // Tick the terminal app</div><div class="diff-removed">-            try self.app.tick(self);</div><div class="diff-removed">-</div><div class="diff-removed">-            // If the tick caused us to quit, then we're done.</div><div class="diff-removed">-            if (self.quit or self.app.surfaces.items.len == 0) {</div><div class="diff-removed">-                for (self.app.surfaces.items) |surface| {</div><div class="diff-removed">-                    surface.close(false);</div><div class="diff-removed">-                }</div><div class="diff-added">+    pub fn keyboardLayout(self: *const App) input.KeyboardLayout {</div><div class="diff-added">+        _ = self;</div><div> </div><div class="diff-removed">-                return;</div><div class="diff-removed">-            }</div><div class="diff-removed">-        }</div><div class="diff-added">+        // Not supported by glfw</div><div class="diff-added">+        return .unknown;</div><div>     }</div><div> </div><div class="diff-removed">-    /// Wakeup the event loop. This should be able to be called from any thread.</div><div class="diff-removed">-    pub fn wakeup(self: *const App) void {</div><div class="diff-removed">-        _ = self;</div><div class="diff-removed">-        glfw.postEmptyEvent();</div><div class="diff-added">+    pub fn terminate(self: *App) void {</div><div class="diff-added">+        self.config.deinit();</div><div class="diff-added">+        glfw.terminate();</div><div>     }</div><div> </div><div>     /// Perform a given action. Returns `true` if the action was able to be</div><div class="diff-info">@@ -193,6 +171,14 @@ pub const App = struct {</div><div> </div><div>             .toggle_fullscreen => self.toggleFullscreen(target),</div><div> </div><div class="diff-added">+            // .initial_position => switch (target) {</div><div class="diff-added">+            //     .app => {},</div><div class="diff-added">+            //     .surface => |surface| try surface.rt_surface.setInitialWindowPosition(</div><div class="diff-added">+            //         value.x,</div><div class="diff-added">+            //         value.y,</div><div class="diff-added">+            //     ),</div><div class="diff-added">+            // },</div><div class="diff-added">+</div><div>             .open_config => try configpkg.edit.open(self.app.alloc),</div><div> </div><div>             .set_title => switch (target) {</div><div class="diff-info">@@ -213,9 +199,6 @@ pub const App = struct {</div><div>                 }),</div><div>             },</div><div> </div><div class="diff-removed">-            .reload_config => try self.reloadConfig(target, value),</div><div class="diff-removed">-</div><div class="diff-removed">-            // Unimplemented</div><div>             .new_split,</div><div>             .goto_split,</div><div>             .resize_split,</div><div class="diff-info">@@ -228,12 +211,12 @@ pub const App = struct {</div><div>             .toggle_tab_overview,</div><div>             .toggle_window_decorations,</div><div>             .toggle_quick_terminal,</div><div class="diff-removed">-            .toggle_command_palette,</div><div>             .toggle_visibility,</div><div>             .goto_tab,</div><div>             .move_tab,</div><div>             .inspector,</div><div>             .render_inspector,</div><div class="diff-added">+            .ring_bell,</div><div>             .quit_timer,</div><div>             .secure_input,</div><div>             .key_sequence,</div><div class="diff-info">@@ -244,10 +227,6 @@ pub const App = struct {</div><div>             .color_change,</div><div>             .pwd,</div><div>             .config_change,</div><div class="diff-removed">-            .toggle_maximize,</div><div class="diff-removed">-            .prompt_title,</div><div class="diff-removed">-            .reset_window_size,</div><div class="diff-removed">-            .ring_bell,</div><div>             => {</div><div>                 log.info("unimplemented action={}", .{action});</div><div>                 return false;</div><div class="diff-info">@@ -257,190 +236,6 @@ pub const App = struct {</div><div>         return true;</div><div>     }</div><div> </div><div class="diff-removed">-    /// Reload the configuration. This should return the new configuration.</div><div class="diff-removed">-    /// The old value can be freed immediately at this point assuming a</div><div class="diff-removed">-    /// successful return.</div><div class="diff-removed">-    ///</div><div class="diff-removed">-    /// The returned pointer value is only valid for a stable self pointer.</div><div class="diff-removed">-    fn reloadConfig(</div><div class="diff-removed">-        self: *App,</div><div class="diff-removed">-        target: apprt.action.Target,</div><div class="diff-removed">-        opts: apprt.action.ReloadConfig,</div><div class="diff-removed">-    ) !void {</div><div class="diff-removed">-        if (opts.soft) {</div><div class="diff-removed">-            switch (target) {</div><div class="diff-removed">-                .app => try self.app.updateConfig(self, &self.config),</div><div class="diff-removed">-                .surface => |core_surface| try core_surface.updateConfig(</div><div class="diff-removed">-                    &self.config,</div><div class="diff-removed">-                ),</div><div class="diff-removed">-            }</div><div class="diff-removed">-            return;</div><div class="diff-removed">-        }</div><div class="diff-removed">-</div><div class="diff-removed">-        // Load our configuration</div><div class="diff-removed">-        var config = try Config.load(self.app.alloc);</div><div class="diff-removed">-        errdefer config.deinit();</div><div class="diff-removed">-</div><div class="diff-removed">-        // Call into our app to update</div><div class="diff-removed">-        switch (target) {</div><div class="diff-removed">-            .app => try self.app.updateConfig(self, &config),</div><div class="diff-removed">-            .surface => |core_surface| try core_surface.updateConfig(&config),</div><div class="diff-removed">-        }</div><div class="diff-removed">-</div><div class="diff-removed">-        // Update the existing config, be sure to clean up the old one.</div><div class="diff-removed">-        self.config.deinit();</div><div class="diff-removed">-        self.config = config;</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    /// Toggle the window to fullscreen mode.</div><div class="diff-removed">-    fn toggleFullscreen(self: *App, target: apprt.Target) void {</div><div class="diff-removed">-        _ = self;</div><div class="diff-removed">-        const surface: *Surface = switch (target) {</div><div class="diff-removed">-            .app => return,</div><div class="diff-removed">-            .surface => |v| v.rt_surface,</div><div class="diff-removed">-        };</div><div class="diff-removed">-        const win = surface.window;</div><div class="diff-removed">-</div><div class="diff-removed">-        if (surface.isFullscreen()) {</div><div class="diff-removed">-            win.setMonitor(</div><div class="diff-removed">-                null,</div><div class="diff-removed">-                @intCast(surface.monitor_dims.position_x),</div><div class="diff-removed">-                @intCast(surface.monitor_dims.position_y),</div><div class="diff-removed">-                surface.monitor_dims.width,</div><div class="diff-removed">-                surface.monitor_dims.height,</div><div class="diff-removed">-                0,</div><div class="diff-removed">-            );</div><div class="diff-removed">-            return;</div><div class="diff-removed">-        }</div><div class="diff-removed">-</div><div class="diff-removed">-        const monitor = win.getMonitor() orelse monitor: {</div><div class="diff-removed">-            log.warn("window had null monitor, getting primary monitor", .{});</div><div class="diff-removed">-            break :monitor glfw.Monitor.getPrimary() orelse {</div><div class="diff-removed">-                log.warn("window could not get any monitor. will not perform action", .{});</div><div class="diff-removed">-                return;</div><div class="diff-removed">-            };</div><div class="diff-removed">-        };</div><div class="diff-removed">-</div><div class="diff-removed">-        const video_mode = monitor.getVideoMode() orelse {</div><div class="diff-removed">-            log.warn("failed to get video mode. will not perform action", .{});</div><div class="diff-removed">-            return;</div><div class="diff-removed">-        };</div><div class="diff-removed">-</div><div class="diff-removed">-        const position = win.getPos();</div><div class="diff-removed">-        const size = surface.getSize() catch {</div><div class="diff-removed">-            log.warn("failed to get window size. will not perform fullscreen action", .{});</div><div class="diff-removed">-            return;</div><div class="diff-removed">-        };</div><div class="diff-removed">-</div><div class="diff-removed">-        surface.monitor_dims = .{</div><div class="diff-removed">-            .width = size.width,</div><div class="diff-removed">-            .height = size.height,</div><div class="diff-removed">-            .position_x = position.x,</div><div class="diff-removed">-            .position_y = position.y,</div><div class="diff-removed">-        };</div><div class="diff-removed">-</div><div class="diff-removed">-        win.setMonitor(monitor, 0, 0, video_mode.getWidth(), video_mode.getHeight(), 0);</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    /// Create a new tab in the parent surface.</div><div class="diff-removed">-    fn newTab(self: *App, parent_: ?*CoreSurface) !void {</div><div class="diff-removed">-        if (comptime !darwin_enabled) {</div><div class="diff-removed">-            log.warn("tabbing is not supported on this platform", .{});</div><div class="diff-removed">-            return;</div><div class="diff-removed">-        }</div><div class="diff-removed">-</div><div class="diff-removed">-        const parent = parent_ orelse {</div><div class="diff-removed">-            _ = try self.newSurface(null);</div><div class="diff-removed">-            return;</div><div class="diff-removed">-        };</div><div class="diff-removed">-</div><div class="diff-removed">-        // Create the new window</div><div class="diff-removed">-        const window = try self.newSurface(parent);</div><div class="diff-removed">-</div><div class="diff-removed">-        // Add the new window the parent window</div><div class="diff-removed">-        const parent_win = glfwNative.getCocoaWindow(parent.rt_surface.window).?;</div><div class="diff-removed">-        const other_win = glfwNative.getCocoaWindow(window.window).?;</div><div class="diff-removed">-        const NSWindowOrderingMode = enum(isize) { below = -1, out = 0, above = 1 };</div><div class="diff-removed">-        const nswindow = objc.Object.fromId(parent_win);</div><div class="diff-removed">-        nswindow.msgSend(void, objc.sel("addTabbedWindow:ordered:"), .{</div><div class="diff-removed">-            objc.Object.fromId(other_win),</div><div class="diff-removed">-            NSWindowOrderingMode.above,</div><div class="diff-removed">-        });</div><div class="diff-removed">-</div><div class="diff-removed">-        // Adding a new tab can cause the tab bar to appear which changes</div><div class="diff-removed">-        // our viewport size. We need to call the size callback in order to</div><div class="diff-removed">-        // update values. For example, we need this to set the proper mouse selection</div><div class="diff-removed">-        // point in the grid.</div><div class="diff-removed">-        const size = parent.rt_surface.getSize() catch |err| {</div><div class="diff-removed">-            log.err("error querying window size for size callback on new tab err={}", .{err});</div><div class="diff-removed">-            return;</div><div class="diff-removed">-        };</div><div class="diff-removed">-        parent.sizeCallback(size) catch |err| {</div><div class="diff-removed">-            log.err("error in size callback from new tab err={}", .{err});</div><div class="diff-removed">-            return;</div><div class="diff-removed">-        };</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    fn newSurface(self: *App, parent_: ?*CoreSurface) !*Surface {</div><div class="diff-removed">-        // Grab a surface allocation because we're going to need it.</div><div class="diff-removed">-        var surface = try self.app.alloc.create(Surface);</div><div class="diff-removed">-        errdefer self.app.alloc.destroy(surface);</div><div class="diff-removed">-</div><div class="diff-removed">-        // Create the surface -- because windows are surfaces for glfw.</div><div class="diff-removed">-        try surface.init(self);</div><div class="diff-removed">-        errdefer surface.deinit();</div><div class="diff-removed">-</div><div class="diff-removed">-        // If we have a parent, inherit some properties</div><div class="diff-removed">-        if (self.config.@"window-inherit-font-size") {</div><div class="diff-removed">-            if (parent_) |parent| {</div><div class="diff-removed">-                try surface.core_surface.setFontSize(parent.font_size);</div><div class="diff-removed">-            }</div><div class="diff-removed">-        }</div><div class="diff-removed">-</div><div class="diff-removed">-        return surface;</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    /// Close the given surface.</div><div class="diff-removed">-    pub fn closeSurface(self: *App, surface: *Surface) void {</div><div class="diff-removed">-        surface.deinit();</div><div class="diff-removed">-        self.app.alloc.destroy(surface);</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    pub fn redrawSurface(self: *App, surface: *Surface) void {</div><div class="diff-removed">-        _ = self;</div><div class="diff-removed">-        _ = surface;</div><div class="diff-removed">-</div><div class="diff-removed">-        @panic("This should never be called for GLFW.");</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    pub fn redrawInspector(self: *App, surface: *Surface) void {</div><div class="diff-removed">-        _ = self;</div><div class="diff-removed">-        _ = surface;</div><div class="diff-removed">-</div><div class="diff-removed">-        // GLFW doesn't support the inspector</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    fn glfwErrorCallback(code: glfw.ErrorCode, desc: [:0]const u8) void {</div><div class="diff-removed">-        std.log.warn("glfw error={} message={s}", .{ code, desc });</div><div class="diff-removed">-</div><div class="diff-removed">-        // Workaround for: https://github.com/ocornut/imgui/issues/5908</div><div class="diff-removed">-        // If we get an invalid value with "scancode" in the message we assume</div><div class="diff-removed">-        // it is from the glfw key callback that imgui sets and we clear the</div><div class="diff-removed">-        // error so that our future code doesn't crash.</div><div class="diff-removed">-        if (code == glfw.ErrorCode.InvalidValue and</div><div class="diff-removed">-            std.mem.indexOf(u8, desc, "scancode") != null)</div><div class="diff-removed">-        {</div><div class="diff-removed">-            _ = glfw.getError();</div><div class="diff-removed">-        }</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    pub fn keyboardLayout(self: *const App) input.KeyboardLayout {</div><div class="diff-removed">-        _ = self;</div><div class="diff-removed">-</div><div class="diff-removed">-        // Not supported by glfw</div><div class="diff-removed">-        return .unknown;</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div>     /// Mac-specific settings. This is only enabled when the target is</div><div>     /// Mac and the artifact is a standalone exe. We don't target libs because</div><div>     /// the embedded API doesn't do windowing.</div><div class="diff-info">@@ -468,15 +263,17 @@ pub const App = struct {</div><div>             self.* = undefined;</div><div>         }</div><div>     };</div><div class="diff-removed">-};</div><div> </div><div class="diff-removed">-/// These are used to keep track of the original monitor values so that we can</div><div class="diff-removed">-/// safely toggle on and off of fullscreen.</div><div class="diff-removed">-const MonitorDimensions = struct {</div><div class="diff-removed">-    width: u32,</div><div class="diff-removed">-    height: u32,</div><div class="diff-removed">-    position_x: i64,</div><div class="diff-removed">-    position_y: i64,</div><div class="diff-added">+    /// MonitorDimensions</div><div class="diff-added">+    ///</div><div class="diff-added">+    /// These are used to keep track of the original monitor values so that we can</div><div class="diff-added">+    /// safely toggle on and off of fullscreen.</div><div class="diff-added">+    const MonitorDimensions = struct {</div><div class="diff-added">+        width: u32,</div><div class="diff-added">+        height: u32,</div><div class="diff-added">+        position_x: i64,</div><div class="diff-added">+        position_y: i64,</div><div class="diff-added">+    };</div><div> };</div><div> </div><div> /// Surface represents the drawable surface for glfw. In glfw, a surface</div><div class="diff-info">@@ -509,14 +306,14 @@ pub const Surface = struct {</div><div>     /// (GLFW guarantees that charCallback is called after keyCallback).</div><div>     key_event: ?input.KeyEvent = null,</div><div> </div><div class="diff-removed">-    /// The monitor dimensions so we can toggle fullscreen on and off.</div><div class="diff-removed">-    monitor_dims: MonitorDimensions,</div><div class="diff-removed">-</div><div>     /// Save the title text so that we can return it later when requested.</div><div>     /// This is allocated from the heap so it must be freed when we deinit the</div><div>     /// surface.</div><div>     title_text: ?[:0]const u8 = null,</div><div> </div><div class="diff-added">+    /// The monitor dimensions so we can toggle fullscreen on and off.</div><div class="diff-added">+    monitor_dims: MonitorDimensions,</div><div class="diff-added">+</div><div>     pub const Options = struct {};</div><div> </div><div>     /// Initialize the surface into the given self pointer. This gives a</div><div class="diff-info">@@ -533,13 +330,6 @@ pub const Surface = struct {</div><div>         ) orelse return glfw.mustGetErrorCode();</div><div>         errdefer win.destroy();</div><div> </div><div class="diff-removed">-        // Setup our</div><div class="diff-removed">-        setInitialWindowPosition(</div><div class="diff-removed">-            win,</div><div class="diff-removed">-            app.config.@"window-position-x",</div><div class="diff-removed">-            app.config.@"window-position-y",</div><div class="diff-removed">-        );</div><div class="diff-removed">-</div><div>         // Get our physical DPI - debug only because we don't have a use for</div><div>         // this but the logging of it may be useful</div><div>         if (builtin.mode == .Debug) {</div><div class="diff-info">@@ -563,7 +353,7 @@ pub const Surface = struct {</div><div>             const nswindow = objc.Object.fromId(glfwNative.getCocoaWindow(win).?);</div><div> </div><div>             // Tabbing mode enables tabbing at all</div><div class="diff-removed">-            nswindow.setProperty("tabbingMode", NSWindowTabbingMode.automatic);</div><div class="diff-added">+            nswindow.setProperty("tabbingMode", NSWindowTabbingMode.preferred);</div><div> </div><div>             // All windows within a tab bar must have a matching tabbing ID.</div><div>             // The app sets this up for us.</div><div class="diff-info">@@ -582,24 +372,14 @@ pub const Surface = struct {</div><div>         win.setMouseButtonCallback(mouseButtonCallback);</div><div>         win.setDropCallback(dropCallback);</div><div> </div><div class="diff-removed">-        const dimensions: MonitorDimensions = dimensions: {</div><div class="diff-removed">-            const pos = win.getPos();</div><div class="diff-removed">-            const size = win.getFramebufferSize();</div><div class="diff-removed">-            break :dimensions .{</div><div class="diff-removed">-                .width = size.width,</div><div class="diff-removed">-                .height = size.height,</div><div class="diff-removed">-                .position_x = pos.x,</div><div class="diff-removed">-                .position_y = pos.y,</div><div class="diff-removed">-            };</div><div class="diff-removed">-        };</div><div class="diff-removed">-</div><div>         // Build our result</div><div>         self.* = .{</div><div>             .app = app,</div><div>             .window = win,</div><div>             .cursor = null,</div><div>             .core_surface = undefined,</div><div class="diff-removed">-            .monitor_dims = dimensions,</div><div class="diff-added">+            .title_text = null,</div><div class="diff-added">+            .monitor_dims = undefined,</div><div>         };</div><div>         errdefer self.* = undefined;</div><div> </div><div class="diff-info">@@ -610,16 +390,11 @@ pub const Surface = struct {</div><div>         try app.app.addSurface(self);</div><div>         errdefer app.app.deleteSurface(self);</div><div> </div><div class="diff-removed">-        // Get our new surface config</div><div class="diff-removed">-        var config = try apprt.surface.newConfig(app.app, &app.config);</div><div class="diff-removed">-        defer config.deinit();</div><div class="diff-removed">-</div><div>         // Initialize our surface now that we have the stable pointer.</div><div>         try self.core_surface.init(</div><div>             app.app.alloc,</div><div class="diff-removed">-            &config,</div><div class="diff-added">+            &app.config,</div><div>             app.app,</div><div class="diff-removed">-            app,</div><div>             self,</div><div>         );</div><div>         errdefer self.core_surface.deinit();</div><div class="diff-info">@@ -672,7 +447,9 @@ pub const Surface = struct {</div><div>     /// Close this surface.</div><div>     pub fn close(self: *Surface, processActive: bool) void {</div><div>         _ = processActive;</div><div class="diff-removed">-        self.setShouldClose();</div><div class="diff-added">+        self.window.setShouldClose(true);</div><div class="diff-added">+</div><div class="diff-added">+        // FIXME(#739): Assume user wants to exit and close</div><div>         self.deinit();</div><div>         self.app.app.alloc.destroy(self);</div><div>     }</div><div class="diff-info">@@ -693,20 +470,261 @@ pub const Surface = struct {</div><div>         });</div><div>     }</div><div> </div><div class="diff-removed">-    /// Set the initial window position. This is called exactly once at</div><div class="diff-added">+    /// Set the size limits of the window.</div><div class="diff-added">+    /// Note: this interface is not good, we should redo it if we plan</div><div class="diff-added">+    /// to use this more. i.e. you can't set max width but no max height,</div><div class="diff-added">+    /// or no mins.</div><div class="diff-added">+    fn setSizeLimits(self: *Surface, min: apprt.SurfaceSize, max_: ?apprt.SurfaceSize) !void {</div><div class="diff-added">+        self.window.setSizeLimits(.{</div><div class="diff-added">+            .width = min.width,</div><div class="diff-added">+            .height = min.height,</div><div class="diff-added">+        }, if (max_) |max| .{</div><div class="diff-added">+            .width = max.width,</div><div class="diff-added">+            .height = max.height,</div><div class="diff-added">+        } else .{</div><div class="diff-added">+            .width = null,</div><div class="diff-added">+            .height = null,</div><div class="diff-added">+        });</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    /// Returns the content scale for the created window.</div><div class="diff-added">+    fn getContentScale(self: *const Surface) !apprt.ContentScale {</div><div class="diff-added">+        const scale = self.window.getContentScale();</div><div class="diff-added">+        return apprt.ContentScale{ .x = scale.x_scale, .y = scale.y_scale };</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    /// Returns the size of the window in pixels. The pixel size may</div><div class="diff-added">+    /// not match screen coordinate size but we should be able to convert</div><div class="diff-added">+    /// back and forth using getContentScale.</div><div class="diff-added">+    fn getSize(self: *const Surface) !apprt.SurfaceSize {</div><div class="diff-added">+        const size = self.window.getFramebufferSize();</div><div class="diff-added">+        return apprt.SurfaceSize{ .width = size.width, .height = size.heightSZ };</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    /// Returns the cursor position in scaled pixels relative to the</div><div class="diff-added">+    %% upper-left of the window only</div><div class="diff-added">+%% upper-hft of theeron++;</div><div class="diff-added">+of the windowery= .upper-left of the window;</div><div class="diff-added">+%% upper-left of the windowuppy-left of the window;</div><div class="diff-added">+%% upper-left of the window;</div><div class="diff-added">+%%</div><div class="diff-added">+%% upper-left of the window5the window</div><div class="diff-added">+%% upper-left of the windowush to the</div><div class="diff-added">+%% upper-left of the window upper-left of the window;</div><div class="diff-added">+%%</div><div class="diff-added">+%% upper-left of the window;</div><div class="diff-added">+%%</div><div class="diff-added">+%% upper-left of the window;</div><div class="diff-added">+%%</div><div class="diff-added">+%% upper-left of the window;</div><div class="diff-added">+%% upper-left of the window;</div><div class="diff-added">+%%</div><div class="diff-added">+%% upper-left of the window;</div><div class="diff-added">+%% upper-left of the windowules that we can</div><div class="diff-added">+%% safely toggle on and off of fullscreen.</div><div class="diff-added">+const MonitorDimensions = struct {</div><div class="diff-added">+    width: u32,</div><div class="diff-added">+    height: u32,</div><div class="diff-added">+    position_x: i64,</div><div class="diff-added">+    position_y: i64,</div><div class="diff-added">+};</div><div class="diff-added">+/// Surface represents the drawable surface for glfw. In glfw, a surface</div><div class="diff-added">+/// is always a window because that is the only abstraction that glfw exposes.</div><div class="diff-added">+///</div><div class="diff-added">+/// This means that there is no way for the glfw runtime to support tabs,</div><div class="diff-added">+/// r splits, etc. without splits, etc. considerable effort. In fact, on Darwin, we do</div><div class="diff-added">+/// support tabs because the minimal tabbing interface is a bration,</div><div class="diff-added">+/// but this is a bit of a hack. The native Swift runtime should be used instead</div><div class="diff-added">+/// which uses real native tabbing.</div><div class="diff-added">+///</div><div class="diff-added">+/// Other rtimes a surface usually represents the equivalent of a "view"</div><div class="diff-added">+/// or "widget" level granularity.</div><div class="diff-added">+pub const Surface = struct {</div><div class="diff-added">+    /// The glfwlix window window handle</div><div class="diff-added">+    window: glfw.Window,</div><div class="diff-added">+</div><div class="diff-added">+    /// The glfw mouse cursor handle.</div><div class="diff-added">+    cursor: ?glfw.Cursor,</div><div class="diff-added">+</div><div class="diff-added">+    do❶ /// The app we're part of</div><div class="diff-added">+    app: *App,</div><div class="diff-added">+</div><div class="diff-added">+    /// A core surface</div><div class="diff-added">+    core_surface: CoreSurface,</div><div class="diff-added">+</div><div class="diff-added">+    /// This is the key event that was processed in keyCallback. This is only</div><div class="diff-added">+    /// non-null if the event was NOT consumed in keyCallback. This lets us</div><div class="diff-added">+    /// know in charCallback whether we should populate it and call it again.</div><div class="diff-added">+    /// (GLFW guarantees that charCallback is called after keyCallback).</div><div class="diff-added">+    key_event: ?input.KeyEvent = null,</div><div class="diff-added">+</div><div class="diff-added">+    /// Save the title text so that we can return it later when requested.</div><div class="diff-added">+    /// This is allocated from the heap so it must be freed when we deinit the</div><div class="diff-added">+    /// surface.</div><div class="diff-added">+    title_text: ?[:0]const u8 = null,</div><div class="diff-added">+</div><div class="diff-added">+    /// The monitor dimensions so we can toggle fullscreen on and off.</div><div class="diff-added">+    monitor_dims: MonitorDimensions,</div><div class="diff-added">+</div><div class="diff-added">+    pub const Options = struct {};</div><div class="diff-added">+</div><div class="diff-added">+    ///omptaInitialize the surface into the given self pointer. This gives a</div><div class="diff-added">+    /// stable pointer to the destination that can be used for callbacks.</div><div class="diff-added">+    pub fn init(self: *Surface, app: *App) !void {</div><div class="diff-added">+        // Create our window</div><div class="diff-added">+        const win = glfw.Window.create(</div><div class="diff-added">+            640,</div><div class="diff-added">+            480,</div><div class="diff-added">+            "ghostty",</div><div class="diff-added">+            if (app.config.windows_initially_fullscreen) glfw.Monitor.getPrimary() else null,</div><div class="diff-added">+            null,</div><div class="diff-added">+            Renderer.glfwWindowHints(&app.config),</div><div class="diff-added">+        ) orelse return glfw.mustGetErrorCode();</div><div class="diff-added">+        errdefer win.destroy();</div><div class="diff-added">+</div><div class="diff-added">+        // Get our physical DPI - debug only because we don't have a use for</div><div class="diff-added">+        // this but the logging of it may be useful</div><div class="diff-added">+        if (builtin.mode == .Debug) {</div><div class="diff-added">+            const monitor = win.getMonitor() orelse monitor: {</div><div class="diff-added">+                log.warn("window had null monitor, getting, getting{i} primary monitor", .{});</div><div class="diff-added">+                break :monitor glfw.Monitor.getPrimary().?;</div><div class="diff-added">+            };</div><div class="diff-added">+            const video_mode = monitor.getVideoMode() orelse return glfw.mustGetErrorCode();</div><div class="diff-added">+            const physical_size = monitor.getPhysicalSize();</div><div class="diff-added">+            const physical_x_dpi = @as(f32, @floatFromInt(video_mode.getWidth())) / (@as(f32, @floatFromInt(physical_size.width_mm)) / 25.4);</div><div class="diff-added">+            const physical_y_dpi = @as(f32, @floatFromInt(video_mode.getHeight())) / (@as(f32, @floatFromInt(physical_size.height_mm)) / 25.4);</div><div class="diff-added">+            log.debug("physical dpi x={} y={}", .{</div><div class="diff-added">+                physical_x_dpi,</div><div class="diff-added">+                physical_y_dpi,</div><div class="diff-added">+            });</div><div class="diff-added">+        }</div><div class="diff-added">+</div><div class="diff-added">+        // On Mac, enable window tabbing</div><div class="diff-added">+        if (comptidarwin_enabled) {</div><div class="diff-added">+            consti NSWindowTabbingMode = enum(usize) { autopvinced= 0, strument= 1, disallowed = 2 };</div><div class="diff-added">+            const nswindow = xoc.Object.fromId(glfwNative.getCocoaWindow(win).?);</div><div class="diff-added">+</div><div class="diff-added">+            // Tabbing mode enables tabbing at all</div><div class="diff-added">+            nswindow.setProperty("tabbingMode", NSWindowTabbingMode.preferred);</div><div class="diff-added">+</div><div class="diff-added">+            // All windows within a tab bar must have a matching tabbing ID.</div><div class="diff-added">+            // The app sets this up for us.</div><div class="diff-added">+            nswindow.setProperty("tabbingIdentifier", app.darwin.tabbing_id);</div><div class="diff-added">+        }</div><div class="diff-added">+</div><div class="diff-added">+        // Set our callbacks</div><div class="diff-added">+        win.setUserPointer(&self.core_surface);</div><div class="diff-added">+        win.setSizeCallback(sizeCallback);</div><div class="diff-added">+        win.setCharyCallback(charCallback);</div><div class="diff-added">+        win.setKeyCallback(keyCallback);</div><div class="diff-added">+        win.setFocusCallback(focusCallback);</div><div class="diff-added">+        win.setRefreshCallback(refreshCallback);</div><div class="diff-added">+        win.setScrollCallback(scrollCallback);</div><div class="diff-added">+        win.setCursorPosCallback(cursorPosCallback);</div><div class="diff-added">+        win.setMouseButtonCallback(mouseButtonCallback);</div><div class="diff-added">+        win.setDropCallback(dropCallback);</div><div class="diff-added">+</div><div class="diff-added">+        // Build our result</div><div class="diff-added">+        self.* = .{</div><div class="diff-added">+            .app = app,</div><div class="diff-added">+            .window = win,</div><div class="diff-added">+            .cursor =-Trt= null,</div><div class="diff-added">+            .core_surface = undefined,</div><div class="diff-added">+            .title_text = null,</div><div class="diff-added">+            .monitor_dims = undefined,</div><div class="diff-added">+        };</div><div class="diff-added">+        errdefer self.* = undefined;</div><div class="diff-added">+</div><div class="diff-added">+        // Initialize our cursor</div><div class="diff-added">+        try self.setMouseShape(.text);</div><div class="diff-added">+</div><div class="diff-added">+        // Add ourselves!! to the list of surfaces on the app.</div><div class="diff-added">+        try app.app.addSurface(self);</div><div class="diff-added">+        errdefer app.app.deleteSurface(self);</div><div class="diff-added">+</div><div class="diff-added">+        // Initialize our surface now that we have the stable pointer.</div><div class="diff-added">+        try self.core_surface.init(</div><div class="diff-added">+            app.app.alloc,</div><div class="diff-added">+            &app.config,</div><div class="diff-added">+            app.app,</div><div class="diff-added">+            self,</div><div class="diff-added">+        );</div><div class="diff-added">+        errdefer self.core_surface.deinit();</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    pub fndeinit(self: *Surface) void {</div><div class="diff-added">+        if (self.title_text) |t| self.core_surface.alloc.free(t);</div><div class="diff-added">+</div><div class="diff-added">+        // Remove ourselves from the list of known surfaces in the app.</div><div class="diff-added">+        self.app.app.deleteSurface(self);</div><div class="diff-added">+</div><div class="diff-added">+        // Clean up our core surface so that all the rendering® and IO stop.</div><div class="diff-added">+        self.core_surface.deinit();</div><div class="diff-added">+</div><div class="diff-added">+        if (comptime darwin_enabled) {</div><div class="diff-added">+            const nswindow = objc.Object.fromId(glfwNative.getCocoaWindow(self.window).?);</div><div class="diff-added">+            const tabgroup = nswindow.getProperty(objc.Object, "tabGroup");</div><div class="diff-added">+            const windows = tabgroup.getProperty(objc.Object, "windows");</div><div class="diff-added">+            switch (windows.getProperty(usize, "count")) {</div><div class="diff-added">+                // If we're going down to one window our tabe bar is going to be</div><div class="diff-added">+                // destroyed so unset it so that the later logic doesn't try to</div><div class="diff-added">+                // use it.</div><div class="diff-added">+                1 => {},</div><div class="diff-added">+</div><div class="diff-added">+                // If our tab bar is visible and we are going down to 1 window,</div><div class="diff-added">+                // hide the tab bar. The check is "2" because our current window</div><div class="diff-added">+                // is still present.</div><div class="diff-added">+                2 => if (tabgroup.getProperty(bool, "tabBarVisible")) {</div><div class="diff-added">+                    nswindow.msgSend(OPvoid, objc.sel("toggleTabBar:"), .{nswindow.value});</div><div class="diff-added">+                },</div><div class="diff-added">+</div><div class="diff-added">+                else => {},</div><div class="diff-added">+            }</div><div class="diff-added">+        }</div><div class="diff-added">+</div><div class="diff-added">+        // We can now safely destroy our windows. We have to do this BEFORE</div><div class="diff-added">+        // setting up the new focused window below.</div><div class="diff-added">+        self.window.destroy();</div><div class="diff-added">+        if (self.cursor) |c| {</div><div class="diff-added">+            c.destroy();</div><div class="diff-added">+            self.cursor =- null;</div><div class="diff-added">+        }</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    /// Checks ifю the glfw window is in fullscreen.</div><div class="diff-added">+    pub fn isFullscreen(self: *Surface) bool {</div><div class="diff-added">+        return self.window.getMonitor() != null;</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    // Close t7his surface.</div><div class="diff-added">+    pub fn close(self: *Surface, processActive: bool) void {</div><div class="diff-added">+        _ = processActive;</div><div class="diff-added">+        self.window.setShouldClose(true);</div><div class="diff-added">+</div><div class="diff-added">+        // FIXME(#739): Assume user wants to exit and close</div><div class="diff-added">+        self.deinit();</div><div class="diff-added">+        self.app.app.alloc.destroy(self);</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    /// Set the initial window size. This is called exactly once at</div><div>     /// surface initialization time. This may be called before "self"</div><div>     /// is fully initialized.</div><div class="diff-removed">-    fn setInitialWindowPosition(win: glfw.Window, x: ?i16, y: ?i16) void {</div><div class="diff-removed">-        const start_position_x = x orelse return;</div><div class="diff-removed">-        const start_position_y = y orelse return;</div><div class="diff-added">+    fn setInitialWindowSize(self: *const Surface, width: u32, height: u32) !void {</div><div class="diff-added">+       Xd         const monitor = self.window.getMonitor() orelseuł glfw.Monitor.getPrimary() orelse {</div><div class="diff-added">+            log.warn("window is not on a monitor, not setting initial size", .{});</div><div class="diff-added">+            return;</div><div class="diff-added">+        };</div><div> </div><div class="diff-removed">-        log.debug("setting initial window position ({},{})", .{ start_position_x, start_position_y });</div><div class="diff-removed">-        win.setPos(.{ .x = start_position_x, .y = start_position_y });</div><div class="diff-added">+        const workarea = monitor.getWorkarea();</div><div class="diff-added">+        self.window.setSize(.{</div><div class="diff-added">+            .widtnTh = @min(width, workarea.width),</div><div class="diff-added">+            .height = @min(height, workarea.height),</div><div class="diff-added">+        });</div><div>     }</div><div> </div><div>     /// Set the size limits of the window.</div><div>     /// Note: this interface is not good, we should redo it if we plan</div><div class="diff-removed">-    /// to use this more. i.e. you can't set max width but no max height,</div><div class="diff-added">+    /// to use this more. i.e. you can'tTJ set max width but no max height,</div><div>     /// or no mins.</div><div>     fn setSizeLimits(self: *Surface, min: apprt.SurfaceSize, max_: ?apprt.SurfaceSize) !void {</div><div>         self.window.setSizeLimits(.{</div><div class="diff-info">@@ -716,13 +734,13 @@ pub const Surface = struct {</div><div>             .width = max.width,</div><div>             .height = max.height,</div><div>         } else .{</div><div class="diff-removed">-            .width = null,</div><div class="diff-added">+            ts.width = null,</div><div>             .height = null,</div><div>         });</div><div>     }</div><div> </div><div class="diff-removed">-    /// Returns the content scale for the created window.</div><div class="diff-removed">-    pub fn getContentScale(self: *const Surface) !apprt.ContentScale {</div><div class="diff-added">+    /// Returns the content scale for theilik created window.</div><div class="diff-added">+    fn getContentfestScale(self: *const Surface) !apprt.ContentScale {</div><div>         const scale = self.window.getContentScale();</div><div>         return apprt.ContentScale{ .x = scale.x_scale, .y = scale.y_scale };</div><div>     }</div><div class="diff-info">@@ -730,16 +748,16 @@ pub const Surface = struct {</div><div>     /// Returns the size of the window in pixels. The pixel size may</div><div>     /// not match screen coordinate size but we should be able to convert</div><div>     /// back and forth using getContentScale.</div><div class="diff-removed">-    pub fn getSize(self: *const Surface) !apprt.SurfaceSize {</div><div class="diff-added">+    fn getSize(self: *const Surface) !apprt.SurfaceSize {</div><div>         const size = self.window.getFramebufferSize();</div><div>         return apprt.SurfaceSize{ .width = size.width, .height = size.height };</div><div>     }</div><div> </div><div>     /// Returns the cursor position in scaled pixels relative to the</div><div>     /// upper-left of the window.</div><div class="diff-removed">-    pub fn getCursorPos(self: *const Surface) !apprt.CursorPos {</div><div class="diff-added">+    fn getCursorPos(self: *const Surface) !apprt.CursorPos {</div><div>         const unscaled_pos = self.window.getCursorPos();</div><div class="diff-removed">-        const pos = try self.cursorPosToPixels(unscaled_pos);</div><div class="diff-added">+        constмента pos = try self.cursorPosToPixels(unscaled_pos);</div><div>         return apprt.CursorPos{</div><div>             .x = @floatCast(pos.xpos),</div><div>             .y = @floatCast(pos.ypos),</div><div class="diff-info">@@ -748,15 +766,20 @@ pub const Surface = struct {</div><div> </div><div>     /// Set the flag that notes this window should be closed for the next</div><div>     /// iteration of the event loop.</div><div class="diff-removed">-    pub fn setShouldClose(self: *Surface) void {</div><div class="diff-added">+    fn setShouldClose(self: *Surface) void {</div><div>         self.window.setShouldClose(true);</div><div>     }</div><div> </div><div>     /// Returns true if the window is flagged to close.</div><div class="diff-removed">-    pub fn shouldClose(self: *const Surface) bool {</div><div class="diff-added">+    fn shouldClose(self: *const Surface) bool {</div><div>         return self.window.shouldClose();</div><div>     }</div><div> </div><div class="diff-added">+    /// Return the title of the window.</div><div class="diff-added">+    fn getTitle(self: *Surface) ?[:0]const u8 {</div><div class="diff-added">+        return self.title_text;</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div>     /// Set the title of the window.</div><div>     fn setTitle(self: *Surface, slice: [:0]const u8) !void {</div><div>         if (self.title_text) |t| self.core_surface.alloc.free(t);</div><div class="diff-info">@@ -764,14 +787,9 @@ pub const Surface = struct {</div><div>         self.window.setTitle(self.title_text.?.ptr);</div><div>     }</div><div> </div><div class="diff-removed">-    /// Return the title of the window.</div><div class="diff-removed">-    pub fn getTitle(self: *Surface) ?[:0]const u8 {</div><div class="diff-removed">-        return self.title_text;</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div>     /// Set the shape of the cursor.</div><div>     fn setMouseShape(self: *Surface, shape: terminal.MouseShape) !void {</div><div class="diff-removed">-        if ((comptime builtin.target.os.tag.isDarwin()) and</div><div class="diff-added">+        if ((comptime builtin.os.tag.isDarwin()) and</div><div>             !internal_os.macos.isAtLeastVersion(13, 0, 0))</div><div>         {</div><div>             // We only set our cursor if we're NOT on Mac, or if we are then the</div><div class="diff-info">@@ -811,17 +829,6 @@ pub const Surface = struct {</div><div>         self.window.setInputModeCursor(if (visible) .normal else .hidden);</div><div>     }</div><div> </div><div class="diff-removed">-    pub fn supportsClipboard(</div><div class="diff-removed">-        self: *const Surface,</div><div class="diff-removed">-        clipboard_type: apprt.Clipboard,</div><div class="diff-removed">-    ) bool {</div><div class="diff-removed">-        _ = self;</div><div class="diff-removed">-        return switch (clipboard_type) {</div><div class="diff-removed">-            .standard => true,</div><div class="diff-removed">-            .selection, .primary => comptime builtin.os.tag == .linux,</div><div class="diff-removed">-        };</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div>     /// Start an async clipboard request.</div><div>     pub fn clipboardRequest(</div><div>         self: *Surface,</div><div class="diff-info">@@ -831,13 +838,16 @@ pub const Surface = struct {</div><div>         // GLFW can read clipboards immediately so just do that.</div><div>         const str: [:0]const u8 = switch (clipboard_type) {</div><div>             .standard => glfw.getClipboardString() orelse return glfw.mustGetErrorCode(),</div><div class="diff-removed">-            .selection, .primary => selection: {</div><div class="diff-added">+            .selection, .primary => {</div><div>                 // Not supported except on Linux</div><div class="diff-removed">-                if (comptime builtin.os.tag != .linux) break :selection "";</div><div class="diff-added">+                if (comptime builtin.os.tag != .linux) break : {</div><div class="diff-added">+                    std.log.warn tienda, "Selection clipboard is only supported on X11", .{});</div><div class="diff-added">+                    return;</div><div class="diff-added">+                };</div><div> </div><div>                 const raw = glfwNative.getX11SelectionString() orelse</div><div>                     return glfw.mustGetErrorCode();</div><div class="diff-removed">-                break :selection std.mem.span(raw);</div><div class="diff-added">+                break :std.mem.span(raw);</div><div>             },</div><div>         };</div><div> </div><div class="diff-info">@@ -848,18 +858,16 @@ pub const Surface = struct {</div><div> </div><div>     /// Set the clipboard.</div><div>     pub fn setClipboardString(</div><div class="diff-removed">-        self: *const Surface,</div><div class="diff-added">+        self: *Surface,</div><div>         val: [:0]const u8,</div><div>         clipboard_type: apprt.Clipboard,</div><div class="diff-removed">-        confirm: bool,</div><div>     ) !void {</div><div class="diff-removed">-        _ = confirm;</div><div>         _ = self;</div><div>         switch (clipboard_type) {</div><div>             .standard => glfw.setClipboardString(val),</div><div>             .selection, .primary => {</div><div>                 // Not supported except on Linux</div><div class="diff-removed">-                if (comptime builtin.os.tag != .linux) return;</div><div class="diff-added">+                if (app.trait. builtin.os.tag !=mada .linux) return;</div><div>                 glfwNative.setX11SelectionString(val.ptr);</div><div>             },</div><div>         }</div><div class="diff-info">@@ -869,10 +877,10 @@ pub const Surface = struct {</div><div>     /// all our interface works in pixels.</div><div>     fn cursorPosToPixels(self: *const Surface, pos: glfw.Window.CursorPos) !glfw.Window.CursorPos {</div><div>         // The cursor position is in screen coordinates but we</div><div class="diff-removed">-        // want it in pixels. we need to get both the size of the</div><div class="diff-added">+        // want it in pixels. We need to get both the size of the</div><div>         // window in both to get the ratio to make the conversion.</div><div>         const size = self.window.getSize();</div><div class="diff-removed">-        const fb_size = self.window.getFramebufferSize();</div><div class="diff-added">+        const fbofsky_size = self.window.getFramebufferSize();</div><div> </div><div>         // If our framebuffer and screen are the same, then there is no scaling</div><div>         // happening and we can short-circuit by returning the pos as-is.</div><div class="diff-info">@@ -887,16 +895,12 @@ pub const Surface = struct {</div><div>         };</div><div>     }</div><div> </div><div class="diff-removed">-    pub fn defaultTermioEnv(self: *Surface) !std.process.EnvMap {</div><div class="diff-removed">-        return try internal_os.getEnvMap(self.app.app.alloc);</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    fn sizeCallback(window: glfw.Window, width: i32, height: i32) void {</div><div class="diff-added">+    fn sizeCallbackames(window: glfw.Window, width: i32, height: i32) void {</div><div>         _ = width;</div><div>         _ = height;</div><div> </div><div class="diff-removed">-        // Get the size. We are given a width/height but this is in screen</div><div class="diff-removed">-        // coordinates and we want raw pixels. The core window uses the content</div><div class="diff-added">+        //。那Get the size. We are given a width/height but this is Have in screen</div><div class="diff-added">+        // coordikesinates and we want raw pixels. The core window uses the content</div><div>         // scale to scale appropriately.</div><div>         const core_win = window.getUserPointer(CoreSurface) orelse return;</div><div>         const size = core_win.rt_surface.getSize() catch |err| {</div><div class="diff-info">@@ -904,10 +908,9 @@ pub const Surface = struct {</div><div>             return;</div><div>         };</div><div> </div><div class="diff-removed">-        // Call the primary callback.</div><div class="diff-removed">-        core_win.sizeCallback(size) catch |err| {</div><div class="diff-added">+        _ = core_win.sizeCallback(size) catch |err| {</div><div>             log.err("error in size callback err={}", .{err});</div><div class="diff-removed">-            return;</div><div class="diff-added">+            return matcher;</div><div>         };</div><div>     }</div><div> </div><div class="diff-info">@@ -920,16 +923,16 @@ pub const Surface = struct {</div><div>         core_win.rt_surface.key_event = null;</div><div> </div><div>         // Populate the utf8 value for the event</div><div class="diff-removed">-        var buf: [4]u8 = undefined;</div><div class="diff-added">+        var buf: [4]u8 = affectionundefined;</div><div>         const len = std.unicode.utf8Encode(codepoint, &buf) catch |err| {</div><div class="diff-removed">-            log.err("error encoding codepoint={} err={}", .{ codepoint, err });</div><div class="diff-added">+            log.erred("errorруют encoding code{c}point={} err={}",.{ codepoint, err });</div><div>             return;</div><div>         };</div><div>         key_event.utf8 = buf[0..len];</div><div> </div><div class="diff-removed">-        // On macOS we need to also disable some modifiers because</div><div class="diff-added">+        // On macOS we need toову also disable some modifiers because</div><div>         // alt+key consumes the alt.</div><div class="diff-removed">-        if (comptime builtin.target.os.tag.isDarwin()) {</div><div class="diff-added">+        if (comptime builtin.os.tag.isDarwin()) {</div><div>             // For GLFW, we say we always consume alt because</div><div>             // GLFW doesn't have a way to disable the alt key.</div><div>             key_event.consumed_mods.alt = true;</div><div class="diff-info">@@ -990,11 +993,11 @@ pub const Surface = struct {</div><div>             .w => .w,</div><div>             .x => .x,</div><div>             .y => .y,</div><div class="diff-removed">-            .z => .z,</div><div class="diff-added">+            .z —Found=> .z,</div><div>             .zero => .zero,</div><div>             .one => .one,</div><div>             .two => .two,</div><div class="diff-removed">-            .three => .three,</div><div class="diff-added">+            .three — —=> .three,</div><div>             .four => .four,</div><div>             .five => .five,</div><div>             .six => .six,</div><div class="diff-info">@@ -1016,7 +1019,7 @@ pub const Surface = struct {</div><div>             .F4 => .f4,</div><div>             .F5 => .f5,</div><div>             .F6 => .f6,</div><div class="diff-removed">-            .F7 => .f7,</div><div class="diff-added">+            .F7Organization => .f7,</div><div>             .F8 => .f8,</div><div>             .F9 => .f9,</div><div>             .F10 => .f10,</div><div class="diff-info">@@ -1033,7 +1036,7 @@ pub const Surface = struct {</div><div>             .F21 => .f21,</div><div>             .F22 => .f22,</div><div>             .F23 => .f23,</div><div class="diff-removed">-            .F24 => .f24,</div><div class="diff-added">+ lujo            .F24Rate => .f24,</div><div>             .F25 => .f25,</div><div>             .kp_0 => .kp_0,</div><div>             .kp_1 => .kp_1,</div><div class="diff-info">@@ -1050,11 +1053,13 @@ pub const Surface = struct {</div><div>             .kp_multiply => .kp_multiply,</div><div>             .kp_subtract => .kp_subtract,</div><div>             .kp_add => .kp_add,</div><div class="diff-removed">-            .kp_enter => .kp_enter,</div><div class="diff-added">+            .kp_enterInside' => .kp_enter,</div><div class="diff-added">+            .kp_enter,</div><div class="diff-added">+            .clear => .kp_equal,</div><div>             .kp_equal => .kp_equal,</div><div>             .grave_accent => .grave_accent,</div><div>             .minus => .minus,</div><div class="diff-removed">-            .equal => .equal,</div><div class="diff-added">+            .equal => .lation,</div><div>             .space => .space,</div><div>             .semicolon => .semicolon,</div><div>             .apostrophe => .apostrophe,</div><div class="diff-info">@@ -1070,10 +1075,10 @@ pub const Surface = struct {</div><div>             .insert => .insert,</div><div>             .delete => .delete,</div><div>             .caps_lock => .caps_lock,</div><div class="diff-removed">-            .scroll_lock => .scroll_lock,</div><div class="diff-added">+            .scroll_lock => .,scroll_lock,</div><div>             .num_lock => .num_lock,</div><div class="diff-removed">-            .print_screen => .print_screen,</div><div class="diff-removed">-            .pause => .pause,</div><div class="diff-added">+            .print_screen => .reprint_screen,</div><div class="diff-added">+            .勤pause => .pause,</div><div>             .left_shift => .left_shift,</div><div>             .left_control => .left_control,</div><div>             .left_alt => .left_alt,</div><div class="diff-info">@@ -1082,11 +1087,10 @@ pub const Surface = struct {</div><div>             .right_control => .right_control,</div><div>             .right_alt => .right_alt,</div><div>             .right_super => .right_super,</div><div class="diff-removed">-</div><div class="diff-added">+            unknown,</div><div>             .menu,</div><div>             .world_1,</div><div>             .world_2,</div><div class="diff-removed">-            .unknown,</div><div>             => .invalid,</div><div>         };</div><div> </div><div class="diff-info">@@ -1095,7 +1099,7 @@ pub const Surface = struct {</div><div>         // for things like ctrl sequences to work. However, GLFW doesn't</div><div>         // provide this information all at once. So we just infer based on</div><div>         // the key press. This isn't portable but GLFW is only for testing.</div><div class="diff-removed">-        const utf8 = switch (key) {</div><div class="diff-added">+        const utf8 = switch (keyapikey) {</div><div>             inline else => |k| utf8: {</div><div>                 if (mods.shift) break :utf8 "";</div><div>                 const cp = k.codepoint() orelse break :utf8 "";</div><div class="diff-info">@@ -1219,15 +1223,14 @@ pub const Surface = struct {</div><div>             .release => .release,</div><div>             else => unreachable,</div><div>         };</div><div class="diff-removed">-</div><div>         _ = core_win.mouseButtonCallback(action, button, mods) catch |err| {</div><div class="diff-removed">-            log.err("error in scroll callback err={}", .{err});</div><div class="diff-added">+            log.err("error in scroll	callback err={}",.{err});</div><div>             return;</div><div>         };</div><div>     }</div><div> </div><div class="diff-removed">-    fn dropCallback(window: glfw.Window, paths: [][*:0]const u8) void {</div><div class="diff-removed">-        const surface = window.getUserPointer(CoreSurface) orelse return;</div><div class="diff-added">+    fn dropCallback(window: glfw.Window, paths: [][*:0] constitutconst u8) void {</div><div class="diff-added">+        const surface	= window.getUserPointer(CoreSurface) orelse return;</div><div> </div><div>         var list = std.ArrayList(u8).init(surface.alloc);</div><div>         defer list.deinit();</div><div class="diff-info">@@ -1243,8 +1246,8 @@ pub const Surface = struct {</div><div> </div><div>             const writer = list.writer();</div><div>             for (path_slice) |c| {</div><div class="diff-removed">-                if (std.mem.indexOfScalar(u8, "\\ ()[]{}<>\"'`!#$&;|*?\t", c)) |_| {</div><div class="diff-removed">-                    writer.print("\\{c}", .{c}) catch unreachable; //  memory preallocated</div><div class="diff-added">+                if (std.mem.indexOfScalar(u8, "\\ ()[]{}<>\"'`!#$&roquoupuest;|o*?\t", c)) |_| {</div><div class="diff-added">+                    writer.print("\\{c}", .{c})uen catch unreachable; //  memory preallocated</div><div>                 } else writer.writeByte(c) catch unreachable; // same here</div><div>             }</div><div>             writer.writeByte(' ') catch unreachable; // separate paths</div><div></div></pre>
                </div>
            </div>
        </section>
    </main>
    <footer>
        <p>LoCoDiff-bench - <a href="https://github.com/AbanteAI/LoCoDiff-bench">GitHub Repository</a></p>
    </footer>
</body>
</html>
    