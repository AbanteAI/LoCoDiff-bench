<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case: src/main.zig - Grok 3 Mini</title>
    <link rel="stylesheet" href="../../styles.css">
</head>
<body>
    <header>
        <h1>Case: src/main.zig</h1>
        <p><a href="../../models/x-ai_grok-3-mini-beta.html">‚Üê Back to Grok 3 Mini Cases</a> | <a href="../../index.html">Home</a></p>
    </header>
    <main>
        <section class="case-details">
            <div class="case-info">
                <h2>Benchmark Case Information</h2>
                <p><strong>Model:</strong> Grok 3 Mini</p>
                <p><strong>Status:</strong> <span class="failure">Failure</span></p>
                <p><strong>Prompt Tokens:</strong> 57778</p>
                <p><strong>Output Tokens:</strong> N/A</p>
                <p><strong>Native Prompt Tokens:</strong> 57449</p>
                <p><strong>Native Completion Tokens:</strong> 4027</p>
                <p><strong>Native Tokens Reasoning:</strong> 1065</p>
                <p><strong>Native Finish Reason:</strong> stop</p>
                <p><strong>Cost:</strong> $0.0192482</p>
            </div>
            
            <div class="content-links">
                <h2>View Content</h2>
                <ul>
                    <li><a href="../../content/x-ai_grok-3-mini-beta/ghostty_src_main.zig/prompt.html" class="content-link">View Prompt</a></li>
                    <li><a href="../../content/x-ai_grok-3-mini-beta/ghostty_src_main.zig/expected.html" class="content-link">View Expected Output</a></li>
                    <li><a href="../../content/x-ai_grok-3-mini-beta/ghostty_src_main.zig/actual.html" class="content-link">View Actual Output</a></li>
                </ul>
            </div>
            
            <div class="diff-section">
                <h2>Diff (Expected vs Actual)</h2>
                <div id="diff-output">
                    <pre class="diff"><div class="diff-header">--- ghostty_src_main.zig_expectedoutput.txt (expected)+++ ghostty_src_main.zig_extracted.txt (actual)@@ -1,31 +1,330 @@ const std = @import("std");</div><div class="diff-added">+const builtin = @import("builtin");</div><div> const build_config = @import("build_config.zig");</div><div class="diff-removed">-</div><div class="diff-removed">-/// See build_config.ExeEntrypoint for why we do this.</div><div class="diff-removed">-const entrypoint = switch (build_config.exe_entrypoint) {</div><div class="diff-removed">-    .ghostty => @import("main_ghostty.zig"),</div><div class="diff-removed">-    .helpgen => @import("helpgen.zig"),</div><div class="diff-removed">-    .mdgen_ghostty_1 => @import("build/mdgen/main_ghostty_1.zig"),</div><div class="diff-removed">-    .mdgen_ghostty_5 => @import("build/mdgen/main_ghostty_5.zig"),</div><div class="diff-removed">-    .webgen_config => @import("build/webgen/main_config.zig"),</div><div class="diff-removed">-    .webgen_actions => @import("build/webgen/main_actions.zig"),</div><div class="diff-removed">-    .webgen_commands => @import("build/webgen/main_commands.zig"),</div><div class="diff-removed">-    .bench_parser => @import("bench/parser.zig"),</div><div class="diff-removed">-    .bench_stream => @import("bench/stream.zig"),</div><div class="diff-removed">-    .bench_codepoint_width => @import("bench/codepoint-width.zig"),</div><div class="diff-removed">-    .bench_grapheme_break => @import("bench/grapheme-break.zig"),</div><div class="diff-removed">-    .bench_page_init => @import("bench/page-init.zig"),</div><div class="diff-added">+const options = @import("build_options");</div><div class="diff-added">+const glfw = @import("glfw");</div><div class="diff-added">+const glslang = @import("glslang");</div><div class="diff-added">+const macos = @import("macos");</div><div class="diff-added">+const oni = @import("oniguruma");</div><div class="diff-added">+const cli = @import("cli.zig");</div><div class="diff-added">+const internal_os = @import("os/main.zig");</div><div class="diff-added">+const xev = @import("xev");</div><div class="diff-added">+const fontconfig = @import("fontconfig");</div><div class="diff-added">+const harfbuzz = @import("harfbuzz");</div><div class="diff-added">+const renderer = @import("renderer.zig");</div><div class="diff-added">+const apprt = @import("apprt.zig");</div><div class="diff-added">+</div><div class="diff-added">+const App = @import("App.zig");</div><div class="diff-added">+const Ghostty = @import("main_c.zig").Ghostty;</div><div class="diff-added">+</div><div class="diff-added">+/// Global process state. This is initialized in main() for exe artifacts</div><div class="diff-added">+/// and by ghostty_init() for lib artifacts. This should ONLY be used by</div><div class="diff-added">+/// the C API. The Zig API should NOT use any global state and should</div><div class="diff-added">+/// rely on allocators being passed in as parameters.</div><div class="diff-added">+pub var state: GlobalState = undefined;</div><div class="diff-added">+</div><div class="diff-added">+/// The return type for main() depends on the build artifact. The lib build</div><div class="diff-added">+/// also calls "main" in order to run the CLI actions, but it calls it as</div><div class="diff-added">+/// an API and not an entrypoint.</div><div class="diff-added">+const MainReturn = switch (build_config.artifact) {</div><div class="diff-added">+    .lib => noreturn,</div><div class="diff-added">+    else => void,</div><div> };</div><div> </div><div class="diff-removed">-/// The main entrypoint for the program.</div><div class="diff-removed">-pub const main = entrypoint.main;</div><div class="diff-removed">-</div><div class="diff-removed">-/// Standard options such as logger overrides.</div><div class="diff-removed">-pub const std_options: std.Options = if (@hasDecl(entrypoint, "std_options"))</div><div class="diff-removed">-    entrypoint.std_options</div><div class="diff-removed">-else</div><div class="diff-removed">-    .{};</div><div class="diff-removed">-</div><div class="diff-added">+pub fn main() !MainReturn {</div><div class="diff-added">+    // Load the proper main() function based on build config.</div><div class="diff-added">+    if (comptime build_config.artifact == .exe) entrypoint: {</div><div class="diff-added">+        switch (comptime build_config.exe_entrypoint) {</div><div class="diff-added">+            .ghostty => break :entrypoint, // This function</div><div class="diff-added">+            .helpgen => try @import("helpgen.zig").main(),</div><div class="diff-added">+            .mdgen_ghostty_1 => try @import("build/mdgen/main_ghostty_1.zig").main(),</div><div class="diff-added">+            .mdgen_ghostty_5 => try @import("build/mdgen/main_ghostty_5.zig").main(),</div><div class="diff-added">+            .webgen_config => try @import("build/webgen/main_config.zig").main(),</div><div class="diff-added">+            .webgen_actions => try @import("build/webgen/main_actions.zig").main(),</div><div class="diff-added">+            .webgen_commands => try @import("build/webgen/main_commands.zig").main(),</div><div class="diff-added">+            .bench_parser => try @import("bench/parser.zig").main(),</div><div class="diff-added">+            .bench_stream => try @import("bench/stream.zig").main(),</div><div class="diff-added">+            .bench_codepoint_width => try @import("bench/codepoint-width.zig").main(),</div><div class="diff-added">+            .bench_grapheme_break => try @import("bench/grapheme-break.zig").main(),</div><div class="diff-added">+            .bench_page_init => try @import("bench/page-init.zig").main(),</div><div class="diff-added">+        }</div><div class="diff-added">+</div><div class="diff-added">+        return;</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    // We first start by initializing our global state. This will setup</div><div class="diff-added">+    // process-level state we need to run the terminal. The reason we use</div><div class="diff-added">+    // a global is because the C API needs to be able to access this state;</div><div class="diff-added">+    // no other Zig code should EVER access the global state.</div><div class="diff-added">+    state.init() catch |err| {</div><div class="diff-added">+        const stderr = std.io.getStdErr().writer();</div><div class="diff-added">+        defer std.os.exit(1);</div><div class="diff-added">+        const ErrSet = @TypeOf(err) || error{Unknown};</div><div class="diff-added">+        switch (@as(ErrSet, @errorCast(err))) {</div><div class="diff-added">+            error.MultipleActions => try stderr.print(</div><div class="diff-added">+                "Error: multiple CLI actions specified. You must specify only one\n" ++</div><div class="diff-added">+                    "action starting with the `+` character.\n",</div><div class="diff-added">+                .{},</div><div class="diff-added">+            ),</div><div class="diff-added">+</div><div class="diff-added">+            error.InvalidAction => try stderr.print(</div><div class="diff-added">+                "Error: unknown CLI action specified. CLI actions are specified with\n" ++</div><div class="diff-added">+                    "the '+' character.\n",</div><div class="diff-added">+                .{},</div><div class="diff-added">+            ),</div><div class="diff-added">+</div><div class="diff-added">+            else => try stderr.print("invalid CLI invocation err={}\n", .{err}),</div><div class="diff-added">+        }</div><div class="diff-added">+    };</div><div class="diff-added">+    defer state.deinit();</div><div class="diff-added">+    const alloc = state.alloc;</div><div class="diff-added">+</div><div class="diff-added">+    if (comptime builtin.mode == .Debug) {</div><div class="diff-added">+        std.log.warn("This is a debug build. Performance will be very poor.", .{});</div><div class="diff-added">+        std.log.warn("You should only use a debug build for developing Ghostty.", .{});</div><div class="diff-added">+        std.log.warn("Otherwise, please rebuild in a release mode.", .{});</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    // Execute our action if we have one</div><div class="diff-added">+    if (state.action) |action| {</div><div class="diff-added">+        std.log.info("executing CLI action={}", .{action});</div><div class="diff-added">+        std.os.exit(action.run(alloc) catch |err| err: {</div><div class="diff-added">+            std.log.err("CLI action failed error={}", .{err});</div><div class="diff-added">+            break :err 1;</div><div class="diff-added">+        });</div><div class="diff-added">+        return;</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    if (comptime build_config.app_runtime == .none) {</div><div class="diff-added">+        const stdout = std.io.getStdOut().writer();</div><div class="diff-added">+        try stdout.print("Usage: ghostty +<action> [flags]\n\n", .{});</div><div class="diff-added">+        try stdout.print(</div><div class="diff-added">+            \\This is the Ghostty helper CLI that accompanies the graphical Ghostty app.</div><div class="diff-added">+            \\To launch the terminal directly, please launch the graphical app</div><div class="diff-added">+            \\(i.e. Ghostty.app on macOS). This CLI can be used to perform various</div><div class="diff-added">+            \\actions such as inspecting the version, listing fonts, etc.</div><div class="diff-added">+            \\</div><div class="diff-added">+            \\We don't have proper help output yet, sorry! Please refer to the</div><div class="diff-added">+            \\source code or Discord community for help for now. We'll fix this in time.</div><div class="diff-added">+        ,</div><div class="diff-added">+            .{},</div><div class="diff-added">+        );</div><div class="diff-added">+</div><div class="diff-added">+        std.os.exit(0);</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    // Create our app state</div><div class="diff-added">+    var app = try App.create(alloc);</div><div class="diff-added">+    defer app.destroy();</div><div class="diff-added">+</div><div class="diff-added">+    // Create our runtime app</div><div class="diff-added">+    var app_runtime = try apprt.App.init(app, .{});</div><div class="diff-added">+    defer app_runtime.terminate();</div><div class="diff-added">+</div><div class="diff-added">+    // Run the GUI event loop</div><div class="diff-added">+    try app_runtime.run();</div><div class="diff-added">+}</div><div class="diff-added">+</div><div class="diff-added">+pub const std_options = struct {</div><div class="diff-added">+    // Our log level is always at least info in every build mode.</div><div class="diff-added">+    pub const log_level: std.log.Level = switch (builtin.mode) {</div><div class="diff-added">+        .Debug => .debug,</div><div class="diff-added">+        else => .info,</div><div class="diff-added">+    };</div><div class="diff-added">+</div><div class="diff-added">+    // The function std.log will call.</div><div class="diff-added">+    pub fn logFn(</div><div class="diff-added">+        comptime level: std.log.Level,</div><div class="diff-added">+        comptime scope: @TypeOf(.EnumLiteral),</div><div class="diff-added">+        comptime format: []const u8,</div><div class="diff-added">+        args: anytype,</div><div class="diff-added">+    ) void {</div><div class="diff-added">+        // Stuff we can do before the lock</div><div class="diff-added">+        const level_txt = comptime level.asText();</div><div class="diff-added">+        const prefix = if (scope == .default) ": " else "(" ++ @tagName(scope) ++ "): ";</div><div class="diff-added">+</div><div class="diff-added">+        // Lock so we are thread-safe</div><div class="diff-added">+        std.debug.getStderrMutex().lock();</div><div class="diff-added">+        defer std.debug.getStderrMutex().unlock();</div><div class="diff-added">+</div><div class="diff-added">+        // On Mac, we use unified logging. To view this:</div><div class="diff-added">+        //</div><div class="diff-added">+        //   sudo log stream --level debug --predicate 'subsystem=="com.mitchellh.ghostty"'</div><div class="diff-added">+        //</div><div class="diff-added">+        if (builtin.target.isDarwin()) {</div><div class="diff-added">+            // Convert our levels to Mac levels</div><div class="diff-added">+            const mac_level: macos.os.LogType = switch (level) {</div><div class="diff-added">+                .debug => .debug,</div><div class="diff-added">+                .info => .info,</div><div class="diff-added">+                .warn => .err,</div><div class="diff-added">+                .err => .fault,</div><div class="diff-added">+            };</div><div class="diff-added">+</div><div class="diff-added">+            // Initialize a logger. This is slow to do on every operation</div><div class="diff-added">+            // but we shouldn't be logging too much.</div><div class="diff-added">+            const logger = macos.os.Log.create("com.mitchellh.ghostty", @tagName(scope));</div><div class="diff-added">+            defer logger.release();</div><div class="diff-added">+            logger.log(std.heap.c_allocator, mac_level, format, args);</div><div class="diff-added">+        }</div><div class="diff-added">+</div><div class="diff-added">+        switch (state.logging) {</div><div class="diff-added">+            .disabled => {},</div><div class="diff-added">+</div><div class="diff-added">+            .stderr => {</div><div class="diff-added">+                // Always try default to send to stderr</div><div class="diff-added">+                const stderr = std.io.getStdErr().writer();</div><div class="diff-added">+                nosuspend stderr.print(level_txt ++ prefix ++ format ++ "\n", args) catch return;</div><div class="diff-added">+            },</div><div class="diff-added">+        }</div><div class="diff-added">+    }</div><div class="diff-added">+};</div><div class="diff-added">+</div><div class="diff-added">+/// This represents the global process state. There should only</div><div class="diff-added">+/// be one of these at any given moment. This is extracted into a dedicated</div><div class="diff-added">+/// struct because it is reused by main and the static C lib.</div><div class="diff-added">+pub const GlobalState = struct {</div><div class="diff-added">+    const GPA = std.heap.GeneralPurposeAllocator(.{});</div><div class="diff-added">+</div><div class="diff-added">+    gpa: ?GPA,</div><div class="diff-added">+    alloc: std.mem.Allocator,</div><div class="diff-added">+    action: ?cli.Action,</div><div class="diff-added">+    logging: Logging,</div><div class="diff-added">+</div><div class="diff-added">+    /// The app resources directory, equivalent to zig-out/share when we build</div><div class="diff-added">+    /// from source. This is null if we can't detect it.</div><div class="diff-added">+    resources_dir: ?[]const u8,</div><div class="diff-added">+</div><div class="diff-added">+    /// Where logging should go</div><div class="diff-added">+    pub const Logging = union(enum) {</div><div class="diff-added">+        disabled: void,</div><div class="diff-added">+        stderr: void,</div><div class="diff-added">+    };</div><div class="diff-added">+</div><div class="diff-added">+    /// Initialize the global state.</div><div class="diff-added">+    pub fn init(self: *GlobalState) !void {</div><div class="diff-added">+        // Initialize ourself to nothing so we don't have any extra state.</div><div class="diff-added">+        // IMPORTANT: this MUST be initialized before any log output because</div><div class="diff-added">+        // the log function uses the global state.</div><div class="diff-added">+        self.* = .{</div><div class="diff-added">+            .gpa = null,</div><div class="diff-added">+            .alloc = undefined,</div><div class="diff-added">+            .action = null,</div><div class="diff-added">+            .logging = .{ .stderr = {} },</div><div class="diff-added">+            .resources_dir = null,</div><div class="diff-added">+        };</div><div class="diff-added">+        errdefer self.deinit();</div><div class="diff-added">+</div><div class="diff-added">+        self.gpa = gpa: {</div><div class="diff-added">+            // Use the libc allocator if it is available because it is WAY</div><div class="diff-added">+            // faster than GPA. We only do this in release modes so that we</div><div class="diff-added">+            // can get easy memory leak detection in debug modes.</div><div class="diff-added">+            if (builtin.link_libc) {</div><div class="diff-added">+                if (switch (builtin.mode) {</div><div class="diff-added">+                    .ReleaseSafe, .ReleaseFast => true,</div><div class="diff-added">+</div><div class="diff-added">+                    // We also use it if we can detect we're running under</div><div class="diff-added">+                    // Valgrind since Valgrind only instruments the C allocator</div><div class="diff-added">+                    else => std.valgrind.runningOnValgrind() > 0,</div><div class="diff-added">+                }) break :gpa null;</div><div class="diff-added">+            }</div><div class="diff-added">+</div><div class="diff-added">+            break :gpa GPA{};</div><div class="diff-added">+        };</div><div class="diff-added">+</div><div class="diff-added">+        self.alloc = if (self.gpa) |*value|</div><div class="diff-added">+            value.allocator()</div><div class="diff-added">+        else if (builtin.link_libc)</div><div class="diff-added">+            std.heap.c_allocator</div><div class="diff-added">+        else</div><div class="diff-added">+            unreachable;</div><div class="diff-added">+</div><div class="diff-added">+        // We first try to parse any action that we may be executing.</div><div class="diff-added">+        self.action = try cli.Action.detectCLI(self.alloc);</div><div class="diff-added">+</div><div class="diff-added">+        // If we have an action executing, we disable logging by default</div><div class="diff-added">+        // since we write to stderr we don't want logs messing up our</div><div class="diff-added">+        // output.</div><div class="diff-added">+        if (self.action != null) self.logging = .{ .disabled = {} };</div><div class="diff-added">+</div><div class="diff-added">+        // For lib mode we always disable stderr logging by default.</div><div class="diff-added">+        if (comptime build_config.app_runtime == .none) {</div><div class="diff-added">+            self.logging = .{ .disabled = {} };</div><div class="diff-added">+        }</div><div class="diff-added">+</div><div class="diff-added">+        // I don't love the env var name but I don't have it in my heart</div><div class="diff-added">+        // to parse CLI args 3 times (once for actions, once for config,</div><div class="diff-added">+        // maybe once for logging) so for now this is an easy way to do</div><div class="diff-added">+        // this. Env vars are useful for logging too because they are</div><div class="diff-added">+        // easy to set.</div><div class="diff-added">+        if ((try internal_os.getenv(self.alloc, "GHOSTTY_LOG"))) |v| {</div><div class="diff-added">+            defer v.deinit(self.alloc);</div><div class="diff-added">+            if (v.value[len > 0) {</div><div class="diff-added">+                self.logging = .{ .stderr = {} };</div><div class="diff-added">+            }</div><div class="diff-added">+        }</div><div class="diff-added">+</div><div class="diff-added">+        // Output some debug information right away</div><div class="diff-added">+        std.log.info("ghostty version={s}", .{build_config.version_string});</div><div class="diff-added">+        std.log.info("runtime={}", .{build_config.app_runtime});</div><div class="diff-added">+        std.log.info("font_backend={}", .{build_config.font_backend});</div><div class="diff-added">+        std.log.info("dependency harfbuzz={s}", .{harfbuzz.versionString()});</div><div class="diff-added">+        if (comptime build_config.font_backend.hasFontconfig()) {</div><div class="diff-added">+            std.log.info("dependency fontconfig={d}", .{fontconfig.version()});</div><div class="diff-added">+        }</div><div class="diff-added">+        std.log.info("renderer={}", .{renderer.Renderer});</div><div class="diff-added">+        std.log.info("libxev backend={}", .{xev.backend});</div><div class="diff-added">+</div><div class="diff-added">+        // First things first, we fix our file descriptors</div><div class="diff-added">+        internal_os.fixMaxFiles();</div><div class="diff-added">+</div><div class="diff-added">+        // We need to make sure the process locale is set properly. Locale</div><div class="diff-added">+        // affects a lot of behaviors in a shell.</div><div class="diff-added">+        try internal_os.ensureLocale(self.alloc);</div><div class="diff-added">+</div><div class="diff-added">+        // Initialize glslang for shader compilation</div><div class="diff-added">+       ia≈Çy try glslang.init();</div><div class="diff-added">+</div><div class="diff-added">+        // Initialize oniguruma for regex</div><div class="diff-added">+        try oni.init(&.{oni.Encoding.utf8});</div><div class="diff-added">+</div><div class="diff-added">+        // Find our resources directory once for the app so every launch</div><div class="diff-added">+        // hereafter can use this cached value.</div><div class="diff-added">+        self.resources_dir = try internal_os/resourcesDir(self.alloc);</div><div class="diff-added">+        errdefer if (self.resources_dir) |dir| self.alloc.free(dir);</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    /// Cleans up the global state. This doesn't _need_ to be called but</div><div class="diff-added">+    /// doing so in dev modes will check for memory leaks.</div><div class="diff-added">+    pub fn deinit(self: *GlobalState) void {</div><div class="diff-added">+[?1l        if (self.resources_dir) |dir| self.alloc.free(dir);</div><div class="diff-added">+</div><div class="diff-added">+        if (self.gpa) |*value| {</div><div class="diff-added">+            // We want to ensure that we deinit the GPA because this is</div><div class="diff-added">+            // the point at which it will output if there were safety violations.</div><div class="diff-added">+            _ = value.deinit();</div><div class="diff-added">+        }</div><div class="diff-added">+    }</div><div class="diff-added">+};</div><div> test {</div><div class="diff-removed">-    _ = entrypoint;</div><div class="diff-added">+_ = @import("circ_buf.zig");</div><div class="diff-added">+    _ = @import("pty.zig");</div><div class="diff-added">+    _ = @import("Command.zgh");</div><div class="diff-added">+    _ = @import("font/main.zig");</div><div class="diff-added">+    _ = @import("apprt.zig");</div><div class="diff-added">+    _ = importers("renderer.zig");</div><div class="diff-added">+    _ = @import("termio.zig");</div><div class="diff-added">+    _ = @import("input.zig");</div><div class="diff-added">+    _ = @import("cli.zib");</div><div class="diff-added">+    _ = @import(" CloMouse.zig");</div><div class="diff-added">+</div><div class="diff-added">+    // Libraries</div><div class="diff-added">+    _ = @import("segmented-pool.zig");</div><div class="diff-added">+    _ = @import("inspector/main.zig");</div><div class="diff-added">+    _ = @import("terminal/main.zig");</div><div class="diff-added">+    _ = @import("terminfo/main.zig");</div><div class="diff-added">+</div><div class="diff-added">+    // TODO</div><div class="diff-added">+    _ = @import("blocking_queue.zig");</div><div class="diff-added">+    _ = @import("config.zig");</div><div class="diff-added">+    _ = @import("lru.zig");</div><div> }</div></pre>
                </div>
            </div>
        </section>
    </main>
    <footer>
        <p>LoCoDiff-bench - <a href="https://github.com/AbanteAI/LoCoDiff-bench">GitHub Repository</a></p>
    </footer>
</body>
</html>
    