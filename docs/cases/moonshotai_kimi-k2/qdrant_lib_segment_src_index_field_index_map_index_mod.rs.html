<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case: lib/segment/src/index/field_index/map_index/mod.rs - Kimi K2</title>
    <link rel="stylesheet" href="../../styles.css">
</head>
<body>
    <header>
        <h1>Case: lib/segment/src/index/field_index/map_index/mod.rs</h1>
        <h2>Model: Kimi K2</h2>
        <p><a href="../../models/moonshotai_kimi-k2.html">All Kimi K2 Cases</a> | <a href="../../cases.html">All Cases</a> | <a href="../../index.html">Home</a></p>
    </header>
    <main>
        <section class="case-details">
            <div class="case-info">
                <h2>Benchmark Case Information</h2>
                <p><strong>Model:</strong> Kimi K2</p>
                <p><strong>Status:</strong> <span class="failure">Failure</span></p>
                <p><strong>Prompt Tokens:</strong> 56553</p>
                <p><strong>Native Prompt Tokens:</strong> 56285</p>
                <p><strong>Native Completion Tokens:</strong> 10658</p>
                <p><strong>Native Tokens Reasoning:</strong> 0</p>
                <p><strong>Native Finish Reason:</strong> stop</p>
                <p><strong>Cost:</strong> $0.05659585</p>
            </div>
            
            <div class="content-links">
                <h2>View Content</h2>
                <ul>
                    <li><a href="../../content/moonshotai_kimi-k2/qdrant_lib_segment_src_index_field_index_map_index_mod.rs/prompt.html" class="content-link">View Prompt</a></li>
                    <li><a href="../../content/moonshotai_kimi-k2/qdrant_lib_segment_src_index_field_index_map_index_mod.rs/expected.html" class="content-link">View Expected Output</a></li>
                    <li><a href="../../content/moonshotai_kimi-k2/qdrant_lib_segment_src_index_field_index_map_index_mod.rs/actual.html" class="content-link">View Actual Output</a></li>
                </ul>
            </div>
            
            <div class="diff-section">
                <h2>Diff (Expected vs Actual)</h2>
                <div id="diff-output">
                    <pre class="diff"><div></div><div>index 0a4e2d762..d6265f81a 100644</div><div class="diff-header">--- a/qdrant_lib_segment_src_index_field_index_map_index_mod.rs_expectedoutput.txt (expected):tmp/tmp_xu1ueqp_expected.txt	</div><div class="diff-header">+++ b/qdrant_lib_segment_src_index_field_index_map_index_mod.rs_extracted.txt (actual):tmp/tmpm9p1eoy3_actual.txt	</div><div class="diff-info">@@ -20,13 +20,8 @@ use serde_json::Value;</div><div> use smol_str::SmolStr;</div><div> use uuid::Uuid;</div><div> </div><div class="diff-removed">-use self::immutable_map_index::ImmutableMapIndex;</div><div class="diff-removed">-use self::mutable_map_index::MutableMapIndex;</div><div class="diff-removed">-use super::FieldIndexBuilderTrait;</div><div class="diff-removed">-use super::facet_index::FacetIndex;</div><div class="diff-removed">-use super::mmap_point_to_values::MmapValue;</div><div class="diff-removed">-use crate::common::Flusher;</div><div> use crate::common::operation_error::{OperationError, OperationResult};</div><div class="diff-added">+use crate::common::Flusher;</div><div> use crate::data_types::facets::{FacetHit, FacetValueRef};</div><div> use crate::index::field_index::stat_tools::number_of_selected_points;</div><div> use crate::index::field_index::{</div><div class="diff-info">@@ -83,7 +78,11 @@ pub enum MapIndex<N: MapIndexKey + ?Sized> {</div><div> }</div><div> </div><div> impl<N: MapIndexKey + ?Sized> MapIndex<N> {</div><div class="diff-removed">-    pub fn new_memory(db: Arc<RwLock<DB>>, field_name: &str, is_appendable: bool) -> Self {</div><div class="diff-added">+    pub fn new_memory(</div><div class="diff-added">+        db: Arc<RwLock<DB>>,</div><div class="diff-added">+        field_name: &str,</div><div class="diff-added">+        is_appendable: bool,</div><div class="diff-added">+    ) -> Self {</div><div>         if is_appendable {</div><div>             MapIndex::Mutable(MutableMapIndex::new(db, field_name))</div><div>         } else {</div><div class="diff-info">@@ -122,13 +121,12 @@ impl<N: MapIndexKey + ?Sized> MapIndex<N> {</div><div>     pub fn check_values_any(</div><div>         &self,</div><div>         idx: PointOffsetType,</div><div class="diff-removed">-        hw_counter: &HardwareCounterCell,</div><div>         check_fn: impl Fn(&N) -> bool,</div><div>     ) -> bool {</div><div>         match self {</div><div>             MapIndex::Mutable(index) => index.check_values_any(idx, check_fn),</div><div>             MapIndex::Immutable(index) => index.check_values_any(idx, check_fn),</div><div class="diff-removed">-            MapIndex::Mmap(index) => index.check_values_any(idx, hw_counter, check_fn),</div><div class="diff-added">+            MapIndex::Mmap(index) => index.check_values_any(idx, &HardwareCounterCell::disposable(), check_fn),</div><div>         }</div><div>     }</div><div> </div><div class="diff-info">@@ -155,7 +153,7 @@ impl<N: MapIndexKey + ?Sized> MapIndex<N> {</div><div>         }</div><div>     }</div><div> </div><div class="diff-removed">-    fn get_indexed_points(&self) -> usize {</div><div class="diff-added">+    pub fn get_indexed_points(&self) -> usize {</div><div>         match self {</div><div>             MapIndex::Mutable(index) => index.get_indexed_points(),</div><div>             MapIndex::Immutable(index) => index.get_indexed_points(),</div><div class="diff-info">@@ -163,7 +161,7 @@ impl<N: MapIndexKey + ?Sized> MapIndex<N> {</div><div>         }</div><div>     }</div><div> </div><div class="diff-removed">-    fn get_values_count(&self) -> usize {</div><div class="diff-added">+    pub fn get_values_count(&self) -> usize {</div><div>         match self {</div><div>             MapIndex::Mutable(index) => index.get_values_count(),</div><div>             MapIndex::Immutable(index) => index.get_values_count(),</div><div class="diff-info">@@ -187,7 +185,11 @@ impl<N: MapIndexKey + ?Sized> MapIndex<N> {</div><div>         }</div><div>     }</div><div> </div><div class="diff-removed">-    fn get_iterator(&self, value: &N, hw_counter: &HardwareCounterCell) -> IdRefIter<'_> {</div><div class="diff-added">+    fn get_iterator(</div><div class="diff-added">+        &self,</div><div class="diff-added">+        value: &N,</div><div class="diff-added">+        hw_counter: &HardwareCounterCell,</div><div class="diff-added">+    ) -> IdRefIter<'_> {</div><div>         match self {</div><div>             MapIndex::Mutable(index) => index.get_iterator(value),</div><div>             MapIndex::Immutable(index) => index.get_iterator(value),</div><div class="diff-info">@@ -226,39 +228,15 @@ impl<N: MapIndexKey + ?Sized> MapIndex<N> {</div><div>         format!("{field}_map")</div><div>     }</div><div> </div><div class="diff-removed">-    fn flusher(&self) -> Flusher {</div><div class="diff-removed">-        match self {</div><div class="diff-removed">-            MapIndex::Mutable(index) => index.get_db_wrapper().flusher(),</div><div class="diff-removed">-            MapIndex::Immutable(index) => index.get_db_wrapper().flusher(),</div><div class="diff-removed">-            MapIndex::Mmap(index) => index.flusher(),</div><div class="diff-removed">-        }</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    fn match_cardinality(</div><div class="diff-removed">-        &self,</div><div class="diff-removed">-        value: &N,</div><div class="diff-removed">-        hw_counter: &HardwareCounterCell,</div><div class="diff-removed">-    ) -> CardinalityEstimation {</div><div class="diff-removed">-        let values_count = self.get_count_for_value(value, hw_counter).unwrap_or(0);</div><div class="diff-removed">-</div><div class="diff-removed">-        CardinalityEstimation::exact(values_count)</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div>     pub fn get_telemetry_data(&self) -> PayloadIndexTelemetry {</div><div class="diff-removed">-        PayloadIndexTelemetry {</div><div class="diff-removed">-            field_name: None,</div><div class="diff-removed">-            points_count: self.get_indexed_points(),</div><div class="diff-removed">-            points_values_count: self.get_values_count(),</div><div class="diff-removed">-            histogram_bucket_size: None,</div><div class="diff-removed">-            index_type: match self {</div><div class="diff-removed">-                MapIndex::Mutable(_) => "mutable_map",</div><div class="diff-removed">-                MapIndex::Immutable(_) => "immutable_map",</div><div class="diff-removed">-                MapIndex::Mmap(_) => "mmap_map",</div><div class="diff-removed">-            },</div><div class="diff-added">+        match self {</div><div class="diff-added">+            MapIndex::Mutable(index) => index.get_telemetry_data(),</div><div class="diff-added">+            MapIndex::Immutable(index) => index.get_telemetry_data(),</div><div class="diff-added">+            MapIndex::Mmap(index) => index.get_telemetry_data(),</div><div>         }</div><div>     }</div><div> </div><div class="diff-removed">-    pub fn encode_db_record(value: &N, idx: PointOffsetType) -> String {</div><div class="diff-added">+    pub fn encode_db_record(value: &N::Owned, idx: PointOffsetType) -> String {</div><div>         format!("{value}/{idx}")</div><div>     }</div><div> </div><div class="diff-info">@@ -283,7 +261,7 @@ impl<N: MapIndexKey + ?Sized> MapIndex<N> {</div><div>         self.values_count(idx) == 0</div><div>     }</div><div> </div><div class="diff-removed">-    fn clear(self) -> OperationResult<()> {</div><div class="diff-added">+    fn clear(&self) -> OperationResult<()> {</div><div>         match self {</div><div>             MapIndex::Mutable(index) => index.get_db_wrapper().recreate_column_family(),</div><div>             MapIndex::Immutable(index) => index.get_db_wrapper().recreate_column_family(),</div><div class="diff-info">@@ -291,7 +269,11 @@ impl<N: MapIndexKey + ?Sized> MapIndex<N> {</div><div>         }</div><div>     }</div><div> </div><div class="diff-removed">-    fn remove_point(&mut self, id: PointOffsetType) -> OperationResult<()> {</div><div class="diff-added">+    fn cleanup(self) -> OperationResult<()> {</div><div class="diff-added">+        self.clear()</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    pub fn remove_point(&mut self, id: PointOffsetType) -> OperationResult<()> {</div><div>         match self {</div><div>             MapIndex::Mutable(index) => index.remove_point(id),</div><div>             MapIndex::Immutable(index) => index.remove_point(id),</div><div class="diff-info">@@ -302,14 +284,43 @@ impl<N: MapIndexKey + ?Sized> MapIndex<N> {</div><div>         }</div><div>     }</div><div> </div><div class="diff-removed">-    fn files(&self) -> Vec<PathBuf> {</div><div class="diff-added">+    fn flusher(&self) -> Flusher {</div><div>         match self {</div><div class="diff-removed">-            MapIndex::Mutable(_) => Vec::new(),</div><div class="diff-removed">-            MapIndex::Immutable(_) => Vec::new(),</div><div class="diff-removed">-            MapIndex::Mmap(index) => index.files(),</div><div class="diff-added">+            MapIndex::Mutable(index) => index.get_db_wrapper().flusher(),</div><div class="diff-added">+            MapIndex::Immutable(index) => index.get_db_wrapper().flusher(),</div><div class="diff-added">+            MapIndex::Mmap(index) => index.flusher(),</div><div>         }</div><div>     }</div><div> </div><div class="diff-added">+    fn is_on_disk(&self) -> bool {</div><div class="diff-added">+        match self {</div><div class="diff-added">+            MapIndex::Mutable(_) => false,</div><div class="diff-added">+            MapIndex::Immutable(_) => false,</div><div class="diff-added">+            MapIndex::Mmap(index) => index.is_on_disk(),</div><div class="diff-added">+        }</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    /// Populate all pages in the mmap.</div><div class="diff-added">+    /// Block until all pages are populated.</div><div class="diff-added">+    pub fn populate(&self) -> OperationResult<()> {</div><div class="diff-added">+        match self {</div><div class="diff-added">+            MapIndex::Mutable(_) => {}   // Not a mmap</div><div class="diff-added">+            MapIndex::Immutable(_) => {} // Not a mmap</div><div class="diff-added">+            MapIndex::Mmap(index) => index.populate()?,</div><div class="diff-added">+        }</div><div class="diff-added">+        Ok(())</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    /// Drop disk cache.</div><div class="diff-added">+    pub fn clear_cache(&self) -> OperationResult<()> {</div><div class="diff-added">+        match self {</div><div class="diff-added">+            MapIndex::Mutable(_) => {}   // Not a mmap</div><div class="diff-added">+            MapIndex::Immutable(_) => {} // Not a mmap</div><div class="diff-added">+            MapIndex::Mmap(index) => index.clear_cache()?,</div><div class="diff-added">+        }</div><div class="diff-added">+        Ok(())</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div>     /// Estimates cardinality for `except` clause</div><div>     ///</div><div>     /// # Arguments</div><div class="diff-info">@@ -322,7 +333,7 @@ impl<N: MapIndexKey + ?Sized> MapIndex<N> {</div><div>     fn except_cardinality<'a>(</div><div>         &'a self,</div><div>         excluded: impl Iterator<Item = &'a N>,</div><div class="diff-removed">-        hw_counter: &HardwareCounterCell,</div><div class="diff-added">+        hw_counter: &'a HardwareCounterCell,</div><div>     ) -> CardinalityEstimation {</div><div>         // Minimal case: we exclude as many points as possible.</div><div>         // In this case, excluded points do not have any other values except excluded ones.</div><div class="diff-info">@@ -390,7 +401,8 @@ impl<N: MapIndexKey + ?Sized> MapIndex<N> {</div><div> </div><div>         // Minimal amount of points, required to fit all unused values.</div><div>         // Cardinality can't be less than this value.</div><div class="diff-removed">-        let min_not_excluded_by_values = non_excluded_values_count.div_ceil(max_values_per_point);</div><div class="diff-added">+        let min_not_excluded_by_values =</div><div class="diff-added">+            non_excluded_values_count.div_ceil(max_values_per_point);</div><div> </div><div>         let min = min_not_excluded_by_values.max(</div><div>             self.get_indexed_points()</div><div class="diff-info">@@ -440,33 +452,12 @@ impl<N: MapIndexKey + ?Sized> MapIndex<N> {</div><div>         )</div><div>     }</div><div> </div><div class="diff-removed">-    pub fn is_on_disk(&self) -> bool {</div><div class="diff-removed">-        match self {</div><div class="diff-removed">-            MapIndex::Mutable(_) => false,</div><div class="diff-removed">-            MapIndex::Immutable(_) => false,</div><div class="diff-removed">-            MapIndex::Mmap(index) => index.is_on_disk(),</div><div class="diff-removed">-        }</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    /// Populate all pages in the mmap.</div><div class="diff-removed">-    /// Block until all pages are populated.</div><div class="diff-removed">-    pub fn populate(&self) -> OperationResult<()> {</div><div class="diff-removed">-        match self {</div><div class="diff-removed">-            MapIndex::Mutable(_) => {}   // Not a mmap</div><div class="diff-removed">-            MapIndex::Immutable(_) => {} // Not a mmap</div><div class="diff-removed">-            MapIndex::Mmap(index) => index.populate()?,</div><div class="diff-removed">-        }</div><div class="diff-removed">-        Ok(())</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    /// Drop disk cache.</div><div class="diff-removed">-    pub fn clear_cache(&self) -> OperationResult<()> {</div><div class="diff-added">+    fn files(&self) -> Vec<PathBuf> {</div><div>         match self {</div><div class="diff-removed">-            MapIndex::Mutable(_) => {}   // Not a mmap</div><div class="diff-removed">-            MapIndex::Immutable(_) => {} // Not a mmap</div><div class="diff-removed">-            MapIndex::Mmap(index) => index.clear_cache()?,</div><div class="diff-added">+            MapIndex::Mutable(_) => Vec::new(),</div><div class="diff-added">+            MapIndex::Immutable(_) => Vec::new(),</div><div class="diff-added">+            MapIndex::Mmap(index) => index.files(),</div><div>         }</div><div class="diff-removed">-        Ok(())</div><div>     }</div><div> }</div><div> </div><div class="diff-info">@@ -530,29 +521,22 @@ where</div><div>             flatten_values.extend(payload_values);</div><div>         }</div><div>         let flatten_values: Vec<N::Owned> = flatten_values.into_iter().map(Into::into).collect();</div><div class="diff-removed">-</div><div>         if self.point_to_values.len() <= id as usize {</div><div>             self.point_to_values.resize_with(id as usize + 1, Vec::new);</div><div>         }</div><div class="diff-removed">-</div><div>         self.point_to_values[id as usize].extend(flatten_values.clone());</div><div class="diff-removed">-</div><div>         let mut hw_cell_wb = hw_counter</div><div>             .payload_index_io_write_counter()</div><div>             .write_back_counter();</div><div class="diff-removed">-</div><div>         for value in flatten_values {</div><div>             let entry = self.values_to_points.entry(value);</div><div class="diff-removed">-</div><div>             if let Entry::Vacant(e) = &entry {</div><div>                 let size = N::mmapped_size(N::as_referenced(e.key().borrow()));</div><div>                 hw_cell_wb.incr_delta(size);</div><div>             }</div><div class="diff-removed">-</div><div>             hw_cell_wb.incr_delta(size_of_val(&id));</div><div>             entry.or_default().push(id);</div><div>         }</div><div class="diff-removed">-</div><div>         Ok(())</div><div>     }</div><div> </div><div class="diff-info">@@ -576,7 +560,7 @@ impl PayloadFieldIndex for MapIndex<str> {</div><div>     }</div><div> </div><div>     fn cleanup(self) -> OperationResult<()> {</div><div class="diff-removed">-        self.clear()</div><div class="diff-added">+        self.cleanup()</div><div>     }</div><div> </div><div>     fn flusher(&self) -> Flusher {</div><div class="diff-info">@@ -676,9 +660,9 @@ impl PayloadFieldIndex for MapIndex<str> {</div><div>                 }</div><div>             },</div><div>             Some(Match::Except(MatchExcept { except })) => match except {</div><div class="diff-removed">-                AnyVariants::Strings(keywords) => {</div><div class="diff-removed">-                    Some(self.except_cardinality(keywords.iter().map(|k| k.as_str()), hw_counter))</div><div class="diff-removed">-                }</div><div class="diff-added">+                AnyVariants::Strings(keywords) => Some(</div><div class="diff-added">+                    self.except_cardinality(keywords.iter().map(|k| k.as_str()), hw_counter),</div><div class="diff-added">+                ),</div><div>                 AnyVariants::Integers(others) => {</div><div>                     if others.is_empty() {</div><div>                         Some(CardinalityEstimation::exact(0).with_primary_clause(</div><div class="diff-info">@@ -703,7 +687,7 @@ impl PayloadFieldIndex for MapIndex<str> {</div><div>                 .map(|value| {</div><div>                     (</div><div>                         value,</div><div class="diff-removed">-                        self.get_count_for_value(value, &HardwareCounterCell::disposable()) // Payload_blocks only used in HNSW building, which is unmeasured.</div><div class="diff-added">+                        self.get_count_for_value(value, &HardwareCounterCell::disposable()) // payload_blocks only used in HNSW building, which is unmeasured.</div><div>                             .unwrap_or(0),</div><div>                     )</div><div>                 })</div><div class="diff-info">@@ -726,7 +710,7 @@ impl PayloadFieldIndex for MapIndex<UuidIntType> {</div><div>     }</div><div> </div><div>     fn cleanup(self) -> OperationResult<()> {</div><div class="diff-removed">-        self.clear()</div><div class="diff-added">+        self.cleanup()</div><div>     }</div><div> </div><div>     fn flusher(&self) -> Flusher {</div><div class="diff-info">@@ -759,13 +743,13 @@ impl PayloadFieldIndex for MapIndex<UuidIntType> {</div><div>                         .iter()</div><div>                         .map(|uuid_string| Uuid::from_str(uuid_string).map(|x| x.as_u128()))</div><div>                         .collect();</div><div class="diff-removed">-</div><div>                     let uuids = uuids.ok()?;</div><div class="diff-removed">-</div><div>                     Some(Box::new(</div><div>                         uuids</div><div>                             .into_iter()</div><div class="diff-removed">-                            .flat_map(move |uuid| self.get_iterator(&uuid, hw_counter).copied())</div><div class="diff-added">+                            .flat_map(move |uuid| {</div><div class="diff-added">+                                self.get_iterator(&uuid, hw_counter).copied()</div><div class="diff-added">+                            })</div><div>                             .unique(),</div><div>                     ))</div><div>                 }</div><div class="diff-info">@@ -783,7 +767,6 @@ impl PayloadFieldIndex for MapIndex<UuidIntType> {</div><div>                         .iter()</div><div>                         .map(|uuid_string| Uuid::from_str(uuid_string).map(|x| x.as_u128()))</div><div>                         .collect();</div><div class="diff-removed">-</div><div>                     let excluded_uuids = uuids.ok()?;</div><div>                     let exclude_iter = self</div><div>                         .iter_values()</div><div class="diff-info">@@ -828,9 +811,7 @@ impl PayloadFieldIndex for MapIndex<UuidIntType> {</div><div>                         .iter()</div><div>                         .map(|uuid_string| Uuid::from_str(uuid_string).map(|x| x.as_u128()))</div><div>                         .collect();</div><div class="diff-removed">-</div><div>                     let uuids = uuids.ok()?;</div><div class="diff-removed">-</div><div>                     let estimations = uuids</div><div>                         .into_iter()</div><div>                         .map(|uuid| self.match_cardinality(&uuid, hw_counter))</div><div class="diff-info">@@ -848,9 +829,11 @@ impl PayloadFieldIndex for MapIndex<UuidIntType> {</div><div>                 }</div><div>                 AnyVariants::Integers(integers) => {</div><div>                     if integers.is_empty() {</div><div class="diff-removed">-                        Some(CardinalityEstimation::exact(0).with_primary_clause(</div><div class="diff-removed">-                            PrimaryCondition::Condition(Box::new(condition.clone())),</div><div class="diff-removed">-                        ))</div><div class="diff-added">+                        Some(</div><div class="diff-added">+                            CardinalityEstimation::exact(0).with_primary_clause(</div><div class="diff-added">+                                PrimaryCondition::Condition(Box::new(condition.clone())),</div><div class="diff-added">+                            ),</div><div class="diff-added">+                        )</div><div>                     } else {</div><div>                         None</div><div>                     }</div><div class="diff-info">@@ -862,16 +845,16 @@ impl PayloadFieldIndex for MapIndex<UuidIntType> {</div><div>                         .iter()</div><div>                         .map(|uuid_string| Uuid::from_str(uuid_string).map(|x| x.as_u128()))</div><div>                         .collect();</div><div class="diff-removed">-</div><div>                     let excluded_uuids = uuids.ok()?;</div><div class="diff-removed">-</div><div>                     Some(self.except_cardinality(excluded_uuids.iter(), hw_counter))</div><div>                 }</div><div>                 AnyVariants::Integers(other) => {</div><div>                     if other.is_empty() {</div><div class="diff-removed">-                        Some(CardinalityEstimation::exact(0).with_primary_clause(</div><div class="diff-removed">-                            PrimaryCondition::Condition(Box::new(condition.clone())),</div><div class="diff-removed">-                        ))</div><div class="diff-added">+                        Some(</div><div class="diff-added">+                            CardinalityEstimation::exact(0).with_primary_clause(</div><div class="diff-added">+                                PrimaryCondition::Condition(Box::new(condition.clone())),</div><div class="diff-added">+                            ),</div><div class="diff-added">+                        )</div><div>                     } else {</div><div>                         None</div><div>                     }</div><div class="diff-info">@@ -891,7 +874,7 @@ impl PayloadFieldIndex for MapIndex<UuidIntType> {</div><div>                 .map(move |value| {</div><div>                     (</div><div>                         value,</div><div class="diff-removed">-                        self.get_count_for_value(value, &HardwareCounterCell::disposable()) // payload_blocks only used in HNSW building, which is unmeasured.</div><div class="diff-added">+                        self.get_count_for_value(value, &HardwareCounterCell::disposable()) // Only used in HNSW building so no measurement needed here.</div><div>                             .unwrap_or(0),</div><div>                     )</div><div>                 })</div><div class="diff-info">@@ -917,7 +900,7 @@ impl PayloadFieldIndex for MapIndex<IntPayloadType> {</div><div>     }</div><div> </div><div>     fn cleanup(self) -> OperationResult<()> {</div><div class="diff-removed">-        self.clear()</div><div class="diff-added">+        self.cleanup()</div><div>     }</div><div> </div><div>     fn flusher(&self) -> Flusher {</div><div class="diff-info">@@ -936,15 +919,15 @@ impl PayloadFieldIndex for MapIndex<IntPayloadType> {</div><div>         match &condition.r#match {</div><div>             Some(Match::Value(MatchValue { value })) => match value {</div><div>                 ValueVariants::String(_) => None,</div><div class="diff-removed">-                ValueVariants::Integer(integer) => {</div><div class="diff-removed">-                    Some(Box::new(self.get_iterator(integer, hw_counter).copied()))</div><div class="diff-removed">-                }</div><div class="diff-added">+                ValueVariants::Integer(integer) => Some(Box::new(</div><div class="diff-added">+                    self.get_iterator(integer, hw_counter).copied(),</div><div class="diff-added">+                )),</div><div>                 ValueVariants::Bool(_) => None,</div><div>             },</div><div>             Some(Match::Any(MatchAny { any: any_variant })) => match any_variant {</div><div>                 AnyVariants::Strings(keywords) => {</div><div>                     if keywords.is_empty() {</div><div class="diff-removed">-                        Some(Box::new(vec![].into_iter()))</div><div class="diff-added">+                        Some(Box::new(iter::empty()))</div><div>                     } else {</div><div>                         None</div><div>                     }</div><div class="diff-info">@@ -952,7 +935,9 @@ impl PayloadFieldIndex for MapIndex<IntPayloadType> {</div><div>                 AnyVariants::Integers(integers) => Some(Box::new(</div><div>                     integers</div><div>                         .iter()</div><div class="diff-removed">-                        .flat_map(move |integer| self.get_iterator(integer, hw_counter).copied())</div><div class="diff-added">+                        .flat_map(move |integer| {</div><div class="diff-added">+                            self.get_iterator(integer, hw_counter).copied()</div><div class="diff-added">+                        })</div><div>                         .unique(),</div><div>                 )),</div><div>             },</div><div class="diff-info">@@ -990,9 +975,11 @@ impl PayloadFieldIndex for MapIndex<IntPayloadType> {</div><div>             Some(Match::Any(MatchAny { any: any_variants })) => match any_variants {</div><div>                 AnyVariants::Strings(keywords) => {</div><div>                     if keywords.is_empty() {</div><div class="diff-removed">-                        Some(CardinalityEstimation::exact(0).with_primary_clause(</div><div class="diff-removed">-                            PrimaryCondition::Condition(Box::new(condition.clone())),</div><div class="diff-removed">-                        ))</div><div class="diff-added">+                        Some(</div><div class="diff-added">+                            CardinalityEstimation::exact(0).with_primary_clause(</div><div class="diff-added">+                                PrimaryCondition::Condition(Box::new(condition.clone())),</div><div class="diff-added">+                            ),</div><div class="diff-added">+                        )</div><div>                     } else {</div><div>                         None</div><div>                     }</div><div class="diff-info">@@ -1017,9 +1004,11 @@ impl PayloadFieldIndex for MapIndex<IntPayloadType> {</div><div>             Some(Match::Except(MatchExcept { except })) => match except {</div><div>                 AnyVariants::Strings(others) => {</div><div>                     if others.is_empty() {</div><div class="diff-removed">-                        Some(CardinalityEstimation::exact(0).with_primary_clause(</div><div class="diff-removed">-                            PrimaryCondition::Condition(Box::new(condition.clone())),</div><div class="diff-removed">-                        ))</div><div class="diff-added">+                        Some(</div><div class="diff-added">+                            CardinalityEstimation::exact(0).with_primary_clause(</div><div class="diff-added">+                                PrimaryCondition::Condition(Box::new(condition.clone())),</div><div class="diff-added">+                            ),</div><div class="diff-added">+                        )</div><div>                     } else {</div><div>                         None</div><div>                     }</div><div class="diff-info">@@ -1111,11 +1100,12 @@ impl ValueIndexer for MapIndex<str> {</div><div>         }</div><div>     }</div><div> </div><div class="diff-removed">-    fn get_value(value: &Value) -> Option<String> {</div><div class="diff-added">+    fn get_values(value: &Value) -> Vec<Self::ValueType> {</div><div>         if let Value::String(keyword) = value {</div><div class="diff-removed">-            return Some(keyword.to_owned());</div><div class="diff-added">+            vec![keyword.to_owned()]</div><div class="diff-added">+        } else {</div><div class="diff-added">+            vec![]</div><div>         }</div><div class="diff-removed">-        None</div><div>     }</div><div> </div><div>     fn remove_point(&mut self, id: PointOffsetType) -> OperationResult<()> {</div><div class="diff-info">@@ -1143,11 +1133,12 @@ impl ValueIndexer for MapIndex<IntPayloadType> {</div><div>         }</div><div>     }</div><div> </div><div class="diff-removed">-    fn get_value(value: &Value) -> Option<IntPayloadType> {</div><div class="diff-added">+    fn get_values(value: &Value) -> Vec<Self::ValueType> {</div><div>         if let Value::Number(num) = value {</div><div class="diff-removed">-            return num.as_i64();</div><div class="diff-added">+            num.as_i64().into_iter().collect()</div><div class="diff-added">+        } else {</div><div class="diff-added">+            vec![]</div><div>         }</div><div class="diff-removed">-        None</div><div>     }</div><div> </div><div>     fn remove_point(&mut self, id: PointOffsetType) -> OperationResult<()> {</div><div class="diff-info">@@ -1175,8 +1166,10 @@ impl ValueIndexer for MapIndex<UuidIntType> {</div><div>         }</div><div>     }</div><div> </div><div class="diff-removed">-    fn get_value(value: &Value) -> Option<Self::ValueType> {</div><div class="diff-added">+    fn get_values(value: &Value) -> Vec<Self::ValueType> {</div><div>         Some(Uuid::parse_str(value.as_str()?).ok()?.as_u128())</div><div class="diff-added">+            .into_iter()</div><div class="diff-added">+            .collect()</div><div>     }</div><div> </div><div>     fn remove_point(&mut self, id: PointOffsetType) -> OperationResult<()> {</div><div class="diff-info">@@ -1215,7 +1208,6 @@ mod tests {</div><div>         <MapIndex<N> as ValueIndexer>::ValueType: Into<N::Owned>,</div><div>     {</div><div>         let hw_counter = HardwareCounterCell::new();</div><div class="diff-removed">-</div><div>         match index_type {</div><div>             IndexType::Mutable | IndexType::Immutable => {</div><div>                 let mut builder =</div><div class="diff-info">@@ -1251,9 +1243,11 @@ mod tests {</div><div>         index_type: IndexType,</div><div>     ) -> MapIndex<N> {</div><div>         let mut index = match index_type {</div><div class="diff-removed">-            IndexType::Mutable => {</div><div class="diff-removed">-                MapIndex::<N>::new_memory(open_db_with_existing_cf(path).unwrap(), FIELD_NAME, true)</div><div class="diff-removed">-            }</div><div class="diff-added">+            IndexType::Mutable => MapIndex::<N>::new_memory(</div><div class="diff-added">+                open_db_with_existing_cf(path).unwrap(),</div><div class="diff-added">+                FIELD_NAME,</div><div class="diff-added">+                true,</div><div class="diff-added">+            ),</div><div>             IndexType::Immutable => MapIndex::<N>::new_memory(</div><div>                 open_db_with_existing_cf(path).unwrap(),</div><div>                 FIELD_NAME,</div><div class="diff-info">@@ -1272,7 +1266,6 @@ mod tests {</div><div>             let check_values: HashSet<&N> = values.iter().map(|v| v.borrow()).collect();</div><div>             assert_eq!(index_values, check_values);</div><div>         }</div><div class="diff-removed">-</div><div>         index</div><div>     }</div><div> </div><div class="diff-info">@@ -1281,11 +1274,8 @@ mod tests {</div><div>         let temp_dir = Builder::new().prefix("store_dir").tempdir().unwrap();</div><div>         let mut builder = MapIndex::<IntPayloadType>::mmap_builder(temp_dir.path(), false);</div><div>         builder.init().unwrap();</div><div class="diff-removed">-</div><div class="diff-removed">-        let data = [vec![1, 2, 3, 4, 5, 6], vec![25], vec![10, 11]];</div><div class="diff-removed">-</div><div>         let hw_counter = HardwareCounterCell::new();</div><div class="diff-removed">-</div><div class="diff-added">+        let data = [vec![1, 2, 3, 4, 5, 6], vec![25], vec![10, 11]];</div><div>         for (idx, values) in data.iter().enumerate().rev() {</div><div>             let values: Vec<Value> = values.iter().map(|i| (*i).into()).collect();</div><div>             let values: Vec<_> = values.iter().collect();</div><div class="diff-info">@@ -1293,7 +1283,6 @@ mod tests {</div><div>                 .add_point(idx as PointOffsetType, &values, &hw_counter)</div><div>                 .unwrap();</div><div>         }</div><div class="diff-removed">-</div><div>         let index = builder.finalize().unwrap();</div><div>         for (idx, values) in data.iter().enumerate().rev() {</div><div>             let res: Vec<_> = index</div><div class="diff-info">@@ -1321,10 +1310,7 @@ mod tests {</div><div>         let temp_dir = Builder::new().prefix("store_dir").tempdir().unwrap();</div><div>         save_map_index::<IntPayloadType>(&data, temp_dir.path(), index_type, |v| (*v).into());</div><div>         let index = load_map_index::<IntPayloadType>(&data, temp_dir.path(), index_type);</div><div class="diff-removed">-</div><div>         let hw_counter = HardwareCounterCell::new();</div><div class="diff-removed">-</div><div class="diff-removed">-        // Ensure cardinality is non zero</div><div>         assert!(</div><div>             !index</div><div>                 .except_cardinality(vec![].into_iter(), &hw_counter)</div><div class="diff-info">@@ -1364,10 +1350,7 @@ mod tests {</div><div>         let temp_dir = Builder::new().prefix("store_dir").tempdir().unwrap();</div><div>         save_map_index::<str>(&data, temp_dir.path(), index_type, |v| v.to_string().into());</div><div>         let index = load_map_index::<str>(&data, temp_dir.path(), index_type);</div><div class="diff-removed">-</div><div>         let hw_counter = HardwareCounterCell::new();</div><div class="diff-removed">-</div><div class="diff-removed">-        // Ensure cardinality is non zero</div><div>         assert!(</div><div>             !index</div><div>                 .except_cardinality(vec![].into_iter(), &hw_counter)</div><div class="diff-info">@@ -1385,10 +1368,7 @@ mod tests {</div><div>         let temp_dir = Builder::new().prefix("store_dir").tempdir().unwrap();</div><div>         save_map_index::<str>(&data, temp_dir.path(), index_type, |v| v.to_string().into());</div><div>         let index = load_map_index::<str>(&data, temp_dir.path(), index_type);</div><div class="diff-removed">-</div><div>         let hw_counter = HardwareCounterCell::new();</div><div class="diff-removed">-</div><div class="diff-removed">-        // Ensure cardinality is zero</div><div>         assert!(</div><div>             index</div><div>                 .except_cardinality(vec![].into_iter(), &hw_counter)</div><div></div></pre>
                </div>
            </div>
        </section>
    </main>
    <footer>
        <p>LoCoDiff-bench - <a href="https://github.com/AbanteAI/LoCoDiff-bench">GitHub Repository</a></p>
    </footer>
</body>
</html>
    