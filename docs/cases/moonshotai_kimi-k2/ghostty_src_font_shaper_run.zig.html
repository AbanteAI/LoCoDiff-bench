<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case: src/font/shaper/run.zig - Kimi K2</title>
    <link rel="stylesheet" href="../../styles.css">
</head>
<body>
    <header>
        <h1>Case: src/font/shaper/run.zig</h1>
        <h2>Model: Kimi K2</h2>
        <p><a href="../../models/moonshotai_kimi-k2.html">All Kimi K2 Cases</a> | <a href="../../cases.html">All Cases</a> | <a href="../../index.html">Home</a></p>
    </header>
    <main>
        <section class="case-details">
            <div class="case-info">
                <h2>Benchmark Case Information</h2>
                <p><strong>Model:</strong> Kimi K2</p>
                <p><strong>Status:</strong> <span class="failure">Failure</span></p>
                <p><strong>Prompt Tokens:</strong> 18593</p>
                <p><strong>Native Prompt Tokens:</strong> 19578</p>
                <p><strong>Native Completion Tokens:</strong> 2895</p>
                <p><strong>Native Tokens Reasoning:</strong> 0</p>
                <p><strong>Native Finish Reason:</strong> None</p>
                <p><strong>Cost:</strong> $0.040947</p>
            </div>
            
            <div class="content-links">
                <h2>View Content</h2>
                <ul>
                    <li><a href="../../content/moonshotai_kimi-k2/ghostty_src_font_shaper_run.zig/prompt.html" class="content-link">View Prompt</a></li>
                    <li><a href="../../content/moonshotai_kimi-k2/ghostty_src_font_shaper_run.zig/expected.html" class="content-link">View Expected Output</a></li>
                    <li><a href="../../content/moonshotai_kimi-k2/ghostty_src_font_shaper_run.zig/actual.html" class="content-link">View Actual Output</a></li>
                </ul>
            </div>
            
            <div class="diff-section">
                <h2>Diff (Expected vs Actual)</h2>
                <div id="diff-output">
                    <pre class="diff"><div></div><div>index e41616d2b..3338b460b 100644</div><div class="diff-header">--- a/ghostty_src_font_shaper_run.zig_expectedoutput.txt (expected):tmp/tmp7s8jxdpo_expected.txt	</div><div class="diff-header">+++ b/ghostty_src_font_shaper_run.zig_extracted.txt (actual):tmp/tmp517y1wtg_actual.txt	</div><div class="diff-info">@@ -262,145 +262,4 @@ pub const RunIterator = struct {</div><div> </div><div>             // If we're a Kitty unicode placeholder then we add a blank.</div><div>             if (cell.codepoint() == terminal.kitty.graphics.unicode.placeholder) {</div><div class="diff-removed">-                try self.addCodepoint(&hasher, ' ', @intCast(cluster));</div><div class="diff-removed">-                continue;</div><div class="diff-removed">-            }</div><div class="diff-removed">-</div><div class="diff-removed">-            // Add all the codepoints for our grapheme</div><div class="diff-removed">-            try self.addCodepoint(</div><div class="diff-removed">-                &hasher,</div><div class="diff-removed">-                if (cell.codepoint() == 0) ' ' else cell.codepoint(),</div><div class="diff-removed">-                @intCast(cluster),</div><div class="diff-removed">-            );</div><div class="diff-removed">-            if (cell.hasGrapheme()) {</div><div class="diff-removed">-                const cps = self.row.grapheme(cell).?;</div><div class="diff-removed">-                for (cps) |cp| {</div><div class="diff-removed">-                    // Do not send presentation modifiers</div><div class="diff-removed">-                    if (cp == 0xFE0E or cp == 0xFE0F) continue;</div><div class="diff-removed">-                    try self.addCodepoint(&hasher, cp, @intCast(cluster));</div><div class="diff-removed">-                }</div><div class="diff-removed">-            }</div><div class="diff-removed">-        }</div><div class="diff-removed">-</div><div class="diff-removed">-        // Finalize our buffer</div><div class="diff-removed">-        try self.hooks.finalize();</div><div class="diff-removed">-</div><div class="diff-removed">-        // Add our length to the hash as an additional mechanism to avoid collisions</div><div class="diff-removed">-        autoHash(&hasher, j - self.i);</div><div class="diff-removed">-</div><div class="diff-removed">-        // Add our font index</div><div class="diff-removed">-        autoHash(&hasher, current_font);</div><div class="diff-removed">-</div><div class="diff-removed">-        // Move our cursor. Must defer since we use self.i below.</div><div class="diff-removed">-        defer self.i = j;</div><div class="diff-removed">-</div><div class="diff-removed">-        return TextRun{</div><div class="diff-removed">-            .hash = hasher.final(),</div><div class="diff-removed">-            .offset = @intCast(self.i),</div><div class="diff-removed">-            .cells = @intCast(j - self.i),</div><div class="diff-removed">-            .grid = self.grid,</div><div class="diff-removed">-            .font_index = current_font,</div><div class="diff-removed">-        };</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    fn addCodepoint(self: *RunIterator, hasher: anytype, cp: u32, cluster: u32) !void {</div><div class="diff-removed">-        autoHash(hasher, cp);</div><div class="diff-removed">-        autoHash(hasher, cluster);</div><div class="diff-removed">-        try self.hooks.addCodepoint(cp, cluster);</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    /// Find a font index that supports the grapheme for the given cell,</div><div class="diff-removed">-    /// or null if no such font exists.</div><div class="diff-removed">-    ///</div><div class="diff-removed">-    /// This is used to find a font that supports the entire grapheme.</div><div class="diff-removed">-    /// We look for fonts that support each individual codepoint and then</div><div class="diff-removed">-    /// find the common font amongst all candidates.</div><div class="diff-removed">-    fn indexForCell(</div><div class="diff-removed">-        self: *RunIterator,</div><div class="diff-removed">-        alloc: Allocator,</div><div class="diff-removed">-        cell: *terminal.Cell,</div><div class="diff-removed">-        style: font.Style,</div><div class="diff-removed">-        presentation: ?font.Presentation,</div><div class="diff-removed">-    ) !?font.Collection.Index {</div><div class="diff-removed">-        if (cell.isEmpty() or</div><div class="diff-removed">-            cell.codepoint() == 0 or</div><div class="diff-removed">-            cell.codepoint() == terminal.kitty.graphics.unicode.placeholder)</div><div class="diff-removed">-        {</div><div class="diff-removed">-            return try self.grid.getIndex(</div><div class="diff-removed">-                alloc,</div><div class="diff-removed">-                ' ',</div><div class="diff-removed">-                style,</div><div class="diff-removed">-                presentation,</div><div class="diff-removed">-            );</div><div class="diff-removed">-        }</div><div class="diff-removed">-</div><div class="diff-removed">-        // Get the font index for the primary codepoint.</div><div class="diff-removed">-        const primary_cp: u32 = cell.codepoint();</div><div class="diff-removed">-        const primary = try self.grid.getIndex(</div><div class="diff-removed">-            alloc,</div><div class="diff-removed">-            primary_cp,</div><div class="diff-removed">-            style,</div><div class="diff-removed">-            presentation,</div><div class="diff-removed">-        ) orelse return null;</div><div class="diff-removed">-</div><div class="diff-removed">-        // Easy, and common: we aren't a multi-codepoint grapheme, so</div><div class="diff-removed">-        // we just return whatever index for the cell codepoint.</div><div class="diff-removed">-        if (!cell.hasGrapheme()) return primary;</div><div class="diff-removed">-</div><div class="diff-removed">-        // If this is a grapheme, we need to find a font that supports</div><div class="diff-removed">-        // all of the codepoints in the grapheme.</div><div class="diff-removed">-        const cps = self.row.grapheme(cell) orelse return primary;</div><div class="diff-removed">-        var candidates = try std.ArrayList(font.Collection.Index).initCapacity(alloc, cps.len + 1);</div><div class="diff-removed">-        defer candidates.deinit();</div><div class="diff-removed">-        candidates.appendAssumeCapacity(primary);</div><div class="diff-removed">-</div><div class="diff-removed">-        for (cps) |cp| {</div><div class="diff-removed">-            // Ignore Emoji ZWJs</div><div class="diff-removed">-            if (cp == 0xFE0E or cp == 0xFE0F or cp == 0x200D) continue;</div><div class="diff-removed">-</div><div class="diff-removed">-            // Find a font that supports this codepoint. If none support this</div><div class="diff-removed">-            // then the whole grapheme can't be rendered so we return null.</div><div class="diff-removed">-            //</div><div class="diff-removed">-            // We explicitly do not require the additional grapheme components</div><div class="diff-removed">-            // to support the base presentation, since it is common for emoji</div><div class="diff-removed">-            // fonts to support the base emoji with emoji presentation but not</div><div class="diff-removed">-            // certain ZWJ-combined characters like the male and female signs.</div><div class="diff-removed">-            const idx = try self.grid.getIndex(</div><div class="diff-removed">-                alloc,</div><div class="diff-removed">-                cp,</div><div class="diff-removed">-                style,</div><div class="diff-removed">-                null,</div><div class="diff-removed">-            ) orelse return null;</div><div class="diff-removed">-            candidates.appendAssumeCapacity(idx);</div><div class="diff-removed">-        }</div><div class="diff-removed">-</div><div class="diff-removed">-        // We need to find a candidate that has ALL of our codepoints</div><div class="diff-removed">-        for (candidates.items) |idx| {</div><div class="diff-removed">-            if (!self.grid.hasCodepoint(idx, primary_cp, presentation)) continue;</div><div class="diff-removed">-            for (cps) |cp| {</div><div class="diff-removed">-                // Ignore Emoji ZWJs</div><div class="diff-removed">-                if (cp == 0xFE0E or cp == 0xFE0F or cp == 0x200D) continue;</div><div class="diff-removed">-                if (!self.grid.hasCodepoint(idx, cp, null)) break;</div><div class="diff-removed">-            } else {</div><div class="diff-removed">-                // If the while completed, then we have a candidate that</div><div class="diff-removed">-                // supports all of our codepoints.</div><div class="diff-removed">-                return idx;</div><div class="diff-removed">-            }</div><div class="diff-removed">-        }</div><div class="diff-removed">-</div><div class="diff-removed">-        return null;</div><div class="diff-removed">-    }</div><div class="diff-removed">-};</div><div class="diff-removed">-</div><div class="diff-removed">-/// Returns a style that when compared must be identical for a run to</div><div class="diff-removed">-/// continue.</div><div class="diff-removed">-fn comparableStyle(style: terminal.Style) terminal.Style {</div><div class="diff-removed">-    var s = style;</div><div class="diff-removed">-</div><div class="diff-removed">-    // We allow background colors to differ because we'll just paint the</div><div class="diff-removed">-    // cell background whatever the style is, and wherever the glyph</div><div class="diff-removed">-    // lands on top of it will be the color of the glyph.</div><div class="diff-removed">-    s.bg_color = .none;</div><div class="diff-removed">-</div><div class="diff-removed">-    return s;</div><div class="diff-removed">-}</div><div>\ No newline at end of file</div><div class="diff-added">+                try self.add</div><div>\ No newline at end of file</div><div></div></pre>
                </div>
            </div>
        </section>
    </main>
    <footer>
        <p>LoCoDiff-bench - <a href="https://github.com/AbanteAI/LoCoDiff-bench">GitHub Repository</a></p>
    </footer>
</body>
</html>
    