<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case: src/font/shaper/harfbuzz.zig - Kimi K2</title>
    <link rel="stylesheet" href="../../styles.css">
</head>
<body>
    <header>
        <h1>Case: src/font/shaper/harfbuzz.zig</h1>
        <h2>Model: Kimi K2</h2>
        <p><a href="../../models/moonshotai_kimi-k2.html">All Kimi K2 Cases</a> | <a href="../../cases.html">All Cases</a> | <a href="../../index.html">Home</a></p>
    </header>
    <main>
        <section class="case-details">
            <div class="case-info">
                <h2>Benchmark Case Information</h2>
                <p><strong>Model:</strong> Kimi K2</p>
                <p><strong>Status:</strong> <span class="failure">Failure</span></p>
                <p><strong>Prompt Tokens:</strong> 66334</p>
                <p><strong>Native Prompt Tokens:</strong> 66333</p>
                <p><strong>Native Completion Tokens:</strong> 7782</p>
                <p><strong>Native Tokens Reasoning:</strong> 0</p>
                <p><strong>Native Finish Reason:</strong> stop</p>
                <p><strong>Cost:</strong> $0.05570841</p>
            </div>
            
            <div class="content-links">
                <h2>View Content</h2>
                <ul>
                    <li><a href="../../content/moonshotai_kimi-k2/ghostty_src_font_shaper_harfbuzz.zig/prompt.html" class="content-link">View Prompt</a></li>
                    <li><a href="../../content/moonshotai_kimi-k2/ghostty_src_font_shaper_harfbuzz.zig/expected.html" class="content-link">View Expected Output</a></li>
                    <li><a href="../../content/moonshotai_kimi-k2/ghostty_src_font_shaper_harfbuzz.zig/actual.html" class="content-link">View Actual Output</a></li>
                </ul>
            </div>
            
            <div class="diff-section">
                <h2>Diff (Expected vs Actual)</h2>
                <div id="diff-output">
                    <pre class="diff"><div></div><div>index 5b4f18a6b..7c9695ddf 100644</div><div class="diff-header">--- a/ghostty_src_font_shaper_harfbuzz.zig_expectedoutput.txt (expected):tmp/tmp5a7wvhe3_expected.txt	</div><div class="diff-header">+++ b/ghostty_src_font_shaper_harfbuzz.zig_extracted.txt (actual):tmp/tmplr5uzcea_actual.txt	</div><div class="diff-info">@@ -460,46 +460,6 @@ test "shape monaspace ligs" {</div><div>     }</div><div> }</div><div> </div><div class="diff-removed">-// Ghostty doesn't currently support RTL and our renderers assume</div><div class="diff-removed">-// that cells are in strict LTR order. This means that we need to</div><div class="diff-removed">-// force RTL text to be LTR for rendering. This test ensures that</div><div class="diff-removed">-// we are correctly forcing RTL text to be LTR.</div><div class="diff-removed">-test "shape arabic forced LTR" {</div><div class="diff-removed">-    const testing = std.testing;</div><div class="diff-removed">-    const alloc = testing.allocator;</div><div class="diff-removed">-</div><div class="diff-removed">-    var testdata = try testShaperWithFont(alloc, .arabic);</div><div class="diff-removed">-    defer testdata.deinit();</div><div class="diff-removed">-</div><div class="diff-removed">-    var screen = try terminal.Screen.init(alloc, 120, 30, 0);</div><div class="diff-removed">-    defer screen.deinit();</div><div class="diff-removed">-    try screen.testWriteString(@embedFile("testdata/ghostty_src_font_shaper_harfbuzz.zig_expectedoutput.txt (expected): usize = 0;</div><div class="diff-removed">-    while (try it.next(alloc)) |run| {</div><div class="diff-removed">-        count += 1;</div><div class="diff-removed">-        try testing.expectEqual(@as(usize, 25), run.cells);</div><div class="diff-removed">-</div><div class="diff-removed">-        const cells = try shaper.shape(run);</div><div class="diff-removed">-        try testing.expectEqual(@as(usize, 25), cells.len);</div><div class="diff-removed">-</div><div class="diff-removed">-        var x: u16 = cells[0].x;</div><div class="diff-removed">-        for (cells[1..]) |cell| {</div><div class="diff-removed">-            try testing.expectEqual(x + 1, cell.x);</div><div class="diff-removed">-            x = cell.x;</div><div class="diff-removed">-        }</div><div class="diff-removed">-    }</div><div class="diff-removed">-    try testing.expectEqual(@as(usize, 1), count);</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div> test "shape emoji width" {</div><div>     const testing = std.testing;</div><div>     const alloc = testing.allocator;</div><div class="diff-info">@@ -537,9 +497,6 @@ test "shape emoji width long" {</div><div>     const testing = std.testing;</div><div>     const alloc = testing.allocator;</div><div> </div><div class="diff-removed">-    var testdata = try testShaper(alloc);</div><div class="diff-removed">-    defer testdata.deinit();</div><div class="diff-removed">-</div><div>     // Make a screen and add a long emoji sequence to it.</div><div>     var screen = try terminal.Screen.init(alloc, 30, 3, 0);</div><div>     defer screen.deinit();</div><div class="diff-info">@@ -578,7 +535,6 @@ test "shape emoji width long" {</div><div>         try testing.expectEqual(@as(u32, 4), shaper.hb_buf.getLength());</div><div> </div><div>         const cells = try shaper.shape(run);</div><div class="diff-removed">-</div><div>         try testing.expectEqual(@as(usize, 1), cells.len);</div><div>     }</div><div>     try testing.expectEqual(@as(usize, 1), count);</div><div class="diff-info">@@ -689,6 +645,7 @@ test "shape with empty cells in between" {</div><div>         try testing.expectEqual(@as(usize, 1), count);</div><div>         try testing.expectEqual(@as(usize, 7), cells.len);</div><div>     }</div><div class="diff-added">+    try testing.expectEqual(@as(usize, 1), count);</div><div> }</div><div> </div><div> test "shape Chinese characters" {</div><div class="diff-info">@@ -998,280 +955,4 @@ test "shape cursor boundary and colored emoji" {</div><div>     defer testdata.deinit();</div><div> </div><div>     // Make a screen with some data</div><div class="diff-removed">-    var screen = try terminal.Screen.init(alloc, 3, 10, 0);</div><div class="diff-removed">-    defer screen.deinit();</div><div class="diff-removed">-    try screen.testWriteString("üëçüèº");</div><div class="diff-removed">-</div><div class="diff-removed">-    // No cursor is full line</div><div class="diff-removed">-    {</div><div class="diff-removed">-        // Get our run iterator</div><div class="diff-removed">-        var shaper = &testdata.shaper;</div><div class="diff-removed">-        var it = shaper.runIterator(</div><div class="diff-removed">-            testdata.grid,</div><div class="diff-removed">-            &screen,</div><div class="diff-removed">-            screen.pages.pin(.{ .screen = .{ .y = 0 } }).?,</div><div class="diff-removed">-            null,</div><div class="diff-removed">-            null,</div><div class="diff-removed">-        );</div><div class="diff-removed">-        var count: usize = 0;</div><div class="diff-removed">-        while (try it.next(alloc)) |run| {</div><div class="diff-removed">-            count += 1;</div><div class="diff-removed">-            _ = try shaper.shape(run);</div><div class="diff-removed">-        }</div><div class="diff-removed">-        try testing.expectEqual(@as(usize, 1), count);</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    // Cursor on emoji does not split it</div><div class="diff-removed">-    {</div><div class="diff-removed">-        // Get our run iterator</div><div class="diff-removed">-        var shaper = &testdata.shaper;</div><div class="diff-removed">-        var it = shaper.runIterator(</div><div class="diff-removed">-            testdata.grid,</div><div class="diff-removed">-            &screen,</div><div class="diff-removed">-            screen.pages.pin(.{ .screen = .{ .y = 0 } }).?,</div><div class="diff-removed">-            null,</div><div class="diff-removed">-            0,</div><div class="diff-removed">-        );</div><div class="diff-removed">-        var count: usize = 0;</div><div class="diff-removed">-        while (try it.next(alloc)) |run| {</div><div class="diff-removed">-            count += 1;</div><div class="diff-removed">-            _ = try shaper.shape(run);</div><div class="diff-removed">-        }</div><div class="diff-removed">-        try testing.expectEqual(@as(usize, 1), count);</div><div class="diff-removed">-    }</div><div class="diff-removed">-    {</div><div class="diff-removed">-        // Get our run iterator</div><div class="diff-removed">-        var shaper = &testdata.shaper;</div><div class="diff-removed">-        var it = shaper.runIterator(</div><div class="diff-removed">-            testdata.grid,</div><div class="diff-removed">-            &screen,</div><div class="diff-removed">-            screen.pages.pin(.{ .screen = .{ .y = 0 } }).?,</div><div class="diff-removed">-            null,</div><div class="diff-removed">-            1,</div><div class="diff-removed">-        );</div><div class="diff-removed">-        var count: usize = 0;</div><div class="diff-removed">-        while (try it.next(alloc)) |run| {</div><div class="diff-removed">-            count += 1;</div><div class="diff-removed">-            _ = try shaper.shape(run);</div><div class="diff-removed">-        }</div><div class="diff-removed">-        try testing.expectEqual(@as(usize, 1), count);</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-test "shape cell attribute change" {</div><div class="diff-removed">-    const testing = std.testing;</div><div class="diff-removed">-    const alloc = testing.allocator;</div><div class="diff-removed">-</div><div class="diff-removed">-    var testdata = try testShaper(alloc);</div><div class="diff-removed">-    defer testdata.deinit();</div><div class="diff-removed">-</div><div class="diff-removed">-    // Plain >= should shape into 1 run</div><div class="diff-removed">-    {</div><div class="diff-removed">-        var screen = try terminal.Screen.init(alloc, 10, 3, 0);</div><div class="diff-removed">-        defer screen.deinit();</div><div class="diff-removed">-        try screen.testWriteString(">=");</div><div class="diff-removed">-</div><div class="diff-removed">-        var shaper = &testdata.shaper;</div><div class="diff-removed">-        var it = shaper.runIterator(</div><div class="diff-removed">-            testdata.grid,</div><div class="diff-removed">-            &screen,</div><div class="diff-removed">-            screen.pages.pin(.{ .screen = .{ .y = 0 } }).?,</div><div class="diff-removed">-            null,</div><div class="diff-removed">-            null,</div><div class="diff-removed">-        );</div><div class="diff-removed">-        var count: usize = 0;</div><div class="diff-removed">-        while (try it.next(alloc)) |run| {</div><div class="diff-removed">-            count += 1;</div><div class="diff-removed">-            _ = try shaper.shape(run);</div><div class="diff-removed">-        }</div><div class="diff-removed">-        try testing.expectEqual(@as(usize, 1), count);</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    // Bold vs regular should split</div><div class="diff-removed">-    {</div><div class="diff-removed">-        var screen = try terminal.Screen.init(alloc, 3, 10, 0);</div><div class="diff-removed">-        defer screen.deinit();</div><div class="diff-removed">-        try screen.testWriteString(">");</div><div class="diff-removed">-        try screen.setAttribute(.{ .bold = {} });</div><div class="diff-removed">-        try screen.testWriteString("=");</div><div class="diff-removed">-</div><div class="diff-removed">-        var shaper = &testdata.shaper;</div><div class="diff-removed">-        var it = shaper.runIterator(</div><div class="diff-removed">-            testdata.grid,</div><div class="diff-removed">-            &screen,</div><div class="diff-removed">-            screen.pages.pin(.{ .screen = .{ .y = 0 } }).?,</div><div class="diff-removed">-            null,</div><div class="diff-removed">-            null,</div><div class="diff-removed">-        );</div><div class="diff-removed">-        var count: usize = 0;</div><div class="diff-removed">-        while (try it.next(alloc)) |run| {</div><div class="diff-removed">-            count += 1;</div><div class="diff-removed">-            _ = try shaper.shape(run);</div><div class="diff-removed">-        }</div><div class="diff-removed">-        try testing.expectEqual(@as(usize, 2), count);</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    // Changing fg color should split</div><div class="diff-removed">-    {</div><div class="diff-removed">-        var screen = try terminal.Screen.init(alloc, 3, 10, 0);</div><div class="diff-removed">-        defer screen.deinit();</div><div class="diff-removed">-        try screen.setAttribute(.{ .direct_color_fg = .{ .r = 1, .g = 2, .b = 3 } });</div><div class="diff-removed">-        try screen.testWriteString(">");</div><div class="diff-removed">-        try screen.setAttribute(.{ .direct_color_fg = .{ .r = 3, .g = 2, .b = 1 } });</div><div class="diff-removed">-        try screen.testWriteString("=");</div><div class="diff-removed">-</div><div class="diff-removed">-        var shaper = &testdata.shaper;</div><div class="diff-removed">-        var it = shaper.runIterator(</div><div class="diff-removed">-            testdata.grid,</div><div class="diff-removed">-            &screen,</div><div class="diff-removed">-            screen.pages.pin(.{ .screen = .{ .y = 0 } }).?,</div><div class="diff-removed">-            null,</div><div class="diff-removed">-            null,</div><div class="diff-removed">-        );</div><div class="diff-removed">-        var count: usize = 0;</div><div class="diff-removed">-        while (try it.next(alloc)) |run| {</div><div class="diff-removed">-            count += 1;</div><div class="diff-removed">-            _ = try shaper.shape(run);</div><div class="diff-removed">-        }</div><div class="diff-removed">-        try testing.expectEqual(@as(usize, 2), count);</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    // Changing bg color should not split</div><div class="diff-removed">-    {</div><div class="diff-removed">-        var screen = try terminal.Screen.init(alloc, 3, 10, 0);</div><div class="diff-removed">-        defer screen.deinit();</div><div class="diff-removed">-        try screen.setAttribute(.{ .direct_color_bg = .{ .r = 1, .g = 2, .b = 3 } });</div><div class="diff-removed">-        try screen.testWriteString(">");</div><div class="diff-removed">-        try screen.setAttribute(.{ .direct_color_bg = .{ .r = 3, .g = 2, .b = 1 } });</div><div class="diff-removed">-        try screen.testWriteString("=");</div><div class="diff-removed">-</div><div class="diff-removed">-        var shaper = &testdata.shaper;</div><div class="diff-removed">-        var it = shaper.runIterator(</div><div class="diff-removed">-            testdata.grid,</div><div class="diff-removed">-            &screen,</div><div class="diff-removed">-            screen.pages.pin(.{ .screen = .{ .y = 0 } }).?,</div><div class="diff-removed">-            null,</div><div class="diff-removed">-            null,</div><div class="diff-removed">-        );</div><div class="diff-removed">-        var count: usize = 0;</div><div class="diff-removed">-        while (try it.next(alloc)) |run| {</div><div class="diff-removed">-            count += 1;</div><div class="diff-removed">-            _ = try shaper.shape(run);</div><div class="diff-removed">-        }</div><div class="diff-removed">-        try testing.expectEqual(@as(usize, 1), count);</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    // Same bg color should not split</div><div class="diff-removed">-    {</div><div class="diff-removed">-        var screen = try terminal.Screen.init(alloc, 3, 10, 0);</div><div class="diff-removed">-        defer screen.deinit();</div><div class="diff-removed">-        try screen.setAttribute(.{ .direct_color_bg = .{ .r = 1, .g = 2, .b = 3 } });</div><div class="diff-removed">-        try screen.testWriteString(">");</div><div class="diff-removed">-        try screen.testWriteString("=");</div><div class="diff-removed">-</div><div class="diff-removed">-        var shaper = &testdata.shaper;</div><div class="diff-removed">-        var it = shaper.runIterator(</div><div class="diff-removed">-            testdata.grid,</div><div class="diff-removed">-            &screen,</div><div class="diff-removed">-            screen.pages.pin(.{ .screen = .{ .y = 0 } }).?,</div><div class="diff-removed">-            null,</div><div class="diff-removed">-            null,</div><div class="diff-removed">-        );</div><div class="diff-removed">-        var count: usize = 0;</div><div class="diff-removed">-        while (try it.next(alloc)) |run| {</div><div class="diff-removed">-            count += 1;</div><div class="diff-removed">-            _ = try shaper.shape(run);</div><div class="diff-removed">-        }</div><div class="diff-removed">-        try testing.expectEqual(@as(usize, 1), count);</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-const TestShaper = struct {</div><div class="diff-removed">-    alloc: Allocator,</div><div class="diff-removed">-    shaper: Shaper,</div><div class="diff-removed">-    grid: *SharedGrid,</div><div class="diff-removed">-    lib: Library,</div><div class="diff-removed">-</div><div class="diff-removed">-    pub fn deinit(self: *TestShaper) void {</div><div class="diff-removed">-        self.shaper.deinit();</div><div class="diff-removed">-        self.grid.deinit(self.alloc);</div><div class="diff-removed">-        self.alloc.destroy(self.grid);</div><div class="diff-removed">-        self.lib.deinit();</div><div class="diff-removed">-    }</div><div class="diff-removed">-};</div><div class="diff-removed">-</div><div class="diff-removed">-const TestFont = enum {</div><div class="diff-removed">-    inconsolata,</div><div class="diff-removed">-    monaspace_neon,</div><div class="diff-removed">-    arabic,</div><div class="diff-removed">-};</div><div class="diff-removed">-</div><div class="diff-removed">-/// Helper to return a fully initialized shaper.</div><div class="diff-removed">-fn testShaper(alloc: Allocator) !TestShaper {</div><div class="diff-removed">-    return try testShaperWithFont(alloc, .inconsolata);</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-fn testShaperWithFont(alloc: Allocator, font_req: TestFont) !TestShaper {</div><div class="diff-removed">-    const testEmoji = font.embedded.emoji;</div><div class="diff-removed">-    const testEmojiText = font.embedded.emoji_text;</div><div class="diff-removed">-    const testFont = switch (font_req) {</div><div class="diff-removed">-        .inconsolata => font.embedded.inconsolata,</div><div class="diff-removed">-        .monaspace_neon => font.embedded.monaspace_neon,</div><div class="diff-removed">-        .arabic => font.embedded.arabic,</div><div class="diff-removed">-    };</div><div class="diff-removed">-</div><div class="diff-removed">-    var lib = try Library.init();</div><div class="diff-removed">-    errdefer lib.deinit();</div><div class="diff-removed">-</div><div class="diff-removed">-    var c = Collection.init();</div><div class="diff-removed">-    c.load_options = .{ .library = lib };</div><div class="diff-removed">-</div><div class="diff-removed">-    // Setup group</div><div class="diff-removed">-    _ = try c.add(alloc, .regular, .{ .loaded = try Face.init(</div><div class="diff-removed">-        lib,</div><div class="diff-removed">-        testFont,</div><div class="diff-removed">-        .{ .size = .{ .points = 12 } },</div><div class="diff-removed">-    ) });</div><div class="diff-removed">-</div><div class="diff-removed">-    if (comptime !font.options.backend.hasCoretext()) {</div><div class="diff-removed">-        // Coretext doesn't support Noto's format</div><div class="diff-removed">-        _ = try c.add(alloc, .regular, .{ .loaded = try Face.init(</div><div class="diff-removed">-            lib,</div><div class="diff-removed">-            testEmoji,</div><div class="diff-removed">-            .{ .size = .{ .points = 12 } },</div><div class="diff-removed">-        ) });</div><div class="diff-removed">-    } else {</div><div class="diff-removed">-        // On CoreText we want to load Apple Emoji, we should have it.</div><div class="diff-removed">-        var disco = font.Discover.init();</div><div class="diff-removed">-        defer disco.deinit();</div><div class="diff-removed">-        var disco_it = try disco.discover(alloc, .{</div><div class="diff-removed">-            .family = "Apple Color Emoji",</div><div class="diff-removed">-            .size = 12,</div><div class="diff-removed">-            .monospace = false,</div><div class="diff-removed">-        });</div><div class="diff-removed">-        defer disco_it.deinit();</div><div class="diff-removed">-        var face = (try disco_it.next()).?;</div><div class="diff-removed">-        errdefer face.deinit();</div><div class="diff-removed">-        _ = try c.add(alloc, .regular, .{ .deferred = face });</div><div class="diff-removed">-    }</div><div class="diff-removed">-    _ = try c.add(alloc, .regular, .{ .loaded = try Face.init(</div><div class="diff-removed">-        lib,</div><div class="diff-removed">-        testEmojiText,</div><div class="diff-removed">-        .{ .size = .{ .points = 12 } },</div><div class="diff-removed">-    ) });</div><div class="diff-removed">-</div><div class="diff-removed">-    const grid_ptr = try alloc.create(SharedGrid);</div><div class="diff-removed">-    errdefer alloc.destroy(grid_ptr);</div><div class="diff-removed">-    grid_ptr.* = try SharedGrid.init(alloc, .{ .collection = c });</div><div class="diff-removed">-    errdefer grid_ptr.*.deinit(alloc);</div><div class="diff-removed">-</div><div class="diff-removed">-    var shaper = try Shaper.init(alloc, .{});</div><div class="diff-removed">-    errdefer shaper.deinit();</div><div class="diff-removed">-</div><div class="diff-removed">-    return TestShaper{</div><div class="diff-removed">-        .alloc = alloc,</div><div class="diff-removed">-        .shaper = shaper,</div><div class="diff-removed">-        .grid = grid_ptr,</div><div class="diff-removed">-        .lib = lib,</div><div class="diff-removed">-    };</div><div class="diff-removed">-}</div><div>\ No newline at end of file</div><div class="diff-added">+    var screen = try terminal.Screen</div><div>\ No newline at end of file</div><div></div></pre>
                </div>
            </div>
        </section>
    </main>
    <footer>
        <p>LoCoDiff-bench - <a href="https://github.com/AbanteAI/LoCoDiff-bench">GitHub Repository</a></p>
    </footer>
</body>
</html>
    