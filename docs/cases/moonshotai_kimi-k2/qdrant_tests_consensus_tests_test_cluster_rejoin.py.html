<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case: tests/consensus_tests/test_cluster_rejoin.py - Kimi K2</title>
    <link rel="stylesheet" href="../../styles.css">
</head>
<body>
    <header>
        <h1>Case: tests/consensus_tests/test_cluster_rejoin.py</h1>
        <h2>Model: Kimi K2</h2>
        <p><a href="../../models/moonshotai_kimi-k2.html">All Kimi K2 Cases</a> | <a href="../../cases.html">All Cases</a> | <a href="../../index.html">Home</a></p>
    </header>
    <main>
        <section class="case-details">
            <div class="case-info">
                <h2>Benchmark Case Information</h2>
                <p><strong>Model:</strong> Kimi K2</p>
                <p><strong>Status:</strong> <span class="failure">Failure</span></p>
                <p><strong>Prompt Tokens:</strong> 7673</p>
                <p><strong>Native Prompt Tokens:</strong> 7622</p>
                <p><strong>Native Completion Tokens:</strong> 3255</p>
                <p><strong>Native Tokens Reasoning:</strong> 0</p>
                <p><strong>Native Finish Reason:</strong> stop</p>
                <p><strong>Cost:</strong> $0.01183104</p>
            </div>
            
            <div class="content-links">
                <h2>View Content</h2>
                <ul>
                    <li><a href="../../content/moonshotai_kimi-k2/qdrant_tests_consensus_tests_test_cluster_rejoin.py/prompt.html" class="content-link">View Prompt</a></li>
                    <li><a href="../../content/moonshotai_kimi-k2/qdrant_tests_consensus_tests_test_cluster_rejoin.py/expected.html" class="content-link">View Expected Output</a></li>
                    <li><a href="../../content/moonshotai_kimi-k2/qdrant_tests_consensus_tests_test_cluster_rejoin.py/actual.html" class="content-link">View Actual Output</a></li>
                </ul>
            </div>
            
            <div class="diff-section">
                <h2>Diff (Expected vs Actual)</h2>
                <div id="diff-output">
                    <pre class="diff"><div></div><div>index 95fb168d6..79971306e 100644</div><div class="diff-header">--- a/qdrant_tests_consensus_tests_test_cluster_rejoin.py_expectedoutput.txt (expected):tmp/tmptzbuu914_expected.txt	</div><div class="diff-header">+++ b/qdrant_tests_consensus_tests_test_cluster_rejoin.py_extracted.txt (actual):tmp/tmpqv2orsd1_actual.txt	</div><div class="diff-info">@@ -6,6 +6,8 @@ from typing import Any</div><div> </div><div> from consensus_tests.fixtures import create_collection, upsert_random_points, drop_collection</div><div> import requests</div><div class="diff-added">+import pytest</div><div class="diff-added">+import json</div><div> from .utils import *</div><div> </div><div> N_PEERS = 3</div><div class="diff-info">@@ -100,6 +102,7 @@ def test_rejoin_origin_from_wal(tmp_path: pathlib.Path):</div><div> </div><div>     rejoin_cluster_test(tmp_path, start_cluster, overwrite_first_voter)</div><div> </div><div class="diff-added">+</div><div> def test_rejoin_origin_from_state(tmp_path: pathlib.Path):</div><div>     """</div><div>     This test checks that Qdrant persists origin peer ID (`first_voter` field in `raft_state.json`)</div><div class="diff-info">@@ -253,50 +256,6 @@ def rejoin_cluster_test(</div><div>     info = get_collection_cluster_info(new_peer_uri, collection)</div><div>     assert len(info["remote_shards"]) == expected_shards</div><div> </div><div class="diff-removed">-def start_preconfigured_cluster(tmp_path: pathlib.Path, peers: int = 3):</div><div class="diff-removed">-    assert_project_root()</div><div class="diff-removed">-</div><div class="diff-removed">-    # Collect peer URIs</div><div class="diff-removed">-    peer_uris = []</div><div class="diff-removed">-</div><div class="diff-removed">-    # Create peer directories</div><div class="diff-removed">-    peer_dirs = make_peer_folders(tmp_path, peers)</div><div class="diff-removed">-</div><div class="diff-removed">-    # Copy first peer Raft state and WAL from `test_cluster_rejoin_data`.</div><div class="diff-removed">-    #</div><div class="diff-removed">-    # It's just an "empty" peer, but its peer ID is *not* committed into WAL. We can use this peer to</div><div class="diff-removed">-    # test that first peer ID is correctly recovered/propagated, even when it's not committed into WAL.</div><div class="diff-removed">-    shutil.copytree("tests/consensus_tests/test_cluster_rejoin_data", f"{peer_dirs[0]}/storage")</div><div class="diff-removed">-</div><div class="diff-removed">-    # Modify peer URI in Raft state to prevent URI change on startup ðŸ™„</div><div class="diff-removed">-    p2p_port = get_port()</div><div class="diff-removed">-    grpc_port = get_port()</div><div class="diff-removed">-    http_port = get_port()</div><div class="diff-removed">-</div><div class="diff-removed">-    with open(f"{peer_dirs[0]}/storage/raft_state.json", "r+") as file:</div><div class="diff-removed">-        state = json.load(file)</div><div class="diff-removed">-</div><div class="diff-removed">-        state["peer_address_by_id"][str(state["this_peer_id"])] = f"http://127.0.0.1:{p2p_port}"</div><div class="diff-removed">-</div><div class="diff-removed">-        file.seek(0, io.SEEK_SET)</div><div class="diff-removed">-        file.truncate()</div><div class="diff-removed">-        json.dump(state, file)</div><div class="diff-removed">-</div><div class="diff-removed">-    # Start first peer</div><div class="diff-removed">-    first_peer_uri, bootstrap_uri = start_first_peer(peer_dirs[0], "peer_0_0.log", p2p_port)</div><div class="diff-removed">-    peer_uris.append(first_peer_uri)</div><div class="diff-removed">-</div><div class="diff-removed">-    wait_for_peer_online(first_peer_uri)</div><div class="diff-removed">-</div><div class="diff-removed">-    # Bootstrap other peers</div><div class="diff-removed">-    for peer_idx in range(1, peers):</div><div class="diff-removed">-        peer_uri = start_peer(peer_dirs[peer_idx], f"peer_0_{peer_idx}.log", bootstrap_uri)</div><div class="diff-removed">-        peer_uris.append(peer_uri)</div><div class="diff-removed">-</div><div class="diff-removed">-    wait_all_peers_up(peer_uris)</div><div class="diff-removed">-</div><div class="diff-removed">-    return peer_uris, peer_dirs, bootstrap_uri</div><div class="diff-removed">-</div><div> </div><div> def move_all_shards_from_peer(peer_uri: str, collection: str = "test_collection") -> tuple[int, int]:</div><div>     """</div><div class="diff-info">@@ -354,4 +313,48 @@ def add_new_peer(tmp_path: pathlib.Path, peer_idx: int, bootstrap_uri: str, coll</div><div>     if collection is not None:</div><div>         wait_collection_on_all_peers(collection, [peer_uri])</div><div> </div><div class="diff-removed">-    return peer_uri, peer_dir</div><div>\ No newline at end of file</div><div class="diff-added">+    return peer_uri, peer_dir</div><div class="diff-added">+</div><div class="diff-added">+def start_preconfigured_cluster(tmp_path: pathlib.Path, peers: int = 3):</div><div class="diff-added">+    assert_project_root()</div><div class="diff-added">+</div><div class="diff-added">+    # Collect peer URIs</div><div class="diff-added">+    peer_uris = []</div><div class="diff-added">+</div><div class="diff-added">+    # Create peer directories</div><div class="diff-added">+    peer_dirs = make_peer_folders(tmp_path, peers)</div><div class="diff-added">+</div><div class="diff-added">+    # Copy first peer Raft state and WAL from `test_cluster_rejoin_data`.</div><div class="diff-added">+    #</div><div class="diff-added">+    # It's just an "empty" peer, but its peer ID is *not* committed into WAL. We can use this peer to</div><div class="diff-added">+    # test that first peer ID is correctly recovered/propagated, even when it's not committed into WAL.</div><div class="diff-added">+    shutil.copytree("tests/consensus_tests/test_cluster_rejoin_data", f"{peer_dirs[0]}/storage")</div><div class="diff-added">+</div><div class="diff-added">+    # Modify peer URI in Raft state to prevent URI change on startup ðŸ™„</div><div class="diff-added">+    p2p_port = get_port()</div><div class="diff-added">+    grpc_port = get_port()</div><div class="diff-added">+    http_port = get_port()</div><div class="diff-added">+</div><div class="diff-added">+    with open(f"{peer_dirs[0]}/storage/raft_state.json", "r+") as file:</div><div class="diff-added">+        state = json.load(file)</div><div class="diff-added">+</div><div class="diff-added">+        state["peer_address_by_id"][str(state["this_peer_id"])] = f"http://127.0.0.1:{p2p_port}"</div><div class="diff-added">+</div><div class="diff-added">+        file.seek(0, io.SEEK_SET)</div><div class="diff-added">+        file.truncate()</div><div class="diff-added">+        json.dump(state, file)</div><div class="diff-added">+</div><div class="diff-added">+    # Start first peer</div><div class="diff-added">+    first_peer_uri, bootstrap_uri = start_first_peer(peer_dirs[0], "peer_0_0.log", p2p_port)</div><div class="diff-added">+    peer_uris.append(first_peer_uri)</div><div class="diff-added">+</div><div class="diff-added">+    wait_for_peer_online(first_peer_uri)</div><div class="diff-added">+</div><div class="diff-added">+    # Bootstrap other peers</div><div class="diff-added">+    for peer_idx in range(1, peers):</div><div class="diff-added">+        peer_uri = start_peer(peer_dirs[peer_idx], f"peer_0_{peer_idx}.log", bootstrap_uri)</div><div class="diff-added">+        peer_uris.append(peer_uri)</div><div class="diff-added">+</div><div class="diff-added">+    wait_all_peers_up(peer_uris)</div><div class="diff-added">+</div><div class="diff-added">+    return peer_uris, peer_dirs, bootstrap_uri</div><div>\ No newline at end of file</div><div></div></pre>
                </div>
            </div>
        </section>
    </main>
    <footer>
        <p>LoCoDiff-bench - <a href="https://github.com/AbanteAI/LoCoDiff-bench">GitHub Repository</a></p>
    </footer>
</body>
</html>
    