<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case: src/apprt/glfw.zig - Kimi K2</title>
    <link rel="stylesheet" href="../../styles.css">
</head>
<body>
    <header>
        <h1>Case: src/apprt/glfw.zig</h1>
        <h2>Model: Kimi K2</h2>
        <p><a href="../../models/moonshotai_kimi-k2.html">All Kimi K2 Cases</a> | <a href="../../cases.html">All Cases</a> | <a href="../../index.html">Home</a></p>
    </header>
    <main>
        <section class="case-details">
            <div class="case-info">
                <h2>Benchmark Case Information</h2>
                <p><strong>Model:</strong> Kimi K2</p>
                <p><strong>Status:</strong> <span class="failure">Failure</span></p>
                <p><strong>Prompt Tokens:</strong> 62392</p>
                <p><strong>Native Prompt Tokens:</strong> 63083</p>
                <p><strong>Native Completion Tokens:</strong> 10053</p>
                <p><strong>Native Tokens Reasoning:</strong> 0</p>
                <p><strong>Native Finish Reason:</strong> stop</p>
                <p><strong>Cost:</strong> $0.05907921</p>
            </div>
            
            <div class="content-links">
                <h2>View Content</h2>
                <ul>
                    <li><a href="../../content/moonshotai_kimi-k2/ghostty_src_apprt_glfw.zig/prompt.html" class="content-link">View Prompt</a></li>
                    <li><a href="../../content/moonshotai_kimi-k2/ghostty_src_apprt_glfw.zig/expected.html" class="content-link">View Expected Output</a></li>
                    <li><a href="../../content/moonshotai_kimi-k2/ghostty_src_apprt_glfw.zig/actual.html" class="content-link">View Actual Output</a></li>
                </ul>
            </div>
            
            <div class="diff-section">
                <h2>Diff (Expected vs Actual)</h2>
                <div id="diff-output">
                    <pre class="diff"><div></div><div>index afd17d617..4677972b8 100644</div><div class="diff-header">--- a/ghostty_src_apprt_glfw.zig_expectedoutput.txt (expected):tmp/tmpjln_78hw_expected.txt	</div><div class="diff-header">+++ b/ghostty_src_apprt_glfw.zig_extracted.txt (actual):tmp/tmpgatgiu17_actual.txt	</div><div class="diff-info">@@ -147,7 +147,6 @@ pub const App = struct {</div><div> </div><div>     /// Wakeup the event loop. This should be able to be called from any thread.</div><div>     pub fn wakeup(self: *const App) void {</div><div class="diff-removed">-        _ = self;</div><div>         glfw.postEmptyEvent();</div><div>     }</div><div> </div><div class="diff-info">@@ -191,6 +190,14 @@ pub const App = struct {</div><div>                 ),</div><div>             },</div><div> </div><div class="diff-added">+            .initial_position => switch (target) {</div><div class="diff-added">+                .app => {},</div><div class="diff-added">+                .surface => |surface| try surface.rt_surface.setInitialWindowPosition(</div><div class="diff-added">+                    value.x,</div><div class="diff-added">+                    value.y,</div><div class="diff-added">+                ),</div><div class="diff-added">+            },</div><div class="diff-added">+</div><div>             .toggle_fullscreen => self.toggleFullscreen(target),</div><div> </div><div>             .open_config => try configpkg.edit.open(self.app.alloc),</div><div class="diff-info">@@ -223,8 +230,8 @@ pub const App = struct {</div><div>             .toggle_split_zoom,</div><div>             .present_terminal,</div><div>             .close_all_windows,</div><div class="diff-removed">-            .close_window,</div><div>             .close_tab,</div><div class="diff-added">+            .close_window,</div><div>             .toggle_tab_overview,</div><div>             .toggle_window_decorations,</div><div>             .toggle_quick_terminal,</div><div class="diff-info">@@ -236,7 +243,6 @@ pub const App = struct {</div><div>             .render_inspector,</div><div>             .quit_timer,</div><div>             .secure_input,</div><div class="diff-removed">-            .key_sequence,</div><div>             .desktop_notification,</div><div>             .mouse_over_link,</div><div>             .cell_size,</div><div class="diff-info">@@ -342,6 +348,26 @@ pub const App = struct {</div><div>         win.setMonitor(monitor, 0, 0, video_mode.getWidth(), video_mode.getHeight(), 0);</div><div>     }</div><div> </div><div class="diff-added">+    /// Create a new window for the app.</div><div class="diff-added">+    fn newSurface(self: *App, parent_: ?*CoreSurface) !*Surface {</div><div class="diff-added">+        // Grab a surface allocation because we're going to need it.</div><div class="diff-added">+        var surface = try self.app.alloc.create(Surface);</div><div class="diff-added">+        errdefer self.app.alloc.destroy(surface);</div><div class="diff-added">+</div><div class="diff-added">+        // Create the surface -- because windows are surfaces for glfw.</div><div class="diff-added">+        try surface.init(self);</div><div class="diff-added">+        errdefer surface.deinit();</div><div class="diff-added">+</div><div class="diff-added">+        // If we have a parent, inherit some properties</div><div class="diff-added">+        if (self.config.@"window-inherit-font-size") {</div><div class="diff-added">+            if (parent_) |parent| {</div><div class="diff-added">+                try surface.core_surface.setFontSize(parent.font_size);</div><div class="diff-added">+            }</div><div class="diff-added">+        }</div><div class="diff-added">+</div><div class="diff-added">+        return surface;</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div>     /// Create a new tab in the parent surface.</div><div>     fn newTab(self: *App, parent_: ?*CoreSurface) !void {</div><div>         if (comptime !darwin_enabled) {</div><div class="diff-info">@@ -381,25 +407,6 @@ pub const App = struct {</div><div>         };</div><div>     }</div><div> </div><div class="diff-removed">-    fn newSurface(self: *App, parent_: ?*CoreSurface) !*Surface {</div><div class="diff-removed">-        // Grab a surface allocation because we're going to need it.</div><div class="diff-removed">-        var surface = try self.app.alloc.create(Surface);</div><div class="diff-removed">-        errdefer self.app.alloc.destroy(surface);</div><div class="diff-removed">-</div><div class="diff-removed">-        // Create the surface -- because windows are surfaces for glfw.</div><div class="diff-removed">-        try surface.init(self);</div><div class="diff-removed">-        errdefer surface.deinit();</div><div class="diff-removed">-</div><div class="diff-removed">-        // If we have a parent, inherit some properties</div><div class="diff-removed">-        if (self.config.@"window-inherit-font-size") {</div><div class="diff-removed">-            if (parent_) |parent| {</div><div class="diff-removed">-                try surface.core_surface.setFontSize(parent.font_size);</div><div class="diff-removed">-            }</div><div class="diff-removed">-        }</div><div class="diff-removed">-</div><div class="diff-removed">-        return surface;</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div>     /// Close the given surface.</div><div>     pub fn closeSurface(self: *App, surface: *Surface) void {</div><div>         surface.deinit();</div><div class="diff-info">@@ -420,20 +427,6 @@ pub const App = struct {</div><div>         // GLFW doesn't support the inspector</div><div>     }</div><div> </div><div class="diff-removed">-    fn glfwErrorCallback(code: glfw.ErrorCode, desc: [:0]const u8) void {</div><div class="diff-removed">-        std.log.warn("glfw error={} message={s}", .{ code, desc });</div><div class="diff-removed">-</div><div class="diff-removed">-        // Workaround for: https://github.com/ocornut/imgui/issues/5908</div><div class="diff-removed">-        // If we get an invalid value with "scancode" in the message we assume</div><div class="diff-removed">-        // it is from the glfw key callback that imgui sets and we clear the</div><div class="diff-removed">-        // error so that our future code doesn't crash.</div><div class="diff-removed">-        if (code == glfw.ErrorCode.InvalidValue and</div><div class="diff-removed">-            std.mem.indexOf(u8, desc, "scancode") != null)</div><div class="diff-removed">-        {</div><div class="diff-removed">-            _ = glfw.getError();</div><div class="diff-removed">-        }</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div>     pub fn keyboardLayout(self: *const App) input.KeyboardLayout {</div><div>         _ = self;</div><div> </div><div class="diff-info">@@ -468,6 +461,20 @@ pub const App = struct {</div><div>             self.* = undefined;</div><div>         }</div><div>     };</div><div class="diff-added">+</div><div class="diff-added">+    fn glfwErrorCallback(code: glfw.ErrorCode, desc: [:0]const u8) void {</div><div class="diff-added">+        std.log.warn("glfw error={} message={s}", .{ code, desc });</div><div class="diff-added">+</div><div class="diff-added">+        // Workaround for: https://github.com/ocornut/imgui/issues/5908</div><div class="diff-added">+        // If we get an invalid value with "scancode" in the message we assume</div><div class="diff-added">+        // it is from the glfw key callback that imgui sets and we clear the</div><div class="diff-added">+        // error so that our future code doesn't crash.</div><div class="diff-added">+        if (code == glfw.ErrorCode.InvalidValue and</div><div class="diff-added">+            std.mem.indexOf(u8, desc, "scancode") != null)</div><div class="diff-added">+        {</div><div class="diff-added">+            _ = glfw.getError();</div><div class="diff-added">+        }</div><div class="diff-added">+    }</div><div> };</div><div> </div><div> /// These are used to keep track of the original monitor values so that we can</div><div class="diff-info">@@ -545,7 +552,7 @@ pub const Surface = struct {</div><div>         if (builtin.mode == .Debug) {</div><div>             const monitor = win.getMonitor() orelse monitor: {</div><div>                 log.warn("window had null monitor, getting primary monitor", .{});</div><div class="diff-removed">-                break :monitor glfw.Monitor.getPrimary().?;</div><div class="diff-added">+                break :monitor glfw.Monitor.getPrimary()?;</div><div>             };</div><div>             const video_mode = monitor.getVideoMode() orelse return glfw.mustGetErrorCode();</div><div>             const physical_size = monitor.getPhysicalSize();</div><div class="diff-info">@@ -677,10 +684,21 @@ pub const Surface = struct {</div><div>         self.app.app.alloc.destroy(self);</div><div>     }</div><div> </div><div class="diff-added">+    /// Set the flag that notes this window should be closed for the next</div><div class="diff-added">+    /// iteration of the event loop.</div><div class="diff-added">+    pub fn setShouldClose(self: *Surface) void {</div><div class="diff-added">+        self.window.setShouldClose(true);</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    /// Returns true if the window is flagged to close.</div><div class="diff-added">+    pub fn shouldClose(self: *const Surface) bool {</div><div class="diff-added">+        return self.window.shouldClose();</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div>     /// Set the initial window size. This is called exactly once at</div><div>     /// surface initialization time. This may be called before "self"</div><div>     /// is fully initialized.</div><div class="diff-removed">-    fn setInitialWindowSize(self: *const Surface, width: u32, height: u32) !void {</div><div class="diff-added">+    pub fn setInitialWindowSize(self: *const Surface, width: u32, height: u32) !void {</div><div>         const monitor = self.window.getMonitor() orelse glfw.Monitor.getPrimary() orelse {</div><div>             log.warn("window is not on a monitor, not setting initial size", .{});</div><div>             return;</div><div class="diff-info">@@ -746,27 +764,51 @@ pub const Surface = struct {</div><div>         };</div><div>     }</div><div> </div><div class="diff-removed">-    /// Set the flag that notes this window should be closed for the next</div><div class="diff-removed">-    /// iteration of the event loop.</div><div class="diff-removed">-    pub fn setShouldClose(self: *Surface) void {</div><div class="diff-removed">-        self.window.setShouldClose(true);</div><div class="diff-removed">-    }</div><div class="diff-added">+    /// Start an async clipboard request.</div><div class="diff-added">+    pub fn clipboardRequest(</div><div class="diff-added">+        self: *Surface,</div><div class="diff-added">+        clipboard_type: apprt.Clipboard,</div><div class="diff-added">+        state: apprt.ClipboardRequest,</div><div class="diff-added">+    ) !void {</div><div class="diff-added">+        // GLFW can read clipboards immediately so just do that.</div><div class="diff-added">+        const str: [:0]const u8 = switch (clipboard_type) {</div><div class="diff-added">+            .standard => glfw.getClipboardString() orelse return glfw.mustGetErrorCode(),</div><div class="diff-added">+            .selection, .primary => selection: {</div><div class="diff-added">+                // Not supported except on Linux</div><div class="diff-added">+                if (comptime builtin.os.tag != .linux) break :selection "";</div><div> </div><div class="diff-removed">-    /// Returns true if the window is flagged to close.</div><div class="diff-removed">-    pub fn shouldClose(self: *const Surface) bool {</div><div class="diff-removed">-        return self.window.shouldClose();</div><div class="diff-added">+                const raw = glfwNative.getX11SelectionString() orelse</div><div class="diff-added">+                    return glfw.mustGetErrorCode();</div><div class="diff-added">+                break :selection std.mem.span(raw);</div><div class="diff-added">+            },</div><div class="diff-added">+        };</div><div class="diff-added">+</div><div class="diff-added">+        // Complete our request. We always allow unsafe because we don't</div><div class="diff-added">+        // want to deal with user confirmation in this runtime.</div><div class="diff-added">+        try self.core_surface.completeClipboardRequest(state, str, true);</div><div>     }</div><div> </div><div class="diff-removed">-    /// Set the title of the window.</div><div class="diff-removed">-    fn setTitle(self: *Surface, slice: [:0]const u8) !void {</div><div class="diff-removed">-        if (self.title_text) |t| self.core_surface.alloc.free(t);</div><div class="diff-removed">-        self.title_text = try self.core_surface.alloc.dupeZ(u8, slice);</div><div class="diff-removed">-        self.window.setTitle(self.title_text.?.ptr);</div><div class="diff-added">+    /// Set the clipboard.</div><div class="diff-added">+    pub fn setClipboardString(</div><div class="diff-added">+        self: *Surface,</div><div class="diff-added">+        val: [:0]const u8,</div><div class="diff-added">+        clipboard_type: apprt.Clipboard,</div><div class="diff-added">+        confirm: bool,</div><div class="diff-added">+    ) !void {</div><div class="diff-added">+        _ = confirm;</div><div class="diff-added">+        switch (clipboard_type) {</div><div class="diff-added">+            .standard => glfw.setClipboardString(val),</div><div class="diff-added">+            .selection, .primary => {</div><div class="diff-added">+                // Not supported except on Linux</div><div class="diff-added">+                if (comptime builtin.os.tag != .linux) return;</div><div class="diff-added">+                glfwNative.setX11SelectionString(val.ptr);</div><div class="diff-added">+            },</div><div class="diff-added">+        }</div><div>     }</div><div> </div><div class="diff-removed">-    /// Return the title of the window.</div><div class="diff-removed">-    pub fn getTitle(self: *Surface) ?[:0]const u8 {</div><div class="diff-removed">-        return self.title_text;</div><div class="diff-added">+    /// Set the visibility of the mouse cursor.</div><div class="diff-added">+    fn setMouseVisibility(self: *Surface, visible: bool) void {</div><div class="diff-added">+        self.window.setInputModeCursor(if (visible) .normal else .hidden);</div><div>     }</div><div> </div><div>     /// Set the shape of the cursor.</div><div class="diff-info">@@ -806,63 +848,16 @@ pub const Surface = struct {</div><div>         self.cursor = new;</div><div>     }</div><div> </div><div class="diff-removed">-    /// Set the visibility of the mouse cursor.</div><div class="diff-removed">-    fn setMouseVisibility(self: *Surface, visible: bool) void {</div><div class="diff-removed">-        self.window.setInputModeCursor(if (visible) .normal else .hidden);</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    pub fn supportsClipboard(</div><div class="diff-removed">-        self: *const Surface,</div><div class="diff-removed">-        clipboard_type: apprt.Clipboard,</div><div class="diff-removed">-    ) bool {</div><div class="diff-removed">-        _ = self;</div><div class="diff-removed">-        return switch (clipboard_type) {</div><div class="diff-removed">-            .standard => true,</div><div class="diff-removed">-            .selection, .primary => comptime builtin.os.tag == .linux,</div><div class="diff-removed">-        };</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    /// Start an async clipboard request.</div><div class="diff-removed">-    pub fn clipboardRequest(</div><div class="diff-removed">-        self: *Surface,</div><div class="diff-removed">-        clipboard_type: apprt.Clipboard,</div><div class="diff-removed">-        state: apprt.ClipboardRequest,</div><div class="diff-removed">-    ) !void {</div><div class="diff-removed">-        // GLFW can read clipboards immediately so just do that.</div><div class="diff-removed">-        const str: [:0]const u8 = switch (clipboard_type) {</div><div class="diff-removed">-            .standard => glfw.getClipboardString() orelse return glfw.mustGetErrorCode(),</div><div class="diff-removed">-            .selection, .primary => selection: {</div><div class="diff-removed">-                // Not supported except on Linux</div><div class="diff-removed">-                if (comptime builtin.os.tag != .linux) break :selection "";</div><div class="diff-removed">-</div><div class="diff-removed">-                const raw = glfwNative.getX11SelectionString() orelse</div><div class="diff-removed">-                    return glfw.mustGetErrorCode();</div><div class="diff-removed">-                break :selection std.mem.span(raw);</div><div class="diff-removed">-            },</div><div class="diff-removed">-        };</div><div class="diff-removed">-</div><div class="diff-removed">-        // Complete our request. We always allow unsafe because we don't</div><div class="diff-removed">-        // want to deal with user confirmation in this runtime.</div><div class="diff-removed">-        try self.core_surface.completeClipboardRequest(state, str, true);</div><div class="diff-added">+    /// Return the title of the window.</div><div class="diff-added">+    pub fn getTitle(self: *Surface) ?[:0]const u8 {</div><div class="diff-added">+        return self.title_text;</div><div>     }</div><div> </div><div class="diff-removed">-    /// Set the clipboard.</div><div class="diff-removed">-    pub fn setClipboardString(</div><div class="diff-removed">-        self: *const Surface,</div><div class="diff-removed">-        val: [:0]const u8,</div><div class="diff-removed">-        clipboard_type: apprt.Clipboard,</div><div class="diff-removed">-        confirm: bool,</div><div class="diff-removed">-    ) !void {</div><div class="diff-removed">-        _ = confirm;</div><div class="diff-removed">-        _ = self;</div><div class="diff-removed">-        switch (clipboard_type) {</div><div class="diff-removed">-            .standard => glfw.setClipboardString(val),</div><div class="diff-removed">-            .selection, .primary => {</div><div class="diff-removed">-                // Not supported except on Linux</div><div class="diff-removed">-                if (comptime builtin.os.tag != .linux) return;</div><div class="diff-removed">-                glfwNative.setX11SelectionString(val.ptr);</div><div class="diff-removed">-            },</div><div class="diff-removed">-        }</div><div class="diff-added">+    /// Set the title of the window.</div><div class="diff-added">+    fn setTitle(self: *Surface, slice: [:0]const u8) !void {</div><div class="diff-added">+        if (self.title_text) |t| self.core_surface.alloc.free(t);</div><div class="diff-added">+        self.title_text = try self.core_surface.alloc.dupeZ(u8, slice);</div><div class="diff-added">+        self.window.setTitle(self.title_text.?.ptr);</div><div>     }</div><div> </div><div>     /// The cursor position from glfw directly is in screen coordinates but</div><div class="diff-info">@@ -887,28 +882,19 @@ pub const Surface = struct {</div><div>         };</div><div>     }</div><div> </div><div class="diff-removed">-    pub fn defaultTermioEnv(self: *Surface) !std.process.EnvMap {</div><div class="diff-removed">-        return try internal_os.getEnvMap(self.app.app.alloc);</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    fn sizeCallback(window: glfw.Window, width: i32, height: i32) void {</div><div class="diff-removed">-        _ = width;</div><div class="diff-removed">-        _ = height;</div><div class="diff-removed">-</div><div class="diff-removed">-        // Get the size. We are given a width/height but this is in screen</div><div class="diff-removed">-        // coordinates and we want raw pixels. The core window uses the content</div><div class="diff-removed">-        // scale to scale appropriately.</div><div class="diff-removed">-        const core_win = window.getUserPointer(CoreSurface) orelse return;</div><div class="diff-removed">-        const size = core_win.rt_surface.getSize() catch |err| {</div><div class="diff-removed">-            log.err("error querying window size for size callback err={}", .{err});</div><div class="diff-removed">-            return;</div><div class="diff-added">+    pub fn supportsClipboard(</div><div class="diff-added">+        self: *const Surface,</div><div class="diff-added">+        clipboard_type: apprt.Clipboard,</div><div class="diff-added">+    ) bool {</div><div class="diff-added">+        _ = self;</div><div class="diff-added">+        return switch (clipboard_type) {</div><div class="diff-added">+            .standard => true,</div><div class="diff-added">+            .selection, .primary => comptime builtin.os.tag == .linux,</div><div>         };</div><div class="diff-added">+    }</div><div> </div><div class="diff-removed">-        // Call the primary callback.</div><div class="diff-removed">-        core_win.sizeCallback(size) catch |err| {</div><div class="diff-removed">-            log.err("error in size callback err={}", .{err});</div><div class="diff-removed">-            return;</div><div class="diff-removed">-        };</div><div class="diff-added">+    pub fn defaultTermioEnv(self: *Surface) !std.process.EnvMap {</div><div class="diff-added">+        return try internal_os.getEnvMap(self.app.app.alloc);</div><div>     }</div><div> </div><div>     fn charCallback(window: glfw.Window, codepoint: u21) void {</div><div class="diff-info">@@ -943,28 +929,27 @@ pub const Surface = struct {</div><div> </div><div>     fn keyCallback(</div><div>         window: glfw.Window,</div><div class="diff-removed">-        glfw_key: glfw.Key,</div><div class="diff-added">+        key_: glfw.Key,</div><div>         scancode: i32,</div><div class="diff-removed">-        glfw_action: glfw.Action,</div><div class="diff-removed">-        glfw_mods: glfw.Mods,</div><div class="diff-added">+        action: glfw.Action,</div><div class="diff-added">+        mods_: glfw.Mods,</div><div>     ) void {</div><div>         _ = scancode;</div><div class="diff-removed">-</div><div>         const core_win = window.getUserPointer(CoreSurface) orelse return;</div><div> </div><div>         // Convert our glfw types into our input types</div><div>         const mods: input.Mods = .{</div><div class="diff-removed">-            .shift = glfw_mods.shift,</div><div class="diff-removed">-            .ctrl = glfw_mods.control,</div><div class="diff-removed">-            .alt = glfw_mods.alt,</div><div class="diff-removed">-            .super = glfw_mods.super,</div><div class="diff-added">+            .shift = mods_.shift,</div><div class="diff-added">+            .ctrl = mods_.control,</div><div class="diff-added">+            .alt = mods_.alt,</div><div class="diff-added">+            .super = mods_.super,</div><div>         };</div><div class="diff-removed">-        const action: input.Action = switch (glfw_action) {</div><div class="diff-added">+        const action_enum: input.Action = switch (action) {</div><div>             .release => .release,</div><div>             .press => .press,</div><div>             .repeat => .repeat,</div><div>         };</div><div class="diff-removed">-        const key: input.Key = switch (glfw_key) {</div><div class="diff-added">+        const key: input.Key = switch (key_) {</div><div>             .a => .a,</div><div>             .b => .b,</div><div>             .c => .c,</div><div class="diff-info">@@ -1090,6 +1075,17 @@ pub const Surface = struct {</div><div>             => .invalid,</div><div>         };</div><div> </div><div class="diff-added">+        const key_event: input.KeyEvent = .{</div><div class="diff-added">+            .action = action_enum,</div><div class="diff-added">+            .key = key,</div><div class="diff-added">+            .physical_key = key,</div><div class="diff-added">+            .mods = mods,</div><div class="diff-added">+            .consumed_mods = .{},</div><div class="diff-added">+            .composing = false,</div><div class="diff-added">+            .utf8 = "",</div><div class="diff-added">+            .unshifted_codepoint = 0,</div><div class="diff-added">+        };</div><div class="diff-added">+</div><div>         // This is a hack for GLFW. We require our apprts to send both</div><div>         // the UTF8 encoding AND the keypress at the same time. Its critical</div><div>         // for things like ctrl sequences to work. However, GLFW doesn't</div><div class="diff-info">@@ -1103,17 +1099,8 @@ pub const Surface = struct {</div><div>                 break :utf8 &.{byte};</div><div>             },</div><div>         };</div><div class="diff-removed">-</div><div class="diff-removed">-        const key_event: input.KeyEvent = .{</div><div class="diff-removed">-            .action = action,</div><div class="diff-removed">-            .key = key,</div><div class="diff-removed">-            .physical_key = key,</div><div class="diff-removed">-            .mods = mods,</div><div class="diff-removed">-            .consumed_mods = .{},</div><div class="diff-removed">-            .composing = false,</div><div class="diff-removed">-            .utf8 = utf8,</div><div class="diff-removed">-            .unshifted_codepoint = if (utf8.len > 0) @intCast(utf8[0]) else 0,</div><div class="diff-removed">-        };</div><div class="diff-added">+        key_event.utf8 = utf8;</div><div class="diff-added">+        key_event.unshifted_codepoint = if (utf8.len > 0) @intCast(utf8[0]) else 0;</div><div> </div><div>         const effect = core_win.keyCallback(key_event) catch |err| {</div><div>             log.err("error in key callback err={}", .{err});</div><div class="diff-info">@@ -1213,6 +1200,7 @@ pub const Surface = struct {</div><div>             .six => .six,</div><div>             .seven => .seven,</div><div>             .eight => .eight,</div><div class="diff-added">+            else => unreachable,</div><div>         };</div><div>         const action: input.MouseButtonState = switch (glfw_action) {</div><div>             .press => .press,</div><div class="diff-info">@@ -1234,6 +1222,7 @@ pub const Surface = struct {</div><div> </div><div>         for (paths) |path| {</div><div>             const path_slice = std.mem.span(path);</div><div class="diff-added">+            const writer = list.writer();</div><div> </div><div>             // preallocate worst case of escaping every char + space</div><div>             list.ensureTotalCapacity(path_slice.len * 2 + 1) catch |err| {</div><div class="diff-info">@@ -1241,20 +1230,19 @@ pub const Surface = struct {</div><div>                 return;</div><div>             };</div><div> </div><div class="diff-removed">-            const writer = list.writer();</div><div>             for (path_slice) |c| {</div><div>                 if (std.mem.indexOfScalar(u8, "\\ ()[]{}<>\"'`!#$&;|*?\t", c)) |_| {</div><div>                     writer.print("\\{c}", .{c}) catch unreachable; //  memory preallocated</div><div>                 } else writer.writeByte(c) catch unreachable; // same here</div><div>             }</div><div>             writer.writeByte(' ') catch unreachable; // separate paths</div><div class="diff-added">+        }</div><div> </div><div class="diff-removed">-            surface.textCallback(list.items) catch |err| {</div><div class="diff-removed">-                log.err("error in drop callback err={}", .{err});</div><div class="diff-removed">-                return;</div><div class="diff-removed">-            };</div><div class="diff-added">+        surface.textCallback(list.items) catch |err| {</div><div class="diff-added">+            log.err("error in drop callback err={}", .{err});</div><div class="diff-added">+            return;</div><div class="diff-added">+        };</div><div> </div><div class="diff-removed">-            list.clearRetainingCapacity(); // avoid unnecessary reallocations</div><div class="diff-removed">-        }</div><div class="diff-added">+        list.clearRetainingCapacity(); // avoid unnecessary reallocations</div><div>     }</div><div> };</div><div>\ No newline at end of file</div><div></div></pre>
                </div>
            </div>
        </section>
    </main>
    <footer>
        <p>LoCoDiff-bench - <a href="https://github.com/AbanteAI/LoCoDiff-bench">GitHub Repository</a></p>
    </footer>
</body>
</html>
    