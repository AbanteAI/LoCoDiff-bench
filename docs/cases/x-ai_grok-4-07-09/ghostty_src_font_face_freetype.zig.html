<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case: src/font/face/freetype.zig - Grok 4</title>
    <link rel="stylesheet" href="../../styles.css">
</head>
<body>
    <header>
        <h1>Case: src/font/face/freetype.zig</h1>
        <h2>Model: Grok 4</h2>
        <p><a href="../../models/x-ai_grok-4-07-09.html">All Grok 4 Cases</a> | <a href="../../cases.html">All Cases</a> | <a href="../../index.html">Home</a></p>
    </header>
    <main>
        <section class="case-details">
            <div class="case-info">
                <h2>Benchmark Case Information</h2>
                <p><strong>Model:</strong> Grok 4</p>
                <p><strong>Status:</strong> <span class="failure">Failure</span></p>
                <p><strong>Prompt Tokens:</strong> 57124</p>
                <p><strong>Native Prompt Tokens:</strong> 55894</p>
                <p><strong>Native Completion Tokens:</strong> 19171</p>
                <p><strong>Native Tokens Reasoning:</strong> 10268</p>
                <p><strong>Native Finish Reason:</strong> stop</p>
                <p><strong>Cost:</strong> $0.4552425</p>
            </div>
            
            <div class="content-links">
                <h2>View Content</h2>
                <ul>
                    <li><a href="../../content/x-ai_grok-4-07-09/ghostty_src_font_face_freetype.zig/prompt.html" class="content-link">View Prompt</a></li>
                    <li><a href="../../content/x-ai_grok-4-07-09/ghostty_src_font_face_freetype.zig/expected.html" class="content-link">View Expected Output</a></li>
                    <li><a href="../../content/x-ai_grok-4-07-09/ghostty_src_font_face_freetype.zig/actual.html" class="content-link">View Actual Output</a></li>
                </ul>
            </div>
            
            <div class="diff-section">
                <h2>Diff (Expected vs Actual)</h2>
                <div id="diff-output">
                    <pre class="diff"><div></div><div>index 94dc6911d..a5d9a9d5d 100644</div><div class="diff-header">--- a/ghostty_src_font_face_freetype.zig_expectedoutput.txt (expected):tmp/tmp_4yio1ft_expected.txt	</div><div class="diff-header">+++ b/ghostty_src_font_face_freetype.zig_extracted.txt (actual):tmp/tmp76pnl_z0_actual.txt	</div><div class="diff-info">@@ -140,18 +140,12 @@ pub const Face = struct {</div><div>         return "";</div><div>     }</div><div> </div><div class="diff-removed">-    /// Return a new face that is the same as this but also has synthetic</div><div class="diff-removed">-    /// bold applied.</div><div>     pub fn syntheticBold(self: *const Face, opts: font.face.Options) !Face {</div><div>         // Increase face ref count</div><div>         self.face.ref();</div><div>         errdefer self.face.deinit();</div><div> </div><div class="diff-removed">-        var f = try initFace(</div><div class="diff-removed">-            .{ .lib = self.lib },</div><div class="diff-removed">-            self.face,</div><div class="diff-removed">-            opts,</div><div class="diff-removed">-        );</div><div class="diff-added">+        var f = try initFace(.{ .lib = self.lib }, self.face, opts);</div><div>         errdefer f.deinit();</div><div>         f.synthetic = self.synthetic;</div><div>         f.synthetic.bold = true;</div><div class="diff-info">@@ -166,11 +160,7 @@ pub const Face = struct {</div><div>         self.face.ref();</div><div>         errdefer self.face.deinit();</div><div> </div><div class="diff-removed">-        var f = try initFace(</div><div class="diff-removed">-            .{ .lib = self.lib },</div><div class="diff-removed">-            self.face,</div><div class="diff-removed">-            opts,</div><div class="diff-removed">-        );</div><div class="diff-added">+        var f = try initFace(.{ .lib = self.lib }, self.face, opts);</div><div>         errdefer f.deinit();</div><div>         f.synthetic = self.synthetic;</div><div>         f.synthetic.italic = true;</div><div class="diff-info">@@ -283,7 +273,6 @@ pub const Face = struct {</div><div>         }) catch return false;</div><div> </div><div>         const glyph = self.face.handle.*.glyph;</div><div class="diff-removed">-</div><div>         return glyph.*.bitmap.pixel_mode == freetype.c.FT_PIXEL_MODE_BGRA;</div><div>     }</div><div> </div><div class="diff-info">@@ -306,11 +295,10 @@ pub const Face = struct {</div><div> </div><div>         // If our glyph has color, we want to render the color</div><div>         try self.face.loadGlyph(glyph_index, .{</div><div class="diff-removed">-            .color = self.face.hasColor(),</div><div class="diff-removed">-</div><div>             // If we have synthetic bold, we have to set some additional</div><div>             // glyph properties before render so we don't render here.</div><div>             .render = !self.synthetic.bold,</div><div class="diff-added">+            .color = self.face.hasColor(),</div><div> </div><div>             // use options from config</div><div>             .no_hinting = !self.load_flags.hinting,</div><div class="diff-info">@@ -337,9 +325,10 @@ pub const Face = struct {</div><div>             try self.face.renderGlyph(.normal);</div><div>         }</div><div> </div><div class="diff-added">+        const bitmap_ft = glyph.*.bitmap;</div><div class="diff-added">+</div><div>         // This bitmap is blank. I've seen it happen in a font, I don't know why.</div><div>         // If it is empty, we just return a valid glyph struct that does nothing.</div><div class="diff-removed">-        const bitmap_ft = glyph.*.bitmap;</div><div>         if (bitmap_ft.rows == 0) return .{</div><div>             .width = 0,</div><div>             .height = 0,</div><div class="diff-info">@@ -410,9 +399,7 @@ pub const Face = struct {</div><div>             }</div><div> </div><div>             // If we already fit, we don't need to resize</div><div class="diff-removed">-            if (original_height <= result.rows and original_width <= result.width) {</div><div class="diff-removed">-                break :resized null;</div><div class="diff-removed">-            }</div><div class="diff-added">+            if (original_height <= result.rows and original_width <= result.width) break :resized null;</div><div> </div><div>             result.pitch = @as(c_int, @intCast(result.width)) * atlas.format.depth();</div><div> </div><div class="diff-info">@@ -446,12 +433,12 @@ pub const Face = struct {</div><div>             alloc.free(bm.buffer[0..len]);</div><div>         };</div><div> </div><div class="diff-removed">-        const bitmap = bitmap_resized orelse (bitmap_converted orelse bitmap_ft);</div><div class="diff-added">+        const bitmap = bitmap_resized orelse bitmap_original;</div><div>         const tgt_w = bitmap.width;</div><div>         const tgt_h = bitmap.rows;</div><div> </div><div>         // Must have non-empty bitmap because we return earlier</div><div class="diff-removed">-        // if zero. We assume the rest of this that it is nont-zero so</div><div class="diff-added">+        // if zero. We assume the rest of this that it is non-zero so</div><div>         // this is important.</div><div>         assert(tgt_w > 0 and tgt_h > 0);</div><div> </div><div class="diff-info">@@ -460,11 +447,7 @@ pub const Face = struct {</div><div>         // same ratio as the resize.</div><div>         const glyph_metrics = if (bitmap_resized) |bm| metrics: {</div><div>             // Our ratio for the resize</div><div class="diff-removed">-            const ratio = ratio: {</div><div class="diff-removed">-                const new: f64 = @floatFromInt(bm.rows);</div><div class="diff-removed">-                const old: f64 = @floatFromInt(bitmap_original.rows);</div><div class="diff-removed">-                break :ratio new / old;</div><div class="diff-removed">-            };</div><div class="diff-added">+            const ratio = @as(f64, @floatFromInt(bm.rows)) / @as(f64, @floatFromInt(bitmap_original.rows));</div><div> </div><div>             var copy = glyph.*;</div><div>             copy.bitmap_top = @as(c_int, @intFromFloat(@round(@as(f64, @floatFromInt(copy.bitmap_top)) * ratio)));</div><div class="diff-info">@@ -519,7 +502,7 @@ pub const Face = struct {</div><div>                 }</div><div>                 break :buffer temp;</div><div>             } else bitmap.buffer[0..(tgt_w * tgt_h * depth)];</div><div class="diff-removed">-            defer if (buffer.ptr != bitmap.buffer) alloc.free(buffer);</div><div class="diff-added">+            defer if (needs_copy) alloc.free(buffer);</div><div> </div><div>             // Write the glyph information into the atlas</div><div>             assert(region.width == tgt_w);</div><div class="diff-info">@@ -527,7 +510,7 @@ pub const Face = struct {</div><div>             atlas.set(region, buffer);</div><div>         }</div><div> </div><div class="diff-removed">-        const offset_y: c_int = offset_y: {</div><div class="diff-added">+        const offset_y = offset_y: {</div><div>             // For non-scalable colorized fonts, we assume they are pictographic</div><div>             // and just center the glyph. So far this has only applied to emoji</div><div>             // fonts. Emoji fonts don't always report a correct ascender/descender</div><div class="diff-info">@@ -562,14 +545,6 @@ pub const Face = struct {</div><div>             break :offset_x result;</div><div>         };</div><div> </div><div class="diff-removed">-        // log.warn("renderGlyph width={} height={} offset_x={} offset_y={} glyph_metrics={}", .{</div><div class="diff-removed">-        //     tgt_w,</div><div class="diff-removed">-        //     tgt_h,</div><div class="diff-removed">-        //     glyph_metrics.bitmap_left,</div><div class="diff-removed">-        //     offset_y,</div><div class="diff-removed">-        //     glyph_metrics,</div><div class="diff-removed">-        // });</div><div class="diff-removed">-</div><div>         // Store glyph metadata</div><div>         return Glyph{</div><div>             .width = tgt_w,</div><div class="diff-info">@@ -578,7 +553,7 @@ pub const Face = struct {</div><div>             .offset_y = offset_y,</div><div>             .atlas_x = region.x,</div><div>             .atlas_y = region.y,</div><div class="diff-removed">-            .advance_x = f26dot6ToFloat(glyph_metrics.advance.x),</div><div class="diff-added">+            .advance_x = f26dot6ToFloat(glyph.*.advance.x),</div><div>         };</div><div>     }</div><div> </div><div class="diff-info">@@ -632,9 +607,9 @@ pub const Face = struct {</div><div> </div><div>         const units_per_em = head.Units_Per_EM;</div><div>         const px_per_em: f64 = @floatFromInt(size_metrics.y_ppem);</div><div class="diff-removed">-        const px_per_unit = px_per_em / @as(f64, @floatFromInt(units_per_em));</div><div class="diff-added">+        const px_per_unit = px_per_em / @floatFromInt(units_per_em);</div><div> </div><div class="diff-removed">-        const ascent: f64, const descent: f64, const line_gap: f64 = vertical_metrics: {</div><div class="diff-added">+        const ascent, const descent, const line_gap = vertical_metrics: {</div><div>             const hhea_ascent: f64 = @floatFromInt(hhea.Ascender);</div><div>             const hhea_descent: f64 = @floatFromInt(hhea.Descender);</div><div>             const hhea_line_gap: f64 = @floatFromInt(hhea.Line_Gap);</div><div class="diff-info">@@ -988,7 +963,6 @@ const terminus_i =</div><div>     \\........</div><div>     \\........</div><div> ;</div><div class="diff-removed">-// Including the newline</div><div> const terminus_i_pitch = 9;</div><div> </div><div> test "bitmap glyph" {</div><div></div></pre>
                </div>
            </div>
        </section>
    </main>
    <footer>
        <p>LoCoDiff-bench - <a href="https://github.com/AbanteAI/LoCoDiff-bench">GitHub Repository</a></p>
    </footer>
</body>
</html>
    