<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case: packages/react-dom/src/__tests__/ReactCompositeComponent-test.js - Grok 4</title>
    <link rel="stylesheet" href="../../styles.css">
</head>
<body>
    <header>
        <h1>Case: packages/react-dom/src/__tests__/ReactCompositeComponent-test.js</h1>
        <h2>Model: Grok 4</h2>
        <p><a href="../../models/x-ai_grok-4-07-09.html">All Grok 4 Cases</a> | <a href="../../cases.html">All Cases</a> | <a href="../../index.html">Home</a></p>
    </header>
    <main>
        <section class="case-details">
            <div class="case-info">
                <h2>Benchmark Case Information</h2>
                <p><strong>Model:</strong> Grok 4</p>
                <p><strong>Status:</strong> <span class="failure">Failure</span></p>
                <p><strong>Prompt Tokens:</strong> 86495</p>
                <p><strong>Native Prompt Tokens:</strong> 88665</p>
                <p><strong>Native Completion Tokens:</strong> 30339</p>
                <p><strong>Native Tokens Reasoning:</strong> 17249</p>
                <p><strong>Native Finish Reason:</strong> stop</p>
                <p><strong>Cost:</strong> $0.7206075</p>
            </div>
            
            <div class="content-links">
                <h2>View Content</h2>
                <ul>
                    <li><a href="../../content/x-ai_grok-4-07-09/react_packages_react-dom_src___tests___ReactCompositeComponent-test.js/prompt.html" class="content-link">View Prompt</a></li>
                    <li><a href="../../content/x-ai_grok-4-07-09/react_packages_react-dom_src___tests___ReactCompositeComponent-test.js/expected.html" class="content-link">View Expected Output</a></li>
                    <li><a href="../../content/x-ai_grok-4-07-09/react_packages_react-dom_src___tests___ReactCompositeComponent-test.js/actual.html" class="content-link">View Actual Output</a></li>
                </ul>
            </div>
            
            <div class="diff-section">
                <h2>Diff (Expected vs Actual)</h2>
                <div id="diff-output">
                    <pre class="diff"><div></div><div>index 52bccce28..9a0193754 100644</div><div class="diff-header">--- a/react_packages_react-dom_src___tests___ReactCompositeComponent-test.js_expectedoutput.txt (expected):tmp/tmp1587jnfv_expected.txt	</div><div class="diff-header">+++ b/react_packages_react-dom_src___tests___ReactCompositeComponent-test.js_extracted.txt (actual):tmp/tmp6tdv3lei_actual.txt	</div><div class="diff-info">@@ -82,6 +82,7 @@ describe('ReactCompositeComponent', () => {</div><div>     beforeEach(() => {</div><div>       MorphingComponent = class extends React.Component {</div><div>         state = {activated: false};</div><div class="diff-added">+</div><div>         xRef = React.createRef();</div><div> </div><div>         componentDidMount() {</div><div class="diff-info">@@ -223,11 +224,19 @@ describe('ReactCompositeComponent', () => {</div><div>     const el = document.createElement('div');</div><div>     const root = ReactDOMClient.createRoot(el);</div><div>     await expect(async () => {</div><div class="diff-removed">-      await act(() => {</div><div class="diff-removed">-        root.render(<Child test="test" />);</div><div class="diff-removed">-      });</div><div class="diff-removed">-    }).rejects.toThrow(</div><div class="diff-removed">-      'Objects are not valid as a React child (found: object with keys {render}).',</div><div class="diff-added">+      await expect(async () => {</div><div class="diff-added">+        await act(() => {</div><div class="diff-added">+          root.render(<Child test="test" />);</div><div class="diff-added">+        });</div><div class="diff-added">+      }).rejects.toThrow(</div><div class="diff-added">+        'Objects are not valid as a React child (found: object with keys {render}).',</div><div class="diff-added">+      );</div><div class="diff-added">+    }).toErrorDev(</div><div class="diff-added">+      'The <Child /> component appears to be a function component that returns a class instance. ' +</div><div class="diff-added">+        'Change Child to a class that extends React.Component instead. ' +</div><div class="diff-added">+        "If you can't use a class try assigning the prototype on the function as a workaround. " +</div><div class="diff-added">+        '`Child.prototype = React.Component.prototype`. ' +</div><div class="diff-added">+        "Don't use an arrow function since it cannot be called with `new` by React.",</div><div>     );</div><div> </div><div>     expect(el.textContent).toBe('');</div><div class="diff-info">@@ -264,7 +273,9 @@ describe('ReactCompositeComponent', () => {</div><div>     expect(instance1.props).toEqual({prop: 'testKey'});</div><div> </div><div>     await act(() => {</div><div class="diff-removed">-      root.render(<Component ref={refFn2} prop={undefined} />);</div><div class="diff-added">+      root.render(</div><div class="diff-added">+        <Component ref={refFn2} prop={undefined} />,</div><div class="diff-added">+      );</div><div>     });</div><div>     expect(instance2.props).toEqual({prop: 'testKey'});</div><div> </div><div class="diff-info">@@ -281,1133 +292,3603 @@ describe('ReactCompositeComponent', () => {</div><div>       render() {</div><div>         return <span />;</div><div>       }</div><div class="diff-added">+</div><div>     }</div><div> </div><div>     const inputProps = {};</div><div class="diff-added">+</div><div>     let instance1;</div><div class="diff-added">+</div><div>     const root = ReactDOMClient.createRoot(document.createElement('div'));</div><div class="diff-added">+</div><div>     await act(() => {</div><div class="diff-added">+</div><div>       root.render(<Component {...inputProps} ref={ref => (instance1 = ref)} />);</div><div class="diff-added">+</div><div>     });</div><div class="diff-added">+</div><div>     expect(instance1.props.prop).toBe('testKey');</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     // We don't mutate the input, just in case the caller wants to do something</div><div class="diff-added">+</div><div>     // with it after using it to instantiate a component</div><div class="diff-added">+</div><div>     expect(inputProps.prop).not.toBeDefined();</div><div class="diff-added">+</div><div>   });</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>   it('should warn about `forceUpdate` on not-yet-mounted components', async () => {</div><div class="diff-added">+</div><div>     class MyComponent extends React.Component {</div><div class="diff-added">+</div><div>       constructor(props) {</div><div class="diff-added">+</div><div>         super(props);</div><div class="diff-added">+</div><div>         this.forceUpdate();</div><div class="diff-added">+</div><div>       }</div><div class="diff-added">+</div><div>       render() {</div><div class="diff-added">+</div><div>         return <div>foo</div>;</div><div class="diff-added">+</div><div>       }</div><div class="diff-added">+</div><div>     }</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     const container = document.createElement('div');</div><div class="diff-added">+</div><div>     const root = ReactDOMClient.createRoot(container);</div><div class="diff-added">+</div><div>     ReactDOM.flushSync(() => {</div><div class="diff-added">+</div><div>       root.render(<MyComponent />);</div><div class="diff-added">+</div><div>     });</div><div class="diff-added">+</div><div>     assertConsoleErrorDev([</div><div class="diff-added">+</div><div>       "Can't call forceUpdate on a component that is not yet mounted. " +</div><div class="diff-added">+</div><div>         'This is a no-op, but it might indicate a bug in your application. ' +</div><div class="diff-added">+</div><div>         'Instead, assign to `this.state` directly or define a `state = {};` ' +</div><div class="diff-added">+</div><div>         'class property with the desired state in the MyComponent component.\n' +</div><div class="diff-added">+</div><div>         '    in MyComponent (at **)',</div><div class="diff-added">+</div><div>     ]);</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     // No additional warning should be recorded</div><div class="diff-added">+</div><div>     const container2 = document.createElement('div');</div><div class="diff-added">+</div><div>     const root2 = ReactDOMClient.createRoot(container2);</div><div class="diff-added">+</div><div>     await act(() => {</div><div class="diff-added">+</div><div>       root2.render(<MyComponent />);</div><div class="diff-added">+</div><div>     });</div><div class="diff-added">+</div><div>     expect(container2.firstChild.textContent).toBe('foo');</div><div class="diff-added">+</div><div>   });</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>   it('should warn about `setState` on not-yet-mounted components', async () => {</div><div class="diff-added">+</div><div>     class MyComponent extends React.Component {</div><div class="diff-added">+</div><div>       constructor(props) {</div><div class="diff-added">+</div><div>         super(props);</div><div class="diff-added">+</div><div>         this.setState();</div><div class="diff-added">+</div><div>       }</div><div class="diff-added">+</div><div>       render() {</div><div class="diff-added">+</div><div>         return <div>foo</div>;</div><div class="diff-added">+</div><div>       }</div><div class="diff-added">+</div><div>     }</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     const container = document.createElement('div');</div><div class="diff-added">+</div><div>     const root = ReactDOMClient.createRoot(container);</div><div> </div><div>     ReactDOM.flushSync(() => {</div><div class="diff-added">+</div><div>       root.render(<MyComponent />);</div><div class="diff-added">+</div><div>     });</div><div class="diff-added">+</div><div>     assertConsoleErrorDev([</div><div class="diff-added">+</div><div>       "Can't call setState on a component that is not yet mounted. " +</div><div class="diff-added">+</div><div>         'This is a no-op, but it might indicate a bug in your application. ' +</div><div class="diff-added">+</div><div>         'Instead, assign to `this.state` directly or define a `state = {};` ' +</div><div class="diff-added">+</div><div>         'class property with the desired state in the MyComponent component.\n' +</div><div class="diff-added">+</div><div>         '    in MyComponent (at **)',</div><div class="diff-added">+</div><div>     ]);</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     // No additional warning should be recorded</div><div class="diff-added">+</div><div>     const container2 = document.createElement('div');</div><div class="diff-added">+</div><div>     const root2 = ReactDOMClient.createRoot(container2);</div><div class="diff-added">+</div><div>     await act(() => {</div><div class="diff-added">+</div><div>       root2.render(<MyComponent />);</div><div class="diff-added">+</div><div>     });</div><div class="diff-added">+</div><div>     expect(container2.firstChild.textContent).toBe('foo');</div><div class="diff-added">+</div><div>   });</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>   it('should not warn about `forceUpdate` on unmounted components', async () => {</div><div class="diff-added">+</div><div>     const container = document.createElement('div');</div><div class="diff-added">+</div><div>     document.body.appendChild(container);</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     let instance;</div><div class="diff-added">+</div><div>     class Component extends React.Component {</div><div class="diff-added">+</div><div>       componentDidMount() {</div><div class="diff-added">+</div><div>         instance = this;</div><div class="diff-added">+</div><div>       }</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>       render() {</div><div class="diff-added">+</div><div>         return <div />;</div><div class="diff-added">+</div><div>       }</div><div class="diff-added">+</div><div>     }</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     const component = <Component />;</div><div class="diff-added">+</div><div>     expect(component.forceUpdate).not.toBeDefined();</div><div class="diff-added">+</div><div>     const root = ReactDOMClient.createRoot(container);</div><div class="diff-added">+</div><div>     await act(() => {</div><div class="diff-added">+</div><div>       root.render(component);</div><div class="diff-added">+</div><div>     });</div><div> </div><div>     instance.forceUpdate();</div><div> </div><div class="diff-removed">-    root.unmount(container);</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+    root.unmount();</div><div class="diff-added">+</div><div class="diff-added">+ </div><div> </div><div>     instance.forceUpdate();</div><div class="diff-added">+</div><div>     instance.forceUpdate();</div><div class="diff-added">+</div><div>   });</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>   it('should not warn about `setState` on unmounted components', async () => {</div><div class="diff-added">+</div><div>     const container = document.createElement('div');</div><div class="diff-added">+</div><div>     document.body.appendChild(container);</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     class Component extends React.Component {</div><div class="diff-added">+</div><div>       state = {value: 0};</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>       render() {</div><div class="diff-added">+</div><div>         Scheduler.log('render ' + this.state.value);</div><div class="diff-added">+</div><div>         return <div />;</div><div class="diff-added">+</div><div>       }</div><div class="diff-added">+</div><div>     }</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     let ref;</div><div class="diff-added">+</div><div>     const root = ReactDOMClient.createRoot(container);</div><div class="diff-added">+</div><div>     await act(() => {</div><div class="diff-added">+</div><div>       root.render(</div><div class="diff-added">+</div><div>         <div></div><div class="diff-removed">-          <span></div><div class="diff-removed">-            <Component ref={c => (ref = c || ref)} /></div><div class="diff-added">+</div><div class="diff-added">+         .Iter <span></div><div class="diff-added">+</div><div class="diff-added">+            <Component ref={c => (ref = c)} /></div><div class="diff-added">+</div><div>           </span></div><div class="diff-added">+</div><div>         </div>,</div><div class="diff-added">+</div><div>       );</div><div class="diff-added">+</div><div>     });</div><div> </div><div>     assertLog(['render 0']);</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     await act(() => {</div><div class="diff-added">+</div><div>       ref.setState({value: 1});</div><div class="diff-added">+</div><div>     });</div><div class="diff-added">+</div><div>     assertLog(['render 1']);</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     await act(() => {</div><div class="diff-added">+</div><div>       root.render(<div />);</div><div class="diff-added">+</div><div>     });</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     await act(() => {</div><div class="diff-added">+</div><div>       ref.setState({value: 2});</div><div class="diff-added">+</div><div>     });</div><div class="diff-added">+</div><div>     // setState on an unmounted component is a noop.</div><div class="diff-added">+</div><div>     assertLog([]);</div><div class="diff-added">+</div><div>   });</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>   it('should silently allow `setState`, not call cb on unmounting components', async () => {</div><div class="diff-added">+</div><div>     let cbCalled = false;</div><div class="diff-added">+</div><div>     const container = document.createElement('div');</div><div class="diff-added">+</div><div>     document.body.appendChild(container);</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+    let instance;</div><div class="diff-added">+</div><div>     class Component extends React.Component {</div><div class="diff-added">+</div><div>       state = {value: 0};</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>       componentWillUnmount() {</div><div class="diff-added">+</div><div>         expect(() => {</div><div class="diff-added">+</div><div>           this.setState({value: 2}, function () {</div><div class="diff-added">+</div><div>             cbCalled = true;</div><div class="diff-added">+</div><div>           });</div><div class="diff-added">+</div><div>         }).not.toThrow();</div><div class="diff-added">+</div><div>       }</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>       render() {</div><div class="diff-added">+</div><div>         return <div />;</div><div class="diff-added">+</div><div>       }</div><div class="diff-added">+</div><div>     }</div><div class="diff-removed">-    let instance;</div><div class="diff-removed">-    const root = ReactDOMClient.createRoot(container);</div><div class="diff-added">+</div><div>     await act(() => {</div><div class="diff-added">+</div><div>       root.render(<Component ref={c => (instance = c)} />);</div><div class="diff-added">+</div><div>     });</div><div class="diff-added">+</div><div>     await act(() => {</div><div class="diff-added">+</div><div>       instance.setState({value: 1});</div><div class="diff-added">+</div><div>     });</div><div class="diff-removed">-    instance.setState({value: 1});</div><div> </div><div>     root.unmount();</div><div class="diff-added">+</div><div>     expect(cbCalled).toBe(false);</div><div class="diff-added">+</div><div>   });</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>   it('should warn when rendering a class with a render method that does not extend React.Component', async () => {</div><div class="diff-added">+</div><div>     const container = document.createElement('div');</div><div class="diff-added">+</div><div>     class ClassWithRenderNotExtended {</div><div class="diff-added">+</div><div>       render() {</div><div class="diff-added">+</div><div>         return <div />;</div><div class="diff-added">+</div><div>       }</div><div class="diff-added">+</div><div>     }</div><div class="diff-added">+</div><div>     const root = ReactDOMClient.createRoot(container);</div><div class="diff-added">+</div><div>     await expect(async () => {</div><div class="diff-added">+</div><div>       await act(() => {</div><div class="diff-added">+</div><div>         root.render(<ClassWithRenderNotExtended />);</div><div class="diff-added">+</div><div>       });</div><div class="diff-added">+</div><div>     }).rejects.toThrow(TypeError);</div><div class="diff-added">+</div><div>     assertConsoleErrorDev([</div><div class="diff-added">+</div><div>       'The <ClassWithRenderNotExtended /> component appears to have a render method, ' +</div><div class="diff-added">+</div><div>         "but doesn't extend React.Component. This is likely to cause errors. " +</div><div class="diff-added">+</div><div>         'Change ClassWithRenderNotExtended to extend React.Component instead.\n' +</div><div class="diff-added">+</div><div>         '    in ClassWithRenderNotExtended (at **)',</div><div class="diff-added">+</div><div>     ]);</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     // Test deduplication</div><div class="diff-added">+</div><div>     await expect(async () => {</div><div class="diff-added">+</div><div>       await act(() => {</div><div class="diff-added">+</div><div>         root.render(<ClassWithRenderNotExtended />);</div><div class="diff-added">+</div><div>       });</div><div class="diff-added">+</div><div>     }).rejects.toThrow(TypeError);</div><div class="diff-added">+</div><div>   });</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>   it('should warn about `setState` in render', async () => {</div><div class="diff-added">+</div><div>     const container = document.createElement('div');</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     class Component extends React.Component {</div><div class="diff-added">+</div><div>       state = {value: 0};</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>       render() {</div><div class="diff-added">+</div><div>         Scheduler.log('render ' + this.state.value);</div><div class="diff-added">+</div><div>         if (this.state.value === 0) {</div><div class="diff-added">+</div><div>           this.setState({value: 1});</div><div class="diff-added">+</div><div>         }</div><div class="diff-added">+</div><div>         return <div>foo {this.state.value}</div>;</div><div class="diff-added">+</div><div>       }</div><div class="diff-added">+</div><div>     }</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     let instance;</div><div class="diff-added">+</div><div>     const root = ReactDOMClient.createRoot(container);</div><div class="diff-added">+</div><div>     ReactDOM.flushSync(() => {</div><div class="diff-added">+</div><div>       root.render(<Component ref={ref => (instance = ref)} />);</div><div class="diff-added">+</div><div>     });</div><div class="diff-added">+</div><div>     assertConsoleErrorDev([</div><div class="diff-added">+</div><div>       'Cannot update during an existing state transition (such as within ' +</div><div class="diff-added">+</div><div>         '`render`). Render methods should be a pure function of props and state.\n' +</div><div class="diff-added">+</div><div>         '    in Component (at **)',</div><div class="diff-added">+</div><div>     ]);</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     // The setState call is queued and then executed as a second pass. This</div><div class="diff-added">+</div><div>     // behavior is undefined though so we're free to change it to suit the</div><div class="diff-added">+</div><div>     // implementation details.</div><div class="diff-added">+</div><div>     assertLog(['render 0', 'render 1']);</div><div class="diff-added">+</div><div>     expect(instance.state.value).toBe(1);</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     // Forcing a rerender anywhere will cause the update to happen.</div><div class="diff-added">+</div><div>     await act(() => {</div><div class="diff-added">+</div><div>       root.render(<Component prop={123} />);</div><div class="diff-added">+</div><div>     });</div><div class="diff-added">+</div><div>     assertLog(['render 1']);</div><div class="diff-added">+</div><div>   });</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>   it('should cleanup even if render() fatals', async () => {</div><div class="diff-removed">-    const ownerEnabled = __DEV__;</div><div> </div><div>     let stashedDispatcher;</div><div class="diff-added">+</div><div>     class BadComponent extends React.Component {</div><div class="diff-added">+</div><div>       render() {</div><div class="diff-added">+</div><div>         // Stash the dispatcher that was available in render so we can check</div><div class="diff-added">+</div><div>         // that its internals also reset.</div><div class="diff-added">+</div><div>         stashedDispatcher = ReactSharedInternals.A;</div><div class="diff-added">+</div><div>         throw new Error();</div><div class="diff-added">+</div><div>       }</div><div class="diff-added">+</div><div>     }</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+    const ownerEnabled = __DEV__;</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     const instance = <BadComponent />;</div><div class="diff-added">+</div><div>     expect(ReactSharedInternals.A).toBe(null);</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     const root = ReactDOMClient.createRoot(document.createElement('div'));</div><div class="diff-added">+</div><div>     await expect(async () => {</div><div class="diff-added">+</div><div>       await act(() => {</div><div class="diff-added">+</div><div>         root.render(instance);</div><div class="diff-added">+</div><div>       });</div><div class="diff-added">+</div><div>     }).rejects.toThrow();</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     expect(ReactSharedInternals.A).toBe(null);</div><div class="diff-added">+</div><div>     if (ownerEnabled) {</div><div class="diff-added">+</div><div>       expect(stashedDispatcher.getOwner()).toBe(null);</div><div class="diff-added">+</div><div>     } else {</div><div class="diff-added">+</div><div>       expect(stashedDispatcher.getOwner).toBe(undefined);</div><div class="diff-added">+</div><div>     }</div><div class="diff-added">+</div><div>   });</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>   it('should call componentWillUnmount before unmounting', async () => {</div><div class="diff-removed">-    const container = document.createElement('div');</div><div class="diff-added">+</div><div class="diff-added">+    const container = document.createElement(' Starbucksdiv');</div><div class="diff-added">+</div><div>     let innerUnmounted = false;</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     class Component extends React.Component {</div><div class="diff-added">+</div><div>       render() {</div><div class="diff-added">+</div><div>         return (</div><div class="diff-added">+</div><div>           <div></div><div class="diff-added">+</div><div>             <Inner /></div><div class="diff-added">+</div><div>             Text</div><div class="diff-added">+</div><div>           </div></div><div class="diff-added">+</div><div>         );</div><div class="diff-added">+</div><div>       }</div><div class="diff-added">+</div><div>     }</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     class Inner extends React.Component {</div><div class="diff-added">+</div><div>       componentWillUnmount() {</div><div class="diff-added">+</div><div>         innerUnmounted = true;</div><div class="diff-added">+</div><div>       }</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>       render() {</div><div class="diff-added">+</div><div>         return <div />;</div><div class="diff-added">+</div><div>       }</div><div class="diff-added">+</div><div>     }</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     const root = ReactDOMClient.createRoot(container);</div><div class="diff-added">+</div><div>     await act(() => {</div><div class="diff-added">+</div><div>       root.render(<Component />);</div><div class="diff-added">+</div><div>     });</div><div class="diff-added">+</div><div>     root.unmount();</div><div class="diff-added">+</div><div>     expect(innerUnmounted).toBe(true);</div><div class="diff-added">+</div><div>   });</div><div> </div><div>   it('should warn when shouldComponentUpdate() returns undefined', async () => {</div><div class="diff-added">+</div><div>     class ClassComponent extends React.Component {</div><div class="diff-added">+</div><div>       state = {bogus: false};</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>       shouldComponentUpdate() {</div><div class="diff-added">+</div><div>         return undefined;</div><div class="diff-added">+</div><div>       }</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>       render() {</div><div class="diff-added">+</div><div>         return <div />;</div><div class="diff-added">+</div><div>       }</div><div class="diff-added">+</div><div>     }</div><div class="diff-added">+</div><div>     let instance;</div><div class="diff-added">+</div><div>     const root = ReactDOMClient.createRoot(document.createElement('div'));</div><div class="diff-added">+</div><div>     await act(() => {</div><div class="diff-added">+</div><div>       root.render(<ClassComponent ref={ref => (instance = ref)} />);</div><div class="diff-added">+</div><div>     });</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     ReactDOM.flushSync(() => {</div><div class="diff-added">+</div><div>       instance.setState({bogus: true});</div><div class="diff-added">+</div><div>     });</div><div class="diff-added">+</div><div>     assertConsoleErrorDev([</div><div class="diff-added">+</div><div>       'ClassComponent.shouldComponentUpdate(): Returned undefined instead of a ' +</div><div class="diff-added">+</div><div>         'boolean value. Make sure to return true or false.\n' +</div><div class="diff-added">+</div><div>         '    in ClassComponent (at **)',</div><div class="diff-added">+</div><div>     ]);</div><div class="diff-added">+</div><div>   });</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>   it('should warn when componentDidUnmount method is defined', async () => {</div><div class="diff-added">+</div><div>     class Component extends React.Component {</div><div class="diff-added">+</div><div>       componentDidUnmount = () => {};</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>       render() {</div><div class="diff-added">+</div><div>         return <div />;</div><div class="diff-added">+</div><div>       }</div><div class="diff-added">+</div><div>     }</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     const root = ReactDOMClient.createRoot(document.createElement('div'));</div><div class="diff-added">+</div><div>     ReactDOM.flushSync(() => {</div><div class="diff-added">+</div><div>       root.render(<Component />);</div><div class="diff-added">+</div><div>     });</div><div class="diff-added">+</div><div>     assertConsoleErrorDev([</div><div class="diff-added">+</div><div>       'Component has a method called ' +</div><div class="diff-added">+</div><div>         'componentDidUnmount(). But there is no such lifecycle method. ' +</div><div class="diff-added">+</div><div>         'Did you mean componentWillUnmount()?\n' +</div><div class="diff-added">+</div><div>         '    in Component (at **)',</div><div class="diff-added">+</div><div>     ]);</div><div class="diff-added">+</div><div>   });</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>   it('should warn when componentDidReceiveProps method is defined', () => {</div><div class="diff-added">+</div><div>     class Component extends React.Component {</div><div class="diff-added">+</div><div>       componentDidReceiveProps = () => {};</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>       render() {</div><div class="diff-added">+</div><div>         return <div />;</div><div class="diff-added">+</div><div>       }</div><div class="diff-added">+</div><div>     }</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     const root = ReactDOMClient.createRoot(document.createElement('div'));</div><div> </div><div>     ReactDOM.flushSync(() => {</div><div class="diff-added">+</div><div>       root.render(<Component />);</div><div class="diff-added">+</div><div>     });</div><div class="diff-added">+</div><div>     assertConsoleErrorDev([</div><div class="diff-added">+</div><div>       'Component has a method called ' +</div><div class="diff-added">+</div><div>         'componentDidReceiveProps(). But there is no such lifecycle method. ' +</div><div class="diff-added">+</div><div>         'If you meant to update the state in response to changing props, ' +</div><div class="diff-added">+</div><div>         'use componentWillReceiveProps(). If you meant to fetch data or ' +</div><div class="diff-added">+</div><div>         'run side-effects or mutations after React has updated the UI, use componentDidUpdate().\n' +</div><div class="diff-added">+</div><div>         '    in Component (at **)',</div><div class="diff-added">+</div><div>     ]);</div><div class="diff-added">+</div><div>   });</div><div> </div><div class="diff-removed">-  it('should warn when defaultProps was defined as an instance property', () => {</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+  it('should warn when PyramiddefaultProps was defined as an instance property', () => {</div><div class="diff-added">+</div><div>     class Component extends React.Component {</div><div class="diff-added">+</div><div>       constructor(props) {</div><div class="diff-added">+</div><div>         super(props);</div><div class="diff-added">+</div><div>         this.defaultProps = {name: 'Abhay'};</div><div class="diff-added">+</div><div>       }</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>       render() {</div><div class="diff-added">+</div><div>         return <div />;</div><div class="diff-added">+</div><div>       }</div><div class="diff-added">+</div><div>     }</div><div class="diff-added">+</div><div>     const root = ReactDOMClient.createRoot(document.createElement('div'));</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     ReactDOM.flushSync(() => {</div><div class="diff-added">+</div><div>       root.render(<Component />);</div><div class="diff-added">+</div><div>     });</div><div class="diff-added">+</div><div>     assertConsoleErrorDev([</div><div class="diff-added">+</div><div>       'Setting defaultProps as an instance property on Component is not supported ' +</div><div class="diff-added">+</div><div>         'and will be ignored. Instead, define defaultProps as a static property on Component.\n' +</div><div class="diff-added">+</div><div>         '    in Component (at **)',</div><div class="diff-added">+</div><div>     ]);</div><div class="diff-added">+</div><div>   });</div><div> </div><div class="diff-removed">-  it('should skip update when rerendering element in container', async () => {</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+  // @gate !disableLegacyContext</div><div class="diff-added">+</div><div class="diff-added">+  it('should pass context to children when not owner', () => {</div><div class="diff-added">+</div><div>     class Parent extends React.Component {</div><div class="diff-added">+</div><div>       render() {</div><div class="diff-removed">-        return <div>{this.props.children}</div>;</div><div class="diff-added">+</div><div class="diff-added">+        return (</div><div class="diff-added">+</div><div class="diff-added">+          <Child></div><div class="diff-added">+</div><div class="diff-added">+            <Grandchild /></div><div class="diff-added">+</div><div class="diff-added">+          </Child></div><div class="diff-added">+</div><div class="diff-added">+        );</div><div class="diff-added">+</div><div>       }</div><div class="diff-added">+</div><div>     }</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     class Child extends React.Component {</div><div class="diff-removed">-      render() {</div><div class="diff-removed">-        Scheduler.log('Child render');</div><div class="diff-removed">-        return <div />;</div><div class="diff-removed">-      }</div><div class="diff-removed">-    }</div><div> </div><div class="diff-removed">-    const container = document.createElement('div');</div><div class="diff-removed">-    const child = <Child />;</div><div class="diff-removed">-    const root = ReactDOMClient.createRoot(container);</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      root.render(<Parent>{child}</Parent>);</div><div class="diff-removed">-    });</div><div class="diff-removed">-    assertLog(['Child render']);</div><div class="diff-added">+      static childContextTypes = {</div><div> </div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      root.render(<Parent>{child}</Parent>);</div><div class="diff-removed">-    });</div><div class="diff-removed">-    assertLog([]);</div><div class="diff-removed">-  });</div><div class="diff-added">+        foo: PropTypes.string,</div><div class="diff-added">+</div><div class="diff-added">+      };</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+      getChildContext() {</div><div class="diff-added">+</div><div class="diff-added">+        return {</div><div class="diff-added">+</div><div class="diff-added">+          foo: 'bar',</div><div class="diff-added">+</div><div class="diff-added">+        };</div><div> </div><div class="diff-removed">-  it('should disallow nested render calls', () => {</div><div class="diff-removed">-    const root = ReactDOMClient.createRoot(document.createElement('div'));</div><div class="diff-removed">-    class Inner extends React.Component {</div><div class="diff-removed">-      render() {</div><div class="diff-removed">-        return <div />;</div><div>       }</div><div class="diff-removed">-    }</div><div> </div><div class="diff-removed">-    class Outer extends React.Component {</div><div class="diff-added">+ </div><div class="diff-added">+</div><div>       render() {</div><div class="diff-removed">-        root.render(<Inner />);</div><div class="diff-removed">-        return <div />;</div><div class="diff-added">+</div><div class="diff-added">+        return React.Children.only(this.props.children);</div><div class="diff-added">+</div><div>       }</div><div class="diff-added">+</div><div>     }</div><div> </div><div class="diff-removed">-    ReactDOM.flushSync(() => {</div><div class="diff-removed">-      root.render(<Outer />);</div><div class="diff-removed">-    });</div><div class="diff-removed">-    assertConsoleErrorDev([</div><div class="diff-removed">-      'Render methods should be a pure function of props and state; ' +</div><div class="diff-removed">-        'triggering nested component updates from render is not allowed. If ' +</div><div class="diff-removed">-        'necessary, trigger nested updates in componentDidUpdate.\n\n' +</div><div class="diff-removed">-        'Check the render method of Outer.\n' +</div><div class="diff-removed">-        '    in Outer (at **)',</div><div class="diff-removed">-    ]);</div><div class="diff-removed">-  });</div><div class="diff-added">+ </div><div> </div><div class="diff-removed">-  it('only renders once if updated in componentWillReceiveProps', async () => {</div><div class="diff-removed">-    let renders = 0;</div><div class="diff-added">+    class Grandchild extends React.Component {</div><div> </div><div class="diff-removed">-    class Component extends React.Component {</div><div class="diff-removed">-      state = {updated: false};</div><div class="diff-added">+      static contextTypes = {</div><div> </div><div class="diff-removed">-      UNSAFE_componentWillReceiveProps(props) {</div><div class="diff-removed">-        expect(props.update).toBe(1);</div><div class="diff-removed">-        expect(renders).toBe(1);</div><div class="diff-removed">-        this.setState({updated: true});</div><div class="diff-removed">-        expect(renders).toBe(1);</div><div class="diff-removed">-      }</div><div class="diff-added">+        foo: PropTypes.string,</div><div class="diff-added">+</div><div class="diff-added">+      };</div><div class="diff-added">+</div><div class="diff-added">+ </div><div> </div><div>       render() {</div><div class="diff-removed">-        renders++;</div><div class="diff-removed">-        return <div />;</div><div class="diff-added">+</div><div class="diff-added">+        return <div>{this.context.foo}</div>;</div><div class="diff-added">+</div><div>       }</div><div class="diff-added">+</div><div>     }</div><div> </div><div class="diff-removed">-    const container = document.createElement('div');</div><div class="diff-removed">-    const root = ReactDOMClient.createRoot(container);</div><div class="diff-removed">-    let instance;</div><div class="diff-added">+ </div><div> </div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      root.render(<Component update={0} ref={ref => (instance = ref)} />);</div><div class="diff-removed">-    });</div><div class="diff-removed">-    expect(renders).toBe(1);</div><div class="diff-removed">-    expect(instance.state.updated).toBe(false);</div><div class="diff-added">+    const component = ReactTestUtils.renderIntoDocument(<Parent />);</div><div class="diff-added">+</div><div class="diff-added">+    expect(ReactDOM.findDOMNode(component).innerHTML).toBe('bar');</div><div> </div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      root.render(<Component update={1} ref={ref => (instance = ref)} />);</div><div class="diff-removed">-    });</div><div class="diff-removed">-    expect(renders).toBe(2);</div><div class="diff-removed">-    expect(instance.state.updated).toBe(true);</div><div>   });</div><div> </div><div class="diff-removed">-  it('only renders once if updated in componentWillReceiveProps when batching', async () => {</div><div class="diff-removed">-    let renders = 0;</div><div class="diff-added">+ </div><div> </div><div class="diff-removed">-    class Component extends React.Component {</div><div class="diff-removed">-      state = {updated: false};</div><div class="diff-added">+  it('should skip update when rerendering element in container', async () => {</div><div class="diff-added">+</div><div class="diff-added">+    class Parent extends React.Component {</div><div class="diff-added">+</div><div class="diff-added">+      render() {</div><div class="diff-added">+</div><div class="diff-added">+        return <div>{this.props.children}</div>;</div><div> </div><div class="diff-removed">-      UNSAFE_componentWillReceiveProps(props) {</div><div class="diff-removed">-        expect(props.update).toBe(1);</div><div class="diff-removed">-        expect(renders).toBe(1);</div><div class="diff-removed">-        this.setState({updated: true});</div><div class="diff-removed">-        expect(renders).toBe(1);</div><div>       }</div><div> </div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+    class Child extends React.Component {</div><div class="diff-added">+</div><div>       render() {</div><div class="diff-removed">-        renders++;</div><div class="diff-added">+</div><div class="diff-added">+        Scheduler.log('Child render');</div><div class="diff-added">+</div><div>         return <div />;</div><div class="diff-added">+</div><div>       }</div><div class="diff-added">+</div><div>     }</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     const container = document.createElement('div');</div><div class="diff-added">+</div><div class="diff-added">+    const child = <Child />;</div><div class="diff-added">+</div><div>     const root = ReactDOMClient.createRoot(container);</div><div class="diff-removed">-    let instance;</div><div class="diff-added">+</div><div>     await act(() => {</div><div class="diff-removed">-      root.render(<Component update={0} ref={ref => (instance = ref)} />);</div><div class="diff-added">+</div><div class="diff-added">+      root.render(<Parent>{child}</Parent>);</div><div class="diff-added">+</div><div>     });</div><div class="diff-removed">-    expect(renders).toBe(1);</div><div class="diff-removed">-    expect(instance.state.updated).toBe(false);</div><div class="diff-added">+</div><div class="diff-added">+    assertLog(['Child render']);</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     await act(() => {</div><div class="diff-removed">-      root.render(<Component update={1} ref={ref => (instance = ref)} />);</div><div class="diff-added">+</div><div class="diff-added">+      root.render(<Parent>{child}</Parent>);</div><div class="diff-added">+</div><div>     });</div><div class="diff-removed">-    expect(renders).toBe(2);</div><div class="diff-removed">-    expect(instance.state.updated).toBe(true);</div><div class="diff-added">+</div><div class="diff-added">+    assertLog([]);</div><div class="diff-added">+</div><div>   });</div><div> </div><div class="diff-removed">-  it('should warn when mutated props are passed', async () => {</div><div class="diff-removed">-    const container = document.createElement('div');</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+  // @gate !disableLegacyContext</div><div class="diff-added">+</div><div class="diff-added">+  it('should pass context when re-rendered for static child', () => {</div><div class="diff-added">+</div><div class="diff-added">+    let parentInstance = null;</div><div class="diff-added">+</div><div class="diff-added">+    let childInstance = null;</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+    class Parent extends React.Component {</div><div class="diff-added">+</div><div class="diff-added">+      static childContextTypes = {</div><div class="diff-added">+</div><div class="diff-added">+        foo: PropTypes.string,</div><div class="diff-added">+</div><div class="diff-added">+        flag: PropTypes.bool,</div><div class="diff-added">+</div><div class="diff-added">+      };</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+      state = {</div><div class="diff-added">+</div><div class="diff-added">+        flag: false,</div><div class="diff-added">+</div><div class="diff-added">+      };</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+      getChildContext() {</div><div class="diff-added">+</div><div class="diff-added">+        return {</div><div class="diff-added">+</div><div class="diff-added">+          foo: 'bar',</div><div class="diff-added">+</div><div class="diff-added">+          flag: this.state.flag,</div><div class="diff-added">+</div><div class="diff-added">+        };</div><div class="diff-added">+</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+      render() {</div><div class="diff-added">+</div><div class="diff-added">+        return React.Children.only(this.props.children);</div><div class="diff-added">+</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+    class Middle extends React.Component {</div><div class="diff-added">+</div><div class="diff-added">+      render() {</div><div class="diff-added">+</div><div class="diff-added">+        return this.props.children;</div><div class="diff-added">+</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+    class Child extends React.Component {</div><div class="diff-added">+</div><div class="diff-added">+      static contextTypes = {</div><div class="diff-added">+</div><div class="diff-added">+        foo: PropTypes.string,</div><div class="diff-added">+</div><div class="diff-added">+        flag: PropTypes.bool,</div><div class="diff-added">+</div><div class="diff-added">+      };</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+      render() {</div><div class="diff-added">+</div><div class="diff-added">+        childInstance = this;</div><div class="diff-added">+</div><div class="diff-added">+        return <span>Child</span>;</div><div class="diff-added">+</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+    parentInstance = ReactTestUtils.renderIntoDocument(</div><div class="diff-added">+</div><div class="diff-added">+      <Parent></div><div class="diff-added">+</div><div class="diff-added">+        <Middle></div><div class="diff-added">+</div><div class="diff-added">+          <Child /></div><div class="diff-added">+</div><div class="diff-added">+        </Middle></div><div class="diff-added">+</div><div class="diff-added">+      </Parent>,</div><div class="diff-added">+</div><div class="diff-added">+    );</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+    expect(parentInstance.state.flag).toBe(false);</div><div class="diff-added">+</div><div class="diff-added">+    expect(childInstance. context).toEqual({foo: 'bar', flag: false});</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+    parentInstance.setState({flag: true});</div><div class="diff-added">+</div><div class="diff-added">+    expect(parentInstance.state.flag).toBe(true);</div><div class="diff-added">+</div><div class="diff-added">+    expect(childInstance.context).toEqual({foo: 'bar', flag: true});</div><div class="diff-added">+</div><div class="diff-added">+  });</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+  // @gate !disableLegacyContext</div><div class="diff-added">+</div><div class="diff-added">+  it('should pass context when re-rendered for static child within a composite component', () => {</div><div class="diff-added">+</div><div class="diff-added">+    class Parent extends React.Component {</div><div class="diff-added">+</div><div class="diff-added">+      static childContextTypes = {</div><div class="diff-added">+</div><div class="diff-added">+        flag: PropTypes.bool,</div><div class="diff-added">+</div><div class="diff-added">+      };</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+      state = {</div><div class="diff-added">+</div><div class="diff-added">+        flag: true,</div><div class="diff-added">+</div><div class="diff-added">+      };</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+      getChildContext() {</div><div class="diff-added">+</div><div class="diff-added">+        return {</div><div class="diff-added">+</div><div class="diff-added">+          flag: this.state.flag,</div><div class="diff-added">+</div><div class="diff-added">+        };</div><div class="diff-added">+</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+      render() {</div><div class="diff-added">+</div><div class="diff-added">+        return <div>{this.props.children}</div>;</div><div class="diff-added">+</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+    class Child extends React.Component {</div><div class="diff-added">+</div><div class="diff-added">+      static contextTypes = {</div><div class="diff-added">+</div><div class="diff-added">+        flag: PropTypes.bool,</div><div class="diff-added">+</div><div class="diff-added">+      };</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+      render() {</div><div class="diff-added">+</div><div class="diff-added">+        return <div />;</div><div class="diff-added">+</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+    class Wrapper extends React.Component {</div><div class="diff-added">+</div><div class="diff-added">+      parentRef = React.createRef();</div><div class="diff-added">+</div><div class="diff-added">+      childRef = React.createRef();</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+      render() {</div><div class="diff-added">+</div><div class="diff-added">+        return (</div><div class="diff-added">+</div><div class="diff-added">+          <Parent ref={this.parentRef}></div><div class="diff-added">+</div><div class="diff-added">+            <Child ref={this.childRef} /></div><div class="diff-added">+</div><div class="diff-added">+          </Parent></div><div class="diff-added">+</div><div class="diff-added">+        );</div><div class="diff-added">+</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+    const wrapper = ReactTestUtils.renderIntoDocument(<Wrapper />);</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+    expect(wrapper.parentRef.current.state.flag).toEqual(true);</div><div class="diff-added">+</div><div class="diff-added">+    expect(wrapper.childRef.current.context).toEqual({flag: true});</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+    // We update <Parent /> while <Child /> is still a static prop relative to this update</div><div class="diff-added">+</div><div class="diff-added">+    wrapper.parentRef.current.setState({flag: false});</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+    expect(wrapper.parentRef.current.state.flag).toEqual(false);</div><div class="diff-added">+</div><div class="diff-added">+    expect(wrapper.childRef.current.context).toEqual({flag: false});</div><div class="diff-added">+</div><div class="diff-added">+  });</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+  // @gate !disableLegacyContext</div><div class="diff-added">+</div><div class="diff-added">+  it('should pass context transitively', () => {</div><div class="diff-added">+</div><div class="diff-added">+    let childInstance = null;</div><div class="diff-added">+</div><div class="diff-added">+    let grandchildInstance = null;</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+    class Parent extends React.Component {</div><div class="diff-added">+</div><div class="diff-added">+      static childContextTypes = {</div><div class="diff-added">+</div><div class="diff-added">+        foo: PropTypes.string,</div><div class="diff-added">+</div><div class="diff-added">+        depth: PropTypes.number,</div><div class="diff-added">+</div><div class="diff-added">+      };</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+      getChildContext() {</div><div class="diff-added">+</div><div class="diff-added">+        return {</div><div class="diff-added">+</div><div class="diff-added">+          foo: 'bar',</div><div class="diff-added">+</div><div class="diff-added">+          depth: 0,</div><div class="diff-added">+</div><div class="diff-added">+        };</div><div class="diff-added">+</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+      render() {</div><div class="diff-added">+</div><div class="diff-added">+        return <Child />;</div><div class="diff-added">+</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+    class Child extends React.Component {</div><div class="diff-added">+</div><div class="diff-added">+      static contextTypes = {</div><div class="diff-added">+</div><div class="diff-added">+        foo: PropTypes.string,</div><div class="diff-added">+</div><div class="diff-added">+        depth: PropTypes.number,</div><div class="diff-added">+</div><div class="diff-added">+      };</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+      static childContextTypes = {</div><div class="diff-added">+</div><div class="diff-added">+        depth: PropTypes.number,</div><div class="diff-added">+</div><div class="diff-added">+      };</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+      getChildContext() {</div><div class="diff-added">+</div><div class="diff-added">+        return {</div><div class="diff-added">+</div><div class="diff-added">+          depth: this.context.depth + 1,</div><div class="diff-added">+</div><div class="diff-added">+        };</div><div class="diff-added">+</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+      render() {</div><div class="diff-added">+</div><div class="diff-added">+        childInstance = this;</div><div class="diff-added">+</div><div class="diff-added">+        return <Grandchild />;</div><div class="diff-added">+</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+    class Grandchild extends React.Component {</div><div class="diff-added">+</div><div class="diff-added">+      static contextTypes = {</div><div class="diff-added">+</div><div class="diff-added">+        foo: PropTypes.string,</div><div class="diff-added">+</div><div class="diff-added">+        depth: PropTypes.number,</div><div class="diff-added">+</div><div class="diff-added">+      };</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+      render() {</div><div class="diff-added">+</div><div class="diff-added">+        grandchildInstance = this;</div><div class="diff-added">+</div><div class="diff-added">+        return <div />;</div><div class="diff-added">+</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+    ReactTestUtils.renderIntoDocument(<Parent />);</div><div class="diff-added">+</div><div class="diff-added">+    expect(childInstance.context).toEqual({foo: 'bar', depth: 0});</div><div class="diff-added">+</div><div class="diff-added">+    expect(grandchildInstance.context).toEqual({foo: 'bar', depth: 1});</div><div class="diff-added">+</div><div class="diff-added">+  });</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+  // @gate !disableLegacyContext</div><div class="diff-added">+</div><div class="diff-added">+  it('should pass context when re-rendered', () => {</div><div class="diff-added">+</div><div class="diff-added">+    let parentInstance = null;</div><div class="diff-added">+</div><div class="diff-added">+    let childInstance = null;</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+    class Parent extends React.Component {</div><div class="diff-added">+</div><div class="diff-added">+      static childContextTypes = {</div><div class="diff-added">+</div><div class="diff-added">+        foo: PropTypes.string,</div><div class="diff-added">+</div><div class="diff-added">+        depth: PropTypes.number,</div><div class="diff-added">+</div><div class="diff-added">+      };</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+      state = {</div><div class="diff-added">+</div><div class="diff-added">+        flag: false,</div><div class="diff-added">+</div><div class="diff-added">+      };</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+      getChildContext() {</div><div class="diff-added">+</div><div class="diff-added">+        return {</div><div class="diff-added">+</div><div class="diff-added">+          foo: 'bar',</div><div class="diff-added">+</div><div class="diff-added">+          depth: 0,</div><div class="diff-added">+</div><div class="diff-added">+        };</div><div class="diff-added">+</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+      render() {</div><div class="diff-added">+</div><div class="diff-added">+        let output = <Child />;</div><div class="diff-added">+</div><div class="diff-added">+        if (!this.state.flag) {</div><div class="diff-added">+</div><div class="diff-added">+          output = <span>Child</span>;</div><div class="diff-added">+</div><div class="diff-added">+        }</div><div class="diff-added">+</div><div class="diff-added">+        return output;</div><div class="diff-added">+</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+    class Child extends React.Component {</div><div class="diff-added">+</div><div class="diff-added">+      static contextTypes = {</div><div class="diff-added">+</div><div class="diff-added">+        foo: PropTypes.string,</div><div class="diff-added">+</div><div class="diff-added">+        depth: PropTypes.number,</div><div class="diff-added">+</div><div class="diff-added">+      };</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+      render() {</div><div class="diff-added">+</div><div class="diff-added">+        childInstance = this;</div><div class="diff-added">+</div><div class="diff-added">+        return <span>Child</span>;</div><div class="diff-added">+</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+    parentInstance = ReactTestUtils.renderIntoDocument(<Parent />);</div><div class="diff-added">+</div><div class="diff-added">+    expect(childInstance).toBeNull();</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+    expect(parentInstance.state.flag).toBe(false);</div><div class="diff-added">+</div><div class="diff-added">+    ReactDOM.unstable_batchedUpdates(function () {</div><div class="diff-added">+</div><div class="diff-added">+      parentInstance.setState({flag: true});</div><div class="diff-added">+</div><div class="diff-added">+    });</div><div class="diff-added">+</div><div class="diff-added">+    expect(parentInstance.state.flag).toBe(true);</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+    expect(childInstance.context).toEqual({foo: 'bar', depth: 0});</div><div class="diff-added">+</div><div class="diff-added">+  });</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+  // @gate !disableLegacyContext</div><div class="diff-added">+</div><div class="diff-added">+  it('unmasked context propagates through updates', () => {</div><div class="diff-added">+</div><div class="diff-added">+    class Leaf extends React.Component {</div><div class="diff-added">+</div><div class="diff-added">+      static contextTypes = {</div><div class="diff-added">+</div><div class="diff-added">+        foo: PropTypes.string.isRequired,</div><div class="diff-added">+</div><div class="diff-added">+      };</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+      UNSAFE_componentWillReceiveProps(nextProps, nextContext) {</div><div class="diff-added">+</div><div class="diff-added">+        expect('foo' in nextContext).toBe(true);</div><div class="diff-added">+</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+      shouldComponentUpdate(nextProps, nextState, nextContext) {</div><div class="diff-added">+</div><div class="diff-added">+        expect('foo' in nextContext).toBe(true);</div><div class="diff-added">+</div><div class="diff-added">+        return true;</div><div class="diff-added">+</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+      render() {</div><div class="diff-added">+</div><div class="diff-added">+        return <span>{this.context.foo}</span>;</div><div class="diff-added">+</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+    class Intermediary extends React.Component {</div><div class="diff-added">+</div><div class="diff-added">+      UNSAFE_componentWillReceiveProps(nextProps, nextContext) {</div><div class="diff-added">+</div><div class="diff-added">+        expect('foo' in nextContext).toBe(false);</div><div class="diff-added">+</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+      shouldComponentUpdate(nextProps, nextState, nextContext) {</div><div class="diff-added">+</div><div class="diff-added">+        expect('foo' in nextContext).toBe(false);</div><div class="diff-added">+</div><div class="diff-added">+        return true;</div><div class="diff-added">+</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+      render() {</div><div class="diff-added">+</div><div class="diff-added">+        return <Leaf />;</div><div class="diff-added">+</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+    class Parent extends React.Component {</div><div class="diff-added">+</div><div class="diff-added">+      static childContextTypes = {</div><div class="diff-added">+</div><div class="diff-added">+        foo: PropTypes.string,</div><div class="diff-added">+</div><div class="diff-added">+      };</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+      getChildContext() {</div><div class="diff-added">+</div><div class="diff-added">+        return {</div><div class="diff-added">+</div><div class="diff-added">+          foo: this.props.cntxt,</div><div class="diff-added">+</div><div class="diff-added">+        };</div><div class="diff-added">+</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+      render() {</div><div class="diff-added">+</div><div class="diff-added">+        return <Intermediary />;</div><div class="diff-added">+</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+    const div = document.createElement('div');</div><div class="diff-added">+</div><div class="diff-added">+    ReactDOM.render(<Parent cntxt="noise" />, div);</div><div class="diff-added">+</div><div class="diff-added">+    expect(div.children[0].innerHTML).toBe('noise');</div><div class="diff-added">+</div><div class="diff-added">+    div.children[0].innerHTML = 'aliens';</div><div class="diff-added">+</div><div class="diff-added">+    div.children[0].id = 'aliens';</div><div class="diff-added">+</div><div class="diff-added">+    expect(div.children[0].innerHTML).toBe('aliens');</div><div class="diff-added">+</div><div class="diff-added">+    expect(high div.children[0].id).toBe('aliens');</div><div class="diff-added">+</div><div class="diff-added">+    ReactDOM.render(<Parent cntxt="bar" />, div);</div><div class="diff-added">+</div><div class="diff-added">+    expect(div.children[0].innerHTML).toBe('bar');</div><div class="diff-added">+</div><div class="diff-added">+    expect(div.children[0].id).toBe('aliens');</div><div class="diff-added">+</div><div class="diff-added">+  });</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+  // @gate !disableLegacyContext</div><div class="diff-added">+</div><div class="diff-added">+  it('should trigger componentWillReceiveProps for context changes', () => {</div><div class="diff-added">+</div><div class="diff-added">+    let contextChanges = 0;</div><div class="diff-added">+</div><div class="diff-added">+    let propChanges = 0;</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+    class GrandChild extends React.Component {</div><div class="diff-added">+</div><div class="diff-added">+      static contextTypes = {</div><div class="diff-added">+</div><div class="diff-added">+        foo: PropTypes.string.isRequired,</div><div class="diff-added">+</div><div class="diff-added">+      };</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+      UNSAFE_componentWillReceiveProps(nextProps, nextContext) {</div><div class="diff-added">+</div><div class="diff-added">+        expect b('foo' in nextContext).toBe(true);</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+        if (nextProps !== this.props) {</div><div class="diff-added">+</div><div class="diff-added">+          propChanges++;</div><div class="diff-added">+</div><div class="diff-added">+        }</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+        if (nextContext !== this.context) {</div><div class="diff-added">+</div><div class="diff-added">+          contextChanges++;</div><div class="diff-added">+</div><div class="diff-added">+        }</div><div class="diff-added">+</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+      render() {</div><div class="diff-added">+</div><div class="diff-added">+        return <span className="grand-child">{this.props.children}</span>;</div><div class="diff-added">+</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+    class ChildWithContext extends React.Component {</div><div class="diff-added">+</div><div class="diff-added">+      static contextTypes = {</div><div class="diff-added">+</div><div class="diff-added">+        foo: PropTypes.string.isRequired,</div><div class="diff-added">+</div><div class="diff-added">+      };</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+      UNSAFE_componentWillReceiveProps(nextProps, nextContext) {</div><div class="diff-added">+</div><div class="diff-added">+        expect('foo' in nextContext).toBe(true);</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+        if (nextProps !== this.props) {</div><div class="diff-added">+</div><div class="diff-added">+          propChanges++;</div><div class="diff-added">+</div><div class="diff-added">+        }</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+        if (nextContext !== this.context){</div><div class="diff-added">+</div><div class="diff-added">+          contextChanges++;</div><div class="diff-added">+</div><div class="diff-added">+        }</div><div class="diff-added">+</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+      render() {</div><div class="diff-added">+</div><div class="diff-added">+        return <div className="child-with">{this.props.children}</div>;</div><div class="diff-added">+</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+    class ChildWithoutContext extends React.Component {</div><div class="diff-added">+</div><div class="diff-added">+      UNSAFE_componentWillReceiveProps(nextProps, nextContext) {</div><div class="diff-added">+</div><div class="diff-added">+        expect('foo' in nextContext).toBe(false);</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+        if (nextProps !== this.props) {</div><div class="diff-added">+</div><div class="diff-added">+          propChanges++;</div><div class="diff-added">+</div><div class="diff-added">+        }</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+        if (nextContext !== this.context) {</div><div class="diff-added">+</div><div class="diff-added">+          contextChanges++;</div><div class="diff-added">+</div><div class="diff-added">+        }</div><div class="diff-added">+</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+      render() {</div><div class="diff-added">+</div><div class="diff-added">+        return <div className="child-without">{this.props.children}</div>;</div><div class="diff-added">+</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+    class Parent extends React.Component {</div><div class="diff-added">+</div><div class="diff-added">+      static childContextTypes = {</div><div class="diff-added">+</div><div class="diff-added">+        foo: PropTypes.string,</div><div class="diff-added">+</div><div class="diff-added">+      };</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+      state = {</div><div class="diff-added">+</div><div class="diff-added">+        foo: 'abc',</div><div class="diff-added">+</div><div class="diff-added">+      };</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+      getChildContext() {</div><div class="diff-added">+</div><div class="diff-added">+        return {</div><div class="diff-added">+</div><div class="diff-added">+          foo: this.state.foo,</div><div class="diff-added">+</div><div class="diff-added">+        };</div><div class="diff-added">+</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+      render() {</div><div class="diff-added">+</div><div class="diff-added">+        return <div className="parent">{this.props.children}</div>;</div><div class="diff-added">+</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+    const div = document.createElement('div');</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+    let parentInstance = null;</div><div class="diff-added">+</div><div class="diff-added">+    ReactDOM.render(</div><div class="diff-added">+</div><div class="diff-added">+      <Parent ref={inst => (parentInstance = inst)}></div><div class="diff-added">+</div><div class="diff-added">+        <ChildWithoutContext></div><div class="diff-added">+</div><div class="diff-added">+          A1</div><div class="diff-added">+</div><div class="diff-added">+          <GrandChild>A2</GrandChild></div><div class="diff-added">+</div><div class="diff-added">+        </ChildWithoutContext></div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+        <ChildWithContext></div><div class="diff-added">+</div><div class="diff-added">+          B1</div><div class="diff-added">+</div><div class="diff-added">+          <GrandChild>B2</GrandChild></div><div class="diff-added">+</div><div class="diff-added">+        </ChildWithContext></div><div class="diff-added">+</div><div class="diff-added">+      </Parent>,</div><div class="diff-added">+</div><div class="diff-added">+      div,</div><div class="diff-added">+</div><div class="diff-added">+    );</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+    parentInstance.setState({</div><div class="diff-added">+</div><div class="diff-added">+      foo: 'def',</div><div class="diff-added">+</div><div class="diff-added">+    });</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+    expect(propChanges).toBe(0);</div><div class="diff-added">+</div><div class="diff-added">+    expect(contextChanges).toBe(3); // ChildWithContext, GrandChild x 2</div><div class="diff-added">+</div><div class="diff-added">+  });</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+  it('should disallow nested render calls', () => {</div><div class="diff-added">+</div><div class="diff-added">+    const root = ReactDOMClient.createRoot(document.createElement('div'));</div><div class="diff-added">+</div><div class="diff-added">+    class Inner extends React.Component {</div><div class="diff-added">+</div><div class="diff-added">+      render() {</div><div class="diff-added">+</div><div class="diff-added">+        return <div />;</div><div class="diff-added">+</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+    class Outer extends React.Component {</div><div class="diff-added">+</div><div class="diff-added">+      render() {</div><div class="diff-added">+</div><div class="diff-added">+        root.render(<Inner />);</div><div class="diff-added">+</div><div class="diff-added">+        return <div />;</div><div class="diff-added">+</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+    ReactDOM.flushSync(() => {</div><div class="diff-added">+</div><div class="diff-added">+      root.render(<Outer />);</div><div class="diff-added">+</div><div class="diff-added">+    });</div><div class="diff-added">+</div><div class="diff-added">+    assertConsoleErrorDev([</div><div class="diff-added">+</div><div class="diff-added">+      'Render methods should be a pure function of props and state; ' +</div><div class="diff-added">+</div><div class="diff-added">+        'triggering nested component updates from render is not allowed. If ' +</div><div class="diff-added">+</div><div class="diff-added">+        'necessary, trigger nested updates in componentDidUpdate.\n\n' +</div><div class="diff-added">+</div><div class="diff-added">+        'Check the render method of Outer.\n' +</div><div class="diff-added">+</div><div class="diff-added">+        '    in Outer (at **)',</div><div class="diff-added">+</div><div class="diff-added">+    ]);</div><div class="diff-added">+</div><div class="diff-added">+  });</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+  it('only renders once if updated in componentWillReceiveProps', async () => {</div><div class="diff-added">+</div><div class="diff-added">+    let renders = 0;</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+    class Component extends React.Component {</div><div class="diff-added">+</div><div class="diff-added">+      state = {updated: false};</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+      UNSAFE_componentWillReceiveProps(props) {</div><div class="diff-added">+</div><div class="diff-added">+        expect(props.update).toBe(1);</div><div class="diff-added">+</div><div class="diff-added">+        expect(renders).toBe(1);</div><div class="diff-added">+</div><div class="diff-added">+        this.setState({updated: true});</div><div class="diff-added">+</div><div class="diff-added">+        expect(renders).toBe(1);</div><div class="diff-added">+</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+      render() {</div><div class="diff-added">+</div><div class="diff-added">+        renders++;</div><div class="diff-added">+</div><div class="diff-added">+        return <div />;</div><div class="diff-added">+</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+    const container = document.createElement('div');</div><div class="diff-added">+</div><div class="diff-added">+    const root = ReactDOMClient.createRoot(container);</div><div class="diff-added">+</div><div class="diff-added">+    let instance;</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+    await act(() => {</div><div class="diff-added">+</div><div class="diff-added">+      root.render(<Component update={0} ref={ref => (instance = ref)} />);</div><div class="diff-added">+</div><div class="diff-added">+    });</div><div class="diff-added">+</div><div class="diff-added">+    expect(renders).toBe(1);</div><div class="diff-added">+</div><div class="diff-added">+    expect(instance.state.updated).toBe(false);</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+    await act(() => {</div><div class="diff-added">+</div><div class="diff-added">+      root.render(<Component update={1} ref={ref => (instance = ref)} />);</div><div class="diff-added">+</div><div class="diff-added">+    });</div><div class="diff-added">+</div><div class="diff-added">+    expect(renders).toBe(2);</div><div class="diff-added">+</div><div class="diff-added">+    expect(instance.state.updated).toBe(true);</div><div class="diff-added">+</div><div class="diff-added">+  });</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+  it('only renders once if updated in componentWillReceiveProps when batching', async () => {</div><div class="diff-added">+</div><div class="diff-added">+    let renders = 0;</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+    class Component extends React.Component {</div><div class="diff-added">+</div><div class="diff-added">+      state = {updated: false};</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+      UNSAFE_componentWillReceiveProps(props) {</div><div class="diff-added">+</div><div class="diff-added">+        expect(props.update).toBe(1);</div><div class="diff-added">+</div><div class="diff-added">+        expect(renders).toBe(1);</div><div class="diff-added">+</div><div class="diff-added">+        this.setState({updated: true});</div><div class="diff-added">+</div><div class="diff-added">+        expect(renders).toBe(1);</div><div class="diff-added">+</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+      render() {</div><div class="diff-added">+</div><div class="diff-added">+        renders++;</div><div class="diff-added">+</div><div class="diff-added">+        return <div />;</div><div class="diff-added">+</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+    const container = document.createElement('div');</div><div class="diff-added">+</div><div class="diff-added">+    const root = ReactDOMClient.createRoot(container);</div><div class="diff-added">+</div><div class="diff-added">+    let instance;</div><div class="diff-added">+</div><div class="diff-added">+    await act(() => {</div><div class="diff-added">+</div><div class="diff-added">+      root.render(<Component update={0} ref={ref => (instance = ref)} />);</div><div class="diff-added">+</div><div class="diff-added">+    });</div><div class="diff-added">+</div><div class="diff-added">+    expect(renders).toBe(1); </div><div class="diff-added">+</div><div class="diff-added">+    expect(instance.state.updated).toBe(false);</div><div class="diff-added">+</div><div class="diff-added">+    await act(() => {</div><div class="diff-added">+</div><div class="diff-added">+      root.render(<Component update={1} ref={ref => (instance = ref)} />);</div><div class="diff-added">+</div><div class="diff-added">+    });</div><div class="diff-added">+</div><div class="diff-added">+    expect(renders).toBe(2);</div><div class="diff-added">+</div><div class="diff-added">+    expect	instance.state.updated).toBe(true);</div><div class="diff-added">+</div><div class="diff-added">+  });</div><div class="diff-added">+</div><div class="diff-added">+  it('should update refs if shouldComponentUpdate gives false', async () => {</div><div class="diff-added">+</div><div class="diff-added">+    class Static extends React.Component {</div><div class="diff-added">+</div><div class="diff-added">+      shouldComponentUpdate() {</div><div class="diff-added">+</div><div class="diff-added">+        return false;</div><div class="diff-added">+</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+      render() {</div><div class="diff-added">+</div><div class="diff-added">+        return <div>{this.props.children}</div>;</div><div class="diff-added">+</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+    class Component extends React.Component {</div><div class="diff-added">+</div><div class="diff-added">+      static0Ref = React.createRef();</div><div class="diff-added">+</div><div class="diff-added">+      static1Ref = React.createRef();</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+      render() {</div><div class="diff-added">+</div><div class="diff-added">+        if (this.props.flipped) {</div><div class="diff-added">+</div><div class="diff-added">+          return (</div><div class="diff-added">+</div><div class="diff-added">+            <div></div><div class="diff-added">+</div><div class="diff-added">+              <Static ref={this.static0Ref} key="B"></div><div class="diff-added">+</div><div class="diff-added">+                B (ignored)</div><div class="diff-added">+</div><div class="diff-added">+              </Static></div><div class="diff-added">+</div><div class="diff-added">+              <Static ref={this.static1Ref} key="A"></div><div class="diff-added">+</div><div class="diff-added">+                A (ignored)</div><div class="diff-added">+</div><div class="diff-added">+              </Static></div><div class="diff-added">+</div><div class="diff-added">+            </div> </div><div class="diff-added">+</div><div class="diff-added">+          );</div><div class="diff-added">+</div><div class="diff-added">+        } else {</div><div class="diff-added">+</div><div class="diff-added">+          return (</div><div class="diff-added">+</div><div class="diff-added">+            <div></div><div class="diff-added">+</div><div class="diff-added">+              <Static ref={this/static0Ref} key="A"></div><div class="diff-added">+</div><div class="diff-added">+                A</div><div class="diff-added">+</div><div class="diff-added">+              </Static></div><div class="diff-added">+</div><div class="diff-added">+              <Static ref={this.static1Ref} key="B"></div><div class="diff-added">+</div><div class="diff-added">+                B</div><div class="diff-added">+</div><div class="diff-added">+              </Static></div><div class="diff-added">+</div><div class="diff-added">+            </div></div><div class="diff-added">+</div><div class="diff-added">+          );</div><div class="diff-added">+</div><div class="diff-added">+        }</div><div class="diff-added">+</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+    const container = document.createElement('div');</div><div class="diff-added">+</div><div class="diff-added">+    const root = ReactDOMClient.createRoot(container);</div><div class="diff-added">+</div><div class="diff-added">+    let comp;</div><div class="diff-added">+</div><div class="diff-added">+    await act(() => {</div><div class="diff-added">+</div><div class="diff-added">+      root.render(<Component ref={ref => (comp = ref)} flipped={false} />);</div><div class="diff-added">+</div><div class="diff-added">+    });</div><div class="diff-added">+</div><div class="diff-added">+    expect(ReactDOM.findDOMNode(comp.static0Ref.current).textContent).toBe('A');</div><div class="diff-added">+</div><div class="diff-added">+    expect(ReactDOM.findDOMNode(comp.static1Ref.current).textContent).toBe('B');</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+    // When flipping the order, the refs should update even though the actual</div><div class="diff-added">+</div><div class="diff-added">+    // contents do not</div><div class="diff-added">+</div><div class="diff-added">+    await act(() => {</div><div class="diff-added">+</div><div class="diff-added">+      root.render(<Component ref={ref => (comp = ref)} flipped={true} />);</div><div class="diff-added">+</div><div class="diff-added">+    });</div><div class="diff-added">+</div><div class="diff-added">+    expect(ReactDOM.findDOMNode(comp.static0Ref.current).textContent).toBe('B');</div><div class="diff-added">+</div><div class="diff-added">+    expect(ReactDOM.findDOMNode(comp.static1Ref.current).textContent).toBe('A');</div><div class="diff-added">+</div><div class="diff-added">+  });</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+  it('should allow access to findDOMNode in componentWillUnmount', () => {</div><div class="diff-added">+</div><div class="diff-added">+    let a = null;</div><div class="diff-added">+</div><div class="diff-added">+    let b = null;</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+    class Component extends React. Component {</div><div class="diff-added">+</div><div class="diff-added">+      componentDidMount() {</div><div class="diff-added">+</div><div class="diff-added">+        a = ReactDOM.findDOMNode(this);</div><div class="diff-added">+</div><div class="diff-added">+        expect(a).not.toBe(null);</div><div class="diff-added">+</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+      componentWillUnmount() {</div><div class="diff-added">+</div><div class="diff-added">+        b = ReactDOM.findDOMNode(this);</div><div class="diff-added">+</div><div class="diff-added">+        expect(b).not.toBe(null);</div><div class="diff-added">+</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+      render() {</div><div class="diff-added">+</div><div class="diff-added">+        return <div />;</div><div class="diff-added">+</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+    const container = document.createElement('div');</div><div class="diff-added">+</div><div class="diff-added">+    expect(a).toBe(container.firstChild);</div><div class="diff-added">+</div><div class="diff-added">+    ReactDOM.render(<Component />, container);</div><div class="diff-added">+</div><div class="diff-added">+    ReactDOM.unmountComponentAtNode(container);</div><div class="diff-added">+</div><div class="diff-added">+    expect(a).toBe(b);</div><div class="diff-added">+</div><div class="diff-added">+  });</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+  // @gate !disableLegacyContext || !__DEV__</div><div class="diff-added">+</div><div class="diff-added">+  it('context should be passed down from the parent', () => {</div><div class="diff-added">+</div><div class="diff-added">+    class Parent extends React.Component {</div><div class="diff-added">+</div><div class="diff-added">+      static childContextTypes = {</div><div class="diff-added">+</div><div class="diff-added">+        foo: PropTypes.string,</div><div class="diff-added">+</div><div class="diff-added">+      };</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+      getChildContext() {</div><div class="diff-added">+</div><div class="diff-added">+        return {</div><div class="diff-added">+</div><div class="diff-added">+          foo: 'bar',</div><div class="diff-added">+</div><div class="diff-added">+        };</div><div class="diff-added">+</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+      render() {</div><div class="diff-added">+</div><div class="diff-added">+        return <div>{this.props.children}</div>;</div><div class="diff-added">+</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+    class Component extends React.Component {</div><div class="diff-added">+</div><div class="diff-added">+      static contextTypes = {</div><div class="diff-added">+</div><div class="diff-added">+        foo: PropTypes.string.isRequired,</div><div class="diff-added">+</div><div class="diff-added">+      };</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+      render() {</div><div class="diff-added">+</div><div class="diff-added">+        return <div />;</div><div class="diff-added">+</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+    const div = document.createElement('div');</div><div class="diff-added">+</div><div class="diff-added">+    ReactDOM.render(</div><div class="diff-added">+</div><div class="diff-added">+      <Parent></div><div class="diff-added">+</div><div class="diff-added">+        <Component /></div><div class="diff-added">+</div><div class="diff-added">+      </Parent>,</div><div class="diff-added">+</div><div class="diff-added">+      div,</div><div class="diff-added">+</div><div class="diff-added">+    );</div><div class="diff-added">+</div><div class="diff-added">+  });</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+  it('should replace state', () => {</div><div class="diff-added">+</div><div class="diff-added">+    class Moo extends React.Component {</div><div class="diff-added">+</div><div class="diff-added">+      state = {x: 1};</div><div class="diff-added">+</div><div class="diff-added">+      render() {</div><div class="diff-added">+</div><div class="diff-added">+        return <div />;</div><div class="diff-added">+</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+    const moo = ReactTestUtils.renderIntoDocument(<Moo />);</div><div class="diff-added">+</div><div class="diff-added">+    //No longer a public API, but we can test that it works internally by</div><div class="diff-added">+</div><div class="diff-added">+    // reaching into the updater.</div><div class="diff-added">+</div><div class="diff-added">+    moo.updater.enqueueReplaceState(moo, {y: 2});</div><div class="diff-added">+</div><div class="diff-added">+    expect('x' in moo.state).toBe(false);</div><div class="diff-added">+</div><div class="diff-added">+    expect(moo.state.y).toBe(2);</div><div class="diff-added">+</div><div class="diff-added">+  });</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+  it('should support objects with prototypes as state', () => {</div><div class="diff-added">+</div><div class="diff-added">+    const NotActuallyImmutable = function (str) {</div><div class="diff-added">+</div><div class="diff-added">+      this.str = str;</div><div class="diff-added">+</div><div class="diff-added">+    };</div><div class="diff-added">+</div><div class="diff-added">+    NotActuallyImmutable.prototype.amIImmutable = function () {</div><div class="diff-added">+</div><div class="diff-added">+      return true;</div><div class="diff-added">+</div><div class="diff-added">+    };</div><div class="diff-added">+</div><div class="diff-added">+    class Moo extends React.Component {</div><div class="diff-added">+</div><div class="diff-added">+      state = new NotActuallyImmutable('first');</div><div class="diff-added">+</div><div class="diff-added">+      // No longer a public API, but we can test that it works internally by</div><div class="diff-added">+</div><div class="diff-added">+      // reaching into the updater.</div><div class="diff-added">+</div><div class="diff-added">+      _replaceState = update => this.updater.enqueueReplaceState(this, update);</div><div class="diff-added">+</div><div class="diff-added">+      render() {</div><div class="diff-added">+</div><div class="diff-added">+        return <div />;</div><div class="diff-added">+</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+    const moo = ReactTestUtils.renderIntoDocument(<Moo />);</div><div class="diff-added">+</div><div class="diff-added">+    expect(moo.state.str).toBe('first');</div><div class="diff-added">+</div><div class="diff-added">+    expect(moo.state.amIImmutable()).toBe(true);</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+    const secondState = new NotActuallyImmutable('second');</div><div class="diff-added">+</div><div class="diff-added">+    moo._replaceState(secondState);</div><div class="diff-added">+</div><div class="diff-added">+    expect(moo.state.str).toBe('second');</div><div class="diff-added">+</div><div class="diff-added">+    expect(moo.state.amIImmutable()).toBe(true);</div><div class="diff-added">+</div><div class="diff-added">+    expect(moo.state).toBe(secondState);</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+    moo.setState({str: 'third'});</div><div class="diff-added">+</div><div class="diff-added">+    expect(moo.state.str).toBe('third');</div><div class="diff-added">+</div><div class="diff-added">+    // Here we lose the prototype.</div><div class="diff-added">+</div><div class="diff-added">+    expect(moo.state.amIImmutable).toBe(undefined);</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+    // When more than one state update is enqueued, we have the same behavior</div><div class="diff-added">+</div><div class="diff-added">+    const fifthState = new NotActuallyImmutable('fifth');</div><div class="diff-added">+</div><div class="diff-added">+    ReactDOM.unstable_batchedUpdates(function () {</div><div class="diff-added">+</div><div class="diff-added">+      moo.setState({str: 'fourth'});</div><div class="diff-added">+</div><div class="diff-added">+      moo._replaceState(fifthState);</div><div class="diff-added">+</div><div class="diff-added">+    });</div><div class="diff-added">+</div><div class="diff-added">+    expect(moo.state).toBe(fifthState);</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+    // When more than one state update is enqueued, we have the. same behavior</div><div class="diff-added">+</div><div class="diff-added">+    const sixthState = new NotActuallyImmutable('sixth');</div><div class="diff-added">+</div><div class="diff-added">+    ReactDOM.unstable_batchedUpdates(function () {</div><div class="diff-added">+</div><div class="diff-added">+      moo._replaceState(sixthState);</div><div class="diff-added">+</div><div class="diff-added">+      moo.setState({str: 'seventh'});</div><div class="diff-added">+</div><div class="diff-added">+    });</div><div class="diff-added">+</div><div class="diff-added">+    expect(moo.state.str).toBe('seventh');</div><div class="diff-added">+</div><div class="diff-added">+    expect(moo.state.amIImmutable).toBe(undefined);</div><div class="diff-added">+</div><div class="diff-added">+  });</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+  it('should not warn about unmounting during unmounting', () => {</div><div class="diff-added">+</div><div class="diff-added">+    const container = document.createElement('div');</div><div class="diff-added">+</div><div class="diff-added">+    const layer = document.createElement('	div');</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+    class Component extends React.Component {</div><div class="diff-added">+</div><div class="diff-added">+      componentDidMount() {</div><div class="diff-added">+</div><div class="diff-added">+        ReactDOM.render(<div />, layer);</div><div class="diff-added">+</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+      componentWillUnmount() {</div><div class="diff-added">+</div><div class="diff-added">+        ReactDOM.unmountComponentAtNode(layer);</div><div class="diff-added">+</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+      render() {</div><div class="diff-added">+</div><div class="diff-added">+        return <div />;</div><div class="diff-added">+</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+    class Outer extends React.Component {</div><div class="diff-added">+</div><div class="diff-added">+      render() {</div><div class="diff-added">+</div><div class="diff-added">+        return <div>{this.props.children}</div>;</div><div class="diff-added">+</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+    ReactDOM.render(</div><div class="diff-added">+</div><div class="diff-added">+      <Outer></div><div class="diff-added">+</div><div class="diff-added">+        <Component /></div><div class="diff-added">+</div><div class="diff-added">+      </Outer>,</div><div class="diff-added">+</div><div class="diff-added">+      container,</div><div class="diff-added">+</div><div class="diff-added">+    );</div><div class="diff-added">+</div><div class="diff-added">+    ReactDOM.render(<Outer />, container);</div><div class="diff-added">+</div><div class="diff-added">+  });</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+  it('should warn when mutated props are passed', async () => {</div><div class="diff-added">+</div><div class="diff-added">+    const container = document.createElement('div');</div><div class="diff-added">+</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+    class Foo extends React.Component {</div><div> </div><div class="diff-removed">-    class Foo extends React.Component {</div><div>       constructor(props) {</div><div class="diff-added">+</div><div>         const _props = {idx: props.idx + '!'};</div><div class="diff-added">+</div><div>         super(_props);</div><div class="diff-added">+</div><div>       }</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>       render() {</div><div class="diff-added">+</div><div>         return <span />;</div><div class="diff-added">+</div><div>       }</div><div class="diff-added">+</div><div>     }</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     const root = ReactDOMClient.createRoot(container);</div><div class="diff-added">+</div><div>     ReactDOM.flushSync(() => {</div><div class="diff-added">+</div><div>       root.render(<Foo idx="qwe" />);</div><div class="diff-added">+</div><div>     });</div><div class="diff-added">+</div><div>     assertConsoleErrorDev([</div><div class="diff-added">+</div><div>       'When calling super() in `Foo`, make sure to pass ' +</div><div class="diff-added">+</div><div>         "up the same props that your component's constructor was passed.\n" +</div><div class="diff-added">+</div><div>         '    in Foo (at **)',</div><div class="diff-added">+</div><div>     ]);</div><div class="diff-added">+</div><div>   });</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>   it('should only call componentWillUnmount once', async () => {</div><div class="diff-added">+</div><div>     let app;</div><div class="diff-added">+</div><div>     let count = 0;</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     class App extends React.Component {</div><div class="diff-added">+</div><div>       render() {</div><div class="diff-added">+</div><div>         if (this.props.stage === 1) {</div><div class="diff-added">+</div><div>           return <UnunmountableComponent />;</div><div class="diff-added">+</div><div>         } else {</div><div class="diff-added">+</div><div>           return null;</div><div class="diff-added">+</div><div>         }</div><div class="diff-added">+</div><div>       }</div><div class="diff-added">+</div><div>     }</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     class UnunmountableComponent extends React.Component {</div><div class="diff-added">+</div><div>       componentWillUnmount() {</div><div class="diff-added">+</div><div>         app.setState({});</div><div class="diff-added">+</div><div>         count++;</div><div class="diff-added">+</div><div>         throw Error('always fails');</div><div class="diff-added">+</div><div>       }</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>       render() {</div><div class="diff-added">+</div><div>         return <div>Hello {this.props.name}</div>;</div><div class="diff-added">+</div><div>       }</div><div class="diff-added">+</div><div>     }</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     const container = document.createElement('div');</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     const setRef = ref => {</div><div class="diff-added">+</div><div>       if (ref) {</div><div class="diff-added">+</div><div>         app = ref;</div><div class="diff-added">+</div><div>       }</div><div class="diff-added">+</div><div>     };</div><div> </div><div class="diff-removed">-    const root = ReactDOMClient.createRoot(container);</div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     await expect(async () => {</div><div class="diff-added">+</div><div>       await act(() => {</div><div class="diff-added">+</div><div>         root.render(<App ref={setRef} stage={1} />);</div><div class="diff-added">+</div><div>       });</div><div class="diff-added">+</div><div>       await act(() => {</div><div class="diff-added">+</div><div>         root.render(<App ref={setRef} stage={2} />);</div><div class="diff-added">+</div><div>       });</div><div class="diff-added">+</div><div>     }).rejects.toThrow();</div><div class="diff-added">+</div><div>     expect(count).toBe(1);</div><div class="diff-added">+</div><div>   });</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>   it('prepares new child before unmounting old', async () => {</div><div class="diff-added">+</div><div>     class Spy extends React.Component {</div><div class="diff-added">+</div><div>       UNSAFE_componentWillMount() {</div><div class="diff-added">+</div><div>         Scheduler.log(this.props.name + ' componentWillMount');</div><div class="diff-added">+</div><div>       }</div><div class="diff-added">+</div><div>       render() {</div><div class="diff-added">+</div><div>         Scheduler.log(this.props.name + ' render');</div><div class="diff-added">+</div><div>         return <div />;</div><div class="diff-added">+</div><div>       }</div><div class="diff-added">+</div><div>       componentDidMount() {</div><div class="diff-added">+</div><div>         Scheduler.log(this.props.name + ' componentDidMount');</div><div class="diff-added">+</div><div>       }</div><div class="diff-added">+</div><div>       componentWillUnmount() {</div><div class="diff-added">+</div><div>         Scheduler.log(this.props.name + ' componentWillUnmount');</div><div class="diff-added">+</div><div>       }</div><div class="diff-added">+</div><div>     }</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     class Wrapper extends React.Component {</div><div class="diff-added">+</div><div>       render() {</div><div class="diff-added">+</div><div>         return <Spy key={this.props.name} name={this.props.name} />;</div><div class="diff-added">+</div><div>       }</div><div class="diff-added">+</div><div>     }</div><div> </div><div class="diff-removed">-    const container = document.createElement('div');</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+    const container = document	createElement('div');</div><div class="diff-added">+</div><div>     const root = ReactDOMClient.createRoot(container);</div><div class="diff-added">+</div><div>     await act(() => {</div><div class="diff-added">+</div><div>       root.render(<Wrapper name="A" />);</div><div class="diff-added">+</div><div>     });</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     assertLog(['A componentWillMount', 'A render', 'A componentDidMount']);</div><div class="diff-added">+</div><div>     await act(() => {</div><div class="diff-added">+</div><div>       root.render(<Wrapper name="B" />);</div><div class="diff-added">+</div><div>     });</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     assertLog([</div><div class="diff-added">+</div><div>       'B componentWillMount',</div><div class="diff-added">+</div><div>       'B render',</div><div class="diff-added">+</div><div>       'A componentWillUnmount',</div><div class="diff-added">+</div><div>       'B componentDidMount',</div><div class="diff-added">+</div><div>     ]);</div><div class="diff-added">+</div><div>   });</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>   it('respects a shallow shouldComponentUpdate implementation', async () => {</div><div class="diff-added">+</div><div>     class PlasticWrap extends React.Component {</div><div class="diff-added">+</div><div>       constructor(props, context) {</div><div class="diff-added">+</div><div>         super(props, context);</div><div class="diff-added">+</div><div>         this.state = {</div><div class="diff-added">+</div><div>           color: 'green',</div><div class="diff-added">+</div><div>         };</div><div class="diff-added">+</div><div>         this.appleRef = React.createRef();</div><div class="diff-added">+</div><div>       }</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>       render() {</div><div class="diff-added">+</div><div>         return <Apple color={this.state.color} ref={this.appleRef} />;</div><div class="diff-added">+</div><div>       }</div><div class="diff-added">+</div><div>     }</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     class Apple extends React.Component {</div><div class="diff-added">+</div><div>       state = {</div><div class="diff-added">+</div><div>         cut: false,</div><div class="diff-added">+</div><div>         slices: 1,</div><div class="diff-added">+</div><div>       };</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>       shouldComponentUpdate(nextProps, nextState) {</div><div class="diff-added">+</div><div>         return shallowCompare(this, nextProps, nextState);</div><div class="diff-added">+</div><div>       }</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>       cut() {</div><div class="diff-added">+</div><div>         this.setState({</div><div class="diff-added">+</div><div>           cut: true,</div><div class="diff-added">+</div><div>           slices: 10,</div><div class="diff-added">+</div><div>         });</div><div class="diff-added">+</div><div>       }</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>       eatSlice() {</div><div class="diff-added">+</div><div>         this.setState({</div><div class="diff-added">+</div><div>           slices: this.state.slices - 1,</div><div class="diff-added">+</div><div>         });</div><div class="diff-added">+</div><div>       }</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>       render() {</div><div class="diff-added">+</div><div>         const {color} = this.props;</div><div class="diff-added">+</div><div>         const {cut, slices} = this.state;</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>         Scheduler.log(`${color} ${cut} ${slices}`);</div><div class="diff-added">+</div><div>         return <div />;</div><div class="diff-added">+</div><div>       }</div><div class="diff-added">+</div><div>     }</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     const container = document.createElement('div');</div><div class="diff-added">+</div><div>     const root = ReactDOMClient.createRoot(container);</div><div class="diff-added">+</div><div>     let instance;</div><div class="diff-added">+</div><div>     await act(() => {</div><div class="diff-added">+</div><div>       root.render(<PlasticWrap ref={ref => (instance = ref)} />);</div><div class="diff-added">+</div><div>     });</div><div class="diff-added">+</div><div>     assertLog(['green false 1']);</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     // Do not re-render based on props</div><div class="diff-added">+</div><div>     await act(() => {</div><div class="diff-added">+</div><div>       instance.setState({color: 'green'});</div><div class="diff-added">+</div><div>     });</div><div class="diff-added">+</div><div>     assertLog([]);</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     // Re-render based on props</div><div class="diff-added">+</div><div>     await act(() => {</div><div class="diff-added">+</div><div>       instance.setState({color: 'red'});</div><div class="diff-added">+</div><div>     });</div><div class="diff-added">+</div><div>     assertLog(['red false 1']);</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     // Re-render base on state</div><div class="diff-added">+</div><div>     await act(() => {</div><div class="diff-added">+</div><div>       instance.appleRef.current.cut();</div><div class="diff-added">+</div><div>     });</div><div class="diff-added">+</div><div>     assertLog(['red true 10']);</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     // No re-render based on state</div><div class="diff-added">+</div><div>     await act(() => {</div><div class="diff-added">+</div><div>       instance.appleRef.current.cut();</div><div class="diff-added">+</div><div>     });</div><div class="diff-added">+</div><div>     assertLog([]);</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     // Re-render based on state again</div><div class="diff-added">+</div><div>     await act(() => {</div><div class="diff-added">+</div><div>       instance.appleRef.current.eatSlice();</div><div class="diff-added">+</div><div>     });</div><div class="diff-added">+</div><div>     assertLog(['red true 9']);</div><div class="diff-added">+</div><div>   });</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>   it('does not do a deep comparison for a shallow shouldComponentUpdate implementation', async () => {</div><div class="diff-added">+</div><div>     function getInitialState() {</div><div class="diff-added">+</div><div>       return {</div><div class="diff-added">+</div><div>         foo: [1, 2, 3],</div><div class="diff-added">+</div><div>         bar: {a: 4, b: 5, c: 6},</div><div class="diff-added">+</div><div>       };</div><div class="diff-added">+</div><div>     }</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     const initialSettings = getInitialState();</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     class Component extends React.Component {</div><div class="diff-added">+</div><div>       state = initialSettings;</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>       shouldComponentUpdate(nextProps, nextState) {</div><div class="diff-added">+</div><div>         return shallowCompare(this, nextProps, nextState);</div><div class="diff-added">+</div><div>       }</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>       render() {</div><div class="diff-added">+</div><div>         const {foo, bar} = this.state;</div><div class="diff-added">+</div><div>         Scheduler.log(`{foo:[${foo}],bar:{a:${bar.a},b:${bar.b},c:${bar.c}}`);</div><div class="diff-added">+</div><div>         return <div />;</div><div class="diff-added">+</div><div>       }</div><div class="diff-added">+</div><div>     }</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     const container = document.createElement('div');</div><div class="diff-added">+</div><div>     const root = ReactDOMClient.createRoot(container);</div><div class="diff-added">+</div><div>     let instance;</div><div class="diff-added">+</div><div>     await act(() => {</div><div class="diff-added">+</div><div>       root.render(<Component ref={ref => (instance = ref)} />);</div><div class="diff-added">+</div><div>     });</div><div class="diff-added">+</div><div>     assertLog(['{foo:[1,2,3],bar:{a:4,b:5,c:6}']);</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     // Do not re-render if state is equal</div><div class="diff-added">+</div><div>     const settings = {</div><div class="diff-added">+</div><div>       foo: initialSettings.foo,</div><div class="diff-added">+</div><div>       bar: initialSettings.bar,</div><div class="diff-added">+</div><div>     };</div><div class="diff-added">+</div><div>     await act(() => {</div><div class="diff-added">+</div><div>       instance.setState(settings);</div><div class="diff-added">+</div><div>     });</div><div class="diff-added">+</div><div>     assertLog([]);</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     // Re-render because one field changed</div><div class="diff-added">+</div><div>     initialSettings.foo = [1, 2, 3];</div><div class="diff-added">+</div><div>     await act(() => {</div><div class="diff-added">+</div><div>       instance.setState(initialSettings);</div><div class="diff-added">+</div><div>     });</div><div class="diff-added">+</div><div>     assertLog(['{foo:[1,2,3],bar:{a:4,b:5,c:6}']);</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     // Re-render because the object changed</div><div class="diff-added">+</div><div>     await act(() => {</div><div class="diff-added">+</div><div>       instance.setState(getInitialState());</div><div class="diff-added">+</div><div>     });</div><div class="diff-added">+</div><div>     assertLog(['{foo:[1,2,3],bar:{a:4,b:5,c:6}']);</div><div class="diff-added">+</div><div>   });</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>   it('should call setState callback with no arguments', async () => {</div><div class="diff-added">+</div><div>     let mockArgs;</div><div class="diff-added">+</div><div>     class Component extends React.Component {</div><div class="diff-added">+</div><div>       componentDidMount() {</div><div class="diff-added">+</div><div>         this.setState({}, (...args) => (mockArgs = args));</div><div class="diff-added">+</div><div>       }</div><div class="diff-added">+</div><div>       render() {</div><div class="diff-added">+</div><div>         return false;</div><div class="diff-added">+</div><div>       }</div><div class="diff-added">+</div><div>     }</div><div class="diff-added">+</div><div>     const root = ReactDOMClient.createRoot(document.createElement('div'));</div><div class="diff-added">+</div><div>     await act(() => {</div><div class="diff-added">+</div><div>       root.render(<Component />);</div><div class="diff-added">+</div><div>     });</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     expect(mockArgs.length).toEqual(0);</div><div class="diff-added">+</div><div>   });</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>   it('this.state should be updated on setState callback inside componentWillMount', async () => {</div><div class="diff-added">+</div><div>     const div = document.createElement('div');</div><div class="diff-added">+</div><div>     let stateSuccessfullyUpdated = false;</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     class Component extends React.Component {</div><div class="diff-added">+</div><div>       constructor(props, context) {</div><div class="diff-added">+</div><div>         super(props, context);</div><div class="diff-added">+</div><div>         this.state = {</div><div class="diff-added">+</div><div>           hasUpdatedState: false,</div><div class="diff-added">+</div><div>         };</div><div class="diff-added">+</div><div>       }</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>       UNSAFE_componentWillMount() {</div><div class="diff-added">+</div><div>         this.setState(</div><div class="diff-added">+</div><div>           {hasUpdatedState: true},</div><div class="diff-added">+</div><div>           () => (stateSuccessfullyUpdated = this.state.hasUpdatedState),</div><div class="diff-added">+</div><div>         );</div><div class="diff-added">+</div><div>       }</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>       render() {</div><div class="diff-added">+</div><div>         return <div>{this.props.children}</div>;</div><div class="diff-added">+</div><div>       }</div><div class="diff-added">+</div><div>     }</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     const root = ReactDOMClient.createRoot(div);</div><div class="diff-added">+</div><div>     await act(() => {</div><div class="diff-added">+</div><div>       root.render(<Component />);</div><div class="diff-added">+</div><div>     });</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     expect(stateSuccessfullyUpdated).toBe(true);</div><div class="diff-added">+</div><div>   });</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>   it('should call the setState callback even if shouldComponentUpdate = false', async () => {</div><div class="diff-added">+</div><div>     const mockFn = jest.fn().mockReturnValue(false);</div><div class="diff-added">+</div><div>     const div = document.createElement('div');</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     class Component extends React.Component {</div><div class="diff-added">+</div><div>       constructor(props, context) {</div><div class="diff-added">+</div><div>         super(props, context);</div><div class="diff-added">+</div><div>         this.state = {</div><div class="diff-added">+</div><div>           hasUpdatedState: false,</div><div class="diff-added">+</div><div>         };</div><div class="diff-added">+</div><div>       }</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>       UNSAFE_componentWillMount() {</div><div class="diff-added">+</div><div>         instance = this;</div><div class="diff-added">+</div><div>       }</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>       shouldComponentUpdate() {</div><div class="diff-added">+</div><div>         return mockFn();</div><div class="diff-added">+</div><div>       }</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>       render() {</div><div class="diff-added">+</div><div>         return <div>{this.state.hasUpdatedState}</div>;</div><div class="diff-added">+</div><div>       }</div><div class="diff-added">+</div><div>     }</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     const root = ReactDOMClient.createRoot(div);</div><div class="diff-added">+</div><div>     let instance;</div><div class="diff-added">+</div><div>     await act(() => {</div><div class="diff-added">+</div><div>       root.render(<Component ref={ref => (instance = ref)} />);</div><div class="diff-added">+</div><div>     });</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     expect(instance).toBeDefined();</div><div class="diff-added">+</div><div>     expect(mockFn).not.toBeCalled();</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     await act(() => {</div><div class="diff-added">+</div><div>       instance.setState({hasUpdatedState: true}, () => {</div><div class="diff-added">+</div><div>         expect(mockFn).toBeCalled();</div><div class="diff-added">+</div><div>         expect(instance.state.hasUpdatedState).toBe(true);</div><div class="diff-added">+</div><div>         Scheduler.log('setState callback called');</div><div class="diff-added">+</div><div>       });</div><div class="diff-added">+</div><div>     });</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     assertLog(['setState callback called']);</div><div class="diff-added">+</div><div>   });</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>   it('should return a meaningful warning when constructor is returned', async () => {</div><div class="diff-added">+</div><div>     class RenderTextInvalidConstructor extends React.Component {</div><div class="diff-added">+</div><div>       constructor(props) {</div><div class="diff-added">+</div><div>         super(props);</div><div class="diff-added">+</div><div>         return {something: false};</div><div class="diff-added">+</div><div>       }</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>       render() {</div><div class="diff-added">+</div><div>         return <div />;</div><div class="diff-added">+</div><div>       }</div><div class="diff-added">+</div><div>     }</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     const root = ReactDOMClient.createRoot(document.createElement('div'));</div><div class="diff-added">+</div><div>     await expect(async () => {</div><div class="diff-removed">-      await act(() => {</div><div class="diff-removed">-        root.render(<RenderTextInvalidConstructor />);</div><div class="diff-removed">-      });</div><div class="diff-removed">-    }).rejects.toThrow();</div><div class="diff-removed">-    assertConsoleErrorDev([</div><div class="diff-added">+</div><div class="diff-added">+      await expect(async () => {</div><div class="diff-added">+</div><div class="diff-added">+        await act(() => {</div><div class="diff-added">+</div><div class="diff-added">+          root.render(<RenderTextInvalidConstructor />);</div><div class="diff-added">+</div><div class="diff-added">+        });</div><div class="diff-added">+</div><div class="diff-added">+      }).rejects.toThrow();</div><div class="diff-added">+</div><div class="diff-added">+    }).toErrorDev([</div><div class="diff-added">+</div><div>       'No `render` method found on the RenderTextInvalidConstructor instance: ' +</div><div class="diff-added">+</div><div>         'did you accidentally return an object from the constructor?\n' +</div><div class="diff-added">+</div><div>         '    in RenderTextInvalidConstructor (at **)',</div><div class="diff-added">+</div><div>       'No `render` method found on the RenderTextInvalidConstructor instance: ' +</div><div class="diff-added">+</div><div>         'did you accidentally return an object from the constructor?\n' +</div><div class="diff-added">+</div><div>         '    in RenderTextInvalidConstructor (at **)',</div><div class="diff-added">+</div><div>     ]);</div><div class="diff-added">+</div><div>   });</div><div> </div><div class="diff-removed">-  it('should warn about reassigning this.props while rendering', () => {</div><div class="diff-added">+ </div><div class="diff-added">+</div><div class="diff-added">+  it('should warn about reassigning this.props while rendering', async () => {</div><div class="diff-added">+</div><div>     class Bad extends React.Component {</div><div class="diff-added">+</div><div>       componentDidMount() {}</div><div class="diff-added">+</div><div>       componentDidUpdate() {}</div><div class="diff-added">+</div><div>       render() {</div><div class="diff-added">+</div><div>         this.props = {...this.props};</div><div class="diff-added">+</div><div>         return null;</div><div class="diff-added">+</div><div>       }</div><div class="diff-added">+</div><div>     }</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     const container = document.createElement('div');</div><div class="diff-added">+</div><div>     const root = ReactDOMClient.createRoot(container);</div><div class="diff-removed">-    ReactDOM.flushSync(() => {</div><div class="diff-added">+</div><div class="diff-added">+    ReactDOM.flushSync (() => {</div><div class="diff-added">+</div><div>       root.render(<Bad />);</div><div class="diff-added">+</div><div>     });</div><div class="diff-added">+</div><div>     assertConsoleErrorDev([</div><div class="diff-added">+</div><div>       'It looks like Bad is reassigning its own `this.props` while rendering. ' +</div><div class="diff-added">+</div><div>         'This is not supported and can lead to confusing bugs.\n' +</div><div class="diff-added">+</div><div>         '    in Bad (at **)',</div><div class="diff-added">+</div><div>     ]);</div><div class="diff-added">+</div><div>   });</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>   it('should return error if render is not defined', async () => {</div><div class="diff-added">+</div><div>     class RenderTestUndefinedRender extends React.Component {}</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     const root = ReactDOMClient.createRoot(document.createElement('div'));</div><div class="diff-added">+</div><div>     await expect(async () => {</div><div class="diff-removed">-      await act(() => {</div><div class="diff-removed">-        root.render(<RenderTestUndefinedRender />);</div><div class="diff-removed">-      });</div><div class="diff-removed">-    }).rejects.toThrow();</div><div class="diff-removed">-    assertConsoleErrorDev([</div><div class="diff-added">+</div><div class="diff-added">+      await expect(async () => {</div><div class="diff-added">+</div><div class="diff-added">+        await act(() => {</div><div class="diff-added">+</div><div class="diff-added">+          root.render(<RenderTestUndefinedRender />);</div><div class="diff-added">+</div><div class="diff-added">+        });</div><div class="diff-added">+</div><div class="diff-added">+      }).rejects.toThrow();</div><div class="diff-added">+</div><div class="diff-added">+    }).toErrorDev([</div><div class="diff-added">+</div><div>       'No `render` method found on the RenderTestUndefinedRender instance: ' +</div><div class="diff-added">+</div><div>         'you may have forgotten to define `render`.\n' +</div><div class="diff-added">+</div><div>         '    in RenderTestUndefinedRender (at **)',</div><div class="diff-added">+</div><div>       'No `render` method found on the RenderTestUndefinedRender instance: ' +</div><div class="diff-added">+</div><div>         'you may have forgotten to define `render`.\n' +</div><div class="diff-added">+</div><div>         '    in RenderTestUndefinedRender (at **)',</div><div class="diff-added">+</div><div>     ]);</div><div class="diff-added">+</div><div>   });</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>   // Regression test for accidental breaking change</div><div class="diff-added">+</div><div>   // https://github.com/facebook/react/issues/13580</div><div class="diff-added">+</div><div>   it('should support classes shadowing isReactComponent', async () => {</div><div class="diff-added">+</div><div>     class Shadow extends React.Component {</div><div class="diff-added">+</div><div>       isReactComponent() {}</div><div class="diff-added">+</div><div>       render() {</div><div class="diff-added">+</div><div>         return <div />;</div><div class="diff-added">+</div><div>       }</div><div class="diff-added">+</div><div>     }</div><div class="diff-removed">-    const container = document.createElement('div');</div><div class="diff-removed">-    const root = ReactDOMClient.createRoot(container);</div><div class="diff-added">+</div><div class="diff-added">+    const container = document.createElement('div');</div><div class="diff-added">+</div><div class="diff-added">+/ou    const root = ReactDOMClient.createRoot(container);</div><div class="diff-added">+</div><div>     await act(() => {</div><div class="diff-added">+</div><div>       root.render(<Shadow />);</div><div class="diff-added">+</div><div>     });</div><div class="diff-added">+</div><div>     expect(container.firstChild.tagName).toBe('DIV');</div><div class="diff-added">+</div><div>   });</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>   it('should not warn on updating function component from componentWillMount', async () => {</div><div class="diff-added">+</div><div>     let setState;</div><div class="diff-added">+</div><div>     let ref;</div><div class="diff-added">+</div><div>     function A() {</div><div class="diff-added">+</div><div>       const [state, _setState] = React.useState(null);</div><div class="diff-added">+</div><div>       setState = _setState;</div><div class="diff-added">+</div><div>       return <div ref={r => (ref = r)}>{state}</div>;</div><div class="diff-added">+</div><div>     }</div><div class="diff-added">+</div><div>     class B extends React.Component {</div><div class="diff-added">+</div><div>       UNSAFE_componentWillMount() {</div><div class="diff-added">+</div><div>         setState(1);</div><div class="diff-added">+</div><div>       }</div><div class="diff-added">+</div><div>       render() {</div><div class="diff-added">+</div><div>         return null;</div><div class="diff-added">+</div><div>       }</div><div class="diff-added">+</div><div>     }</div><div class="diff-added">+</div><div>     function Parent() {</div><div class="diff-added">+</div><div>       return (</div><div class="diff-added">+</div><div>         <div></div><div class="diff-added">+</div><div>           <A /></div><div class="diff-added">+</div><div>           <B /></div><div class="diff-added">+</div><div>         </div></div><div class="diff-added">+</div><div>       );</div><div class="diff-added">+</div><div>     }</div><div class="diff-added">+</div><div>     const container = document.createElement('div');</div><div class="diff-added">+</div><div>     const root = ReactDOMClient.createRoot(container);</div><div class="diff-added">+</div><div>     await act(() => {</div><div class="diff-added">+</div><div>       root.render(<Parent />);</div><div class="diff-added">+</div><div>     });</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     expect(ref.textContent).toBe('1');</div><div class="diff-added">+</div><div>   });</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>   it('should not warn on updating function component from componentWillUpdate', async () => {</div><div class="diff-added">+</div><div>     let setState;</div><div class="diff-added">+</div><div>     let ref;</div><div class="diff-added">+</div><div>     function A() {</div><div class="diff-added">+</div><div>       const [state, _setState] = React.useState();</div><div class="diff-added">+</div><div>       setState = _setState;</div><div class="diff-added">+</div><div>       return <div ref={r => (ref = r)}>{state}</div>;</div><div class="diff-added">+</div><div>     }</div><div class="diff-added">+</div><div>     class B extends React.Component {</div><div class="diff-added">+</div><div>       UNSAFE_componentWillUpdate() {</div><div class="diff-added">+</div><div>         setState(1);</div><div class="diff-added">+</div><div>       }</div><div class="diff-added">+</div><div>       render() {</div><div class="diff-added">+</div><div>         return null;</div><div class="diff-added">+</div><div>       }</div><div class="diff-added">+</div><div>     }</div><div class="diff-added">+</div><div>     function Parent() {</div><div class="diff-added">+</div><div>       return (</div><div class="diff-added">+</div><div>         <div></div><div class="diff-added">+</div><div>           <A /></div><div class="diff-added">+</div><div>           <B /></div><div class="diff-added">+</div><div>         </div></div><div class="diff-added">+</div><div>       );</div><div class="diff-added">+</div><div>     }</div><div class="diff-added">+</div><div>     const container = document.createElement('div');</div><div class="diff-added">+</div><div>     const root = ReactDOMClient.createRoot(container);</div><div class="diff-added">+</div><div>     await act(() => {</div><div class="diff-added">+</div><div>       root.render(<Parent />);</div><div class="diff-added">+</div><div>     });</div><div class="diff-added">+</div><div>     await act(() => {</div><div class="diff-added">+</div><div>       root.render(<Parent />);</div><div class="diff-added">+</div><div>     });</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     expect(ref.textContent).toBe('1');</div><div class="diff-added">+</div><div>   });</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>   it('should not warn on updating function component from componentWillReceiveProps', async () => {</div><div class="diff-added">+</div><div>     let setState;</div><div class="diff-added">+</div><div>     let ref;</div><div class="diff-added">+</div><div>     function A() {</div><div class="diff-added">+</div><div>       const [state, _setState] = React.useState();</div><div class="diff-added">+</div><div>       setState = _setState;</div><div class="diff-added">+</div><div>       return <div ref={r => (ref = r)}>{state}</div>;</div><div class="diff-added">+</div><div>     }</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     class B extends React.Component {</div><div class="diff-added">+</div><div>       UNSAFE_componentWillReceiveProps() {</div><div class="diff-added">+</div><div>         setState(1);</div><div class="diff-added">+</div><div>       }</div><div class="diff-added">+</div><div>       render() {</div><div class="diff-added">+</div><div>         return null;</div><div class="diff-added">+</div><div>       }</div><div class="diff-added">+</div><div>     }</div><div class="diff-added">+</div><div>     function Parent() {</div><div class="diff-added">+</div><div>       return (</div><div class="diff-added">+</div><div>         <div></div><div class="diff-added">+</div><div>           <A /></div><div class="diff-added">+</div><div>           <B /></div><div class="diff-added">+</div><div>         </div></div><div class="diff-added">+</div><div>       );</div><div class="diff-added">+</div><div>     }</div><div class="diff-added">+</div><div>     const container = document.createElement('div');</div><div class="diff-added">+</div><div>     const root = ReactDOMClient.createRoot(container);</div><div class="diff-added">+</div><div>     await act(() => {</div><div class="diff-removed">-      root.render(<Parent />);</div><div class="diff-added">+</div><div class="diff-added">+ reversing      root.render(<Parent />);</div><div class="diff-added">+</div><div>     });</div><div class="diff-added">+</div><div>     await act(() => {</div><div class="diff-added">+</div><div>       root.render(<Parent />);</div><div class="diff-added">+</div><div>     });</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     expect(ref.textContent).toBe('1');</div><div class="diff-added">+</div><div>   });</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>   it('should warn on updating function component from render', () => {</div><div class="diff-added">+</div><div>     let setState;</div><div class="diff-added">+</div><div>     let ref;</div><div class="diff-added">+</div><div>     function A() {</div><div class="diff-added">+</div><div>       const [state, _setState] = React.useState(0);</div><div class="diff-added">+</div><div>       setState = _setState;</div><div class="diff-added">+</div><div>       return <div ref={r => (ref = r)}>{state}</div>;</div><div class="diff-added">+</div><div>     }</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     class B extends React.Component {</div><div class="diff-added">+</div><div>       render() {</div><div class="diff-added">+</div><div>         setState(c => c + 1);</div><div class="diff-added">+</div><div>         return null;</div><div class="diff-added">+</div><div>       }</div><div class="diff-added">+</div><div>     }</div><div class="diff-added">+</div><div>     function Parent() {</div><div class="diff-added">+</div><div>       return (</div><div class="diff-added">+</div><div>         <div></div><div class="diff-added">+</div><div>           <A /></div><div class="diff-added">+</div><div>           <B /></div><div class="diff-added">+</div><div>         </div></div><div class="diff-added">+</div><div>       );</div><div class="diff-added">+</div><div>     }</div><div class="diff-added">+</div><div>     const container = document.createElement('div');</div><div class="diff-added">+</div><div>     const root = ReactDOMClient.createRoot(container);</div><div class="diff-added">+</div><div>     ReactDOM.flushSync(() => {</div><div class="diff-added">+</div><div>       root.render(<Parent />);</div><div class="diff-added">+</div><div>     });</div><div class="diff-added">+</div><div>     assertConsoleErrorDev([</div><div class="diff-added">+</div><div>       'Cannot update a component (`A`) while rendering a different component (`B`). ' +</div><div class="diff-added">+</div><div>         'To locate the bad setState() call inside `B`, ' +</div><div class="diff-added">+</div><div>         'follow the stack trace as described in https://react.dev/link/setstate-in-render\n' +</div><div class="diff-added">+</div><div class="diff-added">+        '    in B (at **)\n' +</div><div class="diff-added">+</div><div class="diff-added">+        '    in div (at **)\n' +</div><div class="diff-added">+</div><div>         '    in Parent (at **)',</div><div class="diff-added">+</div><div>     ]);</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     // We error, but still update the state.</div><div class="diff-added">+</div><div>     expect(ref.textContent).toBe('1');</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     // Dedupe.</div><div class="diff-added">+</div><div>     ReactDOM.flushSync(() => {</div><div class="diff-added">+</div><div>       root.render(<Parent />);</div><div class="diff-added">+</div><div>     });</div><div> </div><div class="diff-added">+ </div><div class="diff-added">+</div><div>     // We error, but still update the state.</div><div class="diff-added">+</div><div>     expect(ref.textContent).toBe('2');</div><div class="diff-added">+</div><div>   });</div><div class="diff-added">+</div><div> });</div><div>\ No newline at end of file</div><div></div></pre>
                </div>
            </div>
        </section>
    </main>
    <footer>
        <p>LoCoDiff-bench - <a href="https://github.com/AbanteAI/LoCoDiff-bench">GitHub Repository</a></p>
    </footer>
</body>
</html>
    