<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case: src/apprt/glfw.zig - o3</title>
    <link rel="stylesheet" href="../../styles.css">
</head>
<body>
    <header>
        <h1>Case: src/apprt/glfw.zig</h1>
        <p><a href="../../models/openai_o3.html">‚Üê Back to o3 Cases</a> | <a href="../../index.html">Home</a></p>
    </header>
    <main>
        <section class="case-details">
            <div class="case-info">
                <h2>Benchmark Case Information</h2>
                <p><strong>Model:</strong> o3</p>
                <p><strong>Status:</strong> <span class="failure">Failure</span></p>
                <p><strong>Prompt Tokens:</strong> 62392</p>
                <p><strong>Output Tokens:</strong> N/A</p>
                <p><strong>Native Prompt Tokens:</strong> 62621</p>
                <p><strong>Native Completion Tokens:</strong> 8342</p>
                <p><strong>Native Tokens Reasoning:</strong> 384</p>
                <p><strong>Native Finish Reason:</strong> stop</p>
                <p><strong>Runtime:</strong> N/As</p>
                <p><strong>Cost:</strong> $0.9844124999999999</p>
            </div>
            
            <div class="content-links">
                <h2>View Content</h2>
                <ul>
                    <li><a href="../../content/openai_o3/ghostty_src_apprt_glfw.zig/prompt.html" class="content-link">View Prompt</a></li>
                    <li><a href="../../content/openai_o3/ghostty_src_apprt_glfw.zig/expected.html" class="content-link">View Expected Output</a></li>
                    <li><a href="../../content/openai_o3/ghostty_src_apprt_glfw.zig/actual.html" class="content-link">View Actual Output</a></li>
                </ul>
            </div>
            
            <div class="diff-section">
                <h2>Diff (Expected vs Actual)</h2>
                <div id="diff-output">
                    <pre class="diff"><div class="diff-header">--- ghostty_src_apprt_glfw.zig_expectedoutput.txt (expected)+++ ghostty_src_apprt_glfw.zig_extracted.txt (actual)@@ -1,7 +1,6 @@ //! Application runtime implementation that uses GLFW (https://www.glfw.org/).</div><div> //!</div><div> //! This works on macOS and Linux with OpenGL and Metal.</div><div class="diff-removed">-//! (The above sentence may be out of date).</div><div> </div><div> const std = @import("std");</div><div> const builtin = @import("builtin");</div><div class="diff-info">@@ -26,7 +25,7 @@ // Get native API access on certain platforms so we can do more customization.</div><div> const glfwNative = glfw.Native(.{</div><div>     .cocoa = builtin.target.os.tag.isDarwin(),</div><div class="diff-removed">-    .x11 = builtin.os.tag == .linux,</div><div class="diff-added">+    .x11   = builtin.os.tag == .linux,</div><div> });</div><div> </div><div> /// True if darwin-specific logic is enabled</div><div class="diff-info">@@ -36,12 +35,11 @@ const log = std.log.scoped(.glfw);</div><div> </div><div> pub const App = struct {</div><div class="diff-removed">-    app: *CoreApp,</div><div class="diff-removed">-    config: Config,</div><div class="diff-removed">-</div><div class="diff-removed">-    /// Flips to true to quit on the next event loop tick. This</div><div class="diff-removed">-    /// never goes false and forces the event loop to exit.</div><div class="diff-removed">-    quit: bool = false,</div><div class="diff-added">+    app:     *CoreApp,</div><div class="diff-added">+    config:  Config,</div><div class="diff-added">+</div><div class="diff-added">+    /// Flips to true to quit on the next event loop tick.</div><div class="diff-added">+    quit:    bool = false,</div><div> </div><div>     /// Mac-specific state.</div><div>     darwin: if (darwin_enabled) Darwin else void,</div><div class="diff-info">@@ -73,40 +71,34 @@         var darwin = if (darwin_enabled) try Darwin.init() else {};</div><div>         errdefer if (darwin_enabled) darwin.deinit();</div><div> </div><div class="diff-removed">-        // Load our configuration</div><div class="diff-added">+        // Load configuration</div><div>         var config = try Config.load(core_app.alloc);</div><div>         errdefer config.deinit();</div><div> </div><div class="diff-removed">-        // If we had configuration errors, then log them.</div><div class="diff-added">+        // Log diagnostics if present</div><div>         if (!config._diagnostics.empty()) {</div><div>             var buf = std.ArrayList(u8).init(core_app.alloc);</div><div>             defer buf.deinit();</div><div class="diff-added">+</div><div>             for (config._diagnostics.items()) |diag| {</div><div>                 try diag.write(buf.writer());</div><div>                 log.warn("configuration error: {s}", .{buf.items});</div><div>                 buf.clearRetainingCapacity();</div><div>             }</div><div> </div><div class="diff-removed">-            // If we have any CLI errors, exit.</div><div class="diff-added">+            // Exit if CLI errors</div><div>             if (config._diagnostics.containsLocation(.cli)) {</div><div>                 log.warn("CLI errors detected, exiting", .{});</div><div class="diff-removed">-                _ = core_app.mailbox.push(.{</div><div class="diff-removed">-                    .quit = {},</div><div class="diff-removed">-                }, .{ .forever = {} });</div><div class="diff-added">+                _ = core_app.mailbox.push(.{ .quit = {} }, .{ .forever = {} });</div><div>             }</div><div>         }</div><div> </div><div class="diff-removed">-        // Queue a single new window that starts on launch</div><div class="diff-removed">-        // Note: above we may send a quit so this may never happen</div><div class="diff-removed">-        _ = core_app.mailbox.push(.{</div><div class="diff-removed">-            .new_window = .{},</div><div class="diff-removed">-        }, .{ .forever = {} });</div><div class="diff-removed">-</div><div class="diff-removed">-        // We want the event loop to wake up instantly so we can process our tick.</div><div class="diff-added">+        // Queue a new window on launch</div><div class="diff-added">+        _ = core_app.mailbox.push(.{ .new_window = .{} }, .{ .forever = {} });</div><div>         glfw.postEmptyEvent();</div><div> </div><div>         return .{</div><div class="diff-removed">-            .app = core_app,</div><div class="diff-added">+            .app    = core_app,</div><div>             .config = config,</div><div>             .darwin = darwin,</div><div>         };</div><div class="diff-info">@@ -117,42 +109,35 @@         glfw.terminate();</div><div>     }</div><div> </div><div class="diff-removed">-    /// Run the event loop. This doesn't return until the app exits.</div><div class="diff-added">+    /// Run the event loop.</div><div>     pub fn run(self: *App) !void {</div><div>         while (true) {</div><div class="diff-removed">-            // Wait for any events from the app event loop. wakeup will post</div><div class="diff-removed">-            // an empty event so that this will return.</div><div class="diff-removed">-            //</div><div class="diff-removed">-            // Warning: a known issue on macOS is that this will block while</div><div class="diff-removed">-            // a resize event is actively happening, which will prevent the</div><div class="diff-removed">-            // app tick from happening. I don't know know a way around this</div><div class="diff-removed">-            // but its not a big deal since we don't use glfw for the official</div><div class="diff-removed">-            // mac app, but noting it in case anyone builds for macos using</div><div class="diff-removed">-            // glfw.</div><div>             glfw.waitEvents();</div><div> </div><div class="diff-removed">-            // Tick the terminal app</div><div class="diff-added">+            // Tick core</div><div>             try self.app.tick(self);</div><div> </div><div class="diff-removed">-            // If the tick caused us to quit, then we're done.</div><div>             if (self.quit or self.app.surfaces.items.len == 0) {</div><div>                 for (self.app.surfaces.items) |surface| {</div><div>                     surface.close(false);</div><div>                 }</div><div class="diff-removed">-</div><div>                 return;</div><div>             }</div><div>         }</div><div>     }</div><div> </div><div class="diff-removed">-    /// Wakeup the event loop. This should be able to be called from any thread.</div><div class="diff-added">+    /// Wakeup the event loop.</div><div>     pub fn wakeup(self: *const App) void {</div><div>         _ = self;</div><div>         glfw.postEmptyEvent();</div><div>     }</div><div> </div><div class="diff-removed">-    /// Perform a given action. Returns `true` if the action was able to be</div><div class="diff-removed">-    /// performed, `false` otherwise.</div><div class="diff-added">+    pub fn keyboardLayout(self: *const App) input.KeyboardLayout {</div><div class="diff-added">+        _ = self;</div><div class="diff-added">+        return .unknown; // not supported by GLFW</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    /// Perform an action. Returns true if it was handled.</div><div>     pub fn performAction(</div><div>         self: *App,</div><div>         target: apprt.Target,</div><div class="diff-info">@@ -160,94 +145,79 @@         value: apprt.Action.Value(action),</div><div>     ) !bool {</div><div>         switch (action) {</div><div class="diff-removed">-            .quit => self.quit = true,</div><div class="diff-removed">-</div><div class="diff-removed">-            .new_window => _ = try self.newSurface(switch (target) {</div><div class="diff-removed">-                .app => null,</div><div class="diff-removed">-                .surface => |v| v,</div><div class="diff-added">+            .quit               => self.quit = true,</div><div class="diff-added">+</div><div class="diff-added">+            .new_window         => _ = try self.newSurface(switch (target) {</div><div class="diff-added">+                .app      => null,</div><div class="diff-added">+                .surface  => |v| v,</div><div>             }),</div><div> </div><div class="diff-removed">-            .new_tab => try self.newTab(switch (target) {</div><div class="diff-removed">-                .app => null,</div><div class="diff-removed">-                .surface => |v| v,</div><div class="diff-added">+            .new_tab            => try self.newTab(switch (target) {</div><div class="diff-added">+                .app      => null,</div><div class="diff-added">+                .surface  => |v| v,</div><div>             }),</div><div> </div><div class="diff-removed">-            .size_limit => switch (target) {</div><div class="diff-removed">-                .app => {},</div><div class="diff-removed">-                .surface => |surface| try surface.rt_surface.setSizeLimits(.{</div><div class="diff-removed">-                    .width = value.min_width,</div><div class="diff-added">+            .size_limit         => switch (target) {</div><div class="diff-added">+                .app      => {},</div><div class="diff-added">+                .surface  => |s| try s.rt_surface.setSizeLimits(.{</div><div class="diff-added">+                    .width  = value.min_width,</div><div>                     .height = value.min_height,</div><div>                 }, if (value.max_width > 0) .{</div><div class="diff-removed">-                    .width = value.max_width,</div><div class="diff-added">+                    .width  = value.max_width,</div><div>                     .height = value.max_height,</div><div>                 } else null),</div><div>             },</div><div> </div><div class="diff-removed">-            .initial_size => switch (target) {</div><div class="diff-removed">-                .app => {},</div><div class="diff-removed">-                .surface => |surface| try surface.rt_surface.setInitialWindowSize(</div><div class="diff-added">+            .initial_size       => switch (target) {</div><div class="diff-added">+                .app     => {},</div><div class="diff-added">+                .surface => |s| try s.rt_surface.setInitialWindowSize(</div><div>                     value.width,</div><div>                     value.height,</div><div>                 ),</div><div>             },</div><div> </div><div class="diff-removed">-            .toggle_fullscreen => self.toggleFullscreen(target),</div><div class="diff-removed">-</div><div class="diff-removed">-            .open_config => try configpkg.edit.open(self.app.alloc),</div><div class="diff-removed">-</div><div class="diff-removed">-            .set_title => switch (target) {</div><div class="diff-removed">-                .app => {},</div><div class="diff-removed">-                .surface => |surface| try surface.rt_surface.setTitle(value.title),</div><div class="diff-removed">-            },</div><div class="diff-removed">-</div><div class="diff-removed">-            .mouse_shape => switch (target) {</div><div class="diff-removed">-                .app => {},</div><div class="diff-removed">-                .surface => |surface| try surface.rt_surface.setMouseShape(value),</div><div class="diff-removed">-            },</div><div class="diff-removed">-</div><div class="diff-removed">-            .mouse_visibility => switch (target) {</div><div class="diff-removed">-                .app => {},</div><div class="diff-removed">-                .surface => |surface| surface.rt_surface.setMouseVisibility(switch (value) {</div><div class="diff-added">+            .toggle_fullscreen  => self.toggleFullscreen(target),</div><div class="diff-added">+</div><div class="diff-added">+            .open_config        => try configpkg.edit.open(self.app.alloc),</div><div class="diff-added">+</div><div class="diff-added">+            .set_title          => switch (target) {</div><div class="diff-added">+                .app     => {},</div><div class="diff-added">+                .surface => |s| try s.rt_surface.setTitle(value.title),</div><div class="diff-added">+            },</div><div class="diff-added">+</div><div class="diff-added">+            .mouse_shape        => switch (target) {</div><div class="diff-added">+                .app     => {},</div><div class="diff-added">+                .surface => |s| try s.rt_surface.setMouseShape(value),</div><div class="diff-added">+            },</div><div class="diff-added">+</div><div class="diff-added">+            .mouse_visibility   => switch (target) {</div><div class="diff-added">+                .app     => {},</div><div class="diff-added">+                .surface => |s| s.rt_surface.setMouseVisibility(switch (value) {</div><div>                     .visible => true,</div><div class="diff-removed">-                    .hidden => false,</div><div class="diff-added">+                    .hidden  => false,</div><div>                 }),</div><div>             },</div><div> </div><div class="diff-removed">-            .reload_config => try self.reloadConfig(target, value),</div><div class="diff-removed">-</div><div class="diff-removed">-            // Unimplemented</div><div class="diff-removed">-            .new_split,</div><div class="diff-removed">-            .goto_split,</div><div class="diff-removed">-            .resize_split,</div><div class="diff-removed">-            .equalize_splits,</div><div class="diff-removed">-            .toggle_split_zoom,</div><div class="diff-removed">-            .present_terminal,</div><div class="diff-removed">-            .close_all_windows,</div><div class="diff-removed">-            .close_window,</div><div class="diff-removed">-            .close_tab,</div><div class="diff-removed">-            .toggle_tab_overview,</div><div class="diff-removed">-            .toggle_window_decorations,</div><div class="diff-removed">-            .toggle_quick_terminal,</div><div class="diff-removed">-            .toggle_command_palette,</div><div class="diff-removed">-            .toggle_visibility,</div><div class="diff-removed">-            .goto_tab,</div><div class="diff-removed">-            .move_tab,</div><div class="diff-removed">-            .inspector,</div><div class="diff-removed">-            .render_inspector,</div><div class="diff-removed">-            .quit_timer,</div><div class="diff-removed">-            .secure_input,</div><div class="diff-removed">-            .key_sequence,</div><div class="diff-removed">-            .desktop_notification,</div><div class="diff-removed">-            .mouse_over_link,</div><div class="diff-removed">-            .cell_size,</div><div class="diff-removed">-            .renderer_health,</div><div class="diff-removed">-            .color_change,</div><div class="diff-removed">-            .pwd,</div><div class="diff-removed">-            .config_change,</div><div class="diff-removed">-            .toggle_maximize,</div><div class="diff-removed">-            .prompt_title,</div><div class="diff-removed">-            .reset_window_size,</div><div class="diff-removed">-            .ring_bell,</div><div class="diff-added">+            .initial_position   => switch (target) {</div><div class="diff-added">+                .app     => {},</div><div class="diff-added">+                .surface => |s| try s.rt_surface.setInitialWindowPosition(</div><div class="diff-added">+                    value.x,</div><div class="diff-added">+                    value.y,</div><div class="diff-added">+                ),</div><div class="diff-added">+            },</div><div class="diff-added">+</div><div class="diff-added">+            .reload_config      => try self.reloadConfig(target, value),</div><div class="diff-added">+</div><div class="diff-added">+            // Unimplemented (no-ops)</div><div class="diff-added">+            .new_split, .goto_split, .resize_split, .equalize_splits,</div><div class="diff-added">+            .toggle_split_zoom, .present_terminal, .close_all_windows,</div><div class="diff-added">+            .close_window, .close_tab, .toggle_tab_overview,</div><div class="diff-added">+            .toggle_window_decorations, .toggle_quick_terminal,</div><div class="diff-added">+            .toggle_command_palette, .toggle_maximize, .toggle_visibility,</div><div class="diff-added">+            .goto_tab, .move_tab, .inspector, .render_inspector, .quit_timer,</div><div class="diff-added">+            .secure_input, .ring_bell, .key_sequence, .mouse_over_link,</div><div class="diff-added">+            .cell_size, .renderer_health, .color_change, .pwd,</div><div class="diff-added">+            .config_change, .reset_window_size,</div><div>             => {</div><div>                 log.info("unimplemented action={}", .{action});</div><div>                 return false;</div><div class="diff-info">@@ -257,46 +227,36 @@         return true;</div><div>     }</div><div> </div><div class="diff-removed">-    /// Reload the configuration. This should return the new configuration.</div><div class="diff-removed">-    /// The old value can be freed immediately at this point assuming a</div><div class="diff-removed">-    /// successful return.</div><div class="diff-removed">-    ///</div><div class="diff-removed">-    /// The returned pointer value is only valid for a stable self pointer.</div><div class="diff-added">+    /// Reload configuration helper.</div><div>     fn reloadConfig(</div><div>         self: *App,</div><div>         target: apprt.action.Target,</div><div class="diff-removed">-        opts: apprt.action.ReloadConfig,</div><div class="diff-added">+        opts:   apprt.action.ReloadConfig,</div><div>     ) !void {</div><div>         if (opts.soft) {</div><div>             switch (target) {</div><div class="diff-removed">-                .app => try self.app.updateConfig(self, &self.config),</div><div class="diff-removed">-                .surface => |core_surface| try core_surface.updateConfig(</div><div class="diff-removed">-                    &self.config,</div><div class="diff-removed">-                ),</div><div class="diff-added">+                .app     => try self.app.updateConfig(self, &self.config),</div><div class="diff-added">+                .surface => |cs|   try cs.updateConfig(&self.config),</div><div>             }</div><div>             return;</div><div>         }</div><div> </div><div class="diff-removed">-        // Load our configuration</div><div class="diff-removed">-        var config = try Config.load(self.app.alloc);</div><div class="diff-removed">-        errdefer config.deinit();</div><div class="diff-removed">-</div><div class="diff-removed">-        // Call into our app to update</div><div class="diff-added">+        var new_cfg = try Config.load(self.app.alloc);</div><div class="diff-added">+        errdefer new_cfg.deinit();</div><div class="diff-added">+</div><div>         switch (target) {</div><div class="diff-removed">-            .app => try self.app.updateConfig(self, &config),</div><div class="diff-removed">-            .surface => |core_surface| try core_surface.updateConfig(&config),</div><div class="diff-removed">-        }</div><div class="diff-removed">-</div><div class="diff-removed">-        // Update the existing config, be sure to clean up the old one.</div><div class="diff-added">+            .app     => try self.app.updateConfig(self, &new_cfg),</div><div class="diff-added">+            .surface => |cs|   try cs.updateConfig(&new_cfg),</div><div class="diff-added">+        }</div><div class="diff-added">+</div><div>         self.config.deinit();</div><div class="diff-removed">-        self.config = config;</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    /// Toggle the window to fullscreen mode.</div><div class="diff-added">+        self.config = new_cfg;</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    /// Toggle fullscreen.</div><div>     fn toggleFullscreen(self: *App, target: apprt.Target) void {</div><div class="diff-removed">-        _ = self;</div><div>         const surface: *Surface = switch (target) {</div><div class="diff-removed">-            .app => return,</div><div class="diff-added">+            .app     => return,</div><div>             .surface => |v| v.rt_surface,</div><div>         };</div><div>         const win = surface.window;</div><div class="diff-info">@@ -313,36 +273,54 @@             return;</div><div>         }</div><div> </div><div class="diff-removed">-        const monitor = win.getMonitor() orelse monitor: {</div><div class="diff-removed">-            log.warn("window had null monitor, getting primary monitor", .{});</div><div class="diff-removed">-            break :monitor glfw.Monitor.getPrimary() orelse {</div><div class="diff-removed">-                log.warn("window could not get any monitor. will not perform action", .{});</div><div class="diff-removed">-                return;</div><div class="diff-removed">-            };</div><div class="diff-removed">-        };</div><div class="diff-removed">-</div><div class="diff-removed">-        const video_mode = monitor.getVideoMode() orelse {</div><div class="diff-removed">-            log.warn("failed to get video mode. will not perform action", .{});</div><div class="diff-removed">-            return;</div><div class="diff-removed">-        };</div><div class="diff-removed">-</div><div class="diff-removed">-        const position = win.getPos();</div><div class="diff-removed">-        const size = surface.getSize() catch {</div><div class="diff-removed">-            log.warn("failed to get window size. will not perform fullscreen action", .{});</div><div class="diff-added">+        const monitor = win.getMonitor() orelse glfw.Monitor.getPrimary() orelse {</div><div class="diff-added">+            log.warn("window could not get monitor, will not fullscreen", .{});</div><div class="diff-added">+            return;</div><div class="diff-added">+        };</div><div class="diff-added">+        const mode = monitor.getVideoMode() orelse {</div><div class="diff-added">+            log.warn("failed to get video mode, will not fullscreen", .{});</div><div class="diff-added">+            return;</div><div class="diff-added">+        };</div><div class="diff-added">+</div><div class="diff-added">+        const pos  = win.getPos();</div><div class="diff-added">+        const size = surface.getSize() catch |err| {</div><div class="diff-added">+            log.warn("failed to get window size ({})", .{err});</div><div>             return;</div><div>         };</div><div> </div><div>         surface.monitor_dims = .{</div><div class="diff-removed">-            .width = size.width,</div><div class="diff-removed">-            .height = size.height,</div><div class="diff-removed">-            .position_x = position.x,</div><div class="diff-removed">-            .position_y = position.y,</div><div class="diff-removed">-        };</div><div class="diff-removed">-</div><div class="diff-removed">-        win.setMonitor(monitor, 0, 0, video_mode.getWidth(), video_mode.getHeight(), 0);</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    /// Create a new tab in the parent surface.</div><div class="diff-added">+            .width       = size.width,</div><div class="diff-added">+            .height      = size.height,</div><div class="diff-added">+            .position_x  = pos.x,</div><div class="diff-added">+            .position_y  = pos.y,</div><div class="diff-added">+        };</div><div class="diff-added">+</div><div class="diff-added">+        win.setMonitor(</div><div class="diff-added">+            monitor,</div><div class="diff-added">+            0, 0,</div><div class="diff-added">+            mode.getWidth(),</div><div class="diff-added">+            mode.getHeight(),</div><div class="diff-added">+            0,</div><div class="diff-added">+        );</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    /// Create a new surface.</div><div class="diff-added">+    fn newSurface(self: *App, parent_: ?*CoreSurface) !*Surface {</div><div class="diff-added">+        var s = try self.app.alloc.create(Surface);</div><div class="diff-added">+        errdefer self.app.alloc.destroy(s);</div><div class="diff-added">+</div><div class="diff-added">+        try s.init(self);</div><div class="diff-added">+        errdefer s.deinit();</div><div class="diff-added">+</div><div class="diff-added">+        // inherit font size</div><div class="diff-added">+        if (self.config.@"window-inherit-font-size") {</div><div class="diff-added">+            if (parent_) |p| try s.core_surface.setFontSize(p.font_size);</div><div class="diff-added">+        }</div><div class="diff-added">+</div><div class="diff-added">+        return s;</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    /// Create a new tab.</div><div>     fn newTab(self: *App, parent_: ?*CoreSurface) !void {</div><div>         if (comptime !darwin_enabled) {</div><div>             log.warn("tabbing is not supported on this platform", .{});</div><div class="diff-info">@@ -354,79 +332,43 @@             return;</div><div>         };</div><div> </div><div class="diff-removed">-        // Create the new window</div><div class="diff-removed">-        const window = try self.newSurface(parent);</div><div class="diff-removed">-</div><div class="diff-removed">-        // Add the new window the parent window</div><div class="diff-added">+        // create new window</div><div class="diff-added">+        const win = try self.newSurface(parent);</div><div class="diff-added">+</div><div class="diff-added">+        // add tab</div><div>         const parent_win = glfwNative.getCocoaWindow(parent.rt_surface.window).?;</div><div class="diff-removed">-        const other_win = glfwNative.getCocoaWindow(window.window).?;</div><div class="diff-removed">-        const NSWindowOrderingMode = enum(isize) { below = -1, out = 0, above = 1 };</div><div class="diff-added">+        const other_win  = glfwNative.getCocoaWindow(win.window).?;</div><div class="diff-added">+        const NSWindowOrderingMode = enum(isize){ below = -1, out = 0, above = 1 };</div><div>         const nswindow = objc.Object.fromId(parent_win);</div><div>         nswindow.msgSend(void, objc.sel("addTabbedWindow:ordered:"), .{</div><div>             objc.Object.fromId(other_win),</div><div>             NSWindowOrderingMode.above,</div><div>         });</div><div> </div><div class="diff-removed">-        // Adding a new tab can cause the tab bar to appear which changes</div><div class="diff-removed">-        // our viewport size. We need to call the size callback in order to</div><div class="diff-removed">-        // update values. For example, we need this to set the proper mouse selection</div><div class="diff-removed">-        // point in the grid.</div><div class="diff-removed">-        const size = parent.rt_surface.getSize() catch |err| {</div><div class="diff-removed">-            log.err("error querying window size for size callback on new tab err={}", .{err});</div><div class="diff-removed">-            return;</div><div class="diff-removed">-        };</div><div class="diff-removed">-        parent.sizeCallback(size) catch |err| {</div><div class="diff-removed">-            log.err("error in size callback from new tab err={}", .{err});</div><div class="diff-removed">-            return;</div><div class="diff-removed">-        };</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    fn newSurface(self: *App, parent_: ?*CoreSurface) !*Surface {</div><div class="diff-removed">-        // Grab a surface allocation because we're going to need it.</div><div class="diff-removed">-        var surface = try self.app.alloc.create(Surface);</div><div class="diff-removed">-        errdefer self.app.alloc.destroy(surface);</div><div class="diff-removed">-</div><div class="diff-removed">-        // Create the surface -- because windows are surfaces for glfw.</div><div class="diff-removed">-        try surface.init(self);</div><div class="diff-removed">-        errdefer surface.deinit();</div><div class="diff-removed">-</div><div class="diff-removed">-        // If we have a parent, inherit some properties</div><div class="diff-removed">-        if (self.config.@"window-inherit-font-size") {</div><div class="diff-removed">-            if (parent_) |parent| {</div><div class="diff-removed">-                try surface.core_surface.setFontSize(parent.font_size);</div><div class="diff-removed">-            }</div><div class="diff-removed">-        }</div><div class="diff-removed">-</div><div class="diff-removed">-        return surface;</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    /// Close the given surface.</div><div class="diff-removed">-    pub fn closeSurface(self: *App, surface: *Surface) void {</div><div class="diff-added">+        // adjust size callback after tabbar shows/hides</div><div class="diff-added">+        const sz = parent.rt_surface.getSize() catch |err| {</div><div class="diff-added">+            log.err("error querying size for size callback after tab add ({})", .{err});</div><div class="diff-added">+            return;</div><div class="diff-added">+        };</div><div class="diff-added">+        parent.sizeCallback(sz) catch |err| {</div><div class="diff-added">+            log.err("error in size callback from new tab ({})", .{err});</div><div class="diff-added">+        };</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    fn closeSurface(self: *App, surface: *Surface) void {</div><div>         surface.deinit();</div><div>         self.app.alloc.destroy(surface);</div><div>     }</div><div> </div><div class="diff-removed">-    pub fn redrawSurface(self: *App, surface: *Surface) void {</div><div class="diff-added">+    fn redrawSurface(self: *App, _: *Surface) void {</div><div>         _ = self;</div><div class="diff-removed">-        _ = surface;</div><div class="diff-removed">-</div><div>         @panic("This should never be called for GLFW.");</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    pub fn redrawInspector(self: *App, surface: *Surface) void {</div><div class="diff-removed">-        _ = self;</div><div class="diff-removed">-        _ = surface;</div><div class="diff-removed">-</div><div class="diff-removed">-        // GLFW doesn't support the inspector</div><div>     }</div><div> </div><div>     fn glfwErrorCallback(code: glfw.ErrorCode, desc: [:0]const u8) void {</div><div>         std.log.warn("glfw error={} message={s}", .{ code, desc });</div><div> </div><div class="diff-removed">-        // Workaround for: https://github.com/ocornut/imgui/issues/5908</div><div class="diff-removed">-        // If we get an invalid value with "scancode" in the message we assume</div><div class="diff-removed">-        // it is from the glfw key callback that imgui sets and we clear the</div><div class="diff-removed">-        // error so that our future code doesn't crash.</div><div class="diff-added">+        // Workaround for imgui scancode bug</div><div>         if (code == glfw.ErrorCode.InvalidValue and</div><div>             std.mem.indexOf(u8, desc, "scancode") != null)</div><div>         {</div><div class="diff-info">@@ -434,16 +376,7 @@         }</div><div>     }</div><div> </div><div class="diff-removed">-    pub fn keyboardLayout(self: *const App) input.KeyboardLayout {</div><div class="diff-removed">-        _ = self;</div><div class="diff-removed">-</div><div class="diff-removed">-        // Not supported by glfw</div><div class="diff-removed">-        return .unknown;</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    /// Mac-specific settings. This is only enabled when the target is</div><div class="diff-removed">-    /// Mac and the artifact is a standalone exe. We don't target libs because</div><div class="diff-removed">-    /// the embedded API doesn't do windowing.</div><div class="diff-added">+    /// macOS-specific</div><div>     const Darwin = struct {</div><div>         tabbing_id: *macos.foundation.String,</div><div> </div><div class="diff-info">@@ -451,16 +384,14 @@             const NSWindow = objc.getClass("NSWindow").?;</div><div>             NSWindow.msgSend(void, objc.sel("setAllowsAutomaticWindowTabbing:"), .{true});</div><div> </div><div class="diff-removed">-            // Our tabbing ID allows all of our windows to group together</div><div class="diff-removed">-            const tabbing_id = try macos.foundation.String.createWithBytes(</div><div class="diff-added">+            const tid = try macos.foundation.String.createWithBytes(</div><div>                 "com.mitchellh.ghostty.window",</div><div>                 .utf8,</div><div>                 false,</div><div>             );</div><div class="diff-removed">-            errdefer tabbing_id.release();</div><div class="diff-removed">-</div><div class="diff-removed">-            // Setup our Mac settings</div><div class="diff-removed">-            return .{ .tabbing_id = tabbing_id };</div><div class="diff-added">+            errdefer tid.release();</div><div class="diff-added">+</div><div class="diff-added">+            return .{ .tabbing_id = tid };</div><div>         }</div><div> </div><div>         pub fn deinit(self: *Darwin) void {</div><div class="diff-info">@@ -470,62 +401,34 @@     };</div><div> };</div><div> </div><div class="diff-removed">-/// These are used to keep track of the original monitor values so that we can</div><div class="diff-removed">-/// safely toggle on and off of fullscreen.</div><div class="diff-added">+/// Monitor dimensions for toggling fullscreen</div><div> const MonitorDimensions = struct {</div><div class="diff-removed">-    width: u32,</div><div class="diff-removed">-    height: u32,</div><div class="diff-added">+    width:      u32,</div><div class="diff-added">+    height:     u32,</div><div>     position_x: i64,</div><div>     position_y: i64,</div><div> };</div><div> </div><div class="diff-removed">-/// Surface represents the drawable surface for glfw. In glfw, a surface</div><div class="diff-removed">-/// is always a window because that is the only abstraction that glfw exposes.</div><div class="diff-removed">-///</div><div class="diff-removed">-/// This means that there is no way for the glfw runtime to support tabs,</div><div class="diff-removed">-/// splits, etc. without considerable effort. In fact, on Darwin, we do</div><div class="diff-removed">-/// support tabs because the minimal tabbing interface is a window abstraction,</div><div class="diff-removed">-/// but this is a bit of a hack. The native Swift runtime should be used instead</div><div class="diff-removed">-/// which uses real native tabbing.</div><div class="diff-removed">-///</div><div class="diff-removed">-/// Other runtimes a surface usually represents the equivalent of a "view"</div><div class="diff-removed">-/// or "widget" level granularity.</div><div class="diff-added">+/// GLFW surface (a window)</div><div> pub const Surface = struct {</div><div class="diff-removed">-    /// The glfw window handle</div><div class="diff-added">+    /// glfw window handle</div><div>     window: glfw.Window,</div><div class="diff-removed">-</div><div class="diff-removed">-    /// The glfw mouse cursor handle.</div><div class="diff-added">+    /// glfw cursor</div><div>     cursor: ?glfw.Cursor,</div><div class="diff-removed">-</div><div class="diff-removed">-    /// The app we're part of</div><div class="diff-removed">-    app: *App,</div><div class="diff-removed">-</div><div class="diff-removed">-    /// A core surface</div><div class="diff-added">+    /// parent app</div><div class="diff-added">+    app:    *App,</div><div class="diff-added">+    /// core surface</div><div>     core_surface: CoreSurface,</div><div class="diff-removed">-</div><div class="diff-removed">-    /// This is the key event that was processed in keyCallback. This is only</div><div class="diff-removed">-    /// non-null if the event was NOT consumed in keyCallback. This lets us</div><div class="diff-removed">-    /// know in charCallback whether we should populate it and call it again.</div><div class="diff-removed">-    /// (GLFW guarantees that charCallback is called after keyCallback).</div><div class="diff-added">+    /// key event tracking</div><div>     key_event: ?input.KeyEvent = null,</div><div class="diff-removed">-</div><div class="diff-removed">-    /// The monitor dimensions so we can toggle fullscreen on and off.</div><div class="diff-added">+    /// monitor dims for fullscreen toggle</div><div>     monitor_dims: MonitorDimensions,</div><div class="diff-removed">-</div><div class="diff-removed">-    /// Save the title text so that we can return it later when requested.</div><div class="diff-removed">-    /// This is allocated from the heap so it must be freed when we deinit the</div><div class="diff-removed">-    /// surface.</div><div class="diff-removed">-    title_text: ?[:0]const u8 = null,</div><div class="diff-removed">-</div><div class="diff-removed">-    pub const Options = struct {};</div><div class="diff-removed">-</div><div class="diff-removed">-    /// Initialize the surface into the given self pointer. This gives a</div><div class="diff-removed">-    /// stable pointer to the destination that can be used for callbacks.</div><div class="diff-added">+    /// saved title</div><div class="diff-added">+    title_text:   ?[:0]const u8 = null,</div><div class="diff-added">+</div><div>     pub fn init(self: *Surface, app: *App) !void {</div><div class="diff-removed">-        // Create our window</div><div>         const win = glfw.Window.create(</div><div class="diff-removed">-            640,</div><div class="diff-removed">-            480,</div><div class="diff-added">+            640, 480,</div><div>             "ghostty",</div><div>             if (app.config.fullscreen) glfw.Monitor.getPrimary() else null,</div><div>             null,</div><div class="diff-info">@@ -533,44 +436,39 @@         ) orelse return glfw.mustGetErrorCode();</div><div>         errdefer win.destroy();</div><div> </div><div class="diff-removed">-        // Setup our</div><div>         setInitialWindowPosition(</div><div>             win,</div><div>             app.config.@"window-position-x",</div><div>             app.config.@"window-position-y",</div><div>         );</div><div> </div><div class="diff-removed">-        // Get our physical DPI - debug only because we don't have a use for</div><div class="diff-removed">-        // this but the logging of it may be useful</div><div class="diff-added">+        // DPI logging</div><div>         if (builtin.mode == .Debug) {</div><div class="diff-removed">-            const monitor = win.getMonitor() orelse monitor: {</div><div class="diff-removed">-                log.warn("window had null monitor, getting primary monitor", .{});</div><div class="diff-removed">-                break :monitor glfw.Monitor.getPrimary().?;</div><div class="diff-removed">-            };</div><div class="diff-removed">-            const video_mode = monitor.getVideoMode() orelse return glfw.mustGetErrorCode();</div><div class="diff-removed">-            const physical_size = monitor.getPhysicalSize();</div><div class="diff-removed">-            const physical_x_dpi = @as(f32, @floatFromInt(video_mode.getWidth())) / (@as(f32, @floatFromInt(physical_size.width_mm)) / 25.4);</div><div class="diff-removed">-            const physical_y_dpi = @as(f32, @floatFromInt(video_mode.getHeight())) / (@as(f32, @floatFromInt(physical_size.height_mm)) / 25.4);</div><div class="diff-removed">-            log.debug("physical dpi x={} y={}", .{</div><div class="diff-removed">-                physical_x_dpi,</div><div class="diff-removed">-                physical_y_dpi,</div><div class="diff-removed">-            });</div><div class="diff-removed">-        }</div><div class="diff-removed">-</div><div class="diff-removed">-        // On Mac, enable window tabbing</div><div class="diff-added">+            const mon = win.getMonitor() orelse glfw.Monitor.getPrimary().?;</div><div class="diff-added">+            const vid = mon.getVideoMode() orelse return glfw.mustGetErrorCode();</div><div class="diff-added">+            const phys = mon.getPhysicalSize();</div><div class="diff-added">+            const dpi_x = @as(f32,@floatFromInt(vid.getWidth())) /</div><div class="diff-added">+                (@as(f32,@floatFromInt(phys.width_mm)) / 25.4);</div><div class="diff-added">+            const dpi_y = @as(f32,@floatFromInt(vid.getHeight())) /</div><div class="diff-added">+                (@as(f32,@floatFromInt(phys.height_mm)) / 25.4);</div><div class="diff-added">+            log.debug("physical dpi x={} y={}", .{ dpi_x, dpi_y });</div><div class="diff-added">+        }</div><div class="diff-added">+</div><div class="diff-added">+        // macOS tabbing</div><div>         if (comptime darwin_enabled) {</div><div class="diff-removed">-            const NSWindowTabbingMode = enum(usize) { automatic = 0, preferred = 1, disallowed = 2 };</div><div class="diff-added">+            const NSWindowTabbingMode = enum(usize){ automatic=0,preferred=1,disallowed=2 };</div><div>             const nswindow = objc.Object.fromId(glfwNative.getCocoaWindow(win).?);</div><div class="diff-removed">-</div><div class="diff-removed">-            // Tabbing mode enables tabbing at all</div><div class="diff-removed">-            nswindow.setProperty("tabbingMode", NSWindowTabbingMode.automatic);</div><div class="diff-removed">-</div><div class="diff-removed">-            // All windows within a tab bar must have a matching tabbing ID.</div><div class="diff-removed">-            // The app sets this up for us.</div><div class="diff-removed">-            nswindow.setProperty("tabbingIdentifier", app.darwin.tabbing_id);</div><div class="diff-removed">-        }</div><div class="diff-removed">-</div><div class="diff-removed">-        // Set our callbacks</div><div class="diff-added">+            nswindow.setProperty("tabbingMode",        NSWindowTabbingMode.automatic);</div><div class="diff-added">+            nswindow.setProperty("tabbingIdentifier",  app.darwin.tabbing_id);</div><div class="diff-added">+        }</div><div class="diff-added">+</div><div class="diff-added">+        // cursor</div><div class="diff-added">+        const cur = glfw.Cursor.createStandard(.ibeam) orelse return glfw.mustGetErrorCode();</div><div class="diff-added">+        errdefer cur.destroy();</div><div class="diff-added">+        if ((comptime !builtin.target.os.tag.isDarwin()) or internal_os.macos.isAtLeastVersion(13,0,0))</div><div class="diff-added">+            win.setCursor(cur);</div><div class="diff-added">+</div><div class="diff-added">+        // callbacks</div><div>         win.setUserPointer(&self.core_surface);</div><div>         win.setSizeCallback(sizeCallback);</div><div>         win.setCharCallback(charCallback);</div><div class="diff-info">@@ -582,42 +480,36 @@         win.setMouseButtonCallback(mouseButtonCallback);</div><div>         win.setDropCallback(dropCallback);</div><div> </div><div class="diff-removed">-        const dimensions: MonitorDimensions = dimensions: {</div><div class="diff-removed">-            const pos = win.getPos();</div><div class="diff-removed">-            const size = win.getFramebufferSize();</div><div class="diff-removed">-            break :dimensions .{</div><div class="diff-removed">-                .width = size.width,</div><div class="diff-removed">-                .height = size.height,</div><div class="diff-removed">-                .position_x = pos.x,</div><div class="diff-removed">-                .position_y = pos.y,</div><div class="diff-removed">-            };</div><div class="diff-removed">-        };</div><div class="diff-removed">-</div><div class="diff-removed">-        // Build our result</div><div class="diff-added">+        // init struct</div><div>         self.* = .{</div><div class="diff-removed">-            .app = app,</div><div class="diff-removed">-            .window = win,</div><div class="diff-removed">-            .cursor = null,</div><div class="diff-removed">-            .core_surface = undefined,</div><div class="diff-removed">-            .monitor_dims = dimensions,</div><div class="diff-added">+            .app           = app,</div><div class="diff-added">+            .window        = win,</div><div class="diff-added">+            .cursor        = cur,</div><div class="diff-added">+            .core_surface  = undefined,</div><div class="diff-added">+            .monitor_dims  = blk: {</div><div class="diff-added">+                const p = win.getPos();</div><div class="diff-added">+                const s = win.getFramebufferSize();</div><div class="diff-added">+                break :blk .{</div><div class="diff-added">+                    .width       = s.width,</div><div class="diff-added">+                    .height      = s.height,</div><div class="diff-added">+                    .position_x  = p.x,</div><div class="diff-added">+                    .position_y  = p.y,</div><div class="diff-added">+                };</div><div class="diff-added">+            },</div><div>         };</div><div>         errdefer self.* = undefined;</div><div> </div><div class="diff-removed">-        // Initialize our cursor</div><div class="diff-removed">-        try self.setMouseShape(.text);</div><div class="diff-removed">-</div><div class="diff-removed">-        // Add ourselves to the list of surfaces on the app.</div><div class="diff-added">+        // add to app</div><div>         try app.app.addSurface(self);</div><div>         errdefer app.app.deleteSurface(self);</div><div> </div><div class="diff-removed">-        // Get our new surface config</div><div class="diff-removed">-        var config = try apprt.surface.newConfig(app.app, &app.config);</div><div class="diff-removed">-        defer config.deinit();</div><div class="diff-removed">-</div><div class="diff-removed">-        // Initialize our surface now that we have the stable pointer.</div><div class="diff-added">+        // initialise core surface</div><div class="diff-added">+        var cfg = try apprt.surface.newConfig(app.app, &app.config);</div><div class="diff-added">+        defer cfg.deinit();</div><div class="diff-added">+</div><div>         try self.core_surface.init(</div><div>             app.app.alloc,</div><div class="diff-removed">-            &config,</div><div class="diff-added">+            &cfg,</div><div>             app.app,</div><div>             app,</div><div>             self,</div><div class="diff-info">@@ -628,189 +520,147 @@     pub fn deinit(self: *Surface) void {</div><div>         if (self.title_text) |t| self.core_surface.alloc.free(t);</div><div> </div><div class="diff-removed">-        // Remove ourselves from the list of known surfaces in the app.</div><div class="diff-added">+        // remove from app and deinit core first</div><div>         self.app.app.deleteSurface(self);</div><div class="diff-removed">-</div><div class="diff-removed">-        // Clean up our core surface so that all the rendering and IO stop.</div><div>         self.core_surface.deinit();</div><div> </div><div>         if (comptime darwin_enabled) {</div><div>             const nswindow = objc.Object.fromId(glfwNative.getCocoaWindow(self.window).?);</div><div class="diff-removed">-            const tabgroup = nswindow.getProperty(objc.Object, "tabGroup");</div><div class="diff-removed">-            const windows = tabgroup.getProperty(objc.Object, "windows");</div><div class="diff-removed">-            switch (windows.getProperty(usize, "count")) {</div><div class="diff-removed">-                // If we're going down to one window our tab bar is going to be</div><div class="diff-removed">-                // destroyed so unset it so that the later logic doesn't try to</div><div class="diff-removed">-                // use it.</div><div class="diff-removed">-                1 => {},</div><div class="diff-removed">-</div><div class="diff-removed">-                // If our tab bar is visible and we are going down to 1 window,</div><div class="diff-removed">-                // hide the tab bar. The check is "2" because our current window</div><div class="diff-removed">-                // is still present.</div><div class="diff-removed">-                2 => if (tabgroup.getProperty(bool, "tabBarVisible")) {</div><div class="diff-removed">-                    nswindow.msgSend(void, objc.sel("toggleTabBar:"), .{nswindow.value});</div><div class="diff-removed">-                },</div><div class="diff-removed">-</div><div class="diff-removed">-                else => {},</div><div class="diff-added">+            const group    = nswindow.getProperty(objc.Object, "tabGroup");</div><div class="diff-added">+            const windows  = group.getProperty(objc.Object, "windows");</div><div class="diff-added">+            if (windows.getProperty(usize,"count") == 2 and</div><div class="diff-added">+                group.getProperty(bool,"tabBarVisible"))</div><div class="diff-added">+            {</div><div class="diff-added">+                nswindow.msgSend(void, objc.sel("toggleTabBar:"), .{nswindow.value});</div><div>             }</div><div>         }</div><div> </div><div class="diff-removed">-        // We can now safely destroy our windows. We have to do this BEFORE</div><div class="diff-removed">-        // setting up the new focused window below.</div><div>         self.window.destroy();</div><div class="diff-removed">-        if (self.cursor) |c| {</div><div class="diff-removed">-            c.destroy();</div><div class="diff-removed">-            self.cursor = null;</div><div class="diff-removed">-        }</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    /// Checks if the glfw window is in fullscreen.</div><div class="diff-added">+        if (self.cursor) |c| c.destroy();</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    /// fullscreen check</div><div>     pub fn isFullscreen(self: *Surface) bool {</div><div>         return self.window.getMonitor() != null;</div><div>     }</div><div> </div><div class="diff-removed">-    /// Close this surface.</div><div class="diff-removed">-    pub fn close(self: *Surface, processActive: bool) void {</div><div class="diff-removed">-        _ = processActive;</div><div class="diff-removed">-        self.setShouldClose();</div><div class="diff-added">+    /// close surface</div><div class="diff-added">+    pub fn close(self: *Surface, _: bool) void {</div><div class="diff-added">+        self.window.setShouldClose(true);</div><div>         self.deinit();</div><div>         self.app.app.alloc.destroy(self);</div><div>     }</div><div> </div><div class="diff-removed">-    /// Set the initial window size. This is called exactly once at</div><div class="diff-removed">-    /// surface initialization time. This may be called before "self"</div><div class="diff-removed">-    /// is fully initialized.</div><div class="diff-removed">-    fn setInitialWindowSize(self: *const Surface, width: u32, height: u32) !void {</div><div class="diff-removed">-        const monitor = self.window.getMonitor() orelse glfw.Monitor.getPrimary() orelse {</div><div class="diff-added">+    /// initial window sizing helpers</div><div class="diff-added">+    fn setInitialWindowSize(self: *const Surface, w: u32, h: u32) !void {</div><div class="diff-added">+        const mon = self.window.getMonitor() orelse glfw.Monitor.getPrimary() orelse {</div><div>             log.warn("window is not on a monitor, not setting initial size", .{});</div><div>             return;</div><div>         };</div><div class="diff-removed">-</div><div class="diff-removed">-        const workarea = monitor.getWorkarea();</div><div class="diff-added">+        const wa = mon.getWorkarea();</div><div>         self.window.setSize(.{</div><div class="diff-removed">-            .width = @min(width, workarea.width),</div><div class="diff-removed">-            .height = @min(height, workarea.height),</div><div class="diff-added">+            .width  = @min(w, wa.width),</div><div class="diff-added">+            .height = @min(h, wa.height),</div><div>         });</div><div>     }</div><div class="diff-removed">-</div><div class="diff-removed">-    /// Set the initial window position. This is called exactly once at</div><div class="diff-removed">-    /// surface initialization time. This may be called before "self"</div><div class="diff-removed">-    /// is fully initialized.</div><div>     fn setInitialWindowPosition(win: glfw.Window, x: ?i16, y: ?i16) void {</div><div class="diff-removed">-        const start_position_x = x orelse return;</div><div class="diff-removed">-        const start_position_y = y orelse return;</div><div class="diff-removed">-</div><div class="diff-removed">-        log.debug("setting initial window position ({},{})", .{ start_position_x, start_position_y });</div><div class="diff-removed">-        win.setPos(.{ .x = start_position_x, .y = start_position_y });</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    /// Set the size limits of the window.</div><div class="diff-removed">-    /// Note: this interface is not good, we should redo it if we plan</div><div class="diff-removed">-    /// to use this more. i.e. you can't set max width but no max height,</div><div class="diff-removed">-    /// or no mins.</div><div class="diff-added">+        const px = x orelse return;</div><div class="diff-added">+        const py = y orelse return;</div><div class="diff-added">+        log.debug("setting initial window position ({},{})", .{ px, py });</div><div class="diff-added">+        win.setPos(.{ .x = px, .y = py });</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    /// size limits</div><div>     fn setSizeLimits(self: *Surface, min: apprt.SurfaceSize, max_: ?apprt.SurfaceSize) !void {</div><div>         self.window.setSizeLimits(.{</div><div class="diff-removed">-            .width = min.width,</div><div class="diff-added">+            .width  = min.width,</div><div>             .height = min.height,</div><div class="diff-removed">-        }, if (max_) |max| .{</div><div class="diff-removed">-            .width = max.width,</div><div class="diff-removed">-            .height = max.height,</div><div class="diff-removed">-        } else .{</div><div class="diff-removed">-            .width = null,</div><div class="diff-removed">-            .height = null,</div><div class="diff-removed">-        });</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    /// Returns the content scale for the created window.</div><div class="diff-added">+        }, if (max_) |mx| .{</div><div class="diff-added">+            .width  = mx.width,</div><div class="diff-added">+            .height = mx.height,</div><div class="diff-added">+        } else .{ .width = null, .height = null });</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    /// content scale</div><div>     pub fn getContentScale(self: *const Surface) !apprt.ContentScale {</div><div class="diff-removed">-        const scale = self.window.getContentScale();</div><div class="diff-removed">-        return apprt.ContentScale{ .x = scale.x_scale, .y = scale.y_scale };</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    /// Returns the size of the window in pixels. The pixel size may</div><div class="diff-removed">-    /// not match screen coordinate size but we should be able to convert</div><div class="diff-removed">-    /// back and forth using getContentScale.</div><div class="diff-added">+        const s = self.window.getContentScale();</div><div class="diff-added">+        return .{ .x = s.x_scale, .y = s.y_scale };</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    /// pixel size</div><div>     pub fn getSize(self: *const Surface) !apprt.SurfaceSize {</div><div class="diff-removed">-        const size = self.window.getFramebufferSize();</div><div class="diff-removed">-        return apprt.SurfaceSize{ .width = size.width, .height = size.height };</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    /// Returns the cursor position in scaled pixels relative to the</div><div class="diff-removed">-    /// upper-left of the window.</div><div class="diff-added">+        const s = self.window.getFramebufferSize();</div><div class="diff-added">+        return .{ .width = s.width, .height = s.height };</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    /// cursor pos</div><div>     pub fn getCursorPos(self: *const Surface) !apprt.CursorPos {</div><div class="diff-removed">-        const unscaled_pos = self.window.getCursorPos();</div><div class="diff-removed">-        const pos = try self.cursorPosToPixels(unscaled_pos);</div><div class="diff-removed">-        return apprt.CursorPos{</div><div class="diff-removed">-            .x = @floatCast(pos.xpos),</div><div class="diff-removed">-            .y = @floatCast(pos.ypos),</div><div class="diff-removed">-        };</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    /// Set the flag that notes this window should be closed for the next</div><div class="diff-removed">-    /// iteration of the event loop.</div><div class="diff-removed">-    pub fn setShouldClose(self: *Surface) void {</div><div class="diff-removed">-        self.window.setShouldClose(true);</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    /// Returns true if the window is flagged to close.</div><div class="diff-removed">-    pub fn shouldClose(self: *const Surface) bool {</div><div class="diff-removed">-        return self.window.shouldClose();</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    /// Set the title of the window.</div><div class="diff-removed">-    fn setTitle(self: *Surface, slice: [:0]const u8) !void {</div><div class="diff-added">+        const up = self.window.getCursorPos();</div><div class="diff-added">+        const p  = try self.cursorPosToPixels(up);</div><div class="diff-added">+        return .{ .x = @floatCast(p.xpos), .y = @floatCast(p.ypos) };</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    /// size conversion helper</div><div class="diff-added">+    fn cursorPosToPixels(</div><div class="diff-added">+        self: *const Surface,</div><div class="diff-added">+        pos:  glfw.Window.CursorPos,</div><div class="diff-added">+    ) !glfw.Window.CursorPos {</div><div class="diff-added">+        const sz  = self.window.getSize();</div><div class="diff-added">+        const fbs = self.window.getFramebufferSize();</div><div class="diff-added">+        if (fbs.width == sz.width and fbs.height == sz.height) return pos;</div><div class="diff-added">+</div><div class="diff-added">+        const sx = @as(f64,@floatFromInt(fbs.width)) /</div><div class="diff-added">+                   @as(f64,@floatFromInt(sz.width));</div><div class="diff-added">+        const sy = @as(f64,@floatFromInt(fbs.height)) /</div><div class="diff-added">+                   @as(f64,@floatFromInt(sz.height));</div><div class="diff-added">+        return .{ .xpos = pos.xpos * sx, .ypos = pos.ypos * sy };</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    /// title handling</div><div class="diff-added">+    fn setTitle(self: *Surface, txt: [:0]const u8) !void {</div><div>         if (self.title_text) |t| self.core_surface.alloc.free(t);</div><div class="diff-removed">-        self.title_text = try self.core_surface.alloc.dupeZ(u8, slice);</div><div class="diff-added">+        self.title_text = try self.core_surface.alloc.dupeZ(u8, txt);</div><div>         self.window.setTitle(self.title_text.?.ptr);</div><div>     }</div><div class="diff-removed">-</div><div class="diff-removed">-    /// Return the title of the window.</div><div class="diff-removed">-    pub fn getTitle(self: *Surface) ?[:0]const u8 {</div><div class="diff-removed">-        return self.title_text;</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    /// Set the shape of the cursor.</div><div class="diff-added">+    pub fn getTitle(self: *Surface) ?[:0]const u8 { return self.title_text; }</div><div class="diff-added">+</div><div class="diff-added">+    /// mouse cursor</div><div>     fn setMouseShape(self: *Surface, shape: terminal.MouseShape) !void {</div><div class="diff-removed">-        if ((comptime builtin.target.os.tag.isDarwin()) and</div><div class="diff-removed">-            !internal_os.macos.isAtLeastVersion(13, 0, 0))</div><div class="diff-added">+        if (comptime builtin.target.os.tag.isDarwin() and</div><div class="diff-added">+            !internal_os.macos.isAtLeastVersion(13,0,0))</div><div>         {</div><div class="diff-removed">-            // We only set our cursor if we're NOT on Mac, or if we are then the</div><div class="diff-removed">-            // macOS version is >= 13 (Ventura). On prior versions, glfw crashes</div><div class="diff-removed">-            // since we use a tab group.</div><div>             return;</div><div>         }</div><div> </div><div>         const new = glfw.Cursor.createStandard(switch (shape) {</div><div class="diff-removed">-            .default => .arrow,</div><div class="diff-removed">-            .text => .ibeam,</div><div class="diff-removed">-            .crosshair => .crosshair,</div><div class="diff-removed">-            .pointer => .pointing_hand,</div><div class="diff-removed">-            .ew_resize => .resize_ew,</div><div class="diff-removed">-            .ns_resize => .resize_ns,</div><div class="diff-removed">-            .nwse_resize => .resize_nwse,</div><div class="diff-removed">-            .nesw_resize => .resize_nesw,</div><div class="diff-removed">-            .all_scroll => .resize_all,</div><div class="diff-removed">-            .not_allowed => .not_allowed,</div><div class="diff-removed">-            else => return, // unsupported, ignore</div><div class="diff-removed">-        }) orelse {</div><div class="diff-removed">-            const err = glfw.mustGetErrorCode();</div><div class="diff-removed">-            log.warn("error creating cursor: {}", .{err});</div><div class="diff-removed">-            return;</div><div class="diff-removed">-        };</div><div class="diff-added">+            .default        => .arrow,</div><div class="diff-added">+            .text           => .ibeam,</div><div class="diff-added">+            .crosshair      => .crosshair,</div><div class="diff-added">+            .pointer        => .pointing_hand,</div><div class="diff-added">+            .ew_resize      => .resize_ew,</div><div class="diff-added">+            .ns_resize      => .resize_ns,</div><div class="diff-added">+            .nwse_resize    => .resize_nwse,</div><div class="diff-added">+            .nesw_resize    => .resize_nesw,</div><div class="diff-added">+            .all_scroll     => .resize_all,</div><div class="diff-added">+            .not_allowed    => .not_allowed,</div><div class="diff-added">+            else            => return,</div><div class="diff-added">+        }) orelse return glfw.mustGetErrorCode();</div><div>         errdefer new.destroy();</div><div> </div><div class="diff-removed">-        // Set our cursor before we destroy the old one</div><div>         self.window.setCursor(new);</div><div class="diff-removed">-</div><div>         if (self.cursor) |c| c.destroy();</div><div>         self.cursor = new;</div><div>     }</div><div class="diff-removed">-</div><div class="diff-removed">-    /// Set the visibility of the mouse cursor.</div><div class="diff-removed">-    fn setMouseVisibility(self: *Surface, visible: bool) void {</div><div class="diff-removed">-        self.window.setInputModeCursor(if (visible) .normal else .hidden);</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-added">+    fn setMouseVisibility(self: *Surface, vis: bool) void {</div><div class="diff-added">+        self.window.setInputModeCursor(if (vis) .normal else .hidden);</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    /// default env map</div><div class="diff-added">+    pub fn defaultTermioEnv(self: *Surface) !std.process.EnvMap {</div><div class="diff-added">+        return try internal_os.getEnvMap(self.app.app.alloc);</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    /// clipboard helpers</div><div>     pub fn supportsClipboard(</div><div>         self: *const Surface,</div><div>         clipboard_type: apprt.Clipboard,</div><div class="diff-info">@@ -822,370 +672,207 @@         };</div><div>     }</div><div> </div><div class="diff-removed">-    /// Start an async clipboard request.</div><div>     pub fn clipboardRequest(</div><div>         self: *Surface,</div><div>         clipboard_type: apprt.Clipboard,</div><div>         state: apprt.ClipboardRequest,</div><div>     ) !void {</div><div class="diff-removed">-        // GLFW can read clipboards immediately so just do that.</div><div>         const str: [:0]const u8 = switch (clipboard_type) {</div><div class="diff-removed">-            .standard => glfw.getClipboardString() orelse return glfw.mustGetErrorCode(),</div><div class="diff-removed">-            .selection, .primary => selection: {</div><div class="diff-removed">-                // Not supported except on Linux</div><div class="diff-removed">-                if (comptime builtin.os.tag != .linux) break :selection "";</div><div class="diff-removed">-</div><div class="diff-added">+            .standard => glfw.getClipboardString() orelse</div><div class="diff-added">+                         return glfw.mustGetErrorCode(),</div><div class="diff-added">+</div><div class="diff-added">+            .selection, .primary => blk: {</div><div class="diff-added">+                if (comptime builtin.os.tag != .linux) break :blk "";</div><div>                 const raw = glfwNative.getX11SelectionString() orelse</div><div class="diff-removed">-                    return glfw.mustGetErrorCode();</div><div class="diff-removed">-                break :selection std.mem.span(raw);</div><div class="diff-removed">-            },</div><div class="diff-removed">-        };</div><div class="diff-removed">-</div><div class="diff-removed">-        // Complete our request. We always allow unsafe because we don't</div><div class="diff-removed">-        // want to deal with user confirmation in this runtime.</div><div class="diff-added">+                            return glfw.mustGetErrorCode();</div><div class="diff-added">+                break :blk std.mem.span(raw);</div><div class="diff-added">+            },</div><div class="diff-added">+        };</div><div>         try self.core_surface.completeClipboardRequest(state, str, true);</div><div>     }</div><div class="diff-removed">-</div><div class="diff-removed">-    /// Set the clipboard.</div><div>     pub fn setClipboardString(</div><div>         self: *const Surface,</div><div class="diff-removed">-        val: [:0]const u8,</div><div class="diff-added">+        val:  [:0]const u8,</div><div>         clipboard_type: apprt.Clipboard,</div><div class="diff-removed">-        confirm: bool,</div><div class="diff-added">+        _: bool,</div><div>     ) !void {</div><div class="diff-removed">-        _ = confirm;</div><div>         _ = self;</div><div>         switch (clipboard_type) {</div><div>             .standard => glfw.setClipboardString(val),</div><div>             .selection, .primary => {</div><div class="diff-removed">-                // Not supported except on Linux</div><div>                 if (comptime builtin.os.tag != .linux) return;</div><div>                 glfwNative.setX11SelectionString(val.ptr);</div><div>             },</div><div>         }</div><div>     }</div><div> </div><div class="diff-removed">-    /// The cursor position from glfw directly is in screen coordinates but</div><div class="diff-removed">-    /// all our interface works in pixels.</div><div class="diff-removed">-    fn cursorPosToPixels(self: *const Surface, pos: glfw.Window.CursorPos) !glfw.Window.CursorPos {</div><div class="diff-removed">-        // The cursor position is in screen coordinates but we</div><div class="diff-removed">-        // want it in pixels. we need to get both the size of the</div><div class="diff-removed">-        // window in both to get the ratio to make the conversion.</div><div class="diff-removed">-        const size = self.window.getSize();</div><div class="diff-removed">-        const fb_size = self.window.getFramebufferSize();</div><div class="diff-removed">-</div><div class="diff-removed">-        // If our framebuffer and screen are the same, then there is no scaling</div><div class="diff-removed">-        // happening and we can short-circuit by returning the pos as-is.</div><div class="diff-removed">-        if (fb_size.width == size.width and fb_size.height == size.height)</div><div class="diff-removed">-            return pos;</div><div class="diff-removed">-</div><div class="diff-removed">-        const x_scale = @as(f64, @floatFromInt(fb_size.width)) / @as(f64, @floatFromInt(size.width));</div><div class="diff-removed">-        const y_scale = @as(f64, @floatFromInt(fb_size.height)) / @as(f64, @floatFromInt(size.height));</div><div class="diff-removed">-        return .{</div><div class="diff-removed">-            .xpos = pos.xpos * x_scale,</div><div class="diff-removed">-            .ypos = pos.ypos * y_scale,</div><div class="diff-removed">-        };</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    pub fn defaultTermioEnv(self: *Surface) !std.process.EnvMap {</div><div class="diff-removed">-        return try internal_os.getEnvMap(self.app.app.alloc);</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    fn sizeCallback(window: glfw.Window, width: i32, height: i32) void {</div><div class="diff-removed">-        _ = width;</div><div class="diff-removed">-        _ = height;</div><div class="diff-removed">-</div><div class="diff-removed">-        // Get the size. We are given a width/height but this is in screen</div><div class="diff-removed">-        // coordinates and we want raw pixels. The core window uses the content</div><div class="diff-removed">-        // scale to scale appropriately.</div><div class="diff-removed">-        const core_win = window.getUserPointer(CoreSurface) orelse return;</div><div class="diff-removed">-        const size = core_win.rt_surface.getSize() catch |err| {</div><div class="diff-removed">-            log.err("error querying window size for size callback err={}", .{err});</div><div class="diff-removed">-            return;</div><div class="diff-removed">-        };</div><div class="diff-removed">-</div><div class="diff-removed">-        // Call the primary callback.</div><div class="diff-removed">-        core_win.sizeCallback(size) catch |err| {</div><div class="diff-added">+    /// callbacks ----------------------------------------------------------------</div><div class="diff-added">+</div><div class="diff-added">+    fn sizeCallback(window: glfw.Window, _: i32, _: i32) void {</div><div class="diff-added">+        const core = window.getUserPointer(CoreSurface) orelse return;</div><div class="diff-added">+        const sz = core.rt_surface.getSize() catch |err| {</div><div class="diff-added">+            log.err("error querying size in pixels, err={}", .{err});</div><div class="diff-added">+            return;</div><div class="diff-added">+        };</div><div class="diff-added">+        core.sizeCallback(sz) catch |err| {</div><div>             log.err("error in size callback err={}", .{err});</div><div class="diff-removed">-            return;</div><div>         };</div><div>     }</div><div> </div><div>     fn charCallback(window: glfw.Window, codepoint: u21) void {</div><div class="diff-removed">-        const core_win = window.getUserPointer(CoreSurface) orelse return;</div><div class="diff-removed">-</div><div class="diff-removed">-        // We need a key event in order to process the charcallback. If it</div><div class="diff-removed">-        // isn't set then the key event was consumed.</div><div class="diff-removed">-        var key_event = core_win.rt_surface.key_event orelse return;</div><div class="diff-removed">-        core_win.rt_surface.key_event = null;</div><div class="diff-removed">-</div><div class="diff-removed">-        // Populate the utf8 value for the event</div><div class="diff-added">+        const core = window.getUserPointer(CoreSurface) orelse return;</div><div class="diff-added">+</div><div class="diff-added">+        // if key consumed skip</div><div class="diff-added">+        if (core.rt_surface.key_event == null) return;</div><div class="diff-added">+</div><div class="diff-added">+        var ke = core.rt_surface.key_event.?;</div><div class="diff-added">+        core.rt_surface.key_event = null;</div><div class="diff-added">+</div><div>         var buf: [4]u8 = undefined;</div><div>         const len = std.unicode.utf8Encode(codepoint, &buf) catch |err| {</div><div class="diff-removed">-            log.err("error encoding codepoint={} err={}", .{ codepoint, err });</div><div class="diff-removed">-            return;</div><div class="diff-removed">-        };</div><div class="diff-removed">-        key_event.utf8 = buf[0..len];</div><div class="diff-removed">-</div><div class="diff-removed">-        // On macOS we need to also disable some modifiers because</div><div class="diff-removed">-        // alt+key consumes the alt.</div><div class="diff-removed">-        if (comptime builtin.target.os.tag.isDarwin()) {</div><div class="diff-removed">-            // For GLFW, we say we always consume alt because</div><div class="diff-removed">-            // GLFW doesn't have a way to disable the alt key.</div><div class="diff-removed">-            key_event.consumed_mods.alt = true;</div><div class="diff-removed">-        }</div><div class="diff-removed">-</div><div class="diff-removed">-        _ = core_win.keyCallback(key_event) catch |err| {</div><div class="diff-added">+            log.err("error encoding codepoint={} err={}", .{codepoint, err});</div><div class="diff-added">+            return;</div><div class="diff-added">+        };</div><div class="diff-added">+        ke.utf8 = buf[0..len];</div><div class="diff-added">+</div><div class="diff-added">+        _ = core.keyCallback(ke) catch |err| {</div><div>             log.err("error in key callback err={}", .{err});</div><div class="diff-removed">-            return;</div><div>         };</div><div>     }</div><div> </div><div>     fn keyCallback(</div><div>         window: glfw.Window,</div><div>         glfw_key: glfw.Key,</div><div class="diff-removed">-        scancode: i32,</div><div class="diff-added">+        _: i32,</div><div>         glfw_action: glfw.Action,</div><div>         glfw_mods: glfw.Mods,</div><div>     ) void {</div><div class="diff-removed">-        _ = scancode;</div><div class="diff-removed">-</div><div class="diff-removed">-        const core_win = window.getUserPointer(CoreSurface) orelse return;</div><div class="diff-removed">-</div><div class="diff-removed">-        // Convert our glfw types into our input types</div><div class="diff-added">+        const core = window.getUserPointer(CoreSurface) orelse return;</div><div class="diff-added">+</div><div>         const mods: input.Mods = .{</div><div class="diff-removed">-            .shift = glfw_mods.shift,</div><div class="diff-removed">-            .ctrl = glfw_mods.control,</div><div class="diff-removed">-            .alt = glfw_mods.alt,</div><div class="diff-removed">-            .super = glfw_mods.super,</div><div class="diff-added">+            .shift  = glfw_mods.shift,</div><div class="diff-added">+            .ctrl   = glfw_mods.control,</div><div class="diff-added">+            .alt    = glfw_mods.alt,</div><div class="diff-added">+            .super  = glfw_mods.super,</div><div>         };</div><div>         const action: input.Action = switch (glfw_action) {</div><div class="diff-removed">-            .release => .release,</div><div class="diff-removed">-            .press => .press,</div><div class="diff-removed">-            .repeat => .repeat,</div><div class="diff-removed">-        };</div><div class="diff-added">+            .release => .release, .press => .press, .repeat => .repeat,</div><div class="diff-added">+        };</div><div class="diff-added">+</div><div>         const key: input.Key = switch (glfw_key) {</div><div class="diff-removed">-            .a => .a,</div><div class="diff-removed">-            .b => .b,</div><div class="diff-removed">-            .c => .c,</div><div class="diff-removed">-            .d => .d,</div><div class="diff-removed">-            .e => .e,</div><div class="diff-removed">-            .f => .f,</div><div class="diff-removed">-            .g => .g,</div><div class="diff-removed">-            .h => .h,</div><div class="diff-removed">-            .i => .i,</div><div class="diff-removed">-            .j => .j,</div><div class="diff-removed">-            .k => .k,</div><div class="diff-removed">-            .l => .l,</div><div class="diff-removed">-            .m => .m,</div><div class="diff-removed">-            .n => .n,</div><div class="diff-removed">-            .o => .o,</div><div class="diff-removed">-            .p => .p,</div><div class="diff-removed">-            .q => .q,</div><div class="diff-removed">-            .r => .r,</div><div class="diff-removed">-            .s => .s,</div><div class="diff-removed">-            .t => .t,</div><div class="diff-removed">-            .u => .u,</div><div class="diff-removed">-            .v => .v,</div><div class="diff-removed">-            .w => .w,</div><div class="diff-removed">-            .x => .x,</div><div class="diff-removed">-            .y => .y,</div><div class="diff-removed">-            .z => .z,</div><div class="diff-removed">-            .zero => .zero,</div><div class="diff-removed">-            .one => .one,</div><div class="diff-removed">-            .two => .two,</div><div class="diff-removed">-            .three => .three,</div><div class="diff-removed">-            .four => .four,</div><div class="diff-removed">-            .five => .five,</div><div class="diff-removed">-            .six => .six,</div><div class="diff-removed">-            .seven => .seven,</div><div class="diff-removed">-            .eight => .eight,</div><div class="diff-removed">-            .nine => .nine,</div><div class="diff-removed">-            .up => .up,</div><div class="diff-removed">-            .down => .down,</div><div class="diff-removed">-            .right => .right,</div><div class="diff-removed">-            .left => .left,</div><div class="diff-removed">-            .home => .home,</div><div class="diff-removed">-            .end => .end,</div><div class="diff-removed">-            .page_up => .page_up,</div><div class="diff-removed">-            .page_down => .page_down,</div><div class="diff-removed">-            .escape => .escape,</div><div class="diff-removed">-            .F1 => .f1,</div><div class="diff-removed">-            .F2 => .f2,</div><div class="diff-removed">-            .F3 => .f3,</div><div class="diff-removed">-            .F4 => .f4,</div><div class="diff-removed">-            .F5 => .f5,</div><div class="diff-removed">-            .F6 => .f6,</div><div class="diff-removed">-            .F7 => .f7,</div><div class="diff-removed">-            .F8 => .f8,</div><div class="diff-removed">-            .F9 => .f9,</div><div class="diff-removed">-            .F10 => .f10,</div><div class="diff-removed">-            .F11 => .f11,</div><div class="diff-removed">-            .F12 => .f12,</div><div class="diff-removed">-            .F13 => .f13,</div><div class="diff-removed">-            .F14 => .f14,</div><div class="diff-removed">-            .F15 => .f15,</div><div class="diff-removed">-            .F16 => .f16,</div><div class="diff-removed">-            .F17 => .f17,</div><div class="diff-removed">-            .F18 => .f18,</div><div class="diff-removed">-            .F19 => .f19,</div><div class="diff-removed">-            .F20 => .f20,</div><div class="diff-removed">-            .F21 => .f21,</div><div class="diff-removed">-            .F22 => .f22,</div><div class="diff-removed">-            .F23 => .f23,</div><div class="diff-removed">-            .F24 => .f24,</div><div class="diff-removed">-            .F25 => .f25,</div><div class="diff-removed">-            .kp_0 => .kp_0,</div><div class="diff-removed">-            .kp_1 => .kp_1,</div><div class="diff-removed">-            .kp_2 => .kp_2,</div><div class="diff-removed">-            .kp_3 => .kp_3,</div><div class="diff-removed">-            .kp_4 => .kp_4,</div><div class="diff-removed">-            .kp_5 => .kp_5,</div><div class="diff-removed">-            .kp_6 => .kp_6,</div><div class="diff-removed">-            .kp_7 => .kp_7,</div><div class="diff-removed">-            .kp_8 => .kp_8,</div><div class="diff-removed">-            .kp_9 => .kp_9,</div><div class="diff-removed">-            .kp_decimal => .kp_decimal,</div><div class="diff-removed">-            .kp_divide => .kp_divide,</div><div class="diff-removed">-            .kp_multiply => .kp_multiply,</div><div class="diff-removed">-            .kp_subtract => .kp_subtract,</div><div class="diff-removed">-            .kp_add => .kp_add,</div><div class="diff-removed">-            .kp_enter => .kp_enter,</div><div class="diff-removed">-            .kp_equal => .kp_equal,</div><div class="diff-removed">-            .grave_accent => .grave_accent,</div><div class="diff-removed">-            .minus => .minus,</div><div class="diff-removed">-            .equal => .equal,</div><div class="diff-removed">-            .space => .space,</div><div class="diff-removed">-            .semicolon => .semicolon,</div><div class="diff-removed">-            .apostrophe => .apostrophe,</div><div class="diff-removed">-            .comma => .comma,</div><div class="diff-removed">-            .period => .period,</div><div class="diff-removed">-            .slash => .slash,</div><div class="diff-removed">-            .left_bracket => .left_bracket,</div><div class="diff-removed">-            .right_bracket => .right_bracket,</div><div class="diff-removed">-            .backslash => .backslash,</div><div class="diff-removed">-            .enter => .enter,</div><div class="diff-removed">-            .tab => .tab,</div><div class="diff-removed">-            .backspace => .backspace,</div><div class="diff-removed">-            .insert => .insert,</div><div class="diff-removed">-            .delete => .delete,</div><div class="diff-removed">-            .caps_lock => .caps_lock,</div><div class="diff-removed">-            .scroll_lock => .scroll_lock,</div><div class="diff-removed">-            .num_lock => .num_lock,</div><div class="diff-removed">-            .print_screen => .print_screen,</div><div class="diff-removed">-            .pause => .pause,</div><div class="diff-removed">-            .left_shift => .left_shift,</div><div class="diff-removed">-            .left_control => .left_control,</div><div class="diff-removed">-            .left_alt => .left_alt,</div><div class="diff-removed">-            .left_super => .left_super,</div><div class="diff-removed">-            .right_shift => .right_shift,</div><div class="diff-removed">-            .right_control => .right_control,</div><div class="diff-removed">-            .right_alt => .right_alt,</div><div class="diff-removed">-            .right_super => .right_super,</div><div class="diff-removed">-</div><div class="diff-removed">-            .menu,</div><div class="diff-removed">-            .world_1,</div><div class="diff-removed">-            .world_2,</div><div class="diff-removed">-            .unknown,</div><div class="diff-removed">-            => .invalid,</div><div class="diff-removed">-        };</div><div class="diff-removed">-</div><div class="diff-removed">-        // This is a hack for GLFW. We require our apprts to send both</div><div class="diff-removed">-        // the UTF8 encoding AND the keypress at the same time. Its critical</div><div class="diff-removed">-        // for things like ctrl sequences to work. However, GLFW doesn't</div><div class="diff-removed">-        // provide this information all at once. So we just infer based on</div><div class="diff-removed">-        // the key press. This isn't portable but GLFW is only for testing.</div><div class="diff-removed">-        const utf8 = switch (key) {</div><div class="diff-removed">-            inline else => |k| utf8: {</div><div class="diff-removed">-                if (mods.shift) break :utf8 "";</div><div class="diff-removed">-                const cp = k.codepoint() orelse break :utf8 "";</div><div class="diff-removed">-                const byte = std.math.cast(u8, cp) orelse break :utf8 "";</div><div class="diff-removed">-                break :utf8 &.{byte};</div><div class="diff-removed">-            },</div><div class="diff-removed">-        };</div><div class="diff-removed">-</div><div class="diff-removed">-        const key_event: input.KeyEvent = .{</div><div class="diff-removed">-            .action = action,</div><div class="diff-removed">-            .key = key,</div><div class="diff-removed">-            .physical_key = key,</div><div class="diff-removed">-            .mods = mods,</div><div class="diff-removed">-            .consumed_mods = .{},</div><div class="diff-removed">-            .composing = false,</div><div class="diff-removed">-            .utf8 = utf8,</div><div class="diff-added">+            .a => .a, .b => .b, .c => .c, .d => .d, .e => .e, .f => .f,</div><div class="diff-added">+            .g => .g, .h => .h, .i => .i, .j => .j, .k => .k, .l => .l,</div><div class="diff-added">+            .m => .m, .n => .n, .o => .o, .p => .p, .q => .q, .r => .r,</div><div class="diff-added">+            .s => .s, .t => .t, .u => .u, .v => .v, .w => .w, .x => .x,</div><div class="diff-added">+            .y => .y, .z => .z,</div><div class="diff-added">+            .zero => .zero, .one => .one, .two => .two, .three => .three,</div><div class="diff-added">+            .four => .four, .five => .five, .six => .six, .seven => .seven,</div><div class="diff-added">+            .eight => .eight, .nine => .nine,</div><div class="diff-added">+            .up => .up, .down => .down, .right => .right, .left => .left,</div><div class="diff-added">+            .home => .home, .end => .end, .page_up => .page_up,</div><div class="diff-added">+            .page_down => .page_down, .escape => .escape,</div><div class="diff-added">+            .F1 => .f1, .F2 => .f2, .F3 => .f3, .F4 => .f4, .F5 => .f5,</div><div class="diff-added">+            .F6 => .f6, .F7 => .f7, .F8 => .f8, .F9 => .f9, .F10 => .f10,</div><div class="diff-added">+            .F11 => .f11, .F12 => .f12, .F13 => .f13, .F14 => .f14,</div><div class="diff-added">+            .F15 => .f15, .F16 => .f16, .F17 => .f17, .F18 => .f18,</div><div class="diff-added">+            .F19 => .f19, .F20 => .f20, .F21 => .f21, .F22 => .f22,</div><div class="diff-added">+            .F23 => .f23, .F24 => .f24, .F25 => .f25,</div><div class="diff-added">+            .kp_0 => .kp_0, .kp_1 => .kp_1, .kp_2 => .kp_2,</div><div class="diff-added">+            .kp_3 => .kp_3, .kp_4 => .kp_4, .kp_5 => .kp_5,</div><div class="diff-added">+            .kp_6 => .kp_6, .kp_7 => .kp_7, .kp_8 => .kp_8,</div><div class="diff-added">+            .kp_9 => .kp_9, .kp_decimal => .kp_decimal,</div><div class="diff-added">+            .kp_divide => .kp_divide, .kp_multiply => .kp_multiply,</div><div class="diff-added">+            .kp_subtract => .kp_subtract, .kp_add => .kp_add,</div><div class="diff-added">+            .kp_enter => .kp_enter, .kp_equal => .kp_equal,</div><div class="diff-added">+            .grave_accent => .grave_accent, .minus => .minus,</div><div class="diff-added">+            .equal => .equal, .space => .space, .semicolon => .semicolon,</div><div class="diff-added">+            .apostrophe => .apostrophe, .comma => .comma, .period => .period,</div><div class="diff-added">+            .slash => .slash, .left_bracket => .left_bracket,</div><div class="diff-added">+            .right_bracket => .right_bracket, .backslash => .backslash,</div><div class="diff-added">+            .enter => .enter, .tab => .tab, .backspace => .backspace,</div><div class="diff-added">+            .insert => .insert, .delete => .delete, .caps_lock => .caps_lock,</div><div class="diff-added">+            .scroll_lock => .scroll_lock, .num_lock => .num_lock,</div><div class="diff-added">+            .print_screen => .print_screen, .pause => .pause,</div><div class="diff-added">+            .left_shift => .left_shift, .left_control => .left_control,</div><div class="diff-added">+            .left_alt => .left_alt, .left_super => .left_super,</div><div class="diff-added">+            .right_shift => .right_shift, .right_control => .right_control,</div><div class="diff-added">+            .right_alt => .right_alt, .right_super => .right_super,</div><div class="diff-added">+            else => .invalid,</div><div class="diff-added">+        };</div><div class="diff-added">+</div><div class="diff-added">+        const utf8: []const u8 = switch (key) {</div><div class="diff-added">+            inline else => |k| blk: {</div><div class="diff-added">+                if (mods.shift) break :blk "";</div><div class="diff-added">+                const cp = k.codepoint() orelse break :blk "";</div><div class="diff-added">+                const b  = std.math.cast(u8, cp) orelse break :blk "";</div><div class="diff-added">+                break :blk &.{b};</div><div class="diff-added">+            },</div><div class="diff-added">+        };</div><div class="diff-added">+</div><div class="diff-added">+        var key_event: input.KeyEvent = .{</div><div class="diff-added">+            .action              = action,</div><div class="diff-added">+            .key                 = key,</div><div class="diff-added">+            .physical_key        = key,</div><div class="diff-added">+            .mods                = mods,</div><div class="diff-added">+            .consumed_mods       = .{},</div><div class="diff-added">+            .composing           = false,</div><div class="diff-added">+            .utf8                = utf8,</div><div>             .unshifted_codepoint = if (utf8.len > 0) @intCast(utf8[0]) else 0,</div><div>         };</div><div> </div><div class="diff-removed">-        const effect = core_win.keyCallback(key_event) catch |err| {</div><div class="diff-added">+        // macOS alt consumption</div><div class="diff-added">+        if (comptime builtin.target.os.tag.isDarwin()) {</div><div class="diff-added">+            key_event.consumed_mods.alt = true;</div><div class="diff-added">+        }</div><div class="diff-added">+</div><div class="diff-added">+        const effect = core.keyCallback(key_event) catch |err| {</div><div>             log.err("error in key callback err={}", .{err});</div><div>             return;</div><div>         };</div><div> </div><div class="diff-removed">-        // Surface closed.</div><div>         if (effect == .closed) return;</div><div> </div><div class="diff-removed">-        // If it wasn't consumed, we set it on our self so that charcallback</div><div class="diff-removed">-        // can make another attempt. Otherwise, we set null so the charcallback</div><div class="diff-removed">-        // is ignored.</div><div class="diff-removed">-        core_win.rt_surface.key_event = null;</div><div class="diff-removed">-        if (effect == .ignored and</div><div class="diff-removed">-            (action == .press or action == .repeat))</div><div class="diff-removed">-        {</div><div class="diff-removed">-            core_win.rt_surface.key_event = key_event;</div><div class="diff-removed">-        }</div><div class="diff-added">+        core.rt_surface.key_event = null;</div><div class="diff-added">+        if (effect == .ignored and (action == .press or action == .repeat))</div><div class="diff-added">+            core.rt_surface.key_event = key_event;</div><div>     }</div><div> </div><div>     fn focusCallback(window: glfw.Window, focused: bool) void {</div><div class="diff-removed">-        const core_win = window.getUserPointer(CoreSurface) orelse return;</div><div class="diff-removed">-        core_win.focusCallback(focused) catch |err| {</div><div class="diff-added">+        const core = window.getUserPointer(CoreSurface) orelse return;</div><div class="diff-added">+        core.focusCallback(focused) catch |err| {</div><div>             log.err("error in focus callback err={}", .{err});</div><div class="diff-removed">-            return;</div><div>         };</div><div>     }</div><div> </div><div>     fn refreshCallback(window: glfw.Window) void {</div><div class="diff-removed">-        const core_win = window.getUserPointer(CoreSurface) orelse return;</div><div class="diff-removed">-        core_win.refreshCallback() catch |err| {</div><div class="diff-added">+        const core = window.getUserPointer(CoreSurface) orelse return;</div><div class="diff-added">+        core.refreshCallback() catch |err| {</div><div>             log.err("error in refresh callback err={}", .{err});</div><div class="diff-removed">-            return;</div><div>         };</div><div>     }</div><div> </div><div>     fn scrollCallback(window: glfw.Window, xoff: f64, yoff: f64) void {</div><div class="diff-removed">-        // Glfw doesn't support any of the scroll mods.</div><div class="diff-removed">-        const scroll_mods: input.ScrollMods = .{};</div><div class="diff-removed">-</div><div class="diff-removed">-        const core_win = window.getUserPointer(CoreSurface) orelse return;</div><div class="diff-removed">-        core_win.scrollCallback(xoff, yoff, scroll_mods) catch |err| {</div><div class="diff-added">+        const core = window.getUserPointer(CoreSurface) orelse return;</div><div class="diff-added">+        const sm: input.ScrollMods = .{};</div><div class="diff-added">+        core.scrollCallback(xoff, yoff, sm) catch |err| {</div><div>             log.err("error in scroll callback err={}", .{err});</div><div class="diff-removed">-            return;</div><div>         };</div><div>     }</div><div> </div><div>     fn cursorPosCallback(</div><div>         window: glfw.Window,</div><div class="diff-removed">-        unscaled_xpos: f64,</div><div class="diff-removed">-        unscaled_ypos: f64,</div><div class="diff-added">+        ux: f64, uy: f64,</div><div>     ) void {</div><div class="diff-removed">-        const core_win = window.getUserPointer(CoreSurface) orelse return;</div><div class="diff-removed">-</div><div class="diff-removed">-        // Convert our unscaled x/y to scaled.</div><div class="diff-removed">-        const pos = core_win.rt_surface.cursorPosToPixels(.{</div><div class="diff-removed">-            .xpos = unscaled_xpos,</div><div class="diff-removed">-            .ypos = unscaled_ypos,</div><div class="diff-removed">-        }) catch |err| {</div><div class="diff-removed">-            log.err(</div><div class="diff-removed">-                "error converting cursor pos to scaled pixels in cursor pos callback err={}",</div><div class="diff-removed">-                .{err},</div><div class="diff-removed">-            );</div><div class="diff-removed">-            return;</div><div class="diff-removed">-        };</div><div class="diff-removed">-</div><div class="diff-removed">-        core_win.cursorPosCallback(.{</div><div class="diff-added">+        const core = window.getUserPointer(CoreSurface) orelse return;</div><div class="diff-added">+        const pos = core.rt_surface.cursorPosToPixels(.{ .xpos=ux, .ypos=uy }) catch |err| {</div><div class="diff-added">+            log.err("error converting cursor pos err={}", .{err});</div><div class="diff-added">+            return;</div><div class="diff-added">+        };</div><div class="diff-added">+        core.cursorPosCallback(.{</div><div>             .x = @floatCast(pos.xpos),</div><div>             .y = @floatCast(pos.ypos),</div><div>         }, null) catch |err| {</div><div>             log.err("error in cursor pos callback err={}", .{err});</div><div class="diff-removed">-            return;</div><div>         };</div><div>     }</div><div> </div><div class="diff-info">@@ -1195,66 +882,49 @@         glfw_action: glfw.Action,</div><div>         glfw_mods: glfw.Mods,</div><div>     ) void {</div><div class="diff-removed">-        const core_win = window.getUserPointer(CoreSurface) orelse return;</div><div class="diff-removed">-</div><div class="diff-removed">-        // Convert glfw button to input button</div><div class="diff-added">+        const core = window.getUserPointer(CoreSurface) orelse return;</div><div class="diff-added">+</div><div>         const mods: input.Mods = .{</div><div class="diff-removed">-            .shift = glfw_mods.shift,</div><div class="diff-removed">-            .ctrl = glfw_mods.control,</div><div class="diff-removed">-            .alt = glfw_mods.alt,</div><div class="diff-removed">-            .super = glfw_mods.super,</div><div class="diff-added">+            .shift = glfw_mods.shift, .ctrl = glfw_mods.control,</div><div class="diff-added">+            .alt   = glfw_mods.alt,   .super = glfw_mods.super,</div><div>         };</div><div>         const button: input.MouseButton = switch (glfw_button) {</div><div class="diff-removed">-            .left => .left,</div><div class="diff-removed">-            .right => .right,</div><div class="diff-removed">-            .middle => .middle,</div><div class="diff-removed">-            .four => .four,</div><div class="diff-removed">-            .five => .five,</div><div class="diff-removed">-            .six => .six,</div><div class="diff-removed">-            .seven => .seven,</div><div class="diff-removed">-            .eight => .eight,</div><div class="diff-removed">-        };</div><div class="diff-removed">-        const action: input.MouseButtonState = switch (glfw_action) {</div><div class="diff-removed">-            .press => .press,</div><div class="diff-removed">-            .release => .release,</div><div class="diff-removed">-            else => unreachable,</div><div class="diff-removed">-        };</div><div class="diff-removed">-</div><div class="diff-removed">-        _ = core_win.mouseButtonCallback(action, button, mods) catch |err| {</div><div class="diff-removed">-            log.err("error in scroll callback err={}", .{err});</div><div class="diff-removed">-            return;</div><div class="diff-added">+            .left  => .left,  .right => .right, .middle => .middle,</div><div class="diff-added">+            .four  => .four,  .five  => .five,  .six   => .six,</div><div class="diff-added">+            .seven => .seven, .eight => .eight,</div><div class="diff-added">+        };</div><div class="diff-added">+        const act: input.MouseButtonState = switch (glfw_action) {</div><div class="diff-added">+            .press => .press, .release => .release, else => unreachable,</div><div class="diff-added">+        };</div><div class="diff-added">+</div><div class="diff-added">+        _ = core.mouseButtonCallback(act, button, mods) catch |err| {</div><div class="diff-added">+            log.err("error in mouse button callback err={}", .{err});</div><div>         };</div><div>     }</div><div> </div><div>     fn dropCallback(window: glfw.Window, paths: [][*:0]const u8) void {</div><div class="diff-removed">-        const surface = window.getUserPointer(CoreSurface) orelse return;</div><div class="diff-removed">-</div><div class="diff-removed">-        var list = std.ArrayList(u8).init(surface.alloc);</div><div class="diff-added">+        const core_surface = window.getUserPointer(CoreSurface) orelse return;</div><div class="diff-added">+</div><div class="diff-added">+        var list = std.ArrayList(u8).init(core_surface.alloc);</div><div>         defer list.deinit();</div><div> </div><div class="diff-removed">-        for (paths) |path| {</div><div class="diff-removed">-            const path_slice = std.mem.span(path);</div><div class="diff-removed">-</div><div class="diff-removed">-            // preallocate worst case of escaping every char + space</div><div class="diff-removed">-            list.ensureTotalCapacity(path_slice.len * 2 + 1) catch |err| {</div><div class="diff-added">+        for (paths) |p| {</div><div class="diff-added">+            const slice = std.mem.span(p);</div><div class="diff-added">+            const w = list.writer();</div><div class="diff-added">+            list.ensureTotalCapacity(slice.len * 2 + 1) catch |err| {</div><div class="diff-added">+                log.err("error in drop callback err={}", .{err}); return;</div><div class="diff-added">+            };</div><div class="diff-added">+            for (slice) |c| {</div><div class="diff-added">+                if (std.mem.indexOfScalar(u8, "\\ ()[]{}<>\"'`!#$&;|*?\t", c)) | _ |</div><div class="diff-added">+                    w.print("\\{c}", .{c}) catch unreachable</div><div class="diff-added">+                else</div><div class="diff-added">+                    w.writeByte(c) catch unreachable;</div><div class="diff-added">+            }</div><div class="diff-added">+            w.writeByte(' ') catch unreachable;</div><div class="diff-added">+            core_surface.textCallback(list.items) catch |err| {</div><div>                 log.err("error in drop callback err={}", .{err});</div><div class="diff-removed">-                return;</div><div>             };</div><div class="diff-removed">-</div><div class="diff-removed">-            const writer = list.writer();</div><div class="diff-removed">-            for (path_slice) |c| {</div><div class="diff-removed">-                if (std.mem.indexOfScalar(u8, "\\ ()[]{}<>\"'`!#$&;|*?\t", c)) |_| {</div><div class="diff-removed">-                    writer.print("\\{c}", .{c}) catch unreachable; //  memory preallocated</div><div class="diff-removed">-                } else writer.writeByte(c) catch unreachable; // same here</div><div class="diff-removed">-            }</div><div class="diff-removed">-            writer.writeByte(' ') catch unreachable; // separate paths</div><div class="diff-removed">-</div><div class="diff-removed">-            surface.textCallback(list.items) catch |err| {</div><div class="diff-removed">-                log.err("error in drop callback err={}", .{err});</div><div class="diff-removed">-                return;</div><div class="diff-removed">-            };</div><div class="diff-removed">-</div><div class="diff-removed">-            list.clearRetainingCapacity(); // avoid unnecessary reallocations</div><div class="diff-added">+            list.clearRetainingCapacity();</div><div>         }</div><div>     }</div><div> };</div></pre>
                </div>
            </div>
        </section>
    </main>
    <footer>
        <p>LoCoDiff-bench - <a href="https://github.com/AbanteAI/LoCoDiff-bench">GitHub Repository</a></p>
    </footer>
</body>
</html>
    