<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case: lib/segment/tests/integration/sparse_vector_index_search_tests.rs - o3</title>
    <link rel="stylesheet" href="../../styles.css">
</head>
<body>
    <header>
        <h1>Case: lib/segment/tests/integration/sparse_vector_index_search_tests.rs</h1>
        <p><a href="../../models/openai_o3.html">‚Üê Back to o3 Cases</a> | <a href="../../index.html">Home</a></p>
    </header>
    <main>
        <section class="case-details">
            <div class="case-info">
                <h2>Benchmark Case Information</h2>
                <p><strong>Model:</strong> o3</p>
                <p><strong>Status:</strong> <span class="failure">Failure</span></p>
                <p><strong>Prompt Tokens:</strong> 56319</p>
                <p><strong>Output Tokens:</strong> N/A</p>
                <p><strong>Native Prompt Tokens:</strong> 56727</p>
                <p><strong>Native Completion Tokens:</strong> 7272</p>
                <p><strong>Native Tokens Reasoning:</strong> 1280</p>
                <p><strong>Native Finish Reason:</strong> stop</p>
                <p><strong>Cost:</strong> $0.9010575</p>
            </div>
            
            <div class="content-links">
                <h2>View Content</h2>
                <ul>
                    <li><a href="../../content/openai_o3/qdrant_lib_segment_tests_integration_sparse_vector_index_search_tests.rs/prompt.html" class="content-link">View Prompt</a></li>
                    <li><a href="../../content/openai_o3/qdrant_lib_segment_tests_integration_sparse_vector_index_search_tests.rs/expected.html" class="content-link">View Expected Output</a></li>
                    <li><a href="../../content/openai_o3/qdrant_lib_segment_tests_integration_sparse_vector_index_search_tests.rs/actual.html" class="content-link">View Actual Output</a></li>
                </ul>
            </div>
            
            <div class="diff-section">
                <h2>Diff (Expected vs Actual)</h2>
                <div id="diff-output">
                    <pre class="diff"><div class="diff-header">--- qdrant_lib_segment_tests_integration_sparse_vector_index_search_tests.rs_expectedoutput.txt (expected)+++ qdrant_lib_segment_tests_integration_sparse_vector_index_search_tests.rs_extracted.txt (actual)@@ -7,8 +7,8 @@ use common::types::{PointOffsetType, TelemetryDetail};</div><div> use io::storage_version::VERSION_FILE;</div><div> use itertools::Itertools;</div><div class="diff-added">+use rand::rngs::StdRng;</div><div> use rand::SeedableRng;</div><div class="diff-removed">-use rand::rngs::StdRng;</div><div> use segment::common::operation_error::OperationResult;</div><div> use segment::data_types::named_vectors::NamedVectors;</div><div> use segment::data_types::vectors::{QueryVector, VectorInternal};</div><div class="diff-info">@@ -35,10 +35,10 @@ use sparse::common::sparse_vector::SparseVector;</div><div> use sparse::common::sparse_vector_fixture::{random_full_sparse_vector, random_sparse_vector};</div><div> use sparse::common::types::DimId;</div><div class="diff-removed">-use sparse::index::inverted_index::InvertedIndex;</div><div> use sparse::index::inverted_index::inverted_index_compressed_immutable_ram::InvertedIndexCompressedImmutableRam;</div><div> use sparse::index::inverted_index::inverted_index_compressed_mmap::InvertedIndexCompressedMmap;</div><div> use sparse::index::inverted_index::inverted_index_ram::InvertedIndexRam;</div><div class="diff-added">+use sparse::index::inverted_index::InvertedIndex;</div><div> use sparse::index::posting_list_common::PostingListIter as _;</div><div> use tempfile::Builder;</div><div> </div><div class="diff-info">@@ -63,13 +63,14 @@ </div><div>     let data_dir = Builder::new().prefix("data_dir").tempdir().unwrap();</div><div> </div><div class="diff-removed">-    let sparse_vector_index = fixture_sparse_index::<InvertedIndexCompressedImmutableRam<f32>, _>(</div><div class="diff-removed">-        &mut rnd,</div><div class="diff-removed">-        NUM_VECTORS,</div><div class="diff-removed">-        MAX_SPARSE_DIM,</div><div class="diff-removed">-        full_scan_threshold,</div><div class="diff-removed">-        data_dir.path(),</div><div class="diff-removed">-    );</div><div class="diff-added">+    let sparse_vector_index =</div><div class="diff-added">+        fixture_sparse_index::<InvertedIndexCompressedImmutableRam<f32>, _>(</div><div class="diff-added">+            &mut rnd,</div><div class="diff-added">+            NUM_VECTORS,</div><div class="diff-added">+            MAX_SPARSE_DIM,</div><div class="diff-added">+            full_scan_threshold,</div><div class="diff-added">+            data_dir.path(),</div><div class="diff-added">+        );</div><div> </div><div>     // random query vectors</div><div>     let attempts = 1000;</div><div class="diff-info">@@ -132,18 +133,6 @@             }</div><div>         }</div><div>     }</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-#[test]</div><div class="diff-removed">-fn sparse_vector_index_ram_filter_search() {</div><div class="diff-removed">-    // very low full scan threshold to force usage of inverted index</div><div class="diff-removed">-    compare_sparse_vectors_search_with_without_filter(LOW_FULL_SCAN_THRESHOLD);</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-#[test]</div><div class="diff-removed">-fn sparse_vector_index_fallback_plain_search() {</div><div class="diff-removed">-    // very high full scan threshold to force fallback to plain search</div><div class="diff-removed">-    compare_sparse_vectors_search_with_without_filter(NUM_VECTORS + 1);</div><div> }</div><div> </div><div> /// Checks that the sparse vector index is consistent with the underlying storage</div><div class="diff-info">@@ -212,7 +201,6 @@     check_index_storage_consistency(&sparse_vector_ram_index);</div><div> </div><div>     let mmap_index_dir = Builder::new().prefix("mmap_index_dir").tempdir().unwrap();</div><div class="diff-removed">-</div><div>     // create mmap sparse vector index</div><div>     let mut sparse_index_config = sparse_vector_ram_index.config();</div><div>     sparse_index_config.index_type = SparseIndexType::Mmap;</div><div class="diff-info">@@ -266,13 +254,14 @@ #[test]</div><div> fn sparse_vector_index_load_missing_mmap() {</div><div>     let data_dir = Builder::new().prefix("data_dir").tempdir().unwrap();</div><div class="diff-removed">-    let sparse_vector_index: OperationResult<SparseVectorIndex<InvertedIndexCompressedMmap<f32>>> =</div><div class="diff-removed">-        fixture_sparse_index_from_iter(</div><div class="diff-removed">-            data_dir.path(),</div><div class="diff-removed">-            [].iter().cloned(),</div><div class="diff-removed">-            10_000,</div><div class="diff-removed">-            SparseIndexType::Mmap,</div><div class="diff-removed">-        );</div><div class="diff-added">+    let sparse_vector_index: OperationResult<</div><div class="diff-added">+        SparseVectorIndex<InvertedIndexCompressedMmap<f32>>,</div><div class="diff-added">+    > = fixture_sparse_index_from_iter(</div><div class="diff-added">+        data_dir.path(),</div><div class="diff-added">+        [].iter().cloned(),</div><div class="diff-added">+        10_000,</div><div class="diff-added">+        SparseIndexType::Mmap,</div><div class="diff-added">+    );</div><div>     // absent configuration file for mmap are ignored</div><div>     // a new index is created</div><div>     assert!(sparse_vector_index.is_ok())</div><div class="diff-info">@@ -359,6 +348,8 @@ #[test]</div><div> fn sparse_vector_index_ram_filtered_search() {</div><div>     let mut rnd = StdRng::seed_from_u64(42);</div><div class="diff-added">+    let field_name = "field";</div><div class="diff-added">+    let field_value = "important value";</div><div> </div><div>     let data_dir = Builder::new().prefix("data_dir").tempdir().unwrap();</div><div> </div><div class="diff-info">@@ -372,8 +363,6 @@     );</div><div> </div><div>     // query index by payload</div><div class="diff-removed">-    let field_name = "field";</div><div class="diff-removed">-    let field_value = "important value";</div><div>     let filter = Filter::new_must(Condition::Field(FieldCondition::new_match(</div><div>         JsonPath::new(field_name),</div><div>         field_value.to_owned().into(),</div><div class="diff-info">@@ -382,13 +371,7 @@     // query all sparse dimension to get all points</div><div>     let query_vector: QueryVector = random_full_sparse_vector(&mut rnd, MAX_SPARSE_DIM).into();</div><div>     let before_result = sparse_vector_index</div><div class="diff-removed">-        .search(</div><div class="diff-removed">-            &[&query_vector],</div><div class="diff-removed">-            Some(&filter),</div><div class="diff-removed">-            10,</div><div class="diff-removed">-            None,</div><div class="diff-removed">-            &Default::default(),</div><div class="diff-removed">-        )</div><div class="diff-added">+        .search(&[&query_vector], Some(&filter), 10, None, &Default::default())</div><div>         .unwrap();</div><div>     assert_eq!(before_result.len(), 1);</div><div>     assert_eq!(before_result[0].len(), 0);</div><div class="diff-info">@@ -418,7 +401,6 @@     // add payload on the first half of the points</div><div>     let half_indexed_count = sparse_vector_index.indexed_vector_count() / 2;</div><div>     let payload = payload_json! {field_name: field_value};</div><div class="diff-removed">-    let hw_counter = HardwareCounterCell::new();</div><div>     let mut payload_index = sparse_vector_index.payload_index().borrow_mut();</div><div>     for idx in 0..half_indexed_count {</div><div>         payload_index</div><div class="diff-info">@@ -475,13 +457,7 @@ </div><div>     // empty when searching payload index directly</div><div>     let before_plain_results = sparse_vector_index</div><div class="diff-removed">-        .search(</div><div class="diff-removed">-            &[&query_vector],</div><div class="diff-removed">-            Some(&filter),</div><div class="diff-removed">-            10,</div><div class="diff-removed">-            None,</div><div class="diff-removed">-            &Default::default(),</div><div class="diff-removed">-        )</div><div class="diff-added">+        .search(&[&query_vector], Some(&filter), 10, None, &Default::default())</div><div>         .unwrap();</div><div> </div><div>     assert_eq!(before_plain_results.len(), 1);</div><div class="diff-info">@@ -624,6 +600,7 @@             None,</div><div>             top,</div><div>             None,</div><div class="diff-added">+            &stopped,</div><div>         )</div><div>         .unwrap();</div><div> </div><div class="diff-info">@@ -632,26 +609,8 @@     let path = segment.current_path.clone();</div><div>     drop(segment);</div><div> </div><div class="diff-removed">-    // persistence using rebuild of inverted index</div><div class="diff-removed">-    // for appendable segment vector index has to be rebuilt</div><div class="diff-removed">-    let segment = load_segment(&path, &stopped).unwrap().unwrap();</div><div class="diff-removed">-    let search_after_reload_result = segment</div><div class="diff-removed">-        .search(</div><div class="diff-removed">-            SPARSE_VECTOR_NAME,</div><div class="diff-removed">-            &query_vector,</div><div class="diff-removed">-            &Default::default(),</div><div class="diff-removed">-            &Default::default(),</div><div class="diff-removed">-            None,</div><div class="diff-removed">-            top,</div><div class="diff-removed">-            None,</div><div class="diff-removed">-        )</div><div class="diff-removed">-        .unwrap();</div><div class="diff-removed">-</div><div class="diff-removed">-    assert_eq!(search_after_reload_result.len(), top);</div><div class="diff-removed">-    assert_eq!(search_result, search_after_reload_result);</div><div class="diff-removed">-</div><div>     fixture_for_all_indices!(check_persistence::<_>(</div><div class="diff-removed">-        &segment,</div><div class="diff-added">+        &load_segment(&path, &stopped).unwrap().unwrap(),</div><div>         &search_result,</div><div>         &query_vector,</div><div>         top</div><div></div></pre>
                </div>
            </div>
        </section>
    </main>
    <footer>
        <p>LoCoDiff-bench - <a href="https://github.com/AbanteAI/LoCoDiff-bench">GitHub Repository</a></p>
    </footer>
</body>
</html>
    