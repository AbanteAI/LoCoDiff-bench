<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case: lib/collection/src/collection_manager/optimizers/segment_optimizer.rs - Gemini 2.5 Flash</title>
    <link rel="stylesheet" href="../../styles.css">
</head>
<body>
    <header>
        <h1>Case: lib/collection/src/collection_manager/optimizers/segment_optimizer.rs</h1>
        <h2>Model: Gemini 2.5 Flash</h2>
        <p><a href="../../models/google_gemini-2.5-flash-preview.html">All Gemini 2.5 Flash Cases</a> | <a href="../../cases.html">All Cases</a> | <a href="../../index.html">Home</a></p>
    </header>
    <main>
        <section class="case-details">
            <div class="case-info">
                <h2>Benchmark Case Information</h2>
                <p><strong>Model:</strong> Gemini 2.5 Flash</p>
                <p><strong>Status:</strong> <span class="failure">Failure</span></p>
                <p><strong>Prompt Tokens:</strong> 56534</p>
                <p><strong>Native Prompt Tokens:</strong> 71693</p>
                <p><strong>Native Completion Tokens:</strong> 7389</p>
                <p><strong>Native Tokens Reasoning:</strong> 0</p>
                <p><strong>Native Finish Reason:</strong> STOP</p>
                <p><strong>Cost:</strong> $0.01518735</p>
            </div>
            
            <div class="content-links">
                <h2>View Content</h2>
                <ul>
                    <li><a href="../../content/google_gemini-2.5-flash-preview/qdrant_lib_collection_src_collection_manager_optimizers_segment_optimizer.rs/prompt.html" class="content-link">View Prompt</a></li>
                    <li><a href="../../content/google_gemini-2.5-flash-preview/qdrant_lib_collection_src_collection_manager_optimizers_segment_optimizer.rs/expected.html" class="content-link">View Expected Output</a></li>
                    <li><a href="../../content/google_gemini-2.5-flash-preview/qdrant_lib_collection_src_collection_manager_optimizers_segment_optimizer.rs/actual.html" class="content-link">View Actual Output</a></li>
                </ul>
            </div>
            
            <div class="diff-section">
                <h2>Diff (Expected vs Actual)</h2>
                <div id="diff-output">
                    <pre class="diff"><div></div><div>index a458d559..ad46665c 100644</div><div class="diff-header">--- a/qdrant_lib_collection_src_collection_manager_optimizers_segment_optimizer.rs_expectedoutput.txt (expected):tmp/tmpkyyocfzs_expected.txt	</div><div class="diff-header">+++ b/qdrant_lib_collection_src_collection_manager_optimizers_segment_optimizer.rs_extracted.txt (actual):tmp/tmp0e5ilgpm_actual.txt	</div><div class="diff-info">@@ -26,7 +26,6 @@ use crate::collection_manager::holders::segment_holder::{</div><div>     LockedSegment, LockedSegmentHolder, SegmentId,</div><div> };</div><div> use crate::config::CollectionParams;</div><div class="diff-removed">-use crate::operations::config_diff::DiffConfig;</div><div> use crate::operations::types::{CollectionError, CollectionResult};</div><div> </div><div> const BYTES_IN_KB: usize = 1024;</div><div class="diff-info">@@ -248,7 +247,7 @@ pub trait SegmentOptimizer {</div><div> </div><div>                 match config_on_disk {</div><div>                     Some(true) => config.storage_type = VectorStorageType::Mmap, // Both agree, but prefer mmap storage type</div><div class="diff-removed">-                    Some(false) => {} // on_disk=false wins, do nothing</div><div class="diff-added">+                    Some(false) => {}</div><div>                     None => config.storage_type = VectorStorageType::Mmap, // Mmap threshold wins</div><div>                 }</div><div> </div><div class="diff-info">@@ -256,7 +255,9 @@ pub trait SegmentOptimizer {</div><div>                 // that doesn't match, warn about it</div><div>                 if let Some(config_on_disk) = config_on_disk {</div><div>                     if config_on_disk != config.storage_type.is_on_disk() {</div><div class="diff-removed">-                        log::warn!("Collection config for vector {vector_name} has on_disk={config_on_disk:?} configured, but storage type for segment doesn't match it");</div><div class="diff-added">+                        log::warn!(</div><div class="diff-added">+                            "Collection config for vector {vector_name} has on_disk={config_on_disk:?} configured, but storage type for segment doesn't match it"</div><div class="diff-added">+                        );</div><div>                     }</div><div>                 }</div><div>             });</div><div class="diff-info">@@ -341,12 +342,7 @@ pub trait SegmentOptimizer {</div><div> </div><div>     /// Checks if optimization cancellation is requested.</div><div>     fn check_cancellation(&self, stopped: &AtomicBool) -> CollectionResult<()> {</div><div class="diff-removed">-        if stopped.load(Ordering::Relaxed) {</div><div class="diff-removed">-            return Err(CollectionError::Cancelled {</div><div class="diff-removed">-                description: "optimization cancelled by service".to_string(),</div><div class="diff-removed">-            });</div><div class="diff-removed">-        }</div><div class="diff-removed">-        Ok(())</div><div class="diff-added">+        check_process_stopped(stopped).map_err(CollectionError::from)</div><div>     }</div><div> </div><div>     /// Unwraps proxy, adds temp segment into collection and returns a `Cancelled` error.</div><div class="diff-info">@@ -441,20 +437,15 @@ pub trait SegmentOptimizer {</div><div>             segment_builder.update(</div><div>                 &segment_guards.iter().map(Deref::deref).collect_vec(),</div><div>                 stopped,</div><div class="diff-added">+                hw_counter,</div><div>             )?;</div><div>         }</div><div> </div><div class="diff-removed">-        // Apply index changes to segment builder</div><div class="diff-removed">-        // Indexes are only used for defragmentation in segment builder, so versions are ignored</div><div class="diff-removed">-        for (field_name, change) in proxy_changed_indexes.read().iter_unordered() {</div><div class="diff-removed">-            match change {</div><div class="diff-removed">-                ProxyIndexChange::Create(schema, _) => {</div><div class="diff-removed">-                    segment_builder.add_indexed_field(field_name.to_owned(), schema.to_owned());</div><div class="diff-removed">-                }</div><div class="diff-removed">-                ProxyIndexChange::Delete(_) => {</div><div class="diff-removed">-                    segment_builder.remove_indexed_field(field_name);</div><div class="diff-removed">-                }</div><div class="diff-removed">-            }</div><div class="diff-added">+        for field in proxy_changed_indexes.read().get_deleted().iter() {</div><div class="diff-added">+            segment_builder.remove_indexed_field(field);</div><div class="diff-added">+        }</div><div class="diff-added">+        for (field, schema_type) in proxy_changed_indexes.read().get_created().iter() {</div><div class="diff-added">+            segment_builder.add_indexed_field(field.to_owned(), schema_type.to_owned());</div><div>         }</div><div> </div><div>         // 000 - acquired</div><div class="diff-info">@@ -505,21 +496,13 @@ pub trait SegmentOptimizer {</div><div>         let mut optimized_segment: Segment =</div><div>             segment_builder.build(indexing_permit, stopped, hw_counter)?;</div><div> </div><div class="diff-removed">-        // Delete points</div><div class="diff-removed">-        let deleted_points_snapshot = proxy_deleted_points</div><div class="diff-removed">-            .read()</div><div class="diff-removed">-            .iter()</div><div class="diff-removed">-            .map(|(point_id, versions)| (*point_id, *versions))</div><div class="diff-removed">-            .collect::<Vec<_>>();</div><div class="diff-removed">-</div><div>         // Apply index changes before point deletions</div><div>         // Point deletions bump the segment version, can cause index changes to be ignored</div><div>         let old_optimized_segment_version = optimized_segment.version();</div><div>         for (field_name, change) in proxy_changed_indexes.read().iter_ordered() {</div><div class="diff-removed">-            debug_assert!(</div><div class="diff-removed">-                change.version() >= old_optimized_segment_version,</div><div class="diff-removed">-                "proxied index change should have newer version than segment",</div><div class="diff-removed">-            );</div><div class="diff-added">+            // Warn: change version might be lower than the segment version,</div><div class="diff-added">+            // because we might already applied the change earlier in optimization.</div><div class="diff-added">+            // Applied optimizations are not removed from `proxy_index_changes`.</div><div>             match change {</div><div>                 ProxyIndexChange::Create(schema, version) => {</div><div>                     optimized_segment.create_field_index(</div><div class="diff-info">@@ -536,6 +519,12 @@ pub trait SegmentOptimizer {</div><div>             self.check_cancellation(stopped)?;</div><div>         }</div><div> </div><div class="diff-added">+        // Delete points</div><div class="diff-added">+        let deleted_points_snapshot = proxy_deleted_points</div><div class="diff-added">+            .read()</div><div class="diff-added">+            .iter()</div><div class="diff-added">+            .map(|(point_id, versions)| (*point_id, *versions))</div><div class="diff-added">+            .collect::<Vec<_>>();</div><div>         for (point_id, versions) in deleted_points_snapshot {</div><div>             optimized_segment</div><div>                 .delete_point(versions.operation_version, point_id, hw_counter)</div><div class="diff-info">@@ -555,11 +544,6 @@ pub trait SegmentOptimizer {</div><div>     /// * `ids` - list of segment ids to perform optimization on. All segments will be merged into single one</div><div>     /// * `stopped` - flag for early stopping of the optimization. If appears to be `true` - optimization process should be cancelled, all segments unwrapped.</div><div>     ///</div><div class="diff-removed">-    /// # Result</div><div class="diff-removed">-    ///</div><div class="diff-removed">-    /// New optimized segment should be added into `segments`.</div><div class="diff-removed">-    /// If there were any record changes during the optimization - an additional plain segment will be created.</div><div class="diff-removed">-    ///</div><div>     /// Returns id of the created optimized segment. If no optimization was done - returns None</div><div>     fn optimize(</div><div>         &self,</div><div class="diff-info">@@ -590,6 +574,7 @@ pub trait SegmentOptimizer {</div><div>             .collect();</div><div> </div><div>         // Check if all segments are not under other optimization or some ids are missing</div><div class="diff-added">+        // If there is a proxy, it means the segment is already included in some optimization</div><div>         let all_segments_ok = optimizing_segments.len() == ids.len()</div><div>             && optimizing_segments</div><div>                 .iter()</div><div class="diff-info">@@ -602,13 +587,12 @@ pub trait SegmentOptimizer {</div><div> </div><div>         check_process_stopped(stopped)?;</div><div> </div><div class="diff-removed">-        let hw_counter = HardwareCounterCell::disposable(); // Internal operation, no measurement needed!</div><div class="diff-removed">-</div><div>         let tmp_segment = self.temp_segment(false)?;</div><div>         let proxy_deleted_points = proxy_segment::LockedRmSet::default();</div><div>         let proxy_index_changes = proxy_segment::LockedIndexChanges::default();</div><div> </div><div>         let mut proxies = Vec::new();</div><div class="diff-added">+        let hw_counter = HardwareCounterCell::disposable(); // Internal operation, no measurement needed!</div><div>         for sg in optimizing_segments.iter() {</div><div>             let mut proxy = ProxySegment::new(</div><div>                 sg.clone(),</div><div class="diff-info">@@ -676,14 +660,7 @@ pub trait SegmentOptimizer {</div><div>         // Avoid unnecessary point removing in the critical section:</div><div>         // - save already removed points while avoiding long read locks</div><div>         // - exclude already removed points from post-optimization removing</div><div class="diff-removed">-        let already_remove_points = {</div><div class="diff-removed">-            let mut all_removed_points: HashSet<_> =</div><div class="diff-removed">-                proxy_deleted_points.read().keys().copied().collect();</div><div class="diff-removed">-            for existing_point in optimized_segment.iter_points() {</div><div class="diff-removed">-                all_removed_points.remove(&existing_point);</div><div class="diff-removed">-            }</div><div class="diff-removed">-            all_removed_points</div><div class="diff-removed">-        };</div><div class="diff-added">+        let already_remove_points: HashSet<_> = proxy_deleted_points.read().keys().copied().collect();</div><div> </div><div>         // ---- SLOW PART ENDS HERE -----</div><div> </div><div class="diff-info">@@ -695,6 +672,7 @@ pub trait SegmentOptimizer {</div><div>         {</div><div>             // This block locks all operations with collection. It should be fast</div><div>             let mut write_segments_guard = segments.write();</div><div class="diff-added">+            let old_optimized_segment_version = optimized_segment.version();</div><div> </div><div>             // Apply index changes before point deletions</div><div>             // Point deletions bump the segment version, can cause index changes to be ignored</div><div class="diff-info">@@ -773,10 +751,10 @@ pub trait SegmentOptimizer {</div><div>                 }</div><div>                 tmp_segment.drop_data()?;</div><div>             }</div><div class="diff-added">+        }</div><div> </div><div class="diff-removed">-            timer.set_success(true);</div><div class="diff-added">+        timer.set_success(true);</div><div> </div><div class="diff-removed">-            Ok(point_count)</div><div class="diff-removed">-        }</div><div class="diff-added">+        Ok(point_count)</div><div>     }</div><div> }</div><div>\ No newline at end of file</div><div></div></pre>
                </div>
            </div>
        </section>
    </main>
    <footer>
        <p>LoCoDiff-bench - <a href="https://github.com/AbanteAI/LoCoDiff-bench">GitHub Repository</a></p>
    </footer>
</body>
</html>
    