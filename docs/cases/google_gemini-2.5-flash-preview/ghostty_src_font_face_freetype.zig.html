<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case: src/font/face/freetype.zig - Gemini 2.5 Flash</title>
    <link rel="stylesheet" href="../../styles.css">
</head>
<body>
    <header>
        <h1>Case: src/font/face/freetype.zig</h1>
        <p><a href="../../models/google_gemini-2.5-flash-preview.html">‚Üê Back to Gemini 2.5 Flash Cases</a> | <a href="../../index.html">Home</a></p>
    </header>
    <main>
        <section class="case-details">
            <div class="case-info">
                <h2>Benchmark Case Information</h2>
                <p><strong>Model:</strong> Gemini 2.5 Flash</p>
                <p><strong>Status:</strong> <span class="failure">Failure</span></p>
                <p><strong>Prompt Tokens:</strong> 57124</p>
                <p><strong>Output Tokens:</strong> N/A</p>
                <p><strong>Native Prompt Tokens:</strong> 69394</p>
                <p><strong>Native Completion Tokens:</strong> 11165</p>
                <p><strong>Native Tokens Reasoning:</strong> 103</p>
                <p><strong>Native Finish Reason:</strong> STOP</p>
                <p><strong>Cost:</strong> $0.0171081</p>
            </div>
            
            <div class="content-links">
                <h2>View Content</h2>
                <ul>
                    <li><a href="../../content/google_gemini-2.5-flash-preview/ghostty_src_font_face_freetype.zig/prompt.html" class="content-link">View Prompt</a></li>
                    <li><a href="../../content/google_gemini-2.5-flash-preview/ghostty_src_font_face_freetype.zig/expected.html" class="content-link">View Expected Output</a></li>
                    <li><a href="../../content/google_gemini-2.5-flash-preview/ghostty_src_font_face_freetype.zig/actual.html" class="content-link">View Actual Output</a></li>
                </ul>
            </div>
            
            <div class="diff-section">
                <h2>Diff (Expected vs Actual)</h2>
                <div id="diff-output">
                    <pre class="diff"><div></div><div>index 94dc6911..9a28e20e 100644</div><div class="diff-header">--- a/ghostty_src_font_face_freetype.zig_expectedoutput.txt (expected):tmp/tmp41g_tng4_expected.txt	</div><div class="diff-header">+++ b/ghostty_src_font_face_freetype.zig_extracted.txt (actual):tmp/tmpa8_63l62_actual.txt	</div><div class="diff-info">@@ -38,13 +38,16 @@ pub const Face = struct {</div><div>     /// Harfbuzz font corresponding to this face.</div><div>     hb_font: harfbuzz.Font,</div><div> </div><div class="diff-added">+    /// Metrics for this font face. These are useful for renderers.</div><div class="diff-added">+    metrics: font.Metrics,</div><div class="diff-added">+</div><div>     /// Freetype load flags for this font face.</div><div>     load_flags: font.face.FreetypeLoadFlags,</div><div> </div><div>     /// Set quirks.disableDefaultFontFeatures</div><div>     quirks_disable_default_font_features: bool = false,</div><div> </div><div class="diff-removed">-    /// Set to true to apply a synthetic italic to the face.</div><div class="diff-added">+    /// Synthetic styling modes.</div><div>     synthetic: packed struct {</div><div>         italic: bool = false,</div><div>         bold: bool = false,</div><div class="diff-info">@@ -52,10 +55,10 @@ pub const Face = struct {</div><div> </div><div>     /// The matrix applied to a regular font to create a synthetic italic.</div><div>     const italic_matrix: freetype.c.FT_Matrix = .{</div><div class="diff-removed">-        .xx = 0x10000,</div><div class="diff-added">+        .xx = 0x10000, // 1</div><div>         .xy = 0x044ED, // approx. tan(15)</div><div>         .yx = 0,</div><div class="diff-removed">-        .yy = 0x10000,</div><div class="diff-added">+        .yy = 0x10000, // 1</div><div>     };</div><div> </div><div>     /// Initialize a new font face with the given source in-memory.</div><div class="diff-info">@@ -83,6 +86,7 @@ pub const Face = struct {</div><div>             .lib = lib.lib,</div><div>             .face = face,</div><div>             .hb_font = hb_font,</div><div class="diff-added">+            .metrics = font.Metrics.calc(try getMetricsImpl(face)),</div><div>             .load_flags = opts.freetype_load_flags,</div><div>         };</div><div>         result.quirks_disable_default_font_features = quirks.disableDefaultFontFeatures(&result);</div><div class="diff-info">@@ -133,6 +137,9 @@ pub const Face = struct {</div><div>         for (0..count) |i| {</div><div>             const entry = self.face.getSfntName(i) catch continue;</div><div>             if (entry.name_id == freetype.c.TT_NAME_ID_FONT_FAMILY) {</div><div class="diff-added">+                // We don't have the allocator here, but we expect that name isn't allocated outside</div><div class="diff-added">+                // since we don't pass an allocator.</div><div class="diff-added">+                assert(entry.string.ptr != null);</div><div>                 return entry.string[0..entry.string_len];</div><div>             }</div><div>         }</div><div class="diff-info">@@ -182,6 +189,7 @@ pub const Face = struct {</div><div>     /// for clearing any glyph caches, font atlas data, etc.</div><div>     pub fn setSize(self: *Face, opts: font.face.Options) !void {</div><div>         try setSize_(self.face, opts.size);</div><div class="diff-added">+        self.metrics = font.Metrics.calc(try getMetricsImpl(self.face));</div><div>     }</div><div> </div><div>     fn setSize_(face: freetype.Face, size: font.face.DesiredSize) !void {</div><div class="diff-info">@@ -262,12 +270,6 @@ pub const Face = struct {</div><div>         return self.face.getCharIndex(cp);</div><div>     }</div><div> </div><div class="diff-removed">-    /// Returns true if this font is colored. This can be used by callers to</div><div class="diff-removed">-    /// determine what kind of atlas to pass in.</div><div class="diff-removed">-    pub fn hasColor(self: Face) bool {</div><div class="diff-removed">-        return self.face.hasColor();</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div>     /// Returns true if the given glyph ID is colorized.</div><div>     pub fn isColorGlyph(self: *const Face, glyph_id: u32) bool {</div><div>         // Load the glyph and see what pixel mode it renders with.</div><div class="diff-info">@@ -306,11 +308,16 @@ pub const Face = struct {</div><div> </div><div>         // If our glyph has color, we want to render the color</div><div>         try self.face.loadGlyph(glyph_index, .{</div><div class="diff-added">+            .render = !self.synthetic.bold,</div><div>             .color = self.face.hasColor(),</div><div> </div><div class="diff-removed">-            // If we have synthetic bold, we have to set some additional</div><div class="diff-removed">-            // glyph properties before render so we don't render here.</div><div class="diff-removed">-            .render = !self.synthetic.bold,</div><div class="diff-added">+            // Disable bitmap strikes for now since it causes issues with</div><div class="diff-added">+            // our cell metrics and rasterization. In the future, this is</div><div class="diff-added">+            // all fixable so we can enable it.</div><div class="diff-added">+            //</div><div class="diff-added">+            // This must be enabled for color faces though because those are</div><div class="diff-added">+            // often colored bitmaps, which we support.</div><div class="diff-added">+            .no_bitmap = !self.face.hasColor(),</div><div> </div><div>             // use options from config</div><div>             .no_hinting = !self.load_flags.hinting,</div><div class="diff-info">@@ -337,9 +344,10 @@ pub const Face = struct {</div><div>             try self.face.renderGlyph(.normal);</div><div>         }</div><div> </div><div class="diff-added">+        const bitmap_ft = glyph.*.bitmap;</div><div class="diff-added">+</div><div>         // This bitmap is blank. I've seen it happen in a font, I don't know why.</div><div>         // If it is empty, we just return a valid glyph struct that does nothing.</div><div class="diff-removed">-        const bitmap_ft = glyph.*.bitmap;</div><div>         if (bitmap_ft.rows == 0) return .{</div><div>             .width = 0,</div><div>             .height = 0,</div><div class="diff-info">@@ -363,20 +371,23 @@ pub const Face = struct {</div><div>                 @panic("unsupported pixel mode");</div><div>             },</div><div>         };</div><div class="diff-added">+        assert(atlas.format == format);</div><div> </div><div>         // If our atlas format doesn't match, look for conversions if possible.</div><div class="diff-removed">-        const bitmap_converted = if (format == null or atlas.format != format.?) blk: {</div><div class="diff-added">+        const bitmap_original = bitmap_ft;</div><div class="diff-added">+        const bitmap_converted: ?freetype.c.struct_FT_Bitmap_ = blk: {</div><div class="diff-added">+            if (format == null or atlas.format != format.?) break :blk null;</div><div class="diff-added">+</div><div>             const func = convert.map[bitmap_ft.pixel_mode].get(atlas.format) orelse {</div><div class="diff-removed">-                log.warn("glyph={} pixel mode={}", .{ glyph_index, bitmap_ft.pixel_mode });</div><div class="diff-added">+                log.debug("converting from pixel_mode={} to atlas_format={}", .{</div><div class="diff-added">+                    bitmap_ft.pixel_mode,</div><div class="diff-added">+                    atlas.format,</div><div class="diff-added">+                });</div><div>                 return error.UnsupportedPixelMode;</div><div>             };</div><div> </div><div class="diff-removed">-            log.debug("converting from pixel_mode={} to atlas_format={}", .{</div><div class="diff-removed">-                bitmap_ft.pixel_mode,</div><div class="diff-removed">-                atlas.format,</div><div class="diff-removed">-            });</div><div>             break :blk try func(alloc, bitmap_ft);</div><div class="diff-removed">-        } else null;</div><div class="diff-added">+        };</div><div>         defer if (bitmap_converted) |bm| {</div><div>             const len = @as(usize, @intCast(bm.pitch)) * @as(usize, @intCast(bm.rows));</div><div>             alloc.free(bm.buffer[0..len]);</div><div class="diff-info">@@ -389,7 +400,6 @@ pub const Face = struct {</div><div>         // the atlas and force resizes quite frequently. We pay some CPU cost</div><div>         // up front to resize the glyph to avoid significant CPU cost to resize</div><div>         // and copy the atlas.</div><div class="diff-removed">-        const bitmap_original = bitmap_converted orelse bitmap_ft;</div><div>         const bitmap_resized: ?freetype.c.struct_FT_Bitmap_ = resized: {</div><div>             const original_width = bitmap_original.width;</div><div>             const original_height = bitmap_original.rows;</div><div class="diff-info">@@ -446,7 +456,8 @@ pub const Face = struct {</div><div>             alloc.free(bm.buffer[0..len]);</div><div>         };</div><div> </div><div class="diff-removed">-        const bitmap = bitmap_resized orelse (bitmap_converted orelse bitmap_ft);</div><div class="diff-added">+</div><div class="diff-added">+        const bitmap = bitmap_resized orelse (bitmap_converted orelse bitmap_original);</div><div>         const tgt_w = bitmap.width;</div><div>         const tgt_h = bitmap.rows;</div><div> </div><div class="diff-info">@@ -462,7 +473,7 @@ pub const Face = struct {</div><div>             // Our ratio for the resize</div><div>             const ratio = ratio: {</div><div>                 const new: f64 = @floatFromInt(bm.rows);</div><div class="diff-removed">-                const old: f64 = @floatFromInt(bitmap_original.rows);</div><div class="diff-added">+                const old: f64 = @floatFromInt((bitmap_converted orelse bitmap_original).rows);</div><div>                 break :ratio new / old;</div><div>             };</div><div> </div><div class="diff-info">@@ -606,8 +617,13 @@ pub const Face = struct {</div><div> </div><div>     /// Get the `FaceMetrics` for this face.</div><div>     pub fn getMetrics(self: *Face) GetMetricsError!font.Metrics.FaceMetrics {</div><div class="diff-removed">-        const face = self.face;</div><div class="diff-added">+        return try getMetricsImpl(self.face);</div><div class="diff-added">+    }</div><div> </div><div class="diff-added">+    /// Calculate the opentype metrics associated with a face. This is not public</div><div class="diff-added">+    /// because these metrics are only meaningful when used to calculate the final</div><div class="diff-added">+    /// `font.Metrics` which is publicly accessable.</div><div class="diff-added">+    fn getMetricsImpl(face: freetype.Face) GetMetricsError!font.Metrics.FaceMetrics {</div><div>         const size_metrics = face.handle.*.size.*.metrics;</div><div> </div><div>         // This code relies on this assumption, and it should always be</div><div class="diff-info">@@ -715,6 +731,7 @@ pub const Face = struct {</div><div>         else</div><div>             @as(f64, @floatFromInt(post.underlineThickness)) * px_per_unit;</div><div> </div><div class="diff-added">+</div><div>         // Similar logic to the underline above.</div><div>         const strikethrough_position, const strikethrough_thickness = st: {</div><div>             const os2 = os2_ orelse break :st .{ null, null };</div><div class="diff-info">@@ -745,10 +762,7 @@ pub const Face = struct {</div><div>             var c: u8 = ' ';</div><div>             while (c < 127) : (c += 1) {</div><div>                 if (face.getCharIndex(c)) |glyph_index| {</div><div class="diff-removed">-                    if (face.loadGlyph(glyph_index, .{</div><div class="diff-removed">-                        .render = true,</div><div class="diff-removed">-                        .no_svg = true,</div><div class="diff-removed">-                    })) {</div><div class="diff-added">+                    if (face.loadGlyph(glyph_index, .{ .render = true, .no_svg = true })) {</div><div>                         max = @max(</div><div>                             f26dot6ToF64(face.handle.*.glyph.*.advance.x),</div><div>                             max,</div><div class="diff-info">@@ -781,10 +795,7 @@ pub const Face = struct {</div><div>             break :heights .{</div><div>                 cap: {</div><div>                     if (face.getCharIndex('H')) |glyph_index| {</div><div class="diff-removed">-                        if (face.loadGlyph(glyph_index, .{</div><div class="diff-removed">-                            .render = true,</div><div class="diff-removed">-                            .no_svg = true,</div><div class="diff-removed">-                        })) {</div><div class="diff-added">+                        if (face.loadGlyph(glyph_index, .{ .render = true, .no_svg = true })) {</div><div>                             break :cap f26dot6ToF64(face.handle.*.glyph.*.metrics.height);</div><div>                         } else |_| {}</div><div>                     }</div><div class="diff-info">@@ -792,10 +803,7 @@ pub const Face = struct {</div><div>                 },</div><div>                 ex: {</div><div>                     if (face.getCharIndex('x')) |glyph_index| {</div><div class="diff-removed">-                        if (face.loadGlyph(glyph_index, .{</div><div class="diff-removed">-                            .render = true,</div><div class="diff-removed">-                            .no_svg = true,</div><div class="diff-removed">-                        })) {</div><div class="diff-added">+                        if (face.loadGlyph(glyph_index, .{ .render = true, .no_svg = true })) {</div><div>                             break :ex f26dot6ToF64(face.handle.*.glyph.*.metrics.height);</div><div>                         } else |_| {}</div><div>                     }</div><div class="diff-info">@@ -903,7 +911,7 @@ test "color emoji" {</div><div> </div><div>     // Make sure this glyph has color</div><div>     {</div><div class="diff-removed">-        try testing.expect(ft_font.hasColor());</div><div class="diff-added">+        try testing.expect(ft_font.face.hasColor());</div><div>         const glyph_id = ft_font.glyphIndex('ü•∏').?;</div><div>         try testing.expect(ft_font.isColorGlyph(glyph_id));</div><div>     }</div><div></div></pre>
                </div>
            </div>
        </section>
    </main>
    <footer>
        <p>LoCoDiff-bench - <a href="https://github.com/AbanteAI/LoCoDiff-bench">GitHub Repository</a></p>
    </footer>
</body>
</html>
    