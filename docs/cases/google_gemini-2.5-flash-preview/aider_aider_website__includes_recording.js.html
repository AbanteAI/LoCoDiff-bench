<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case: aider/website/_includes/recording.js - Gemini 2.5 Flash</title>
    <link rel="stylesheet" href="../../styles.css">
</head>
<body>
    <header>
        <h1>Case: aider/website/_includes/recording.js</h1>
        <p><a href="../../models/google_gemini-2.5-flash-preview.html">‚Üê Back to Gemini 2.5 Flash Cases</a> | <a href="../../index.html">Home</a></p>
    </header>
    <main>
        <section class="case-details">
            <div class="case-info">
                <h2>Benchmark Case Information</h2>
                <p><strong>Model:</strong> Gemini 2.5 Flash</p>
                <p><strong>Status:</strong> <span class="failure">Failure</span></p>
                <p><strong>Prompt Tokens:</strong> 10768</p>
                <p><strong>Output Tokens:</strong> N/A</p>
                <p><strong>Native Prompt Tokens:</strong> 12881</p>
                <p><strong>Native Completion Tokens:</strong> 3598</p>
                <p><strong>Native Tokens Reasoning:</strong> 33</p>
                <p><strong>Native Finish Reason:</strong> STOP</p>
                <p><strong>Cost:</strong> $0.00409095</p>
            </div>
            
            <div class="content-links">
                <h2>View Content</h2>
                <ul>
                    <li><a href="../../content/google_gemini-2.5-flash-preview/aider_aider_website__includes_recording.js/prompt.html" class="content-link">View Prompt</a></li>
                    <li><a href="../../content/google_gemini-2.5-flash-preview/aider_aider_website__includes_recording.js/expected.html" class="content-link">View Expected Output</a></li>
                    <li><a href="../../content/google_gemini-2.5-flash-preview/aider_aider_website__includes_recording.js/actual.html" class="content-link">View Actual Output</a></li>
                </ul>
            </div>
            
            <div class="diff-section">
                <h2>Diff (Expected vs Actual)</h2>
                <div id="diff-output">
                    <pre class="diff"><div class="diff-header">--- aider_aider_website__includes_recording.js_expectedoutput.txt (expected)+++ aider_aider_website__includes_recording.js_extracted.txt (actual)@@ -42,387 +42,333 @@             const minutes = parseInt(match[1], 10);</div><div>             const seconds = parseInt(match[2], 10);</div><div>             const timeInSeconds = minutes * 60 + seconds;</div><div class="diff-removed">-            const formattedTime = `${minutes}:${seconds.toString().padStart(2, '0')}`;</div><div class="diff-added">++            const formattedTime = `${minutes}:${seconds.toString().padStart(2, '0')}`;</div><div>             const message = match[3].trim();</div><div>             </div><div class="diff-removed">-            // Create link for the timestamp</div><div class="diff-removed">-            const timeLink = document.createElement('a');</div><div class="diff-removed">-            timeLink.href = '#';</div><div class="diff-removed">-            timeLink.textContent = formattedTime;</div><div class="diff-removed">-            timeLink.className = 'timestamp-link';</div><div class="diff-removed">-            timeLink.dataset.time = timeInSeconds;</div><div class="diff-removed">-            timeLink.dataset.message = message;</div><div class="diff-removed">-            </div><div class="diff-removed">-            // Add click event to seek the player</div><div class="diff-removed">-            timeLink.addEventListener('click', function(e) {</div><div class="diff-removed">-              e.preventDefault();</div><div class="diff-removed">-              if (player && typeof player.seek === 'function') {</div><div class="diff-removed">-                player.seek(timeInSeconds);</div><div class="diff-removed">-                player.play();</div><div class="diff-removed">-                </div><div class="diff-removed">-                // Also trigger toast and speech</div><div class="diff-removed">-                showToast(message);</div><div class="diff-removed">-                speakText(message, timeInSeconds);</div><div class="diff-removed">-                </div><div class="diff-removed">-                // Highlight this timestamp</div><div class="diff-removed">-                highlightTimestamp(timeInSeconds);</div><div class="diff-removed">-              }</div><div class="diff-removed">-            });</div><div class="diff-removed">-            </div><div class="diff-removed">-            // Replace text with the link + message</div><div class="diff-removed">-            item.textContent = '';</div><div class="diff-removed">-            item.appendChild(timeLink);</div><div class="diff-removed">-            item.appendChild(document.createTextNode(' ' + message));</div><div class="diff-removed">-            </div><div class="diff-removed">-            // Add class and click handler to the entire list item</div><div class="diff-removed">-            item.classList.add('transcript-item');</div><div class="diff-removed">-            item.dataset.time = timeInSeconds;</div><div class="diff-removed">-            item.dataset.message = message;</div><div class="diff-removed">-            </div><div class="diff-removed">-            item.addEventListener('click', function(e) {</div><div class="diff-removed">-              // Prevent click event if the user clicked directly on the timestamp link</div><div class="diff-removed">-              // This prevents double-firing of the event</div><div class="diff-removed">-              if (e.target !== timeLink) {</div><div class="diff-removed">-                e.preventDefault();</div><div class="diff-removed">-                if (player && typeof player.seek === 'function') {</div><div class="diff-removed">-                  player.seek(timeInSeconds);</div><div class="diff-removed">-                  player.play();</div><div class="diff-removed">-                  </div><div class="diff-removed">-                  // Also trigger toast and speech</div><div class="diff-removed">-                  showToast(message);</div><div class="diff-removed">-                  speakText(message, timeInSeconds);</div><div class="diff-removed">-                  </div><div class="diff-removed">-                  // Highlight this timestamp</div><div class="diff-removed">-                  highlightTimestamp(timeInSeconds);</div><div class="diff-removed">-                }</div><div class="diff-removed">-              }</div><div class="diff-removed">-            });</div><div class="diff-removed">-            </div><div class="diff-removed">-            markers.push([timeInSeconds, message]);</div><div class="diff-removed">-          }</div><div class="diff-removed">-        });</div><div class="diff-removed">-        </div><div class="diff-removed">-        currentElement = currentElement.nextElementSibling;</div><div class="diff-removed">-      }</div><div class="diff-removed">-    }</div><div class="diff-removed">-    </div><div class="diff-removed">-    return markers;</div><div class="diff-removed">-  }</div><div class="diff-removed">-</div><div class="diff-removed">-  // Parse transcript and create markers</div><div class="diff-removed">-  const markers = parseTranscript();</div><div class="diff-removed">-  </div><div class="diff-removed">-  // Create player with a single call</div><div class="diff-removed">-  player = AsciinemaPlayer.create(</div><div class="diff-removed">-    recording_url,</div><div class="diff-removed">-    document.getElementById('demo'),</div><div class="diff-removed">-    {</div><div class="diff-removed">-      speed: 1.25,</div><div class="diff-removed">-      idleTimeLimit: 1,</div><div class="diff-removed">-      theme: "aider",</div><div class="diff-removed">-      poster: "npt:0:01",</div><div class="diff-removed">-      markers: markers,</div><div class="diff-removed">-      controls: true</div><div class="diff-removed">-    }</div><div class="diff-removed">-  );</div><div class="diff-removed">-  </div><div class="diff-removed">-  // Focus on the player element so keyboard shortcuts work immediately</div><div class="diff-removed">-  setTimeout(() => {</div><div class="diff-removed">-    // Use setTimeout to ensure the player is fully initialized</div><div class="diff-removed">-    if (player && typeof player.focus === 'function') {</div><div class="diff-removed">-      player.focus();</div><div class="diff-removed">-    } else {</div><div class="diff-removed">-      // If player doesn't have a focus method, try to find and focus the terminal element</div><div class="diff-removed">-      const playerElement = document.querySelector('.asciinema-terminal');</div><div class="diff-removed">-      if (playerElement) {</div><div class="diff-removed">-        playerElement.focus();</div><div class="diff-removed">-      } else {</div><div class="diff-removed">-        // Last resort - try to find element with tabindex</div><div class="diff-removed">-        const tabbableElement = document.querySelector('[tabindex]');</div><div class="diff-removed">-        if (tabbableElement) {</div><div class="diff-removed">-          tabbableElement.focus();</div><div class="diff-removed">-        }</div><div class="diff-removed">-      }</div><div class="diff-removed">-    }</div><div class="diff-removed">-  }, 100);</div><div class="diff-removed">-  </div><div class="diff-removed">-  // Track active toast elements</div><div class="diff-removed">-  let activeToast = null;</div><div class="diff-removed">-  </div><div class="diff-removed">-  // Function to display toast notification</div><div class="diff-removed">-  function showToast(text) {</div><div class="diff-removed">-    // Get the appropriate container based on fullscreen state</div><div class="diff-removed">-    let container = document.getElementById('toast-container');</div><div class="diff-removed">-    const isFullscreen = document.fullscreenElement || </div><div class="diff-removed">-                         document.webkitFullscreenElement || </div><div class="diff-removed">-                         document.mozFullScreenElement || </div><div class="diff-removed">-                         document.msFullscreenElement;</div><div class="diff-removed">-    </div><div class="diff-removed">-    // If in fullscreen, check if we need to create a fullscreen toast container</div><div class="diff-removed">-    if (isFullscreen) {</div><div class="diff-removed">-      // Target the fullscreen element as the container parent</div><div class="diff-removed">-      const fullscreenElement = document.fullscreenElement || </div><div class="diff-removed">-                               document.webkitFullscreenElement || </div><div class="diff-removed">-                               document.mozFullScreenElement || </div><div class="diff-removed">-                               document.msFullscreenElement;</div><div class="diff-removed">-      </div><div class="diff-removed">-      // Look for an existing fullscreen toast container</div><div class="diff-removed">-      let fsContainer = fullscreenElement.querySelector('.fs-toast-container');</div><div class="diff-removed">-      </div><div class="diff-removed">-      if (!fsContainer) {</div><div class="diff-removed">-        // Create a new container for fullscreen mode</div><div class="diff-removed">-        fsContainer = document.createElement('div');</div><div class="diff-removed">-        fsContainer.className = 'toast-container fs-toast-container';</div><div class="diff-removed">-        fsContainer.id = 'fs-toast-container';</div><div class="diff-removed">-        fullscreenElement.appendChild(fsContainer);</div><div class="diff-removed">-      }</div><div class="diff-removed">-      </div><div class="diff-removed">-      container = fsContainer;</div><div class="diff-removed">-    }</div><div class="diff-removed">-    </div><div class="diff-removed">-    // Remove any existing toast</div><div class="diff-removed">-    if (activeToast) {</div><div class="diff-removed">-      hideToast(activeToast);</div><div class="diff-removed">-    }</div><div class="diff-removed">-    </div><div class="diff-removed">-    // Create toast element</div><div class="diff-removed">-    const toast = document.createElement('div');</div><div class="diff-removed">-    toast.className = 'toast-notification';</div><div class="diff-removed">-    toast.textContent = text;</div><div class="diff-removed">-    </div><div class="diff-removed">-    // Add to container</div><div class="diff-removed">-    container.appendChild(toast);</div><div class="diff-removed">-    </div><div class="diff-removed">-    // Store reference to active toast</div><div class="diff-removed">-    activeToast = {</div><div class="diff-removed">-      element: toast,</div><div class="diff-removed">-      container: container</div><div class="diff-removed">-    };</div><div class="diff-removed">-    </div><div class="diff-removed">-    // Trigger animation</div><div class="diff-removed">-    setTimeout(() => {</div><div class="diff-removed">-      toast.style.opacity = '1';</div><div class="diff-removed">-    }, 10);</div><div class="diff-removed">-    </div><div class="diff-removed">-    return activeToast;</div><div class="diff-removed">-  }</div><div class="diff-removed">-  </div><div class="diff-removed">-  // Function to hide a toast</div><div class="diff-removed">-  function hideToast(toastInfo) {</div><div class="diff-removed">-    if (!toastInfo || !toastInfo.element) return;</div><div class="diff-removed">-    </div><div class="diff-removed">-    toastInfo.element.style.opacity = '0';</div><div class="diff-removed">-    setTimeout(() => {</div><div class="diff-removed">-      if (toastInfo.container && toastInfo.container.contains(toastInfo.element)) {</div><div class="diff-removed">-        toastInfo.container.removeChild(toastInfo.element);</div><div class="diff-removed">-      }</div><div class="diff-removed">-      </div><div class="diff-removed">-      // If this was the active toast, clear the reference</div><div class="diff-removed">-      if (activeToast === toastInfo) {</div><div class="diff-removed">-        activeToast = null;</div><div class="diff-removed">-      }</div><div class="diff-removed">-    }, 300); // Wait for fade out animation</div><div class="diff-removed">-  }</div><div class="diff-removed">-  </div><div class="diff-removed">-  // Track if TTS is currently in progress to prevent duplicates</div><div class="diff-removed">-  let ttsInProgress = false;</div><div class="diff-removed">-  let currentToast = null;</div><div class="diff-removed">-  </div><div class="diff-removed">-  // Improved browser TTS function</div><div class="diff-removed">-  function useBrowserTTS(text) {</div><div class="diff-removed">-    // Don't start new speech if already in progress</div><div class="diff-removed">-    if (ttsInProgress) {</div><div class="diff-removed">-      console.log('Speech synthesis already in progress, skipping');</div><div class="diff-removed">-      return false;</div><div class="diff-removed">-    }</div><div class="diff-removed">-    </div><div class="diff-removed">-    if ('speechSynthesis' in window) {</div><div class="diff-removed">-      console.log('Using browser TTS fallback');</div><div class="diff-removed">-      </div><div class="diff-removed">-      // Set flag to prevent duplicate speech</div><div class="diff-removed">-      ttsInProgress = true;</div><div class="diff-removed">-      </div><div class="diff-removed">-      // Cancel any ongoing speech</div><div class="diff-removed">-      window.speechSynthesis.cancel();</div><div class="diff-removed">-      </div><div class="diff-removed">-      const utterance = new SpeechSynthesisUtterance(text);</div><div class="diff-removed">-      utterance.rate = 1.0;</div><div class="diff-removed">-      utterance.pitch = 1.0;</div><div class="diff-removed">-      utterance.volume = 1.0;</div><div class="diff-removed">-      </div><div class="diff-removed">-      // For iOS, use a shorter utterance if possible</div><div class="diff-removed">-      if (/iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream) {</div><div class="diff-removed">-        utterance.text = text.length > 100 ? text.substring(0, 100) + '...' : text;</div><div class="diff-removed">-      }</div><div class="diff-removed">-      </div><div class="diff-removed">-      utterance.onstart = () => console.log('Speech started');</div><div class="diff-removed">-      utterance.onend = () => {</div><div class="diff-removed">-        console.log('Speech ended');</div><div class="diff-removed">-        ttsInProgress = false; // Reset flag when speech completes</div><div class="diff-removed">-        </div><div class="diff-removed">-        // Hide toast when speech ends</div><div class="diff-removed">-        if (currentToast) {</div><div class="diff-removed">-          hideToast(currentToast);</div><div class="diff-removed">-          currentToast = null;</div><div class="diff-removed">-        }</div><div class="diff-removed">-      };</div><div class="diff-removed">-      utterance.onerror = (e) => {</div><div class="diff-removed">-        console.warn('Speech error:', e);</div><div class="diff-removed">-        ttsInProgress = false; // Reset flag on error</div><div class="diff-removed">-        </div><div class="diff-removed">-        // Also hide toast on error</div><div class="diff-removed">-        if (currentToast) {</div><div class="diff-removed">-          hideToast(currentToast);</div><div class="diff-removed">-          currentToast = null;</div><div class="diff-removed">-        }</div><div class="diff-removed">-      };</div><div class="diff-removed">-      </div><div class="diff-removed">-      window.speechSynthesis.speak(utterance);</div><div class="diff-removed">-      return true;</div><div class="diff-removed">-    }</div><div class="diff-removed">-    console.warn('SpeechSynthesis not supported');</div><div class="diff-removed">-    return false;</div><div class="diff-removed">-  }</div><div class="diff-removed">-  </div><div class="diff-removed">-  // Function to play pre-generated TTS audio files</div><div class="diff-removed">-  function speakText(text, timeInSeconds) {</div><div class="diff-removed">-    // Show the toast and keep reference</div><div class="diff-removed">-    currentToast = showToast(text);</div><div class="diff-removed">-    </div><div class="diff-removed">-    // Format time for filename (MM-SS)</div><div class="diff-removed">-    const minutes = Math.floor(timeInSeconds / 60);</div><div class="diff-removed">-    const seconds = timeInSeconds % 60;</div><div class="diff-removed">-    const formattedTime = `${minutes.toString().padStart(2, '0')}-${seconds.toString().padStart(2, '0')}`;</div><div class="diff-removed">-    </div><div class="diff-removed">-    // Get recording_id from the page or use default from the URL</div><div class="diff-removed">-    const recordingId = typeof recording_id !== 'undefined' ? recording_id : </div><div class="diff-removed">-                       window.location.pathname.split('/').pop().replace('.html', '');</div><div class="diff-removed">-                       </div><div class="diff-removed">-    // Construct audio file path</div><div class="diff-removed">-    const audioPath = `/assets/audio/${recordingId}/${formattedTime}.mp3`;</div><div class="diff-removed">-    </div><div class="diff-removed">-    // Log for debugging</div><div class="diff-removed">-    console.log(`Attempting to play audio: ${audioPath}`);</div><div class="diff-removed">-    </div><div class="diff-removed">-    // Detect iOS</div><div class="diff-removed">-    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;</div><div class="diff-removed">-    console.log(`Device is iOS: ${isIOS}`);</div><div class="diff-removed">-    </div><div class="diff-removed">-    // Flag to track if we've already fallen back to TTS</div><div class="diff-removed">-    let fallenBackToTTS = false;</div><div class="diff-removed">-    </div><div class="diff-removed">-    try {</div><div class="diff-removed">-      // Create or reuse audio element</div><div class="diff-removed">-      if (!globalAudio) {</div><div class="diff-removed">-        globalAudio = new Audio();</div><div class="diff-removed">-        console.log("Created new global Audio element");</div><div class="diff-removed">-      }</div><div class="diff-removed">-      </div><div class="diff-removed">-      // Set up event handlers</div><div class="diff-removed">-      globalAudio.onended = () => {</div><div class="diff-removed">-        console.log('Audio playback ended');</div><div class="diff-removed">-        // Hide toast when audio ends</div><div class="diff-removed">-        if (currentToast) {</div><div class="diff-removed">-          hideToast(currentToast);</div><div class="diff-removed">-          currentToast = null;</div><div class="diff-removed">-        }</div><div class="diff-removed">-      };</div><div class="diff-removed">-      </div><div class="diff-removed">-      globalAudio.onerror = (e) => {</div><div class="diff-removed">-        console.warn(`Audio error: ${e.type}`, e);</div><div class="diff-removed">-        if (!fallenBackToTTS) {</div><div class="diff-removed">-          fallenBackToTTS = true;</div><div class="diff-removed">-          useBrowserTTS(text);</div><div class="diff-removed">-        } else if (currentToast) {</div><div class="diff-removed">-          // If we've already tried TTS and that failed too, hide the toast</div><div class="diff-removed">-          hideToast(currentToast);</div><div class="diff-removed">-          currentToast = null;</div><div class="diff-removed">-        }</div><div class="diff-removed">-      };</div><div class="diff-removed">-      </div><div class="diff-removed">-      // For iOS, preload might help with subsequent plays</div><div class="diff-removed">-      if (isIOS) {</div><div class="diff-removed">-        globalAudio.preload = "auto";</div><div class="diff-removed">-      }</div><div class="diff-removed">-      </div><div class="diff-removed">-      // Set the new source</div><div class="diff-removed">-      globalAudio.src = audioPath;</div><div class="diff-removed">-      </div><div class="diff-removed">-      // Play with proper error handling</div><div class="diff-removed">-      const playPromise = globalAudio.play();</div><div class="diff-removed">-      </div><div class="diff-removed">-      if (playPromise !== undefined) {</div><div class="diff-removed">-        playPromise.catch(error => {</div><div class="diff-removed">-          console.warn(`Play error: ${error.message}`);</div><div class="diff-removed">-          </div><div class="diff-removed">-          // On iOS, a user gesture might be required</div><div class="diff-removed">-          if (isIOS) {</div><div class="diff-removed">-            console.log("iOS playback failed, trying SpeechSynthesis");</div><div class="diff-removed">-          }</div><div class="diff-removed">-          </div><div class="diff-removed">-          if (!fallenBackToTTS) {</div><div class="diff-removed">-            fallenBackToTTS = true;</div><div class="diff-removed">-            useBrowserTTS(text);</div><div class="diff-removed">-          }</div><div class="diff-removed">-        });</div><div class="diff-removed">-      }</div><div class="diff-removed">-    } catch (e) {</div><div class="diff-removed">-      console.error(`Exception in audio playback: ${e.message}`);</div><div class="diff-removed">-      useBrowserTTS(text);</div><div class="diff-removed">-    }</div><div class="diff-removed">-  }</div><div class="diff-removed">-  </div><div class="diff-removed">-  // Function to highlight the active timestamp in the transcript</div><div class="diff-removed">-  function highlightTimestamp(timeInSeconds) {</div><div class="diff-removed">-    // Remove previous highlights</div><div class="diff-removed">-    document.querySelectorAll('.timestamp-active').forEach(el => {</div><div class="diff-removed">-      el.classList.remove('timestamp-active');</div><div class="diff-removed">-    });</div><div class="diff-removed">-    </div><div class="diff-removed">-    document.querySelectorAll('.active-marker').forEach(el => {</div><div class="diff-removed">-      el.classList.remove('active-marker');</div><div class="diff-removed">-    });</div><div class="diff-removed">-    </div><div class="diff-removed">-    // Find the timestamp link with matching time</div><div class="diff-removed">-    const timestampLinks = document.querySelectorAll('.timestamp-link');</div><div class="diff-removed">-    let activeLink = null;</div><div class="diff-removed">-    </div><div class="diff-removed">-    for (const link of timestampLinks) {</div><div class="diff-removed">-      if (parseInt(link.dataset.time) === timeInSeconds) {</div><div class="diff-removed">-        activeLink = link;</div><div class="diff-removed">-        break;</div><div class="diff-removed">-      }</div><div class="diff-removed">-    }</div><div class="diff-removed">-    </div><div class="diff-removed">-    if (activeLink) {</div><div class="diff-removed">-      // Add highlight class to the link</div><div class="diff-removed">-      activeLink.classList.add('timestamp-active');</div><div class="diff-removed">-      </div><div class="diff-removed">-      // Also highlight the parent list item</div><div class="diff-removed">-      const listItem = activeLink.closest('li');</div><div class="diff-removed">-      if (listItem) {</div><div class="diff-removed">-        listItem.classList.add('active-marker');</div><div class="diff-removed">-        </div><div class="diff-removed">-        // No longer scrolling into view to avoid shifting focus</div><div class="diff-removed">-      }</div><div class="diff-removed">-    }</div><div class="diff-removed">-  }</div><div class="diff-removed">-</div><div class="diff-removed">-  // Add event listener with safety checks</div><div class="diff-removed">-  if (player && typeof player.addEventListener === 'function') {</div><div class="diff-removed">-    player.addEventListener('marker', function(event) {</div><div class="diff-removed">-      try {</div><div class="diff-removed">-        const { index, time, label } = event;</div><div class="diff-removed">-        console.log(`marker! ${index} - ${time} - ${label}`);</div><div class="diff-removed">-        </div><div class="diff-removed">-        // Speak the marker label (toast is now shown within speakText)</div><div class="diff-removed">-        speakText(label, time);</div><div class="diff-removed">-        </div><div class="diff-removed">-        // Highlight the corresponding timestamp in the transcript</div><div class="diff-removed">-        highlightTimestamp(time);</div><div class="diff-removed">-      } catch (error) {</div><div class="diff-removed">-        console.error('Error in marker event handler:', error);</div><div class="diff-removed">-      }</div><div class="diff-removed">-    });</div><div class="diff-removed">-  }</div><div class="diff-removed">-});++            // Create link for the timestamp</div><div class="diff-added">++            const timeLink = document.createElement('a');</div><div class="diff-added">++            timeLink.href = '#';</div><div class="diff-added">++            timeLink.textContent = formattedTime;</div><div class="diff-added">++            timeLink.className = 'timestamp-link';</div><div class="diff-added">++            timeLink.dataset.time = timeInSeconds;</div><div class="diff-added">++            timeLink.dataset.message = message;</div><div class="diff-added">++            </div><div class="diff-added">++            // Add click event to seek the player</div><div class="diff-added">++            timeLink.addEventListener('click', function(e) {</div><div class="diff-added">++              e.preventDefault();</div><div class="diff-added">++              if (player && typeof player.seek === 'function') {</div><div class="diff-added">++                player.seek(timeInSeconds);</div><div class="diff-added">++                player.play();</div><div class="diff-added">++                </div><div class="diff-added">++                // Also trigger toast and speech</div><div class="diff-added">++                showToast(message);</div><div class="diff-added">++                speakText(message, timeInSeconds);</div><div class="diff-added">++                </div><div class="diff-added">++                // Highlight this timestamp</div><div class="diff-added">++                highlightTimestamp(timeInSeconds);</div><div class="diff-added">++              }</div><div class="diff-added">++            });</div><div class="diff-added">++            </div><div class="diff-added">++            // Replace text with the link + message</div><div class="diff-added">++            item.textContent = '';</div><div class="diff-added">++            item.appendChild(timeLink);</div><div class="diff-added">++            item.appendChild(document.createTextNode(' ' + message));</div><div class="diff-added">++            </div><div class="diff-added">++            // Add class and click handler to the entire list item</div><div class="diff-added">++            item.classList.add('transcript-item');</div><div class="diff-added">++            item.dataset.time = timeInSeconds;</div><div class="diff-added">++            item.dataset.message = message;</div><div class="diff-added">++            </div><div class="diff-added">++            item.addEventListener('click', function(e) {</div><div class="diff-added">++              // Prevent click event if the user clicked directly on the timestamp link</div><div class="diff-added">++              // This prevents double-firing of the event</div><div class="diff-added">++              if (e.target !== timeLink) {</div><div class="diff-added">++                e.preventDefault();</div><div class="diff-added">++                if (player && typeof player.seek === 'function') {</div><div class="diff-added">++                  player.seek(timeInSeconds);</div><div class="diff-added">++                  player.play();</div><div class="diff-added">++                  </div><div class="diff-added">++                  // Also trigger toast and speech</div><div class="diff-added">++                  showToast(message);</div><div class="diff-added">++                  speakText(message, timeInSeconds);</div><div class="diff-added">++                  </div><div class="diff-added">++                  // Highlight this timestamp</div><div class="diff-added">++                  highlightTimestamp(timeInSeconds);</div><div class="diff-added">++                }</div><div class="diff-added">++              }</div><div class="diff-added">++            });</div><div class="diff-added">++            </div><div class="diff-added">+             markers.push([timeInSeconds, message]);</div><div class="diff-added">+           }</div><div class="diff-added">+         });</div><div class="diff-added">+@@ -121,7 +145,8 @@</div><div class="diff-added">+       controls: true</div><div class="diff-added">+     }</div><div class="diff-added">+   );</div><div class="diff-added">+-  </div><div class="diff-added">++</div><div class="diff-added">+   // Focus on the player element so keyboard shortcuts work immediately</div><div class="diff-added">+   setTimeout(() => {</div><div class="diff-added">+     // Use setTimeout to ensure the player is fully initialized</div><div class="diff-added">+@@ -140,6 +165,9 @@</div><div class="diff-added">+     }</div><div class="diff-added">+   }, 100);</div><div class="diff-added">+   </div><div class="diff-added">++  // Track active toast elements</div><div class="diff-added">++  let activeToast = null;</div><div class="diff-added">++  </div><div class="diff-added">+   // Function to display toast notification</div><div class="diff-added">+   function showToast(text) {</div><div class="diff-added">+     // Get the appropriate container based on fullscreen state</div><div class="diff-added">+@@ -171,24 +199,40 @@</div><div class="diff-added">+       container = fsContainer;</div><div class="diff-added">+     }</div><div class="diff-added">+     </div><div class="diff-added">++    // Remove any existing toast</div><div class="diff-added">++    if (activeToast) {</div><div class="diff-added">++      hideToast(activeToast);</div><div class="diff-added">++    }</div><div class="diff-added">++    </div><div class="diff-added">+     // Create toast element</div><div class="diff-added">+     const toast = document.createElement('div');</div><div class="diff-added">+     toast.className = 'toast-notification';</div><div class="diff-added">+     toast.textContent = text;</div><div class="diff-added">+     </div><div class="diff-added">+     // Add to container</div><div class="diff-added">+-    container.appendChild(toast);</div><div class="diff-added">++    container.prepend(toast); // Use prepend to make sure new toasts appear on top</div><div class="diff-added">+     </div><div class="diff-added">++    // Store reference to active toast</div><div class="diff-added">++    activeToast = {</div><div class="diff-added">++      element: toast,</div><div class="diff-added">++      container: container</div><div class="diff-added">++    };</div><div class="diff-added">++    </div><div class="diff-added">+     // Trigger animation</div><div class="diff-added">+     setTimeout(() => {</div><div class="diff-added">+       toast.style.opacity = '1';</div><div class="diff-added">+     }, 10);</div><div class="diff-added">+     </div><div class="diff-added">+-    // Remove after 3 seconds</div><div class="diff-added">++    return activeToast;</div><div class="diff-added">++  }</div><div class="diff-added">++  </div><div class="diff-added">++  // Function to hide a toast</div><div class="diff-added">++  function hideToast(toastInfo) {</div><div class="diff-added">++    if (!toastInfo || !toastInfo.element) return;</div><div class="diff-added">++    </div><div class="diff-added">++    toastInfo.element.style.opacity = '0';</div><div class="diff-added">+     setTimeout(() => {</div><div class="diff-added">+-      toast.style.opacity = '0';</div><div class="diff-added">+-      setTimeout(() => {</div><div class="diff-added">+-        if (container && container.contains(toast)) {</div><div class="diff-added">++      if (toastInfo.container && toastInfo.container.contains(toastInfo.element)) {</div><div class="diff-added">+           container.removeChild(toast);</div><div class="diff-added">+         }</div><div class="diff-added">+       }, 300); // Wait for fade out animation</div><div class="diff-added">+@@ -196,11 +240,23 @@ document.addEventListener('DOMContentLoaded', function() {</div><div class="diff-added">+   }</div><div class="diff-added">+   </div><div class="diff-added">+   // Track if TTS is currently in progress to prevent duplicates</div><div class="diff-added">+-  let ttsInProgress = false;</div><div class="diff-added">++  let ttsInProgress = false; // Flag for browser TTS</div><div class="diff-added">+   let currentToast = null;</div><div class="diff-added">+   </div><div class="diff-added">++  // Track ongoing audio playback for pre-generated files</div><div class="diff-added">++  let audioPlaybackInProgress = false;</div><div class="diff-added">++</div><div class="diff-added">++    // Track if we've already fallen back to TTS for the current message</div><div class="diff-added">++  let fallenBackToTTS = false;</div><div class="diff-added">++</div><div class="diff-added">+   // Improved browser TTS function</div><div class="diff-added">+   function useBrowserTTS(text) {</div><div class="diff-added">++    // If audio is playing, stop it first</div><div class="diff-added">++    if (globalAudio && !globalAudio.paused) {</div><div class="diff-added">++      console.log('Stopping audio playback for browser TTS');</div><div class="diff-added">++      globalAudio.pause();</div><div class="diff-added">++    }</div><div class="diff-added">++</div><div class="diff-added">+     // Don't start new speech if already in progress</div><div class="diff-added">+     if (ttsInProgress) {</div><div class="diff-added">+       console.log('Speech synthesis already in progress, skipping');</div><div class="diff-added">+@@ -213,7 +269,7 @@ document.addEventListener('DOMContentLoaded', function() {</div><div class="diff-added">+       // Set flag to prevent duplicate speech</div><div class="diff-added">+       ttsInProgress = true;</div><div class="diff-added">+       </div><div class="diff-added">+-      // Cancel any ongoing speech</div><div class="diff-added">++      // Cancel any ongoing browser speech</div><div class="diff-added">+       window.speechSynthesis.cancel();</div><div class="diff-added">+       </div><div class="diff-added">+       const utterance = new SpeechSynthesisUtterance(text);</div><div class="diff-added">+@@ -225,10 +281,18 @@ document.addEventListener('DOMContentLoaded', function() {</div><div class="diff-added">+         utterance.text = text.length > 100 ? text.substring(0, 100) + '...' : text;</div><div class="diff-added">+       }</div><div class="diff-added">+       </div><div class="diff-added">+-      utterance.onstart = () => console.log('Speech started');</div><div class="diff-added">+-      utterance.onend = () => {</div><div class="diff-added">++      utterance.onstart = () => {</div><div class="diff-added">++        console.log('Speech started');</div><div class="diff-added">++        // Ensure toast is visible while speech is active</div><div class="diff-added">++        if (currentToast) {</div><div class="diff-added">++          currentToast.element.style.opacity = '1';</div><div class="diff-added">++        }</div><div class="diff-added">++      };</div><div class="diff-added">++      utterance.onend = () => {</div><div class="diff-added">+         console.log('Speech ended');</div><div class="diff-added">+         ttsInProgress = false; // Reset flag when speech completes</div><div class="diff-added">++        fallenBackToTTS = false; // Reset fallback flag</div><div class="diff-added">++</div><div class="diff-added">+         </div><div class="diff-added">+         // Hide toast when speech ends</div><div class="diff-added">+         if (currentToast) {</div><div class="diff-added">+@@ -239,6 +303,8 @@ document.addEventListener('DOMContentLoaded', function() {</div><div class="diff-added">+       utterance.onerror = (e) => {</div><div class="diff-added">+         console.warn('Speech error:', e);</div><div class="diff-added">+         ttsInProgress = false; // Reset flag on error</div><div class="diff-added">++        fallenBackToTTS = false; // Reset fallback flag</div><div class="diff-added">++</div><div class="diff-added">+         </div><div class="diff-added">+         // Also hide toast on error</div><div class="diff-added">+         if (currentToast) {</div><div class="diff-added">+@@ -253,6 +319,7 @@</div><div class="diff-added">+     }</div><div class="diff-added">+   }</div><div class="diff-added">+   </div><div class="diff-added">++</div><div class="diff-added">+   // Function to play pre-generated TTS audio files</div><div class="diff-added">+   function speakText(text, timeInSeconds) {</div><div class="diff-added">+     // Show the toast and keep reference</div><div class="diff-added">+@@ -263,9 +330,14 @@</div><div class="diff-added">+     const seconds = timeInSeconds % 60;</div><div class="diff-added">+     const formattedTime = `${minutes.toString().padStart(2, '0')}-${seconds.toString().padStart(2, '0')}`;</div><div class="diff-added">+     </div><div class="diff-added">++    // If browser TTS is in progress, cancel it</div><div class="diff-added">++    if (ttsInProgress) {</div><div class="diff-added">++      window.speechSynthesis.cancel();</div><div class="diff-added">++      ttsInProgress = false;</div><div class="diff-added">++    }</div><div class="diff-added">++</div><div class="diff-added">+     // Get recording_id from the page or use default from the URL</div><div class="diff-added">+     const recordingId = typeof recording_id !== 'undefined' ? recording_id :</div><div class="diff-added">+-                       window.location.pathname.split('/').pop().replace('.html', '');</div><div class="diff-added">++                        window.location.pathname.split('/').pop().replace('.html', '');</div><div class="diff-added">+                        </div><div class="diff-added">+     // Construct audio file path</div><div class="diff-added">+     const audioPath = `/assets/audio/${recordingId}/${formattedTime}.mp3`;</div><div class="diff-added">+@@ -274,9 +346,6 @@ document.addEventListener('DOMContentLoaded', function() {</div><div class="diff-added">+     console.log(`Attempting to play audio: ${audioPath}`);</div><div class="diff-added">+     </div><div class="diff-added">+     // Detect iOS</div><div class="diff-added">+-    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;</div><div class="diff-added">+-    console.log(`Device is iOS: ${isIOS}`);</div><div class="diff-added">+-    </div><div class="diff-added">+     // Flag to track if we've already fallen back to TTS</div><div class="diff-added">+     let fallenBackToTTS = false;</div><div class="diff-added">+     </div><div class="diff-added">+@@ -287,6 +356,17 @@ document.addEventListener('DOMContentLoaded', function() {</div><div class="diff-added">+         globalAudio = new Audio();</div><div class="diff-added">+         console.log("Created new global Audio element");</div><div class="diff-added">+       }</div><div class="diff-added">++      </div><div class="diff-added">++      // Check if the requested audio is already set as the source</div><div class="diff-added">++      // Skipping setting source can sometimes help on iOS.</div><div class="diff-added">++      if (globalAudio.src.endsWith(audioPath)) {</div><div class="diff-added">++          console.log(`Audio source is already ${audioPath}`);</div><div class="diff-added">++      } else {</div><div class="diff-added">++         // Set the new source</div><div class="diff-added">++         globalAudio.src = audioPath;</div><div class="diff-added">++         globalAudio.load(); // Explicitly load source, especially helpful for iOS</div><div class="diff-added">++         console.log(`Set audio source to ${audioPath}`);</div><div class="diff-added">++      }</div><div class="diff-added">+       </div><div class="diff-added">+       // Set up event handlers</div><div class="diff-added">+       globalAudio.onended = () => {</div><div class="diff-added">+@@ -299,30 +379,34 @@ document.addEventListener('DOMContentLoaded', function() {</div><div class="diff-added">+       };</div><div class="diff-added">+       </div><div class="diff-added">+       globalAudio.onerror = (e) => {</div><div class="diff-added">+-        console.warn(`Audio error: ${e.type}`, e);</div><div class="diff-added">+-        if (!fallenBackToTTS) {</div><div class="diff-added">++         console.warn(`Audio error: ${e.type} src: ${globalAudio.src}`, e);</div><div class="diff-added">++          if (!fallenBackToTTS) {</div><div class="diff-added">++            fallenBackToTTS = true;</div><div class="diff-added">++            useBrowserTTS(text);</div><div class="diff-added">++        } else { // If we've already tried TTS and that failed, hide the toast</div><div class="diff-added">++            console.log("Already fell back to TTS, hiding toast.");</div><div class="diff-added">++             if (currentToast) {</div><div class="diff-added">++                hideToast(currentToast);</div><div class="diff-added">++                currentToast = null;</div><div class="diff-added">++             }</div><div class="diff-added">++        }</div><div class="diff-added">++      };</div><div class="diff-added">++</div><div class="diff-added">++      // Play with proper error handling</div><div class="diff-added">++      const playPromise = globalAudio.play();</div><div class="diff-added">++      </div><div class="diff-added">++      if (playPromise !== undefined) {</div><div class="diff-added">++        playPromise.catch(error => {</div><div class="diff-added">++          console.warn(`Play error: ${error.message}`);</div><div class="diff-added">++          // Fall back to browser TTS if play() fails</div><div class="diff-added">++          if (!fallenBackToTTS) {</div><div class="diff-added">+             fallenBackToTTS = true;</div><div class="diff-added">+             useBrowserTTS(text);</div><div class="diff-added">+-        } else if (currentToast) {</div><div class="diff-added">+-          // If we've already tried TTS and that failed too, hide the toast</div><div class="diff-added">+-          hideToast(currentToast);</div><div class="diff-added">+-          currentToast = null;</div><div class="diff-added">++          } else { // If we've already tried TTS and that failed, hide the toast</div><div class="diff-added">++             console.log("Already fell back to TTS, hiding toast.");</div><div class="diff-added">++              if (currentToast) {</div><div class="diff-added">++                 hideToast(currentToast);</div><div class="diff-added">++                 currentToast = null;</div><div class="diff-added">++              }</div><div class="diff-added">++          }</div><div class="diff-added">+         }</div><div class="diff-added">+       };</div><div class="diff-added">+-      </div><div class="diff-added">+-      // For iOS, preload might help with subsequent plays</div><div class="diff-added">+-      if (isIOS) {</div><div class="diff-added">+-        globalAudio.preload = "auto";</div><div class="diff-added">+-      }</div><div class="diff-added">+-      </div><div class="diff-added">+-      // Set the new source</div><div class="diff-added">+-      globalAudio.src = audioPath;</div><div class="diff-added">+-      </div><div class="diff-added">+-      // Play with proper error handling</div><div class="diff-added">+-      const playPromise = globalAudio.play();</div><div class="diff-added">+-      </div><div class="diff-added">+-      if (playPromise !== undefined) {</div><div class="diff-added">+-        playPromise.catch(error => {</div><div class="diff-added">+-          console.warn(`Play error: ${error.message}`);</div><div class="diff-added">+-          </div><div class="diff-added">+-          // On iOS, a user gesture might be required</div><div class="diff-added">+-          if (isIOS) {</div><div class="diff-added">+-            console.log("iOS playback failed, trying SpeechSynthesis");</div><div class="diff-added">+-          }</div><div class="diff-added">+-          </div><div class="diff-added">+-          if (!fallenBackToTTS) {</div><div class="diff-added">+-            fallenBackToTTS = true;</div><div class="diff-added">+-            useBrowserTTS(text);</div><div class="diff-added">+-          } else { // If we've already tried TTS and that failed, hide the toast</div><div class="diff-added">+-             console.log("Already fell back to TTS, hiding toast.");</div><div class="diff-added">+-              if (currentToast) {</div><div class="diff-added">+-                 hideToast(currentToast);</div><div class="diff-added">+-                 currentToast = null;</div><div class="diff-added">+-              }</div><div class="diff-added">+-          }</div><div class="diff-added">+-        });</div><div class="diff-added">+-      }</div><div class="diff-added">+     } catch (e) {</div><div class="diff-added">+       console.error(`Exception in audio playback: ${e.message}`);</div><div class="diff-added">+       useBrowserTTS(text);</div><div class="diff-added">+@@ -362,9 +446,8 @@</div><div class="diff-added">+         const { index, time, label } = event;</div><div class="diff-added">+         console.log(`marker! ${index} - ${time} - ${label}`);</div><div class="diff-added">+         </div><div class="diff-added">+-        // Speak the marker label and show toast</div><div class="diff-added">++        // Speak the marker label (toast is now shown within speakText)</div><div class="diff-added">+         speakText(label, time);</div><div class="diff-added">+-        showToast(label);</div><div class="diff-added">+         </div><div class="diff-added">+         // Highlight the corresponding timestamp in the transcript</div><div class="diff-added">+         highlightTimestamp(time);</div></pre>
                </div>
            </div>
        </section>
    </main>
    <footer>
        <p>LoCoDiff-bench - <a href="https://github.com/AbanteAI/LoCoDiff-bench">GitHub Repository</a></p>
    </footer>
</body>
</html>
    