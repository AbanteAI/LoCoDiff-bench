<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case: src/font/face/coretext.zig - Gemini 2.5 Flash</title>
    <link rel="stylesheet" href="../../styles.css">
</head>
<body>
    <header>
        <h1>Case: src/font/face/coretext.zig</h1>
        <p><a href="../../models/google_gemini-2.5-flash-preview.html">← Back to Gemini 2.5 Flash Cases</a> | <a href="../../index.html">Home</a></p>
    </header>
    <main>
        <section class="case-details">
            <div class="case-info">
                <h2>Benchmark Case Information</h2>
                <p><strong>Model:</strong> Gemini 2.5 Flash</p>
                <p><strong>Status:</strong> <span class="failure">Failure</span></p>
                <p><strong>Prompt Tokens:</strong> 78070</p>
                <p><strong>Output Tokens:</strong> N/A</p>
                <p><strong>Native Prompt Tokens:</strong> 95357</p>
                <p><strong>Native Completion Tokens:</strong> 11997</p>
                <p><strong>Native Tokens Reasoning:</strong> 0</p>
                <p><strong>Native Finish Reason:</strong> STOP</p>
                <p><strong>Cost:</strong> $0.02150175</p>
            </div>
            
            <div class="content-links">
                <h2>View Content</h2>
                <ul>
                    <li><a href="../../content/google_gemini-2.5-flash-preview/ghostty_src_font_face_coretext.zig/prompt.html" class="content-link">View Prompt</a></li>
                    <li><a href="../../content/google_gemini-2.5-flash-preview/ghostty_src_font_face_coretext.zig/expected.html" class="content-link">View Expected Output</a></li>
                    <li><a href="../../content/google_gemini-2.5-flash-preview/ghostty_src_font_face_coretext.zig/actual.html" class="content-link">View Actual Output</a></li>
                </ul>
            </div>
            
            <div class="diff-section">
                <h2>Diff (Expected vs Actual)</h2>
                <div id="diff-output">
                    <pre class="diff"><div></div><div>index 1790a2e6..33d61258 100644</div><div class="diff-header">--- a/ghostty_src_font_face_coretext.zig_expectedoutput.txt (expected):tmp/tmppa2zardv_expected.txt	</div><div class="diff-header">+++ b/ghostty_src_font_face_coretext.zig_extracted.txt (actual):tmp/tmplhxgefl4_actual.txt	</div><div class="diff-info">@@ -6,7 +6,6 @@ const macos = @import("macos");</div><div> const harfbuzz = @import("harfbuzz");</div><div> const font = @import("../main.zig");</div><div> const opentype = @import("../opentype.zig");</div><div class="diff-removed">-const quirks = @import("../../quirks.zig");</div><div> </div><div> const log = std.log.scoped(.font_face);</div><div> </div><div class="diff-info">@@ -83,8 +82,6 @@ pub const Face = struct {</div><div>     /// Initialize a face with a CTFont. This will take ownership over</div><div>     /// the CTFont. This does NOT copy or retain the CTFont.</div><div>     pub fn initFont(ct_font: *macos.text.Font, opts: font.face.Options) !Face {</div><div class="diff-removed">-        const traits = ct_font.getSymbolicTraits();</div><div class="diff-removed">-</div><div>         var hb_font = if (comptime harfbuzz_shaper) font: {</div><div>             var hb_font = try harfbuzz.coretext.createFont(ct_font);</div><div>             hb_font.setScale(opts.size.pixels(), opts.size.pixels());</div><div class="diff-info">@@ -92,6 +89,8 @@ pub const Face = struct {</div><div>         } else {};</div><div>         errdefer if (comptime harfbuzz_shaper) hb_font.destroy();</div><div> </div><div class="diff-added">+        const traits = ct_font.getSymbolicTraits();</div><div class="diff-added">+</div><div>         const color: ?ColorState = if (traits.color_glyphs)</div><div>             try ColorState.init(ct_font)</div><div>         else</div><div class="diff-info">@@ -153,15 +152,18 @@ pub const Face = struct {</div><div>         return result;</div><div>     }</div><div> </div><div class="diff-removed">-    pub fn deinit(self: *Face) void {</div><div class="diff-removed">-        self.font.release();</div><div class="diff-removed">-        if (comptime harfbuzz_shaper) self.hb_font.destroy();</div><div class="diff-removed">-        if (self.color) |v| v.deinit();</div><div class="diff-removed">-        self.* = undefined;</div><div class="diff-added">+    /// Return a new "deferred" face based on CTFontDescriptor. This loads the</div><div class="diff-added">+    /// CTFont only when necessary via `load`.</div><div class="diff-added">+    pub fn initDeferred(lib: font.Library, desc: *macos.text.FontDescriptor, size: font.face.DesiredSize) !Face {</div><div class="diff-added">+        _ = lib;</div><div class="diff-added">+        const ct_font = try macos.text.Font.createWithFontDescriptor(desc, @floatFromInt(size.pixels()));</div><div class="diff-added">+        errdefer ct_font.release();</div><div class="diff-added">+        return try initFont(ct_font, .{ .size = size });</div><div>     }</div><div> </div><div class="diff-removed">-    /// Return a new face that is the same as this but has a transformation</div><div class="diff-removed">-    /// matrix applied to italicize it.</div><div class="diff-added">+    /// Return a new face that is the same as this but applies a synthetic</div><div class="diff-added">+    /// italic effect to it. This is useful for fonts that don't have an italic</div><div class="diff-added">+    /// variant.</div><div>     pub fn syntheticItalic(self: *const Face, opts: font.face.Options) !Face {</div><div>         const ct_font = try self.font.copyWithAttributes(0.0, &italic_skew, null);</div><div>         errdefer ct_font.release();</div><div class="diff-info">@@ -279,8 +281,15 @@ pub const Face = struct {</div><div>         atlas: *font.Atlas,</div><div>         glyph_index: u32,</div><div>         opts: font.face.RenderOptions,</div><div class="diff-removed">-    ) !font.Glyph {</div><div class="diff-removed">-        var glyphs = [_]macos.graphics.Glyph{@intCast(glyph_index)};</div><div class="diff-added">+    ) !font.face.Glyph {</div><div class="diff-added">+        // We reserve a 1px margin to the right and bottom of each glyph,</div><div class="diff-added">+        // to prevent interpolation with adjacent glyphs while sampling</div><div class="diff-added">+        // from the atlas.</div><div class="diff-added">+        const padding = 1;</div><div class="diff-added">+</div><div class="diff-added">+        var glyphs = [_]macos.graphics.Glyph{</div><div class="diff-added">+            @intCast(glyph_index),</div><div class="diff-added">+        };</div><div> </div><div>         // Get the bounding rect for rendering this glyph.</div><div>         // This is in a coordinate space with (0.0, 0.0)</div><div class="diff-info">@@ -321,7 +330,7 @@ pub const Face = struct {</div><div> </div><div>         // This bitmap is blank. I've seen it happen in a font, I don't know why.</div><div>         // If it is empty, we just return a valid glyph struct that does nothing.</div><div class="diff-removed">-        if (x1 <= x0 or y1 <= y0) return font.Glyph{</div><div class="diff-added">+        if (x1 <= x0 or y1 <= y0) return font.face.Glyph{</div><div>             .width = 0,</div><div>             .height = 0,</div><div>             .offset_x = 0,</div><div class="diff-info">@@ -354,15 +363,6 @@ pub const Face = struct {</div><div>         };</div><div>         defer color.space.release();</div><div> </div><div class="diff-removed">-        // This is just a safety check.</div><div class="diff-removed">-        if (atlas.format.depth() != color.depth) {</div><div class="diff-removed">-            log.warn("font atlas color depth doesn't equal font color depth atlas={} font={}", .{</div><div class="diff-removed">-                atlas.format.depth(),</div><div class="diff-removed">-                color.depth,</div><div class="diff-removed">-            });</div><div class="diff-removed">-            return error.InvalidAtlasFormat;</div><div class="diff-removed">-        }</div><div class="diff-removed">-</div><div>         // Our buffer for rendering. We could cache this but glyph rasterization</div><div>         // usually stabilizes pretty quickly and is very infrequent so I think</div><div>         // the allocation overhead is acceptable compared to the cost of</div><div class="diff-info">@@ -440,15 +440,15 @@ pub const Face = struct {</div><div>             // from the atlas.</div><div>             var region = try atlas.reserve(</div><div>                 alloc,</div><div class="diff-removed">-                width + 1,</div><div class="diff-removed">-                height + 1,</div><div class="diff-added">+                width + padding,</div><div class="diff-added">+                height + padding,</div><div>             );</div><div> </div><div>             // We adjust the region width and height back down since we</div><div>             // don't need the extra pixel, we just needed to reserve it</div><div>             // so that it isn't used for other glyphs in the future.</div><div class="diff-removed">-            region.width -= 1;</div><div class="diff-removed">-            region.height -= 1;</div><div class="diff-added">+            region.width -= padding;</div><div class="diff-added">+            region.height -= padding;</div><div>             break :region region;</div><div>         };</div><div>         atlas.set(region, buf);</div><div class="diff-info">@@ -496,6 +496,7 @@ pub const Face = struct {</div><div>         };</div><div>     }</div><div> </div><div class="diff-added">+</div><div>     pub const GetMetricsError = error{</div><div>         CopyTableError,</div><div>         InvalidHeadTable,</div><div class="diff-info">@@ -540,7 +541,7 @@ pub const Face = struct {</div><div>             const len = data.getLength();</div><div>             break :post opentype.Post.init(ptr[0..len]) catch |err| {</div><div>                 return switch (err) {</div><div class="diff-removed">-                    error.EndOfStream => error.InvalidPostTable,</div><div class="diff-added">+                    error.EndOfStream => error.InvalidHheaTable,</div><div>                 };</div><div>             };</div><div>         };</div><div class="diff-info">@@ -645,7 +646,7 @@ pub const Face = struct {</div><div>         else</div><div>             @as(f64, @floatFromInt(post.underlinePosition)) * px_per_unit;</div><div> </div><div class="diff-removed">-        const underline_thickness = if (has_broken_underline)</div><div class="diff-added">+        const underline_thickness: ?f64 = if (has_broken_underline)</div><div>             null</div><div>         else</div><div>             @as(f64, @floatFromInt(post.underlineThickness)) * px_per_unit;</div><div class="diff-info">@@ -747,13 +748,11 @@ pub const Face = struct {</div><div>         const data = self.font.copyTable(macos.text.FontTableTag.init(tag)) orelse</div><div>             return null;</div><div>         defer data.release();</div><div class="diff-removed">-</div><div class="diff-removed">-        const buf = try alloc.alloc(u8, data.getLength());</div><div class="diff-removed">-        errdefer alloc.free(buf);</div><div class="diff-removed">-</div><div>         const ptr = data.getPointer();</div><div class="diff-removed">-        @memcpy(buf, ptr[0..buf.len]);</div><div class="diff-removed">-</div><div class="diff-added">+        const len = data.getLength();</div><div class="diff-added">+        const buf = try alloc.alloc(u8, len);</div><div class="diff-added">+        errdefer alloc.free(buf);</div><div class="diff-added">+        @memcpy(buf, ptr[0..len]);</div><div>         return buf;</div><div>     }</div><div> };</div><div class="diff-info">@@ -888,6 +887,10 @@ test "name" {</div><div> </div><div> test "emoji" {</div><div>     const testing = std.testing;</div><div class="diff-added">+    const alloc = testing.allocator;</div><div class="diff-added">+</div><div class="diff-added">+    var atlas = try font.Atlas.init(alloc, 512, .rgba);</div><div class="diff-added">+    defer atlas.deinit(alloc);</div><div> </div><div>     const name = try macos.foundation.String.createWithBytes("Apple Color Emoji", .utf8, false);</div><div>     defer name.release();</div><div class="diff-info">@@ -1029,4 +1032,60 @@ test "glyphIndex colored vs text" {</div><div>         try testing.expectEqual(11482, glyph);</div><div>         try testing.expect(face.isColorGlyph(glyph));</div><div>     }</div><div class="diff-added">+}</div><div class="diff-added">+</div><div class="diff-added">+test "coretext: metrics" {</div><div class="diff-added">+    const testFont = font.embedded.inconsolata;</div><div class="diff-added">+    const alloc = std.testing.allocator;</div><div class="diff-added">+</div><div class="diff-added">+    var face = try Face.init(</div><div class="diff-added">+        undefined,</div><div class="diff-added">+        testFont,</div><div class="diff-added">+        .{ .size = .{ .points = 12, .xdpi = 96, .ydpi = 96 } },</div><div class="diff-added">+    );</div><div class="diff-added">+    defer face.deinit();</div><div class="diff-added">+    const metrics = try face.getMetrics();</div><div class="diff-added">+</div><div class="diff-added">+</div><div class="diff-added">+    try std.testing.expectEqual(8, @round(metrics.cell_width));</div><div class="diff-added">+    // The cell height is 17 px because the calculation is</div><div class="diff-added">+    //</div><div class="diff-added">+    //  ascender - descender + gap</div><div class="diff-added">+    //</div><div class="diff-added">+    // which, for inconsolata is</div><div class="diff-added">+    //</div><div class="diff-added">+    //  859 - -190 + 0</div><div class="diff-added">+    //</div><div class="diff-added">+    // font units, at 1000 units per em that works out to 1.049 em,</div><div class="diff-added">+    // and 1em should be the point size * dpi scale, so 12 * (96/72)</div><div class="diff-added">+    // which is 16, and 16 * 1.049 = 16.784, which finally is rounded</div><div class="diff-added">+    // to 17.</div><div class="diff-added">+     জনেk:</div><div class="diff-added">+    try std.testing.expectEqual(17, @round(font.Metrics.calc(metrics).cell_height));</div><div class="diff-added">+    try std.testing.expectEqual(3, @round(font.Metrics.calc(metrics).cell_baseline));</div><div class="diff-added">+    try std.testing.expectEqual(17, @round(font.Metrics.calc(metrics).underline_position));</div><div class="diff-added">+    try std.testing.expectEqual(1, @round(font.Metrics.calc(metrics).underline_thickness));</div><div class="diff-added">+    try std.testing.expectEqual(10, @round(font.Metrics.calc(metrics).strikethrough_position));</div><div class="diff-added">+    try std.testing.expectEqual(1, @round(font.Metrics.calc(metrics).strikethrough_thickness));</div><div class="diff-added">+    try std.testing.expectEqual(0, @round(font.Metrics.calc(metrics).overline_position));</div><div class="diff-added">+    try std.testing.expectEqual(1, @round(font.Metrics.calc(metrics).overline_thickness));</div><div class="diff-added">+    try std.testing.expectEqual(1, @round(font.Metrics.calc(metrics).box_thickness));</div><div class="diff-added">+    try std.testing.expectEqual(17, @round(font.Metrics.calc(metrics).cursor_height));</div><div class="diff-added">+</div><div class="diff-added">+</div><div class="diff-added">+    // Resize should change metrics</div><div class="diff-added">+    try face.setSize(.{ .size = .{ .points = 24, .xdpi = 96, .ydpi = 96 } });</div><div class="diff-added">+    const metrics2 = try face.getMetrics();</div><div class="diff-added">+    try std.testing.expectEqual(16, @round(metrics2.cell_width));</div><div class="diff-added">+    try std.testing.expectEqual(34, @round(font.Metrics.calc(metrics2).cell_height));</div><div class="diff-added">+    try std.testing.expectEqual(6, @round(font.Metrics.calc(metrics2).cell_baseline));</div><div class="diff-added">+    try std.testing.expectEqual(34, @round(font.Metrics.calc(metrics2).underline_position));</div><div class="diff-added">+    try std.testing.expectEqual(2, @round(font.Metrics.calc(metrics2).underline_thickness));</div><div class="diff-added">+    try std.testing.expectEqual(19, @round(font.Metrics.calc(metrics2).strikethrough_position));</div><div class="diff-added">+    try std.testing.expectEqual(2, @round(font.Metrics.calc(metrics2).strikethrough_thickness));</div><div class="diff-added">+    try std.testing.expectEqual(0, @round(font.Metrics.calc(metrics2).overline_position));</div><div class="diff-added">+    try std.testing.expectEqual(2, @round(font.Metrics.calc(metrics2).overline_thickness));</div><div class="diff-added">+    try std.testing.expectEqual(2, @round(font.Metrics.calc(metrics2).box_thickness));</div><div class="diff-added">+    try std.testing.expectEqual(34, @round(font.Metrics.calc(metrics2).cursor_height));</div><div class="diff-added">+</div><div> }</div><div>\ No newline at end of file</div><div></div></pre>
                </div>
            </div>
        </section>
    </main>
    <footer>
        <p>LoCoDiff-bench - <a href="https://github.com/AbanteAI/LoCoDiff-bench">GitHub Repository</a></p>
    </footer>
</body>
</html>
    