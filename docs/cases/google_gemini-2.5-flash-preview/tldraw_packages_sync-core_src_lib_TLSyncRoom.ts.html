<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case: packages/sync-core/src/lib/TLSyncRoom.ts - Gemini 2.5 Flash</title>
    <link rel="stylesheet" href="../../styles.css">
</head>
<body>
    <header>
        <h1>Case: packages/sync-core/src/lib/TLSyncRoom.ts</h1>
        <p><a href="../../models/google_gemini-2.5-flash-preview.html">‚Üê Back to Gemini 2.5 Flash Cases</a> | <a href="../../index.html">Home</a></p>
    </header>
    <main>
        <section class="case-details">
            <div class="case-info">
                <h2>Benchmark Case Information</h2>
                <p><strong>Model:</strong> Gemini 2.5 Flash</p>
                <p><strong>Status:</strong> <span class="failure">Failure</span></p>
                <p><strong>Prompt Tokens:</strong> 30839</p>
                <p><strong>Output Tokens:</strong> N/A</p>
                <p><strong>Native Prompt Tokens:</strong> 36867</p>
                <p><strong>Native Completion Tokens:</strong> 11272</p>
                <p><strong>Native Tokens Reasoning:</strong> 135</p>
                <p><strong>Native Finish Reason:</strong> STOP</p>
                <p><strong>Runtime:</strong> N/As</p>
                <p><strong>Cost:</strong> $0.01229325</p>
            </div>
            
            <div class="content-links">
                <h2>View Content</h2>
                <ul>
                    <li><a href="../../content/google_gemini-2.5-flash-preview/tldraw_packages_sync-core_src_lib_TLSyncRoom.ts/prompt.html" class="content-link">View Prompt</a></li>
                    <li><a href="../../content/google_gemini-2.5-flash-preview/tldraw_packages_sync-core_src_lib_TLSyncRoom.ts/expected.html" class="content-link">View Expected Output</a></li>
                    <li><a href="../../content/google_gemini-2.5-flash-preview/tldraw_packages_sync-core_src_lib_TLSyncRoom.ts/actual.html" class="content-link">View Actual Output</a></li>
                </ul>
            </div>
            
            <div class="diff-section">
                <h2>Diff (Expected vs Actual)</h2>
                <div id="diff-output">
                    <pre class="diff"><div class="diff-header">--- tldraw_packages_sync-core_src_lib_TLSyncRoom.ts_expectedoutput.txt (expected)+++ tldraw_packages_sync-core_src_lib_TLSyncRoom.ts_extracted.txt (actual)@@ -617,53 +617,12 @@ 	}</div><div> </div><div> 	/**</div><div class="diff-removed">-	 * When we send a diff to a client, if that client is on a lower version than us, we need to make</div><div class="diff-removed">-	 * the diff compatible with their version. At the moment this means migrating each affected record</div><div class="diff-removed">-	 * to the client's version and sending the whole record again. We can optimize this later by</div><div class="diff-removed">-	 * keeping the previous versions of records around long enough to recalculate these diffs for</div><div class="diff-removed">-	 * older client versions.</div><div class="diff-removed">-	 */</div><div class="diff-removed">-	private migrateDiffForSession(</div><div class="diff-removed">-		serializedSchema: SerializedSchema,</div><div class="diff-removed">-		diff: NetworkDiff<R></div><div class="diff-removed">-	): Result<NetworkDiff<R>, MigrationFailureReason> {</div><div class="diff-removed">-		// TODO: optimize this by recalculating patches using the previous versions of records</div><div class="diff-removed">-</div><div class="diff-removed">-		// when the client connects we check whether the schema is identical and make sure</div><div class="diff-removed">-		// to use the same object reference so that === works on this line</div><div class="diff-removed">-		if (serializedSchema === this.serializedSchema) {</div><div class="diff-removed">-			return Result.ok(diff)</div><div class="diff-removed">-		}</div><div class="diff-removed">-</div><div class="diff-removed">-		const result: NetworkDiff<R> = {}</div><div class="diff-removed">-		for (const [id, op] of Object.entries(diff)) {</div><div class="diff-removed">-			if (op[0] === RecordOpType.Remove) {</div><div class="diff-removed">-				result[id] = op</div><div class="diff-removed">-				continue</div><div class="diff-removed">-			}</div><div class="diff-removed">-</div><div class="diff-removed">-			const migrationResult = this.schema.migratePersistedRecord(</div><div class="diff-removed">-				this.getDocument(id).state,</div><div class="diff-removed">-				serializedSchema,</div><div class="diff-removed">-				'down'</div><div class="diff-removed">-			)</div><div class="diff-removed">-</div><div class="diff-removed">-			if (migrationResult.type === 'error') {</div><div class="diff-removed">-				return Result.err(migrationResult.reason)</div><div class="diff-removed">-			}</div><div class="diff-removed">-</div><div class="diff-removed">-			result[id] = [RecordOpType.Put, migrationResult.value]</div><div class="diff-removed">-		}</div><div class="diff-removed">-</div><div class="diff-removed">-		return Result.ok(result)</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	/**</div><div> 	 * When the server receives a message from the clients Currently, supports connect and patches.</div><div> 	 * Invalid messages types throws an error. Currently, doesn't validate data.</div><div> 	 *</div><div> 	 * @param sessionId - The session that sent the message</div><div> 	 * @param message - The message that was sent</div><div class="diff-added">+	 * @internal</div><div> 	 */</div><div> 	async handleMessage(sessionId: string, message: TLSocketClientSentEvent<R>) {</div><div> 		const session = this.sessions.get(sessionId)</div><div class="diff-info">@@ -690,7 +649,10 @@ 		}</div><div> 	}</div><div> </div><div class="diff-removed">-	/** If the client is out of date, or we are out of date, we need to let them know */</div><div class="diff-added">+	/** If the client is out of date, or we are out of date, we need to let them know</div><div class="diff-added">+	 * @param sessionId - The session of the client to reject.</div><div class="diff-added">+	 * @param fatalReason - The reason for rejecting the session.</div><div class="diff-added">+	 */</div><div> 	rejectSession(sessionId: string, fatalReason?: TLSyncErrorCloseEventReason | string) {</div><div> 		const session = this.sessions.get(sessionId)</div><div> 		if (!session) return</div><div class="diff-info">@@ -729,7 +691,7 @@ 			} catch {</div><div> 				// noop</div><div> 			} finally {</div><div class="diff-removed">-				this.removeSession(sessionId)</div><div class="diff-added">+				this.removeSession(sessionId, fatalReason)</div><div> 			}</div><div> 		} else {</div><div> 			this.removeSession(sessionId, fatalReason)</div><div class="diff-info">@@ -923,7 +885,9 @@ 				if (session) {</div><div> 					this.rejectSession(session.sessionId, reason)</div><div> 				} else {</div><div class="diff-removed">-					throw new Error('failed to apply changes: ' + reason, underlyingError)</div><div class="diff-added">+					throw new Error('failed to apply changes: ' + reason, {</div><div class="diff-added">+						cause: underlyingError,</div><div class="diff-added">+					})</div><div> 				}</div><div> 				if (typeof process !== 'undefined' && process.env.NODE_ENV !== 'test') {</div><div> 					this.log?.error?.('failed to apply push', reason, message, underlyingError)</div><div class="diff-info">@@ -1049,6 +1013,10 @@ 						if (!res.ok) return</div><div> 						break</div><div> 					}</div><div class="diff-added">+					case RecordOpType.Remove: {</div><div class="diff-added">+						// there is no remove op for presence</div><div class="diff-added">+						return fail(TLSyncErrorCloseEventReason.INVALID_OPERATION)</div><div class="diff-added">+					}</div><div> 				}</div><div> 			}</div><div> 			if (message.diff && !session?.isReadonly) {</div><div class="diff-info">@@ -1056,7 +1024,6 @@ 				for (const [id, op] of Object.entries(message.diff!)) {</div><div> 					switch (op[0]) {</div><div> 						case RecordOpType.Put: {</div><div class="diff-removed">-							// Try to add the document.</div><div> 							// If we're putting a record with a type that we don't recognize, fail</div><div> 							if (!this.documentTypes.has(op[1].typeName)) {</div><div> 								return fail(TLSyncErrorCloseEventReason.INVALID_RECORD)</div><div class="diff-info">@@ -1089,43 +1056,43 @@ 						}</div><div> 					}</div><div> 				}</div><div class="diff-added">+			} else if (message.diff) {</div><div class="diff-added">+				// client is readonly and tried to push a diff</div><div class="diff-added">+				return fail(TLSyncErrorCloseEventReason.INVALID_OPERATION)</div><div> 			}</div><div> </div><div> 			// Let the client know what action to take based on the results of the push</div><div class="diff-removed">-			if (</div><div class="diff-added">+			if (session) {</div><div> 				// if there was only a presence push, the client doesn't need to do anything aside from</div><div> 				// shift the push request.</div><div class="diff-removed">-				!message.diff ||</div><div class="diff-removed">-				isEqual(docChanges.diff, message.diff)</div><div class="diff-removed">-			) {</div><div class="diff-removed">-				// COMMIT</div><div class="diff-removed">-				// Applying the client's changes had the exact same effect on the server as</div><div class="diff-removed">-				// they had on the client, so the client should keep the diff</div><div class="diff-removed">-				if (session) {</div><div class="diff-added">+				if (</div><div class="diff-added">+					//</div><div class="diff-added">+					!message.diff ||</div><div class="diff-added">+					isEqual(docChanges.diff, message.diff)</div><div class="diff-added">+				) {</div><div class="diff-added">+					// COMMIT</div><div class="diff-added">+					// Applying the client's changes had the exact same effect on the server as</div><div class="diff-added">+					// they had on the client, so the client should keep the diff</div><div> 					this.sendMessage(session.sessionId, {</div><div> 						type: 'push_result',</div><div> 						serverClock: this.clock,</div><div> 						clientClock,</div><div> 						action: 'commit',</div><div> 					})</div><div class="diff-removed">-				}</div><div class="diff-removed">-			} else if (!docChanges.diff) {</div><div class="diff-removed">-				// DISCARD</div><div class="diff-removed">-				// Applying the client's changes had no effect, so the client should drop the diff</div><div class="diff-removed">-				if (session) {</div><div class="diff-added">+				} else if (!docChanges.diff) {</div><div class="diff-added">+					// DISCARD</div><div class="diff-added">+					// Applying the client's changes had no effect, so the client should drop the diff</div><div> 					this.sendMessage(session.sessionId, {</div><div> 						type: 'push_result',</div><div> 						serverClock: this.clock,</div><div> 						clientClock,</div><div> 						action: 'discard',</div><div> 					})</div><div class="diff-removed">-				}</div><div class="diff-removed">-			} else {</div><div class="diff-removed">-				// REBASE</div><div class="diff-removed">-				// Applying the client's changes had a different non-empty effect on the server,</div><div class="diff-removed">-				// so the client should rebase with our gold-standard / authoritative diff.</div><div class="diff-removed">-				// First we need to migrate the diff to the client's version</div><div class="diff-removed">-				if (session) {</div><div class="diff-added">+				} else {</div><div class="diff-added">+					// REBASE</div><div class="diff-added">+					// Applying the client's changes had a different non-empty effect on the server,</div><div class="diff-added">+					// so the client should rebase with our gold-standard / authoritative diff.</div><div class="diff-added">+					// First we need to migrate the diff to the client's version</div><div> 					const migrateResult = this.migrateDiffForSession(</div><div> 						session.serializedSchema,</div><div> 						docChanges.diff</div><div class="diff-info">@@ -1175,6 +1142,7 @@ 	 * Handle the event when a client disconnects.</div><div> 	 *</div><div> 	 * @param sessionId - The session that disconnected.</div><div class="diff-added">+	 * @internal</div><div> 	 */</div><div> 	handleClose(sessionId: string) {</div><div> 		this.cancelSession(sessionId)</div><div></div></pre>
                </div>
            </div>
        </section>
    </main>
    <footer>
        <p>LoCoDiff-bench - <a href="https://github.com/AbanteAI/LoCoDiff-bench">GitHub Repository</a></p>
    </footer>
</body>
</html>
    