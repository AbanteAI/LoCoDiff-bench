<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case: apps/dotcom/client/src/tla/app/TldrawApp.ts - GPT-5</title>
    <link rel="stylesheet" href="../../styles.css">
</head>
<body>
    <header>
        <h1>Case: apps/dotcom/client/src/tla/app/TldrawApp.ts</h1>
        <h2>Model: GPT-5</h2>
        <p><a href="../../models/openai_gpt-5.html">All GPT-5 Cases</a> | <a href="../../cases.html">All Cases</a> | <a href="../../index.html">Home</a></p>
    </header>
    <main>
        <section class="case-details">
            <div class="case-info">
                <h2>Benchmark Case Information</h2>
                <p><strong>Model:</strong> GPT-5</p>
                <p><strong>Status:</strong> <span class="failure">Failure</span></p>
                <p><strong>Prompt Tokens:</strong> 77021</p>
                <p><strong>Native Prompt Tokens:</strong> 76363</p>
                <p><strong>Native Completion Tokens:</strong> 6776</p>
                <p><strong>Native Tokens Reasoning:</strong> 1792</p>
                <p><strong>Native Finish Reason:</strong> stop</p>
                <p><strong>Cost:</strong> $0.0038672375</p>
            </div>
            
            <div class="content-links">
                <h2>View Content</h2>
                <ul>
                    <li><a href="../../content/openai_gpt-5/tldraw_apps_dotcom_client_src_tla_app_TldrawApp.ts/prompt.html" class="content-link">View Prompt</a></li>
                    <li><a href="../../content/openai_gpt-5/tldraw_apps_dotcom_client_src_tla_app_TldrawApp.ts/expected.html" class="content-link">View Expected Output</a></li>
                    <li><a href="../../content/openai_gpt-5/tldraw_apps_dotcom_client_src_tla_app_TldrawApp.ts/actual.html" class="content-link">View Actual Output</a></li>
                </ul>
            </div>
            
            <div class="diff-section">
                <h2>Diff (Expected vs Actual)</h2>
                <div id="diff-output">
                    <pre class="diff"><div></div><div>index 1724dd1c8..e01fbfd37 100644</div><div class="diff-header">--- a/tldraw_apps_dotcom_client_src_tla_app_TldrawApp.ts_expectedoutput.txt (expected):tmp/tmpwgk6qk9v_expected.txt	</div><div class="diff-header">+++ b/tldraw_apps_dotcom_client_src_tla_app_TldrawApp.ts_extracted.txt (actual):tmp/tmpa2_9x7jm_actual.txt	</div><div class="diff-info">@@ -3,13 +3,12 @@ import { Zero } from '@rocicorp/zero'</div><div> import { captureException } from '@sentry/react'</div><div> import {</div><div> 	CreateFilesResponseBody,</div><div class="diff-removed">-	createMutators,</div><div> 	CreateSnapshotRequestBody,</div><div> 	LOCAL_FILE_PREFIX,</div><div> 	MAX_NUMBER_OF_FILES,</div><div> 	TlaFile,</div><div class="diff-added">+	TlaFilePartial,</div><div> 	TlaFileState,</div><div class="diff-removed">-	TlaMutators,</div><div> 	TlaSchema,</div><div> 	TlaUser,</div><div> 	UserPreferencesKeys,</div><div class="diff-info">@@ -79,36 +78,24 @@ export class TldrawApp {</div><div> </div><div> 	readonly id = appId++</div><div> </div><div class="diff-removed">-	readonly z: ZeroPolyfill | Zero<TlaSchema, TlaMutators></div><div class="diff-added">+	readonly z: ZeroPolyfill | Zero<TlaSchema></div><div> </div><div> 	private readonly user$: Signal<TlaUser | undefined></div><div class="diff-added">+	private readonly files$: Signal<TlaFile[]></div><div> 	private readonly fileStates$: Signal<(TlaFileState & { file: TlaFile })[]></div><div> </div><div> 	private readonly abortController = new AbortController()</div><div class="diff-removed">-	readonly disposables: (() => void)[] = [() => this.abortController.abort(), () => this.z.close()]</div><div class="diff-removed">-</div><div class="diff-removed">-	changes: Map<Atom<any, unknown>, any> = new Map()</div><div class="diff-removed">-	changesFlushed = null as null | ReturnType<typeof promiseWithResolve></div><div class="diff-added">+	readonly disposables: (() => void)[] = [</div><div class="diff-added">+		() => this.abortController.abort(),</div><div class="diff-added">+		() => (this.z as any)?.dispose?.(),</div><div class="diff-added">+	]</div><div> </div><div> 	private signalizeQuery<TReturn>(name: string, query: any): Signal<TReturn> {</div><div> 		// fail if closed?</div><div> 		const view = query.materialize()</div><div> 		const val$ = atom(name, view.data)</div><div> 		view.addListener((res: any) => {</div><div class="diff-removed">-			this.changes.set(val$, structuredClone(res))</div><div class="diff-removed">-			if (!this.changesFlushed) {</div><div class="diff-removed">-				this.changesFlushed = promiseWithResolve()</div><div class="diff-removed">-			}</div><div class="diff-removed">-			queueMicrotask(() => {</div><div class="diff-removed">-				transact(() => {</div><div class="diff-removed">-					this.changes.forEach((value, key) => {</div><div class="diff-removed">-						key.set(value)</div><div class="diff-removed">-					})</div><div class="diff-removed">-					this.changes.clear()</div><div class="diff-removed">-				})</div><div class="diff-removed">-				this.changesFlushed?.resolve(undefined)</div><div class="diff-removed">-				this.changesFlushed = null</div><div class="diff-removed">-			})</div><div class="diff-added">+			val$.set(structuredClone(res) as any)</div><div> 		})</div><div> 		this.disposables.push(() => {</div><div> 			view.destroy()</div><div class="diff-info">@@ -120,65 +107,398 @@ export class TldrawApp {</div><div> </div><div> 	private constructor(</div><div> 		public readonly userId: string,</div><div class="diff-removed">-		getToken: () => Promise<string | undefined>,</div><div class="diff-added">+		getToken: () => Promise<string | null>,</div><div> 		onClientTooOld: () => void,</div><div> 		trackEvent: TLAppUiContextType</div><div> 	) {</div><div> 		const sessionId = uniqueId()</div><div class="diff-removed">-		this.z = useProperZero</div><div class="diff-removed">-			? new Zero<TlaSchema, TlaMutators>({</div><div class="diff-removed">-					auth: getToken,</div><div class="diff-removed">-					userID: userId,</div><div class="diff-removed">-					schema: zeroSchema,</div><div class="diff-removed">-					server: ZERO_SERVER,</div><div class="diff-removed">-					mutators: createMutators(userId),</div><div class="diff-removed">-					onUpdateNeeded(reason) {</div><div class="diff-removed">-						console.error('update needed', reason)</div><div class="diff-removed">-						onClientTooOld()</div><div class="diff-removed">-					},</div><div class="diff-removed">-					kvStore: window.navigator.webdriver ? 'mem' : 'idb',</div><div class="diff-removed">-				})</div><div class="diff-removed">-			: new ZeroPolyfill({</div><div class="diff-removed">-					userId,</div><div class="diff-removed">-					// auth: encodedJWT,</div><div class="diff-removed">-					getUri: async () => {</div><div class="diff-removed">-						const params = new URLSearchParams({</div><div class="diff-removed">-							sessionId,</div><div class="diff-removed">-							protocolVersion: String(Z_PROTOCOL_VERSION),</div><div class="diff-removed">-						})</div><div class="diff-removed">-						const token = await getToken()</div><div class="diff-removed">-						params.set('accessToken', token || 'no-token-found')</div><div class="diff-removed">-						return `${MULTIPLAYER_SERVER}/app/${userId}/connect?${params}`</div><div class="diff-removed">-					},</div><div class="diff-removed">-					// schema,</div><div class="diff-removed">-					// This is often easier to develop with if you're frequently changing</div><div class="diff-removed">-					// the schema. Switch to 'idb' for local-persistence.</div><div class="diff-removed">-					onMutationRejected: this.showMutationRejectionToast,</div><div class="diff-removed">-					onClientTooOld: () => onClientTooOld(),</div><div class="diff-removed">-					trackEvent,</div><div class="diff-added">+</div><div class="diff-added">+		if (useProperZero) {</div><div class="diff-added">+			// NOTE: experimental client; keep options in sync with Zero polyfill behavior where possible</div><div class="diff-added">+			this.z = new Zero<TlaSchema>({</div><div class="diff-added">+				server: ZERO_SERVER,</div><div class="diff-added">+				schema: zeroSchema,</div><div class="diff-added">+				userID: this.userId,</div><div class="diff-added">+				getAuth: async () => {</div><div class="diff-added">+					const token = await getToken()</div><div class="diff-added">+					return { accessToken: token || 'no-token-found' }</div><div class="diff-added">+				},</div><div class="diff-added">+				params: {</div><div class="diff-added">+					sessionId,</div><div class="diff-added">+					protocolVersion: String(Z_PROTOCOL_VERSION),</div><div class="diff-added">+				},</div><div class="diff-added">+				onMutationRejected: this.showMutationRejectionToast,</div><div class="diff-added">+				onClientTooOld: () => onClientTooOld(),</div><div class="diff-added">+				trackEvent,</div><div class="diff-added">+			} as any)</div><div class="diff-added">+		} else {</div><div class="diff-added">+			this.z = new ZeroPolyfill({</div><div class="diff-added">+				// userID: userId,</div><div class="diff-added">+				// auth: encodedJWT,</div><div class="diff-added">+				getUri: async () => {</div><div class="diff-added">+					const params = new URLSearchParams({</div><div class="diff-added">+						sessionId,</div><div class="diff-added">+						protocolVersion: String(Z_PROTOCOL_VERSION),</div><div class="diff-added">+					})</div><div class="diff-added">+					const token = await getToken()</div><div class="diff-added">+					params.set('accessToken', token || 'no-token-found')</div><div class="diff-added">+					return `${MULTIPLAYER_SERVER}/app/${this.userId}/connect?${params}`</div><div class="diff-added">+				},</div><div class="diff-added">+				// schema,</div><div class="diff-added">+				// This is often easier to develop with if you're frequently changing</div><div class="diff-added">+				// the schema. Switch to 'idb' for local-persistence.</div><div class="diff-added">+				onMutationRejected: this.showMutationRejectionToast,</div><div class="diff-added">+				onClientTooOld: () => onClientTooOld(),</div><div class="diff-added">+				trackEvent,</div><div class="diff-added">+			})</div><div class="diff-added">+		}</div><div class="diff-added">+</div><div class="diff-added">+		this.user$ = this.signalizeQuery(</div><div class="diff-added">+			'user signal',</div><div class="diff-added">+			(this.z as any).query.user.where('id', this.userId).one()</div><div class="diff-added">+		)</div><div class="diff-added">+		this.files$ = this.signalizeQuery(</div><div class="diff-added">+			'files signal',</div><div class="diff-added">+			(this.z as any).query.file.where('ownerId', this.userId)</div><div class="diff-added">+		)</div><div class="diff-added">+		this.fileStates$ = this.signalizeQuery(</div><div class="diff-added">+			'file states signal',</div><div class="diff-added">+			(this.z as any).query.file_state.where('userId', this.userId).related('file', (q: any) => q.one())</div><div class="diff-added">+		)</div><div class="diff-added">+	}</div><div class="diff-added">+</div><div class="diff-added">+	async preload(initialUserData: TlaUser) {</div><div class="diff-added">+		let didCreate = false</div><div class="diff-added">+		await (this.z as any).query.user.where('id', this.userId).preload().complete</div><div class="diff-added">+		if (!this.user$.get()) {</div><div class="diff-added">+			didCreate = true</div><div class="diff-added">+			;(this.z as any).mutate.user.create(initialUserData)</div><div class="diff-added">+			updateLocalSessionState((state) => ({ ...state, shouldShowWelcomeDialog: true }))</div><div class="diff-added">+		}</div><div class="diff-added">+		await new Promise((resolve) => {</div><div class="diff-added">+			let unsub = () => {}</div><div class="diff-added">+			unsub = react('wait for user', () => this.user$.get() && resolve(unsub()))</div><div class="diff-added">+		})</div><div class="diff-added">+		if (!this.user$.get()) {</div><div class="diff-added">+			throw Error('could not create user')</div><div class="diff-added">+		}</div><div class="diff-added">+		await (this.z as any).query.file_state.where('userId', this.userId).preload().complete</div><div class="diff-added">+		await (this.z as any).query.file.where('ownerId', this.userId).preload().complete</div><div class="diff-added">+		return didCreate</div><div class="diff-added">+	}</div><div class="diff-added">+</div><div class="diff-added">+	messages = defineMessages({</div><div class="diff-added">+		// toast title</div><div class="diff-added">+		mutation_error_toast_title: { defaultMessage: 'Error' },</div><div class="diff-added">+		// toast descriptions</div><div class="diff-added">+		publish_failed: {</div><div class="diff-added">+			defaultMessage: 'Unable to publish the file.',</div><div class="diff-added">+		},</div><div class="diff-added">+		unpublish_failed: {</div><div class="diff-added">+			defaultMessage: 'Unable to unpublish the file.',</div><div class="diff-added">+		},</div><div class="diff-added">+		republish_failed: {</div><div class="diff-added">+			defaultMessage: 'Unable to publish the changes.',</div><div class="diff-added">+		},</div><div class="diff-added">+		unknown_error: {</div><div class="diff-added">+			defaultMessage: 'An unexpected error occurred.',</div><div class="diff-added">+		},</div><div class="diff-added">+		forbidden: {</div><div class="diff-added">+			defaultMessage: 'You do not have the necessary permissions to perform this action.',</div><div class="diff-added">+		},</div><div class="diff-added">+		bad_request: {</div><div class="diff-added">+			defaultMessage: 'Invalid request.',</div><div class="diff-added">+		},</div><div class="diff-added">+		rate_limit_exceeded: {</div><div class="diff-added">+			defaultMessage: 'Rate limit exceeded, try again later.',</div><div class="diff-added">+		},</div><div class="diff-added">+		client_too_old: {</div><div class="diff-added">+			defaultMessage: 'Please refresh the page to get the latest version of tldraw.',</div><div class="diff-added">+		},</div><div class="diff-added">+		max_files_title: {</div><div class="diff-added">+			defaultMessage: 'File limit reached',</div><div class="diff-added">+		},</div><div class="diff-added">+		max_files_reached: {</div><div class="diff-added">+			defaultMessage:</div><div class="diff-added">+				'You have reached the maximum number of files. You need to delete old files before creating new ones.',</div><div class="diff-added">+		},</div><div class="diff-added">+		uploadingTldrFiles: {</div><div class="diff-added">+			defaultMessage:</div><div class="diff-added">+				'{total, plural, one {Uploading .tldr file…} other {Uploading {uploaded} of {total} .tldr files…}}',</div><div class="diff-added">+		},</div><div class="diff-added">+		addingTldrFiles: {</div><div class="diff-added">+			// no need for pluralization, if there was only one file we navigated to it</div><div class="diff-added">+			// so there's no need to show a toast.</div><div class="diff-added">+			defaultMessage: 'Added {total} .tldr files.',</div><div class="diff-added">+		},</div><div class="diff-added">+	})</div><div class="diff-added">+</div><div class="diff-added">+	getMessage(id: keyof typeof this.messages) {</div><div class="diff-added">+		let msg = this.messages[id]</div><div class="diff-added">+		if (!msg) {</div><div class="diff-added">+			console.error('Could not find a translation for this error code', id)</div><div class="diff-added">+			msg = this.messages.unknown_error</div><div class="diff-added">+		}</div><div class="diff-added">+		return msg</div><div class="diff-added">+	}</div><div class="diff-added">+</div><div class="diff-added">+	showMutationRejectionToast = throttle((errorCode: ZErrorCode) => {</div><div class="diff-added">+		const descriptor = this.getMessage(errorCode)</div><div class="diff-added">+		this.toasts?.addToast({</div><div class="diff-added">+			title: this.getIntl().formatMessage(this.messages.mutation_error_toast_title),</div><div class="diff-added">+			description: this.getIntl().formatMessage(descriptor),</div><div class="diff-added">+		})</div><div class="diff-added">+	}, 3000)</div><div class="diff-added">+</div><div class="diff-added">+	dispose() {</div><div class="diff-added">+		this.disposables.forEach((d) => d())</div><div class="diff-added">+		// this.store.dispose()</div><div class="diff-added">+	}</div><div class="diff-added">+</div><div class="diff-added">+	getUser() {</div><div class="diff-added">+		return assertExists(this.user$.get(), 'no user')</div><div class="diff-added">+	}</div><div class="diff-added">+</div><div class="diff-added">+	tlUser = createTLUser({</div><div class="diff-added">+		userPreferences: computed('user prefs', () => {</div><div class="diff-added">+			const user = this.getUser()</div><div class="diff-added">+			return {</div><div class="diff-added">+				...(pick(user, UserPreferencesKeys) as TLUserPreferences),</div><div class="diff-added">+				id: this.userId,</div><div class="diff-added">+			}</div><div class="diff-added">+		}),</div><div class="diff-added">+		setUserPreferences: ({ id: _, ...others }: Partial<TLUserPreferences>) => {</div><div class="diff-added">+			const user = this.getUser()</div><div class="diff-added">+</div><div class="diff-added">+			const nonNull = Object.fromEntries(</div><div class="diff-added">+				Object.entries(others).filter(([_, value]) => value !== null)</div><div class="diff-added">+			) as Partial<TLUserPreferences></div><div class="diff-added">+</div><div class="diff-added">+			;(this.z as any).mutate((tx: any) => {</div><div class="diff-added">+				tx.user.update({</div><div class="diff-added">+					id: user.id,</div><div class="diff-added">+					...(nonNull as any),</div><div> 				})</div><div class="diff-added">+			})</div><div class="diff-added">+		},</div><div class="diff-added">+	})</div><div class="diff-added">+</div><div class="diff-added">+	// getAll<T extends keyof Schema['tables']>(</div><div class="diff-added">+	// 	typeName: T</div><div class="diff-added">+	// ): SchemaToRow<Schema['tables'][T]>[] {</div><div class="diff-added">+	// 	return this.z.query[typeName].run()</div><div class="diff-added">+	// }</div><div class="diff-added">+</div><div class="diff-added">+	getUserOwnFiles() {</div><div class="diff-added">+		return this.files$.get()</div><div class="diff-added">+	}</div><div class="diff-added">+</div><div class="diff-added">+	getUserFileStates() {</div><div class="diff-added">+		return this.fileStates$.get()</div><div class="diff-added">+	}</div><div class="diff-added">+</div><div class="diff-added">+	lastRecentFileOrdering = null as null | Array<{</div><div class="diff-added">+		fileId: TlaFile['id']</div><div class="diff-added">+		isPinned: boolean</div><div class="diff-added">+		date: number</div><div class="diff-added">+	}></div><div class="diff-added">+</div><div class="diff-added">+	@computed</div><div class="diff-added">+	getUserRecentFiles() {</div><div class="diff-added">+		const myFiles = objectMapFromEntries(this.getUserOwnFiles().map((f) => [f.id, f]))</div><div class="diff-added">+		const myStates = objectMapFromEntries(this.getUserFileStates().map((f) => [f.fileId, f]))</div><div class="diff-added">+</div><div class="diff-added">+		const myFileIds = new Set<string>([...objectMapKeys(myFiles), ...objectMapKeys(myStates)])</div><div class="diff-added">+</div><div class="diff-added">+		const nextRecentFileOrdering: {</div><div class="diff-added">+			fileId: TlaFile['id']</div><div class="diff-added">+			isPinned: boolean</div><div class="diff-added">+			date: number</div><div class="diff-added">+		}[] = []</div><div class="diff-added">+</div><div class="diff-added">+		for (const fileId of myFileIds) {</div><div class="diff-added">+			const file = myFiles[fileId]</div><div class="diff-added">+			let state = myStates[fileId]</div><div class="diff-added">+			if (!file) continue</div><div class="diff-added">+			if (!state && !file.isDeleted && file.ownerId === this.userId) {</div><div class="diff-added">+				// create a file state for this file</div><div class="diff-added">+				// this allows us to 'undelete' soft-deleted files by manually toggling 'isDeleted' in the backend</div><div class="diff-added">+				state = this.getOrCreateFileState(file```ts</div><div class="diff-added">+// import { Query, QueryType, Smash, TableSchema, Zero } from '@rocicorp/zero'</div><div class="diff-added">+import { Zero } from '@rocicorp/zero'</div><div class="diff-added">+import { captureException } from '@sentry/react'</div><div class="diff-added">+import {</div><div class="diff-added">+	CreateFilesResponseBody,</div><div class="diff-added">+	CreateSnapshotRequestBody,</div><div class="diff-added">+	LOCAL_FILE_PREFIX,</div><div class="diff-added">+	MAX_NUMBER_OF_FILES,</div><div class="diff-added">+	TlaFile,</div><div class="diff-added">+	TlaFilePartial,</div><div class="diff-added">+	TlaFileState,</div><div class="diff-added">+	TlaSchema,</div><div class="diff-added">+	TlaUser,</div><div class="diff-added">+	UserPreferencesKeys,</div><div class="diff-added">+	Z_PROTOCOL_VERSION,</div><div class="diff-added">+	schema as zeroSchema,</div><div class="diff-added">+	ZErrorCode,</div><div class="diff-added">+} from '@tldraw/dotcom-shared'</div><div class="diff-added">+import {</div><div class="diff-added">+	assert,</div><div class="diff-added">+	fetch,</div><div class="diff-added">+	getFromLocalStorage,</div><div class="diff-added">+	promiseWithResolve,</div><div class="diff-added">+	Result,</div><div class="diff-added">+	setInLocalStorage,</div><div class="diff-added">+	structuredClone,</div><div class="diff-added">+	throttle,</div><div class="diff-added">+	uniqueId,</div><div class="diff-added">+} from '@tldraw/utils'</div><div class="diff-added">+import pick from 'lodash.pick'</div><div class="diff-added">+import {</div><div class="diff-added">+	assertExists,</div><div class="diff-added">+	Atom,</div><div class="diff-added">+	atom,</div><div class="diff-added">+	computed,</div><div class="diff-added">+	createTLSchema,</div><div class="diff-added">+	createTLUser,</div><div class="diff-added">+	dataUrlToFile,</div><div class="diff-added">+	defaultUserPreferences,</div><div class="diff-added">+	getUserPreferences,</div><div class="diff-added">+	objectMapFromEntries,</div><div class="diff-added">+	objectMapKeys,</div><div class="diff-added">+	parseTldrawJsonFile,</div><div class="diff-added">+	react,</div><div class="diff-added">+	Signal,</div><div class="diff-added">+	TLDocument,</div><div class="diff-added">+	TLSessionStateSnapshot,</div><div class="diff-added">+	TLUiToastsContextType,</div><div class="diff-added">+	TLUserPreferences,</div><div class="diff-added">+	transact,</div><div class="diff-added">+} from 'tldraw'</div><div class="diff-added">+import { MULTIPLAYER_SERVER, ZERO_SERVER } from '../../utils/config'</div><div class="diff-added">+import { multiplayerAssetStore } from '../../utils/multiplayerAssetStore'</div><div class="diff-added">+import { getScratchPersistenceKey } from '../../utils/scratch-persistence-key'</div><div class="diff-added">+import { TLAppUiContextType } from '../utils/app-ui-events'</div><div class="diff-added">+import { getDateFormat } from '../utils/dates'</div><div class="diff-added">+import { createIntl, defineMessages, setupCreateIntl } from '../utils/i18n'</div><div class="diff-added">+import { updateLocalSessionState } from '../utils/local-session-state'</div><div class="diff-added">+import { Zero as ZeroPolyfill } from './zero-polyfill'</div><div class="diff-added">+</div><div class="diff-added">+export const TLDR_FILE_ENDPOINT = `/api/app/tldr`</div><div class="diff-added">+export const PUBLISH_ENDPOINT = `/api/app/publish`</div><div> </div><div class="diff-removed">-		this.user$ = this.signalizeQuery('user signal', this.userQuery())</div><div class="diff-removed">-		this.fileStates$ = this.signalizeQuery('file states signal', this.fileStateQuery())</div><div class="diff-added">+let appId = 0</div><div class="diff-added">+const useProperZero = getFromLocalStorage('useProperZero') === 'true'</div><div class="diff-added">+// eslint-disable-next-line no-console</div><div class="diff-added">+console.log('useProperZero', useProperZero)</div><div class="diff-added">+// @ts-expect-error</div><div class="diff-added">+window.zero = () => {</div><div class="diff-added">+	setInLocalStorage('useProperZero', String(!useProperZero))</div><div class="diff-added">+	location.reload()</div><div class="diff-added">+}</div><div class="diff-added">+</div><div class="diff-added">+export class TldrawApp {</div><div class="diff-added">+	config = {</div><div class="diff-added">+		maxNumberOfFiles: MAX_NUMBER_OF_FILES,</div><div> 	}</div><div> </div><div class="diff-removed">-	private userQuery() {</div><div class="diff-removed">-		return this.z.query.user.where('id', '=', this.userId).one()</div><div class="diff-added">+	readonly id = appId++</div><div class="diff-added">+</div><div class="diff-added">+	readonly z: ZeroPolyfill | Zero<TlaSchema></div><div class="diff-added">+</div><div class="diff-added">+	private readonly user$: Signal<TlaUser | undefined></div><div class="diff-added">+	private readonly files$: Signal<TlaFile[]></div><div class="diff-added">+	private readonly fileStates$: Signal<(TlaFileState & { file: TlaFile })[]></div><div class="diff-added">+</div><div class="diff-added">+	private readonly abortController = new AbortController()</div><div class="diff-added">+	readonly disposables: (() => void)[] = [</div><div class="diff-added">+		() => this.abortController.abort(),</div><div class="diff-added">+		() => (this.z as any)?.dispose?.(),</div><div class="diff-added">+	]</div><div class="diff-added">+</div><div class="diff-added">+	private signalizeQuery<TReturn>(name: string, query: any): Signal<TReturn> {</div><div class="diff-added">+		// fail if closed?</div><div class="diff-added">+		const view = query.materialize()</div><div class="diff-added">+		const val$ = atom(name, view.data)</div><div class="diff-added">+		view.addListener((res: any) => {</div><div class="diff-added">+			val$.set(structuredClone(res) as any)</div><div class="diff-added">+		})</div><div class="diff-added">+		this.disposables.push(() => {</div><div class="diff-added">+			view.destroy()</div><div class="diff-added">+		})</div><div class="diff-added">+		return val$</div><div> 	}</div><div> </div><div class="diff-removed">-	private fileStateQuery() {</div><div class="diff-removed">-		return this.z.query.file_state</div><div class="diff-removed">-			.where('userId', '=', this.userId)</div><div class="diff-removed">-			.related('file', (q: any) => q.one())</div><div class="diff-added">+	toasts: TLUiToastsContextType | null = null</div><div class="diff-added">+</div><div class="diff-added">+	private constructor(</div><div class="diff-added">+		public readonly userId: string,</div><div class="diff-added">+		getToken: () => Promise<string | null>,</div><div class="diff-added">+		onClientTooOld: () => void,</div><div class="diff-added">+		trackEvent: TLAppUiContextType</div><div class="diff-added">+	) {</div><div class="diff-added">+		const sessionId = uniqueId()</div><div class="diff-added">+</div><div class="diff-added">+		if (useProperZero) {</div><div class="diff-added">+			// NOTE: experimental client; keep options in sync with Zero polyfill behavior where possible</div><div class="diff-added">+			this.z = new Zero<TlaSchema>({</div><div class="diff-added">+				server: ZERO_SERVER,</div><div class="diff-added">+				schema: zeroSchema,</div><div class="diff-added">+				userID: this.userId,</div><div class="diff-added">+				getAuth: async () => {</div><div class="diff-added">+					const token = await getToken()</div><div class="diff-added">+					return { accessToken: token || 'no-token-found' }</div><div class="diff-added">+				},</div><div class="diff-added">+				params: {</div><div class="diff-added">+					sessionId,</div><div class="diff-added">+					protocolVersion: String(Z_PROTOCOL_VERSION),</div><div class="diff-added">+				},</div><div class="diff-added">+				onMutationRejected: this.showMutationRejectionToast,</div><div class="diff-added">+				onClientTooOld: () => onClientTooOld(),</div><div class="diff-added">+				trackEvent,</div><div class="diff-added">+			} as any)</div><div class="diff-added">+		} else {</div><div class="diff-added">+			this.z = new ZeroPolyfill({</div><div class="diff-added">+				// userID: userId,</div><div class="diff-added">+				// auth: encodedJWT,</div><div class="diff-added">+				getUri: async () => {</div><div class="diff-added">+					const params = new URLSearchParams({</div><div class="diff-added">+						sessionId,</div><div class="diff-added">+						protocolVersion: String(Z_PROTOCOL_VERSION),</div><div class="diff-added">+					})</div><div class="diff-added">+					const token = await getToken()</div><div class="diff-added">+					params.set('accessToken', token || 'no-token-found')</div><div class="diff-added">+					return `${MULTIPLAYER_SERVER}/app/${this.userId}/connect?${params}`</div><div class="diff-added">+				},</div><div class="diff-added">+				// schema,</div><div class="diff-added">+				// This is often easier to develop with if you're frequently changing</div><div class="diff-added">+				// the schema. Switch to 'idb' for local-persistence.</div><div class="diff-added">+				onMutationRejected: this.showMutationRejectionToast,</div><div class="diff-added">+				onClientTooOld: () => onClientTooOld(),</div><div class="diff-added">+				trackEvent,</div><div class="diff-added">+			})</div><div class="diff-added">+		}</div><div class="diff-added">+</div><div class="diff-added">+		this.user$ = this.signalizeQuery(</div><div class="diff-added">+			'user signal',</div><div class="diff-added">+			(this.z as any).query.user.where('id', this.userId).one()</div><div class="diff-added">+		)</div><div class="diff-added">+		this.files$ = this.signalizeQuery(</div><div class="diff-added">+			'files signal',</div><div class="diff-added">+			(this.z as any).query.file.where('ownerId', this.userId)</div><div class="diff-added">+		)</div><div class="diff-added">+		this.fileStates$ = this.signalizeQuery(</div><div class="diff-added">+			'file states signal',</div><div class="diff-added">+			(this.z as any).query.file_state.where('userId', this.userId).related('file', (q: any) => q.one())</div><div class="diff-added">+		)</div><div> 	}</div><div> </div><div> 	async preload(initialUserData: TlaUser) {</div><div> 		let didCreate = false</div><div class="diff-removed">-		await this.userQuery().preload().complete</div><div class="diff-removed">-		await this.changesFlushed</div><div class="diff-added">+		await (this.z as any).query.user.where('id', this.userId).preload().complete</div><div> 		if (!this.user$.get()) {</div><div> 			didCreate = true</div><div class="diff-removed">-			this.z.mutate.user.insert(initialUserData)</div><div class="diff-added">+			;(this.z as any).mutate.user.create(initialUserData)</div><div> 			updateLocalSessionState((state) => ({ ...state, shouldShowWelcomeDialog: true }))</div><div> 		}</div><div> 		await new Promise((resolve) => {</div><div class="diff-info">@@ -188,7 +508,8 @@ export class TldrawApp {</div><div> 		if (!this.user$.get()) {</div><div> 			throw Error('could not create user')</div><div> 		}</div><div class="diff-removed">-		await this.fileStateQuery().preload().complete</div><div class="diff-added">+		await (this.z as any).query.file_state.where('userId', this.userId).preload().complete</div><div class="diff-added">+		await (this.z as any).query.file.where('ownerId', this.userId).preload().complete</div><div> 		return didCreate</div><div> 	}</div><div> </div><div class="diff-info">@@ -279,20 +600,17 @@ export class TldrawApp {</div><div> 				Object.entries(others).filter(([_, value]) => value !== null)</div><div> 			) as Partial<TLUserPreferences></div><div> </div><div class="diff-removed">-			this.z.mutate.user.update({</div><div class="diff-removed">-				id: user.id,</div><div class="diff-removed">-				...(nonNull as any),</div><div class="diff-added">+			;(this.z as any).mutate((tx: any) => {</div><div class="diff-added">+				tx.user.update({</div><div class="diff-added">+					id: user.id,</div><div class="diff-added">+					...(nonNull as any),</div><div class="diff-added">+				})</div><div> 			})</div><div> 		},</div><div> 	})</div><div> </div><div> 	getUserOwnFiles() {</div><div class="diff-removed">-		const fileStates = this.getUserFileStates()</div><div class="diff-removed">-		const files: TlaFile[] = []</div><div class="diff-removed">-		fileStates.forEach((f) => {</div><div class="diff-removed">-			if (f.file) files.push(f.file)</div><div class="diff-removed">-		})</div><div class="diff-removed">-		return files</div><div class="diff-added">+		return this.files$.get()</div><div> 	}</div><div> </div><div> 	getUserFileStates() {</div><div class="diff-info">@@ -320,14 +638,13 @@ export class TldrawApp {</div><div> </div><div> 		for (const fileId of myFileIds) {</div><div> 			const file = myFiles[fileId]</div><div class="diff-removed">-			let state: (typeof myStates)[string] | undefined = myStates[fileId]</div><div class="diff-added">+			let state = myStates[fileId]</div><div> 			if (!file) continue</div><div> 			if (!state && !file.isDeleted && file.ownerId === this.userId) {</div><div> 				// create a file state for this file</div><div> 				// this allows us to 'undelete' soft-deleted files by manually toggling 'isDeleted' in the backend</div><div class="diff-removed">-				state = this.fileStates$.get().find((fs) => fs.fileId === fileId)</div><div class="diff-removed">-			}</div><div class="diff-removed">-			if (!state) {</div><div class="diff-added">+				state = this.getOrCreateFileState(fileId)</div><div class="diff-added">+			} else if (!state) {</div><div> 				// if the file is deleted, we don't want to show it in the recent files</div><div> 				continue</div><div> 			}</div><div class="diff-info">@@ -372,19 +689,15 @@ export class TldrawApp {</div><div> 		return numberOfFiles < this.config.maxNumberOfFiles</div><div> 	}</div><div> </div><div class="diff-removed">-	private showMaxFilesToast() {</div><div class="diff-removed">-		this.toasts?.addToast({</div><div class="diff-removed">-			title: this.getIntl().formatMessage(this.messages.max_files_title),</div><div class="diff-removed">-			description: this.getIntl().formatMessage(this.messages.max_files_reached),</div><div class="diff-removed">-			keepOpen: true,</div><div class="diff-removed">-		})</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	async createFile(</div><div class="diff-added">+	createFile(</div><div> 		fileOrId?: string | Partial<TlaFile></div><div class="diff-removed">-	): Promise<Result<{ file: TlaFile }, 'max number of files reached'>> {</div><div class="diff-added">+	): Result<{ file: TlaFile }, 'max number of files reached'> {</div><div> 		if (!this.canCreateNewFile()) {</div><div class="diff-removed">-			this.showMaxFilesToast()</div><div class="diff-added">+			this.toasts?.addToast({</div><div class="diff-added">+				title: this.getIntl().formatMessage(this.messages.max_files_title),</div><div class="diff-added">+				description: this.getIntl().formatMessage(this.messages.max_files_reached),</div><div class="diff-added">+				keepOpen: true,</div><div class="diff-added">+			})</div><div> 			return Result.err('max number of files reached')</div><div> 		}</div><div> </div><div class="diff-info">@@ -413,23 +726,19 @@ export class TldrawApp {</div><div> 				Object.assign(file, { name: this.getFallbackFileName(file.createdAt) })</div><div> 			}</div><div> 		}</div><div class="diff-removed">-		const fileState = {</div><div class="diff-removed">-			isFileOwner: true,</div><div class="diff-removed">-			fileId: file.id,</div><div class="diff-removed">-			userId: this.userId,</div><div class="diff-removed">-			firstVisitAt: null,</div><div class="diff-removed">-			isPinned: false,</div><div class="diff-removed">-			lastEditAt: null,</div><div class="diff-removed">-			lastSessionState: null,</div><div class="diff-removed">-			lastVisitAt: null,</div><div class="diff-removed">-		}</div><div class="diff-removed">-		await this.z.mutate.file.insertWithFileState({ file, fileState })</div><div class="diff-removed">-		// todo: add server error handling for real Zero</div><div class="diff-removed">-		// .server.catch((res: { error: string; details: string }) => {</div><div class="diff-removed">-		// 	if (res.details === ZErrorCode.max_files_reached) {</div><div class="diff-removed">-		// 		this.showMaxFilesToast()</div><div class="diff-removed">-		// 	}</div><div class="diff-removed">-		// })</div><div class="diff-added">+		;(this.z as any).mutate((tx: any) => {</div><div class="diff-added">+			tx.file.create(file)</div><div class="diff-added">+			tx.file_state.create({</div><div class="diff-added">+				isFileOwner: true,</div><div class="diff-added">+				fileId: file.id,</div><div class="diff-added">+				userId: this.userId,</div><div class="diff-added">+				firstVisitAt: null,</div><div class="diff-added">+				isPinned: false,</div><div class="diff-added">+				lastEditAt: null,</div><div class="diff-added">+				lastSessionState: null,</div><div class="diff-added">+				lastVisitAt: null,</div><div class="diff-added">+			})</div><div class="diff-added">+		})</div><div> </div><div> 		return Result.ok({ file })</div><div> 	}</div><div class="diff-info">@@ -468,15 +777,14 @@ export class TldrawApp {</div><div> 		return</div><div> 	}</div><div> </div><div class="diff-removed">-	async slurpFile() {</div><div class="diff-removed">-		return await this.createFile({</div><div class="diff-removed">-			createSource: `${LOCAL_FILE_PREFIX}/${getScratchPersistenceKey()}`,</div><div class="diff-removed">-		})</div><div class="diff-added">+	claimTemporaryFile(fileId: string) {</div><div class="diff-added">+		// removed; replaced by slurpFile</div><div> 	}</div><div> </div><div class="diff-removed">-	getFilePk(fileId: string) {</div><div class="diff-removed">-		const file = this.getFile(fileId)</div><div class="diff-removed">-		return { id: fileId, ownerId: file!.ownerId, publishedSlug: file!.publishedSlug }</div><div class="diff-added">+	slurpFile() {</div><div class="diff-added">+		return this.createFile({</div><div class="diff-added">+			createSource: `${LOCAL_FILE_PREFIX}/${getScratchPersistenceKey()}`,</div><div class="diff-added">+		})</div><div> 	}</div><div> </div><div> 	toggleFileShared(fileId: string) {</div><div class="diff-info">@@ -485,9 +793,11 @@ export class TldrawApp {</div><div> </div><div> 		if (file.ownerId !== this.userId) throw Error('user cannot edit that file')</div><div> </div><div class="diff-removed">-		this.z.mutate.file.update({</div><div class="diff-removed">-			id: fileId,</div><div class="diff-removed">-			shared: !file.shared,</div><div class="diff-added">+		;(this.z as any).mutate((tx: any) => {</div><div class="diff-added">+			tx.file.update({</div><div class="diff-added">+				id: fileId,</div><div class="diff-added">+				shared: !file.shared,</div><div class="diff-added">+			})</div><div> 		})</div><div> 	}</div><div> </div><div class="diff-info">@@ -506,11 +816,13 @@ export class TldrawApp {</div><div> 		const name = this.getFileName(file)</div><div> </div><div> 		// Optimistic update</div><div class="diff-removed">-		this.z.mutate.file.update({</div><div class="diff-removed">-			id: fileId,</div><div class="diff-removed">-			name,</div><div class="diff-removed">-			published: true,</div><div class="diff-removed">-			lastPublished: Date.now(),</div><div class="diff-added">+		;(this.z as any).mutate((tx: any) => {</div><div class="diff-added">+			tx.file.update({</div><div class="diff-added">+				id: fileId,</div><div class="diff-added">+				name,</div><div class="diff-added">+				published: true,</div><div class="diff-added">+				lastPublished: Date.now(),</div><div class="diff-added">+			})</div><div> 		})</div><div> 	}</div><div> </div><div class="diff-info">@@ -528,6 +840,11 @@ export class TldrawApp {</div><div> 		return assertExists(this.getFile(fileId), 'no file with id ' + fileId)</div><div> 	}</div><div> </div><div class="diff-added">+	updateFile(partial: TlaFilePartial) {</div><div class="diff-added">+		this.requireFile(partial.id)</div><div class="diff-added">+		;(this.z as any).mutate.file.update(partial)</div><div class="diff-added">+	}</div><div class="diff-added">+</div><div> 	/**</div><div> 	 * Unpublish a file.</div><div> 	 *</div><div class="diff-info">@@ -541,9 +858,11 @@ export class TldrawApp {</div><div> 		if (!file.published) return Result.ok('success')</div><div> </div><div> 		// Optimistic update</div><div class="diff-removed">-		this.z.mutate.file.update({</div><div class="diff-removed">-			id: fileId,</div><div class="diff-removed">-			published: false,</div><div class="diff-added">+		;(this.z as any).mutate((tx: any) => {</div><div class="diff-added">+			tx.file.update({</div><div class="diff-added">+				id: fileId,</div><div class="diff-added">+				published: false,</div><div class="diff-added">+			})</div><div> 		})</div><div> </div><div> 		return Result.ok('success')</div><div class="diff-info">@@ -556,10 +875,14 @@ export class TldrawApp {</div><div> 	 */</div><div> 	async deleteOrForgetFile(fileId: string) {</div><div> 		const file = this.getFile(fileId)</div><div class="diff-removed">-		if (!file) return</div><div> </div><div> 		// Optimistic update, remove file and file states</div><div class="diff-removed">-		await this.z.mutate.file.deleteOrForget(file)</div><div class="diff-added">+		return (this.z as any).mutate((tx: any) => {</div><div class="diff-added">+			tx.file_state.delete({ fileId, userId: this.userId })</div><div class="diff-added">+			if (file?.ownerId === this.userId) {</div><div class="diff-added">+				tx.file.update({ id: fileId, isDeleted: true })</div><div class="diff-added">+			}</div><div class="diff-added">+		})</div><div> 	}</div><div> </div><div> 	/**</div><div class="diff-info">@@ -572,7 +895,7 @@ export class TldrawApp {</div><div> </div><div> 		if (!fileState) return</div><div> </div><div class="diff-removed">-		return this.z.mutate.file_state.update({</div><div class="diff-added">+		return (this.z as any).mutate.file_state.update({</div><div> 			fileId,</div><div> 			userId: this.userId,</div><div> 			isPinned: !fileState.isPinned,</div><div class="diff-info">@@ -587,15 +910,15 @@ export class TldrawApp {</div><div> 		}</div><div> </div><div> 		if (sharedLinkType === 'no-access') {</div><div class="diff-removed">-			this.z.mutate.file.update({ id: fileId, shared: false })</div><div class="diff-added">+			;(this.z as any).mutate.file.update({ id: fileId, shared: false })</div><div> 			return</div><div> 		}</div><div class="diff-removed">-		this.z.mutate.file.update({ id: fileId, shared: true, sharedLinkType })</div><div class="diff-added">+		;(this.z as any).mutate.file.update({ id: fileId, shared: true, sharedLinkType })</div><div> 	}</div><div> </div><div> 	updateUser(partial: Partial<TlaUser>) {</div><div> 		const user = this.getUser()</div><div class="diff-removed">-		return this.z.mutate.user.update({</div><div class="diff-added">+		;(this.z as any).mutate.user.update({</div><div> 			id: user.id,</div><div> 			...partial,</div><div> 		})</div><div class="diff-info">@@ -607,26 +930,23 @@ export class TldrawApp {</div><div> 		></div><div> 	) {</div><div> 		this.updateUser(exportPreferences)</div><div class="diff-removed">-	}</div><div class="diff-added">+ 	}</div><div> </div><div class="diff-removed">-	async createFileStateIfNotExists(fileId: string) {</div><div class="diff-removed">-		await this.changesFlushed</div><div class="diff-removed">-		const fileState = this.getFileState(fileId)</div><div class="diff-added">+	getOrCreateFileState(fileId: string) {</div><div class="diff-added">+		let fileState = this.getFileState(fileId)</div><div> 		if (!fileState) {</div><div class="diff-removed">-			const fs: TlaFileState = {</div><div class="diff-added">+			;(this.z as any).mutate.file_state.create({</div><div> 				fileId,</div><div> 				userId: this.userId,</div><div> 				firstVisitAt: Date.now(),</div><div> 				lastEditAt: null,</div><div> 				lastSessionState: null,</div><div> 				lastVisitAt: null,</div><div class="diff-removed">-				isPinned: false,</div><div class="diff-removed">-				// doesn't really matter what this is because it is</div><div class="diff-removed">-				// overwritten by postgres</div><div class="diff-removed">-				isFileOwner: this.isFileOwner(fileId),</div><div class="diff-removed">-			}</div><div class="diff-removed">-			this.z.mutate.file_state.insert(fs)</div><div class="diff-added">+			})</div><div> 		}</div><div class="diff-added">+		fileState = this.getFileState(fileId)</div><div class="diff-added">+		if (!fileState) throw Error('could not create file state')</div><div class="diff-added">+		return fileState</div><div> 	}</div><div> </div><div> 	getFileState(fileId: string) {</div><div class="diff-info">@@ -636,15 +956,11 @@ export class TldrawApp {</div><div> 	updateFileState(fileId: string, partial: Partial<TlaFileState>) {</div><div> 		const fileState = this.getFileState(fileId)</div><div> 		if (!fileState) return</div><div class="diff-removed">-		this.z.mutate.file_state.update({ ...partial, fileId, userId: fileState.userId })</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	updateFile(fileId: string, partial: Partial<TlaFile>) {</div><div class="diff-removed">-		this.z.mutate.file.update({ id: fileId, ...partial })</div><div class="diff-added">+		;(this.z as any).mutate.file_state.update({ ...partial, fileId, userId: fileState.userId })</div><div> 	}</div><div> </div><div class="diff-removed">-	async onFileEnter(fileId: string) {</div><div class="diff-removed">-		await this.createFileStateIfNotExists(fileId)</div><div class="diff-added">+	onFileEnter(fileId: string) {</div><div class="diff-added">+		this.getOrCreateFileState(fileId)</div><div> 		this.updateFileState(fileId, {</div><div> 			lastVisitAt: Date.now(),</div><div> 		})</div><div class="diff-info">@@ -670,7 +986,7 @@ export class TldrawApp {</div><div> 		fullName: string</div><div> 		email: string</div><div> 		avatar: string</div><div class="diff-removed">-		getToken(): Promise<string | undefined></div><div class="diff-added">+		getToken(): Promise<string | null></div><div> 		onClientTooOld(): void</div><div> 		trackEvent: TLAppUiContextType</div><div> 	}) {</div><div class="diff-info">@@ -754,7 +1070,6 @@ export class TldrawApp {</div><div> 					total: totalFiles,</div><div> 					uploaded: uploadedFiles,</div><div> 				}),</div><div class="diff-removed">-</div><div> 				description: `${getApproxPercentage()}%`,</div><div> 				keepOpen: true,</div><div> 			})</div><div></div></pre>
                </div>
            </div>
        </section>
    </main>
    <footer>
        <p>LoCoDiff-bench - <a href="https://github.com/AbanteAI/LoCoDiff-bench">GitHub Repository</a></p>
    </footer>
</body>
</html>
    