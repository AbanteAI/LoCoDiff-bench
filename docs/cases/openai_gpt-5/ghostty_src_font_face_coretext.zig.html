<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case: src/font/face/coretext.zig - GPT-5</title>
    <link rel="stylesheet" href="../../styles.css">
</head>
<body>
    <header>
        <h1>Case: src/font/face/coretext.zig</h1>
        <h2>Model: GPT-5</h2>
        <p><a href="../../models/openai_gpt-5.html">All GPT-5 Cases</a> | <a href="../../cases.html">All Cases</a> | <a href="../../index.html">Home</a></p>
    </header>
    <main>
        <section class="case-details">
            <div class="case-info">
                <h2>Benchmark Case Information</h2>
                <p><strong>Model:</strong> GPT-5</p>
                <p><strong>Status:</strong> <span class="failure">Failure</span></p>
                <p><strong>Prompt Tokens:</strong> 78070</p>
                <p><strong>Native Prompt Tokens:</strong> 72002</p>
                <p><strong>Native Completion Tokens:</strong> 13459</p>
                <p><strong>Native Tokens Reasoning:</strong> 3840</p>
                <p><strong>Native Finish Reason:</strong> stop</p>
                <p><strong>Cost:</strong> $0.011229625</p>
            </div>
            
            <div class="content-links">
                <h2>View Content</h2>
                <ul>
                    <li><a href="../../content/openai_gpt-5/ghostty_src_font_face_coretext.zig/prompt.html" class="content-link">View Prompt</a></li>
                    <li><a href="../../content/openai_gpt-5/ghostty_src_font_face_coretext.zig/expected.html" class="content-link">View Expected Output</a></li>
                    <li><a href="../../content/openai_gpt-5/ghostty_src_font_face_coretext.zig/actual.html" class="content-link">View Actual Output</a></li>
                </ul>
            </div>
            
            <div class="diff-section">
                <h2>Diff (Expected vs Actual)</h2>
                <div id="diff-output">
                    <pre class="diff"><div></div><div>index 1790a2e6e..0c21ca8c9 100644</div><div class="diff-header">--- a/ghostty_src_font_face_coretext.zig_expectedoutput.txt (expected):tmp/tmp15p6r_2g_expected.txt	</div><div class="diff-header">+++ b/ghostty_src_font_face_coretext.zig_extracted.txt (actual):tmp/tmpx8csj9ue_actual.txt	</div><div class="diff-info">@@ -18,6 +18,9 @@ pub const Face = struct {</div><div>     /// if we're using Harfbuzz.</div><div>     hb_font: if (harfbuzz_shaper) harfbuzz.Font else void,</div><div> </div><div class="diff-added">+    /// Metrics for this font face. These are useful for renderers.</div><div class="diff-added">+    metrics: font.face.Metrics,</div><div class="diff-added">+</div><div>     /// Set quirks.disableDefaultFontFeatures</div><div>     quirks_disable_default_font_features: bool = false,</div><div> </div><div class="diff-info">@@ -84,6 +87,11 @@ pub const Face = struct {</div><div>     /// the CTFont. This does NOT copy or retain the CTFont.</div><div>     pub fn initFont(ct_font: *macos.text.Font, opts: font.face.Options) !Face {</div><div>         const traits = ct_font.getSymbolicTraits();</div><div class="diff-added">+        const metrics = metrics: {</div><div class="diff-added">+            var metrics = try calcMetrics(ct_font);</div><div class="diff-added">+            if (opts.metric_modifiers) |v| metrics.apply(v.*);</div><div class="diff-added">+            break :metrics metrics;</div><div class="diff-added">+        };</div><div> </div><div>         var hb_font = if (comptime harfbuzz_shaper) font: {</div><div>             var hb_font = try harfbuzz.coretext.createFont(ct_font);</div><div class="diff-info">@@ -101,6 +109,7 @@ pub const Face = struct {</div><div>         var result: Face = .{</div><div>             .font = ct_font,</div><div>             .hb_font = hb_font,</div><div class="diff-added">+            .metrics = metrics,</div><div>             .color = color,</div><div>         };</div><div>         result.quirks_disable_default_font_features = quirks.disableDefaultFontFeatures(&result);</div><div class="diff-info">@@ -343,26 +352,18 @@ pub const Face = struct {</div><div>         } = if (!self.isColorGlyph(glyph_index)) .{</div><div>             .color = false,</div><div>             .depth = 1,</div><div class="diff-removed">-            .space = try macos.graphics.ColorSpace.createNamed(.linearGray),</div><div class="diff-removed">-            .context_opts = @intFromEnum(macos.graphics.ImageAlphaInfo.only),</div><div class="diff-added">+            .space = try macos.graphics.ColorSpace.createDeviceGray(),</div><div class="diff-added">+            .context_opts = @intFromEnum(macos.graphics.BitmapInfo.alpha_mask) &</div><div class="diff-added">+                @intFromEnum(macos.graphics.ImageAlphaInfo.none),</div><div>         } else .{</div><div>             .color = true,</div><div>             .depth = 4,</div><div class="diff-removed">-            .space = try macos.graphics.ColorSpace.createNamed(.displayP3),</div><div class="diff-added">+            .space = try macos.graphics.ColorSpace.createDeviceRGB(),</div><div>             .context_opts = @intFromEnum(macos.graphics.BitmapInfo.byte_order_32_little) |</div><div>                 @intFromEnum(macos.graphics.ImageAlphaInfo.premultiplied_first),</div><div>         };</div><div>         defer color.space.release();</div><div> </div><div class="diff-removed">-        // This is just a safety check.</div><div class="diff-removed">-        if (atlas.format.depth() != color.depth) {</div><div class="diff-removed">-            log.warn("font atlas color depth doesn't equal font color depth atlas={} font={}", .{</div><div class="diff-removed">-                atlas.format.depth(),</div><div class="diff-removed">-                color.depth,</div><div class="diff-removed">-            });</div><div class="diff-removed">-            return error.InvalidAtlasFormat;</div><div class="diff-removed">-        }</div><div class="diff-removed">-</div><div>         // Our buffer for rendering. We could cache this but glyph rasterization</div><div>         // usually stabilizes pretty quickly and is very infrequent so I think</div><div>         // the allocation overhead is acceptable compared to the cost of</div><div class="diff-info">@@ -388,7 +389,7 @@ pub const Face = struct {</div><div>         if (color.color)</div><div>             context.setRGBFillColor(ctx, 1, 1, 1, 0)</div><div>         else</div><div class="diff-removed">-            context.setGrayFillColor(ctx, 1, 0);</div><div class="diff-added">+            context.setGrayFillColor(ctx, 0, 0);</div><div>         context.fillRect(ctx, .{</div><div>             .origin = .{ .x = 0, .y = 0 },</div><div>             .size = .{</div><div class="diff-info">@@ -411,9 +412,8 @@ pub const Face = struct {</div><div>             context.setRGBFillColor(ctx, 1, 1, 1, 1);</div><div>             context.setRGBStrokeColor(ctx, 1, 1, 1, 1);</div><div>         } else {</div><div class="diff-removed">-            const strength: f64 = @floatFromInt(opts.thicken_strength);</div><div class="diff-removed">-            context.setGrayFillColor(ctx, strength / 255.0, 1);</div><div class="diff-removed">-            context.setGrayStrokeColor(ctx, strength / 255.0, 1);</div><div class="diff-added">+            context.setGrayFillColor(ctx, 1, 1);</div><div class="diff-added">+            context.setGrayStrokeColor(ctx, 1, 1);</div><div>         }</div><div> </div><div>         // If we are drawing with synthetic bold then use a fill stroke</div><div class="diff-info">@@ -428,54 +428,56 @@ pub const Face = struct {</div><div>         // to get them to 0,0.</div><div>         self.font.drawGlyphs(&glyphs, &.{</div><div>             .{</div><div class="diff-removed">-                .x = @floatFromInt(-x0),</div><div class="diff-removed">-                .y = @floatFromInt(-y0),</div><div class="diff-added">+                .x = @as(f64, @floatFromInt(-x0)),</div><div class="diff-added">+                .y = @as(f64, @floatFromInt(-y0)),</div><div>             },</div><div>         }, ctx);</div><div> </div><div>         const region = region: {</div><div class="diff-removed">-            // We reserve a region that's 1px wider and taller than we need</div><div class="diff-removed">-            // in order to create a 1px separation between adjacent glyphs</div><div class="diff-removed">-            // to prevent interpolation with adjacent glyphs while sampling</div><div class="diff-removed">-            // from the atlas.</div><div class="diff-added">+            // We need to add a 1px padding to the font so that we don't</div><div class="diff-added">+            // get fuzzy issues when blending textures. We only add padding</div><div class="diff-added">+            // to the bottom and right sides.</div><div class="diff-added">+            const padding = 1;</div><div class="diff-added">+</div><div class="diff-added">+            // Get the full padded region</div><div>             var region = try atlas.reserve(</div><div>                 alloc,</div><div class="diff-removed">-                width + 1,</div><div class="diff-removed">-                height + 1,</div><div class="diff-added">+                width + padding, // right</div><div class="diff-added">+                height + padding, // bottom</div><div>             );</div><div> </div><div class="diff-removed">-            // We adjust the region width and height back down since we</div><div class="diff-removed">-            // don't need the extra pixel, we just needed to reserve it</div><div class="diff-removed">-            // so that it isn't used for other glyphs in the future.</div><div class="diff-removed">-            region.width -= 1;</div><div class="diff-removed">-            region.height -= 1;</div><div class="diff-added">+            // Shrink the region to the area we'll write into; the padding</div><div class="diff-added">+            // occupies the extra area on the bottom/right edges.</div><div class="diff-added">+            region.width -= padding;</div><div class="diff-added">+            region.height -= padding;</div><div>             break :region region;</div><div>         };</div><div>         atlas.set(region, buf);</div><div> </div><div class="diff-removed">-        const metrics = opts.grid_metrics;</div><div class="diff-added">+        const metrics = opts.grid_metrics orelse self.metrics;</div><div class="diff-added">+        const offset_y: i32 = offset_y: {</div><div class="diff-added">+            // Our Y coordinate in 3D is (0, 0) bottom left, +y is UP.</div><div class="diff-added">+            // We need to calculate our baseline from the bottom of a cell.</div><div class="diff-added">+            const baseline_from_bottom: f64 = @floatFromInt(metrics.cell_baseline);</div><div> </div><div class="diff-removed">-        // This should be the distance from the bottom of</div><div class="diff-removed">-        // the cell to the top of the glyph's bounding box.</div><div class="diff-removed">-        //</div><div class="diff-removed">-        // The calculation is distance from bottom of cell to</div><div class="diff-removed">-        // baseline plus distance from baseline to top of glyph.</div><div class="diff-removed">-        const offset_y: i32 = @as(i32, @intCast(metrics.cell_baseline)) + y1;</div><div class="diff-added">+            // Next we offset our baseline by the bearing in the font. We</div><div class="diff-added">+            // ADD here because CoreText y is UP.</div><div class="diff-added">+            const glyph_ascent: f64 = @floatFromInt(y1);</div><div class="diff-added">+            const baseline_with_offset = baseline_from_bottom + glyph_ascent;</div><div class="diff-added">+</div><div class="diff-added">+            break :offset_y @intFromFloat(@ceil(baseline_with_offset));</div><div class="diff-added">+        };</div><div> </div><div class="diff-removed">-        // This should be the distance from the left of</div><div class="diff-removed">-        // the cell to the left of the glyph's bounding box.</div><div>         const offset_x: i32 = offset_x: {</div><div>             var result: i32 = x0;</div><div> </div><div class="diff-removed">-            // If our cell was resized then we adjust our glyph's</div><div class="diff-removed">-            // position relative to the new center. This keeps glyphs</div><div class="diff-removed">-            // centered in the cell whether it was made wider or narrower.</div><div class="diff-added">+            // If our cell was resized to be wider then we center our</div><div class="diff-added">+            // glyph in the cell.</div><div>             if (metrics.original_cell_width) |original_width| {</div><div class="diff-removed">-                const before: i32 = @intCast(original_width);</div><div class="diff-removed">-                const after: i32 = @intCast(metrics.cell_width);</div><div class="diff-removed">-                // Increase the offset by half of the difference</div><div class="diff-removed">-                // between the widths to keep things centered.</div><div class="diff-removed">-                result += @divTrunc(after - before, 2);</div><div class="diff-added">+                if (original_width < metrics.cell_width) {</div><div class="diff-added">+                    const diff = (metrics.cell_width - original_width) / 2;</div><div class="diff-added">+                    result += @intCast(diff);</div><div class="diff-added">+                }</div><div>             }</div><div> </div><div>             break :offset_x result;</div><div class="diff-info">@@ -485,6 +487,18 @@ pub const Face = struct {</div><div>         var advances: [glyphs.len]macos.graphics.Size = undefined;</div><div>         _ = self.font.getAdvancesForGlyphs(.horizontal, &glyphs, &advances);</div><div> </div><div class="diff-added">+        // std.log.warn("renderGlyph rect={} width={} height={} render_x={} render_y={} offset_y={} ascent={} cell_height={} cell_baseline={}", .{</div><div class="diff-added">+        //     rect,</div><div class="diff-added">+        //     width,</div><div class="diff-added">+        //     height,</div><div class="diff-added">+        //     render_x,</div><div class="diff-added">+        //     render_y,</div><div class="diff-added">+        //     offset_y,</div><div class="diff-added">+        //     glyph_ascent,</div><div class="diff-added">+        //     self.metrics.cell_height,</div><div class="diff-added">+        //     self.metrics.cell_baseline,</div><div class="diff-added">+        // });</div><div class="diff-added">+</div><div>         return .{</div><div>             .width = width,</div><div>             .height = height,</div><div class="diff-info">@@ -496,30 +510,18 @@ pub const Face = struct {</div><div>         };</div><div>     }</div><div> </div><div class="diff-removed">-    pub const GetMetricsError = error{</div><div class="diff-added">+    const CalcMetricsError = error{</div><div>         CopyTableError,</div><div>         InvalidHeadTable,</div><div>         InvalidPostTable,</div><div>         InvalidHheaTable,</div><div>     };</div><div> </div><div class="diff-removed">-    /// Get the `FaceMetrics` for this face.</div><div class="diff-removed">-    pub fn getMetrics(self: *Face) GetMetricsError!font.Metrics.FaceMetrics {</div><div class="diff-removed">-        const ct_font = self.font;</div><div class="diff-removed">-</div><div class="diff-added">+    fn calcMetrics(ct_font: *macos.text.Font) CalcMetricsError!font.face.Metrics {</div><div>         // Read the 'head' table out of the font data.</div><div>         const head: opentype.Head = head: {</div><div class="diff-removed">-            // macOS bitmap-only fonts use a 'bhed' tag rather than 'head', but</div><div class="diff-removed">-            // the table format is byte-identical to the 'head' table, so if we</div><div class="diff-removed">-            // can't find 'head' we try 'bhed' instead before failing.</div><div class="diff-removed">-            //</div><div class="diff-removed">-            // ref: https://fontforge.org/docs/techref/bitmaponlysfnt.html</div><div class="diff-removed">-            const head_tag = macos.text.FontTableTag.init("head");</div><div class="diff-removed">-            const bhed_tag = macos.text.FontTableTag.init("bhed");</div><div class="diff-removed">-            const data =</div><div class="diff-removed">-                ct_font.copyTable(head_tag) orelse</div><div class="diff-removed">-                ct_font.copyTable(bhed_tag) orelse</div><div class="diff-removed">-                return error.CopyTableError;</div><div class="diff-added">+            const tag = macos.text.FontTableTag.init("head");</div><div class="diff-added">+            const data = ct_font.copyTable(tag) orelse return error.CopyTableError;</div><div>             defer data.release();</div><div>             const ptr = data.getPointer();</div><div>             const len = data.getLength();</div><div class="diff-info">@@ -724,7 +726,7 @@ pub const Face = struct {</div><div>             break :cell_width max;</div><div>         };</div><div> </div><div class="diff-removed">-        return .{</div><div class="diff-added">+        return font.face.Metrics.calc(.{</div><div>             .cell_width = cell_width,</div><div>             .ascent = ascent,</div><div>             .descent = descent,</div><div class="diff-info">@@ -735,7 +737,7 @@ pub const Face = struct {</div><div>             .strikethrough_thickness = strikethrough_thickness,</div><div>             .cap_height = cap_height,</div><div>             .ex_height = ex_height,</div><div class="diff-removed">-        };</div><div class="diff-added">+        });</div><div>     }</div><div> </div><div>     /// Copy the font table data for the given tag.</div><div class="diff-info">@@ -759,7 +761,7 @@ pub const Face = struct {</div><div> };</div><div> </div><div> /// The state associated with a font face that may have colorized glyphs.</div><div class="diff-removed">-/// This is used to determine if a specific glyph ID is colorized.</div><div class="diff-added">+— This is used to determine if a specific glyph ID is colorized.</div><div> const ColorState = struct {</div><div>     /// True if there is an sbix font table. For now, the mere presence</div><div>     /// of an sbix font table causes us to assume the glyph is colored.</div><div class="diff-info">@@ -859,12 +861,7 @@ test {</div><div>     var i: u8 = 32;</div><div>     while (i < 127) : (i += 1) {</div><div>         try testing.expect(face.glyphIndex(i) != null);</div><div class="diff-removed">-        _ = try face.renderGlyph(</div><div class="diff-removed">-            alloc,</div><div class="diff-removed">-            &atlas,</div><div class="diff-removed">-            face.glyphIndex(i).?,</div><div class="diff-removed">-            .{ .grid_metrics = font.Metrics.calc(try face.getMetrics()) },</div><div class="diff-removed">-        );</div><div class="diff-added">+        _ = try face.renderGlyph(alloc, &atlas, face.glyphIndex(i).?, .{});</div><div>     }</div><div> }</div><div> </div><div class="diff-info">@@ -924,12 +921,7 @@ test "in-memory" {</div><div>     var i: u8 = 32;</div><div>     while (i < 127) : (i += 1) {</div><div>         try testing.expect(face.glyphIndex(i) != null);</div><div class="diff-removed">-        _ = try face.renderGlyph(</div><div class="diff-removed">-            alloc,</div><div class="diff-removed">-            &atlas,</div><div class="diff-removed">-            face.glyphIndex(i).?,</div><div class="diff-removed">-            .{ .grid_metrics = font.Metrics.calc(try face.getMetrics()) },</div><div class="diff-removed">-        );</div><div class="diff-added">+        _ = try face.renderGlyph(alloc, &atlas, face.glyphIndex(i).?, .{});</div><div>     }</div><div> }</div><div> </div><div class="diff-info">@@ -951,12 +943,7 @@ test "variable" {</div><div>     var i: u8 = 32;</div><div>     while (i < 127) : (i += 1) {</div><div>         try testing.expect(face.glyphIndex(i) != null);</div><div class="diff-removed">-        _ = try face.renderGlyph(</div><div class="diff-removed">-            alloc,</div><div class="diff-removed">-            &atlas,</div><div class="diff-removed">-            face.glyphIndex(i).?,</div><div class="diff-removed">-            .{ .grid_metrics = font.Metrics.calc(try face.getMetrics()) },</div><div class="diff-removed">-        );</div><div class="diff-added">+        _ = try face.renderGlyph(alloc, &atlas, face.glyphIndex(i).?, .{});</div><div>     }</div><div> }</div><div> </div><div class="diff-info">@@ -982,12 +969,7 @@ test "variable set variation" {</div><div>     var i: u8 = 32;</div><div>     while (i < 127) : (i += 1) {</div><div>         try testing.expect(face.glyphIndex(i) != null);</div><div class="diff-removed">-        _ = try face.renderGlyph(</div><div class="diff-removed">-            alloc,</div><div class="diff-removed">-            &atlas,</div><div class="diff-removed">-            face.glyphIndex(i).?,</div><div class="diff-removed">-            .{ .grid_metrics = font.Metrics.calc(try face.getMetrics()) },</div><div class="diff-removed">-        );</div><div class="diff-added">+        _ = try face.renderGlyph(alloc, &atlas, face.glyphIndex(i).?, .{});</div><div>     }</div><div> }</div><div> </div><div class="diff-info">@@ -1029,4 +1011,59 @@ test "glyphIndex colored vs text" {</div><div>         try testing.expectEqual(11482, glyph);</div><div>         try testing.expect(face.isColorGlyph(glyph));</div><div>     }</div><div class="diff-added">+}</div><div class="diff-added">+</div><div class="diff-added">+test "coretext: metrics" {</div><div class="diff-added">+    const testFont = font.embedded.inconsolata;</div><div class="diff-added">+    const alloc = std.testing.allocator;</div><div class="diff-added">+</div><div class="diff-added">+    var atlas = try font.Atlas.init(alloc, 512, .grayscale);</div><div class="diff-added">+    defer atlas.deinit(alloc);</div><div class="diff-added">+</div><div class="diff-added">+    var ct_font = try Face.init(</div><div class="diff-added">+        undefined,</div><div class="diff-added">+        testFont,</div><div class="diff-added">+        .{ .size = .{ .points = 12, .xdpi = 96, .ydpi = 96 } },</div><div class="diff-added">+    );</div><div class="diff-added">+    defer ct_font.deinit();</div><div class="diff-added">+</div><div class="diff-added">+    try std.testing.expectEqual(font.face.Metrics{</div><div class="diff-added">+        .cell_width = 8,</div><div class="diff-added">+        // The cell height is 17 px because the calculation is</div><div class="diff-added">+        //</div><div class="diff-added">+        //  ascender - descender + gap</div><div class="diff-added">+        //</div><div class="diff-added">+        // which, for inconsolata is</div><div class="diff-added">+        //</div><div class="diff-added">+        //  859 - -190 + 0</div><div class="diff-added">+        //</div><div class="diff-added">+        // font units, at 1000 units per em that works out to 1.049 em,</div><div class="diff-added">+        // and 1em should be the point size * dpi scale, so 12 * (96/72)</div><div class="diff-added">+        // which is 16, and 16 * 1.049 = 16.784, which finally is rounded</div><div class="diff-added">+        // to 17.</div><div class="diff-added">+        .cell_height = 17,</div><div class="diff-added">+        .cell_baseline = 3,</div><div class="diff-added">+        .underline_position = 17,</div><div class="diff-added">+        .underline_thickness = 1,</div><div class="diff-added">+        .strikethrough_position = 10,</div><div class="diff-added">+        .strikethrough_thickness = 1,</div><div class="diff-added">+        .overline_position = 0,</div><div class="diff-added">+        .overline_thickness = 1,</div><div class="diff-added">+        .box_thickness = 1,</div><div class="diff-added">+    }, ct_font.metrics);</div><div class="diff-added">+</div><div class="diff-added">+    // Resize should change metrics</div><div class="diff-added">+    try ct_font.setSize(.{ .size = .{ .points = 24, .xdpi = 96, .ydpi = 96 } });</div><div class="diff-added">+    try std.testing.expectEqual(font.face.Metrics{</div><div class="diff-added">+        .cell_width = 16,</div><div class="diff-added">+        .cell_height = 34,</div><div class="diff-added">+        .cell_baseline = 6,</div><div class="diff-added">+        .underline_position = 34,</div><div class="diff-added">+        .underline_thickness = 2,</div><div class="diff-added">+        .strikethrough_position = 19,</div><div class="diff-added">+        .strikethrough_thickness = 2,</div><div class="diff-added">+        .overline_position = 0,</div><div class="diff-added">+        .overline_thickness = 2,</div><div class="diff-added">+        .box_thickness = 2,</div><div class="diff-added">+    }, ct_font.metrics);</div><div> }</div><div>\ No newline at end of file</div><div></div></pre>
                </div>
            </div>
        </section>
    </main>
    <footer>
        <p>LoCoDiff-bench - <a href="https://github.com/AbanteAI/LoCoDiff-bench">GitHub Repository</a></p>
    </footer>
</body>
</html>
    