<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case: src/terminal/Parser.zig - o4-mini-high</title>
    <link rel="stylesheet" href="../../styles.css">
</head>
<body>
    <header>
        <h1>Case: src/terminal/Parser.zig</h1>
        <p><a href="../../models/openai_o4-mini-high.html">‚Üê Back to o4-mini-high Cases</a> | <a href="../../index.html">Home</a></p>
    </header>
    <main>
        <section class="case-details">
            <div class="case-info">
                <h2>Benchmark Case Information</h2>
                <p><strong>Model:</strong> o4-mini-high</p>
                <p><strong>Status:</strong> <span class="failure">Failure</span></p>
                <p><strong>Prompt Tokens:</strong> 32616</p>
                <p><strong>Output Tokens:</strong> N/A</p>
                <p><strong>Native Prompt Tokens:</strong> 32746</p>
                <p><strong>Native Completion Tokens:</strong> 10222</p>
                <p><strong>Native Tokens Reasoning:</strong> 3776</p>
                <p><strong>Native Finish Reason:</strong> stop</p>
                <p><strong>Cost:</strong> $0.0540694</p>
            </div>
            
            <div class="content-links">
                <h2>View Content</h2>
                <ul>
                    <li><a href="../../content/openai_o4-mini-high/ghostty_src_terminal_Parser.zig/prompt.html" class="content-link">View Prompt</a></li>
                    <li><a href="../../content/openai_o4-mini-high/ghostty_src_terminal_Parser.zig/expected.html" class="content-link">View Expected Output</a></li>
                    <li><a href="../../content/openai_o4-mini-high/ghostty_src_terminal_Parser.zig/actual.html" class="content-link">View Actual Output</a></li>
                </ul>
            </div>
            
            <div class="diff-section">
                <h2>Diff (Expected vs Actual)</h2>
                <div id="diff-output">
                    <pre class="diff"><div></div><div>index ed477f2d..c02da0a9 100644</div><div class="diff-header">--- a/ghostty_src_terminal_Parser.zig_expectedoutput.txt (expected):tmp/tmp353feexw_expected.txt	</div><div class="diff-header">+++ b/ghostty_src_terminal_Parser.zig_extracted.txt (actual):tmp/tmp9o4p2pl4_actual.txt	</div><div class="diff-info">@@ -39,11 +39,14 @@ pub const TransitionAction = enum {</div><div>     ignore,</div><div>     print,</div><div>     execute,</div><div class="diff-added">+    clear,</div><div>     collect,</div><div>     param,</div><div>     esc_dispatch,</div><div>     csi_dispatch,</div><div class="diff-added">+    hook,</div><div>     put,</div><div class="diff-added">+    unhook,</div><div>     osc_put,</div><div>     apc_put,</div><div> };</div><div class="diff-info">@@ -51,8 +54,6 @@ pub const TransitionAction = enum {</div><div> /// Action is the action that a caller of the parser is expected to</div><div> /// take as a result of some input character.</div><div> pub const Action = union(enum) {</div><div class="diff-removed">-    pub const Tag = std.meta.FieldEnum(Action);</div><div class="diff-removed">-</div><div>     /// Draw character to the screen. This is a unicode codepoint.</div><div>     print: u21,</div><div> </div><div class="diff-info">@@ -79,16 +80,15 @@ pub const Action = union(enum) {</div><div>     apc_put: u8,</div><div>     apc_end: void,</div><div> </div><div class="diff-added">+    pub const Tag = std.meta.FieldEnum(Action);</div><div class="diff-added">+</div><div>     pub const CSI = struct {</div><div>         intermediates: []u8,</div><div>         params: []u16,</div><div>         params_sep: SepList,</div><div>         final: u8,</div><div> </div><div class="diff-removed">-        /// The list of separators used for CSI params. The value of the</div><div class="diff-removed">-        /// bit can be mapped to Sep. The index of this bit set specifies</div><div class="diff-removed">-        /// the separator AFTER that param. For example: 0;4:3 would have</div><div class="diff-removed">-        /// index 1 set.</div><div class="diff-added">+        /// The list of separators used for CSI params. The bit can be mapped to Sep.</div><div>         pub const SepList = std.StaticBitSet(MAX_PARAMS);</div><div> </div><div>         /// The separator used for CSI params.</div><div class="diff-info">@@ -136,58 +136,6 @@ pub const Action = union(enum) {</div><div>         params: []const u16 = &.{},</div><div>         final: u8,</div><div>     };</div><div class="diff-removed">-</div><div class="diff-removed">-    // Implement formatter for logging. This is mostly copied from the</div><div class="diff-removed">-    // std.fmt implementation, but we modify it slightly so that we can</div><div class="diff-removed">-    // print out custom formats for some of our primitives.</div><div class="diff-removed">-    pub fn format(</div><div class="diff-removed">-        self: Action,</div><div class="diff-removed">-        comptime layout: []const u8,</div><div class="diff-removed">-        opts: std.fmt.FormatOptions,</div><div class="diff-removed">-        writer: anytype,</div><div class="diff-removed">-    ) !void {</div><div class="diff-removed">-        _ = layout;</div><div class="diff-removed">-        const T = Action;</div><div class="diff-removed">-        const info = @typeInfo(T).@"union";</div><div class="diff-removed">-</div><div class="diff-removed">-        try writer.writeAll(@typeName(T));</div><div class="diff-removed">-        if (info.tag_type) |TagType| {</div><div class="diff-removed">-            try writer.writeAll("{ .");</div><div class="diff-removed">-            try writer.writeAll(@tagName(@as(TagType, self)));</div><div class="diff-removed">-            try writer.writeAll(" = ");</div><div class="diff-removed">-</div><div class="diff-removed">-            inline for (info.fields) |u_field| {</div><div class="diff-removed">-                // If this is the active field...</div><div class="diff-removed">-                if (self == @field(TagType, u_field.name)) {</div><div class="diff-removed">-                    const value = @field(self, u_field.name);</div><div class="diff-removed">-                    switch (@TypeOf(value)) {</div><div class="diff-removed">-                        // Unicode</div><div class="diff-removed">-                        u21 => try std.fmt.format(writer, "'{u}' (U+{X})", .{ value, value }),</div><div class="diff-removed">-</div><div class="diff-removed">-                        // Byte</div><div class="diff-removed">-                        u8 => try std.fmt.format(writer, "0x{x}", .{value}),</div><div class="diff-removed">-</div><div class="diff-removed">-                        // Note: we don't do ASCII (u8) because there are a lot</div><div class="diff-removed">-                        // of invisible characters we don't want to handle right</div><div class="diff-removed">-                        // now.</div><div class="diff-removed">-</div><div class="diff-removed">-                        // All others do the default behavior</div><div class="diff-removed">-                        else => try std.fmt.formatType(</div><div class="diff-removed">-                            @field(self, u_field.name),</div><div class="diff-removed">-                            "any",</div><div class="diff-removed">-                            opts,</div><div class="diff-removed">-                            writer,</div><div class="diff-removed">-                            3,</div><div class="diff-removed">-                        ),</div><div class="diff-removed">-                    }</div><div class="diff-removed">-                }</div><div class="diff-removed">-            }</div><div class="diff-removed">-</div><div class="diff-removed">-            try writer.writeAll(" }");</div><div class="diff-removed">-        } else {</div><div class="diff-removed">-            try format(writer, "@{x}", .{@intFromPtr(&self)});</div><div class="diff-removed">-        }</div><div class="diff-removed">-    }</div><div> };</div><div> </div><div> /// Maximum number of intermediate characters during parsing. This is</div><div class="diff-info">@@ -209,21 +157,21 @@ const MAX_INTERMEDIATE = 4;</div><div> const MAX_PARAMS = 24;</div><div> </div><div> /// Current state of the state machine</div><div class="diff-removed">-state: State = .ground,</div><div class="diff-added">+state: State = .ground;</div><div> </div><div> /// Intermediate tracking.</div><div class="diff-removed">-intermediates: [MAX_INTERMEDIATE]u8 = undefined,</div><div class="diff-removed">-intermediates_idx: u8 = 0,</div><div class="diff-added">+intermediates: [MAX_INTERMEDIATE]u8 = undefined;</div><div class="diff-added">+intermediates_idx: u8 = 0;</div><div> </div><div> /// Param tracking, building</div><div class="diff-removed">-params: [MAX_PARAMS]u16 = undefined,</div><div class="diff-removed">-params_sep: Action.CSI.SepList = Action.CSI.SepList.initEmpty(),</div><div class="diff-removed">-params_idx: u8 = 0,</div><div class="diff-removed">-param_acc: u16 = 0,</div><div class="diff-removed">-param_acc_idx: u8 = 0,</div><div class="diff-added">+params: [MAX_PARAMS]u16 = undefined;</div><div class="diff-added">+params_sep: Action.CSI.SepList = Action.CSI.SepList.initEmpty();</div><div class="diff-added">+params_idx: u8 = 0;</div><div class="diff-added">+param_acc: u16 = 0;</div><div class="diff-added">+param_acc_idx: u8 = 0;</div><div> </div><div> /// Parser for OSC sequences</div><div class="diff-removed">-osc_parser: osc.Parser = .{},</div><div class="diff-added">+osc_parser: osc.Parser = .{};</div><div> </div><div> pub fn init() Parser {</div><div>     return .{};</div><div class="diff-info">@@ -238,27 +186,17 @@ pub fn deinit(self: *Parser) void {</div><div> /// the state exit, transition, and entry actions.</div><div> pub fn next(self: *Parser, c: u8) [3]?Action {</div><div>     const effect = table[c][@intFromEnum(self.state)];</div><div class="diff-removed">-</div><div class="diff-removed">-    // log.info("next: {x}", .{c});</div><div class="diff-removed">-</div><div>     const next_state = effect.state;</div><div>     const action = effect.action;</div><div> </div><div class="diff-removed">-    // After generating the actions, we set our next state.</div><div>     defer self.state = next_state;</div><div> </div><div class="diff-removed">-    // When going from one state to another, the actions take place in this order:</div><div class="diff-removed">-    //</div><div class="diff-removed">-    // 1. exit action from old state</div><div class="diff-removed">-    // 2. transition action</div><div class="diff-removed">-    // 3. entry action to new state</div><div>     return [3]?Action{</div><div>         // Exit depends on current state</div><div>         if (self.state == next_state) null else switch (self.state) {</div><div>             .osc_string => if (self.osc_parser.end(c)) |cmd|</div><div>                 Action{ .osc_dispatch = cmd }</div><div class="diff-removed">-            else</div><div class="diff-removed">-                null,</div><div class="diff-added">+            else null,</div><div>             .dcs_passthrough => Action{ .dcs_unhook = {} },</div><div>             .sos_pm_apc_string => Action{ .apc_end = {} },</div><div>             else => null,</div><div class="diff-info">@@ -296,16 +234,6 @@ pub fn next(self: *Parser, c: u8) [3]?Action {</div><div>     };</div><div> }</div><div> </div><div class="diff-removed">-pub fn collect(self: *Parser, c: u8) void {</div><div class="diff-removed">-    if (self.intermediates_idx >= MAX_INTERMEDIATE) {</div><div class="diff-removed">-        log.warn("invalid intermediates count", .{});</div><div class="diff-removed">-        return;</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    self.intermediates[self.intermediates_idx] = c;</div><div class="diff-removed">-    self.intermediates_idx += 1;</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div> fn doAction(self: *Parser, action: TransitionAction, c: u8) ?Action {</div><div>     return switch (action) {</div><div>         .none, .ignore => null,</div><div class="diff-info">@@ -316,51 +244,32 @@ fn doAction(self: *Parser, action: TransitionAction, c: u8) ?Action {</div><div>             break :collect null;</div><div>         },</div><div>         .param => param: {</div><div class="diff-removed">-            // Semicolon separates parameters. If we encounter a semicolon</div><div class="diff-removed">-            // we need to store and move on to the next parameter.</div><div>             if (c == ';' or c == ':') {</div><div class="diff-removed">-                // Ignore too many parameters</div><div>                 if (self.params_idx >= MAX_PARAMS) break :param null;</div><div class="diff-removed">-</div><div class="diff-removed">-                // Set param final value</div><div>                 self.params[self.params_idx] = self.param_acc;</div><div>                 if (c == ':') self.params_sep.set(self.params_idx);</div><div>                 self.params_idx += 1;</div><div class="diff-removed">-</div><div class="diff-removed">-                // Reset current param value to 0</div><div>                 self.param_acc = 0;</div><div>                 self.param_acc_idx = 0;</div><div>                 break :param null;</div><div>             }</div><div class="diff-removed">-</div><div class="diff-removed">-            // A numeric value. Add it to our accumulator.</div><div class="diff-removed">-            if (self.param_acc_idx > 0) {</div><div class="diff-removed">-                self.param_acc *|= 10;</div><div class="diff-removed">-            }</div><div class="diff-removed">-            self.param_acc +|= c - '0';</div><div class="diff-removed">-</div><div class="diff-removed">-            // Increment our accumulator index. If we overflow then</div><div class="diff-removed">-            // we're out of bounds and we exit immediately.</div><div class="diff-added">+            if (self.param_acc_idx > 0) self.param_acc *= 10;</div><div class="diff-added">+            self.param_acc += @intFrom(u16, c - '0');</div><div>             self.param_acc_idx, const overflow = @addWithOverflow(self.param_acc_idx, 1);</div><div class="diff-removed">-            if (overflow > 0) break :param null;</div><div class="diff-removed">-</div><div class="diff-removed">-            // The client is expected to perform no action.</div><div class="diff-added">+            if (overflow) break :param null;</div><div>             break :param null;</div><div>         },</div><div class="diff-added">+        .esc_dispatch => Action{ .esc_dispatch = .{ .intermediates = self.intermediates[0..self.intermediates_idx], .final = c } },</div><div>         .osc_put => osc_put: {</div><div>             self.osc_parser.next(c);</div><div>             break :osc_put null;</div><div>         },</div><div>         .csi_dispatch => csi_dispatch: {</div><div class="diff-removed">-            // Ignore too many parameters</div><div>             if (self.params_idx >= MAX_PARAMS) break :csi_dispatch null;</div><div class="diff-removed">-</div><div class="diff-removed">-            // Finalize parameters if we have one</div><div>             if (self.param_acc_idx > 0) {</div><div>                 self.params[self.params_idx] = self.param_acc;</div><div>                 self.params_idx += 1;</div><div>             }</div><div class="diff-removed">-</div><div>             const result: Action = .{</div><div>                 .csi_dispatch = .{</div><div>                     .intermediates = self.intermediates[0..self.intermediates_idx],</div><div class="diff-info">@@ -369,29 +278,27 @@ fn doAction(self: *Parser, action: TransitionAction, c: u8) ?Action {</div><div>                     .final = c,</div><div>                 },</div><div>             };</div><div class="diff-removed">-</div><div class="diff-removed">-            // We only allow colon or mixed separators for the 'm' command.</div><div>             if (c != 'm' and self.params_sep.count() > 0) {</div><div class="diff-removed">-                log.warn(</div><div class="diff-removed">-                    "CSI colon or mixed separators only allowed for 'm' command, got: {}",</div><div class="diff-removed">-                    .{result},</div><div class="diff-removed">-                );</div><div class="diff-added">+                log.warn("CSI colon or mixed separators only allowed for 'm' command, got: {}", .{result});</div><div>                 break :csi_dispatch null;</div><div>             }</div><div class="diff-removed">-</div><div>             break :csi_dispatch result;</div><div>         },</div><div class="diff-removed">-        .esc_dispatch => Action{</div><div class="diff-removed">-            .esc_dispatch = .{</div><div class="diff-removed">-                .intermediates = self.intermediates[0..self.intermediates_idx],</div><div class="diff-removed">-                .final = c,</div><div class="diff-removed">-            },</div><div class="diff-removed">-        },</div><div>         .put => Action{ .dcs_put = c },</div><div>         .apc_put => Action{ .apc_put = c },</div><div class="diff-added">+        else => null,</div><div>     };</div><div> }</div><div> </div><div class="diff-added">+pub fn collect(self: *Parser, c: u8) void {</div><div class="diff-added">+    if (self.intermediates_idx >= MAX_INTERMEDIATE) {</div><div class="diff-added">+        log.warn("invalid intermediates count", .{});</div><div class="diff-added">+        return;</div><div class="diff-added">+    }</div><div class="diff-added">+    self.intermediates[self.intermediates_idx] = c;</div><div class="diff-added">+    self.intermediates_idx += 1;</div><div class="diff-added">+}</div><div class="diff-added">+</div><div> pub fn clear(self: *Parser) void {</div><div>     self.intermediates_idx = 0;</div><div>     self.params_idx = 0;</div><div class="diff-info">@@ -400,29 +307,7 @@ pub fn clear(self: *Parser) void {</div><div>     self.param_acc_idx = 0;</div><div> }</div><div> </div><div class="diff-removed">-test {</div><div class="diff-removed">-    var p = init();</div><div class="diff-removed">-    _ = p.next(0x9E);</div><div class="diff-removed">-    try testing.expect(p.state == .sos_pm_apc_string);</div><div class="diff-removed">-    _ = p.next(0x9C);</div><div class="diff-removed">-    try testing.expect(p.state == .ground);</div><div class="diff-removed">-</div><div class="diff-removed">-    {</div><div class="diff-removed">-        const a = p.next('a');</div><div class="diff-removed">-        try testing.expect(p.state == .ground);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1].? == .print);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    {</div><div class="diff-removed">-        const a = p.next(0x19);</div><div class="diff-removed">-        try testing.expect(p.state == .ground);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1].? == .execute);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-added">+// -- Tests --</div><div> </div><div> test "esc: ESC ( B" {</div><div>     var p = init();</div><div class="diff-info">@@ -446,7 +331,7 @@ test "esc: ESC ( B" {</div><div> test "csi: ESC [ H" {</div><div>     var p = init();</div><div>     _ = p.next(0x1B);</div><div class="diff-removed">-    _ = p.next(0x5B);</div><div class="diff-added">+    _ = p.next('[');</div><div> </div><div>     {</div><div>         const a = p.next(0x48);</div><div class="diff-info">@@ -464,13 +349,13 @@ test "csi: ESC [ H" {</div><div> test "csi: ESC [ 1 ; 4 H" {</div><div>     var p = init();</div><div>     _ = p.next(0x1B);</div><div class="diff-removed">-    _ = p.next(0x5B);</div><div class="diff-removed">-    _ = p.next(0x31); // 1</div><div class="diff-removed">-    _ = p.next(0x3B); // ;</div><div class="diff-removed">-    _ = p.next(0x34); // 4</div><div class="diff-added">+    _ = p.next('[');</div><div class="diff-added">+    _ = p.next('1');</div><div class="diff-added">+    _ = p.next(';');</div><div class="diff-added">+    _ = p.next('4');</div><div> </div><div>     {</div><div class="diff-removed">-        const a = p.next(0x48); // H</div><div class="diff-added">+        const a = p.next(0x48);</div><div>         try testing.expect(p.state == .ground);</div><div>         try testing.expect(a[0] == null);</div><div>         try testing.expect(a[1].? == .csi_dispatch);</div><div class="diff-info">@@ -503,58 +388,10 @@ test "csi: SGR ESC [ 38 : 2 m" {</div><div>         const d = a[1].?.csi_dispatch;</div><div>         try testing.expect(d.final == 'm');</div><div>         try testing.expect(d.params.len == 2);</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 38), d.params[0]);</div><div>         try testing.expect(d.params_sep.isSet(0));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 2), d.params[1]);</div><div>         try testing.expect(!d.params_sep.isSet(1));</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-test "csi: SGR colon followed by semicolon" {</div><div class="diff-removed">-    var p = init();</div><div class="diff-removed">-    _ = p.next(0x1B);</div><div class="diff-removed">-    for ("[48:2") |c| {</div><div class="diff-removed">-        const a = p.next(c);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1] == null);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    {</div><div class="diff-removed">-        const a = p.next('m');</div><div class="diff-removed">-        try testing.expect(p.state == .ground);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1].? == .csi_dispatch);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    _ = p.next(0x1B);</div><div class="diff-removed">-    _ = p.next('[');</div><div class="diff-removed">-    {</div><div class="diff-removed">-        const a = p.next('H');</div><div class="diff-removed">-        try testing.expect(p.state == .ground);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1].? == .csi_dispatch);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-test "csi: SGR mixed colon and semicolon" {</div><div class="diff-removed">-    var p = init();</div><div class="diff-removed">-    _ = p.next(0x1B);</div><div class="diff-removed">-    for ("[38:5:1;48:5:0") |c| {</div><div class="diff-removed">-        const a = p.next(c);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1] == null);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    {</div><div class="diff-removed">-        const a = p.next('m');</div><div class="diff-removed">-        try testing.expect(p.state == .ground);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1].? == .csi_dispatch);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-added">+        try testing.expectEqual(@as(u16, 38), d.params[0]);</div><div class="diff-added">+        try testing.expectEqual(@as(u16, 2), d.params[1]);</div><div>     }</div><div> }</div><div> </div><div class="diff-info">@@ -578,16 +415,13 @@ test "csi: SGR ESC [ 48 : 2 m" {</div><div>         const d = a[1].?.csi_dispatch;</div><div>         try testing.expect(d.final == 'm');</div><div>         try testing.expect(d.params.len == 5);</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 48), d.params[0]);</div><div>         try testing.expect(d.params_sep.isSet(0));</div><div class="diff-added">+        try testing.expect(!d.params_sep.isSet(4));</div><div class="diff-added">+        try testing.expectEqual(@as(u16, 48), d.params[0]);</div><div>         try testing.expectEqual(@as(u16, 2), d.params[1]);</div><div class="diff-removed">-        try testing.expect(d.params_sep.isSet(1));</div><div>         try testing.expectEqual(@as(u16, 240), d.params[2]);</div><div class="diff-removed">-        try testing.expect(d.params_sep.isSet(2));</div><div>         try testing.expectEqual(@as(u16, 143), d.params[3]);</div><div class="diff-removed">-        try testing.expect(d.params_sep.isSet(3));</div><div>         try testing.expectEqual(@as(u16, 104), d.params[4]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(4));</div><div>     }</div><div> }</div><div> </div><div class="diff-info">@@ -609,10 +443,10 @@ test "csi: SGR ESC [4:3m colon" {</div><div>         const d = a[1].?.csi_dispatch;</div><div>         try testing.expect(d.final == 'm');</div><div>         try testing.expect(d.params.len == 2);</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 4), d.params[0]);</div><div>         try testing.expect(d.params_sep.isSet(0));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 3), d.params[1]);</div><div>         try testing.expect(!d.params_sep.isSet(1));</div><div class="diff-added">+        try testing.expectEqual(@as(u16, 4), d.params[0]);</div><div class="diff-added">+        try testing.expectEqual(@as(u16, 3), d.params[1]);</div><div>     }</div><div> }</div><div> </div><div class="diff-info">@@ -636,78 +470,21 @@ test "csi: SGR with many blank and colon" {</div><div>         const d = a[1].?.csi_dispatch;</div><div>         try testing.expect(d.final == 'm');</div><div>         try testing.expect(d.params.len == 6);</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 58), d.params[0]);</div><div>         try testing.expect(d.params_sep.isSet(0));</div><div class="diff-added">+        try testing.expect(!d.params_sep.isSet(5));</div><div class="diff-added">+        try testing.expectEqual(@as(u16, 58), d.params[0]);</div><div>         try testing.expectEqual(@as(u16, 2), d.params[1]);</div><div class="diff-removed">-        try testing.expect(d.params_sep.isSet(1));</div><div>         try testing.expectEqual(@as(u16, 0), d.params[2]);</div><div class="diff-removed">-        try testing.expect(d.params_sep.isSet(2));</div><div>         try testing.expectEqual(@as(u16, 240), d.params[3]);</div><div class="diff-removed">-        try testing.expect(d.params_sep.isSet(3));</div><div>         try testing.expectEqual(@as(u16, 143), d.params[4]);</div><div class="diff-removed">-        try testing.expect(d.params_sep.isSet(4));</div><div>         try testing.expectEqual(@as(u16, 104), d.params[5]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(5));</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-// This is from a Kakoune actual SGR sequence.</div><div class="diff-removed">-test "csi: SGR mixed colon and semicolon with blank" {</div><div class="diff-removed">-    var p = init();</div><div class="diff-removed">-    _ = p.next(0x1B);</div><div class="diff-removed">-    for ("[;4:3;38;2;175;175;215;58:2::190:80:70") |c| {</div><div class="diff-removed">-        const a = p.next(c);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1] == null);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    {</div><div class="diff-removed">-        const a = p.next('m');</div><div class="diff-removed">-        try testing.expect(p.state == .ground);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1].? == .csi_dispatch);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-</div><div class="diff-removed">-        const d = a[1].?.csi_dispatch;</div><div class="diff-removed">-        try testing.expect(d.final == 'm');</div><div class="diff-removed">-        try testing.expectEqual(14, d.params.len);</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 0), d.params[0]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(0));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 4), d.params[1]);</div><div class="diff-removed">-        try testing.expect(d.params_sep.isSet(1));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 3), d.params[2]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(2));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 38), d.params[3]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(3));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 2), d.params[4]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(4));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 175), d.params[5]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(5));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 175), d.params[6]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(6));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 215), d.params[7]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(7));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 58), d.params[8]);</div><div class="diff-removed">-        try testing.expect(d.params_sep.isSet(8));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 2), d.params[9]);</div><div class="diff-removed">-        try testing.expect(d.params_sep.isSet(9));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 0), d.params[10]);</div><div class="diff-removed">-        try testing.expect(d.params_sep.isSet(10));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 190), d.params[11]);</div><div class="diff-removed">-        try testing.expect(d.params_sep.isSet(11));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 80), d.params[12]);</div><div class="diff-removed">-        try testing.expect(d.params_sep.isSet(12));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 70), d.params[13]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(13));</div><div>     }</div><div> }</div><div> </div><div class="diff-removed">-// This is from a Kakoune actual SGR sequence also.</div><div class="diff-removed">-test "csi: SGR mixed colon and semicolon setting underline, bg, fg" {</div><div class="diff-added">+test "csi: SGR mixed colon and semicolon" {</div><div>     var p = init();</div><div>     _ = p.next(0x1B);</div><div class="diff-removed">-    for ("[4:3;38;2;51;51;51;48;2;170;170;170;58;2;255;97;136") |c| {</div><div class="diff-added">+    for ("[38:5:1;48:5:0") |c| {</div><div>         const a = p.next(c);</div><div>         try testing.expect(a[0] == null);</div><div>         try testing.expect(a[1] == null);</div><div class="diff-info">@@ -720,44 +497,6 @@ test "csi: SGR mixed colon and semicolon setting underline, bg, fg" {</div><div>         try testing.expect(a[0] == null);</div><div>         try testing.expect(a[1].? == .csi_dispatch);</div><div>         try testing.expect(a[2] == null);</div><div class="diff-removed">-</div><div class="diff-removed">-        const d = a[1].?.csi_dispatch;</div><div class="diff-removed">-        try testing.expect(d.final == 'm');</div><div class="diff-removed">-        try testing.expectEqual(17, d.params.len);</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 4), d.params[0]);</div><div class="diff-removed">-        try testing.expect(d.params_sep.isSet(0));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 3), d.params[1]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(1));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 38), d.params[2]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(2));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 2), d.params[3]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(3));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 51), d.params[4]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(4));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 51), d.params[5]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(5));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 51), d.params[6]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(6));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 48), d.params[7]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(7));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 2), d.params[8]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(8));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 170), d.params[9]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(9));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 170), d.params[10]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(10));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 170), d.params[11]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(11));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 58), d.params[12]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(12));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 2), d.params[13]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(13));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 255), d.params[14]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(14));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 97), d.params[15]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(15));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 136), d.params[16]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(16));</div><div>     }</div><div> }</div><div> </div><div class="diff-info">@@ -774,59 +513,6 @@ test "csi: colon for non-m final" {</div><div>     try testing.expect(p.state == .ground);</div><div> }</div><div> </div><div class="diff-removed">-test "csi: request mode decrqm" {</div><div class="diff-removed">-    var p = init();</div><div class="diff-removed">-    _ = p.next(0x1B);</div><div class="diff-removed">-    for ("[?2026$") |c| {</div><div class="diff-removed">-        const a = p.next(c);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1] == null);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    {</div><div class="diff-removed">-        const a = p.next('p');</div><div class="diff-removed">-        try testing.expect(p.state == .ground);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1].? == .csi_dispatch);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-</div><div class="diff-removed">-        const d = a[1].?.csi_dispatch;</div><div class="diff-removed">-        try testing.expect(d.final == 'p');</div><div class="diff-removed">-        try testing.expectEqual(@as(usize, 2), d.intermediates.len);</div><div class="diff-removed">-        try testing.expectEqual(@as(usize, 1), d.params.len);</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, '?'), d.intermediates[0]);</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, '$'), d.intermediates[1]);</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 2026), d.params[0]);</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-test "csi: change cursor" {</div><div class="diff-removed">-    var p = init();</div><div class="diff-removed">-    _ = p.next(0x1B);</div><div class="diff-removed">-    for ("[3 ") |c| {</div><div class="diff-removed">-        const a = p.next(c);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1] == null);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    {</div><div class="diff-removed">-        const a = p.next('q');</div><div class="diff-removed">-        try testing.expect(p.state == .ground);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1].? == .csi_dispatch);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-</div><div class="diff-removed">-        const d = a[1].?.csi_dispatch;</div><div class="diff-removed">-        try testing.expect(d.final == 'q');</div><div class="diff-removed">-        try testing.expectEqual(@as(usize, 1), d.intermediates.len);</div><div class="diff-removed">-        try testing.expectEqual(@as(usize, 1), d.params.len);</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, ' '), d.intermediates[0]);</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 3), d.params[0]);</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div> test "osc: change window title" {</div><div>     var p = init();</div><div>     _ = p.next(0x1B);</div><div class="diff-info">@@ -838,7 +524,7 @@ test "osc: change window title" {</div><div>     _ = p.next('c');</div><div> </div><div>     {</div><div class="diff-removed">-        const a = p.next(0x07); // BEL</div><div class="diff-added">+        const a = p.next(0x07);</div><div>         try testing.expect(p.state == .ground);</div><div>         try testing.expect(a[0].? == .osc_dispatch);</div><div>         try testing.expect(a[1] == null);</div><div class="diff-info">@@ -897,6 +583,59 @@ test "osc: 112 incomplete sequence" {</div><div>     }</div><div> }</div><div> </div><div class="diff-added">+test "csi: request mode decrqm" {</div><div class="diff-added">+    var p = init();</div><div class="diff-added">+    _ = p.next(0x1B);</div><div class="diff-added">+    for ("[?2026$") |c| {</div><div class="diff-added">+        const a = p.next(c);</div><div class="diff-added">+        try testing.expect(a[0] == null);</div><div class="diff-added">+        try testing.expect(a[1] == null);</div><div class="diff-added">+        try testing.expect(a[2] == null);</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    {</div><div class="diff-added">+        const a = p.next('p');</div><div class="diff-added">+        try testing.expect(p.state == .ground);</div><div class="diff-added">+        try testing.expect(a[0] == null);</div><div class="diff-added">+        try testing.expect(a[1].? == .csi_dispatch);</div><div class="diff-added">+        try testing.expect(a[2] == null);</div><div class="diff-added">+</div><div class="diff-added">+        const d = a[1].?.csi_dispatch;</div><div class="diff-added">+        try testing.expect(d.final == 'p');</div><div class="diff-added">+        try testing.expectEqual(@as(usize, 2), d.intermediates.len);</div><div class="diff-added">+        try testing.expectEqual(@as(usize, 1), d.params.len);</div><div class="diff-added">+        try testing.expectEqual(@as(u16, '?'), d.intermediates[0]);</div><div class="diff-added">+        try testing.expectEqual(@as(u16, '$'), d.intermediates[1]);</div><div class="diff-added">+        try testing.expectEqual(@as(u16, 2026), d.params[0]);</div><div class="diff-added">+    }</div><div class="diff-added">+}</div><div class="diff-added">+</div><div class="diff-added">+test "csi: change cursor" {</div><div class="diff-added">+    var p = init();</div><div class="diff-added">+    _ = p.next(0x1B);</div><div class="diff-added">+    for ("[3 ") |c| {</div><div class="diff-added">+        const a = p.next(c);</div><div class="diff-added">+        try testing.expect(a[0] == null);</div><div class="diff-added">+        try testing.expect(a[1] == null);</div><div class="diff-added">+        try testing.expect(a[2] == null);</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    {</div><div class="diff-added">+        const a = p.next('q');</div><div class="diff-added">+        try testing.expect(p.state == .ground);</div><div class="diff-added">+        try testing.expect(a[0] == null);</div><div class="diff-added">+        try testing.expect(a[1].? == .csi_dispatch);</div><div class="diff-added">+        try testing.expect(a[2] == null);</div><div class="diff-added">+</div><div class="diff-added">+        const d = a[1].?.csi_dispatch;</div><div class="diff-added">+        try testing.expect(d.final == 'q');</div><div class="diff-added">+        try testing.expectEqual(@as(usize, 1), d.intermediates.len);</div><div class="diff-added">+        try testing.expectEqual(@as(usize, 1), d.params.len);</div><div class="diff-added">+        try testing.expectEqual(@as(u16, ' '), d.intermediates[0]);</div><div class="diff-added">+        try testing.expectEqual(@as(u16, 3), d.params[0]);</div><div class="diff-added">+    }</div><div class="diff-added">+}</div><div class="diff-added">+</div><div> test "csi: too many params" {</div><div>     var p = init();</div><div>     _ = p.next(0x1B);</div><div class="diff-info">@@ -961,4 +700,66 @@ test "dcs: params" {</div><div>         try testing.expectEqualSlices(u16, &[_]u16{1000}, hook.params);</div><div>         try testing.expectEqual('p', hook.final);</div><div>     }</div><div class="diff-added">+}</div><div class="diff-added">+</div><div class="diff-added">+// This is from a Kakoune actual SGR sequence also.</div><div class="diff-added">+test "csi: SGR mixed colon and semicolon setting underline, bg, fg" {</div><div class="diff-added">+    var p = init();</div><div class="diff-added">+    _ = p.next(0x1B);</div><div class="diff-added">+    for ("[4:3;38;2;51;51;51;48;2;170;170;170;58;2;255;97;136") |c| {</div><div class="diff-added">+        const a = p.next(c);</div><div class="diff-added">+        try testing.expect(a[0] == null);</div><div class="diff-added">+        try testing.expect(a[1] == null);</div><div class="diff-added">+        try testing.expect(a[2] == null);</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    {</div><div class="diff-added">+        const a = p.next('m');</div><div class="diff-added">+        try testing.expect(p.state == .ground);</div><div class="diff-added">+        try testing.expect(a[0] == null);</div><div class="diff-added">+        try testing.expect(a[1].? == .csi_dispatch);</div><div class="diff-added">+        try testing.expect(a[2] == null);</div><div class="diff-added">+</div><div class="diff-added">+        const d = a[1].?.csi_dispatch;</div><div class="diff-added">+        try testing.expect(d.final == 'm');</div><div class="diff-added">+        try testing.expectEqual(17, d.params.len);</div><div class="diff-added">+        // underline separator</div><div class="diff-added">+        try testing.expect(d.params_sep.isSet(0));</div><div class="diff-added">+        try testing.expectEqual(@as(u16, 4), d.params[0]);</div><div class="diff-added">+        try testing.expect(!d.params_sep.isSet(1));</div><div class="diff-added">+        try testing.expectEqual(@as(u16, 3), d.params[1]);</div><div class="diff-added">+        // fg sequence separators</div><div class="diff-added">+        try testing.expect(!d.params_sep.isSet(2));</div><div class="diff-added">+        try testing.expectEqual(@as(u16, 38), d.params[2]);</div><div class="diff-added">+        try testing.expect(!d.params_sep.isSet(3));</div><div class="diff-added">+        try testing.expectEqual(@as(u16, 2), d.params[3]);</div><div class="diff-added">+        try testing.expect(!d.params_sep.isSet(4));</div><div class="diff-added">+        try testing.expectEqual(@as(u16, 51), d.params[4]);</div><div class="diff-added">+        try testing.expect(!d.params_sep.isSet(5));</div><div class="diff-added">+        try testing.expectEqual(@as(u16, 51), d.params[5]);</div><div class="diff-added">+        try testing.expect(!d.params_sep.isSet(6));</div><div class="diff-added">+        try testing.expectEqual(@as(u16, 51), d.params[6]);</div><div class="diff-added">+        // bg sequence separators</div><div class="diff-added">+        try testing.expect(!d.params_sep.isSet(7));</div><div class="diff-added">+        try testing.expectEqual(@as(u16, 48), d.params[7]);</div><div class="diff-added">+        try testing.expect(!d.params_sep.isSet(8));</div><div class="diff-added">+        try testing.expectEqual(@as(u16, 2), d.params[8]);</div><div class="diff-added">+        try testing.expect(!d.params_sep.isSet(9));</div><div class="diff-added">+        try testing.expectEqual(@as(u16, 170), d.params[9]);</div><div class="diff-added">+        try testing.expect(!d.params_sep.isSet(10));</div><div class="diff-added">+        try testing.expectEqual(@as(u16, 170), d.params[10]);</div><div class="diff-added">+        try testing.expect(!d.params_sep.isSet(11));</div><div class="diff-added">+        try testing.expectEqual(@as(u16, 170), d.params[11]);</div><div class="diff-added">+        // curly underline separators</div><div class="diff-added">+        try testing.expect(!d.params_sep.isSet(12));</div><div class="diff-added">+        try testing.expectEqual(@as(u16, 58), d.params[12]);</div><div class="diff-added">+        try testing.expect(!d.params_sep.isSet(13));</div><div class="diff-added">+        try testing.expectEqual(@as(u16, 2), d.params[13]);</div><div class="diff-added">+        try testing.expect(!d.params_sep.isSet(14));</div><div class="diff-added">+        try testing.expectEqual(@as(u16, 255), d.params[14]);</div><div class="diff-added">+        try testing.expect(!d.params_sep.isSet(15));</div><div class="diff-added">+        try testing.expectEqual(@as(u16, 97), d.params[15]);</div><div class="diff-added">+        try testing.expect(!d.params_sep.isSet(16));</div><div class="diff-added">+        try testing.expectEqual(@as(u16, 136), d.params[16]);</div><div class="diff-added">+    }</div><div> }</div><div>\ No newline at end of file</div><div></div></pre>
                </div>
            </div>
        </section>
    </main>
    <footer>
        <p>LoCoDiff-bench - <a href="https://github.com/AbanteAI/LoCoDiff-bench">GitHub Repository</a></p>
    </footer>
</body>
</html>
    