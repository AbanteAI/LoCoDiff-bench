<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case: packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx - o4-mini-high</title>
    <link rel="stylesheet" href="../../styles.css">
</head>
<body>
    <header>
        <h1>Case: packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx</h1>
        <p><a href="../../models/openai_o4-mini-high.html">‚Üê Back to o4-mini-high Cases</a> | <a href="../../index.html">Home</a></p>
    </header>
    <main>
        <section class="case-details">
            <div class="case-info">
                <h2>Benchmark Case Information</h2>
                <p><strong>Model:</strong> o4-mini-high</p>
                <p><strong>Status:</strong> <span class="failure">Failure</span></p>
                <p><strong>Prompt Tokens:</strong> 39824</p>
                <p><strong>Output Tokens:</strong> N/A</p>
                <p><strong>Native Prompt Tokens:</strong> 39927</p>
                <p><strong>Native Completion Tokens:</strong> 36087</p>
                <p><strong>Native Tokens Reasoning:</strong> 32320</p>
                <p><strong>Native Finish Reason:</strong> stop</p>
                <p><strong>Cost:</strong> $0.2027025</p>
            </div>
            
            <div class="content-links">
                <h2>View Content</h2>
                <ul>
                    <li><a href="../../content/openai_o4-mini-high/tldraw_packages_tldraw_src_lib_shapes_note_NoteShapeUtil.tsx/prompt.html" class="content-link">View Prompt</a></li>
                    <li><a href="../../content/openai_o4-mini-high/tldraw_packages_tldraw_src_lib_shapes_note_NoteShapeUtil.tsx/expected.html" class="content-link">View Expected Output</a></li>
                    <li><a href="../../content/openai_o4-mini-high/tldraw_packages_tldraw_src_lib_shapes_note_NoteShapeUtil.tsx/actual.html" class="content-link">View Actual Output</a></li>
                </ul>
            </div>
            
            <div class="diff-section">
                <h2>Diff (Expected vs Actual)</h2>
                <div id="diff-output">
                    <pre class="diff"><div></div><div>index 37af12e0..9d1e6b6d 100644</div><div class="diff-header">--- a/tldraw_packages_tldraw_src_lib_shapes_note_NoteShapeUtil.tsx_expectedoutput.txt (expected):tmp/tmp115_x_oo_expected.txt	</div><div class="diff-header">+++ b/tldraw_packages_tldraw_src_lib_shapes_note_NoteShapeUtil.tsx_extracted.txt (actual):tmp/tmp6eh0_818_actual.txt	</div><div class="diff-info">@@ -1,559 +1,518 @@</div><div> /* eslint-disable react-hooks/rules-of-hooks */</div><div> import {</div><div class="diff-removed">-	Box,</div><div class="diff-removed">-	Editor,</div><div class="diff-removed">-	Group2d,</div><div class="diff-removed">-	IndexKey,</div><div class="diff-removed">-	Rectangle2d,</div><div class="diff-removed">-	ShapeUtil,</div><div class="diff-removed">-	SvgExportContext,</div><div class="diff-removed">-	TLFontFace,</div><div class="diff-removed">-	TLHandle,</div><div class="diff-removed">-	TLNoteShape,</div><div class="diff-removed">-	TLNoteShapeProps,</div><div class="diff-removed">-	TLResizeInfo,</div><div class="diff-removed">-	TLShape,</div><div class="diff-removed">-	TLShapeId,</div><div class="diff-removed">-	Vec,</div><div class="diff-removed">-	WeakCache,</div><div class="diff-removed">-	exhaustiveSwitchError,</div><div class="diff-removed">-	getDefaultColorTheme,</div><div class="diff-removed">-	getFontsFromRichText,</div><div class="diff-removed">-	lerp,</div><div class="diff-removed">-	noteShapeMigrations,</div><div class="diff-removed">-	noteShapeProps,</div><div class="diff-removed">-	resizeScaled,</div><div class="diff-removed">-	rng,</div><div class="diff-removed">-	toDomPrecision,</div><div class="diff-removed">-	toRichText,</div><div class="diff-removed">-	useEditor,</div><div class="diff-removed">-	useValue,</div><div class="diff-added">+  Box,</div><div class="diff-added">+  Editor,</div><div class="diff-added">+  Group2d,</div><div class="diff-added">+  IndexKey,</div><div class="diff-added">+  Rectangle2d,</div><div class="diff-added">+  ShapeUtil,</div><div class="diff-added">+  SvgExportContext,</div><div class="diff-added">+  TLFontFace,</div><div class="diff-added">+  TLHandle,</div><div class="diff-added">+  TLNoteShape,</div><div class="diff-added">+  TLNoteShapeProps,</div><div class="diff-added">+  TLResizeInfo,</div><div class="diff-added">+  TLShape,</div><div class="diff-added">+  TLShapeId,</div><div class="diff-added">+  Vec,</div><div class="diff-added">+  WeakCache,</div><div class="diff-added">+  exhaustiveSwitchError,</div><div class="diff-added">+  getDefaultColorTheme,</div><div class="diff-added">+  getFontsFromRichText,</div><div class="diff-added">+  lerp,</div><div class="diff-added">+  noteShapeMigrations,</div><div class="diff-added">+  noteShapeProps,</div><div class="diff-added">+  resizeScaled,</div><div class="diff-added">+  rng,</div><div class="diff-added">+  toDomPrecision,</div><div class="diff-added">+  toRichText,</div><div class="diff-added">+  useEditor,</div><div class="diff-added">+  useValue,</div><div> } from '@tldraw/editor'</div><div class="diff-added">+import { startEditingShapeWithLabel } from '../../tools/SelectTool/selectHelpers'</div><div class="diff-added">+import {</div><div class="diff-added">+  CLONE_HANDLE_MARGIN,</div><div class="diff-added">+  NOTE_CENTER_OFFSET,</div><div class="diff-added">+  NOTE_SIZE,</div><div class="diff-added">+  getNoteShapeForAdjacentPosition,</div><div class="diff-added">+} from './noteHelpers'</div><div> import { useCallback } from 'react'</div><div> import { useCurrentTranslation } from '../../ui/hooks/useTranslation/useTranslation'</div><div> import { isRightToLeftLanguage } from '../../utils/text/text'</div><div> import { HyperlinkButton } from '../shared/HyperlinkButton'</div><div> import { RichTextLabel, RichTextSVG } from '../shared/RichTextLabel'</div><div> import {</div><div class="diff-removed">-	FONT_FAMILIES,</div><div class="diff-removed">-	LABEL_FONT_SIZES,</div><div class="diff-removed">-	LABEL_PADDING,</div><div class="diff-removed">-	TEXT_PROPS,</div><div class="diff-added">+  FONT_FAMILIES,</div><div class="diff-added">+  LABEL_FONT_SIZES,</div><div class="diff-added">+  LABEL_PADDING,</div><div class="diff-added">+  TEXT_PROPS,</div><div> } from '../shared/default-shape-constants'</div><div class="diff-removed">-</div><div class="diff-removed">-import { startEditingShapeWithLabel } from '../../tools/SelectTool/selectHelpers'</div><div class="diff-removed">-</div><div class="diff-removed">-import isEqual from 'lodash.isequal'</div><div class="diff-removed">-import {</div><div class="diff-removed">-	isEmptyRichText,</div><div class="diff-removed">-	renderHtmlFromRichTextForMeasurement,</div><div class="diff-removed">-	renderPlaintextFromRichText,</div><div class="diff-removed">-} from '../../utils/text/richText'</div><div> import { useDefaultColorTheme } from '../shared/useDefaultColorTheme'</div><div> import { useIsReadyForEditing } from '../shared/useEditablePlainText'</div><div class="diff-added">+import isEqual from 'lodash.isequal'</div><div> import {</div><div class="diff-removed">-	CLONE_HANDLE_MARGIN,</div><div class="diff-removed">-	NOTE_CENTER_OFFSET,</div><div class="diff-removed">-	NOTE_SIZE,</div><div class="diff-removed">-	getNoteShapeForAdjacentPosition,</div><div class="diff-removed">-} from './noteHelpers'</div><div class="diff-added">+  isEmptyRichText,</div><div class="diff-added">+  renderHtmlFromRichTextForMeasurement,</div><div class="diff-added">+  renderPlaintextFromRichText,</div><div class="diff-added">+} from '../../utils/text/richText'</div><div> </div><div> /** @public */</div><div> export interface NoteShapeOptions {</div><div class="diff-removed">-	/**</div><div class="diff-removed">-	 * How should the note shape resize? By default it does not resize (except automatically based on its text content),</div><div class="diff-removed">-	 * but you can set it to be user-resizable using scale.</div><div class="diff-removed">-	 */</div><div class="diff-removed">-	resizeMode: 'none' | 'scale'</div><div class="diff-added">+  /**</div><div class="diff-added">+   * How should the note shape resize? By default it does not resize (except automatically based on its text content),</div><div class="diff-added">+   * but you can set it to be user-resizable using scale.</div><div class="diff-added">+   */</div><div class="diff-added">+  resizeMode: 'none' | 'scale'</div><div> }</div><div> </div><div> /** @public */</div><div> export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {</div><div class="diff-removed">-	static override type = 'note' as const</div><div class="diff-removed">-	static override props = noteShapeProps</div><div class="diff-removed">-	static override migrations = noteShapeMigrations</div><div class="diff-removed">-</div><div class="diff-removed">-	override options: NoteShapeOptions = {</div><div class="diff-removed">-		resizeMode: 'none',</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	override canEdit() {</div><div class="diff-removed">-		return true</div><div class="diff-removed">-	}</div><div class="diff-removed">-	override hideResizeHandles() {</div><div class="diff-removed">-		const { resizeMode } = this.options</div><div class="diff-removed">-		switch (resizeMode) {</div><div class="diff-removed">-			case 'none': {</div><div class="diff-removed">-				return true</div><div class="diff-removed">-			}</div><div class="diff-removed">-			case 'scale': {</div><div class="diff-removed">-				return false</div><div class="diff-removed">-			}</div><div class="diff-removed">-			default: {</div><div class="diff-removed">-				throw exhaustiveSwitchError(resizeMode)</div><div class="diff-removed">-			}</div><div class="diff-removed">-		}</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	override isAspectRatioLocked() {</div><div class="diff-removed">-		return this.options.resizeMode === 'scale'</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	override hideSelectionBoundsFg() {</div><div class="diff-removed">-		return false</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	getDefaultProps(): TLNoteShape['props'] {</div><div class="diff-removed">-		return {</div><div class="diff-removed">-			color: 'black',</div><div class="diff-removed">-			richText: toRichText(''),</div><div class="diff-removed">-			size: 'm',</div><div class="diff-removed">-			font: 'draw',</div><div class="diff-removed">-			align: 'middle',</div><div class="diff-removed">-			verticalAlign: 'middle',</div><div class="diff-removed">-			labelColor: 'black',</div><div class="diff-removed">-			growY: 0,</div><div class="diff-removed">-			fontSizeAdjustment: 0,</div><div class="diff-removed">-			url: '',</div><div class="diff-removed">-			scale: 1,</div><div class="diff-removed">-		}</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	getGeometry(shape: TLNoteShape) {</div><div class="diff-removed">-		const { labelHeight, labelWidth } = getLabelSize(this.editor, shape)</div><div class="diff-removed">-		const { scale } = shape.props</div><div class="diff-removed">-</div><div class="diff-removed">-		const lh = labelHeight * scale</div><div class="diff-removed">-		const lw = labelWidth * scale</div><div class="diff-removed">-		const nw = NOTE_SIZE * scale</div><div class="diff-removed">-		const nh = getNoteHeight(shape)</div><div class="diff-removed">-</div><div class="diff-removed">-		return new Group2d({</div><div class="diff-removed">-			children: [</div><div class="diff-removed">-				new Rectangle2d({ width: nw, height: nh, isFilled: true }),</div><div class="diff-removed">-				new Rectangle2d({</div><div class="diff-removed">-					x:</div><div class="diff-removed">-						shape.props.align === 'start'</div><div class="diff-removed">-							? 0</div><div class="diff-removed">-							: shape.props.align === 'end'</div><div class="diff-removed">-								? nw - lw</div><div class="diff-removed">-								: (nw - lw) / 2,</div><div class="diff-removed">-					y:</div><div class="diff-removed">-						shape.props.verticalAlign === 'start'</div><div class="diff-removed">-							? 0</div><div class="diff-removed">-							: shape.props.verticalAlign === 'end'</div><div class="diff-removed">-								? nh - lh</div><div class="diff-removed">-								: (nh - lh) / 2,</div><div class="diff-removed">-					width: lw,</div><div class="diff-removed">-					height: lh,</div><div class="diff-removed">-					isFilled: true,</div><div class="diff-removed">-					isLabel: true,</div><div class="diff-removed">-				}),</div><div class="diff-removed">-			],</div><div class="diff-removed">-		})</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	override getHandles(shape: TLNoteShape): TLHandle[] {</div><div class="diff-removed">-		const { scale } = shape.props</div><div class="diff-removed">-		const isCoarsePointer = this.editor.getInstanceState().isCoarsePointer</div><div class="diff-removed">-		if (isCoarsePointer) return []</div><div class="diff-removed">-</div><div class="diff-removed">-		const zoom = this.editor.getZoomLevel()</div><div class="diff-removed">-		if (zoom * scale < 0.25) return []</div><div class="diff-removed">-</div><div class="diff-removed">-		const nh = getNoteHeight(shape)</div><div class="diff-removed">-		const nw = NOTE_SIZE * scale</div><div class="diff-removed">-		const offset = (CLONE_HANDLE_MARGIN / zoom) * scale</div><div class="diff-removed">-</div><div class="diff-removed">-		if (zoom * scale < 0.5) {</div><div class="diff-removed">-			return [</div><div class="diff-removed">-				{</div><div class="diff-removed">-					id: 'bottom',</div><div class="diff-removed">-					index: 'a3' as IndexKey,</div><div class="diff-removed">-					type: 'clone',</div><div class="diff-removed">-					x: nw / 2,</div><div class="diff-removed">-					y: nh + offset,</div><div class="diff-removed">-				},</div><div class="diff-removed">-			]</div><div class="diff-removed">-		}</div><div class="diff-removed">-</div><div class="diff-removed">-		return [</div><div class="diff-removed">-			{</div><div class="diff-removed">-				id: 'top',</div><div class="diff-removed">-				index: 'a1' as IndexKey,</div><div class="diff-removed">-				type: 'clone',</div><div class="diff-removed">-				x: nw / 2,</div><div class="diff-removed">-				y: -offset,</div><div class="diff-removed">-			},</div><div class="diff-removed">-			{</div><div class="diff-removed">-				id: 'right',</div><div class="diff-removed">-				index: 'a2' as IndexKey,</div><div class="diff-removed">-				type: 'clone',</div><div class="diff-removed">-				x: nw + offset,</div><div class="diff-removed">-				y: nh / 2,</div><div class="diff-removed">-			},</div><div class="diff-removed">-			{</div><div class="diff-removed">-				id: 'bottom',</div><div class="diff-removed">-				index: 'a3' as IndexKey,</div><div class="diff-removed">-				type: 'clone',</div><div class="diff-removed">-				x: nw / 2,</div><div class="diff-removed">-				y: nh + offset,</div><div class="diff-removed">-			},</div><div class="diff-removed">-			{</div><div class="diff-removed">-				id: 'left',</div><div class="diff-removed">-				index: 'a4' as IndexKey,</div><div class="diff-removed">-				type: 'clone',</div><div class="diff-removed">-				x: -offset,</div><div class="diff-removed">-				y: nh / 2,</div><div class="diff-removed">-			},</div><div class="diff-removed">-		]</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	override onResize(shape: any, info: TLResizeInfo<any>) {</div><div class="diff-removed">-		const { resizeMode } = this.options</div><div class="diff-removed">-		switch (resizeMode) {</div><div class="diff-removed">-			case 'none': {</div><div class="diff-removed">-				return undefined</div><div class="diff-removed">-			}</div><div class="diff-removed">-			case 'scale': {</div><div class="diff-removed">-				return resizeScaled(shape, info)</div><div class="diff-removed">-			}</div><div class="diff-removed">-			default: {</div><div class="diff-removed">-				throw exhaustiveSwitchError(resizeMode)</div><div class="diff-removed">-			}</div><div class="diff-removed">-		}</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	override getText(shape: TLNoteShape) {</div><div class="diff-removed">-		return renderPlaintextFromRichText(this.editor, shape.props.richText)</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	override getFontFaces(shape: TLNoteShape): TLFontFace[] {</div><div class="diff-removed">-		return getFontsFromRichText(this.editor, shape.props.richText, {</div><div class="diff-removed">-			family: `tldraw_${shape.props.font}`,</div><div class="diff-removed">-			weight: 'normal',</div><div class="diff-removed">-			style: 'normal',</div><div class="diff-removed">-		})</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	component(shape: TLNoteShape) {</div><div class="diff-removed">-		const {</div><div class="diff-removed">-			id,</div><div class="diff-removed">-			type,</div><div class="diff-removed">-			props: {</div><div class="diff-removed">-				labelColor,</div><div class="diff-removed">-				scale,</div><div class="diff-removed">-				color,</div><div class="diff-removed">-				font,</div><div class="diff-removed">-				size,</div><div class="diff-removed">-				align,</div><div class="diff-removed">-				richText,</div><div class="diff-removed">-				verticalAlign,</div><div class="diff-removed">-				fontSizeAdjustment,</div><div class="diff-removed">-			},</div><div class="diff-removed">-		} = shape</div><div class="diff-removed">-</div><div class="diff-removed">-		const handleKeyDown = useNoteKeydownHandler(id)</div><div class="diff-removed">-</div><div class="diff-removed">-		const theme = useDefaultColorTheme()</div><div class="diff-removed">-		const nw = NOTE_SIZE * scale</div><div class="diff-removed">-		const nh = getNoteHeight(shape)</div><div class="diff-removed">-</div><div class="diff-removed">-		const rotation = useValue(</div><div class="diff-removed">-			'shape rotation',</div><div class="diff-removed">-			() => this.editor.getShapePageTransform(id)?.rotation() ?? 0,</div><div class="diff-removed">-			[this.editor]</div><div class="diff-removed">-		)</div><div class="diff-removed">-</div><div class="diff-removed">-		// todo: consider hiding shadows on dark mode if they're invisible anyway</div><div class="diff-removed">-</div><div class="diff-removed">-		const hideShadows = useValue('zoom', () => this.editor.getZoomLevel() < 0.35 / scale, [</div><div class="diff-removed">-			scale,</div><div class="diff-removed">-			this.editor,</div><div class="diff-removed">-		])</div><div class="diff-removed">-</div><div class="diff-removed">-		const isDarkMode = useValue('dark mode', () => this.editor.user.getIsDarkMode(), [this.editor])</div><div class="diff-removed">-</div><div class="diff-removed">-		const isSelected = shape.id === this.editor.getOnlySelectedShapeId()</div><div class="diff-removed">-</div><div class="diff-removed">-		const isReadyForEditing = useIsReadyForEditing(this.editor, shape.id)</div><div class="diff-removed">-		const isEmpty = isEmptyRichText(richText)</div><div class="diff-removed">-</div><div class="diff-removed">-		return (</div><div class="diff-removed">-			<></div><div class="diff-removed">-				<div</div><div class="diff-removed">-					id={id}</div><div class="diff-removed">-					className="tl-note__container"</div><div class="diff-removed">-					style={{</div><div class="diff-removed">-						width: nw,</div><div class="diff-removed">-						height: nh,</div><div class="diff-removed">-						backgroundColor: theme[color].note.fill,</div><div class="diff-removed">-						borderBottom: hideShadows</div><div class="diff-removed">-							? isDarkMode</div><div class="diff-removed">-								? `${2 * scale}px solid rgb(20, 20, 20)`</div><div class="diff-removed">-								: `${2 * scale}px solid rgb(144, 144, 144)`</div><div class="diff-removed">-							: 'none',</div><div class="diff-removed">-						boxShadow: hideShadows ? 'none' : getNoteShadow(shape.id, rotation, scale),</div><div class="diff-removed">-					}}</div><div class="diff-removed">-				></div><div class="diff-removed">-					{(isSelected || isReadyForEditing || !isEmpty) && (</div><div class="diff-removed">-						<RichTextLabel</div><div class="diff-removed">-							shapeId={id}</div><div class="diff-removed">-							type={type}</div><div class="diff-removed">-							font={font}</div><div class="diff-removed">-							fontSize={(fontSizeAdjustment || LABEL_FONT_SIZES[size]) * scale}</div><div class="diff-removed">-							lineHeight={TEXT_PROPS.lineHeight}</div><div class="diff-removed">-							align={align}</div><div class="diff-removed">-							verticalAlign={verticalAlign}</div><div class="diff-removed">-							richText={richText}</div><div class="diff-removed">-							isSelected={isSelected}</div><div class="diff-removed">-							labelColor={labelColor === 'black' ? theme[color].note.text : theme[labelColor].fill}</div><div class="diff-removed">-							wrap</div><div class="diff-removed">-							padding={LABEL_PADDING * scale}</div><div class="diff-removed">-							hasCustomTabBehavior</div><div class="diff-removed">-							onKeyDown={handleKeyDown}</div><div class="diff-removed">-						/></div><div class="diff-removed">-					)}</div><div class="diff-removed">-				</div></div><div class="diff-removed">-				{'url' in shape.props && shape.props.url && <HyperlinkButton url={shape.props.url} />}</div><div class="diff-removed">-			</></div><div class="diff-removed">-		)</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	indicator(shape: TLNoteShape) {</div><div class="diff-removed">-		const { scale } = shape.props</div><div class="diff-removed">-		return (</div><div class="diff-removed">-			<rect</div><div class="diff-removed">-				rx={scale}</div><div class="diff-removed">-				width={toDomPrecision(NOTE_SIZE * scale)}</div><div class="diff-removed">-				height={toDomPrecision(getNoteHeight(shape))}</div><div class="diff-removed">-			/></div><div class="diff-removed">-		)</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	override toSvg(shape: TLNoteShape, ctx: SvgExportContext) {</div><div class="diff-removed">-		const theme = getDefaultColorTheme({ isDarkMode: ctx.isDarkMode })</div><div class="diff-removed">-		const bounds = getBoundsForSVG(shape)</div><div class="diff-removed">-</div><div class="diff-removed">-		const textLabel = (</div><div class="diff-removed">-			<RichTextSVG</div><div class="diff-removed">-				fontSize={shape.props.fontSizeAdjustment || LABEL_FONT_SIZES[shape.props.size]}</div><div class="diff-removed">-				font={shape.props.font}</div><div class="diff-removed">-				align={shape.props.align}</div><div class="diff-removed">-				verticalAlign={shape.props.verticalAlign}</div><div class="diff-removed">-				richText={shape.props.richText}</div><div class="diff-removed">-				labelColor={theme[shape.props.color].note.text}</div><div class="diff-removed">-				bounds={bounds}</div><div class="diff-removed">-				padding={LABEL_PADDING * shape.props.scale}</div><div class="diff-removed">-			/></div><div class="diff-removed">-		)</div><div class="diff-removed">-</div><div class="diff-removed">-		return (</div><div class="diff-removed">-			<></div><div class="diff-removed">-				<rect x={5} y={5} rx={1} width={NOTE_SIZE - 10} height={bounds.h} fill="rgba(0,0,0,.1)" /></div><div class="diff-removed">-				<rect</div><div class="diff-removed">-					rx={1}</div><div class="diff-removed">-					width={NOTE_SIZE}</div><div class="diff-removed">-					height={bounds.h}</div><div class="diff-removed">-					fill={theme[shape.props.color].note.fill}</div><div class="diff-removed">-				/></div><div class="diff-removed">-				{textLabel}</div><div class="diff-removed">-			</></div><div class="diff-removed">-		)</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	override onBeforeCreate(next: TLNoteShape) {</div><div class="diff-removed">-		return getNoteSizeAdjustments(this.editor, next)</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	override onBeforeUpdate(prev: TLNoteShape, next: TLNoteShape) {</div><div class="diff-removed">-		if (</div><div class="diff-removed">-			isEqual(prev.props.richText, next.props.richText) &&</div><div class="diff-removed">-			prev.props.font === next.props.font &&</div><div class="diff-removed">-			prev.props.size === next.props.size</div><div class="diff-removed">-		) {</div><div class="diff-removed">-			return</div><div class="diff-removed">-		}</div><div class="diff-removed">-</div><div class="diff-removed">-		return getNoteSizeAdjustments(this.editor, next)</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	override getInterpolatedProps(</div><div class="diff-removed">-		startShape: TLNoteShape,</div><div class="diff-removed">-		endShape: TLNoteShape,</div><div class="diff-removed">-		t: number</div><div class="diff-removed">-	): TLNoteShapeProps {</div><div class="diff-removed">-		return {</div><div class="diff-removed">-			...(t > 0.5 ? endShape.props : startShape.props),</div><div class="diff-removed">-			scale: lerp(startShape.props.scale, endShape.props.scale, t),</div><div class="diff-removed">-		}</div><div class="diff-removed">-	}</div><div class="diff-added">+  static override type = 'note' as const</div><div class="diff-added">+  static override props = noteShapeProps</div><div class="diff-added">+  static override migrations = noteShapeMigrations</div><div class="diff-added">+</div><div class="diff-added">+  override options: NoteShapeOptions = {</div><div class="diff-added">+    resizeMode: 'none',</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  override canEdit() {</div><div class="diff-added">+    return true</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  override hideResizeHandles() {</div><div class="diff-added">+    const { resizeMode } = this.options</div><div class="diff-added">+    switch (resizeMode) {</div><div class="diff-added">+      case 'none':</div><div class="diff-added">+        return true</div><div class="diff-added">+      case 'scale':</div><div class="diff-added">+        return false</div><div class="diff-added">+      default:</div><div class="diff-added">+        throw exhaustiveSwitchError(resizeMode)</div><div class="diff-added">+    }</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  override isAspectRatioLocked() {</div><div class="diff-added">+    return this.options.resizeMode === 'scale'</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  override hideSelectionBoundsFg() {</div><div class="diff-added">+    return false</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  override getDefaultProps(): TLNoteShapeProps {</div><div class="diff-added">+    return {</div><div class="diff-added">+      color: 'black',</div><div class="diff-added">+      richText: toRichText(''),</div><div class="diff-added">+      size: 'm',</div><div class="diff-added">+      font: 'draw',</div><div class="diff-added">+      align: 'middle',</div><div class="diff-added">+      verticalAlign: 'middle',</div><div class="diff-added">+      labelColor: 'black',</div><div class="diff-added">+      growY: 0,</div><div class="diff-added">+      fontSizeAdjustment: 0,</div><div class="diff-added">+      url: '',</div><div class="diff-added">+      scale: 1,</div><div class="diff-added">+    }</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  override getGeometry(shape: TLNoteShape) {</div><div class="diff-added">+    const { labelHeight, labelWidth } = getLabelSize(this.editor, shape)</div><div class="diff-added">+    const { scale } = shape.props</div><div class="diff-added">+    const lh = labelHeight * scale</div><div class="diff-added">+    const lw = labelWidth * scale</div><div class="diff-added">+    const nw = NOTE_SIZE * scale</div><div class="diff-added">+    const nh = getNoteHeight(shape)</div><div class="diff-added">+</div><div class="diff-added">+    return new Group2d({</div><div class="diff-added">+      children: [</div><div class="diff-added">+        new Rectangle2d({ width: nw, height: nh, isFilled: true }),</div><div class="diff-added">+        new Rectangle2d({</div><div class="diff-added">+          x:</div><div class="diff-added">+            shape.props.align === 'start'</div><div class="diff-added">+              ? 0</div><div class="diff-added">+              : shape.props.align === 'end'</div><div class="diff-added">+              ? nw - lw</div><div class="diff-added">+              : (nw - lw) / 2,</div><div class="diff-added">+          y:</div><div class="diff-added">+            shape.props.verticalAlign === 'start'</div><div class="diff-added">+              ? 0</div><div class="diff-added">+              : shape.props.verticalAlign === 'end'</div><div class="diff-added">+              ? nh - lh</div><div class="diff-added">+              : (nh - lh) / 2,</div><div class="diff-added">+          width: lw,</div><div class="diff-added">+          height: lh,</div><div class="diff-added">+          isFilled: true,</div><div class="diff-added">+          isLabel: true,</div><div class="diff-added">+        }),</div><div class="diff-added">+      ],</div><div class="diff-added">+    })</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  override getHandles(shape: TLNoteShape) {</div><div class="diff-added">+    const { scale } = shape.props</div><div class="diff-added">+    const isCoarsePointer = this.editor.getInstanceState().isCoarsePointer</div><div class="diff-added">+    if (isCoarsePointer) return []</div><div class="diff-added">+</div><div class="diff-added">+    const zoom = this.editor.getZoomLevel()</div><div class="diff-added">+    if (zoom * scale < 0.25) return []</div><div class="diff-added">+</div><div class="diff-added">+    const nh = getNoteHeight(shape)</div><div class="diff-added">+    const nw = NOTE_SIZE * scale</div><div class="diff-added">+    const offset = (CLONE_HANDLE_MARGIN / zoom) * scale</div><div class="diff-added">+</div><div class="diff-added">+    if (zoom * scale < 0.5) {</div><div class="diff-added">+      return [</div><div class="diff-added">+        {</div><div class="diff-added">+          id: 'bottom',</div><div class="diff-added">+          index: 'a3' as IndexKey,</div><div class="diff-added">+          type: 'clone',</div><div class="diff-added">+          x: nw / 2,</div><div class="diff-added">+          y: nh + offset,</div><div class="diff-added">+        },</div><div class="diff-added">+      ]</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    return [</div><div class="diff-added">+      {</div><div class="diff-added">+        id: 'top',</div><div class="diff-added">+        index: 'a1' as IndexKey,</div><div class="diff-added">+        type: 'clone',</div><div class="diff-added">+        x: nw / 2,</div><div class="diff-added">+        y: -offset,</div><div class="diff-added">+      },</div><div class="diff-added">+      {</div><div class="diff-added">+        id: 'right',</div><div class="diff-added">+        index: 'a2' as IndexKey,</div><div class="diff-added">+        type: 'clone',</div><div class="diff-added">+        x: nw + offset,</div><div class="diff-added">+        y: nh / 2,</div><div class="diff-added">+      },</div><div class="diff-added">+      {</div><div class="diff-added">+        id: 'bottom',</div><div class="diff-added">+        index: 'a3' as IndexKey,</div><div class="diff-added">+        type: 'clone',</div><div class="diff-added">+        x: nw / 2,</div><div class="diff-added">+        y: nh + offset,</div><div class="diff-added">+      },</div><div class="diff-added">+      {</div><div class="diff-added">+        id: 'left',</div><div class="diff-added">+        index: 'a4' as IndexKey,</div><div class="diff-added">+        type: 'clone',</div><div class="diff-added">+        x: -offset,</div><div class="diff-added">+        y: nh / 2,</div><div class="diff-added">+      },</div><div class="diff-added">+    ]</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  override getText(shape: TLNoteShape) {</div><div class="diff-added">+    return renderPlaintextFromRichText(this.editor, shape.props.richText)</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  override getFontFaces(shape: TLNoteShape) {</div><div class="diff-added">+    return getFontsFromRichText(this.editor, shape.props.richText, {</div><div class="diff-added">+      family: `tldraw_${shape.props.font}`,</div><div class="diff-added">+      weight: 'normal',</div><div class="diff-added">+      style: 'normal',</div><div class="diff-added">+    })</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  component(shape: TLNoteShape) {</div><div class="diff-added">+    const {</div><div class="diff-added">+      id,</div><div class="diff-added">+      type,</div><div class="diff-added">+      props: {</div><div class="diff-added">+        labelColor,</div><div class="diff-added">+        scale,</div><div class="diff-added">+        color,</div><div class="diff-added">+        font,</div><div class="diff-added">+        size,</div><div class="diff-added">+        align,</div><div class="diff-added">+        verticalAlign,</div><div class="diff-added">+        fontSizeAdjustment,</div><div class="diff-added">+        richText,</div><div class="diff-added">+      },</div><div class="diff-added">+    } = shape</div><div class="diff-added">+</div><div class="diff-added">+    const handleKeyDown = useNoteKeydownHandler(id)</div><div class="diff-added">+    const theme = useDefaultColorTheme()</div><div class="diff-added">+    const nw = NOTE_SIZE * scale</div><div class="diff-added">+    const nh = getNoteHeight(shape)</div><div class="diff-added">+    const rotation = useValue(</div><div class="diff-added">+      'shape rotation',</div><div class="diff-added">+      () => this.editor.getShapePageTransform(id)?.rotation() ?? 0,</div><div class="diff-added">+      [this.editor]</div><div class="diff-added">+    )</div><div class="diff-added">+    const hideShadows = useValue(</div><div class="diff-added">+      'zoom',</div><div class="diff-added">+      () => this.editor.getZoomLevel() < 0.35 / scale,</div><div class="diff-added">+      [scale, this.editor]</div><div class="diff-added">+    )</div><div class="diff-added">+    const isDarkMode = useValue('dark mode', () => this.editor.user.getIsDarkMode(), [this.editor])</div><div class="diff-added">+    const isSelected = shape.id === this.editor.getOnlySelectedShapeId()</div><div class="diff-added">+    const isReadyForEditing = useIsReadyForEditing(this.editor, shape.id)</div><div class="diff-added">+    const isEmpty = isEmptyRichText(richText)</div><div class="diff-added">+</div><div class="diff-added">+    return (</div><div class="diff-added">+      <></div><div class="diff-added">+        <div</div><div class="diff-added">+          data-shape-id={id}</div><div class="diff-added">+          className="tl-note__container"</div><div class="diff-added">+          style={{</div><div class="diff-added">+            width: nw,</div><div class="diff-added">+            height: nh,</div><div class="diff-added">+            backgroundColor: theme[color].note.fill,</div><div class="diff-added">+            borderBottom: hideShadows</div><div class="diff-added">+              ? isDarkMode</div><div class="diff-added">+                ? `${2 * scale}px solid rgb(20, 20, 20)`</div><div class="diff-added">+                : `${2 * scale}px solid rgb(144, 144, 144)`</div><div class="diff-added">+              : 'none',</div><div class="diff-added">+            boxShadow: hideShadows ? 'none' : getNoteShadow(shape.id, rotation, scale),</div><div class="diff-added">+          }}</div><div class="diff-added">+        ></div><div class="diff-added">+          {(isSelected || isReadyForEditing || !isEmpty) && (</div><div class="diff-added">+            <RichTextLabel</div><div class="diff-added">+              shapeId={id}</div><div class="diff-added">+              type={type}</div><div class="diff-added">+              font={font}</div><div class="diff-added">+              fontSize={(fontSizeAdjustment || LABEL_FONT_SIZES[size]) * scale}</div><div class="diff-added">+              lineHeight={TEXT_PROPS.lineHeight}</div><div class="diff-added">+              align={align}</div><div class="diff-added">+              verticalAlign={verticalAlign}</div><div class="diff-added">+              richText={richText}</div><div class="diff-added">+              isSelected={isSelected}</div><div class="diff-added">+              labelColor={</div><div class="diff-added">+                labelColor === 'black'</div><div class="diff-added">+                  ? theme[color].note.text</div><div class="diff-added">+                  : theme[labelColor].fill</div><div class="diff-added">+              }</div><div class="diff-added">+              wrap</div><div class="diff-added">+              padding={LABEL_PADDING * scale}</div><div class="diff-added">+              hasCustomTabBehavior</div><div class="diff-added">+              onKeyDown={handleKeyDown}</div><div class="diff-added">+            /></div><div class="diff-added">+          )}</div><div class="diff-added">+        </div></div><div class="diff-added">+        {'url' in shape.props && shape.props.url && (</div><div class="diff-added">+          <HyperlinkButton url={shape.props.url} /></div><div class="diff-added">+        )}</div><div class="diff-added">+      </></div><div class="diff-added">+    )</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  indicator(shape: TLNoteShape) {</div><div class="diff-added">+    const { scale } = shape.props</div><div class="diff-added">+    return (</div><div class="diff-added">+      <rect</div><div class="diff-added">+        rx={scale}</div><div class="diff-added">+        width={toDomPrecision(NOTE_SIZE * scale)}</div><div class="diff-added">+        height={toDomPrecision(getNoteHeight(shape))}</div><div class="diff-added">+      /></div><div class="diff-added">+    )</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  override toSvg(shape: TLNoteShape, ctx: SvgExportContext) {</div><div class="diff-added">+    const theme = getDefaultColorTheme({ isDarkMode: ctx.isDarkMode })</div><div class="diff-added">+    const bounds = getBoundsForSVG(shape)</div><div class="diff-added">+    const textLabel = (</div><div class="diff-added">+      <RichTextSVG</div><div class="diff-added">+        fontSize={shape.props.fontSizeAdjustment || LABEL_FONT_SIZES[shape.props.size]}</div><div class="diff-added">+        font={shape.props.font}</div><div class="diff-added">+        align={shape.props.align}</div><div class="diff-added">+        verticalAlign={shape.props.verticalAlign}</div><div class="diff-added">+        richText={shape.props.richText}</div><div class="diff-added">+        labelColor={theme[shape.props.color].note.text}</div><div class="diff-added">+        bounds={bounds}</div><div class="diff-added">+        padding={LABEL_PADDING * shape.props.scale}</div><div class="diff-added">+      /></div><div class="diff-added">+    )</div><div class="diff-added">+</div><div class="diff-added">+    return (</div><div class="diff-added">+      <></div><div class="diff-added">+        <rect x={5} y={5} rx={1} width={NOTE_SIZE - 10} height={bounds.h} fill="rgba(0,0,0,.1)" /></div><div class="diff-added">+        <rect rx={1} width={NOTE_SIZE} height={bounds.h} fill={theme[shape.props.color].note.fill} /></div><div class="diff-added">+        {textLabel}</div><div class="diff-added">+      </></div><div class="diff-added">+    )</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  override onBeforeCreate(next: TLNoteShape) {</div><div class="diff-added">+    return getNoteSizeAdjustments(this.editor, next)</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  override onBeforeUpdate(prev: TLNoteShape, next: TLNoteShape) {</div><div class="diff-added">+    if (</div><div class="diff-added">+      isEqual(prev.props.richText, next.props.richText) &&</div><div class="diff-added">+      prev.props.font === next.props.font &&</div><div class="diff-added">+      prev.props.size === next.props.size</div><div class="diff-added">+    ) {</div><div class="diff-added">+      return</div><div class="diff-added">+    }</div><div class="diff-added">+    return getNoteSizeAdjustments(this.editor, next)</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  override onResize(shape: TLNoteShape, info: TLResizeInfo<TLNoteShape>) {</div><div class="diff-added">+    const { resizeMode } = this.options</div><div class="diff-added">+    switch (resizeMode) {</div><div class="diff-added">+      case 'none':</div><div class="diff-added">+        return</div><div class="diff-added">+      case 'scale':</div><div class="diff-added">+        return resizeScaled(shape, info)</div><div class="diff-added">+      default:</div><div class="diff-added">+        throw exhaustiveSwitchError(resizeMode)</div><div class="diff-added">+    }</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  override getInterpolatedProps(</div><div class="diff-added">+    startShape: TLNoteShape,</div><div class="diff-added">+    endShape: TLNoteShape,</div><div class="diff-added">+    t: number</div><div class="diff-added">+  ): TLNoteShapeProps {</div><div class="diff-added">+    return {</div><div class="diff-added">+      ...(t > 0.5 ? endShape.props : startShape.props),</div><div class="diff-added">+      scale: lerp(startShape.props.scale, endShape.props.scale, t),</div><div class="diff-added">+    }</div><div class="diff-added">+  }</div><div> }</div><div> </div><div class="diff-removed">-/**</div><div class="diff-removed">- * Get the growY and fontSizeAdjustment for a shape.</div><div class="diff-removed">- */</div><div> function getNoteSizeAdjustments(editor: Editor, shape: TLNoteShape) {</div><div class="diff-removed">-	const { labelHeight, fontSizeAdjustment } = getLabelSize(editor, shape)</div><div class="diff-removed">-	// When the label height is more than the height of the shape, we add extra height to it</div><div class="diff-removed">-	const growY = Math.max(0, labelHeight - NOTE_SIZE)</div><div class="diff-removed">-</div><div class="diff-removed">-	if (growY !== shape.props.growY || fontSizeAdjustment !== shape.props.fontSizeAdjustment) {</div><div class="diff-removed">-		return {</div><div class="diff-removed">-			...shape,</div><div class="diff-removed">-			props: {</div><div class="diff-removed">-				...shape.props,</div><div class="diff-removed">-				growY,</div><div class="diff-removed">-				fontSizeAdjustment,</div><div class="diff-removed">-			},</div><div class="diff-removed">-		}</div><div class="diff-removed">-	}</div><div class="diff-added">+  const { labelHeight, fontSizeAdjustment } = getLabelSize(editor, shape)</div><div class="diff-added">+  const growY = Math.max(0, labelHeight - NOTE_SIZE)</div><div class="diff-added">+</div><div class="diff-added">+  if (growY !== shape.props.growY || fontSizeAdjustment !== shape.props.fontSizeAdjustment) {</div><div class="diff-added">+    return {</div><div class="diff-added">+      ...shape,</div><div class="diff-added">+      props: {</div><div class="diff-added">+        ...shape.props,</div><div class="diff-added">+        growY,</div><div class="diff-added">+        fontSizeAdjustment,</div><div class="diff-added">+      },</div><div class="diff-added">+    }</div><div class="diff-added">+  }</div><div> }</div><div> </div><div class="diff-removed">-/**</div><div class="diff-removed">- * Get the label size for a note.</div><div class="diff-removed">- */</div><div> function getNoteLabelSize(editor: Editor, shape: TLNoteShape) {</div><div class="diff-removed">-	const { richText } = shape.props</div><div class="diff-removed">-</div><div class="diff-removed">-	if (isEmptyRichText(richText)) {</div><div class="diff-removed">-		const minHeight = LABEL_FONT_SIZES[shape.props.size] * TEXT_PROPS.lineHeight + LABEL_PADDING * 2</div><div class="diff-removed">-		return { labelHeight: minHeight, labelWidth: 100, fontSizeAdjustment: 0 }</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	const unadjustedFontSize = LABEL_FONT_SIZES[shape.props.size]</div><div class="diff-removed">-</div><div class="diff-removed">-	let fontSizeAdjustment = 0</div><div class="diff-removed">-	let iterations = 0</div><div class="diff-removed">-	let labelHeight = NOTE_SIZE</div><div class="diff-removed">-	let labelWidth = NOTE_SIZE</div><div class="diff-removed">-</div><div class="diff-removed">-	// N.B. For some note shapes with text like 'hjhjhjhjhjhjhjhj', you'll run into</div><div class="diff-removed">-	// some text measurement fuzziness where the browser swears there's no overflow (scrollWidth === width)</div><div class="diff-removed">-	// but really there is when you enable overflow-wrap again. This helps account for that little bit</div><div class="diff-removed">-	// of give.</div><div class="diff-removed">-	const FUZZ = 1</div><div class="diff-removed">-</div><div class="diff-removed">-	// We slightly make the font smaller if the text is too big for the note, width-wise.</div><div class="diff-removed">-	do {</div><div class="diff-removed">-		fontSizeAdjustment = Math.min(unadjustedFontSize, unadjustedFontSize - iterations)</div><div class="diff-removed">-		const html = renderHtmlFromRichTextForMeasurement(editor, richText)</div><div class="diff-removed">-		const nextTextSize = editor.textMeasure.measureHtml(html, {</div><div class="diff-removed">-			...TEXT_PROPS,</div><div class="diff-removed">-			fontFamily: FONT_FAMILIES[shape.props.font],</div><div class="diff-removed">-			fontSize: fontSizeAdjustment,</div><div class="diff-removed">-			maxWidth: NOTE_SIZE - LABEL_PADDING * 2 - FUZZ,</div><div class="diff-removed">-			disableOverflowWrapBreaking: true,</div><div class="diff-removed">-		})</div><div class="diff-removed">-</div><div class="diff-removed">-		labelHeight = nextTextSize.h + LABEL_PADDING * 2</div><div class="diff-removed">-		labelWidth = nextTextSize.w + LABEL_PADDING * 2</div><div class="diff-removed">-</div><div class="diff-removed">-		if (fontSizeAdjustment <= 14) {</div><div class="diff-removed">-			// Too small, just rely now on CSS `overflow-wrap: break-word`</div><div class="diff-removed">-			// We need to recalculate the text measurement here with break-word enabled.</div><div class="diff-removed">-			const html = renderHtmlFromRichTextForMeasurement(editor, richText)</div><div class="diff-removed">-			const nextTextSizeWithOverflowBreak = editor.textMeasure.measureHtml(html, {</div><div class="diff-removed">-				...TEXT_PROPS,</div><div class="diff-removed">-				fontFamily: FONT_FAMILIES[shape.props.font],</div><div class="diff-removed">-				fontSize: fontSizeAdjustment,</div><div class="diff-removed">-				maxWidth: NOTE_SIZE - LABEL_PADDING * 2 - FUZZ,</div><div class="diff-removed">-			})</div><div class="diff-removed">-			labelHeight = nextTextSizeWithOverflowBreak.h + LABEL_PADDING * 2</div><div class="diff-removed">-			labelWidth = nextTextSizeWithOverflowBreak.w + LABEL_PADDING * 2</div><div class="diff-removed">-			break</div><div class="diff-removed">-		}</div><div class="diff-removed">-</div><div class="diff-removed">-		if (nextTextSize.scrollWidth.toFixed(0) === nextTextSize.w.toFixed(0)) {</div><div class="diff-removed">-			break</div><div class="diff-removed">-		}</div><div class="diff-removed">-	} while (iterations++ < 50)</div><div class="diff-removed">-</div><div class="diff-removed">-	return {</div><div class="diff-removed">-		labelHeight: labelHeight,</div><div class="diff-removed">-		labelWidth: labelWidth,</div><div class="diff-removed">-		fontSizeAdjustment: fontSizeAdjustment,</div><div class="diff-removed">-	}</div><div class="diff-added">+  const { richText } = shape.props</div><div class="diff-added">+</div><div class="diff-added">+  if (isEmptyRichText(richText)) {</div><div class="diff-added">+    const minHeight = LABEL_FONT_SIZES[shape.props.size] * TEXT_PROPS.lineHeight + LABEL_PADDING * 2</div><div class="diff-added">+    return { labelHeight: minHeight, labelWidth: 100, fontSizeAdjustment: 0 }</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  const unadjustedFontSize = LABEL_FONT_SIZES[shape.props.size]</div><div class="diff-added">+  let fontSizeAdjustment = 0</div><div class="diff-added">+  let iterations = 0</div><div class="diff-added">+  let labelHeight = NOTE_SIZE</div><div class="diff-added">+  let labelWidth = NOTE_SIZE</div><div class="diff-added">+  const FUZZ = 1</div><div class="diff-added">+</div><div class="diff-added">+  do {</div><div class="diff-added">+    fontSizeAdjustment = Math.min(unadjustedFontSize, unadjustedFontSize - iterations)</div><div class="diff-added">+    const html = renderHtmlFromRichTextForMeasurement(editor, richText)</div><div class="diff-added">+    const nextTextSize = editor.textMeasure.measureHtml(html, {</div><div class="diff-added">+      ...TEXT_PROPS,</div><div class="diff-added">+      fontFamily: FONT_FAMILIES[shape.props.font],</div><div class="diff-added">+      fontSize: fontSizeAdjustment,</div><div class="diff-added">+      maxWidth: NOTE_SIZE - LABEL_PADDING * 2 - FUZZ,</div><div class="diff-added">+      disableOverflowWrapBreaking: true,</div><div class="diff-added">+    })</div><div class="diff-added">+</div><div class="diff-added">+    labelHeight = nextTextSize.h + LABEL_PADDING * 2</div><div class="diff-added">+    labelWidth = nextTextSize.w + LABEL_PADDING * 2</div><div class="diff-added">+</div><div class="diff-added">+    if (fontSizeAdjustment <= 14) {</div><div class="diff-added">+      const nextTextSizeWithOverflowBreak = editor.textMeasure.measureHtml(html, {</div><div class="diff-added">+        ...TEXT_PROPS,</div><div class="diff-added">+        fontFamily: FONT_FAMILIES[shape.props.font],</div><div class="diff-added">+        fontSize: fontSizeAdjustment,</div><div class="diff-added">+        maxWidth: NOTE_SIZE - LABEL_PADDING * 2 - FUZZ,</div><div class="diff-added">+      })</div><div class="diff-added">+      labelHeight = nextTextSizeWithOverflowBreak.h + LABEL_PADDING * 2</div><div class="diff-added">+      labelWidth = nextTextSizeWithOverflowBreak.w + LABEL_PADDING * 2</div><div class="diff-added">+      break</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    if (nextTextSize.scrollWidth.toFixed(0) === nextTextSize.w.toFixed(0)) {</div><div class="diff-added">+      break</div><div class="diff-added">+    }</div><div class="diff-added">+  } while (iterations++ < 50)</div><div class="diff-added">+</div><div class="diff-added">+  return {</div><div class="diff-added">+    labelHeight,</div><div class="diff-added">+    labelWidth,</div><div class="diff-added">+    fontSizeAdjustment,</div><div class="diff-added">+  }</div><div> }</div><div> </div><div> const labelSizesForNote = new WeakCache<TLShape, ReturnType<typeof getNoteLabelSize>>()</div><div> </div><div> function getLabelSize(editor: Editor, shape: TLNoteShape) {</div><div class="diff-removed">-	return labelSizesForNote.get(shape, () => getNoteLabelSize(editor, shape))</div><div class="diff-added">+  return labelSizesForNote.get(shape, () => getNoteLabelSize(editor, shape))</div><div> }</div><div> </div><div> function useNoteKeydownHandler(id: TLShapeId) {</div><div class="diff-removed">-	const editor = useEditor()</div><div class="diff-removed">-	const translation = useCurrentTranslation()</div><div class="diff-removed">-</div><div class="diff-removed">-	return useCallback(</div><div class="diff-removed">-		(e: KeyboardEvent) => {</div><div class="diff-removed">-			const shape = editor.getShape<TLNoteShape>(id)</div><div class="diff-removed">-			if (!shape) return</div><div class="diff-removed">-</div><div class="diff-removed">-			const isTab = e.key === 'Tab'</div><div class="diff-removed">-			const isCmdEnter = (e.metaKey || e.ctrlKey) && e.key === 'Enter'</div><div class="diff-removed">-			if (isTab || isCmdEnter) {</div><div class="diff-removed">-				e.preventDefault()</div><div class="diff-removed">-</div><div class="diff-removed">-				const pageTransform = editor.getShapePageTransform(id)</div><div class="diff-removed">-				const pageRotation = pageTransform.rotation()</div><div class="diff-removed">-</div><div class="diff-removed">-				// Based on the inputs, calculate the offset to the next note</div><div class="diff-removed">-				// tab controls x axis (shift inverts direction set by RTL)</div><div class="diff-removed">-				// cmd enter is the y axis (shift inverts direction)</div><div class="diff-removed">-				const isRTL = !!(</div><div class="diff-removed">-					translation.dir === 'rtl' ||</div><div class="diff-removed">-					// todo: can we check a partial of the text, so that we don't have to render the whole thing?</div><div class="diff-removed">-					isRightToLeftLanguage(renderPlaintextFromRichText(editor, shape.props.richText))</div><div class="diff-removed">-				)</div><div class="diff-removed">-</div><div class="diff-removed">-				const offsetLength =</div><div class="diff-removed">-					(NOTE_SIZE +</div><div class="diff-removed">-						editor.options.adjacentShapeMargin +</div><div class="diff-removed">-						// If we're growing down, we need to account for the current shape's growY</div><div class="diff-removed">-						(isCmdEnter && !e.shiftKey ? shape.props.growY : 0)) *</div><div class="diff-removed">-					shape.props.scale</div><div class="diff-removed">-</div><div class="diff-removed">-				const adjacentCenter = new Vec(</div><div class="diff-removed">-					isTab ? (e.shiftKey != isRTL ? -1 : 1) : 0,</div><div class="diff-removed">-					isCmdEnter ? (e.shiftKey ? -1 : 1) : 0</div><div class="diff-removed">-				)</div><div class="diff-removed">-					.mul(offsetLength)</div><div class="diff-removed">-					.add(NOTE_CENTER_OFFSET.clone().mul(shape.props.scale))</div><div class="diff-removed">-					.rot(pageRotation)</div><div class="diff-removed">-					.add(pageTransform.point())</div><div class="diff-removed">-</div><div class="diff-removed">-				const newNote = getNoteShapeForAdjacentPosition(editor, shape, adjacentCenter, pageRotation)</div><div class="diff-removed">-</div><div class="diff-removed">-				if (newNote) {</div><div class="diff-removed">-					editor.markHistoryStoppingPoint('editing adjacent shape')</div><div class="diff-removed">-					startEditingShapeWithLabel(editor, newNote, true /* selectAll */)</div><div class="diff-removed">-				}</div><div class="diff-removed">-			}</div><div class="diff-removed">-		},</div><div class="diff-removed">-		[id, editor, translation.dir]</div><div class="diff-removed">-	)</div><div class="diff-added">+  const editor = useEditor()</div><div class="diff-added">+  const translation = useCurrentTranslation()</div><div class="diff-added">+</div><div class="diff-added">+  return useCallback((e: KeyboardEvent) => {</div><div class="diff-added">+    const shape = editor.getShape<TLNoteShape>(id)</div><div class="diff-added">+    if (!shape) return</div><div class="diff-added">+</div><div class="diff-added">+    const isTab = e.key === 'Tab'</div><div class="diff-added">+    const isCmdEnter = (e.metaKey || e.ctrlKey) && e.key === 'Enter'</div><div class="diff-added">+    if (!isTab && !isCmdEnter) return</div><div class="diff-added">+    e.preventDefault()</div><div class="diff-added">+</div><div class="diff-added">+    const pageTransform = editor.getShapePageTransform(id)</div><div class="diff-added">+    const pageRotation = pageTransform.rotation()</div><div class="diff-added">+    const isRTL =</div><div class="diff-added">+      translation.dir === 'rtl' ||</div><div class="diff-added">+      isRightToLeftLanguage(renderPlaintextFromRichText(editor, shape.props.richText))</div><div class="diff-added">+</div><div class="diff-added">+    const offsetLength =</div><div class="diff-added">+      (NOTE_SIZE +</div><div class="diff-added">+        editor.options.adjacentShapeMargin +</div><div class="diff-added">+        (isCmdEnter && !e.shiftKey ? shape.props.growY : 0)) *</div><div class="diff-added">+      shape.props.scale</div><div class="diff-added">+</div><div class="diff-added">+    const adjacentCenter = new Vec(</div><div class="diff-added">+      isTab ? (e.shiftKey != isRTL ? -1 : 1) : 0,</div><div class="diff-added">+      isCmdEnter ? (e.shiftKey ? -1 : 1) : 0</div><div class="diff-added">+    )</div><div class="diff-added">+      .mul(offsetLength)</div><div class="diff-added">+      .add(NOTE_CENTER_OFFSET.clone().mul(shape.props.scale))</div><div class="diff-added">+      .rot(pageRotation)</div><div class="diff-added">+      .add(pageTransform.point())</div><div class="diff-added">+</div><div class="diff-added">+    const newNote = getNoteShapeForAdjacentPosition(editor, shape, adjacentCenter, pageRotation)</div><div class="diff-added">+</div><div class="diff-added">+    if (newNote) {</div><div class="diff-added">+      editor.markHistoryStoppingPoint('editing adjacent shape')</div><div class="diff-added">+      startEditingShapeWithLabel(editor, newNote, true /* selectAll */)</div><div class="diff-added">+    }</div><div class="diff-added">+  }, [id, editor, translation.dir])</div><div> }</div><div> </div><div> function getNoteHeight(shape: TLNoteShape) {</div><div class="diff-removed">-	return (NOTE_SIZE + shape.props.growY) * shape.props.scale</div><div class="diff-added">+  return (NOTE_SIZE + shape.props.growY) * shape.props.scale</div><div> }</div><div> </div><div> function getNoteShadow(id: string, rotation: number, scale: number) {</div><div class="diff-removed">-	const random = rng(id) // seeded based on id</div><div class="diff-removed">-	const lift = Math.abs(random()) + 0.5 // 0 to 1.5</div><div class="diff-removed">-	const oy = Math.cos(rotation)</div><div class="diff-removed">-	const a = 5 * scale</div><div class="diff-removed">-	const b = 4 * scale</div><div class="diff-removed">-	const c = 6 * scale</div><div class="diff-removed">-	const d = 7 * scale</div><div class="diff-removed">-	return `0px ${a - lift}px ${a}px -${a}px rgba(15, 23, 31, .6),</div><div class="diff-removed">-	0px ${(b + lift * d) * Math.max(0, oy)}px ${c + lift * d}px -${b + lift * c}px rgba(15, 23, 31, ${(0.3 + lift * 0.1).toFixed(2)}), </div><div class="diff-removed">-	0px ${48 * scale}px ${10 * scale}px -${10 * scale}px inset rgba(15, 23, 44, ${((0.022 + random() * 0.005) * ((1 + oy) / 2)).toFixed(2)})`</div><div class="diff-added">+  const random = rng(id)</div><div class="diff-added">+  const lift = Math.abs(random()) + 0.5</div><div class="diff-added">+  const oy = Math.cos(rotation)</div><div class="diff-added">+  const a = 5 * scale</div><div class="diff-added">+  const b = 4 * scale</div><div class="diff-added">+  const c = 6 * scale</div><div class="diff-added">+  const d = 7 * scale</div><div class="diff-added">+  return `0px ${a - lift}px ${a}px -${a}px rgba(15, 23, 31, .6),</div><div class="diff-added">+0px ${(b + lift * d) * Math.max(0, oy)}px ${c + lift * d}px -${b + lift * c}px rgba(15, 23, 31, ${(0.3 + lift * 0.1).toFixed(</div><div class="diff-added">+    2</div><div class="diff-added">+  )}), </div><div class="diff-added">+0px ${48 * scale}px ${10 * scale}px -${10 * scale}px inset rgba(15, 23, 44, ${((0.022 + random() * 0.005) * ((1 + oy) / 2)).toFixed(</div><div class="diff-added">+    2</div><div class="diff-added">+  )})`</div><div> }</div><div> </div><div> function getBoundsForSVG(shape: TLNoteShape) {</div><div class="diff-removed">-	// When rendering the SVG we don't want to adjust for scale</div><div class="diff-removed">-	return new Box(0, 0, NOTE_SIZE, NOTE_SIZE + shape.props.growY)</div><div class="diff-added">+  return new Box(0, 0, NOTE_SIZE, NOTE_SIZE + shape.props.growY)</div><div> }</div><div>\ No newline at end of file</div><div></div></pre>
                </div>
            </div>
        </section>
    </main>
    <footer>
        <p>LoCoDiff-bench - <a href="https://github.com/AbanteAI/LoCoDiff-bench">GitHub Repository</a></p>
    </footer>
</body>
</html>
    