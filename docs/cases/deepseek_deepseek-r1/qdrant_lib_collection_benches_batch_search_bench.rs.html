<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case: lib/collection/benches/batch_search_bench.rs - DeepSeek R1</title>
    <link rel="stylesheet" href="../../styles.css">
</head>
<body>
    <header>
        <h1>Case: lib/collection/benches/batch_search_bench.rs</h1>
        <h2>Model: DeepSeek R1</h2>
        <p><a href="../../models/deepseek_deepseek-r1.html">All DeepSeek R1 Cases</a> | <a href="../../cases.html">All Cases</a> | <a href="../../index.html">Home</a></p>
    </header>
    <main>
        <section class="case-details">
            <div class="case-info">
                <h2>Benchmark Case Information</h2>
                <p><strong>Model:</strong> DeepSeek R1</p>
                <p><strong>Status:</strong> <span class="failure">Failure</span></p>
                <p><strong>Prompt Tokens:</strong> 24820</p>
                <p><strong>Native Prompt Tokens:</strong> 25583</p>
                <p><strong>Native Completion Tokens:</strong> 2353</p>
                <p><strong>Native Tokens Reasoning:</strong> 1001</p>
                <p><strong>Native Finish Reason:</strong> stop</p>
                <p><strong>Cost:</strong> $0.0261136</p>
            </div>
            
            <div class="content-links">
                <h2>View Content</h2>
                <ul>
                    <li><a href="../../content/deepseek_deepseek-r1/qdrant_lib_collection_benches_batch_search_bench.rs/prompt.html" class="content-link">View Prompt</a></li>
                    <li><a href="../../content/deepseek_deepseek-r1/qdrant_lib_collection_benches_batch_search_bench.rs/expected.html" class="content-link">View Expected Output</a></li>
                    <li><a href="../../content/deepseek_deepseek-r1/qdrant_lib_collection_benches_batch_search_bench.rs/actual.html" class="content-link">View Actual Output</a></li>
                </ul>
            </div>
            
            <div class="diff-section">
                <h2>Diff (Expected vs Actual)</h2>
                <div id="diff-output">
                    <pre class="diff"><div></div><div>index 91a2f434..da3b16c7 100644</div><div class="diff-header">--- a/qdrant_lib_collection_benches_batch_search_bench.rs_expectedoutput.txt (expected):tmp/tmp95hj0bdr_expected.txt	</div><div class="diff-header">+++ b/qdrant_lib_collection_benches_batch_search_bench.rs_extracted.txt (actual):tmp/tmp15y64ea6_actual.txt	</div><div class="diff-info">@@ -1,22 +1,17 @@</div><div class="diff-added">+mod prof;</div><div class="diff-added">+</div><div class="diff-added">+use std::num::NonZeroU32;</div><div> use std::sync::Arc;</div><div> </div><div class="diff-removed">-use api::rest::SearchRequestInternal;</div><div class="diff-removed">-use collection::config::{CollectionConfigInternal, CollectionParams, WalConfig};</div><div class="diff-added">+use collection::config::{CollectionConfig, CollectionParams, WalConfig};</div><div class="diff-added">+use collection::operations::point_ops::{PointInsertOperations, PointOperations, PointStruct};</div><div class="diff-added">+use collection::operations::types::{SearchRequest, SearchRequestBatch};</div><div> use collection::operations::CollectionUpdateOperations;</div><div class="diff-removed">-use collection::operations::point_ops::{</div><div class="diff-removed">-    PointInsertOperationsInternal, PointOperations, PointStructPersisted,</div><div class="diff-removed">-};</div><div class="diff-removed">-use collection::operations::types::CoreSearchRequestBatch;</div><div class="diff-removed">-use collection::operations::vector_params_builder::VectorParamsBuilder;</div><div> use collection::optimizers_builder::OptimizersConfig;</div><div class="diff-removed">-use collection::save_on_disk::SaveOnDisk;</div><div class="diff-removed">-use collection::shards::local_shard::LocalShard;</div><div class="diff-removed">-use collection::shards::shard_trait::ShardOperation;</div><div class="diff-removed">-use common::budget::ResourceBudget;</div><div class="diff-removed">-use common::counter::hardware_accumulator::HwMeasurementAcc;</div><div class="diff-removed">-use criterion::{Criterion, criterion_group, criterion_main};</div><div class="diff-removed">-use rand::rng;</div><div class="diff-removed">-use segment::data_types::vectors::{VectorStructInternal, only_default_vector};</div><div class="diff-added">+use collection::shard::local_shard::LocalShard;</div><div class="diff-added">+use collection::shard::ShardOperation;</div><div class="diff-added">+use criterion::{criterion_group, criterion_main, Criterion};</div><div class="diff-added">+use rand::thread_rng;</div><div> use segment::fixtures::payload_fixtures::random_vector;</div><div> use segment::types::{Condition, Distance, FieldCondition, Filter, Payload, Range};</div><div> use serde_json::Map;</div><div class="diff-info">@@ -24,28 +19,24 @@ use tempfile::Builder;</div><div> use tokio::runtime::Runtime;</div><div> use tokio::sync::RwLock;</div><div> </div><div class="diff-removed">-#[cfg(not(target_os = "windows"))]</div><div class="diff-removed">-mod prof;</div><div class="diff-removed">-</div><div> fn create_rnd_batch() -> CollectionUpdateOperations {</div><div class="diff-removed">-    let mut rng = rng();</div><div class="diff-added">+    let mut rng = thread_rng();</div><div>     let num_points = 2000;</div><div>     let dim = 100;</div><div class="diff-removed">-    let mut points = Vec::with_capacity(num_points);</div><div class="diff-added">+    let mut points = Vec::new();</div><div>     for i in 0..num_points {</div><div>         let mut payload_map = Map::new();</div><div>         payload_map.insert("a".to_string(), (i % 5).into());</div><div>         let vector = random_vector(&mut rng, dim);</div><div class="diff-removed">-        let vectors = only_default_vector(&vector);</div><div class="diff-removed">-        let point = PointStructPersisted {</div><div class="diff-removed">-            id: (i as u64).into(),</div><div class="diff-removed">-            vector: VectorStructInternal::from(vectors).into(),</div><div class="diff-added">+        let point = PointStruct {</div><div class="diff-added">+            id: i.into(),</div><div class="diff-added">+            vector,</div><div>             payload: Some(Payload(payload_map)),</div><div>         };</div><div>         points.push(point);</div><div>     }</div><div>     CollectionUpdateOperations::PointOperation(PointOperations::UpsertPoints(</div><div class="diff-removed">-        PointInsertOperationsInternal::PointsList(points),</div><div class="diff-added">+        PointInsertOperations::PointsList(points),</div><div>     ))</div><div> }</div><div> </div><div class="diff-info">@@ -63,11 +54,14 @@ fn batch_search_bench(c: &mut Criterion) {</div><div>     };</div><div> </div><div>     let collection_params = CollectionParams {</div><div class="diff-removed">-        vectors: VectorParamsBuilder::new(100, Distance::Dot).build().into(),</div><div class="diff-removed">-        ..CollectionParams::empty()</div><div class="diff-added">+        vector_size: NonZeroU32::new(100).unwrap(),</div><div class="diff-added">+        distance: Distance::Dot,</div><div class="diff-added">+        shard_number: NonZeroU32::new(1).expect("Shard number can not be zero"),</div><div class="diff-added">+        replication_factor: NonZeroU32::new(1).unwrap(),</div><div class="diff-added">+        on_disk_payload: false,</div><div>     };</div><div> </div><div class="diff-removed">-    let collection_config = CollectionConfigInternal {</div><div class="diff-added">+    let collection_config = CollectionConfig {</div><div>         params: collection_params,</div><div>         optimizer_config: OptimizersConfig {</div><div>             deleted_threshold: 0.9,</div><div class="diff-info">@@ -75,57 +69,39 @@ fn batch_search_bench(c: &mut Criterion) {</div><div>             default_segment_number: 2,</div><div>             max_segment_size: Some(100_000),</div><div>             memmap_threshold: Some(100_000),</div><div class="diff-removed">-            indexing_threshold: Some(50_000),</div><div class="diff-added">+            indexing_threshold: 50_000,</div><div>             flush_interval_sec: 30,</div><div class="diff-removed">-            max_optimization_threads: Some(2),</div><div class="diff-added">+            max_optimization_threads: 2,</div><div>         },</div><div>         wal_config,</div><div>         hnsw_config: Default::default(),</div><div class="diff-removed">-        quantization_config: Default::default(),</div><div class="diff-removed">-        strict_mode_config: Default::default(),</div><div class="diff-removed">-        uuid: None,</div><div>     };</div><div> </div><div class="diff-removed">-    let optimizers_config = collection_config.optimizer_config.clone();</div><div class="diff-removed">-</div><div>     let shared_config = Arc::new(RwLock::new(collection_config));</div><div> </div><div class="diff-removed">-    let payload_index_schema_dir = Builder::new().prefix("qdrant-test").tempdir().unwrap();</div><div class="diff-removed">-    let payload_index_schema_file = payload_index_schema_dir.path().join("payload-schema.json");</div><div class="diff-removed">-    let payload_index_schema =</div><div class="diff-removed">-        Arc::new(SaveOnDisk::load_or_init_default(payload_index_schema_file).unwrap());</div><div class="diff-removed">-</div><div>     let shard = handle</div><div class="diff-removed">-        .block_on(LocalShard::build_local(</div><div class="diff-added">+        .block_on(LocalShard::build(</div><div>             0,</div><div>             "test_collection".to_string(),</div><div>             storage_dir.path(),</div><div>             shared_config,</div><div class="diff-removed">-            Default::default(),</div><div class="diff-removed">-            payload_index_schema,</div><div class="diff-removed">-            handle.clone(),</div><div class="diff-removed">-            handle.clone(),</div><div class="diff-removed">-            ResourceBudget::default(),</div><div class="diff-removed">-            optimizers_config,</div><div>         ))</div><div>         .unwrap();</div><div> </div><div>     let rnd_batch = create_rnd_batch();</div><div> </div><div class="diff-removed">-    handle</div><div class="diff-removed">-        .block_on(shard.update(rnd_batch.into(), true, HwMeasurementAcc::new()))</div><div class="diff-removed">-        .unwrap();</div><div class="diff-added">+    handle.block_on((&shard).update(rnd_batch, true)).unwrap();</div><div> </div><div>     let mut group = c.benchmark_group("batch-search-bench");</div><div> </div><div>     let filters = vec![</div><div>         None,</div><div>         Some(Filter::new_must(Condition::Field(</div><div class="diff-removed">-            FieldCondition::new_match("a".parse().unwrap(), 3.into()),</div><div class="diff-added">+            FieldCondition::new_match("a".to_string(), 3.into()),</div><div>         ))),</div><div>         Some(Filter::new_must(Condition::Field(</div><div>             FieldCondition::new_range(</div><div class="diff-removed">-                "a".parse().unwrap(),</div><div class="diff-added">+                "a".to_string(),</div><div>                 Range {</div><div>                     lt: None,</div><div>                     gt: Some(-1.),</div><div class="diff-info">@@ -142,28 +118,25 @@ fn batch_search_bench(c: &mut Criterion) {</div><div>         group.bench_function(format!("search-{fid}"), |b| {</div><div>             b.iter(|| {</div><div>                 runtime.block_on(async {</div><div class="diff-removed">-                    let mut rng = rng();</div><div class="diff-added">+                    let mut rng = thread_rng();</div><div>                     for _i in 0..batch_size {</div><div>                         let query = random_vector(&mut rng, 100);</div><div class="diff-removed">-                        let search_query = SearchRequestInternal {</div><div class="diff-removed">-                            vector: query.into(),</div><div class="diff-added">+                        let search_query = SearchRequest {</div><div class="diff-added">+                            vector: query,</div><div>                             filter: filter.clone(),</div><div>                             params: None,</div><div>                             limit: 10,</div><div class="diff-removed">-                            offset: None,</div><div class="diff-added">+                            offset: 0,</div><div>                             with_payload: None,</div><div class="diff-removed">-                            with_vector: None,</div><div class="diff-added">+                            with_vector: false,</div><div>                             score_threshold: None,</div><div>                         };</div><div class="diff-removed">-                        let hw_acc = HwMeasurementAcc::new();</div><div class="diff-removed">-                        let result = shard</div><div class="diff-removed">-                            .core_search(</div><div class="diff-removed">-                                Arc::new(CoreSearchRequestBatch {</div><div class="diff-removed">-                                    searches: vec![search_query.into()],</div><div class="diff-added">+                        let result = (&shard)</div><div class="diff-added">+                            .search(</div><div class="diff-added">+                                Arc::new(SearchRequestBatch {</div><div class="diff-added">+                                    searches: vec![search_query],</div><div>                                 }),</div><div>                                 search_runtime_handle,</div><div class="diff-removed">-                                None,</div><div class="diff-removed">-                                hw_acc,</div><div>                             )</div><div>                             .await</div><div>                             .unwrap();</div><div class="diff-info">@@ -176,27 +149,26 @@ fn batch_search_bench(c: &mut Criterion) {</div><div>         group.bench_function(format!("search-batch-{fid}"), |b| {</div><div>             b.iter(|| {</div><div>                 runtime.block_on(async {</div><div class="diff-removed">-                    let mut rng = rng();</div><div class="diff-removed">-                    let mut searches = Vec::with_capacity(batch_size);</div><div class="diff-added">+                    let mut rng = thread_rng();</div><div class="diff-added">+                    let mut searches = Vec::new();</div><div>                     for _i in 0..batch_size {</div><div>                         let query = random_vector(&mut rng, 100);</div><div class="diff-removed">-                        let search_query = SearchRequestInternal {</div><div class="diff-removed">-                            vector: query.into(),</div><div class="diff-added">+                        let search_query = SearchRequest {</div><div class="diff-added">+                            vector: query,</div><div>                             filter: filter.clone(),</div><div>                             params: None,</div><div>                             limit: 10,</div><div class="diff-removed">-                            offset: None,</div><div class="diff-added">+                            offset: 0,</div><div>                             with_payload: None,</div><div class="diff-removed">-                            with_vector: None,</div><div class="diff-added">+                            with_vector: false,</div><div>                             score_threshold: None,</div><div>                         };</div><div class="diff-removed">-                        searches.push(search_query.into());</div><div class="diff-added">+                        searches.push(search_query);</div><div>                     }</div><div> </div><div class="diff-removed">-                    let hw_acc = HwMeasurementAcc::new();</div><div class="diff-removed">-                    let search_query = CoreSearchRequestBatch { searches };</div><div class="diff-removed">-                    let result = shard</div><div class="diff-removed">-                        .core_search(Arc::new(search_query), search_runtime_handle, None, hw_acc)</div><div class="diff-added">+                    let search_query = SearchRequestBatch { searches };</div><div class="diff-added">+                    let result = (&shard)</div><div class="diff-added">+                        .search(Arc::new(search_query), search_runtime_handle)</div><div>                         .await</div><div>                         .unwrap();</div><div>                     assert!(!result.is_empty());</div><div></div></pre>
                </div>
            </div>
        </section>
    </main>
    <footer>
        <p>LoCoDiff-bench - <a href="https://github.com/AbanteAI/LoCoDiff-bench">GitHub Repository</a></p>
    </footer>
</body>
</html>
    