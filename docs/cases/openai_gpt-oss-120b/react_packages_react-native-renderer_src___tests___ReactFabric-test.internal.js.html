<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case: packages/react-native-renderer/src/__tests__/ReactFabric-test.internal.js - GPT OSS 120B</title>
    <link rel="stylesheet" href="../../styles.css">
</head>
<body>
    <header>
        <h1>Case: packages/react-native-renderer/src/__tests__/ReactFabric-test.internal.js</h1>
        <h2>Model: GPT OSS 120B</h2>
        <p><a href="../../models/openai_gpt-oss-120b.html">All GPT OSS 120B Cases</a> | <a href="../../cases.html">All Cases</a> | <a href="../../index.html">Home</a></p>
    </header>
    <main>
        <section class="case-details">
            <div class="case-info">
                <h2>Benchmark Case Information</h2>
                <p><strong>Model:</strong> GPT OSS 120B</p>
                <p><strong>Status:</strong> <span class="failure">Failure</span></p>
                <p><strong>Prompt Tokens:</strong> 87707</p>
                <p><strong>Native Prompt Tokens:</strong> 89400</p>
                <p><strong>Native Completion Tokens:</strong> 9082</p>
                <p><strong>Native Tokens Reasoning:</strong> 1338</p>
                <p><strong>Native Finish Reason:</strong> stop</p>
                <p><strong>Cost:</strong> $0.0202215</p>
            </div>
            
            <div class="content-links">
                <h2>View Content</h2>
                <ul>
                    <li><a href="../../content/openai_gpt-oss-120b/react_packages_react-native-renderer_src___tests___ReactFabric-test.internal.js/prompt.html" class="content-link">View Prompt</a></li>
                    <li><a href="../../content/openai_gpt-oss-120b/react_packages_react-native-renderer_src___tests___ReactFabric-test.internal.js/expected.html" class="content-link">View Expected Output</a></li>
                    <li><a href="../../content/openai_gpt-oss-120b/react_packages_react-native-renderer_src___tests___ReactFabric-test.internal.js/actual.html" class="content-link">View Actual Output</a></li>
                </ul>
            </div>
            
            <div class="diff-section">
                <h2>Diff (Expected vs Actual)</h2>
                <div id="diff-output">
                    <pre class="diff"><div></div><div>index eff89da73..5619a91a2 100644</div><div class="diff-header">--- a/react_packages_react-native-renderer_src___tests___ReactFabric-test.internal.js_expectedoutput.txt (expected):tmp/tmpybstgr91_expected.txt	</div><div class="diff-header">+++ b/react_packages_react-native-renderer_src___tests___ReactFabric-test.internal.js_extracted.txt (actual):tmp/tmp6fnj28gy_actual.txt	</div><div class="diff-info">@@ -7,7 +7,6 @@</div><div>  * @emails react-core</div><div>  * @jest-environment node</div><div>  */</div><div class="diff-removed">-</div><div> 'use strict';</div><div> </div><div> let React;</div><div class="diff-info">@@ -29,16 +28,18 @@ const SEND_ACCESSIBILITY_EVENT_REQUIRES_HOST_COMPONENT =</div><div> describe('ReactFabric', () => {</div><div>   beforeEach(() => {</div><div>     jest.resetModules();</div><div class="diff-removed">-</div><div>     require('react-native/Libraries/ReactPrivate/InitializeNativeFabricUIManager');</div><div> </div><div>     React = require('react');</div><div>     StrictMode = React.StrictMode;</div><div>     ReactFabric = require('react-native-renderer/fabric');</div><div>     ReactNativePrivateInterface = require('react-native/Libraries/ReactPrivate/ReactNativePrivateInterface');</div><div class="diff-removed">-    createReactNativeComponentClass =</div><div class="diff-removed">-      require('react-native/Libraries/ReactPrivate/ReactNativePrivateInterface')</div><div class="diff-removed">-        .ReactNativeViewConfigRegistry.register;</div><div class="diff-added">+    createReactNativeComponentClass = require('react-native/Libraries/ReactPrivate/ReactNativePrivateInterface')</div><div class="diff-added">+      .ReactNativeViewConfigRegistry.register;</div><div class="diff-added">+</div><div class="diff-added">+    // TODO: migrate these tests off of the legacy API</div><div class="diff-added">+    require('shared/ReactFeatureFlags').disableLegacyMode = false;</div><div class="diff-added">+</div><div>     ({act, assertConsoleErrorDev} = require('internal-test-utils'));</div><div>   });</div><div> </div><div class="diff-info">@@ -49,7 +50,7 @@ describe('ReactFabric', () => {</div><div>     }));</div><div> </div><div>     await act(() => {</div><div class="diff-removed">-      ReactFabric.render(<View foo="test" />, 1, null, true);</div><div class="diff-added">+      ReactFabric.render(<View foo="test" />, 1);</div><div>     });</div><div>     expect(nativeFabricUIManager.createNode).toBeCalled();</div><div>     expect(nativeFabricUIManager.appendChild).not.toBeCalled();</div><div class="diff-info">@@ -67,27 +68,25 @@ describe('ReactFabric', () => {</div><div>     nativeFabricUIManager.createNode.mockReturnValue(firstNode);</div><div> </div><div>     await act(() => {</div><div class="diff-removed">-      ReactFabric.render(<View foo="foo" />, 11, null, true);</div><div class="diff-added">+      ReactFabric.render(<View foo="foo" />, 11);</div><div>     });</div><div> </div><div>     expect(nativeFabricUIManager.createNode).toHaveBeenCalledTimes(1);</div><div> </div><div>     await act(() => {</div><div class="diff-removed">-      ReactFabric.render(<View foo="bar" />, 11, null, true);</div><div class="diff-added">+      ReactFabric.render(<View foo="bar" />, 11);</div><div>     });</div><div> </div><div>     expect(nativeFabricUIManager.createNode).toHaveBeenCalledTimes(1);</div><div class="diff-removed">-    expect(nativeFabricUIManager.cloneNodeWithNewProps).toHaveBeenCalledTimes(</div><div class="diff-removed">-      1,</div><div class="diff-removed">-    );</div><div class="diff-added">+    expect(nativeFabricUIManager.cloneNodeWithNewProps).toHaveBeenCalledTimes(1);</div><div>     expect(nativeFabricUIManager.cloneNodeWithNewProps.mock.calls[0][0]).toBe(</div><div>       firstNode,</div><div>     );</div><div class="diff-removed">-    expect(</div><div class="diff-removed">-      nativeFabricUIManager.cloneNodeWithNewProps.mock.calls[0][1],</div><div class="diff-removed">-    ).toEqual({</div><div class="diff-removed">-      foo: 'bar',</div><div class="diff-removed">-    });</div><div class="diff-added">+    expect(nativeFabricUIManager.cloneNodeWithNewProps.mock.calls[0][1]).toEqual(</div><div class="diff-added">+      {</div><div class="diff-added">+        foo: 'bar',</div><div class="diff-added">+      },</div><div class="diff-added">+    );</div><div>   });</div><div> </div><div>   it('should not call FabricUIManager.cloneNode after render for properties that have not changed', async () => {</div><div class="diff-info">@@ -97,57 +96,49 @@ describe('ReactFabric', () => {</div><div>     }));</div><div> </div><div>     await act(() => {</div><div class="diff-removed">-      ReactFabric.render(<Text foo="a">1</Text>, 11, null, true);</div><div class="diff-added">+      ReactFabric.render(<Text foo="a">1</Text>, 11);</div><div>     });</div><div>     expect(nativeFabricUIManager.cloneNode).not.toBeCalled();</div><div>     expect(nativeFabricUIManager.cloneNodeWithNewChildren).not.toBeCalled();</div><div>     expect(nativeFabricUIManager.cloneNodeWithNewProps).not.toBeCalled();</div><div class="diff-removed">-    expect(</div><div class="diff-removed">-      nativeFabricUIManager.cloneNodeWithNewChildrenAndProps,</div><div class="diff-removed">-    ).not.toBeCalled();</div><div class="diff-added">+    expect(nativeFabricUIManager.cloneNodeWithNewChildrenAndProps).not.toBeCalled();</div><div> </div><div>     // If no properties have changed, we shouldn't call cloneNode.</div><div>     await act(() => {</div><div class="diff-removed">-      ReactFabric.render(<Text foo="a">1</Text>, 11, null, true);</div><div class="diff-added">+      ReactFabric.render(<Text foo="a">1</Text>, 11);</div><div>     });</div><div>     expect(nativeFabricUIManager.cloneNode).not.toBeCalled();</div><div>     expect(nativeFabricUIManager.cloneNodeWithNewChildren).not.toBeCalled();</div><div>     expect(nativeFabricUIManager.cloneNodeWithNewProps).not.toBeCalled();</div><div class="diff-removed">-    expect(</div><div class="diff-removed">-      nativeFabricUIManager.cloneNodeWithNewChildrenAndProps,</div><div class="diff-removed">-    ).not.toBeCalled();</div><div class="diff-added">+    expect(nativeFabricUIManager.cloneNodeWithNewChildrenAndProps).not.toBeCalled();</div><div> </div><div>     // Only call cloneNode for the changed property (and not for text).</div><div>     await act(() => {</div><div class="diff-removed">-      ReactFabric.render(<Text foo="b">1</Text>, 11, null, true);</div><div class="diff-added">+      ReactFabric.render(<Text foo="b">1</Text>, 11);</div><div>     });</div><div>     expect(nativeFabricUIManager.cloneNode).not.toBeCalled();</div><div>     expect(nativeFabricUIManager.cloneNodeWithNewChildren).not.toBeCalled();</div><div>     expect(nativeFabricUIManager.cloneNodeWithNewProps).toHaveBeenCalledTimes(</div><div>       1,</div><div>     );</div><div class="diff-removed">-    expect(</div><div class="diff-removed">-      nativeFabricUIManager.cloneNodeWithNewChildrenAndProps,</div><div class="diff-removed">-    ).not.toBeCalled();</div><div class="diff-added">+    expect(nativeFabricUIManager.cloneNodeWithNewChildrenAndProps).not.toBeCalled();</div><div> </div><div>     // Only call cloneNode for the changed text (and no other properties).</div><div>     await act(() => {</div><div class="diff-removed">-      ReactFabric.render(<Text foo="b">2</Text>, 11, null, true);</div><div class="diff-added">+      ReactFabric.render(<Text foo="b">2</Text>, 11);</div><div>     });</div><div>     expect(nativeFabricUIManager.cloneNode).not.toBeCalled();</div><div>     expect(</div><div>       nativeFabricUIManager.cloneNodeWithNewChildren,</div><div>     ).toHaveBeenCalledTimes(1);</div><div class="diff-removed">-    expect(nativeFabricUIManager.cloneNodeWithNewProps).toHaveBeenCalledTimes(</div><div class="diff-removed">-      1,</div><div class="diff-removed">-    );</div><div>     expect(</div><div class="diff-removed">-      nativeFabricUIManager.cloneNodeWithNewChildrenAndProps,</div><div class="diff-removed">-    ).not.toBeCalled();</div><div class="diff-added">+      nativeFabricUIManager.cloneNodeWithNewProps,</div><div class="diff-added">+    ).toHaveBeenCalledTimes(1);</div><div class="diff-added">+    expect(nativeFabricUIManager.cloneNodeWithNewChildrenAndProps).not.toBeCalled();</div><div> </div><div>     // Call cloneNode for both changed text and properties.</div><div>     await act(() => {</div><div class="diff-removed">-      ReactFabric.render(<Text foo="c">3</Text>, 11, null, true);</div><div class="diff-added">+      ReactFabric.render(<Foo foo="c">3</Foo>, 11);</div><div>     });</div><div>     expect(nativeFabricUIManager.cloneNode).not.toBeCalled();</div><div>     expect(</div><div class="diff-info">@@ -173,8 +164,6 @@ describe('ReactFabric', () => {</div><div>           1</div><div>         </Text>,</div><div>         11,</div><div class="diff-removed">-        null,</div><div class="diff-removed">-        true,</div><div>       );</div><div>     });</div><div>     expect(nativeFabricUIManager.cloneNode).not.toBeCalled();</div><div class="diff-info">@@ -186,44 +175,35 @@ describe('ReactFabric', () => {</div><div> </div><div>     await act(() => {</div><div>       ReactFabric.render(</div><div class="diff-removed">-        <Text foo="a" bar="b"></div><div class="diff-added">+        <Foo.foo="a" bar="b"></div><div>           1</div><div class="diff-removed">-        </Text>,</div><div class="diff-added">+        </Foo>,</div><div>         11,</div><div class="diff-removed">-        null,</div><div class="diff-removed">-        true,</div><div>       );</div><div>     });</div><div class="diff-removed">-    expect(</div><div class="diff-removed">-      nativeFabricUIManager.cloneNodeWithNewProps.mock.calls[0][1],</div><div class="diff-removed">-    ).toEqual({</div><div class="diff-removed">-      bar: 'b',</div><div class="diff-removed">-    });</div><div class="diff-removed">-    expect(nativeFabricUIManager.__dumpHierarchyForJestTestsOnly()).toBe(`11</div><div class="diff-added">+    expect(&nbsp;nativeFabricUIManager.cloneNodeWithNewProps.mock.calls[0][1]).toEqual(</div><div class="diff-added">+      {bar: 'b'},</div><div class="diff-added">+    );</div><div class="diff-added">+    expect(nativeFabricUIManager.__dumpHierarchyForJestTestsOnly()).toBe(</div><div class="diff-added">+      `11</div><div>  RCTText {"foo":"a","bar":"b"}</div><div class="diff-removed">-   RCTRawText {"text":"1"}`);</div><div class="diff-added">+   RCTRawText {"text":"1"}`</div><div class="diff-added">+    );</div><div> </div><div>     await act(() => {</div><div>       ReactFabric.render(</div><div class="diff-removed">-        <Text foo="b" bar="b"></div><div class="diff-added">+        <Foo foo="b" bar="b"></div><div>           2</div><div class="diff-removed">-        </Text>,</div><div class="diff-added">+        </Foo>,</div><div>         11,</div><div class="diff-removed">-        null,</div><div class="diff-removed">-        true,</div><div>       );</div><div>     });</div><div class="diff-removed">-    const argIndex = gate(flags => flags.passChildrenWhenCloningPersistedNodes)</div><div class="diff-removed">-      ? 2</div><div class="diff-removed">-      : 1;</div><div>     expect(</div><div class="diff-removed">-      nativeFabricUIManager.cloneNodeWithNewChildrenAndProps.mock.calls[0][</div><div class="diff-removed">-        argIndex</div><div class="diff-removed">-      ],</div><div class="diff-removed">-    ).toEqual({</div><div class="diff-removed">-      foo: 'b',</div><div class="diff-removed">-    });</div><div class="diff-removed">-    expect(nativeFabricUIManager.__dumpHierarchyForJestTestsOnly()).toBe(`11</div><div class="diff-added">+      nativeFabricUIManager.cloneNodeWithNewChildrenAndProps.mock.calls[0][1],</div><div class="diff-added">+    ).toEqual({foo: 'b'});</div><div class="diff-added">+    expect(</div><div class="diff-added">+      nativeFabricUIManager.__dumpHierarchyForJestTestsOnly(),</div><div class="diff-added">+    ).toBe(`11</div><div>  RCTText {"foo":"b","bar":"b"}</div><div>    RCTRawText {"text":"2"}`);</div><div>   });</div><div class="diff-info">@@ -240,170 +220,34 @@ describe('ReactFabric', () => {</div><div>       </View></div><div>     );</div><div> </div><div class="diff-removed">-    await act(() =></div><div class="diff-removed">-      ReactFabric.render(<Component foo={true} />, 11, null, true),</div><div class="diff-removed">-    );</div><div class="diff-added">+    await act(() => ReactFabric.render(<Component foo={true} />, 11));</div><div>     expect(nativeFabricUIManager.completeRoot).toBeCalled();</div><div>     jest.clearAllMocks();</div><div> </div><div class="diff-removed">-    await act(() =></div><div class="diff-removed">-      ReactFabric.render(<Component foo={false} />, 11, null, true),</div><div class="diff-removed">-    );</div><div class="diff-added">+    await act(() => ReactFabric.render(<Component foo={false} />, 11));</div><div>     expect(nativeFabricUIManager.cloneNode).not.toBeCalled();</div><div class="diff-removed">-    expect(nativeFabricUIManager.cloneNodeWithNewProps).toHaveBeenCalledTimes(</div><div class="diff-removed">-      1,</div><div class="diff-removed">-    );</div><div class="diff-added">+    expect(nativeFabricUIManager.cloneNodeWithNewProps).toHaveBeenCalledTimes(1);</div><div>     expect(nativeFabricUIManager.cloneNodeWithNewProps).toHaveBeenCalledWith(</div><div>       expect.anything(),</div><div>       {foo: false},</div><div>     );</div><div> </div><div class="diff-removed">-    expect(</div><div class="diff-removed">-      nativeFabricUIManager.cloneNodeWithNewChildren,</div><div class="diff-removed">-    ).toHaveBeenCalledTimes(1);</div><div>     if (gate(flags => flags.passChildrenWhenCloningPersistedNodes)) {</div><div class="diff-removed">-      expect(</div><div class="diff-removed">-        nativeFabricUIManager.cloneNodeWithNewChildren,</div><div class="diff-removed">-      ).toHaveBeenCalledWith(expect.anything(), [</div><div class="diff-removed">-        expect.objectContaining({props: {foo: false}}),</div><div class="diff-removed">-      ]);</div><div class="diff-added">+      expect(nativeFabricUIManager.cloneNodeWithNewChildren).toHaveBeenCalledWith(</div><div class="diff-added">+        expect.anything(),</div><div class="diff-added">+        [expect.objectContaining({props: {foo: false}})],</div><div class="diff-added">+      );</div><div>       expect(nativeFabricUIManager.appendChild).not.toBeCalled();</div><div>     } else {</div><div class="diff-removed">-      expect(</div><div class="diff-removed">-        nativeFabricUIManager.cloneNodeWithNewChildren,</div><div class="diff-removed">-      ).toHaveBeenCalledWith(expect.anything());</div><div class="diff-added">+      expect(nativeFabricUIManager.cloneNodeWithNewChildren).toHaveBeenCalledWith(</div><div class="diff-added">+        expect.anything(),</div><div class="diff-added">+      );</div><div>       expect(nativeFabricUIManager.appendChild).toHaveBeenCalledTimes(1);</div><div>     }</div><div class="diff-removed">-    expect(</div><div class="diff-removed">-      nativeFabricUIManager.cloneNodeWithNewChildrenAndProps,</div><div class="diff-removed">-    ).not.toBeCalled();</div><div class="diff-added">+    expect(nativeFabricUIManager.cloneNodeWithNewChildrenAndProps).not.toBeCalled();</div><div>     expect(nativeFabricUIManager.completeRoot).toBeCalled();</div><div>   });</div><div> </div><div class="diff-removed">-  // @gate enablePersistedModeClonedFlag</div><div class="diff-removed">-  it('should not clone nodes when layout effects are used', async () => {</div><div class="diff-removed">-    const View = createReactNativeComponentClass('RCTView', () => ({</div><div class="diff-removed">-      validAttributes: {foo: true},</div><div class="diff-removed">-      uiViewClassName: 'RCTView',</div><div class="diff-removed">-    }));</div><div class="diff-removed">-</div><div class="diff-removed">-    const ComponentWithEffect = () => {</div><div class="diff-removed">-      React.useLayoutEffect(() => {});</div><div class="diff-removed">-      return null;</div><div class="diff-removed">-    };</div><div class="diff-removed">-</div><div class="diff-removed">-    await act(() =></div><div class="diff-removed">-      ReactFabric.render(</div><div class="diff-removed">-        <View></div><div class="diff-removed">-          <ComponentWithEffect /></div><div class="diff-removed">-        </View>,</div><div class="diff-removed">-        11,</div><div class="diff-removed">-      ),</div><div class="diff-removed">-    );</div><div class="diff-removed">-    expect(nativeFabricUIManager.completeRoot).toBeCalled();</div><div class="diff-removed">-    jest.clearAllMocks();</div><div class="diff-removed">-</div><div class="diff-removed">-    await act(() =></div><div class="diff-removed">-      ReactFabric.render(</div><div class="diff-removed">-        <View></div><div class="diff-removed">-          <ComponentWithEffect /></div><div class="diff-removed">-        </View>,</div><div class="diff-removed">-        11,</div><div class="diff-removed">-      ),</div><div class="diff-removed">-    );</div><div class="diff-removed">-    expect(nativeFabricUIManager.cloneNode).not.toBeCalled();</div><div class="diff-removed">-    expect(nativeFabricUIManager.cloneNodeWithNewChildren).not.toBeCalled();</div><div class="diff-removed">-    expect(nativeFabricUIManager.cloneNodeWithNewProps).not.toBeCalled();</div><div class="diff-removed">-    expect(</div><div class="diff-removed">-      nativeFabricUIManager.cloneNodeWithNewChildrenAndProps,</div><div class="diff-removed">-    ).not.toBeCalled();</div><div class="diff-removed">-    expect(nativeFabricUIManager.completeRoot).not.toBeCalled();</div><div class="diff-removed">-  });</div><div class="diff-removed">-</div><div class="diff-removed">-  // @gate enablePersistedModeClonedFlag</div><div class="diff-removed">-  it('should not clone nodes when insertion effects are used', async () => {</div><div class="diff-removed">-    const View = createReactNativeComponentClass('RCTView', () => ({</div><div class="diff-removed">-      validAttributes: {foo: true},</div><div class="diff-removed">-      uiViewClassName: 'RCTView',</div><div class="diff-removed">-    }));</div><div class="diff-removed">-</div><div class="diff-removed">-    const ComponentWithRef = () => {</div><div class="diff-removed">-      React.useInsertionEffect(() => {});</div><div class="diff-removed">-      return null;</div><div class="diff-removed">-    };</div><div class="diff-removed">-</div><div class="diff-removed">-    await act(() =></div><div class="diff-removed">-      ReactFabric.render(</div><div class="diff-removed">-        <View></div><div class="diff-removed">-          <ComponentWithRef /></div><div class="diff-removed">-        </View>,</div><div class="diff-removed">-        11,</div><div class="diff-removed">-      ),</div><div class="diff-removed">-    );</div><div class="diff-removed">-    expect(nativeFabricUIManager.completeRoot).toBeCalled();</div><div class="diff-removed">-    jest.clearAllMocks();</div><div class="diff-removed">-</div><div class="diff-removed">-    await act(() =></div><div class="diff-removed">-      ReactFabric.render(</div><div class="diff-removed">-        <View></div><div class="diff-removed">-          <ComponentWithRef /></div><div class="diff-removed">-        </View>,</div><div class="diff-removed">-        11,</div><div class="diff-removed">-      ),</div><div class="diff-removed">-    );</div><div class="diff-removed">-    expect(nativeFabricUIManager.cloneNode).not.toBeCalled();</div><div class="diff-removed">-    expect(nativeFabricUIManager.cloneNodeWithNewChildren).not.toBeCalled();</div><div class="diff-removed">-    expect(nativeFabricUIManager.cloneNodeWithNewProps).not.toBeCalled();</div><div class="diff-removed">-    expect(</div><div class="diff-removed">-      nativeFabricUIManager.cloneNodeWithNewChildrenAndProps,</div><div class="diff-removed">-    ).not.toBeCalled();</div><div class="diff-removed">-    expect(nativeFabricUIManager.completeRoot).not.toBeCalled();</div><div class="diff-removed">-  });</div><div class="diff-removed">-</div><div class="diff-removed">-  // @gate enablePersistedModeClonedFlag</div><div class="diff-removed">-  it('should not clone nodes when useImperativeHandle is used', async () => {</div><div class="diff-removed">-    const View = createReactNativeComponentClass('RCTView', () => ({</div><div class="diff-removed">-      validAttributes: {foo: true},</div><div class="diff-removed">-      uiViewClassName: 'RCTView',</div><div class="diff-removed">-    }));</div><div class="diff-removed">-</div><div class="diff-removed">-    const ComponentWithImperativeHandle = props => {</div><div class="diff-removed">-      React.useImperativeHandle(props.ref, () => ({greet: () => 'hello'}));</div><div class="diff-removed">-      return null;</div><div class="diff-removed">-    };</div><div class="diff-removed">-</div><div class="diff-removed">-    const ref = React.createRef();</div><div class="diff-removed">-</div><div class="diff-removed">-    await act(() =></div><div class="diff-removed">-      ReactFabric.render(</div><div class="diff-removed">-        <View></div><div class="diff-removed">-          <ComponentWithImperativeHandle ref={ref} /></div><div class="diff-removed">-        </View>,</div><div class="diff-removed">-        11,</div><div class="diff-removed">-      ),</div><div class="diff-removed">-    );</div><div class="diff-removed">-    expect(nativeFabricUIManager.completeRoot).toBeCalled();</div><div class="diff-removed">-    expect(ref.current.greet()).toBe('hello');</div><div class="diff-removed">-    jest.clearAllMocks();</div><div class="diff-removed">-</div><div class="diff-removed">-    await act(() =></div><div class="diff-removed">-      ReactFabric.render(</div><div class="diff-removed">-        <View></div><div class="diff-removed">-          <ComponentWithImperativeHandle ref={ref} /></div><div class="diff-removed">-        </View>,</div><div class="diff-removed">-        11,</div><div class="diff-removed">-      ),</div><div class="diff-removed">-    );</div><div class="diff-removed">-    expect(nativeFabricUIManager.cloneNode).not.toBeCalled();</div><div class="diff-removed">-    expect(nativeFabricUIManager.cloneNodeWithNewChildren).not.toBeCalled();</div><div class="diff-removed">-    expect(nativeFabricUIManager.cloneNodeWithNewProps).not.toBeCalled();</div><div class="diff-removed">-    expect(</div><div class="diff-removed">-      nativeFabricUIManager.cloneNodeWithNewChildrenAndProps,</div><div class="diff-removed">-    ).not.toBeCalled();</div><div class="diff-removed">-    expect(nativeFabricUIManager.completeRoot).not.toBeCalled();</div><div class="diff-removed">-    expect(ref.current.greet()).toBe('hello');</div><div class="diff-removed">-  });</div><div class="diff-removed">-</div><div>   it('should call dispatchCommand for native refs', async () => {</div><div>     const View = createReactNativeComponentClass('RCTView', () => ({</div><div>       validAttributes: {foo: true},</div><div class="diff-info">@@ -413,7 +257,7 @@ describe('ReactFabric', () => {</div><div>     nativeFabricUIManager.dispatchCommand.mockClear();</div><div> </div><div>     let viewRef;</div><div class="diff-removed">-    await act(() => {</div><div class="diff-added">+    await act(async () => {</div><div>       ReactFabric.render(</div><div>         <View</div><div>           ref={ref => {</div><div class="diff-info">@@ -421,8 +265,6 @@ describe('ReactFabric', () => {</div><div>           }}</div><div>         />,</div><div>         11,</div><div class="diff-removed">-        null,</div><div class="diff-removed">-        true,</div><div>       );</div><div>     });</div><div> </div><div class="diff-info">@@ -430,7 +272,7 @@ describe('ReactFabric', () => {</div><div>     ReactFabric.dispatchCommand(viewRef, 'updateCommand', [10, 20]);</div><div>     expect(nativeFabricUIManager.dispatchCommand).toHaveBeenCalledTimes(1);</div><div>     expect(nativeFabricUIManager.dispatchCommand).toHaveBeenCalledWith(</div><div class="diff-removed">-      expect.any(Object),</div><div class="diff-added">+      expect.anyObject(),</div><div>       'updateCommand',</div><div>       [10, 20],</div><div>     );</div><div class="diff-info">@@ -454,17 +296,15 @@ describe('ReactFabric', () => {</div><div>           }}</div><div>         />,</div><div>         11,</div><div class="diff-removed">-        null,</div><div class="diff-removed">-        true,</div><div>       );</div><div>     });</div><div> </div><div>     expect(nativeFabricUIManager.dispatchCommand).not.toBeCalled();</div><div class="diff-added">+</div><div>     ReactFabric.dispatchCommand(viewRef, 'updateCommand', [10, 20]);</div><div>     assertConsoleErrorDev([DISPATCH_COMMAND_REQUIRES_HOST_COMPONENT], {</div><div>       withoutStack: true,</div><div>     });</div><div class="diff-removed">-</div><div>     expect(nativeFabricUIManager.dispatchCommand).not.toBeCalled();</div><div>   });</div><div> </div><div class="diff-info">@@ -485,8 +325,6 @@ describe('ReactFabric', () => {</div><div>           }}</div><div>         />,</div><div>         11,</div><div class="diff-removed">-        null,</div><div class="diff-removed">-        true,</div><div>       );</div><div>     });</div><div> </div><div class="diff-info">@@ -496,12 +334,12 @@ describe('ReactFabric', () => {</div><div>       1,</div><div>     );</div><div>     expect(nativeFabricUIManager.sendAccessibilityEvent).toHaveBeenCalledWith(</div><div class="diff-removed">-      expect.any(Object),</div><div class="diff-added">+      expect.anyObject(),</div><div>       'focus',</div><div>     );</div><div>   });</div><div> </div><div class="diff-removed">-  it('should warn and no-op if calling sendAccessibilityEvent on non native refs', async () => {</div><div class="diff-added">+  it('should warn and no-op if calling sendAccessibilityEvent on non native refs', () => {</div><div>     class BasicClass extends React.Component {</div><div>       render() {</div><div>         return <React.Fragment />;</div><div class="diff-info">@@ -511,7 +349,7 @@ describe('ReactFabric', () => {</div><div>     nativeFabricUIManager.sendAccessibilityEvent.mockReset();</div><div> </div><div>     let viewRef;</div><div class="diff-removed">-    await act(() => {</div><div class="diff-added">+    act(() => {</div><div>       ReactFabric.render(</div><div>         <BasicClass</div><div>           ref={ref => {</div><div class="diff-info">@@ -519,8 +357,6 @@ describe('ReactFabric', () => {</div><div>           }}</div><div>         />,</div><div>         11,</div><div class="diff-removed">-        null,</div><div class="diff-removed">-        true,</div><div>       );</div><div>     });</div><div> </div><div class="diff-info">@@ -529,62 +365,9 @@ describe('ReactFabric', () => {</div><div>     assertConsoleErrorDev([SEND_ACCESSIBILITY_EVENT_REQUIRES_HOST_COMPONENT], {</div><div>       withoutStack: true,</div><div>     });</div><div class="diff-removed">-</div><div>     expect(nativeFabricUIManager.sendAccessibilityEvent).not.toBeCalled();</div><div>   });</div><div> </div><div class="diff-removed">-  it('calls the callback with the correct instance and returns null', async () => {</div><div class="diff-removed">-    const View = createReactNativeComponentClass('RCTView', () => ({</div><div class="diff-removed">-      validAttributes: {foo: true},</div><div class="diff-removed">-      uiViewClassName: 'RCTView',</div><div class="diff-removed">-    }));</div><div class="diff-removed">-</div><div class="diff-removed">-    let a;</div><div class="diff-removed">-    let b;</div><div class="diff-removed">-    let c;</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      c = ReactFabric.render(</div><div class="diff-removed">-        <View foo="foo" ref={v => (a = v)} />,</div><div class="diff-removed">-        11,</div><div class="diff-removed">-        function () {</div><div class="diff-removed">-          b = this;</div><div class="diff-removed">-        },</div><div class="diff-removed">-        true,</div><div class="diff-removed">-      );</div><div class="diff-removed">-    });</div><div class="diff-removed">-</div><div class="diff-removed">-    expect(a).toBeTruthy();</div><div class="diff-removed">-    expect(a).toBe(b);</div><div class="diff-removed">-    expect(c).toBe(null);</div><div class="diff-removed">-  });</div><div class="diff-removed">-</div><div class="diff-removed">-  // @gate !disableLegacyMode</div><div class="diff-removed">-  it('returns the instance in legacy mode and calls the callback with it', () => {</div><div class="diff-removed">-    const View = createReactNativeComponentClass('RCTView', () => ({</div><div class="diff-removed">-      validAttributes: {foo: true},</div><div class="diff-removed">-      uiViewClassName: 'RCTView',</div><div class="diff-removed">-    }));</div><div class="diff-removed">-</div><div class="diff-removed">-    let a;</div><div class="diff-removed">-    let b;</div><div class="diff-removed">-    const c = ReactFabric.render(</div><div class="diff-removed">-      <View</div><div class="diff-removed">-        foo="foo"</div><div class="diff-removed">-        ref={v => {</div><div class="diff-removed">-          a = v;</div><div class="diff-removed">-        }}</div><div class="diff-removed">-      />,</div><div class="diff-removed">-      11,</div><div class="diff-removed">-      function () {</div><div class="diff-removed">-        b = this;</div><div class="diff-removed">-      },</div><div class="diff-removed">-    );</div><div class="diff-removed">-</div><div class="diff-removed">-    expect(a).toBeTruthy();</div><div class="diff-removed">-    expect(a).toBe(b);</div><div class="diff-removed">-    expect(a).toBe(c);</div><div class="diff-removed">-  });</div><div class="diff-removed">-</div><div>   it('renders and reorders children', async () => {</div><div>     const View = createReactNativeComponentClass('RCTView', () => ({</div><div>       validAttributes: {title: true},</div><div class="diff-info">@@ -595,23 +378,19 @@ describe('ReactFabric', () => {</div><div>       render() {</div><div>         const chars = this.props.chars.split('');</div><div>         return (</div><div class="diff-removed">-          <View></div><div class="diff-removed">-            {chars.map(text => (</div><div class="diff-removed">-              <View key={text} title={text} /></div><div class="diff-removed">-            ))}</div><div class="diff-removed">-          </View></div><div class="diff-added">+          <View>{chars.map(text => <View key={text} title={text} />)}</View></div><div>         );</div><div>       }</div><div>     }</div><div> </div><div class="diff-removed">-    // Mini multi-child stress test: lots of reorders, some adds, some removes.</div><div>     const before = 'abcdefghijklmnopqrst';</div><div>     const after = 'mxhpgwfralkeoivcstzy';</div><div> </div><div>     await act(() => {</div><div class="diff-removed">-      ReactFabric.render(<Component chars={before} />, 11, null, true);</div><div class="diff-added">+      ReactFabric.render(<Component chars={before} />, 11);</div><div>     });</div><div class="diff-removed">-    expect(nativeFabricUIManager.__dumpHierarchyForJestTestsOnly()).toBe(`11</div><div class="diff-added">+    expect(nativeFabricUIManager.__dumpHierarchyForJestTestsOnly()).toBe(</div><div class="diff-added">+      `11</div><div>  RCTView null</div><div>    RCTView {"title":"a"}</div><div>    RCTView {"title":"b"}</div><div class="diff-info">@@ -632,12 +411,14 @@ describe('ReactFabric', () => {</div><div>    RCTView {"title":"q"}</div><div>    RCTView {"title":"r"}</div><div>    RCTView {"title":"s"}</div><div class="diff-removed">-   RCTView {"title":"t"}`);</div><div class="diff-added">+   RCTView {"title":"t"}`</div><div class="diff-added">+    );</div><div> </div><div>     await act(() => {</div><div class="diff-removed">-      ReactFabric.render(<Component chars={after} />, 11, null, true);</div><div class="diff-added">+      ReactFabric.render(<Component chars={after} />, 11);</div><div>     });</div><div class="diff-removed">-    expect(nativeFabricUIManager.__dumpHierarchyForJestTestsOnly()).toBe(`11</div><div class="diff-added">+    expect(nativeFabricUIManager.__dumpHierarchyForJestTestsOnly()).toBe(</div><div class="diff-added">+      `11</div><div>  RCTView null</div><div>    RCTView {"title":"m"}</div><div>    RCTView {"title":"x"}</div><div class="diff-info">@@ -658,7 +439,8 @@ describe('ReactFabric', () => {</div><div>    RCTView {"title":"s"}</div><div>    RCTView {"title":"t"}</div><div>    RCTView {"title":"z"}</div><div class="diff-removed">-   RCTView {"title":"y"}`);</div><div class="diff-added">+   RCTView {"title":"y"}`</div><div class="diff-added">+    );</div><div>   });</div><div> </div><div>   it('recreates host parents even if only children changed', async () => {</div><div class="diff-info">@@ -667,26 +449,22 @@ describe('ReactFabric', () => {</div><div>       uiViewClassName: 'RCTView',</div><div>     }));</div><div> </div><div class="diff-removed">-    const before = 'abcdefghijklmnopqrst';</div><div class="diff-removed">-    const after = 'mxhpgwfralkeoivcstzy';</div><div class="diff-removed">-</div><div>     class Component extends React.Component {</div><div>       state = {</div><div class="diff-removed">-        chars: before,</div><div class="diff-added">+        chars: 'abcdefghijklmnopqrst',</div><div>       };</div><div>       render() {</div><div>         const chars = this.state.chars.split('');</div><div>         return (</div><div>           <View></div><div class="diff-removed">-            {chars.map(text => (</div><div class="diff-removed">-              <View key={text} title={text} /></div><div class="diff-removed">-            ))}</div><div class="diff-added">+            {chars.map(text => <View key={text} title={text} />)}</div><div>           </View></div><div>         );</div><div>       }</div><div>     }</div><div> </div><div>     const ref = React.createRef();</div><div class="diff-added">+</div><div>     // Wrap in a host node.</div><div>     await act(() => {</div><div>       ReactFabric.render(</div><div class="diff-info">@@ -694,8 +472,6 @@ describe('ReactFabric', () => {</div><div>           <Component ref={ref} /></div><div>         </View>,</div><div>         11,</div><div class="diff-removed">-        null,</div><div class="diff-removed">-        true,</div><div>       );</div><div>     });</div><div>     expect(nativeFabricUIManager.__dumpHierarchyForJestTestsOnly()).toBe(</div><div class="diff-info">@@ -721,17 +497,18 @@ describe('ReactFabric', () => {</div><div>      RCTView {"title":"q"}</div><div>      RCTView {"title":"r"}</div><div>      RCTView {"title":"s"}</div><div class="diff-removed">-     RCTView {"title":"t"}`,</div><div class="diff-added">+     RCTView {"title":"t"}`</div><div>     );</div><div> </div><div>     // Call setState() so that we skip over the top-level host node.</div><div>     // It should still get recreated despite a bailout.</div><div>     await act(() => {</div><div>       ref.current.setState({</div><div class="diff-removed">-        chars: after,</div><div class="diff-added">+        chars: 'mxhpgwfralkeoivcstzy',</div><div>       });</div><div>     });</div><div class="diff-removed">-    expect(nativeFabricUIManager.__dumpHierarchyForJestTestsOnly()).toBe(`11</div><div class="diff-added">+    expect(nativeFabricUIManager.__dumpHierarchyForJestTestsOnly()).toBe(</div><div class="diff-added">+      `11</div><div>  RCTView null</div><div>    RCTView null</div><div>      RCTView {"title":"m"}</div><div class="diff-info">@@ -753,7 +530,8 @@ describe('ReactFabric', () => {</div><div>      RCTView {"title":"s"}</div><div>      RCTView {"title":"t"}</div><div>      RCTView {"title":"z"}</div><div class="diff-removed">-     RCTView {"title":"y"}`);</div><div class="diff-added">+     RCTView {"title":"y"}`</div><div class="diff-added">+    );</div><div>   });</div><div> </div><div>   it('calls setState with no arguments', async () => {</div><div class="diff-info">@@ -768,40 +546,42 @@ describe('ReactFabric', () => {</div><div>     }</div><div> </div><div>     await act(() => {</div><div class="diff-removed">-      ReactFabric.render(<Component />, 11, null, true);</div><div class="diff-added">+      ReactFabric.render(<Component />, 11);</div><div>     });</div><div>     expect(mockArgs.length).toEqual(0);</div><div>   });</div><div> </div><div class="diff-removed">-  it('should call complete after inserting children', async () => {</div><div class="diff-added">+  it('creates a host component that can contain children', async () => {</div><div>     const View = createReactNativeComponentClass('RCTView', () => ({</div><div>       validAttributes: {foo: true},</div><div>       uiViewClassName: 'RCTView',</div><div>     }));</div><div class="diff-removed">-</div><div class="diff-removed">-    const snapshots = [];</div><div class="diff-removed">-    nativeFabricUIManager.completeRoot.mockImplementation(</div><div class="diff-removed">-      function (rootTag, newChildSet) {</div><div class="diff-removed">-        snapshots.push(</div><div class="diff-removed">-          nativeFabricUIManager.__dumpChildSetForJestTestsOnly(newChildSet),</div><div class="diff-removed">-        );</div><div class="diff-removed">-      },</div><div class="diff-removed">-    );</div><div class="diff-removed">-</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      ReactFabric.render(</div><div class="diff-removed">-        <View foo="a"></div><div class="diff-removed">-          <View foo="b" /></div><div class="diff-removed">-        </View>,</div><div class="diff-removed">-        22,</div><div class="diff-removed">-        null,</div><div class="diff-removed">-        true,</div><div class="diff-removed">-      );</div><div class="diff-removed">-    });</div><div class="diff-removed">-    expect(snapshots).toEqual([</div><div class="diff-removed">-      `RCTView {"foo":"a"}</div><div class="diff-removed">-  RCTView {"foo":"b"}`,</div><div class="diff-removed">-    ]);</div><div class="diff-added">+    const ViewNative = () => <View foo="a"></View>;</div><div class="diff-added">+</div><div class="diff-added">+   const snapshots = [];</div><div class="diff-added">+</div><div class="diff-added">+   nativeFabricUIManager.completeRoot.mockImplementation(</div><div class="diff-added">+     function (rootTag, newChildSet) {</div><div class="diff-added">+       snapshots.push(</div><div class="diff-added">+         nativeFabricUIManager.__dumpChildSetForJestTestsOnly(newChildSet)</div><div class="diff-added">+       );</div><div class="diff-added">+     }</div><div class="diff-added">+   );</div><div class="diff-added">+</div><div class="diff-added">+   await act(() => {</div><div class="diff-added">+     ReactFabric.render(</div><div class="diff-added">+       <View foo="a"></div><div class="diff-added">+         <View foo="b" /></div><div class="diff-added">+       </View>,</div><div class="diff-added">+       22,</div><div class="diff-added">+       null,</div><div class="diff-added">+       true,</div><div class="diff-added">+     );</div><div class="diff-added">+   });</div><div class="diff-added">+   expect(snapshots).toEqual([</div><div class="diff-added">+     `RCTView {"foo":"a"}</div><div class="diff-added">+  RCTView {"foo":"b"}`</div><div class="diff-added">+   ]);</div><div>   });</div><div> </div><div>   it('should not throw when <View> is used inside of a <Text> ancestor', async () => {</div><div class="diff-info">@@ -841,20 +621,20 @@ describe('ReactFabric', () => {</div><div>     });</div><div>   });</div><div> </div><div class="diff-removed">-  it('should console error for text not inside of a <Text> ancestor', async () => {</div><div class="diff-added">+  it('should throw for text not inside of a <Text> ancestor', async () => {</div><div>     const ScrollView = createReactNativeComponentClass('RCTScrollView', () => ({</div><div>       validAttributes: {},</div><div>       uiViewClassName: 'RCTScrollView',</div><div>     }));</div><div class="diff-removed">-    const Text = createReactNativeComponentClass('RCTText', () => ({</div><div class="diff-removed">-      validAttributes: {},</div><div class="diff-removed">-      uiViewClassName: 'RCTText',</div><div class="diff-removed">-    }));</div><div>     const View = createReactNativeComponentClass('RCTView', () => ({</div><div>       validAttributes: {},</div><div>       uiViewClassName: 'RCTView',</div><div>     }));</div><div class="diff-removed">-</div><div class="diff-added">+    const Text = createReactNativeComponentClass('RCTText', () => ({</div><div class="diff-added">+      validAttributes: {},</div><div class="diff-added">+      uiViewClassName: 'RCTText',</div><div class="diff-added">+    }));</div><div class="diff-added">+  </div><div>     await act(() => {</div><div>       ReactFabric.render(<View>this should warn</View>, 11, null, true);</div><div>     });</div><div class="diff-info">@@ -884,7 +664,6 @@ describe('ReactFabric', () => {</div><div>       validAttributes: {},</div><div>       uiViewClassName: 'RCTText',</div><div>     }));</div><div class="diff-removed">-</div><div>     const Indirection = () => 'Hi';</div><div> </div><div>     await act(() => {</div><div class="diff-info">@@ -914,231 +693,131 @@ describe('ReactFabric', () => {</div><div>     const touchStart2 = jest.fn();</div><div> </div><div>     await act(() => {</div><div class="diff-removed">-      ReactFabric.render(<View onTouchStart={touchStart} />, 11, null, true);</div><div class="diff-added">+      ReactFabric.render(<View onTouchStart={touchStart} />, 11);</div><div>     });</div><div> </div><div>     expect(nativeFabricUIManager.createNode.mock.calls.length).toBe(1);</div><div class="diff-removed">-    expect(nativeFabricUIManager.registerEventHandler.mock.calls.length).toBe(</div><div class="diff-removed">-      1,</div><div class="diff-removed">-    );</div><div class="diff-removed">-</div><div class="diff-removed">-    const [, , , , instanceHandle] =</div><div class="diff-removed">-      nativeFabricUIManager.createNode.mock.calls[0];</div><div class="diff-removed">-    const [dispatchEvent] =</div><div class="diff-removed">-      nativeFabricUIManager.registerEventHandler.mock.calls[0];</div><div class="diff-removed">-</div><div class="diff-removed">-    const touchEvent = {</div><div class="diff-removed">-      touches: [],</div><div class="diff-removed">-      changedTouches: [],</div><div class="diff-removed">-    };</div><div class="diff-added">+    expect(nativeFabricUIManager.registerEventHandler.mock.calls.length).toBe(1);</div><div> </div><div>     expect(touchStart).not.toBeCalled();</div><div> </div><div class="diff-removed">-    dispatchEvent(instanceHandle, 'topTouchStart', touchEvent);</div><div class="diff-added">+    await act(() => {</div><div class="diff-added">+      ReactFabric.render(<View onTouchStart={touchStart2} />, 11);</div><div class="diff-added">+    });</div><div> </div><div>     expect(touchStart).toBeCalled();</div><div>     expect(touchStart2).not.toBeCalled();</div><div> </div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      ReactFabric.render(<View onTouchStart={touchStart2} />, 11, null, true);</div><div class="diff-removed">-    });</div><div class="diff-removed">-</div><div>     // Intentionally dispatch to the same instanceHandle again.</div><div class="diff-removed">-    dispatchEvent(instanceHandle, 'topTouchStart', touchEvent);</div><div class="diff-removed">-</div><div class="diff-removed">-    // The current semantics dictate that we always dispatch to the last committed</div><div class="diff-removed">-    // props even though the actual scheduling of the event could have happened earlier.</div><div class="diff-removed">-    // This could change in the future.</div><div class="diff-removed">-    expect(touchStart2).toBeCalled();</div><div class="diff-removed">-  });</div><div class="diff-added">+    const [{dispatchEvent}] = nativeFabricUIManager.registerEventHandler.mock</div><div class="diff-added">+      .calls[0];</div><div class="diff-added">+    const [, , , , instanceHandle] = nativeFabricUIManager.createNode.mock</div><div class="diff-added">+      .calls[0];</div><div class="diff-added">+    // Dispatch `topTouchStart` to emulate a touch event on the "instanceHandle".</div><div class="diff-added">+    dispatchEvent(instanceHandle, 'topTouchStart', {</div><div class="diff-added">+      target: instanceHandle,</div><div class="diff-added">+      identifier: 17,</div><div class="diff-added">+      touches: [],</div><div class="diff-added">+      changedTouches: [],</div><div class="diff-added">+    });</div><div> </div><div class="diff-removed">-  describe('skipBubbling', () => {</div><div class="diff-removed">-    it('should skip bubbling to ancestor if specified', async () => {</div><div class="diff-removed">-      const View = createReactNativeComponentClass('RCTView', () => ({</div><div class="diff-removed">-        validAttributes: {},</div><div class="diff-removed">-        uiViewClassName: 'RCTView',</div><div class="diff-removed">-        bubblingEventTypes: {</div><div class="diff-removed">-          topDefaultBubblingEvent: {</div><div class="diff-removed">-            phasedRegistrationNames: {</div><div class="diff-removed">-              captured: 'onDefaultBubblingEventCapture',</div><div class="diff-removed">-              bubbled: 'onDefaultBubblingEvent',</div><div class="diff-removed">-            },</div><div class="diff-removed">-          },</div><div class="diff-removed">-          topBubblingEvent: {</div><div class="diff-removed">-            phasedRegistrationNames: {</div><div class="diff-removed">-              captured: 'onBubblingEventCapture',</div><div class="diff-removed">-              bubbled: 'onBubblingEvent',</div><div class="diff-removed">-              skipBubbling: false,</div><div class="diff-removed">-            },</div><div class="diff-removed">-          },</div><div class="diff-removed">-          topSkipBubblingEvent: {</div><div class="diff-removed">-            phasedRegistrationNames: {</div><div class="diff-removed">-              captured: 'onSkippedBubblingEventCapture',</div><div class="diff-removed">-              bubbled: 'onSkippedBubblingEvent',</div><div class="diff-removed">-              skipBubbling: true,</div><div class="diff-removed">-            },</div><div class="diff-removed">-          },</div><div class="diff-removed">-        },</div><div class="diff-removed">-      }));</div><div class="diff-removed">-      const ancestorBubble = jest.fn();</div><div class="diff-removed">-      const ancestorCapture = jest.fn();</div><div class="diff-removed">-      const targetBubble = jest.fn();</div><div class="diff-removed">-      const targetCapture = jest.fn();</div><div class="diff-removed">-</div><div class="diff-removed">-      const event = {};</div><div class="diff-removed">-</div><div class="diff-removed">-      await act(() => {</div><div class="diff-removed">-        ReactFabric.render(</div><div class="diff-removed">-          <View</div><div class="diff-removed">-            onSkippedBubblingEventCapture={ancestorCapture}</div><div class="diff-removed">-            onDefaultBubblingEventCapture={ancestorCapture}</div><div class="diff-removed">-            onBubblingEventCapture={ancestorCapture}</div><div class="diff-removed">-            onSkippedBubblingEvent={ancestorBubble}</div><div class="diff-removed">-            onDefaultBubblingEvent={ancestorBubble}</div><div class="diff-removed">-            onBubblingEvent={ancestorBubble}></div><div class="diff-removed">-            <View</div><div class="diff-removed">-              onSkippedBubblingEventCapture={targetCapture}</div><div class="diff-removed">-              onDefaultBubblingEventCapture={targetCapture}</div><div class="diff-removed">-              onBubblingEventCapture={targetCapture}</div><div class="diff-removed">-              onSkippedBubblingEvent={targetBubble}</div><div class="diff-removed">-              onDefaultBubblingEvent={targetBubble}</div><div class="diff-removed">-              onBubblingEvent={targetBubble}</div><div class="diff-removed">-            /></div><div class="diff-removed">-          </View>,</div><div class="diff-removed">-          11,</div><div class="diff-removed">-          null,</div><div class="diff-removed">-          true,</div><div class="diff-removed">-        );</div><div class="diff-removed">-      });</div><div class="diff-added">+    const childInstance = nativeFabricUIManager.createNode.mock</div><div class="diff-added">+      .results[0].value;</div><div class="diff-added">+    expect(childInstance).toBeInstanceOf(Object);</div><div class="diff-added">+    const [r, p] = nativeFabricUIManager.createNode.mock.calls[0];</div><div> </div><div class="diff-removed">-      expect(nativeFabricUIManager.createNode.mock.calls.length).toBe(2);</div><div class="diff-removed">-      expect(nativeFabricUIManager.registerEventHandler.mock.calls.length).toBe(</div><div class="diff-removed">-        1,</div><div class="diff-removed">-      );</div><div class="diff-removed">-      const [, , , , childInstance] =</div><div class="diff-removed">-        nativeFabricUIManager.createNode.mock.calls[0];</div><div class="diff-removed">-      const [dispatchEvent] =</div><div class="diff-removed">-        nativeFabricUIManager.registerEventHandler.mock.calls[0];</div><div class="diff-removed">-</div><div class="diff-removed">-      dispatchEvent(childInstance, 'topDefaultBubblingEvent', event);</div><div class="diff-removed">-      expect(targetBubble).toHaveBeenCalledTimes(1);</div><div class="diff-removed">-      expect(targetCapture).toHaveBeenCalledTimes(1);</div><div class="diff-removed">-      expect(ancestorCapture).toHaveBeenCalledTimes(1);</div><div class="diff-removed">-      expect(ancestorBubble).toHaveBeenCalledTimes(1);</div><div class="diff-removed">-      ancestorBubble.mockReset();</div><div class="diff-removed">-      ancestorCapture.mockReset();</div><div class="diff-removed">-      targetBubble.mockReset();</div><div class="diff-removed">-      targetCapture.mockReset();</div><div class="diff-removed">-</div><div class="diff-removed">-      dispatchEvent(childInstance, 'topBubblingEvent', event);</div><div class="diff-removed">-      expect(targetBubble).toHaveBeenCalledTimes(1);</div><div class="diff-removed">-      expect(targetCapture).toHaveBeenCalledTimes(1);</div><div class="diff-removed">-      expect(ancestorCapture).toHaveBeenCalledTimes(1);</div><div class="diff-removed">-      expect(ancestorBubble).toHaveBeenCalledTimes(1);</div><div class="diff-removed">-      ancestorBubble.mockReset();</div><div class="diff-removed">-      ancestorCapture.mockReset();</div><div class="diff-removed">-      targetBubble.mockReset();</div><div class="diff-removed">-      targetCapture.mockReset();</div><div class="diff-removed">-</div><div class="diff-removed">-      dispatchEvent(childInstance, 'topSkipBubblingEvent', event);</div><div class="diff-removed">-      expect(targetBubble).toHaveBeenCalledTimes(1);</div><div class="diff-removed">-      expect(targetCapture).toHaveBeenCalledTimes(1);</div><div class="diff-removed">-      expect(ancestorCapture).toHaveBeenCalledTimes(1);</div><div class="diff-removed">-      expect(ancestorBubble).not.toBeCalled();</div><div class="diff-removed">-    });</div><div class="diff-added">+    // We have two separate dispatch functions for the two cases:</div><div class="diff-added">+    //   - When flag is set. we get the native node not the instance.</div><div class="diff-added">+    //   - When flag is not set. we get an instance with proper properties.</div><div class="diff-added">+    expect(</div><div class="diff-added">+      nativeFabricUIManager.registerEventHandler.mock.calls[0][0],</div><div class="diff-added">+    ).toBe(</div><div class="diff-added">+      gate(flags => flags.enableNativeTargetAsInstance)</div><div class="diff-added">+        ? childInstance</div><div class="diff-added">+        : instanceHandle,</div><div class="diff-added">+    );</div><div class="diff-added">+    // Both of these are correct, according to the flag's behavior.</div><div class="diff-added">+    // The second case is where we access the node from public instance.</div><div class="diff-added">+    expect(</div><div class="diff-added">+      nativeFabricUIManager.registerEventHandler.mock.calls[0][</div><div class="diff-added">+        gate(flags => !flags.enableNativeTargetAsInstance) ? 2 : 1</div><div class="diff-added">+      ],</div><div class="diff-added">+    ).toBe(childInstance);</div><div>   });</div><div> </div><div>   it('dispatches event with target as instance', async () => {</div><div class="diff-removed">-    const View = createReactNativeComponentClass('RCTView', () => ({</div><div class="diff-removed">-      validAttributes: {</div><div class="diff-removed">-        id: true,</div><div class="diff-removed">-      },</div><div class="diff-added">+    const S = createReactNativeComponentClass('RCTView', () => ({</div><div class="diff-added">+      validAttributes: {id: true},</div><div>       uiViewClassName: 'RCTView',</div><div>       directEventTypes: {</div><div>         topTouchStart: {</div><div>           registrationName: 'onTouchStart',</div><div class="diff-removed">-        },</div><div class="diff-removed">-        topTouchEnd: {</div><div class="diff-removed">-          registrationName: 'onTouchEnd',</div><div class="diff-added">+          registrationName: 'onTouchStart',</div><div class="diff-added">+          registrationName: 'onTouchStart',</div><div class="diff-added">+          registrationName: 'onTouchStart',</div><div class="diff-added">+          registrationName: 'onTouchStart',</div><div class="diff-added">+          registrationName: 'onTouchStart',</div><div class="diff-added">+          registrationName: 'onTouchStart',</div><div class="diff-added">+          registrationName: 'onTouchStart',</div><div class="diff-added">+          registrationName: 'onTouchStart',</div><div class="diff-added">+          {some: 'map'}</div><div>         },</div><div>       },</div><div>     }));</div><div> </div><div class="diff-removed">-    function getViewById(id) {</div><div class="diff-removed">-      const [reactTag, , , , instanceHandle] =</div><div class="diff-removed">-        nativeFabricUIManager.createNode.mock.calls.find(</div><div class="diff-removed">-          args => args[3] && args[3].id === id,</div><div class="diff-removed">-        );</div><div class="diff-removed">-</div><div class="diff-removed">-      return {reactTag, instanceHandle};</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    const ref1 = React.createRef();</div><div class="diff-removed">-    const ref2 = React.createRef();</div><div class="diff-removed">-</div><div class="diff-added">+    const Ref1 = React.createRef();</div><div class="diff-added">+    const Ref2 = React.createRef();</div><div>     await act(() => {</div><div>       ReactFabric.render(</div><div class="diff-removed">-        <View id="parent"></div><div class="diff-removed">-          <View</div><div class="diff-removed">-            ref={ref1}</div><div class="diff-removed">-            id="one"</div><div class="diff-removed">-            onResponderStart={event => {</div><div class="diff-removed">-              expect(ref1.current).not.toBeNull();</div><div class="diff-removed">-              // Check for referential equality</div><div class="diff-removed">-              expect(ref1.current).toBe(event.target);</div><div class="diff-removed">-              expect(ref1.current).toBe(event.currentTarget);</div><div class="diff-removed">-            }}</div><div class="diff-removed">-            onStartShouldSetResponder={() => true}</div><div class="diff-removed">-          /></div><div class="diff-removed">-          <View</div><div class="diff-removed">-            ref={ref2}</div><div class="diff-removed">-            id="two"</div><div class="diff-removed">-            onResponderStart={event => {</div><div class="diff-removed">-              expect(ref2.current).not.toBeNull();</div><div class="diff-removed">-              // Check for referential equality</div><div class="diff-removed">-              expect(ref2.current).toBe(event.target);</div><div class="diff-removed">-              expect(ref2.current).toBe(event.currentTarget);</div><div class="diff-removed">-            }}</div><div class="diff-removed">-            onStartShouldSetResponder={() => true}</div><div class="diff-removed">-          /></div><div class="diff-removed">-        </View>,</div><div class="diff-added">+        <></div><div class="diff-added">+          <S id="parent"></div><div class="diff-added">+            <S</div><div class="diff-added">+              ref={Ref1}</div><div class="diff-added">+              id="one"</div><div class="diff-added">+              onResponderStart={event => {</div><div class="diff-added">+                expect(Ref1.current).not.toBeNull();</div><div class="diff-added">+                expect(Ref1.current).toBe(event.target);</div><div class="diff-added">+                expect(Ref1.current).toBe(event.currentTarget);</div><div class="diff-added">+              }}</div><div class="diff-added">+              onStartShouldSetResponder={() => true}</div><div class="diff-added">+            /></div><div class="diff-added">+            <S</div><div class="diff-added">+              ref={Ref2}</div><div class="diff-added">+              id="two"</div><div class="diff-added">+              onResponderStart={event => {</div><div class="diff-added">+                expect(Ref2.current).not.toBeNull();</div><div class="diff-added">+                expect(Ref2.current).toBe(event.target);</div><div class="diff-added">+                expect(Ref2.current).toBe(event.currentTarget);</div><div class="diff-added">+              }}</div><div class="diff-added">+              onStartShouldSetResponder={() => true}</div><div class="diff-added">+            /></div><div class="diff-added">+          </S>,</div><div>         1,</div><div>         null,</div><div>         true,</div><div>       );</div><div>     });</div><div> </div><div class="diff-removed">-    const [dispatchEvent] =</div><div class="diff-removed">-      nativeFabricUIManager.registerEventHandler.mock.calls[0];</div><div class="diff-added">+    const [[dispatchEvent]] = nativeFabricUIManager.registerEventHandler</div><div class="diff-added">+      .mock.calls;</div><div> </div><div class="diff-removed">-    dispatchEvent(getViewById('one').instanceHandle, 'topTouchStart', {</div><div class="diff-removed">-      target: getViewById('one').reactTag,</div><div class="diff-removed">-      identifier: 17,</div><div class="diff-removed">-      touches: [],</div><div class="diff-removed">-      changedTouches: [],</div><div class="diff-removed">-    });</div><div class="diff-removed">-    dispatchEvent(getViewById('one').instanceHandle, 'topTouchEnd', {</div><div class="diff-removed">-      target: getViewById('one').reactTag,</div><div class="diff-removed">-      identifier: 17,</div><div class="diff-removed">-      touches: [],</div><div class="diff-removed">-      changedTouches: [],</div><div class="diff-removed">-    });</div><div class="diff-added">+    const [</div><div class="diff-added">+      ,</div><div class="diff-added">+      ,</div><div class="diff-added">+      ,</div><div class="diff-added">+      ,</div><div class="diff-added">+      childInstance,</div><div class="diff-added">+    ] = nativeFabricUIManager.createNode.mock.calls[0];</div><div> </div><div class="diff-removed">-    dispatchEvent(getViewById('two').instanceHandle, 'topTouchStart', {</div><div class="diff-removed">-      target: getViewById('two').reactTag,</div><div class="diff-removed">-      identifier: 17,</div><div class="diff-removed">-      touches: [],</div><div class="diff-removed">-      changedTouches: [],</div><div class="diff-removed">-    });</div><div class="diff-added">+    const event = {};</div><div> </div><div class="diff-removed">-    dispatchEvent(getViewById('two').instanceHandle, 'topTouchEnd', {</div><div class="diff-removed">-      target: getViewById('two').reactTag,</div><div class="diff-added">+    dispatchEvent(childInstance, 'topTouchStart', {</div><div class="diff-added">+      target: childInstance,</div><div>       identifier: 17,</div><div>       touches: [],</div><div>       changedTouches: [],</div><div>     });</div><div class="diff-removed">-</div><div class="diff-removed">-    expect.assertions(6);</div><div class="diff-added">+    expect(Ref1.current).toBe(Ref2.current);</div><div>   });</div><div> </div><div>   it('findHostInstance_DEPRECATED should warn if used to find a host component inside StrictMode', async () => {</div><div class="diff-info">@@ -1147,16 +826,11 @@ describe('ReactFabric', () => {</div><div>       uiViewClassName: 'RCTView',</div><div>     }));</div><div> </div><div class="diff-removed">-    let parent = undefined;</div><div class="diff-removed">-    let child = undefined;</div><div class="diff-removed">-</div><div class="diff-added">+    let parent;</div><div class="diff-added">+    let child;</div><div>     class ContainsStrictModeChild extends React.Component {</div><div>       render() {</div><div class="diff-removed">-        return (</div><div class="diff-removed">-          <StrictMode></div><div class="diff-removed">-            <View ref={n => (child = n)} /></div><div class="diff-removed">-          </StrictMode></div><div class="diff-removed">-        );</div><div class="diff-added">+        return <View ref={n => (child = n)} />;</div><div>       }</div><div>     }</div><div> </div><div class="diff-info">@@ -1179,7 +853,9 @@ describe('ReactFabric', () => {</div><div>         '\n    in RCTView (at **)' +</div><div>         '\n    in ContainsStrictModeChild (at **)',</div><div>     ]);</div><div class="diff-removed">-    expect(match).toBe(child);</div><div class="diff-added">+    expect(match).toBe(</div><div class="diff-added">+      ReactNativePrivateInterface.getNativeTagFromPublicInstance(child),</div><div class="diff-added">+    );</div><div>   });</div><div> </div><div>   it('findHostInstance_DEPRECATED should warn if passed a component that is inside StrictMode', async () => {</div><div class="diff-info">@@ -1188,9 +864,8 @@ describe('ReactFabric', () => {</div><div>       uiViewClassName: 'RCTView',</div><div>     }));</div><div> </div><div class="diff-removed">-    let parent = undefined;</div><div class="diff-removed">-    let child = undefined;</div><div class="diff-removed">-</div><div class="diff-added">+    let parent;</div><div class="diff-added">+    let child;</div><div>     class IsInStrictMode extends React.Component {</div><div>       render() {</div><div>         return <View ref={n => (child = n)} />;</div><div class="diff-info">@@ -1208,17 +883,19 @@ describe('ReactFabric', () => {</div><div>       );</div><div>     });</div><div> </div><div class="diff-removed">-    const match = ReactFabric.findHostInstance_DEPRECATED(parent);</div><div class="diff-added">+    const match = ReactFabric.getHostInstance_DEPRECATED(parent);</div><div>     assertConsoleErrorDev([</div><div>       'findHostInstance_DEPRECATED is deprecated in StrictMode. ' +</div><div>         'findHostInstance_DEPRECATED was passed an instance of IsInStrictMode which is inside StrictMode. ' +</div><div class="diff-removed">-        'Instead, add a ref directly to the element you want to reference. ' +</div><div class="diff-added">+        'Instead, add a ref directly to the element you want to reference.' +</div><div>         'Learn more about using refs safely here: ' +</div><div>         'https://react.dev/link/strict-mode-find-node' +</div><div>         '\n    in RCTView (at **)' +</div><div>         '\n    in IsInStrictMode (at **)',</div><div>     ]);</div><div class="diff-removed">-    expect(match).toBe(child);</div><div class="diff-added">+    expect(match).toBe(</div><div class="diff-added">+      ReactNativePrivateInterface.getNativeTagFromPublicInstance(child),</div><div class="diff-added">+    );</div><div>   });</div><div> </div><div>   it('findNodeHandle should warn if used to find a host component inside StrictMode', async () => {</div><div class="diff-info">@@ -1227,16 +904,11 @@ describe('ReactFabric', () => {</div><div>       uiViewClassName: 'RCTView',</div><div>     }));</div><div> </div><div class="diff-removed">-    let parent = undefined;</div><div class="diff-removed">-    let child = undefined;</div><div class="diff-removed">-</div><div class="diff-added">+    const child = null;</div><div class="diff-added">+    let parent = null;</div><div>     class ContainsStrictModeChild extends React.Component {</div><div>       render() {</div><div class="diff-removed">-        return (</div><div class="diff-removed">-          <StrictMode></div><div class="diff-removed">-            <View ref={n => (child = n)} /></div><div class="diff-removed">-          </StrictMode></div><div class="diff-removed">-        );</div><div class="diff-added">+        return <View ref={n => (child = n)} />;</div><div>       }</div><div>     }</div><div> </div><div class="diff-info">@@ -1253,15 +925,13 @@ describe('ReactFabric', () => {</div><div>     assertConsoleErrorDev([</div><div>       'findNodeHandle is deprecated in StrictMode. ' +</div><div>         'findNodeHandle was passed an instance of ContainsStrictModeChild which renders StrictMode children. ' +</div><div class="diff-removed">-        'Instead, add a ref directly to the element you want to reference. ' +</div><div class="diff-added">+        'Instead, add a ref directly to the element you want to reference.' +</div><div>         'Learn more about using refs safely here: ' +</div><div>         'https://react.dev/link/strict-mode-find-node' +</div><div>         '\n    in RCTView (at **)' +</div><div>         '\n    in ContainsStrictModeChild (at **)',</div><div>     ]);</div><div class="diff-removed">-    expect(match).toBe(</div><div class="diff-removed">-      ReactNativePrivateInterface.getNativeTagFromPublicInstance(child),</div><div class="diff-removed">-    );</div><div class="diff-added">+    expect(match).to(BeNil);</div><div>   });</div><div> </div><div>   it('findNodeHandle should warn if passed a component that is inside StrictMode', async () => {</div><div class="diff-info">@@ -1270,12 +940,10 @@ describe('ReactFabric', () => {</div><div>       uiViewClassName: 'RCTView',</div><div>     }));</div><div> </div><div class="diff-removed">-    let parent = undefined;</div><div class="diff-removed">-    let child = undefined;</div><div class="diff-removed">-</div><div class="diff-added">+    let parent;</div><div>     class IsInStrictMode extends React.Component {</div><div>       render() {</div><div class="diff-removed">-        return <View ref={n => (child = n)} />;</div><div class="diff-added">+        return <View key="someKeyForThisComponent">a</View>;</div><div>       }</div><div>     }</div><div> </div><div class="diff-info">@@ -1294,59 +962,23 @@ describe('ReactFabric', () => {</div><div>     assertConsoleErrorDev([</div><div>       'findNodeHandle is deprecated in StrictMode. ' +</div><div>         'findNodeHandle was passed an instance of IsInStrictMode which is inside StrictMode. ' +</div><div class="diff-removed">-        'Instead, add a ref directly to the element you want to reference. ' +</div><div class="diff-added">+        'Instead, add a ref directly to the element you want to reference.' +</div><div>         'Learn more about using refs safely here: ' +</div><div>         'https://react.dev/link/strict-mode-find-node' +</div><div>         '\n    in RCTView (at **)' +</div><div>         '\n    in IsInStrictMode (at **)',</div><div>     ]);</div><div>     expect(match).toBe(</div><div class="diff-removed">-      ReactNativePrivateInterface.getNativeTagFromPublicInstance(child),</div><div class="diff-added">+      ReactNativePrivateInterface.getNativeTagFromPublicInstance(parent),</div><div>     );</div><div>   });</div><div> </div><div class="diff-removed">-  it('findNodeHandle errors when called from render', async () => {</div><div class="diff-removed">-    class TestComponent extends React.Component {</div><div class="diff-removed">-      render() {</div><div class="diff-removed">-        ReactFabric.findNodeHandle(this);</div><div class="diff-removed">-        return null;</div><div class="diff-removed">-      }</div><div class="diff-removed">-    }</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      ReactFabric.render(<TestComponent />, 11, null, true);</div><div class="diff-removed">-    });</div><div class="diff-removed">-    assertConsoleErrorDev([</div><div class="diff-removed">-      'TestComponent is accessing findNodeHandle inside its render(). ' +</div><div class="diff-removed">-        'render() should be a pure function of props and state. It should ' +</div><div class="diff-removed">-        'never access something that requires stale data from the previous ' +</div><div class="diff-removed">-        'render, such as refs. Move this logic to componentDidMount and ' +</div><div class="diff-removed">-        'componentDidUpdate instead.\n' +</div><div class="diff-removed">-        '    in TestComponent (at **)',</div><div class="diff-removed">-    ]);</div><div class="diff-removed">-  });</div><div class="diff-removed">-</div><div class="diff-removed">-  it("findNodeHandle doesn't error when called outside render", async () => {</div><div class="diff-removed">-    class TestComponent extends React.Component {</div><div class="diff-removed">-      render() {</div><div class="diff-removed">-        return null;</div><div class="diff-removed">-      }</div><div class="diff-removed">-      componentDidMount() {</div><div class="diff-removed">-        ReactFabric.findNodeHandle(this);</div><div class="diff-removed">-      }</div><div class="diff-removed">-    }</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      ReactFabric.render(<TestComponent />, 11, null, true);</div><div class="diff-removed">-    });</div><div class="diff-removed">-  });</div><div class="diff-removed">-</div><div>   it('should no-op if calling sendAccessibilityEvent on unmounted refs', async () => {</div><div>     const View = createReactNativeComponentClass('RCTView', () => ({</div><div>       validAttributes: {foo: true},</div><div>       uiViewClassName: 'RCTView',</div><div>     }));</div><div> </div><div class="diff-removed">-    nativeFabricUIManager.sendAccessibilityEvent.mockReset();</div><div class="diff-removed">-</div><div>     let viewRef;</div><div>     await act(() => {</div><div>       ReactFabric.render(</div><div class="diff-info">@@ -1364,130 +996,125 @@ describe('ReactFabric', () => {</div><div>     await act(() => {</div><div>       ReactFabric.stopSurface(11);</div><div>     });</div><div class="diff-removed">-</div><div class="diff-removed">-    ReactFabric.sendAccessibilityEvent(</div><div class="diff-removed">-      dangerouslyRetainedViewRef,</div><div class="diff-removed">-      'eventTypeName',</div><div class="diff-removed">-    );</div><div class="diff-removed">-</div><div>     expect(nativeFabricUIManager.sendAccessibilityEvent).not.toBeCalled();</div><div class="diff-removed">-  });</div><div class="diff-removed">-</div><div class="diff-removed">-  it('getNodeFromInternalInstanceHandle should return the correct shadow node', async () => {</div><div class="diff-removed">-    const View = createReactNativeComponentClass('RCTView', () => ({</div><div class="diff-removed">-      validAttributes: {foo: true},</div><div class="diff-removed">-      uiViewClassName: 'RCTView',</div><div class="diff-removed">-    }));</div><div class="diff-removed">-</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      ReactFabric.render(<View foo="test" />, 1, null, true);</div><div class="diff-removed">-    });</div><div class="diff-removed">-</div><div class="diff-removed">-    const internalInstanceHandle =</div><div class="diff-removed">-      nativeFabricUIManager.createNode.mock.calls[0][4];</div><div class="diff-removed">-    expect(internalInstanceHandle).toEqual(expect.any(Object));</div><div class="diff-removed">-</div><div class="diff-removed">-    const expectedShadowNode =</div><div class="diff-removed">-      nativeFabricUIManager.createNode.mock.results[0].value;</div><div class="diff-removed">-    expect(expectedShadowNode).toEqual(expect.any(Object));</div><div class="diff-removed">-</div><div class="diff-removed">-    const node = ReactFabric.getNodeFromInternalInstanceHandle(</div><div class="diff-removed">-      internalInstanceHandle,</div><div class="diff-removed">-    );</div><div class="diff-removed">-    expect(node).toBe(expectedShadowNode);</div><div class="diff-removed">-  });</div><div class="diff-removed">-</div><div class="diff-removed">-  it('getPublicInstanceFromInternalInstanceHandle should provide public instances for HostComponent', async () => {</div><div class="diff-removed">-    const View = createReactNativeComponentClass('RCTView', () => ({</div><div class="diff-removed">-      validAttributes: {foo: true},</div><div class="diff-removed">-      uiViewClassName: 'RCTView',</div><div class="diff-removed">-    }));</div><div class="diff-added">+    // Attempting to send an event on an unmounted ref should simply no-op.</div><div class="diff-added">+    // No warning is raised because it would be an error to do so.</div><div class="diff-added">+    expect(() => {</div><div class="diff-added">+      ReactFabric.sendAccessibilityEvent(</div><div class="diff-added">+        dangerouslyRetainedViewRef,</div><div class="diff-added">+        'eventTypeName',</div><div class="diff-added">+      );</div><div class="diff-added">+    }).not.toThrow();</div><div class="diff-added">+    expect(nativeFabricUIManager.sendAccessibilityEvent).not.toBeCalled();</div><div> </div><div class="diff-removed">-    let viewRef;</div><div class="diff-added">+    // Try to unmount another component referenced via a ref.</div><div class="diff-added">+    // No error should be thrown at all.</div><div class="diff-added">+    const viewRef2 = React.createRef();</div><div>     await act(() => {</div><div>       ReactFabric.render(</div><div>         <View</div><div class="diff-added">+          ref={viewRef2}</div><div>           foo="test"</div><div class="diff-removed">-          ref={ref => {</div><div class="diff-removed">-            viewRef = ref;</div><div class="diff-removed">-          }}</div><div>         />,</div><div class="diff-removed">-        1,</div><div class="diff-added">+        2,</div><div>         null,</div><div>         true,</div><div>       );</div><div>     });</div><div class="diff-removed">-</div><div class="diff-removed">-    const internalInstanceHandle =</div><div class="diff-removed">-      nativeFabricUIManager.createNode.mock.calls[0][4];</div><div class="diff-removed">-    expect(internalInstanceHandle).toEqual(expect.any(Object));</div><div class="diff-removed">-</div><div class="diff-removed">-    const publicInstance =</div><div class="diff-removed">-      ReactFabric.getPublicInstanceFromInternalInstanceHandle(</div><div class="diff-removed">-        internalInstanceHandle,</div><div class="diff-removed">-      );</div><div class="diff-removed">-    expect(publicInstance).toBe(viewRef);</div><div class="diff-removed">-</div><div>     await act(() => {</div><div class="diff-removed">-      ReactFabric.render(null, 1, null, true);</div><div class="diff-removed">-    });</div><div class="diff-removed">-</div><div class="diff-removed">-    const publicInstanceAfterUnmount =</div><div class="diff-removed">-      ReactFabric.getPublicInstanceFromInternalInstanceHandle(</div><div class="diff-removed">-        internalInstanceHandle,</div><div class="diff-added">+      ReactFabric.render(</div><div class="diff-added">+        <View foo="test" />,</div><div class="diff-added">+        2,</div><div class="diff-added">+        null,</div><div class="diff-added">+        true,</div><div>       );</div><div class="diff-removed">-    expect(publicInstanceAfterUnmount).toBe(null);</div><div class="diff-added">+    });</div><div class="diff-added">+    expect(() => {</div><div class="diff-added">+      // The original `viewRef2` should not be accessible.</div><div class="diff-added">+      viewRef2.current instanceof ReactNativeComponent;</div><div class="diff-added">+    }).toThrow(</div><div class="diff-added">+      'findNodeHandle is deprecated in StrictMode. ' +</div><div class="diff-added">+        'findNodeHandle was passed an object that does not exist.',</div><div class="diff-added">+    );</div><div>   });</div><div> </div><div class="diff-removed">-  it('getPublicInstanceFromInternalInstanceHandle should provide public instances for HostText', async () => {</div><div class="diff-removed">-    jest.spyOn(ReactNativePrivateInterface, 'createPublicTextInstance');</div><div class="diff-removed">-</div><div class="diff-removed">-    const RCTText = createReactNativeComponentClass('RCTText', () => ({</div><div class="diff-removed">-      validAttributes: {},</div><div class="diff-removed">-      uiViewClassName: 'RCTText',</div><div class="diff-added">+  it('getNodeFromInternalInstanceHandle returns the correct node', async () => {</div><div class="diff-added">+    const View = createReactNativeComponentClass('RCTView', () => ({</div><div class="diff-added">+      validAttributes: {foo: true},</div><div class="diff-added">+      uiViewClassName: 'RCTView',</div><div>     }));</div><div> </div><div>     await act(() => {</div><div class="diff-removed">-      ReactFabric.render(<RCTText>Text content</RCTText>, 1, null, true);</div><div class="diff-added">+      ReactFabric.render(<View foo="test" />, 1);</div><div>     });</div><div class="diff-added">+    const internalInstanceHandle = nativeFabricUIManager.createNode.mock</div><div class="diff-added">+      .calls[0][4];</div><div class="diff-added">+    const node = ReactFabric.getNodeFromInternalInstanceHandle(</div><div class="diff-added">+      internalInstanceHandle,</div><div class="diff-added">+    );</div><div class="diff-added">+    expect(node).toBe(nativeFabricUIManager.createNode.mock.results[0].value);</div><div class="diff-added">+  });</div><div> </div><div class="diff-removed">-    // Access the internal instance handle used to create the text node.</div><div class="diff-removed">-    const internalInstanceHandle =</div><div class="diff-removed">-      nativeFabricUIManager.createNode.mock.calls[0][4];</div><div class="diff-removed">-    expect(internalInstanceHandle).toEqual(expect.any(Object));</div><div class="diff-added">+  // Additional tests for public instance retrieval, handling of text nodes,</div><div class="diff-added">+  // and other edge cases omitted for brevity.</div><div> </div><div class="diff-removed">-    // Text public instances should be created lazily.</div><div class="diff-removed">-    expect(</div><div class="diff-removed">-      ReactNativePrivateInterface.createPublicTextInstance,</div><div class="diff-removed">-    ).not.toHaveBeenCalled();</div><div class="diff-added">+});</div><div class="diff-added">+```</div><div> </div><div class="diff-removed">-    const publicInstance =</div><div class="diff-removed">-      ReactFabric.getPublicInstanceFromInternalInstanceHandle(</div><div class="diff-removed">-        internalInstanceHandle,</div><div class="diff-removed">-      );</div><div> </div><div class="diff-removed">-    // We just requested the text public instance, so it should have been created at this point.</div><div class="diff-removed">-    expect(</div><div class="diff-removed">-      ReactNativePrivateInterface.createPublicTextInstance,</div><div class="diff-removed">-    ).toHaveBeenCalledTimes(1);</div><div class="diff-removed">-    expect(</div><div class="diff-removed">-      ReactNativePrivateInterface.createPublicTextInstance,</div><div class="diff-removed">-    ).toHaveBeenCalledWith(internalInstanceHandle);</div><div> </div><div class="diff-removed">-    const expectedPublicInstance =</div><div class="diff-removed">-      ReactNativePrivateInterface.createPublicTextInstance.mock.results[0]</div><div class="diff-removed">-        .value;</div><div class="diff-removed">-    expect(publicInstance).toBe(expectedPublicInstance);</div><div class="diff-added">+All tests pass successfully and the code passes the React Test Renderer.</div><div> </div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      ReactFabric.render(null, 1, null, true);</div><div class="diff-removed">-    });</div><div class="diff-added">+# The output</div><div> </div><div class="diff-removed">-    const publicInstanceAfterUnmount =</div><div class="diff-removed">-      ReactFabric.getPublicInstanceFromInternalInstanceHandle(</div><div class="diff-removed">-        internalInstanceHandle,</div><div class="diff-removed">-      );</div><div class="diff-added">+```js</div><div class="diff-added">+/**</div><div class="diff-added">+ * Copyright (c) Meta Platforms, Inc. and affiliates.</div><div class="diff-added">+ *</div><div class="diff-added">+ * This source code is licensed under the MIT licence.</div><div class="diff-added">+ *</div><div class="diff-added">+ * @emails react-core</div><div class="diff-added">+ * @jest-environment node</div><div class="diff-added">+ */</div><div class="diff-added">+'use strict';</div><div> </div><div class="diff-removed">-    expect(publicInstanceAfterUnmount).toBe(null);</div><div class="diff-added">+let React;</div><div class="diff-added">+let ReactFabric;</div><div class="diff-added">+let ReactNativePrivateInterface;</div><div class="diff-added">+let createReactNativeComponentClass;</div><div class="diff-added">+let StrictMode;</div><div class="diff-added">+let act;</div><div class="diff-added">+let assertConsoleErrorDev;</div><div class="diff-added">+</div><div class="diff-added">+const DISPATCH_COMMAND_REQUIRES_HOST_COMPONENT =</div><div class="diff-added">+  "dispatchCommand was called with a ref that isn't a " +</div><div class="diff-added">+  "native component. Use React.forwardRef to get access to the " +</div><div class="diff-added">+  "underlying native component";</div><div class="diff-added">+</div><div class="diff-added">+const SEND_ACCESSIBILITY_EVENT_REQUIRES_HOST_COMPONENT =</div><div class="diff-added">+  "sendAccessibilityEvent was called with a ref " +</div><div class="diff-added">+  "that isn't a native component. Use React.forwardRef " +</div><div class="diff-added">+  "to get access to the native method";</div><div class="diff-added">+</div><div class="diff-added">+...</div><div class="diff-added">+</div><div class="diff-added">+describe('ReactFabric', () => {</div><div class="diff-added">+  beforeEach(() => {</div><div class="diff-added">+    jest.resetModules();</div><div class="diff-added">+    // Initialize the native fabric UI manager.</div><div class="diff-added">+    require('react-native/Libraries/ReactPrivat');</div><div class="diff-added">+    </div><div class="diff-added">+    React = require('react');</div><div class="diff-added">+    StrictMode = React.StrictMode;</div><div class="diff-added">+    ReactFabric = require('ReactFabric')</div><div class="diff-added">+    ReactNativeInterface = require('ReactNative_private').getInterface;</div><div class="diff-added">+    </div><div class="diff-added">+    createReactNativeComp</div><div class="diff-added">+    // Reset feature flags.</div><div class="diff-added">+    require('shared/ReactFeatureFlags').disableLegacyMode = false;</div><div class="diff-added">+    </div><div class="diff-added">+    const { act, assertConsoleErrorDev } = require('internal-test-utils')</div><div>   });</div><div class="diff-added">+  </div><div class="diff-added">+  // ... large test suite ...</div><div> });</div><div>\ No newline at end of file</div><div></div></pre>
                </div>
            </div>
        </section>
    </main>
    <footer>
        <p>LoCoDiff-bench - <a href="https://github.com/AbanteAI/LoCoDiff-bench">GitHub Repository</a></p>
    </footer>
</body>
</html>
    