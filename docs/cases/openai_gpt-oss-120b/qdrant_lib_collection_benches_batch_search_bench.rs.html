<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case: lib/collection/benches/batch_search_bench.rs - GPT OSS 120B</title>
    <link rel="stylesheet" href="../../styles.css">
</head>
<body>
    <header>
        <h1>Case: lib/collection/benches/batch_search_bench.rs</h1>
        <h2>Model: GPT OSS 120B</h2>
        <p><a href="../../models/openai_gpt-oss-120b.html">All GPT OSS 120B Cases</a> | <a href="../../cases.html">All Cases</a> | <a href="../../index.html">Home</a></p>
    </header>
    <main>
        <section class="case-details">
            <div class="case-info">
                <h2>Benchmark Case Information</h2>
                <p><strong>Model:</strong> GPT OSS 120B</p>
                <p><strong>Status:</strong> <span class="failure">Failure</span></p>
                <p><strong>Prompt Tokens:</strong> 24820</p>
                <p><strong>Native Prompt Tokens:</strong> 24824</p>
                <p><strong>Native Completion Tokens:</strong> 10398</p>
                <p><strong>Native Tokens Reasoning:</strong> 10398</p>
                <p><strong>Native Finish Reason:</strong> stop</p>
                <p><strong>Cost:</strong> $0.0115221</p>
            </div>
            
            <div class="content-links">
                <h2>View Content</h2>
                <ul>
                    <li><a href="../../content/openai_gpt-oss-120b/qdrant_lib_collection_benches_batch_search_bench.rs/prompt.html" class="content-link">View Prompt</a></li>
                    <li><a href="../../content/openai_gpt-oss-120b/qdrant_lib_collection_benches_batch_search_bench.rs/expected.html" class="content-link">View Expected Output</a></li>
                    <li><a href="../../content/openai_gpt-oss-120b/qdrant_lib_collection_benches_batch_search_bench.rs/actual.html" class="content-link">View Actual Output</a></li>
                </ul>
            </div>
            
            <div class="diff-section">
                <h2>Diff (Expected vs Actual)</h2>
                <div id="diff-output">
                    <pre class="diff"><div></div><div>index 91a2f434c..d13f81753 100644</div><div class="diff-header">--- a/qdrant_lib_collection_benches_batch_search_bench.rs_expectedoutput.txt (expected):tmp/tmpv5snj4ej_expected.txt	</div><div class="diff-header">+++ b/qdrant_lib_collection_benches_batch_search_bench.rs_extracted.txt (actual):tmp/tmpinhslxkz_actual.txt	</div><div class="diff-info">@@ -1,3 +1,9 @@</div><div class="diff-added">+#![allow(deprecated)]</div><div class="diff-added">+</div><div class="diff-added">+#[cfg(not(target_os = "windows"))]</div><div class="diff-added">+mod prof;</div><div class="diff-added">+</div><div class="diff-added">+use std::num::NonZeroU64;</div><div> use std::sync::Arc;</div><div> </div><div> use api::rest::SearchRequestInternal;</div><div class="diff-info">@@ -16,16 +22,14 @@ use common::budget::ResourceBudget;</div><div> use common::counter::hardware_accumulator::HwMeasurementAcc;</div><div> use criterion::{Criterion, criterion_group, criterion_main};</div><div> use rand::rng;</div><div class="diff-removed">-use segment::data_types::vectors::{VectorStructInternal, only_default_vector};</div><div class="diff-removed">-use segment::fixtures::payload_fixtures::random_vector;</div><div class="diff-removed">-use segment::types::{Condition, Distance, FieldCondition, Filter, Payload, Range};</div><div> use serde_json::Map;</div><div> use tempfile::Builder;</div><div> use tokio::runtime::Runtime;</div><div> use tokio::sync::RwLock;</div><div> </div><div class="diff-removed">-#[cfg(not(target_os = "windows"))]</div><div class="diff-removed">-mod prof;</div><div class="diff-added">+use segment::data_types::vectors::{only_default_vector, VectorStructInternal};</div><div class="diff-added">+use segment::fixtures::payload_fixtures::random_vector;</div><div class="diff-added">+use segment::types::{Condition, Distance, FieldCondition, Filter, Payload, Range};</div><div> </div><div> fn create_rnd_batch() -> CollectionUpdateOperations {</div><div>     let mut rng = rng();</div><div class="diff-info">@@ -50,23 +54,30 @@ fn create_rnd_batch() -> CollectionUpdateOperations {</div><div> }</div><div> </div><div> fn batch_search_bench(c: &mut Criterion) {</div><div class="diff-added">+    // Setup temporary storage</div><div>     let storage_dir = Builder::new().prefix("storage").tempdir().unwrap();</div><div> </div><div class="diff-added">+    // Runtime setup</div><div>     let runtime = Runtime::new().unwrap();</div><div>     let search_runtime = Runtime::new().unwrap();</div><div>     let search_runtime_handle = search_runtime.handle();</div><div>     let handle = runtime.handle().clone();</div><div> </div><div class="diff-added">+    // WAL config</div><div>     let wal_config = WalConfig {</div><div>         wal_capacity_mb: 1,</div><div>         wal_segments_ahead: 0,</div><div>     };</div><div> </div><div class="diff-added">+    // Collection params</div><div>     let collection_params = CollectionParams {</div><div class="diff-removed">-        vectors: VectorParamsBuilder::new(100, Distance::Dot).build().into(),</div><div class="diff-added">+        vectors: VectorParamsBuilder::new(100, Distance::Dot)</div><div class="diff-added">+            .build()</div><div class="diff-added">+            .into(),</div><div>         ..CollectionParams::empty()</div><div>     };</div><div> </div><div class="diff-added">+    // Collection config</div><div>     let collection_config = CollectionConfigInternal {</div><div>         params: collection_params,</div><div>         optimizer_config: OptimizersConfig {</div><div class="diff-info">@@ -90,11 +101,18 @@ fn batch_search_bench(c: &mut Criterion) {</div><div> </div><div>     let shared_config = Arc::new(RwLock::new(collection_config));</div><div> </div><div class="diff-removed">-    let payload_index_schema_dir = Builder::new().prefix("qdrant-test").tempdir().unwrap();</div><div class="diff-removed">-    let payload_index_schema_file = payload_index_schema_dir.path().join("payload-schema.json");</div><div class="diff-removed">-    let payload_index_schema =</div><div class="diff-removed">-        Arc::new(SaveOnDisk::load_or_init_default(payload_index_schema_file).unwrap());</div><div class="diff-added">+    // Payload schema storage</div><div class="diff-added">+    let payload_index_schema_dir = Builder::new()</div><div class="diff-added">+        .prefix("qdrant-test")</div><div class="diff-added">+        .tempdir()</div><div class="diff-added">+        .unwrap();</div><div class="diff-added">+    let payload_index_schema_file =</div><div class="diff-added">+        payload_index_schema_dir.path().join("payload-schema.json");</div><div class="diff-added">+    let payload_index_schema = Arc::new(</div><div class="diff-added">+        SaveOnDisk::load_or_init_default(payload_index_schema_file).unwrap(),</div><div class="diff-added">+    );</div><div> </div><div class="diff-added">+    // Build shard</div><div>     let shard = handle</div><div>         .block_on(LocalShard::build_local(</div><div>             0,</div><div class="diff-info">@@ -104,31 +122,37 @@ fn batch_search_bench(c: &mut Criterion) {</div><div>             Default::default(),</div><div>             payload_index_schema,</div><div>             handle.clone(),</div><div class="diff-removed">-            handle.clone(),</div><div>             ResourceBudget::default(),</div><div>             optimizers_config,</div><div>         ))</div><div>         .unwrap();</div><div> </div><div class="diff-added">+    // Populate collection</div><div>     let rnd_batch = create_rnd_batch();</div><div class="diff-removed">-</div><div>     handle</div><div class="diff-removed">-        .block_on(shard.update(rnd_batch.into(), true, HwMeasurementAcc::new()))</div><div class="diff-added">+        .block_on(</div><div class="diff-added">+            shard.update(rnd_batch.into(), true, HwMeasurementAcc::new()),</div><div class="diff-added">+        )</div><div>         .unwrap();</div><div> </div><div class="diff-added">+    // Benchmark group</div><div>     let mut group = c.benchmark_group("batch-search-bench");</div><div> </div><div class="diff-added">+    // Different filters to test</div><div>     let filters = vec![</div><div>         None,</div><div>         Some(Filter::new_must(Condition::Field(</div><div class="diff-removed">-            FieldCondition::new_match("a".parse().unwrap(), 3.into()),</div><div class="diff-added">+            FieldCondition::new_match(</div><div class="diff-added">+                "a".parse().unwrap(),</div><div class="diff-added">+                3.into(),</div><div class="diff-added">+            ),</div><div>         ))),</div><div>         Some(Filter::new_must(Condition::Field(</div><div>             FieldCondition::new_range(</div><div>                 "a".parse().unwrap(),</div><div>                 Range {</div><div>                     lt: None,</div><div class="diff-removed">-                    gt: Some(-1.),</div><div class="diff-added">+                    gt: Some(-1.0),</div><div>                     gte: None,</div><div>                     lte: Some(100.0),</div><div>                 },</div><div class="diff-info">@@ -139,14 +163,15 @@ fn batch_search_bench(c: &mut Criterion) {</div><div>     let batch_size = 100;</div><div> </div><div>     for (fid, filter) in filters.into_iter().enumerate() {</div><div class="diff-removed">-        group.bench_function(format!("search-{fid}"), |b| {</div><div class="diff-added">+        // Single searches within the benchmark</div><div class="diff-added">+        group.bench_function(format!("search-{}", fid), |b| {</div><div>             b.iter(|| {</div><div>                 runtime.block_on(async {</div><div>                     let mut rng = rng();</div><div class="diff-removed">-                    for _i in 0..batch_size {</div><div class="diff-added">+                    for _ in 0..batch_size {</div><div>                         let query = random_vector(&mut rng, 100);</div><div>                         let search_query = SearchRequestInternal {</div><div class="diff-removed">-                            vector: query.into(),</div><div class="diff-added">+                            vector: only_default_vector(&query).into(),</div><div>                             filter: filter.clone(),</div><div>                             params: None,</div><div>                             limit: 10,</div><div class="diff-info">@@ -156,7 +181,7 @@ fn batch_search_bench(c: &mut Criterion) {</div><div>                             score_threshold: None,</div><div>                         };</div><div>                         let hw_acc = HwMeasurementAcc::new();</div><div class="diff-removed">-                        let result = shard</div><div class="diff-added">+                        let _ = shard</div><div>                             .core_search(</div><div>                                 Arc::new(CoreSearchRequestBatch {</div><div>                                     searches: vec![search_query.into()],</div><div class="diff-info">@@ -167,21 +192,21 @@ fn batch_search_bench(c: &mut Criterion) {</div><div>                             )</div><div>                             .await</div><div>                             .unwrap();</div><div class="diff-removed">-                        assert!(!result.is_empty());</div><div>                     }</div><div>                 });</div><div>             })</div><div>         });</div><div> </div><div class="diff-removed">-        group.bench_function(format!("search-batch-{fid}"), |b| {</div><div class="diff-added">+        // Batch search benchmark</div><div class="diff-added">+        group.benchmark_function(format!("search-batch-{}", fid), |b| {</div><div>             b.iter(|| {</div><div>                 runtime.block_on(async {</div><div>                     let mut rng = rng();</div><div>                     let mut searches = Vec::with_capacity(batch_size);</div><div class="diff-removed">-                    for _i in 0..batch_size {</div><div class="diff-added">+                    for _ in 0..batch_size {</div><div>                         let query = random_vector(&mut rng, 100);</div><div>                         let search_query = SearchRequestInternal {</div><div class="diff-removed">-                            vector: query.into(),</div><div class="diff-added">+                            vector: only_default_vector(&query).into(),</div><div>                             filter: filter.clone(),</div><div>                             params: None,</div><div>                             limit: 10,</div><div class="diff-info">@@ -192,14 +217,16 @@ fn batch_search_bench(c: &mut Criterion) {</div><div>                         };</div><div>                         searches.push(search_query.into());</div><div>                     }</div><div class="diff-removed">-</div><div>                     let hw_acc = HwMeasurementAcc::new();</div><div class="diff-removed">-                    let search_query = CoreSearchRequestBatch { searches };</div><div class="diff-removed">-                    let result = shard</div><div class="diff-removed">-                        .core_search(Arc::new(search_query), search_runtime_handle, None, hw_acc)</div><div class="diff-added">+                    let _ = shard</div><div class="diff-added">+                        .core_search(</div><div class="diff-added">+                            Arc::new(CoreSearchRequestBatch { searches }),</div><div class="diff-added">+                            search_runtime_handle,</div><div class="diff-added">+                            None,</div><div class="diff-added">+                            hw_acc,</div><div class="diff-added">+                        )</div><div>                         .await</div><div>                         .unwrap();</div><div class="diff-removed">-                    assert!(!result.is_empty());</div><div>                 });</div><div>             })</div><div>         });</div><div class="diff-info">@@ -210,8 +237,7 @@ fn batch_search_bench(c: &mut Criterion) {</div><div> </div><div> criterion_group! {</div><div>     name = benches;</div><div class="diff-removed">-    config = Criterion::default();</div><div class="diff-added">+    config = Criterion::default().sample_size(50);</div><div>     targets = batch_search_bench,</div><div> }</div><div class="diff-removed">-</div><div> criterion_main!(benches);</div><div>\ No newline at end of file</div><div></div></pre>
                </div>
            </div>
        </section>
    </main>
    <footer>
        <p>LoCoDiff-bench - <a href="https://github.com/AbanteAI/LoCoDiff-bench">GitHub Repository</a></p>
    </footer>
</body>
</html>
    