<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case: packages/editor/src/lib/config/TLSessionStateSnapshot.ts - GPT OSS 120B</title>
    <link rel="stylesheet" href="../../styles.css">
</head>
<body>
    <header>
        <h1>Case: packages/editor/src/lib/config/TLSessionStateSnapshot.ts</h1>
        <h2>Model: GPT OSS 120B</h2>
        <p><a href="../../models/openai_gpt-oss-120b.html">All GPT OSS 120B Cases</a> | <a href="../../cases.html">All Cases</a> | <a href="../../index.html">Home</a></p>
    </header>
    <main>
        <section class="case-details">
            <div class="case-info">
                <h2>Benchmark Case Information</h2>
                <p><strong>Model:</strong> GPT OSS 120B</p>
                <p><strong>Status:</strong> <span class="failure">Failure</span></p>
                <p><strong>Prompt Tokens:</strong> 19363</p>
                <p><strong>Native Prompt Tokens:</strong> 19514</p>
                <p><strong>Native Completion Tokens:</strong> 5514</p>
                <p><strong>Native Tokens Reasoning:</strong> 3818</p>
                <p><strong>Native Finish Reason:</strong> stop</p>
                <p><strong>Cost:</strong> $0.0070626</p>
            </div>
            
            <div class="content-links">
                <h2>View Content</h2>
                <ul>
                    <li><a href="../../content/openai_gpt-oss-120b/tldraw_packages_editor_src_lib_config_TLSessionStateSnapshot.ts/prompt.html" class="content-link">View Prompt</a></li>
                    <li><a href="../../content/openai_gpt-oss-120b/tldraw_packages_editor_src_lib_config_TLSessionStateSnapshot.ts/expected.html" class="content-link">View Expected Output</a></li>
                    <li><a href="../../content/openai_gpt-oss-120b/tldraw_packages_editor_src_lib_config_TLSessionStateSnapshot.ts/actual.html" class="content-link">View Actual Output</a></li>
                </ul>
            </div>
            
            <div class="diff-section">
                <h2>Diff (Expected vs Actual)</h2>
                <div id="diff-output">
                    <pre class="diff"><div></div><div>index 1dbf9d1f4..f31d39848 100644</div><div class="diff-header">--- a/tldraw_packages_editor_src_lib_config_TLSessionStateSnapshot.ts_expectedoutput.txt (expected):tmp/tmprpn7ua9e_expected.txt	</div><div class="diff-header">+++ b/tldraw_packages_editor_src_lib_config_TLSessionStateSnapshot.ts_extracted.txt (actual):tmp/tmpejs2tgdc_actual.txt	</div><div class="diff-info">@@ -1,5 +1,6 @@</div><div> import { Signal, computed } from '@tldraw/state'</div><div> import { UnknownRecord } from '@tldraw/store'</div><div class="diff-added">+</div><div> import {</div><div> 	CameraRecordType,</div><div> 	InstancePageStateRecordType,</div><div class="diff-info">@@ -11,13 +12,16 @@ import {</div><div> 	pluckPreservingValues,</div><div> 	shapeIdValidator,</div><div> } from '@tldraw/tlschema'</div><div class="diff-added">+</div><div> import {</div><div> 	deleteFromSessionStorage,</div><div> 	getFromSessionStorage,</div><div class="diff-added">+	objectMapFromEntries,</div><div> 	setInSessionStorage,</div><div> 	structuredClone,</div><div> 	uniqueId,</div><div> } from '@tldraw/utils'</div><div class="diff-added">+</div><div> import { T } from '@tldraw/validate'</div><div> import isEqual from 'lodash.isequal'</div><div> import { tlenv } from '../globals/environment'</div><div class="diff-info">@@ -27,16 +31,24 @@ const tabIdKey = 'TLDRAW_TAB_ID_v2' as const</div><div> const window = globalThis.window as</div><div> 	| {</div><div> 			navigator: Window['navigator']</div><div class="diff-added">+			localStorage: Window['localStorage']</div><div class="diff-added">+			sessionStorage: Window['sessionStorage']</div><div> 			addEventListener: Window['addEventListener']</div><div> 			TLDRAW_TAB_ID_v2?: string</div><div> 	  }</div><div> 	| undefined</div><div> </div><div class="diff-removed">-// https://stackoverflow.com/a/tldraw_packages_editor_src_lib_config_TLSessionStateSnapshot.ts_expectedoutput.txt (expected): string = window</div><div class="diff-removed">-	? (window[tabIdKey] ??</div><div class="diff-removed">-		getFromSessionStorage(tabIdKey) ??</div><div class="diff-removed">-		`TLDRAW_INSTANCE_STATE_V1_` + uniqueId())</div><div class="diff-added">+	? window[tabIdKey] ??</div><div class="diff-added">+	  getFromSessionStorage(tabIdKey) ??</div><div class="diff-added">+	  `TLDRAW_INSTANCE_STATE_V1_` + uniqueId()</div><div> 	: '<error>'</div><div class="diff-added">+</div><div> if (window) {</div><div> 	window[tabIdKey] = TAB_ID</div><div> 	if (iOS()) {</div><div class="diff-removed">-		// iOS does not trigger beforeunload</div><div class="diff-removed">-		// so we need to keep the sessionStorage value around</div><div class="diff-removed">-		// and hope the user doesn't figure out a way to duplicate their tab</div><div class="diff-removed">-		// in which case they'll have two tabs with the same UI state.</div><div class="diff-removed">-		// It's not a big deal, but it's not ideal.</div><div class="diff-removed">-		// And anyway I can't see a way to duplicate a tab in iOS Safari.</div><div class="diff-added">+		// iOS does not trigger beforeunload so keep sessionStorage</div><div class="diff-added">+		// (duplicate tab detection not perfect)</div><div> 		setInSessionStorage(tabIdKey, TAB_ID)</div><div> 	} else {</div><div> 		deleteFromSessionStorage(tabIdKey)</div><div class="diff-info">@@ -81,10 +90,9 @@ const CURRENT_SESSION_STATE_SNAPSHOT_VERSION = Math.max(...Object.values(Version</div><div> </div><div> function migrate(snapshot: any) {</div><div> 	if (snapshot.version < Versions.Initial) {</div><div class="diff-removed">-		// initial version</div><div class="diff-removed">-		// noop</div><div class="diff-added">+		// initial version (noop)</div><div> 	}</div><div class="diff-removed">-	// add further migrations down here. see TLUserPreferences.ts for an example.</div><div class="diff-added">+	// add further migrations down here… </div><div> </div><div> 	// finally</div><div> 	snapshot.version = CURRENT_SESSION_STATE_SNAPSHOT_VERSION</div><div class="diff-info">@@ -133,22 +141,27 @@ const sessionStateSnapshotValidator: T.Validator<TLSessionStateSnapshot> = T.obj</div><div> 	).optional(),</div><div> })</div><div> </div><div class="diff-removed">-function migrateAndValidateSessionStateSnapshot(state: unknown): TLSessionStateSnapshot | null {</div><div class="diff-added">+function migrateAndValidateSessionStateSnapshot(</div><div class="diff-added">+	state: unknown</div><div class="diff-added">+): TLSessionStateSnapshot | null {</div><div> 	if (!state || typeof state !== 'object') {</div><div> 		console.warn('Invalid instance state')</div><div> 		return null</div><div> 	}</div><div class="diff-removed">-	if (!('version' in state) || typeof state.version !== 'number') {</div><div class="diff-added">+	if (!('version' in state) || typeof (state as any).version !== 'number') {</div><div> 		console.warn('No version in instance state')</div><div> 		return null</div><div> 	}</div><div class="diff-removed">-	if (state.version !== CURRENT_SESSION_STATE_SNAPSHOT_VERSION) {</div><div class="diff-removed">-		state = structuredClone(state)</div><div class="diff-removed">-		migrate(state)</div><div class="diff-added">+	if ((state as any).version !== CURRENT_SESSION_STATE_SNAPSHOT_VERSION) {</div><div class="diff-added">+		// Clone before mutating</div><div class="diff-added">+		const cloned = structuredClone(state)</div><div class="diff-added">+		migrate(cloned)</div><div class="diff-added">+		; (state as any) = cloned</div><div> 	}</div><div class="diff-removed">-</div><div> 	try {</div><div class="diff-removed">-		return sessionStateSnapshotValidator.validate(state)</div><div class="diff-added">+		return sessionStateSnapshotValidator.validate(</div><div class="diff-added">+			state as TLSessionStateSnapshot</div><div class="diff-added">+		) as TLSessionStateSnapshot</div><div> 	} catch (e) {</div><div> 		console.warn(e)</div><div> 		return null</div><div class="diff-info">@@ -158,8 +171,6 @@ function migrateAndValidateSessionStateSnapshot(state: unknown): TLSessionStateS</div><div> /**</div><div>  * Creates a signal of the instance state for a given store.</div><div>  * @public</div><div class="diff-removed">- * @param store - The store to create the instance state snapshot signal for</div><div class="diff-removed">- * @returns</div><div>  */</div><div> export function createSessionStateSnapshotSignal(</div><div> 	store: TLStore</div><div class="diff-info">@@ -168,6 +179,9 @@ export function createSessionStateSnapshotSignal(</div><div> </div><div> 	return computed<TLSessionStateSnapshot | null>(</div><div> 		'sessionStateSnapshot',</div><div class="diff-added">+		/**</div><div class="diff-added">+		 * No side‑effects, no impure getters!</div><div class="diff-added">+		 */</div><div> 		() => {</div><div> 			const instanceState = store.get(TLINSTANCE_ID)</div><div> 			if (!instanceState) return null</div><div class="diff-info">@@ -175,28 +189,28 @@ export function createSessionStateSnapshotSignal(</div><div> 			const allPageIds = [...$allPageIds.get()]</div><div> 			return {</div><div> 				version: CURRENT_SESSION_STATE_SNAPSHOT_VERSION,</div><div class="diff-removed">-				currentPageId: instanceState.currentPageId,</div><div class="diff-removed">-				exportBackground: instanceState.exportBackground,</div><div class="diff-removed">-				isFocusMode: instanceState.isFocusMode,</div><div class="diff-removed">-				isDebugMode: instanceState.isDebugMode,</div><div class="diff-removed">-				isToolLocked: instanceState.isToolLocked,</div><div class="diff-removed">-				isGridMode: instanceState.isGridMode,</div><div class="diff-removed">-				pageStates: allPageIds.map((id) => {</div><div class="diff-removed">-					const ps = store.get(InstancePageStateRecordType.createId(id))</div><div class="diff-removed">-					const camera = store.get(CameraRecordType.createId(id))</div><div class="diff-removed">-					return {</div><div class="diff-removed">-						pageId: id,</div><div class="diff-removed">-						camera: {</div><div class="diff-removed">-							x: camera?.x ?? 0,</div><div class="diff-removed">-							y: camera?.y ?? 0,</div><div class="diff-removed">-							z: camera?.z ?? 1,</div><div class="diff-removed">-						},</div><div class="diff-removed">-						selectedShapeIds: ps?.selectedShapeIds ?? [],</div><div class="diff-removed">-						focusedGroupId: ps?.focusedGroupId ?? null,</div><div class="diff-removed">-					} satisfies NonNullable<TLSessionStateSnapshot['pageStates']>[0]</div><div class="diff-removed">-				}),</div><div class="diff-removed">-			} satisfies TLSessionStateSnapshot</div><div class="diff-removed">-		},</div><div class="diff-added">+					currentPageId: instanceState.currentPageId,</div><div class="diff-added">+					exportBackground: instanceState.exportBackground,</div><div class="diff-added">+					isFocusMode: instanceState.isFocusMode,</div><div class="diff-added">+					isDebugMode: instanceState.isDebugMode,</div><div class="diff-added">+					isToolLocked: instanceState.isToolLocked,</div><div class="diff-added">+					isGridMode: instanceState.isGridMode,</div><div class="diff-added">+					pageStates: allPageIds.map((id) => {</div><div class="diff-added">+						const ps = store.get(InstancePageStateRecordType.createId(id))</div><div class="diff-added">+						const camera = store.get(CameraRecordType.createId(id))</div><div class="diff-added">+						return {</div><div class="diff-added">+							pageId: id,</div><div class="diff-added">+							camera: {</div><div class="diff-added">+								x: camera?.x ?? 0,</div><div class="diff-added">+								y: camera?.y ?? 0,</div><div class="diff-added">+								z: camera?.z ?? 1,</div><div class="diff-added">+							},</div><div class="diff-added">+							selectedShapeIds: ps?.selectedShapeIds ?? [],</div><div class="diff-added">+							focusedGroupId: ps?.focusedGroupId ?? null,</div><div class="diff-added">+						} satisfies NonNullable<TLSessionStateSnapshot['pageStates']>[0]</div><div class="diff-added">+					}),</div><div class="diff-added">+				} satisfies TLSessionStateSnapshot</div><div class="diff-added">+			},</div><div> 		{ isEqual }</div><div> 	)</div><div> }</div><div class="diff-info">@@ -208,19 +222,15 @@ export function createSessionStateSnapshotSignal(</div><div> export interface TLLoadSessionStateSnapshotOptions {</div><div> 	/**</div><div> 	 * By default, some session state flags like `isDebugMode` are not overwritten when loading a snapshot.</div><div class="diff-removed">-	 * These are usually considered "sticky" by users while the document data is not.</div><div> 	 * If you want to overwrite these flags, set this to `true`.</div><div> 	 */</div><div> 	forceOverwrite?: boolean</div><div> }</div><div> </div><div> /**</div><div class="diff-removed">- * Loads a snapshot of the editor's instance state into the store of a new editor instance.</div><div class="diff-added">+ * Loads a snapshot of the editor's instance state into a new store.</div><div>  *</div><div>  * @public</div><div class="diff-removed">- * @param store - The store to load the instance state into</div><div class="diff-removed">- * @param snapshot - The instance state snapshot to load</div><div class="diff-removed">- * @returns</div><div>  */</div><div> export function loadSessionStateSnapshotIntoStore(</div><div> 	store: TLStore,</div><div class="diff-info">@@ -237,7 +247,6 @@ export function loadSessionStateSnapshotIntoStore(</div><div> 	const instanceState = store.schema.types.instance.create({</div><div> 		id: TLINSTANCE_ID,</div><div> 		...preserved,</div><div class="diff-removed">-		// the integrity checker will ensure that the currentPageId is valid</div><div> 		currentPageId: res.currentPageId,</div><div> 		isDebugMode: primary?.isDebugMode ?? secondary?.isDebugMode,</div><div> 		isFocusMode: primary?.isFocusMode ?? secondary?.isFocusMode,</div><div class="diff-info">@@ -246,35 +255,49 @@ export function loadSessionStateSnapshotIntoStore(</div><div> 		exportBackground: primary?.exportBackground ?? secondary?.exportBackground,</div><div> 	})</div><div> </div><div class="diff-added">+	// Gather all existing page states and cameras</div><div class="diff-added">+	const allPageStatesAndCameras = store</div><div class="diff-added">+		.allRecords()</div><div class="diff-added">+		.filter((r) => r.typeName === 'instance_page_state' || r.typeName === 'camera')</div><div class="diff-added">+</div><div> 	store.atomic(() => {</div><div class="diff-added">+		// Remove existing page states and cameras</div><div class="diff-added">+		store.remove(allPageStatesAndCameras.map((r) => r.id))</div><div class="diff-added">+</div><div class="diff-added">+		// Insert new page states and cameras from the snapshot</div><div> 		for (const ps of res.pageStates ?? []) {</div><div> 			if (!store.has(ps.pageId)) continue</div><div> 			const cameraId = CameraRecordType.createId(ps.pageId)</div><div class="diff-removed">-			const instancePageState = InstancePageStateRecordType.createId(ps.pageId)</div><div class="diff-added">+			const instancePageStateId = InstancePageStateRecordType.createId(ps.pageId)</div><div> 			const previousCamera = store.get(cameraId)</div><div class="diff-removed">-			const previousInstanceState = store.get(instancePageState)</div><div class="diff-added">+			const previousInstance = store.get(instancePageStateId)</div><div class="diff-added">+</div><div> 			store.put([</div><div> 				CameraRecordType.create({</div><div> 					id: cameraId,</div><div> 					x: ps.camera?.x ?? previousCamera?.x,</div><div class="diff-removed">-					y: ps.camera?.y ?? previousCamera?.y,</div><div class="diff-removed">-					z: ps.camera?.z ?? previousCamera?.z,</div><div class="diff-added">+					y: camera?.y ?? previousCamera?.y,</div><div class="diff-added">+					z: camera?.z ?? previousCamera?.z,</div><div> 				}),</div><div> 				InstancePageStateRecordType.create({</div><div class="diff-removed">-					id: instancePageState,</div><div class="diff-added">+					id: instancePageStateId,</div><div> 					pageId: ps.pageId,</div><div class="diff-removed">-					selectedShapeIds: ps.selectedShapeIds ?? previousInstanceState?.selectedShapeIds,</div><div class="diff-removed">-					focusedGroupId: ps.focusedGroupId ?? previousInstanceState?.focusedGroupId,</div><div class="diff-added">+					selectedShapeIds:</div><div class="diff-added">+						ps.selectedShapeIds ?? previousInstance?.selectedShapeIds,</div><div class="diff-added">+					focusedGroupId:</div><div class="diff-added">+						ps.focusedGroupId ?? previousInstance?.focusedGroupId,</div><div> 				}),</div><div> 			])</div><div> 		}</div><div class="diff-removed">-</div><div class="diff-added">+		// Save the instance state</div><div> 		store.put([instanceState])</div><div> 		store.ensureStoreIsUsable()</div><div> 	})</div><div> }</div><div> </div><div> /**</div><div class="diff-added">+ * Extract instance state from legacy snapshot.</div><div class="diff-added">+ *</div><div>  * @internal</div><div>  */</div><div> export function extractSessionStateFromLegacySnapshot(</div><div class="diff-info">@@ -287,10 +310,8 @@ export function extractSessionStateFromLegacySnapshot(</div><div> 		}</div><div> 	}</div><div> </div><div class="diff-removed">-	// for scratch documents, we need to extract the most recently-used instance and it's associated page states</div><div class="diff-removed">-	// but oops we don't have the concept of "most recently-used" so we'll just take the first one</div><div> 	const oldInstance = instanceRecords.filter(</div><div class="diff-removed">-		(r) => r.typeName === 'instance' && r.id !== TLINSTANCE_ID</div><div class="diff-added">+		(r) => (r as any).typeName === 'instance' && (r as any).id !== TLINSTANCE_ID</div><div> 	)[0] as any</div><div> 	if (!oldInstance) return null</div><div> </div><div class="diff-info">@@ -306,17 +327,17 @@ export function extractSessionStateFromLegacySnapshot(</div><div> 			.filter((r: any) => r.typeName === 'instance_page_state' && r.instanceId === oldInstance.id)</div><div> 			.map((ps: any) => {</div><div> 				const camera = (store[ps.cameraId] as any) ?? { x: 0, y: 0, z: 1 }</div><div class="diff-removed">-				return {</div><div class="diff-removed">-					pageId: ps.pageId,</div><div class="diff-removed">-					camera: {</div><div class="diff-removed">-						x: camera.x,</div><div class="diff-removed">-						y: camera.y,</div><div class="diff-removed">-						z: camera.z,</div><div class="diff-removed">-					},</div><div class="diff-removed">-					selectedShapeIds: ps.selectedShapeIds,</div><div class="diff-removed">-					focusedGroupId: ps.focusedGroupId,</div><div class="diff-removed">-				} satisfies NonNullable<TLSessionStateSnapshot['pageStates']>[0]</div><div class="diff-removed">-			}),</div><div class="diff-added">+					return {</div><div class="diff-added">+						pageId: ps.pageId,</div><div class="diff-added">+						camera: {</div><div class="diff-added">+							x: camera.x,</div><div class="diff-added">+							y: camera.y,</div><div class="diff-added">+							z: camera.z,</div><div class="diff-added">+						},</div><div class="diff-added">+						selectedShapeIds: ps.selectedShapeIds,</div><div class="diff-added">+						focusedGroupId: ps.focusedGroupId,</div><div class="diff-added">+					} satisfies NonNullable<TLSessionStateSnapshot['pageStates']>[0]</div><div class="diff-added">+				}),</div><div> 	}</div><div> </div><div> 	try {</div><div></div></pre>
                </div>
            </div>
        </section>
    </main>
    <footer>
        <p>LoCoDiff-bench - <a href="https://github.com/AbanteAI/LoCoDiff-bench">GitHub Repository</a></p>
    </footer>
</body>
</html>
    