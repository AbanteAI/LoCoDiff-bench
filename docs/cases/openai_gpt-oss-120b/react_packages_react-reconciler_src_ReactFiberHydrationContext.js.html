<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case: packages/react-reconciler/src/ReactFiberHydrationContext.js - GPT OSS 120B</title>
    <link rel="stylesheet" href="../../styles.css">
</head>
<body>
    <header>
        <h1>Case: packages/react-reconciler/src/ReactFiberHydrationContext.js</h1>
        <h2>Model: GPT OSS 120B</h2>
        <p><a href="../../models/openai_gpt-oss-120b.html">All GPT OSS 120B Cases</a> | <a href="../../cases.html">All Cases</a> | <a href="../../index.html">Home</a></p>
    </header>
    <main>
        <section class="case-details">
            <div class="case-info">
                <h2>Benchmark Case Information</h2>
                <p><strong>Model:</strong> GPT OSS 120B</p>
                <p><strong>Status:</strong> <span class="failure">Failure</span></p>
                <p><strong>Prompt Tokens:</strong> 82014</p>
                <p><strong>Native Prompt Tokens:</strong> 80097</p>
                <p><strong>Native Completion Tokens:</strong> 12430</p>
                <p><strong>Native Tokens Reasoning:</strong> 2210</p>
                <p><strong>Native Finish Reason:</strong> stop</p>
                <p><strong>Cost:</strong> $0.02133705</p>
            </div>
            
            <div class="content-links">
                <h2>View Content</h2>
                <ul>
                    <li><a href="../../content/openai_gpt-oss-120b/react_packages_react-reconciler_src_ReactFiberHydrationContext.js/prompt.html" class="content-link">View Prompt</a></li>
                    <li><a href="../../content/openai_gpt-oss-120b/react_packages_react-reconciler_src_ReactFiberHydrationContext.js/expected.html" class="content-link">View Expected Output</a></li>
                    <li><a href="../../content/openai_gpt-oss-120b/react_packages_react-reconciler_src_ReactFiberHydrationContext.js/actual.html" class="content-link">View Actual Output</a></li>
                </ul>
            </div>
            
            <div class="diff-section">
                <h2>Diff (Expected vs Actual)</h2>
                <div id="diff-output">
                    <pre class="diff"><div></div><div>index f9932b8c4..dfe80e5a9 100644</div><div class="diff-header">--- a/react_packages_react-reconciler_src_ReactFiberHydrationContext.js_expectedoutput.txt (expected):tmp/tmpsxuijm7__expected.txt	</div><div class="diff-header">+++ b/react_packages_react-reconciler_src_ReactFiberHydrationContext.js_extracted.txt (actual):tmp/tmpt1aq8qpp_actual.txt	</div><div class="diff-info">@@ -1,5 +1,5 @@</div><div> /**</div><div class="diff-removed">- * Copyright (c) Meta Platforms, Inc. and affiliates.</div><div class="diff-added">+ * Copyright (c) Meta, Inc. and its affiliates.</div><div>  *</div><div>  * This source code is licensed under the MIT license found in the</div><div>  * LICENSE file in the root directory of this source tree.</div><div class="diff-info">@@ -8,6 +8,7 @@</div><div>  */</div><div> </div><div> import type {Fiber} from './ReactInternalTypes';</div><div class="diff-added">+</div><div> import type {</div><div>   Instance,</div><div>   TextInstance,</div><div class="diff-info">@@ -21,7 +22,16 @@ import type {ActivityState} from './ReactFiberActivityComponent';</div><div> import type {SuspenseState} from './ReactFiberSuspenseComponent';</div><div> import type {TreeContext} from './ReactFiberTreeContext';</div><div> import type {CapturedValue} from './ReactCapturedValue';</div><div class="diff-removed">-import type {HydrationDiffNode} from './ReactFiberHydrationDiffs';</div><div class="diff-added">+type HydrationDiffNode = {</div><div class="diff-added">+  fiber: Fiber,</div><div class="diff-added">+  children: Array<HydrationDiffNode>,</div><div class="diff-added">+  serverProps: null | {[string]: mixed},</div><div class="diff-added">+  serverTail: $ReadOnlyArray<{</div><div class="diff-added">+    type: string,</div><div class="diff-added">+    key?: mixed,</div><div class="diff-added">+  }>,</div><div class="diff-added">+  distanceFromLeaf: number,</div><div class="diff-added">+};</div><div> </div><div> import {</div><div>   HostComponent,</div><div class="diff-info">@@ -32,9 +42,15 @@ import {</div><div> } from './ReactWorkTags';</div><div> import {favorSafetyOverHydrationPerf} from 'shared/ReactFeatureFlags';</div><div> </div><div class="diff-removed">-import {createCapturedValueAtFiber} from './ReactCapturedValue';</div><div class="diff-added">+import {</div><div class="diff-added">+  createCapturedValueAtFiber,</div><div class="diff-added">+  queueRecoverableErrors,</div><div class="diff-added">+} from './ReactFiberWorkLoop';</div><div class="diff-added">+</div><div class="diff-added">+import {</div><div class="diff-added">+  createFiberFromDehydratedFragment,</div><div class="diff-added">+} from './ReactFiber';</div><div> </div><div class="diff-removed">-import {createFiberFromDehydratedFragment} from './ReactFiber';</div><div> import {</div><div>   shouldSetTextContent,</div><div>   supportsHydration,</div><div class="diff-info">@@ -43,18 +59,21 @@ import {</div><div>   getNextHydratableSiblingAfterSingleton,</div><div>   getFirstHydratableChild,</div><div>   getFirstHydratableChildWithinContainer,</div><div class="diff-removed">-  getFirstHydratableChildWithinActivityInstance,</div><div class="diff-removed">-  getFirstHydratableChildWithinSuspenseInstance,</div><div>   getFirstHydratableChildWithinSingleton,</div><div class="diff-added">+  getFirstHydratableChildWithinSuspenseInstance,</div><div class="diff-added">+  getFirstHydratableChildWithinActivityInstance,</div><div>   hydrateInstance,</div><div>   diffHydratedPropsForDevWarnings,</div><div>   describeHydratableInstanceForDevWarnings,</div><div class="diff-added">+  getFirstHydratableChildWithinSingleton,</div><div>   hydrateTextInstance,</div><div>   diffHydratedTextForDevWarnings,</div><div class="diff-removed">-  hydrateActivityInstance,</div><div>   hydrateSuspenseInstance,</div><div class="diff-removed">-  getNextHydratableInstanceAfterActivityInstance,</div><div class="diff-added">+  hydrateActivityInstance,</div><div class="diff-added">+  getNextHydratableSibling,</div><div class="diff-added">+  getNextHydratableSiblingAfterSingleton,</div><div>   getNextHydratableInstanceAfterSuspenseInstance,</div><div class="diff-added">+  getNextHydratableInstanceAfterActivityInstance,</div><div>   shouldDeleteUnhydratedTailInstances,</div><div>   resolveSingletonInstance,</div><div>   canHydrateInstance,</div><div class="diff-info">@@ -63,86 +82,27 @@ import {</div><div>   canHydrateSuspenseInstance,</div><div>   canHydrateFormStateMarker,</div><div>   isFormStateMarkerMatching,</div><div class="diff-removed">-  validateHydratableInstance,</div><div class="diff-removed">-  validateHydratableTextInstance,</div><div> } from './ReactFiberConfig';</div><div class="diff-added">+</div><div> import {OffscreenLane} from './ReactFiberLane';</div><div> import {</div><div>   getSuspendedTreeContext,</div><div>   restoreSuspendedTreeContext,</div><div> } from './ReactFiberTreeContext';</div><div class="diff-removed">-import {queueRecoverableErrors} from './ReactFiberWorkLoop';</div><div> import {getRootHostContainer, getHostContext} from './ReactFiberHostContext';</div><div> import {describeDiff} from './ReactFiberHydrationDiffs';</div><div> import {runWithFiberInDEV} from './ReactCurrentFiber';</div><div> </div><div class="diff-removed">-// The deepest Fiber on the stack involved in a hydration context.</div><div class="diff-removed">-// This may have been an insertion or a hydration.</div><div> let hydrationParentFiber: null | Fiber = null;</div><div> let nextHydratableInstance: null | HydratableInstance = null;</div><div> let isHydrating: boolean = false;</div><div> </div><div class="diff-removed">-// This flag allows for warning supression when we expect there to be mismatches</div><div class="diff-removed">-// due to earlier mismatches or a suspended fiber.</div><div> let didSuspendOrErrorDEV: boolean = false;</div><div class="diff-removed">-</div><div class="diff-removed">-// Hydration differences found that haven't yet been logged.</div><div> let hydrationDiffRootDEV: null | HydrationDiffNode = null;</div><div> </div><div class="diff-removed">-// Hydration errors that were thrown inside this boundary</div><div> let hydrationErrors: Array<CapturedValue<mixed>> | null = null;</div><div> </div><div class="diff-removed">-let rootOrSingletonContext = false;</div><div class="diff-removed">-</div><div class="diff-removed">-// Builds a common ancestor tree from the root down for collecting diffs.</div><div class="diff-removed">-function buildHydrationDiffNode(</div><div class="diff-removed">-  fiber: Fiber,</div><div class="diff-removed">-  distanceFromLeaf: number,</div><div class="diff-removed">-): HydrationDiffNode {</div><div class="diff-removed">-  if (fiber.return === null) {</div><div class="diff-removed">-    // We're at the root.</div><div class="diff-removed">-    if (hydrationDiffRootDEV === null) {</div><div class="diff-removed">-      hydrationDiffRootDEV = {</div><div class="diff-removed">-        fiber: fiber,</div><div class="diff-removed">-        children: [],</div><div class="diff-removed">-        serverProps: undefined,</div><div class="diff-removed">-        serverTail: [],</div><div class="diff-removed">-        distanceFromLeaf: distanceFromLeaf,</div><div class="diff-removed">-      };</div><div class="diff-removed">-    } else if (hydrationDiffRootDEV.fiber !== fiber) {</div><div class="diff-removed">-      throw new Error(</div><div class="diff-removed">-        'Saw multiple hydration diff roots in a pass. This is a bug in React.',</div><div class="diff-removed">-      );</div><div class="diff-removed">-    } else if (hydrationDiffRootDEV.distanceFromLeaf > distanceFromLeaf) {</div><div class="diff-removed">-      hydrationDiffRootDEV.distanceFromLeaf = distanceFromLeaf;</div><div class="diff-removed">-    }</div><div class="diff-removed">-    return hydrationDiffRootDEV;</div><div class="diff-removed">-  }</div><div class="diff-removed">-  const siblings = buildHydrationDiffNode(</div><div class="diff-removed">-    fiber.return,</div><div class="diff-removed">-    distanceFromLeaf + 1,</div><div class="diff-removed">-  ).children;</div><div class="diff-removed">-  // The same node may already exist in the parent. Since we currently always render depth first</div><div class="diff-removed">-  // and rerender if we suspend or terminate early, if a shared ancestor was added we should still</div><div class="diff-removed">-  // be inside of that shared ancestor which means it was the last one to be added. If this changes</div><div class="diff-removed">-  // we may have to scan the whole set.</div><div class="diff-removed">-  if (siblings.length > 0 && siblings[siblings.length - 1].fiber === fiber) {</div><div class="diff-removed">-    const existing = siblings[siblings.length - 1];</div><div class="diff-removed">-    if (existing.distanceFromLeaf > distanceFromLeaf) {</div><div class="diff-removed">-      existing.distanceFromLeaf = distanceFromLeaf;</div><div class="diff-removed">-    }</div><div class="diff-removed">-    return existing;</div><div class="diff-removed">-  }</div><div class="diff-removed">-  const newNode: HydrationDiffNode = {</div><div class="diff-removed">-    fiber: fiber,</div><div class="diff-removed">-    children: [],</div><div class="diff-removed">-    serverProps: undefined,</div><div class="diff-removed">-    serverTail: [],</div><div class="diff-removed">-    distanceFromLeaf: distanceFromLeaf,</div><div class="diff-removed">-  };</div><div class="diff-removed">-  siblings.push(newNode);</div><div class="diff-removed">-  return newNode;</div><div class="diff-removed">-}</div><div class="diff-added">+let rootOrSingletonContext: boolean = false;</div><div> </div><div> function warnIfHydrating() {</div><div>   if (__DEV__) {</div><div class="diff-info">@@ -156,7 +116,7 @@ function warnIfHydrating() {</div><div> </div><div> export function markDidThrowWhileHydratingDEV() {</div><div>   if (__DEV__) {</div><div class="diff-removed">-    didSuspendOrErrorDEV = true;</div><div class="diff-added">+    // dummy, not used in this file.</div><div>   }</div><div> }</div><div> </div><div class="diff-info">@@ -166,8 +126,9 @@ function enterHydrationState(fiber: Fiber): boolean {</div><div>   }</div><div> </div><div>   const parentInstance: Container = fiber.stateNode.containerInfo;</div><div class="diff-removed">-  nextHydratableInstance =</div><div class="diff-removed">-    getFirstHydratableChildWithinContainer(parentInstance);</div><div class="diff-added">+  nextHydratableInstance = getFirstHydratableChildWithinContainer(</div><div class="diff-added">+    parentInstance,</div><div class="diff-added">+  );</div><div>   hydrationParentFiber = fiber;</div><div>   isHydrating = true;</div><div>   hydrationErrors = null;</div><div class="diff-info">@@ -177,16 +138,22 @@ function enterHydrationState(fiber: Fiber): boolean {</div><div>   return true;</div><div> }</div><div> </div><div class="diff-removed">-function reenterHydrationStateFromDehydratedActivityInstance(</div><div class="diff-added">+/**</div><div class="diff-added">+ * Called by the Suspense component when it knows that it needs to be</div><div class="diff-added">+ * re-entered due to a mismatch in the hydration context.</div><div class="diff-added">+ *</div><div class="diff-added">+ * This re-enters the Hydra state for a Suspense boundary.</div><div class="diff-added">+ */</div><div class="diff-added">+function reenterHydrationStateFromDehydratedSuspenseInstance(</div><div>   fiber: Fiber,</div><div class="diff-removed">-  activityInstance: ActivityInstance,</div><div class="diff-added">+  suspenseInstance: SuspenseInstance,</div><div>   treeContext: TreeContext | null,</div><div> ): boolean {</div><div>   if (!supportsHydration) {</div><div>     return false;</div><div>   }</div><div>   nextHydratableInstance =</div><div class="diff-removed">-    getFirstHydratableChildWithinActivityInstance(activityInstance);</div><div class="diff-added">+    getFirstHydratableChildWithinSuspenseInstance(suspenseInstance);</div><div>   hydrationParentFiber = fiber;</div><div>   isHydrating = true;</div><div>   hydrationErrors = null;</div><div class="diff-info">@@ -199,16 +166,22 @@ function reenterHydrationStateFromDehydratedActivityInstance(</div><div>   return true;</div><div> }</div><div> </div><div class="diff-removed">-function reenterHydrationStateFromDehydratedSuspenseInstance(</div><div class="diff-added">+/**</div><div class="diff-added">+ * Called by an Activity component when it knows that it needs to be</div><div class="diff-added">+ * re-entered due to a mismatch in the hydration context.</div><div class="diff-added">+ *</div><div class="diff-added">+ * This re-enters the Hydra state for an Activity boundary.</div><div class="diff-added">+ */</div><div class="diff-added">+function reenterHydrationStateFromDehydratedActivityInstance(</div><div>   fiber: Fiber,</div><div class="diff-removed">-  suspenseInstance: SuspenseInstance,</div><div class="diff-added">+  activityInstance: ActivityInstance,</div><div>   treeContext: TreeContext | null,</div><div> ): boolean {</div><div>   if (!supportsHydration) {</div><div>     return false;</div><div>   }</div><div>   nextHydratableInstance =</div><div class="diff-removed">-    getFirstHydratableChildWithinSuspenseInstance(suspenseInstance);</div><div class="diff-added">+    getFirstHydratableChildWithinActivityInstance(activityInstance);</div><div>   hydrationParentFiber = fiber;</div><div>   isHydrating = true;</div><div>   hydrationErrors = null;</div><div class="diff-info">@@ -221,30 +194,114 @@ function reenterHydrationStateFromDehydratedSuspenseInstance(</div><div>   return true;</div><div> }</div><div> </div><div class="diff-removed">-function warnNonHydratedInstance(</div><div class="diff-removed">-  fiber: Fiber,</div><div class="diff-removed">-  rejectedCandidate: null | HydratableInstance,</div><div class="diff-added">+// ---------------------------------------------------------------------------</div><div class="diff-added">+// Hydration warning / error handling</div><div class="diff-added">+// ---------------------------------------------------------------------------</div><div class="diff-added">+</div><div class="diff-added">+function warnForDeletedHydratableInstance(</div><div class="diff-added">+  parentType: string,</div><div class="diff-added">+  child: HydratableInstance,</div><div> ) {</div><div>   if (__DEV__) {</div><div class="diff-removed">-    if (didSuspendOrErrorDEV) {</div><div class="diff-removed">-      // Inside a boundary that already suspended. We're currently rendering the</div><div class="diff-removed">-      // siblings of a suspended node. The mismatch may be due to the missing</div><div class="diff-removed">-      // data, so it's probably a false positive.</div><div class="diff-removed">-      return;</div><div class="diff-added">+    const description = describeHydratableInstanceForDevWarnings(child);</div><div class="diff-added">+    if (typeof description === 'string') {</div><div class="diff-added">+      console.error(</div><div class="diff-added">+        'Did not expect server HTML to contain the text node "%s" in <%s>.',</div><div class="diff-added">+        description,</div><div class="diff-added">+        parentType,</div><div class="diff-added">+      );</div><div class="diff-added">+    } else {</div><div class="diff-added">+      console.error(</div><div class="diff-added">+        'Did not expect server HTML to contain a <%s> in <%s>.',</div><div class="diff-added">+        description.type,</div><div class="diff-added">+        parentType,</div><div class="diff-added">+      );</div><div>     }</div><div class="diff-added">+  }</div><div class="diff-added">+}</div><div> </div><div class="diff-removed">-    // Add this fiber to the diff tree.</div><div class="diff-removed">-    const diffNode = buildHydrationDiffNode(fiber, 0);</div><div class="diff-removed">-    // We use null as a signal that there was no node to match.</div><div class="diff-removed">-    diffNode.serverProps = null;</div><div class="diff-removed">-    if (rejectedCandidate !== null) {</div><div class="diff-removed">-      const description =</div><div class="diff-removed">-        describeHydratableInstanceForDevWarnings(rejectedCandidate);</div><div class="diff-removed">-      diffNode.serverTail.push(description);</div><div class="diff-added">+function warnForInsertedHydratedElement(parentType: string, tag: string) {</div><div class="diff-added">+  if (__DEV__) {</div><div class="diff-added">+    console.error(</div><div class="diff-added">+      'Expected server HTML to contain a matching <%s> in <%s>.',</div><div class="diff-added">+      tag,</div><div class="diff-added">+      parentType,</div><div class="diff-added">+    );</div><div class="diff-added">+  }</div><div class="diff-added">+}</div><div class="diff-added">+</div><div class="diff-added">+function warnForInsertedHydratedText(parentType: string, text: string) {</div><div class="diff-added">+  if (__DEV__) {</div><div class="diff-added">+    console.error(</div><div class="diff-added">+      'Expected server HTML to contain matching text "%s" in <%s>.',</div><div class="diff-added">+      text,</div><div class="diff-added">+      parentType,</div><div class="diff-added">+    );</div><div class="diff-added">+  }</div><div class="diff-added">+}</div><div class="diff-added">+</div><div class="diff-added">+export const HydrationMismatchException: mixed = new Error(</div><div class="diff-added">+  "Hydration Mismatch Exception: This is not a real error, or otherwise we would hide it from users. If you see this, it's a bug in React.",</div><div class="diff-added">+);</div><div class="diff-added">+</div><div class="diff-added">+function throwOnHydrationMismatch(fiber: Fiber, fromText: boolean = false) {</div><div class="diff-added">+  let diff = '';</div><div class="diff-added">+  if (__DEV__) {</div><div class="diff-added">+    const diffRoot = hydrationDiffRootDEV;</div><div class="diff-added">+    if (diffRoot !== null) {</div><div class="diff-added">+      diff = describeDiff(diffRoot);</div><div class="diff-added">+      hydrationDiffRootDEV = null;</div><div class="diff-added">+    }</div><div class="diff-added">+  }</div><div class="diff-added">+  const error = new Error(</div><div class="diff-added">+    `Hydration failed because the server rendered ${fromText ? 'text' : 'HTML'} didn't match the client. As a result this tree will be regenerated on the client. This can happen if a SSR-ed Client Component used:\n` +</div><div class="diff-added">+      '\n' +</div><div class="diff-added">+      "- A server/client branch `if (typeof window !== 'undefined')`.\n" +</div><div class="diff-added">+      "- Variable input such as Date.now() or Math.random() which changes each time.\n" +</div><div class="diff-added">+      '- Locale dependent date formatting.\n' +</div><div class="diff-added">+      '- External changing data without snapshot.\n' +</div><div class="diff-added">+      '- Invalid HTML nesting.\n' +</div><div class="diff-added">+      '\n' +</div><div class="diff-added">+      'It can also happen if the client has a browser extension that modifies the DOM before React loads.\n' +</div><div class="diff-added">+      '\n' +</div><div class="diff-added">+      'https://react.dev/link/hydration-mismatch' +</div><div class="diff-added">+      diff,</div><div class="diff-added">+  );</div><div class="diff-added">+  queueHydrationError(createCapturedValueAtFiber(error, fiber));</div><div class="diff-added">+  throw HydrationMismatchException;</div><div class="diff-added">+}</div><div class="diff-added">+</div><div class="diff-added">+// ---------------------------------------------------------------------------</div><div class="diff-added">+// Claim hydratable instances</div><div class="diff-added">+// ---------------------------------------------------------------------------</div><div class="diff-added">+</div><div class="diff-added">+function claimHydratableSingleton(fiber: Fiber): void {</div><div class="diff-added">+  if (supportsSingletons) {</div><div class="diff-added">+    if (!isHydrating) {</div><div class="diff-added">+      return;</div><div>     }</div><div class="diff-added">+    const currentRootContainer = getRootHostContainer();</div><div class="diff-added">+    const currentHostContext = getHostContext();</div><div class="diff-added">+    const instance = (fiber.stateNode = resolveSingletonInstance(</div><div class="diff-added">+      fiber.type,</div><div class="diff-added">+      fiber.pendingProps,</div><div class="diff-added">+      currentRootContainer,</div><div class="diff-added">+      currentHostContext,</div><div class="diff-added">+      false,</div><div class="diff-added">+    ));</div><div class="diff-added">+    hydrationParentFiber = fiber;</div><div class="diff-added">+    rootOrSingletonContext = true;</div><div class="diff-added">+    nextHydratableInstance = getFirstHydratableChildWithinSingleton(</div><div class="diff-added">+      fiber.type,</div><div class="diff-added">+      instance,</div><div class="diff-added">+      nextHydratableInstance,</div><div class="diff-added">+    );</div><div>   }</div><div> }</div><div> </div><div class="diff-added">+/**</div><div class="diff-added">+ * Normal case: we are attempting to hydrate a HostComponent.</div><div class="diff-added">+ */</div><div> function tryHydrateInstance(</div><div>   fiber: Fiber,</div><div>   nextInstance: any,</div><div class="diff-info">@@ -255,17 +312,15 @@ function tryHydrateInstance(</div><div>     nextInstance,</div><div>     fiber.type,</div><div>     fiber.pendingProps,</div><div class="diff-removed">-    rootOrSingletonContext,</div><div>   );</div><div>   if (instance !== null) {</div><div>     fiber.stateNode = (instance: Instance);</div><div class="diff-removed">-</div><div>     if (__DEV__) {</div><div>       if (!didSuspendOrErrorDEV) {</div><div>         const differences = diffHydratedPropsForDevWarnings(</div><div>           instance,</div><div>           fiber.type,</div><div class="diff-removed">-          fiber.pendingProps,</div><div class="diff-added">+          fiber.memoizedProps,</div><div>           hostContext,</div><div>         );</div><div>         if (differences !== null) {</div><div class="diff-info">@@ -274,7 +329,6 @@ function tryHydrateInstance(</div><div>         }</div><div>       }</div><div>     }</div><div class="diff-removed">-</div><div>     hydrationParentFiber = fiber;</div><div>     nextHydratableInstance = getFirstHydratableChild(instance);</div><div>     rootOrSingletonContext = false;</div><div class="diff-info">@@ -283,8 +337,13 @@ function tryHydrateInstance(</div><div>   return false;</div><div> }</div><div> </div><div class="diff-removed">-function tryHydrateText(fiber: Fiber, nextInstance: any) {</div><div class="diff-removed">-  // fiber is a HostText Fiber</div><div class="diff-added">+/**</div><div class="diff-added">+ * Normal case: we are attempting to hydrate a HostText.</div><div class="diff-added">+ */</div><div class="diff-added">+function tryHydrateText(</div><div class="diff-added">+  fiber: Fiber,</div><div class="diff-added">+  nextInstance: any,</div><div class="diff-added">+) {</div><div>   const text = fiber.pendingProps;</div><div>   const textInstance = canHydrateTextInstance(</div><div>     nextInstance,</div><div class="diff-info">@@ -294,13 +353,16 @@ function tryHydrateText(fiber: Fiber, nextInstance: any) {</div><div>   if (textInstance !== null) {</div><div>     fiber.stateNode = (textInstance: TextInstance);</div><div>     hydrationParentFiber = fiber;</div><div class="diff-removed">-    // Text Instances don't have children so there's nothing to hydrate.</div><div class="diff-added">+    // Text nodes have no children, so no further hydration.</div><div>     nextHydratableInstance = null;</div><div>     return true;</div><div>   }</div><div>   return false;</div><div> }</div><div> </div><div class="diff-added">+/**</div><div class="diff-added">+ * Normal case: we are attempting to hydrate an Activity.</div><div class="diff-added">+ */</div><div> function tryHydrateActivity(</div><div>   fiber: Fiber,</div><div>   nextInstance: any,</div><div class="diff-info">@@ -317,177 +379,117 @@ function tryHydrateActivity(</div><div>       retryLane: OffscreenLane,</div><div>       hydrationErrors: null,</div><div>     };</div><div class="diff-added">+</div><div>     fiber.memoizedState = activityState;</div><div class="diff-removed">-    // Store the dehydrated fragment as a child fiber.</div><div class="diff-removed">-    // This simplifies the code for getHostSibling and deleting nodes,</div><div class="diff-removed">-    // since it doesn't have to consider all Suspense boundaries and</div><div class="diff-removed">-    // check if they're dehydrated ones or not.</div><div class="diff-removed">-    const dehydratedFragment =</div><div class="diff-removed">-      createFiberFromDehydratedFragment(activityInstance);</div><div class="diff-added">+    // We'll deal with the child after the container is re-entered.</div><div class="diff-added">+    hydrationParentFiber = fiber;</div><div class="diff-added">+    // For Activity, we also store a child fragment fiber.</div><div class="diff-added">+    const dehydratedFragment = createFiberFromDehydratedFragment(</div><div class="diff-added">+      activityInstance,</div><div class="diff-added">+    );</div><div>     dehydratedFragment.return = fiber;</div><div>     fiber.child = dehydratedFragment;</div><div class="diff-removed">-    hydrationParentFiber = fiber;</div><div class="diff-removed">-    // While an Activity Instance does have children, we won't step into</div><div class="diff-removed">-    // it during the first pass. Instead, we'll reenter it later.</div><div class="diff-added">+    // The actual children will be walked later.</div><div>     nextHydratableInstance = null;</div><div class="diff-added">+    return activityInstance;</div><div>   }</div><div class="diff-removed">-  return activityInstance;</div><div class="diff-added">+  return null;</div><div> }</div><div> </div><div class="diff-added">+/**</div><div class="diff-added">+ * Normal case: we are attempting to hydrate a SuspenseBoundary.</div><div class="diff-added">+ */</div><div> function tryHydrateSuspense(</div><div>   fiber: Fiber,</div><div>   nextInstance: any,</div><div> ): null | SuspenseInstance {</div><div class="diff-removed">-  // fiber is a SuspenseComponent Fiber</div><div class="diff-removed">-  const suspenseInstance = canHydrateSuspenseInstance(</div><div class="diff-removed">-    nextInstance,</div><div class="diff-removed">-    rootOrSingletonContext,</div><div class="diff-removed">-  );</div><div class="diff-removed">-  if (suspenseInstance !== null) {</div><div class="diff-added">+  const instance = canHydrateSuspenseInstance(nextInstance);</div><div class="diff-added">+  if (instance !== null) {</div><div>     const suspenseState: SuspenseState = {</div><div class="diff-removed">-      dehydrated: suspenseInstance,</div><div class="diff-added">+      dehydrated: instance,</div><div>       treeContext: getSuspendedTreeContext(),</div><div>       retryLane: OffscreenLane,</div><div>       hydrationErrors: null,</div><div>     };</div><div>     fiber.memoizedState = suspenseState;</div><div class="diff-removed">-    // Store the dehydrated fragment as a child fiber.</div><div class="diff-removed">-    // This simplifies the code for getHostSibling and deleting nodes,</div><div class="diff-removed">-    // since it doesn't have to consider all Suspense boundaries and</div><div class="diff-removed">-    // check if they're dehydrated ones or not.</div><div class="diff-removed">-    const dehydratedFragment =</div><div class="diff-removed">-      createFiberFromDehydratedFragment(suspenseInstance);</div><div class="diff-added">+</div><div class="diff-added">+    const dehydratedFragment = createFiberFromDehydratedFragment(</div><div class="diff-added">+      instance,</div><div class="diff-added">+    );</div><div>     dehydratedFragment.return = fiber;</div><div>     fiber.child = dehydratedFragment;</div><div class="diff-removed">-    hydrationParentFiber = fiber;</div><div class="diff-removed">-    // While a Suspense Instance does have children, we won't step into</div><div class="diff-removed">-    // it during the first pass. Instead, we'll reenter it later.</div><div class="diff-removed">-    nextHydratableInstance = null;</div><div class="diff-removed">-  }</div><div class="diff-removed">-  return suspenseInstance;</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-export const HydrationMismatchException: mixed = new Error(</div><div class="diff-removed">-  'Hydration Mismatch Exception: This is not a real error, and should not leak into ' +</div><div class="diff-removed">-    "userspace. If you're seeing this, it's likely a bug in React.",</div><div class="diff-removed">-);</div><div class="diff-removed">-</div><div class="diff-removed">-function throwOnHydrationMismatch(fiber: Fiber, fromText: boolean = false) {</div><div class="diff-removed">-  let diff = '';</div><div class="diff-removed">-  if (__DEV__) {</div><div class="diff-removed">-    // Consume the diff root for this mismatch.</div><div class="diff-removed">-    // Any other errors will get their own diffs.</div><div class="diff-removed">-    const diffRoot = hydrationDiffRootDEV;</div><div class="diff-removed">-    if (diffRoot !== null) {</div><div class="diff-removed">-      hydrationDiffRootDEV = null;</div><div class="diff-removed">-      diff = describeDiff(diffRoot);</div><div class="diff-removed">-    }</div><div class="diff-removed">-  }</div><div class="diff-removed">-  const error = new Error(</div><div class="diff-removed">-    `Hydration failed because the server rendered ${fromText ? 'text' : 'HTML'} didn't match the client. As a result this tree will be regenerated on the client. This can happen if a SSR-ed Client Component used:</div><div class="diff-removed">-` +</div><div class="diff-removed">-      '\n' +</div><div class="diff-removed">-      "- A server/client branch `if (typeof window !== 'undefined')`.\n" +</div><div class="diff-removed">-      "- Variable input such as `Date.now()` or `Math.random()` which changes each time it's called.\n" +</div><div class="diff-removed">-      "- Date formatting in a user's locale which doesn't match the server.\n" +</div><div class="diff-removed">-      '- External changing data without sending a snapshot of it along with the HTML.\n' +</div><div class="diff-removed">-      '- Invalid HTML tag nesting.\n' +</div><div class="diff-removed">-      '\n' +</div><div class="diff-removed">-      'It can also happen if the client has a browser extension installed which messes with the HTML before React loaded.\n' +</div><div class="diff-removed">-      '\n' +</div><div class="diff-removed">-      'https://react.dev/link/hydration-mismatch' +</div><div class="diff-removed">-      diff,</div><div class="diff-removed">-  );</div><div class="diff-removed">-  queueHydrationError(createCapturedValueAtFiber(error, fiber));</div><div class="diff-removed">-  throw HydrationMismatchException;</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-function claimHydratableSingleton(fiber: Fiber): void {</div><div class="diff-removed">-  if (supportsSingletons) {</div><div class="diff-removed">-    if (!isHydrating) {</div><div class="diff-removed">-      return;</div><div class="diff-removed">-    }</div><div class="diff-removed">-    const currentRootContainer = getRootHostContainer();</div><div class="diff-removed">-    const currentHostContext = getHostContext();</div><div class="diff-removed">-    const instance = (fiber.stateNode = resolveSingletonInstance(</div><div class="diff-removed">-      fiber.type,</div><div class="diff-removed">-      fiber.pendingProps,</div><div class="diff-removed">-      currentRootContainer,</div><div class="diff-removed">-      currentHostContext,</div><div class="diff-removed">-      false,</div><div class="diff-removed">-    ));</div><div class="diff-removed">-</div><div class="diff-removed">-    if (__DEV__) {</div><div class="diff-removed">-      if (!didSuspendOrErrorDEV) {</div><div class="diff-removed">-        const differences = diffHydratedPropsForDevWarnings(</div><div class="diff-removed">-          instance,</div><div class="diff-removed">-          fiber.type,</div><div class="diff-removed">-          fiber.pendingProps,</div><div class="diff-removed">-          currentHostContext,</div><div class="diff-removed">-        );</div><div class="diff-removed">-        if (differences !== null) {</div><div class="diff-removed">-          const diffNode = buildHydrationDiffNode(fiber, 0);</div><div class="diff-removed">-          diffNode.serverProps = differences;</div><div class="diff-removed">-        }</div><div class="diff-removed">-      }</div><div class="diff-removed">-    }</div><div> </div><div>     hydrationParentFiber = fiber;</div><div class="diff-removed">-    rootOrSingletonContext = true;</div><div class="diff-removed">-    nextHydratableInstance = getFirstHydratableChildWithinSingleton(</div><div class="diff-removed">-      fiber.type,</div><div class="diff-removed">-      instance,</div><div class="diff-removed">-      nextHydratableInstance,</div><div class="diff-removed">-    );</div><div class="diff-added">+    // We don't step into the content yet, will re-enter later.</div><div class="diff-added">+    nextHydratableInstance = null;</div><div class="diff-added">+    return instance;</div><div>   }</div><div class="diff-added">+  return null;</div><div> }</div><div> </div><div class="diff-added">+/**</div><div class="diff-added">+ * Try to claim the next hydrateable DOM element for this Fiber.</div><div class="diff-added">+ */</div><div> function tryToClaimNextHydratableInstance(fiber: Fiber): void {</div><div>   if (!isHydrating) {</div><div>     return;</div><div>   }</div><div class="diff-removed">-</div><div class="diff-removed">-  // Validate that this is ok to render here before any mismatches.</div><div class="diff-removed">-  const currentHostContext = getHostContext();</div><div class="diff-removed">-  const shouldKeepWarning = validateHydratableInstance(</div><div class="diff-removed">-    fiber.type,</div><div class="diff-removed">-    fiber.pendingProps,</div><div class="diff-removed">-    currentHostContext,</div><div class="diff-removed">-  );</div><div class="diff-removed">-</div><div class="diff-added">+  const hostContext = getHostContext();</div><div>   const nextInstance = nextHydratableInstance;</div><div class="diff-removed">-  if (</div><div class="diff-removed">-    !nextInstance ||</div><div class="diff-removed">-    !tryHydrateInstance(fiber, nextInstance, currentHostContext)</div><div class="diff-removed">-  ) {</div><div class="diff-removed">-    if (shouldKeepWarning) {</div><div class="diff-added">+  if (!nextInstance) {</div><div class="diff-added">+    if (shouldClientRenderOnMismatch(fiber)) {</div><div class="diff-added">+      warnNonHydratedInstance(fiber, null);</div><div class="diff-added">+    }</div><div class="diff-added">+    insertNonHydratedInstance((hydrationParentFiber: any), fiber);</div><div class="diff-added">+    isHydrating = false;</div><div class="diff-added">+    hydrationParentFiber = fiber;</div><div class="diff-added">+    return;</div><div class="diff-added">+  }</div><div class="diff-added">+  if (!tryHydrateInstance(fiber, nextInstance, hostContext)) {</div><div class="diff-added">+    if (shouldClientRenderOnMismatch(fiber)) {</div><div>       warnNonHydratedInstance(fiber, nextInstance);</div><div>     }</div><div class="diff-removed">-    throwOnHydrationMismatch(fiber);</div><div class="diff-added">+    insertNonHydratedInstance((hydrationParentFiber: any), fiber);</div><div class="diff-added">+    isHydrating = false;</div><div class="diff-added">+    hydrationParentFiber = fiber;</div><div class="diff-added">+    return;</div><div>   }</div><div> }</div><div> </div><div class="diff-added">+/**</div><div class="diff-added">+ * Same as ``tryToClaimNextHydratableInstance`` but operates on HostText</div><div class="diff-added">+ * instances.</div><div class="diff-added">+ */</div><div> function tryToClaimNextHydratableTextInstance(fiber: Fiber): void {</div><div>   if (!isHydrating) {</div><div>     return;</div><div>   }</div><div class="diff-removed">-  const text = fiber.pendingProps;</div><div class="diff-removed">-</div><div class="diff-removed">-  let shouldKeepWarning = true;</div><div class="diff-removed">-  // Validate that this is ok to render here before any mismatches.</div><div class="diff-removed">-  const currentHostContext = getHostContext();</div><div class="diff-removed">-  shouldKeepWarning = validateHydratableTextInstance(text, currentHostContext);</div><div class="diff-removed">-</div><div>   const nextInstance = nextHydratableInstance;</div><div class="diff-removed">-  if (!nextInstance || !tryHydrateText(fiber, nextInstance)) {</div><div class="diff-removed">-    if (shouldKeepWarning) {</div><div class="diff-added">+  if (!nextInstance || !isHydratableText(pendingProps)) {</div><div class="diff-added">+    warnNonHydratedInstance(fiber, nextInstance);</div><div class="diff-added">+    insertNonHydratedInstance((hydrationParentFiber: any), fiber);</div><div class="diff-added">+    isHydrating = false;</div><div class="diff-added">+    hydrationParentFiber = fiber;</div><div class="diff-added">+    return;</div><div class="diff-added">+  }</div><div class="diff-added">+  if (!tryHydrateText(fiber, nextInstance)) {</div><div class="diff-added">+    if (shouldClientRenderOnMismatch(fiber)) {</div><div>       warnNonHydratedInstance(fiber, nextInstance);</div><div>     }</div><div class="diff-removed">-    throwOnHydrationMismatch(fiber);</div><div class="diff-added">+    insertNonHydratedInstance((hydrationParentFiber: any), fiber);</div><div class="diff-added">+    isHydrating = false;</div><div class="diff-added">+    hydrationParentFiber = fiber;</div><div class="diff-added">+    return;</div><div>   }</div><div> }</div><div> </div><div class="diff-removed">-function claimNextHydratableActivityInstance(fiber: Fiber): ActivityInstance {</div><div class="diff-added">+/**</div><div class="diff-added">+ * Same as ``tryToClaimNextHydratableInstance`` but operates on</div><div class="diff-added">+ * ActivityComponent instances.</div><div class="diff-added">+ */</div><div class="diff-added">+function claimNextHydratableActivityInstance(</div><div class="diff-added">+  fiber: Fiber,</div><div class="diff-added">+): ActivityInstance {</div><div>   const nextInstance = nextHydratableInstance;</div><div>   const activityInstance = nextInstance</div><div>     ? tryHydrateActivity(fiber, nextInstance)</div><div class="diff-info">@@ -499,7 +501,13 @@ function claimNextHydratableActivityInstance(fiber: Fiber): ActivityInstance {</div><div>   return activityInstance;</div><div> }</div><div> </div><div class="diff-removed">-function claimNextHydratableSuspenseInstance(fiber: Fiber): SuspenseInstance {</div><div class="diff-added">+/**</div><div class="diff-added">+ * Same as ``tryToClaimNextHydratableInstance`` but operates on</div><div class="diff-added">+ * SuspenseComponent instances.</div><div class="diff-added">+ */</div><div class="diff-added">+function claimNextHydratableSuspenseInstance(</div><div class="diff-added">+  fiber: Fiber,</div><div class="diff-added">+): SuspenseInstance {</div><div>   const nextInstance = nextHydratableInstance;</div><div>   const suspenseInstance = nextInstance</div><div>     ? tryHydrateSuspense(fiber, nextInstance)</div><div class="diff-info">@@ -511,6 +519,10 @@ function claimNextHydratableSuspenseInstance(fiber: Fiber): SuspenseInstance {</div><div>   return suspenseInstance;</div><div> }</div><div> </div><div class="diff-added">+/**</div><div class="diff-added">+ * The form marker is used to indicate that a component was</div><div class="diff-added">+ * rendered with an action state.</div><div class="diff-added">+ */</div><div> export function tryToClaimNextHydratableFormMarkerInstance(</div><div>   fiber: Fiber,</div><div> ): boolean {</div><div class="diff-info">@@ -523,300 +535,209 @@ export function tryToClaimNextHydratableFormMarkerInstance(</div><div>       rootOrSingletonContext,</div><div>     );</div><div>     if (markerInstance) {</div><div class="diff-removed">-      // Found the marker instance.</div><div class="diff-added">+      // if we found a marker, match.</div><div>       nextHydratableInstance = getNextHydratableSibling(markerInstance);</div><div class="diff-removed">-      // Return true if this marker instance should use the state passed</div><div class="diff-removed">-      // to hydrateRoot.</div><div class="diff-removed">-      // TODO: As an optimization, Fizz should only emit these markers if form</div><div class="diff-removed">-      // state is passed at the root.</div><div class="diff-added">+      // return true if this marker instance was matched.</div><div class="diff-added">+      // TODO: We should pass this fact to the fiber.</div><div>       return isFormStateMarkerMatching(markerInstance);</div><div>     }</div><div>   }</div><div class="diff-removed">-  // Should have found a marker instance. Throw an error to trigger client</div><div class="diff-removed">-  // rendering. We don't bother to check if we're in a concurrent root because</div><div class="diff-removed">-  // useActionState is a new API, so backwards compat is not an issue.</div><div class="diff-added">+  // We did not find a marker; throw for client render.</div><div class="diff-added">+  // Use "throw on mismtach".</div><div>   throwOnHydrationMismatch(fiber);</div><div class="diff-removed">-  return false;</div><div class="diff-added">+  return false; // unreachable</div><div> }</div><div> </div><div class="diff-added">+/**</div><div class="diff-added">+ * Prepare a HostComponent instance for hydration.</div><div class="diff-added">+ *</div><div class="diff-added">+ * The host instance is considered "equal" the host's</div><div class="diff-added">+ * type and props and may produce a diff of properties.</div><div class="diff-added">+ */</div><div> function prepareToHydrateHostInstance(</div><div>   fiber: Fiber,</div><div>   hostContext: HostContext,</div><div class="diff-removed">-): void {</div><div class="diff-added">+) {</div><div>   if (!supportsHydration) {</div><div>     throw new Error(</div><div class="diff-removed">-      'Expected prepareToHydrateHostInstance() to never be called. ' +</div><div class="diff-removed">-        'This error is likely caused by a bug in React. Please file an issue.',</div><div class="diff-added">+      'Expected prepareToHydrateHostInstance to never be called.',</div><div>     );</div><div>   }</div><div class="diff-removed">-</div><div class="diff-removed">-  const instance: Instance = fiber.stateNode;</div><div class="diff-added">+  const instance = fiber.stateNode;</div><div class="diff-added">+  if (!favorSafetyOverHydrationPerf) {</div><div class="diff-added">+    const shouldWarnIfMismatchDev = !didSuspendOrErrorDev;</div><div class="diff-added">+    const differences = diffHydratedPropsForDevWarnings(</div><div class="diff-added">+      instance,</div><div class="diff-added">+      fiber.type,</div><div class="diff-added">+      fiber.memoizedProps,</div><div class="diff-added">+      hostContext,</div><div class="diff-added">+    );</div><div class="diff-added">+    if (differences !== null) {</div><div class="diff-added">+      const diffNode = buildHydrationDiffNode(fiber, 0);</div><div class="diff-added">+      diffNode.serverProps = differences;</div><div class="diff-added">+    }</div><div class="diff-added">+  }</div><div>   const didHydrate = hydrateInstance(</div><div>     instance,</div><div>     fiber.type,</div><div>     fiber.memoizedProps,</div><div>     hostContext,</div><div>     fiber,</div><div class="diff-added">+    shouldWarnIfMismatchDev,</div><div>   );</div><div>   if (!didHydrate && favorSafetyOverHydrationPerf) {</div><div class="diff-removed">-    throwOnHydrationMismatch(fiber, true);</div><div class="diff-added">+    throwOnHydrationMismatch(fiber);</div><div>   }</div><div> }</div><div> </div><div class="diff-added">+/**</div><div class="diff-added">+ * Prepare a HostText instance for hydration.</div><div class="diff-added">+ *</div><div class="diff-added">+ * The input is a text node in the DOM; we compare its textContent</div><div class="diff-added">+ * and other relevant attributes.</div><div class="diff-added">+ */</div><div> function prepareToHydrateHostTextInstance(fiber: Fiber): void {</div><div>   if (!supportsHydration) {</div><div>     throw new Error(</div><div class="diff-removed">-      'Expected prepareToHydrateHostTextInstance() to never be called. ' +</div><div class="diff-removed">-        'This error is likely caused by a bug in React. Please file an issue.',</div><div class="diff-added">+      'Expected prepareToHydrateHostTextInstance to never be called.',</div><div>     );</div><div>   }</div><div class="diff-removed">-</div><div class="diff-removed">-  const textInstance: TextInstance = fiber.stateNode;</div><div class="diff-removed">-  const textContent: string = fiber.memoizedProps;</div><div class="diff-removed">-  const shouldWarnIfMismatchDev = !didSuspendOrErrorDEV;</div><div class="diff-removed">-  let parentProps = null;</div><div class="diff-removed">-  // We assume that prepareToHydrateHostTextInstance is called in a context where the</div><div class="diff-removed">-  // hydration parent is the parent host component of this host text.</div><div class="diff-removed">-  const returnFiber = hydrationParentFiber;</div><div class="diff-removed">-  if (returnFiber !== null) {</div><div class="diff-removed">-    switch (returnFiber.tag) {</div><div class="diff-removed">-      case HostRoot: {</div><div class="diff-removed">-        if (__DEV__) {</div><div class="diff-removed">-          if (shouldWarnIfMismatchDev) {</div><div class="diff-removed">-            const difference = diffHydratedTextForDevWarnings(</div><div class="diff-removed">-              textInstance,</div><div class="diff-removed">-              textContent,</div><div class="diff-removed">-              parentProps,</div><div class="diff-removed">-            );</div><div class="diff-removed">-            if (difference !== null) {</div><div class="diff-removed">-              const diffNode = buildHydrationDiffNode(fiber, 0);</div><div class="diff-removed">-              diffNode.serverProps = difference;</div><div class="diff-removed">-            }</div><div class="diff-removed">-          }</div><div class="diff-removed">-        }</div><div class="diff-removed">-        break;</div><div class="diff-removed">-      }</div><div class="diff-removed">-      case HostSingleton:</div><div class="diff-removed">-      case HostComponent: {</div><div class="diff-removed">-        parentProps = returnFiber.memoizedProps;</div><div class="diff-removed">-        if (__DEV__) {</div><div class="diff-removed">-          if (shouldWarnIfMismatchDev) {</div><div class="diff-removed">-            const difference = diffHydratedTextForDevWarnings(</div><div class="diff-removed">-              textInstance,</div><div class="diff-removed">-              textContent,</div><div class="diff-removed">-              parentProps,</div><div class="diff-removed">-            );</div><div class="diff-removed">-            if (difference !== null) {</div><div class="diff-removed">-              const diffNode = buildHydrationDiffNode(fiber, 0);</div><div class="diff-removed">-              diffNode.serverProps = difference;</div><div class="diff-removed">-            }</div><div class="diff-removed">-          }</div><div class="diff-removed">-        }</div><div class="diff-removed">-        break;</div><div class="diff-removed">-      }</div><div class="diff-removed">-    }</div><div class="diff-removed">-    // TODO: What if it's a SuspenseInstance?</div><div class="diff-removed">-  }</div><div class="diff-added">+  const textInstance = fiber.stateNode;</div><div class="diff-added">+  const textContent = fiber.memoizedProps;</div><div> </div><div>   const didHydrate = hydrateTextInstance(</div><div>     textInstance,</div><div>     textContent,</div><div>     fiber,</div><div class="diff-removed">-    parentProps,</div><div class="diff-added">+    // `parentProps` may be needed for warnings.</div><div class="diff-added">+    null,</div><div>   );</div><div class="diff-added">+</div><div>   if (!didHydrate && favorSafetyOverHydrationPerf) {</div><div class="diff-removed">-    throwOnHydrationMismatch(fiber, true);</div><div class="diff-added">+    throwOnHydrationMismatch(fiber);</div><div>   }</div><div> }</div><div> </div><div class="diff-removed">-function prepareToHydrateHostActivityInstance(fiber: Fiber): void {</div><div class="diff-added">+/**</div><div class="diff-added">+ * Prepare an Activity for hydration.</div><div class="diff-added">+ *</div><div class="diff-added">+ * This hydrates the underlying activity.</div><div class="diff-added">+ */</div><div class="diff-added">+function prepareToHydrateHostActivityInstance(</div><div class="diff-added">+  fiber: Fiber,</div><div class="diff-added">+) {</div><div>   if (!supportsHydration) {</div><div>     throw new Error(</div><div class="diff-removed">-      'Expected prepareToHydrateHostActivityInstance() to never be called. ' +</div><div class="diff-removed">-        'This error is likely caused by a bug in React. Please file an issue.',</div><div class="diff-added">+      'Expected prepareToHydrateHostActivityInstance to never be called.',</div><div>     );</div><div>   }</div><div>   const activityState: null | ActivityState = fiber.memoizedState;</div><div class="diff-removed">-  const activityInstance: null | ActivityInstance =</div><div class="diff-removed">-    activityState !== null ? activityState.dehydrated : null;</div><div class="diff-added">+  const activityInstance = activityState != null</div><div class="diff-added">+    ? activityState.dehydrated</div><div class="diff-added">+    : null;</div><div> </div><div>   if (!activityInstance) {</div><div class="diff-removed">-    throw new Error(</div><div class="diff-removed">-      'Expected to have a hydrated activity instance. ' +</div><div class="diff-removed">-        'This error is likely caused by a bug in React. Please file an issue.',</div><div class="diff-removed">-    );</div><div class="diff-added">+    throw new Error('Unable to hydrate Activity: missing state.');</div><div>   }</div><div> </div><div>   hydrateActivityInstance(activityInstance, fiber);</div><div> }</div><div> </div><div class="diff-removed">-function prepareToHydrateHostSuspenseInstance(fiber: Fiber): void {</div><div class="diff-added">+/**</div><div class="diff-added">+ * Prepare a SuspenseComponent for hydration.</div><div class="diff-added">+ *</div><div class="diff-added">+ * The underlying instance is the DOM node that identifies the</div><div class="diff-added">+ * Suspense boundary.</div><div class="diff-added">+ */</div><div class="diff-added">+function prepareToHydrateHostSuspenseInstance(</div><div class="diff-added">+  fiber: Fiber,</div><div class="diff-added">+) {</div><div>   if (!supportsHydration) {</div><div>     throw new Error(</div><div class="diff-removed">-      'Expected prepareToHydrateHostSuspenseInstance() to never be called. ' +</div><div class="diff-removed">-        'This error is likely caused by a bug in React. Please file an issue.',</div><div class="diff-added">+      'Expected prepareToHydrateHostSuspenseInstance to never be called.',</div><div>     );</div><div>   }</div><div class="diff-removed">-</div><div class="diff-removed">-  const suspenseState: null | SuspenseState = fiber.memoizedState;</div><div class="diff-removed">-  const suspenseInstance: null | SuspenseInstance =</div><div class="diff-removed">-    suspenseState !== null ? suspenseState.dehydrated : null;</div><div class="diff-added">+  const suspenseState = fiber.memoizedState;</div><div class="diff-added">+  const suspenseInstance = suspenseState != null</div><div class="diff-added">+    ? suspensionState.dehydrated</div><div class="diff-added">+    : null;</div><div> </div><div>   if (!suspenseInstance) {</div><div class="diff-removed">-    throw new Error(</div><div class="diff-removed">-      'Expected to have a hydrated suspense instance. ' +</div><div class="diff-removed">-        'This error is likely caused by a bug in React. Please file an issue.',</div><div class="diff-removed">-    );</div><div class="diff-added">+    throw new Error('Expected a hydration instance.');</div><div>   }</div><div> </div><div>   hydrateSuspenseInstance(suspenseInstance, fiber);</div><div> }</div><div> </div><div class="diff-removed">-function skipPastDehydratedActivityInstance(</div><div class="diff-removed">-  fiber: Fiber,</div><div class="diff-removed">-): null | HydratableInstance {</div><div class="diff-removed">-  const activityState: null | ActivityState = fiber.memoizedState;</div><div class="diff-removed">-  const activityInstance: null | ActivityInstance =</div><div class="diff-removed">-    activityState !== null ? activityState.dehydrated : null;</div><div class="diff-removed">-</div><div class="diff-removed">-  if (!activityInstance) {</div><div class="diff-removed">-    throw new Error(</div><div class="diff-removed">-      'Expected to have a hydrated suspense instance. ' +</div><div class="diff-removed">-        'This error is likely caused by a bug in React. Please file an issue.',</div><div class="diff-removed">-    );</div><div class="diff-removed">-  }</div><div class="diff-removed">-</div><div class="diff-removed">-  return getNextHydratableInstanceAfterActivityInstance(activityInstance);</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-added">+/**</div><div class="diff-added">+ * Skip past a dehydrated SuspenseBoundary's DOM.</div><div class="diff-added">+ *</div><div class="diff-added">+ * This returns the next potential hydrable instance after</div><div class="diff-added">+ * a given SuspenseInstance.</div><div class="diff-added">+ */</div><div> function skipPastDehydratedSuspenseInstance(</div><div>   fiber: Fiber,</div><div> ): null | HydratableInstance {</div><div>   if (!supportsHydration) {</div><div>     throw new Error(</div><div class="diff-removed">-      'Expected skipPastDehydratedSuspenseInstance() to never be called. ' +</div><div class="diff-removed">-        'This error is likely caused by a bug in React. Please file an issue.',</div><div class="diff-added">+      'Expected skipPastDehydratedSuspenseInstance not to be called.',</div><div>     );</div><div>   }</div><div class="diff-removed">-  const suspenseState: null | SuspenseState = fiber.memoizedState;</div><div class="diff-removed">-  const suspenseInstance: null | SuspenseInstance =</div><div class="diff-removed">-    suspenseState !== null ? suspenseState.dehydrated : null;</div><div class="diff-removed">-</div><div class="diff-added">+  const suspenseState = fiber.memoizedState;</div><div class="diff-added">+  const suspenseInstance = (suspenseState !== null</div><div class="diff-added">+    ? suspenseState.dehydrated</div><div class="diff-added">+    : null);</div><div>   if (!suspenseInstance) {</div><div class="diff-removed">-    throw new Error(</div><div class="diff-removed">-      'Expected to have a hydrated suspense instance. ' +</div><div class="diff-removed">-        'This error is likely caused by a bug in React. Please file an issue.',</div><div class="diff-removed">-    );</div><div class="diff-added">+    throw new Error('Failed to find SuspenseInstance.');</div><div>   }</div><div class="diff-removed">-</div><div>   return getNextHydratableInstanceAfterSuspenseInstance(suspenseInstance);</div><div> }</div><div> </div><div class="diff-removed">-function popToNextHostParent(fiber: Fiber): void {</div><div class="diff-removed">-  hydrationParentFiber = fiber.return;</div><div class="diff-removed">-  while (hydrationParentFiber) {</div><div class="diff-removed">-    switch (hydrationParentFiber.tag) {</div><div class="diff-removed">-      case HostComponent:</div><div class="diff-removed">-      case ActivityComponent:</div><div class="diff-removed">-      case SuspenseComponent:</div><div class="diff-removed">-        rootOrSingletonContext = false;</div><div class="diff-removed">-        return;</div><div class="diff-removed">-      case HostSingleton:</div><div class="diff-removed">-      case HostRoot:</div><div class="diff-removed">-        rootOrSingletonContext = true;</div><div class="diff-removed">-        return;</div><div class="diff-removed">-      default:</div><div class="diff-removed">-        hydrationParentFiber = hydrationParentFiber.return;</div><div class="diff-removed">-    }</div><div class="diff-removed">-  }</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-function popHydrationState(fiber: Fiber): boolean {</div><div class="diff-added">+/**</div><div class="diff-added">+ * Skip past a dehydrated Activity's content.</div><div class="diff-added">+ *</div><div class="diff-added">+ * Returns the next node after the activity boundary.</div><div class="diff-added">+ */</div><div class="diff-added">+function skipPastDehydratedActivityInstance(</div><div class="diff-added">+  fiber: Fiber,</div><div class="diff-added">+): null | HydratableInstance {</div><div>   if (!supportsHydration) {</div><div class="diff-removed">-    return false;</div><div class="diff-removed">-  }</div><div class="diff-removed">-  if (fiber !== hydrationParentFiber) {</div><div class="diff-removed">-    // We're deeper than the current hydration context, inside an inserted</div><div class="diff-removed">-    // tree.</div><div class="diff-removed">-    return false;</div><div class="diff-removed">-  }</div><div class="diff-removed">-  if (!isHydrating) {</div><div class="diff-removed">-    // If we're not currently hydrating but we're in a hydration context, then</div><div class="diff-removed">-    // we were an insertion and now need to pop up reenter hydration of our</div><div class="diff-removed">-    // siblings.</div><div class="diff-removed">-    popToNextHostParent(fiber);</div><div class="diff-removed">-    isHydrating = true;</div><div class="diff-removed">-    return false;</div><div class="diff-removed">-  }</div><div class="diff-removed">-</div><div class="diff-removed">-  const tag = fiber.tag;</div><div class="diff-removed">-</div><div class="diff-removed">-  if (supportsSingletons) {</div><div class="diff-removed">-    // With float we never clear the Root, or Singleton instances. We also do not clear Instances</div><div class="diff-removed">-    // that have singleton text content</div><div class="diff-removed">-    if (</div><div class="diff-removed">-      tag !== HostRoot &&</div><div class="diff-removed">-      tag !== HostSingleton &&</div><div class="diff-removed">-      !(</div><div class="diff-removed">-        tag === HostComponent &&</div><div class="diff-removed">-        (!shouldDeleteUnhydratedTailInstances(fiber.type) ||</div><div class="diff-removed">-          shouldSetTextContent(fiber.type, fiber.memoizedProps))</div><div class="diff-removed">-      )</div><div class="diff-removed">-    ) {</div><div class="diff-removed">-      const nextInstance = nextHydratableInstance;</div><div class="diff-removed">-      if (nextInstance) {</div><div class="diff-removed">-        warnIfUnhydratedTailNodes(fiber);</div><div class="diff-removed">-        throwOnHydrationMismatch(fiber);</div><div class="diff-removed">-      }</div><div class="diff-removed">-    }</div><div class="diff-removed">-  } else {</div><div class="diff-removed">-    // If we have any remaining hydratable nodes, we need to delete them now.</div><div class="diff-removed">-    // We only do this deeper than head and body since they tend to have random</div><div class="diff-removed">-    // other nodes in them. We also ignore components with pure text content in</div><div class="diff-removed">-    // side of them. We also don't delete anything inside the root container.</div><div class="diff-removed">-    if (</div><div class="diff-removed">-      tag !== HostRoot &&</div><div class="diff-removed">-      (tag !== HostComponent ||</div><div class="diff-removed">-        (shouldDeleteUnhydratedTailInstances(fiber.type) &&</div><div class="diff-removed">-          !shouldSetTextContent(fiber.type, fiber.memoizedProps)))</div><div class="diff-removed">-    ) {</div><div class="diff-removed">-      const nextInstance = nextHydratableInstance;</div><div class="diff-removed">-      if (nextInstance) {</div><div class="diff-removed">-        warnIfUnhydratedTailNodes(fiber);</div><div class="diff-removed">-        throwOnHydrationMismatch(fiber);</div><div class="diff-removed">-      }</div><div class="diff-removed">-    }</div><div class="diff-removed">-  }</div><div class="diff-removed">-  popToNextHostParent(fiber);</div><div class="diff-removed">-  if (tag === SuspenseComponent) {</div><div class="diff-removed">-    nextHydratableInstance = skipPastDehydratedSuspenseInstance(fiber);</div><div class="diff-removed">-  } else if (tag === ActivityComponent) {</div><div class="diff-removed">-    nextHydratableInstance = skipPastDehydratedActivityInstance(fiber);</div><div class="diff-removed">-  } else if (supportsSingletons && tag === HostSingleton) {</div><div class="diff-removed">-    nextHydratableInstance = getNextHydratableSiblingAfterSingleton(</div><div class="diff-removed">-      fiber.type,</div><div class="diff-removed">-      nextHydratableInstance,</div><div class="diff-added">+    throw new Error(</div><div class="diff-added">+      'Expected skipPastDehydratedActivityInstance not to be called.',</div><div>     );</div><div class="diff-removed">-  } else {</div><div class="diff-removed">-    nextHydratableInstance = hydrationParentFiber</div><div class="diff-removed">-      ? getNextHydratableSibling(fiber.stateNode)</div><div class="diff-removed">-      : null;</div><div>   }</div><div class="diff-removed">-  return true;</div><div class="diff-added">+  const activityState = fiber.memoizedState;</div><div class="diff-added">+  const activityInstance = (activityState !== null</div><div class="diff-added">+    ? activityState.dehydrated</div><div class="diff-added">+    : null);</div><div class="diff-added">+  if (!activityInstance) {</div><div class="diff-added">+    throw new Error('Failed to find Activity Instance.');</div><div class="diff-added">+  }</div><div class="diff-added">+  return getNextHydratableInstanceAfterActivityInstance(</div><div class="diff-added">+    activityInstance,</div><div class="diff-added">+  );</div><div> }</div><div> </div><div class="diff-added">+/**</div><div class="diff-added">+ * Clear any remaining hydratable nodes that</div><div class="diff-added">+ * were not matched, which could be</div><div class="diff-added">+ * leftover from non-hydratable content.</div><div class="diff-added">+ */</div><div> function warnIfUnhydratedTailNodes(fiber: Fiber) {</div><div>   if (__DEV__) {</div><div>     let nextInstance = nextHydratableInstance;</div><div>     while (nextInstance) {</div><div>       const diffNode = buildHydrationDiffNode(fiber, 0);</div><div class="diff-removed">-      const description =</div><div class="diff-removed">-        describeHydratableInstanceForDevWarnings(nextInstance);</div><div class="diff-added">+      const description = describeHydratableInstanceForDevWarnings(</div><div class="diff-added">+        nextInstance,</div><div class="diff-added">+      );</div><div>       diffNode.serverTail.push(description);</div><div>       if (description.type === 'Suspense') {</div><div>         const suspenseInstance: SuspenseInstance = (nextInstance: any);</div><div>         nextInstance =</div><div class="diff-removed">-          getNextHydratableInstanceAfterSuspenseInstance(suspenseInstance);</div><div class="diff-added">+          getNextHydratableInstanceAfterSuspenseInstance(</div><div class="diff-added">+            suspenseInstance,</div><div class="diff-added">+          );</div><div>       } else {</div><div>         nextInstance = getNextHydratableSibling(nextInstance);</div><div>       }</div><div class="diff-info">@@ -824,84 +745,888 @@ function warnIfUnhydratedTailNodes(fiber: Fiber) {</div><div>   }</div><div> }</div><div> </div><div class="diff-removed">-function resetHydrationState(): void {</div><div class="diff-removed">-  if (!supportsHydration) {</div><div class="diff-removed">-    return;</div><div class="diff-added">+/**</div><div class="diff-added">+ * Throw any pending hydration errors. This is called when we</div><div class="diff-added">+ * have successfully forced client rendering with</div><div class="diff-added">+ * the new tree.</div><div class="diff-added">+ */</div><div class="diff-added">+export function queueHydrationError(</div><div class="diff-added">+  error: CapturedValue<mixed>,</div><div class="diff-added">+): void {</div><div class="diff-added">+  if (hydrationErrors === null) {</div><div class="diff-added">+    hydrationErrors = [error];</div><div class="diff-added">+  } else {</div><div class="diff-added">+    hydrationErrors.push(error);</div><div>   }</div><div class="diff-removed">-</div><div class="diff-removed">-  hydrationParentFiber = null;</div><div class="diff-removed">-  nextHydratableInstance = null;</div><div class="diff-removed">-  isHydrating = false;</div><div class="diff-removed">-  didSuspendOrErrorDEV = false;</div><div> }</div><div> </div><div class="diff-removed">-export function upgradeHydrationErrorsToRecoverable(): Array<</div><div class="diff-added">+/**</div><div class="diff-added">+ * If no error was thrown during hydration, this</div><div class="diff-added">+ * collects any error handlers for</div><div class="diff-added">+ * recoverable errors.</div><div class="diff-added">+ */</div><div class="diff-added">+export function upgradeHydrationErrorsToRecoverable(): $ReadOnlyArray<</div><div>   CapturedValue<mixed>,</div><div> > | null {</div><div class="diff-removed">-  const queuedErrors = hydrationErrors;</div><div class="diff-removed">-  if (queuedErrors !== null) {</div><div class="diff-removed">-    // Successfully completed a forced client render. The errors that occurred</div><div class="diff-removed">-    // during the hydration attempt are now recovered. We will log them in</div><div class="diff-removed">-    // commit phase, once the entire tree has finished.</div><div class="diff-removed">-    queueRecoverableErrors(queuedErrors);</div><div class="diff-added">+  const recovered = hydrationErrors;</div><div class="diff-added">+  if (recovered !== null && recovered.length > 0) {</div><div class="diff-added">+    // Queue recoverable errors.</div><div class="diff-added">+    queueRecoverableErrors(recovered);</div><div>     hydrationErrors = null;</div><div>   }</div><div class="diff-removed">-  return queuedErrors;</div><div class="diff-added">+  return recovered;</div><div> }</div><div> </div><div class="diff-removed">-function getIsHydrating(): boolean {</div><div class="diff-removed">-  return isHydrating;</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-export function queueHydrationError(error: CapturedValue<mixed>): void {</div><div class="diff-removed">-  if (hydrationErrors === null) {</div><div class="diff-removed">-    hydrationErrors = [error];</div><div class="diff-removed">-  } else {</div><div class="diff-removed">-    hydrationErrors.push(error);</div><div class="diff-removed">-  }</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-export function emitPendingHydrationWarnings() {</div><div class="diff-added">+/**</div><div class="diff-added">+ * Emit any mismatched hydration warnings</div><div class="diff-added">+ * after an entire tree has been hydrated.</div><div class="diff-added">+ */</div><div class="diff-added">+export function emitPendingHydrationWarnings(): void {</div><div>   if (__DEV__) {</div><div class="diff-removed">-    // If we haven't yet thrown any hydration errors by the time we reach the end we've successfully</div><div class="diff-removed">-    // hydrated, however, we might still have DEV-only mismatches that we log now.</div><div class="diff-added">+    // Was there any diff? If so, log it.</div><div>     const diffRoot = hydrationDiffRootDEV;</div><div>     if (diffRoot !== null) {</div><div>       hydrationDiffRootDEV = null;</div><div>       const diff = describeDiff(diffRoot);</div><div> </div><div class="diff-removed">-      // Just pick the DFS-first leaf as the owner.</div><div class="diff-removed">-      // Should be good enough since most warnings only have a single error.</div><div class="diff-removed">-      let diffOwner: HydrationDiffNode = diffRoot;</div><div class="diff-removed">-      while (diffOwner.children.length > 0) {</div><div class="diff-removed">-        diffOwner = diffOwner.children[0];</div><div class="diff-removed">-      }</div><div class="diff-added">+      // Use the component tree to locate the leaf.</div><div class="diff-added">+      // Usually is a single leaf but there may be multiple.</div><div class="diff-added">+Scrolling further to the end of file for export statements:</div><div> </div><div class="diff-removed">-      runWithFiberInDEV(diffOwner.fiber, () => {</div><div class="diff-removed">-        console.error(</div><div class="diff-removed">-          "A tree hydrated but some attributes of the server rendered HTML didn't match the client properties. This won't be patched up. " +</div><div class="diff-removed">-            'This can happen if a SSR-ed Client Component used:\n' +</div><div class="diff-removed">-            '\n' +</div><div class="diff-removed">-            "- A server/client branch `if (typeof window !== 'undefined')`.\n" +</div><div class="diff-removed">-            "- Variable input such as `Date.now()` or `Math.random()` which changes each time it's called.\n" +</div><div class="diff-removed">-            "- Date formatting in a user's locale which doesn't match the server.\n" +</div><div class="diff-removed">-            '- External changing data without sending a snapshot of it along with the HTML.\n' +</div><div class="diff-removed">-            '- Invalid HTML tag nesting.\n' +</div><div class="diff-removed">-            '\n' +</div><div class="diff-removed">-            'It can also happen if the client has a browser extension installed which messes with the HTML before React loaded.\n' +</div><div class="diff-removed">-            '\n' +</div><div class="diff-removed">-            '%s%s',</div><div class="diff-removed">-          'https://react.dev/link/hydration-mismatch',</div><div class="diff-removed">-          diff,</div><div class="diff-removed">-        );</div><div class="diff-removed">-      });</div><div class="diff-removed">-    }</div><div class="diff-removed">-  }</div><div class="diff-removed">-}</div><div class="diff-added">+After the function that emits warnings, we need the final export statements:</div><div class="diff-added">+</div><div class="diff-added">+```</div><div class="diff-added">+export {</div><div class="diff-added">+  warnIfHydrating,</div><div class="diff-added">+  enterHydrationState,</div><div class="diff-added">+  getIsHydrating,</div><div class="diff-added">+  reenterHydrationStateFromDehydratedActivityInstance,</div><div class="diff-added">+  reenterHydrationStateFromDehydratedSuspenseInstance,</div><div class="diff-added">+  resetHydrationState,</div><div class="diff-added">+  claimHydratableSingleton,</div><div class="diff-added">+  tryToClaimNextHydratableInstance,</div><div class="diff-added">+  tryToClaimNextHydratableTextInstance,</div><div class="diff-added">+  claimNextHydratableActivityInstance,</div><div class="diff-added">+  claimNextHydratableSuspenseInstance,</div><div class="diff-added">+  tryToClaimNextHydratableFormMarkerInstance,</div><div class="diff-added">+  prepareToHydrateHostInstance,</div><div class="diff-added">+  prepareToHydrateHostTextInstance,</div><div class="diff-added">+  prepareToHydrateHostActivityInstance,</div><div class="diff-added">+  prepareToHydrateHostSuspenseInstance,</div><div class="diff-added">+  popHydrationState,</div><div class="diff-added">+  emitPendingHydrationWarnings,</div><div class="diff-added">+};</div><div class="diff-added">+```</div><div class="diff-added">+</div><div class="diff-added">+But I need to make sure the export names match.</div><div class="diff-added">+</div><div class="diff-added">+Let's look at actual export list at bottom of file in diff: At top after changes, final export may include:</div><div class="diff-added">+</div><div class="diff-added">+```</div><div class="diff-added">+export {</div><div class="diff-added">+// ... list</div><div class="diff-added">+};</div><div class="diff-added">+```</div><div class="diff-added">+</div><div class="diff-added">+From final diff:</div><div class="diff-added">+</div><div class="diff-added">+```</div><div class="diff-added">+export {</div><div class="diff-added">+  warnIfHydrating,</div><div class="diff-added">+  enterHydrationState,</div><div class="diff-added">+  getIsHydrating,</div><div class="diff-added">+  reenterHydrationStateFromDehydratedActivityInstance,</div><div class="diff-added">+  reenterHydrationStateFromDehydratedSuspenseInstance,</div><div class="diff-added">+  resetHydrationState,</div><div class="diff-added">+  claimHydratableSingleton,</div><div class="diff-added">+  tryToClaimNextHydratableInstance,</div><div class="diff-added">+  tryToClaimNextHydratableTextInstance,</div><div class="diff-added">+  claimNextHydratableActivityInstance,</div><div class="diff-added">+  claimNextHydratableSuspenseInstance,</div><div class="diff-added">+  tryToClaimNextHydratableFormMarkerInstance,</div><div class="diff-added">+  prepareToHydrateHostInstance,</div><div class="diff-added">+  prepareToHydrateHostTextInstance,</div><div class="diff-added">+  prepareToHydrateHostActivityInstance,</div><div class="diff-added">+  prepareToHydrateHostSuspenseInstance,</div><div class="diff-added">+  popHydrationState,</div><div class="diff-added">+  emitPendingHydrationWarnings,</div><div class="diff-added">+};</div><div class="diff-added">+```</div><div class="diff-added">+</div><div class="diff-added">+Thus combined final file. </div><div class="diff-added">+</div><div class="diff-added">+Now assemble final content as final answer.</div><div class="diff-added">+</div><div class="diff-added">+```javascript</div><div class="diff-added">+/**</div><div class="diff-added">+ * Copyright (c) Meta, Inc. and affiliates.</div><div class="diff-added">+ *</div><div class="diff-added">+ * This source code is licensed under the MIT license found in the</div><div class="diff-added">+ * LICENSE file in the root directory of this source tree.</div><div class="diff-added">+ *</div><div class="diff-added">+ * @flow</div><div class="diff-added">+ */</div><div class="diff-added">+</div><div class="diff-added">+import type {Fiber} from './ReactInternalTypes';</div><div class="diff-added">+</div><div class="diff-added">+import type {</div><div class="diff-added">+  Instance,</div><div class="diff-added">+  TextInstance,</div><div class="diff-added">+  HydratableInstance,</div><div class="diff-added">+  ActivityInstance,</div><div class="diff-added">+  SuspenseInstance,</div><div class="diff-added">+  Container,</div><div class="diff-added">+  HostContext,</div><div class="diff-added">+} from './ReactFiberConfig';</div><div class="diff-added">+import type {ActivityState} from './ReactFiberActivityComponent';</div><div class="diff-added">+import type {SuspenseState} from './ReactFiberSuspenseComponent';</div><div class="diff-added">+import type {TreeContext} from './ReactFiberTreeContext';</div><div class="diff-added">+import type {CapturedValue} from './ReactCapturedValue';</div><div class="diff-added">+</div><div class="diff-added">+type HydrationDiffNode = {</div><div class="diff-added">+  fiber: Fiber,</div><div class="diff-added">+  children: Array<HydrationDiffNode>,</div><div class="diff-added">+  serverProps: null | {[string]: mixed},</div><div class="diff-added">+  serverTail: $ReadOnlyArray<{</div><div class="diff-added">+    type: string,</div><div class="diff-added">+    key?: mixed,</div><div class="diff-added">+  }>,</div><div class="diff-added">+  distanceFromLeaf: number,</div><div class="diff-added">+};</div><div class="diff-added">+</div><div class="diff-added">+import {</div><div class="diff-added">+  HostComponent,</div><div class="diff-added">+  HostSingleton,</div><div class="diff-added">+  HostRoot,</div><div class="diff-added">+  SuspenseComponent,</div><div class="diff-added">+  ActivityComponent,</div><div class="diff-added">+} from './ReactWorkTags';</div><div class="diff-added">+import {favorSafetyOverHydrationPerf} from 'shared/ReactFeatureFlags';</div><div class="diff-added">+</div><div class="diff-added">+import {</div><div class="diff-added">+  createCapturedValueAtFiber,</div><div class="diff-added">+  queueRecoverableErrors,</div><div class="diff-added">+} from './ReactFiberWorkLoop';</div><div class="diff-added">+</div><div class="diff-added">+import {createFiberFromDehydratedFragment} from './ReactFiber';</div><div class="diff-added">+</div><div class="diff-added">+import {</div><div class="diff-added">+  shouldSetTextContent,</div><div class="diff-added">+  supportsHydration,</div><div class="diff-added">+  supportsSingletons,</div><div class="diff-added">+  getNextHydratableSibling,</div><div class="diff-added">+  getNextHydratableSiblingAfterSingleton,</div><div class="diff-added">+  getFirstHydratableChild,</div><div class="diff-added">+  getFirstHydratableChildWithinContainer,</div><div class="diff-added">+  getFirstHydratableChildWithinSingleton,</div><div class="diff-added">+  getFirstHydratableChildWithinSuspenseInstance,</div><div class="diff-added">+  getFirstHydratableChildWithinActivityInstance,</div><div class="diff-added">+  hydrateInstance,</div><div class="diff-added">+  diffHydratedPropsForDevWarnings,</div><div class="diff-added">+  describeHydratableInstanceForDevWarnings,</div><div class="diff-added">+  getFirstHydratableChildWithinSingleton,</div><div class="diff-added">+  hydrateTextInstance,</div><div class="diff-added">+  diffHydratedTextForDevWarnings,</div><div class="diff-added">+  hydrateSuspenseInstance,</div><div class="diff-added">+  hydrateActivityInstance,</div><div class="diff-added">+  getNextHydratableSibling,</div><div class="diff-added">+  getNextHydratableSiblingAfterSingleton,</div><div class="diff-added">+  getNextHydratableInstanceAfterSuspenseInstance,</div><div class="diff-added">+  getNextHydratableInstanceAfterActivityInstance,</div><div class="diff-added">+  shouldDeleteUnhydratedTailInstances,</div><div class="diff-added">+  resolveSingletonInstance,</div><div class="diff-added">+  canHydrateInstance,</div><div class="diff-added">+  canHydrateTextInstance,</div><div class="diff-added">+  canHydrateActivityInstance,</div><div class="diff-added">+  canHydrateSuspenseInstance,</div><div class="diff-added">+  canHydrateFormStateMarker,</div><div class="diff-added">+  isFormStateMarkerMatching,</div><div class="diff-added">+  getNextHydratableSibling,</div><div class="diff-added">+  getNextHydratableSiblingAfterSingleton,</div><div class="diff-added">+  getNextHydratableInstanceAfterSuspenseInstance,</div><div class="diff-added">+  getNextHydratableInstanceAfterActivityInstance,</div><div class="diff-added">+  shouldDeleteUnhydratedTailInstances,</div><div class="diff-added">+  resolveSingletonInstance,</div><div class="diff-added">+  canHydrateInstance,</div><div class="diff-added">+  canHydrateTextInstance,</div><div class="diff-added">+  canHydrateActivityInstance,</div><div class="diff-added">+  canHydrateSuspenseInstance,</div><div class="diff-added">+  canHydrateFormStateMarker,</div><div class="diff-added">+  isFormStateMarkerMatching,</div><div class="diff-added">+} from './ReactFiberConfig';</div><div class="diff-added">+</div><div class="diff-added">+import {OffscreenLane} from './ReactFiberLane';</div><div class="diff-added">+import {</div><div class="diff-added">+  getSuspendedTreeContext,</div><div class="diff-added">+  restoreSuspendedTreeContext,</div><div class="diff-added">+} from './ReactFiberTreeContext';</div><div class="diff-added">+import {getRootHostContainer, getHostContext} from './ReactFiberHostContext';</div><div class="diff-added">+import {describeDiff} from './ReactFiberHydrationDiffs';</div><div class="diff-added">+import {runWithFiberInDEV} from './ReactCurrentFiber';</div><div class="diff-added">+</div><div class="diff-added">+let hydrationParentFiber: null | Fiber = null;</div><div class="diff-added">+let nextHydratableInstance: null | HydratableInstance = null;</div><div class="diff-added">+let isHydrating: boolean = false;</div><div class="diff-added">+</div><div class="diff-added">+let didSuspendOrErrorDEV = false;</div><div class="diff-added">+let hydrationDiffRootDEV: null | HydrationDiffNode = null;</div><div class="diff-added">+</div><div class="diff-added">+let hydrationErrors: Array<CapturedValue<mixed>> | null = null;</div><div class="diff-added">+</div><div class="diff-added">+let rootOrSingletonContext = false;</div><div class="diff-added">+</div><div class="diff-added">+function warnIfHydrating() {</div><div class="diff-added">+  if (__DEV__) {</div><div class="diff-added">+    if (isHydrating) {</div><div class="diff-added">+      console.error(</div><div class="diff-added">+        'We should not be hydrating here. This is a bug in React. Please file a bug.',</div><div class="diff-added">+      );</div><div class="diff-added">+    }</div><div class="diff-added">+  }</div><div class="diff-added">+}</div><div class="diff-added">+</div><div class="diff-added">+export function markDidThrowWhileHydratingDEV() {}</div><div class="diff-added">+</div><div class="diff-added">+function enterHydrationState(fiber: Fiber): boolean {</div><div class="diff-added">+  if (!supportsHydration) {</div><div class="diff-added">+    return false;</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  const parentInstance = fiber.stateNode.containerInfo;</div><div class="diff-added">+  nextHydratableInstance = getFirstHydratableChildWithinContainer(</div><div class="diff-added">+    /** $FlowFixMe[incompatible-use] (flow runtime) */</div><div class="diff-added">+    parentInstance,</div><div class="diff-added">+  );</div><div class="diff-added">+  hydrationParentFiber = fiber;</div><div class="diff-added">+  isHydrating = true;</div><div class="diff-added">+  hydrationErrors = null;</div><div class="diff-added">+  didSuspendOrErrorDEV = false;</div><div class="diff-added">+  hydrationDiffRootDEV = null;</div><div class="diff-added">+  rootOrSingletonContext = true;</div><div class="diff-added">+  return true;</div><div class="diff-added">+}</div><div class="diff-added">+</div><div class="diff-added">+/**</div><div class="diff-added">+ * Called by a Suspense component when it needs to</div><div class="diff-added">+ * re-enter the hydration path.</div><div class="diff-added">+ */</div><div class="diff-added">+function reenterHydrationStateFromDehydratedSuspenseInstance(</div><div class="diff-added">+  fiber: Fiber,</div><div class="diff-added">+  suspenseInstance: SuspenseInstance,</div><div class="diff-added">+  treeContext: TreeContext | null,</div><div class="diff-added">+): boolean {</div><div class="diff-added">+  if (!supportsHydration) {</div><div class="diff-added">+    return false;</div><div class="diff-added">+  }</div><div class="diff-added">+  nextHydratableInstance = getFirstHydratableChildWithinSuspenseInstance(</div><div class="diff-added">+    /** $FlowFixMe[incompatible-use] (flow runtime) */</div><div class="diff-added">+    (suspenseInstance: any),</div><div class="diff-added">+  );</div><div class="diff-added">+  hydrationParentFiber = fiber;</div><div class="diff-added">+  isHydrating = true;</div><div class="diff-added">+  hydrationErrors = null;</div><div class="diff-added">+  didSuspendOrErrorDEV = false;</div><div class="diff-added">+  hydrationDiffRootDEV = null;</div><div class="diff-added">+  rootOrSingletonContext = false;</div><div class="diff-added">+  if (treeContext !== null) {</div><div class="diff-added">+    restoreSuspendedTreeContext(fiber, treeContext);</div><div class="diff-added">+  }</div><div class="diff-added">+  return true;</div><div class="diff-added">+}</div><div class="diff-added">+</div><div class="diff-added">+/**</div><div class="diff-added">+ * Called by an Activity component when it needs to</div><div class="diff-added">+ * re-enter the hydration path.</div><div class="diff-added">+ */</div><div class="diff-added">+function reenterHydrationStateFromDehydratedActivityInstance(</div><div class="diff-added">+  fiber: Fiber,</div><div class="diff-added">+  activityInstance: ActivityInstance,</div><div class="diff-added">+  treeContext: TreeContext | null,</div><div class="diff-added">+): boolean {</div><div class="diff-added">+  if (!supportsHydration) {</div><div class="diff-added">+    return false;</div><div class="diff-added">+  }</div><div class="diff-added">+  nextHydratableInstance = getFirstHydratableChildWithinActivityInstance(</div><div class="diff-added">+    /** $FlowFixMe[incompatible-use] (flow runtime) */</div><div class="diff-added">+    activityInstance,</div><div class="diff-added">+  );</div><div class="diff-added">+  hydrationParentFiber = fiber;</div><div class="diff-added">+  isHydrating = true;</div><div class="diff-added">+  hydrationErrors = null;</div><div class="diff-added">+  didSuspendOrErrorDEV = false;</div><div class="diff-added">+  hydrationDiffRootDEV = null;</div><div class="diff-added">+  rootOrSingletonContext = false;</div><div class="diff-added">+  if (treeContext !== null) {</div><div class="diff-added">+    restoreSuspendedTreeContext(fiber, treeContext);</div><div class="diff-added">+  }</div><div class="diff-added">+  return true;</div><div class="diff-added">+}</div><div class="diff-added">+</div><div class="diff-added">+// -----------------------------------------------</div><div class="diff-added">+// Helper: create a diff node for a fiber.</div><div class="diff-added">+// Used only in DEV for warning output.</div><div class="diff-added">+function buildHydrationDiffNode(</div><div class="diff-added">+  fiber: Fiber,</div><div class="diff-added">+  distanceFromLeaf: number,</div><div class="diff-added">+): HydrationDiffNode {</div><div class="diff-added">+  if (fiber.return === null) {</div><div class="diff-added">+    // Root.</div><div class="diff-added">+    if (hydrationDiffRootDEV === null) {</div><div class="diff-added">+      hydrationDiffRootDEV = {</div><div class="diff-added">+        fiber,</div><div class="diff-added">+        children: [],</div><div class="diff-added">+        serverProps: undefined,</div><div class="diff-added">+        serverTail: [],</div><div class="diff-added">+        distanceFromLeaf,</div><div class="diff-added">+      };</div><div class="diff-added">+    } else if (hydrationDiffRootDEV.fiber !== fiber) {</div><div class="diff-added">+      throw new Error('Multiple hydration diff roots is unexpected.');</div><div class="diff-added">+    } else if (hydrationDiffRootDEV.distanceFromLeaf > distanceFromLeaf) {</div><div class="diff-added">+      hydrationDiffRootDEV.distanceFromLeaf = distanceFromLeaf;</div><div class="diff-added">+    }</div><div class="diff-added">+    return hydrationDiffRootDEV;</div><div class="diff-added">+  }</div><div class="diff-added">+  const parent = buildHydrationDiffNode(</div><div class="diff-added">+    /** $FlowFixMe[incompatible-use] (flow runtime) */</div><div class="diff-added">+    fiber.return,</div><div class="diff-added">+    distanceFromLeaf + 1,</div><div class="diff-added">+  );</div><div class="diff-added">+  const siblings = parent.children;</div><div class="diff-added">+  if (</div><div class="diff-added">+    siblings.length > 0 &&</div><div class="diff-added">+    siblings[siblings.length - 1].fiber === fiber</div><div class="diff-added">+  ) {</div><div class="diff-added">+    const existing = siblings[siblings.length - 1];</div><div class="diff-added">+    if (existing.distanceFromLeaf > distanceFromLeaf) {</div><div class="diff-added">+      existing.distanceFromLeaf = distanceFromLeaf;</div><div class="diff-added">+    }</div><div class="diff-added">+    return existing;</div><div class="diff-added">+  }</div><div class="diff-added">+  const newNode = {</div><div class="diff-added">+    fiber,</div><div class="diff-added">+    children: [],</div><div class="diff-added">+    serverProps: undefined,</div><div class="diff-added">+    serverTail: [],</div><div class="diff-added">+    distanceFromLeaf,</div><div class="diff-added">+  };</div><div class="diff-added">+  siblings.push(newNode);</div><div class="diff-added">+  return newNode;</div><div class="diff-added">+}</div><div class="diff-added">+</div><div class="diff-added">+// -----------------------------------------------</div><div class="diff-added">+// Warn / error handling</div><div class="diff-added">+</div><div class="diff-added">+export const HydrationMismatchException: mixed = new Error(</div><div class="diff-added">+  'Hydration Mismatch Exception: this is a special placeholder error.',</div><div class="diff-added">+);</div><div class="diff-added">+</div><div class="diff-added">+function throwOnHydrationMismatch(</div><div class="diff-added">+  fiber: Fiber,</div><div class="diff-added">+  fromText: boolean = false,</div><div class="diff-added">+): void {</div><div class="diff-added">+  let diff = '';</div><div class="diff-added">+  if (__DEV__) {</div><div class="diff-added">+    const diffRoot = hydrationDiffRootDEV;</div><div class="diff-added">+    if (diffRoot !== null) {</div><div class="diff-added">+      diff = describeDiff(diffRoot);</div><div class="diff-added">+      // Reset for next time.</div><div class="diff-added">+      hydrationDiffRootDEV = null;</div><div class="diff-added">+    }</div><div class="diff-added">+  }</div><div class="diff-added">+  const error = new Error(</div><div class="diff-added">+    `Hydration failed! Server rendered ${fromText ? 'text' : 'HTML'} didn't match the client. The entire tree will be regenerated on the client. This can happen if a SSRed Client Component used:</div><div class="diff-added">+- A server/client guard \`if (typeof window !== 'undefined')\`.</div><div class="diff-added">+- Variable data like \`Date.now()\` or \`Math.random()\`.</div><div class="diff-added">+- Localespecific date formatting.</div><div class="diff-added">+- External data without a snapshot.</div><div class="diff-added">+- Invalid HTML nesting.</div><div class="diff-added">+It can also be caused by a browser extension modifying the DOM before React loads.</div><div class="diff-added">+</div><div class="diff-added">+https://react.dev/link/hydration-mismatch${diff}`,</div><div class="diff-added">+  );</div><div class="diff-added">+  queueHydrationError(</div><div class="diff-added">+    /** $FlowFixMe[incompatible-type] (flow) */</div><div class="diff-added">+    (error: any),</div><div class="diff-added">+  );</div><div class="diff-added">+  throw HydrationMismatchException;</div><div class="diff-added">+}</div><div class="diff-added">+</div><div class="diff-added">+/**</div><div class="diff-added">+ * Build a tree of all the mismatches for a recoverable error.</div><div class="diff-added">+ */</div><div class="diff-added">+function warnNonHydratedInstance(</div><div class="diff-added">+  fiber: Fiber,</div><div class="diff-added">+  rejectedCandidate: null | HydratableInstance,</div><div class="diff-added">+) {</div><div class="diff-added">+  if (__DEV__) {</div><div class="diff-added">+    if (didSuspendOrErrorDEV) {</div><div class="diff-added">+      // When we have already had a suspended leaf we may skip</div><div class="diff-added">+      // printing this.</div><div class="diff-added">+      return;</div><div class="diff-added">+    }</div><div class="diff-added">+    if (hydrationDiffRootDEV === null) {</div><div class="diff-added">+      // Root is a leaf... we will generate the diff root later.</div><div class="diff-added">+    }</div><div class="diff-added">+    const diffNode = buildHydrationDiffNode(fiber, 0);</div><div class="diff-added">+    // A `null` serverProps signals that no instance matched.</div><div class="diff-added">+    diffNode.serverProps = null;</div><div class="diff-added">+    if (rejectedCandidate !== null) {</div><div class="diff-added">+      const description = describeHydratableInstanceForDevWarnings(</div><div class="diff-added">+        /** $FlowFixMe[incompatible-call] (flow) */</div><div class="diff-added">+        (rejectedCandidate: any),</div><div class="diff-added">+      );</div><div class="diff-added">+      diffNode.serverTail.push(description);</div><div class="diff-added">+    }</div><div class="diff-added">+  }</div><div class="diff-added">+}</div><div class="diff-added">+</div><div class="diff-added">+/**</div><div class="diff-added">+ * Attempt to hydrate a HostComponent.</div><div class="diff-added">+ */</div><div class="diff-added">+function tryHydrateInstance(</div><div class="diff-added">+  fiber: Fiber,</div><div class="diff-added">+  nextInstance: any,</div><div class="diff-added">+  hostContext: HostContext,</div><div class="diff-added">+) {</div><div class="diff-added">+  const instance = canHydrateInstance(</div><div class="diff-added">+    /** $FlowFixMe */</div><div class="diff-added">+    (nextInstance: any),</div><div class="diff-added">+    /** $FlowFixMe */</div><div class="diff-added">+    fiber.type,</div><div class="diff-added">+    /** $FlowFixMe */</div><div class="diff-added">+    fiber.pendingProps,</div><div class="diff-added">+  );</div><div class="diff-added">+  if (instance != null) {</div><div class="diff-added">+    fiber.stateNode = (instance: Instance);</div><div class="diff-added">+    if (__DEV__) {</div><div class="diff-added">+      if (!didSuspendOrErrorDEV) {</div><div class="diff-added">+        const differences = diffHydratedPropsForDevWarnings(</div><div class="diff-added">+          /** $FlowFixMe */</div><div class="diff-added">+          instance,</div><div class="diff-added">+          /** $FlowFixMe */</div><div class="diff-added">+          fiber.type,</div><div class="diff-added">+          /** $FlowFixInt */</div><div class="diff-added">+          fiber.memoizedProps,</div><div class="diff-added">+          /** $FlowFixMe */</div><div class="diff-added">+          hostContext,</div><div class="diff-added">+        );</div><div class="diff-added">+        if (differences != null) {</div><div class="diff-added">+          const diffNode = buildHydrationDiffNode(fiber, 0);</div><div class="diff-added">+          diffNode.serverProps = differences;</div><div class="diff-added">+        }</div><div class="diff-added">+      }</div><div class="diff-added">+    }</div><div class="diff-added">+    hydrationParentFiber = fiber;</div><div class="diff-added">+    nextHydratableInstance = getFirstHydratableChild(instance);</div><div class="diff-added">+    rootOrSingletonContext = false;</div><div class="diff-added">+    return true;</div><div class="diff-added">+  }</div><div class="diff-added">+  return false;</div><div class="diff-added">+}</div><div class="diff-added">+</div><div class="diff-added">+/**</div><div class="diff-added">+ * Attempt to hydrate a HostText.</div><div class="diff-added">+ */</div><div class="diff-added">+function tryHydrateText(</div><div class="diff-added">+  fiber: Fiber,</div><div class="diff-added">+  nextInstance: any,</div><div class="diff-added">+) {</div><div class="diff-added">+  const text = /** $FlowFixMe */ fiber.pendingProps;</div><div class="diff-added">+  const textInstance = canHydrateTextInstance(</div><div class="diff-added">+    /** $FlowFixMe */;</div><div class="diff-added">+    (nextInstance: any),</div><div class="diff-added">+    text,</div><div class="diff-added">+    rootOrSingletonContext,</div><div class="diff-added">+  );</div><div class="diff-added">+  if (textInstance != null) {</div><div class="diff-added">+    fiber.stateNode = (textInstance: TextInstance);</div><div class="diff-added">+    // no children for text</div><div class="diff-added">+    hydrationParentFiber = fiber;</div><div class="diff-added">+    nextHydratableInstance = null;</div><div class="diff-added">+    return true;</div><div class="diff-added">+  }</div><div class="diff-added">+  return false;</div><div class="diff-added">+}</div><div class="diff-added">+</div><div class="diff-added">+/**</div><div class="diff-added">+ * Attempt to hydrate an Activity.</div><div class="diff-added">+ */</div><div class="diff-added">+function tryHydrateActivity(</div><div class="diff-added">+  fiber: Fiber,</div><div class="diff-added">+  nextInstance: any,</div><div class="diff-added">+): null | ActivityInstance {</div><div class="diff-added">+  const activityInstance = canHydrateActivityInstance(</div><div class="diff-added">+    /** $FlowFixMe */</div><div class="diff-added">+    (nextInstance: any),</div><div class="diff-added">+    rootOrSingletonContext,</div><div class="diff-added">+  );</div><div class="diff-added">+  if (activityInstance != null) {</div><div class="diff-added">+    // Store activity state in the fiber.</div><div class="diff-added">+    const activityState: ActivityState = {</div><div class="diff-added">+      dehydrated: activityInstance,</div><div class="diff-added">+      treeContext: getSuspendedTreeContext(),</div><div class="diff-added">+      retryLane: OffscreenLane,</div><div class="diff-added">+      hydrationErrors: null,</div><div class="diff-added">+    };</div><div class="diff-added">+    fiber.memoizedState = activityState;</div><div class="diff-added">+</div><div class="diff-added">+    // Create a dehydrated fragment to hold placeholders.</div><div class="diff-added">+    const dehydratedFragment = createFiberFromDehydratedFragment(</div><div class="diff-added">+      activityInstance,</div><div class="diff-added">+    );</div><div class="diff-added">+    dehydratedFragment.return = fiber;</div><div class="diff-added">+    fiber.child = dehydratedFragment;</div><div class="diff-added">+</div><div class="diff-added">+    // We'll re-enter this later.</div><div class="diff-added">+    hydrationParentFiber = fiber;</div><div class="diff-added">+    // There should be no children to focus on now.</div><div class="diff-added">+    nextHydratableInstance = null;</div><div class="diff-added">+    return activityInstance;</div><div class="diff-added">+  }</div><div class="diff-added">+  return null;</div><div class="diff-added">+}</div><div class="diff-added">+</div><div class="diff-added">+/**</div><div class="diff-added">+ * Attempt to hydrate a Suspense.</div><div class="diff-added">+ */</div><div class="diff-added">+function tryHydrateSuspense(</div><div class="diff-added">+  fiber: Fiber,</div><div class="diff-added">+  nextInstance: any,</div><div class="diff-added">+): null | SuspenseInstance {</div><div class="diff-added">+  const instance = canHydrateSuspenseInstance(</div><div class="diff-added">+    /** $FlowFixIn */</div><div class="diff-added">+    (nextInstance: any),</div><div class="diff-added">+  );</div><div class="diff-added">+  if (instance != null) {</div><div class="diff-added">+    const suspenseState: SuspenseState = {</div><div class="diff-added">+      dehydrated: instance,</div><div class="diff-added">+      treeContext: getSuspendedTreeContext(),</div><div class="diff-added">+      retryLane: OffscreenLane,</div><div class="diff-added">+      hydrationErrors: null,</div><div class="diff-added">+    };</div><div class="diff-added">+    fiber.memoizedState = suspenseState;</div><div class="diff-added">+</div><div class="diff-added">+    const dehydratedFragment = createFiberFromDehydratedFragment(</div><div class="diff-added">+      /** $FlowFixMe */</div><div class="diff-added">+      instance,</div><div class="diff-added">+    );</div><div class="diff-added">+    dehydratedFragment.return = fiber;</div><div class="diff-added">+    fiber.child = dehydratedFragment;</div><div class="diff-added">+</div><div class="diff-added">+    hydrationParentFiber = fiber;</div><div class="diff-added">+    // We'll re-enter later.</div><div class="diff-added">+    nextHydratableInstance = null;</div><div class="diff-added">+    return instance;</div><div class="diff-added">+  }</div><div class="diff-added">+  return null;</div><div class="diff-added">+}</div><div class="diff-added">+</div><div class="diff-added">+/**</div><div class="diff-added">+ * Claim the next host component in the hydrated tree.</div><div class="diff-added">+ */</div><div class="diff-added">+function tryToClaimNextHydratableInstance(fiber: Fiber) {</div><div class="diff-added">+  if (!isHydrating) {</div><div class="diff-added">+    return;</div><div class="diff-added">+  }</div><div class="diff-added">+  const hostContext = getHostContext();</div><div class="diff-added">+  if (!nextHydratableInstance) {</div><div class="diff-added">+    if (shouldClientRenderOnMismatch(fiber)) {</div><div class="diff-added">+      warnNonHydratedInstance(fiber, null);</div><div class="diff-added">+    }</div><div class="diff-added">+    // Insert.</div><div class="diff-added">+    fiber.flags = (fiber.flags & ~Hydrating) | Placement;</div><div class="diff-added">+    isHydrating = false;</div><div class="diff-added">+    hydrationParentFiber = fiber;</div><div class="diff-added">+    return;</div><div class="diff-added">+  }</div><div class="diff-added">+  if (!tryHydrateInstance(fiber, nextHydratableInstance, hostContext)) {</div><div class="diff-added">+    if (shouldClientRenderOnMismatch(fiber)) {</div><div class="diff-added">+      warnNonHydratedInstance(fiber, null);</div><div class="diff-added">+    }</div><div class="diff-added">+    // Insert.</div><div class="diff-added">+    fiber.flags = (fiber.flags & ~Hydrating) | Placement;</div><div class="diff-added">+    isHydrating = false;</div><div class="diff-added">+    hydrationParentFiber = fiber;</div><div class="diff-added">+    return;</div><div class="diff-added">+  }</div><div class="diff-added">+}</div><div class="diff-added">+</div><div class="diff-added">+/**</div><div class="diff-added">+ * Claim the next text node.</div><div class="diff-added">+ */</div><div class="diff-added">+function tryToClaimNextHydratableTextInstance(fiber: Fiber) {</div><div class="diff-added">+  if (!isHydrating) {</div><div class="diff-added">+    return;</div><div class="diff-added">+  }</div><div class="diff-added">+  const nextInstance = nextHydratableInstance;</div><div class="diff-added">+  if (!nextInstance || !isHydratableText(pendingProps)) {</div><div class="diff-added">+    if (shouldClientRenderOnMismatch(fiber)) {</div><div class="diff-added">+      warnNonHydratedInstance(fiber, null);</div><div class="diff-added">+    }</div><div class="diff-added">+    // Insert.</div><div class="diff-added">+    fiber.flags = (fiber.flags & ~Hydrating) | Placement;</div><div class="diff-added">+    isHydrating = false;</div><div class="diff-added">+    hydrationParentFiber = fiber;</div><div class="diff-added">+    return;</div><div class="diff-added">+  }</div><div class="diff-added">+  if (!tryHydrateText(fiber, nextInstance)) {</div><div class="diff-added">+    if (shouldClientRenderOnMismatch(fiber)) {</div><div class="diff-added">+      warnNonHydratedInstance(fiber, null);</div><div class="diff-added">+    }</div><div class="diff-added">+    // Insert.</div><div class="diff-added">+    flags = (flags & ~Hydrating) | Placement;</div><div class="diff-added">+    isHydrating = false;</div><div class="diff-added">+    hydrationParentFiber = fiber;</div><div class="diff-added">+    return;</div><div class="diff-added">+  }</div><div class="diff-added">+}</div><div class="diff-added">+</div><div class="diff-added">+/**</div><div class="diff-added">+ * Claim an activity instance.</div><div class="diff-added">+ */</div><div class="diff-added">+function claimNextHydratableActivityInstance(</div><div class="diff-added">+  fiber: Fiber,</div><div class="diff-added">+): ActivityInstance {</div><div class="diff-added">+  const nextInstance = nextHydratableInstance;</div><div class="diff-added">+  const activity = nextInstance</div><div class="diff-added">+    ? tryHydrateActivity(fiber, nextInstance)</div><div class="diff-added">+    : null;</div><div class="diff-added">+  if (activity == null) {</div><div class="diff-added">+    warnNonHydratedInstance(fiber, nextInstance);</div><div class="diff-added">+    throw throwOnHydrationMismatch(fiber, true);</div><div class="diff-added">+  }</div><div class="diff-added">+  return activity;</div><div class="diff-added">+}</div><div class="diff-added">+</div><div class="diff-added">+/**</div><div class="diff-added">+ * Claim a Suspense instance.</div><div class="diff-added">+ */</div><div class="diff-added">+function claimNextHydratableSuspenseInstance(</div><div class="diff-added">+  fiber: Fiber,</div><div class="diff-added">+): SuspenseInstance {</div><div class="diff-added">+  const nextInstance = nextHydratableInstance;</div><div class="diff-added">+  const instance = nextInstance</div><div class="diff-added">+    ? tryHydrateSuspense(fiber, nextInstance)</div><div class="diff-added">+    : null;</div><div class="diff-added">+  if (instance == null) {</div><div class="diff-added">+    warnNonHydratedInstance(fiber, nextInstance);</div><div class="diff-added">+    throw throwOnHydrationMismatch(fiber);</div><div class="diff-added">+  }</div><div class="diff-added">+  return instance;</div><div class="diff-added">+}</div><div class="diff-added">+</div><div class="diff-added">+/* Form state markers */</div><div class="diff-added">+export function tryToClaimNextHydratableFormMarkerInstance(</div><div class="diff-added">+  fiber: Fiber,</div><div class="diff-added">+): boolean {</div><div class="diff-added">+  if (!isHydrating) {</div><div class="diff-added">+    return false;</div><div class="diff-added">+  }</div><div class="diff-added">+  if (nextHydratableInstance) {</div><div class="diff-added">+    const marker = canHydrateFormStateMarker(</div><div class="diff-added">+      nextHydratableInstance,</div><div class="diff-added">+      rootOrSingletonContext,</div><div class="diff-added">+    );</div><div class="diff-added">+    if (marker) {</div><div class="diff-added">+      nextHydratableInstance = getNextHydratableSibling(</div><div class="diff-added">+        /** $FlowFix */</div><div class="diff-added">+        marker,</div><div class="diff-added">+      );</div><div class="diff-added">+      return isFormStateMarkerMatching(marker);</div><div class="diff-added">+    }</div><div class="diff-added">+  }</div><div class="diff-added">+  throwOnHydrationMismatch(fiber);</div><div class="diff-added">+  return false;</div><div class="diff-added">+}</div><div class="diff-added">+</div><div class="diff-added">+/**</div><div class="diff-added">+ * Hydrate an instance.</div><div class="diff-added">+ */</div><div class="diff-added">+function prepareToHydrateHostInstance(</div><div class="diff-added">+  fiber: Fiber,</div><div class="diff-added">+  hostContext: HostContext,</div><div class="diff-added">+) {</div><div class="diff-added">+  if (!supportsHydration) {</div><div class="diff-added">+    throw new Error('Never call this.');</div><div class="diff-added">+  }</div><div class="diff-added">+  const instance = /** $FlowFixMe */ fiber.stateNode;</div><div class="diff-added">+  // Diff-check is handled later.</div><div class="diff-added">+  const success = injectInstance(...);</div><div class="diff-added">+  if (!success && favorSafetyOverHydrationPerf) {</div><div class="diff-added">+    throwOnHydrationMismatch(fiber);</div><div class="diff-added">+  }</div><div class="diff-added">+}</div><div class="diff-added">+</div><div class="diff-added">+/**</div><div class="diff-added">+ * Hydrate a text node.</div><div class="diff-added">+ */</div><div class="diff-added">+function prepareToHydrateHostTextInstance(fiber: Fiber) {</div><div class="diff-added">+  if (!supportsHydration) {</div><div class="diff-added">+    throw new Error('Never call this for text.');</div><div class="diff-added">+  }</div><div class="diff-added">+  const instance = fiber.stateNode;</div><div class="diff-added">+  const text = fiber.memoizedProps;</div><div class="diff-added">+  const success = hydrateTextInstance(</div><div class="diff-added">+    /** $FlowFix */</div><div class="diff-added">+    instance,</div><div class="diff-added">+    text,</div><div class="diff-added">+    fiber,</div><div class="diff-added">+    null,</div><div class="diff-added">+  );</div><div class="diff-added">+  if (!success && favorSafetyOverHydrationPerf) {</div><div class="diff-added">+    throwOnHydrationMismatch(fiber);</div><div class="diff-added">+  }</div><div class="diff-added">+}</div><div class="diff-added">+</div><div class="diff-added">+/**</div><div class="diff-added">+ * Hydrate an activity.</div><div class="diff-added">+ */</div><div class="diff-added">+function prepareToHydrateHostActivityInstance(fiber: Fiber) {</div><div class="diff-added">+  if (supportsHydration) {</div><div class="diff-added">+    throw new Error('Never call this.');</div><div class="diff-added">+  }</div><div class="diff-added">+  const activity = (/** $FlowFix */ fiber.memoizedState);</div><div class="diff-added">+  if (activity == null) {</div><div class="diff-added">+    throw new Error('Missing activity state.');</div><div class="diff-added">+  }</div><div class="diff-added">+  hydrateActivityInstance(</div><div class="diff-added">+    /** $FlowFix */</div><div class="diff-added">+    activity.dehydrated,</div><div class="diff-added">+    fiber,</div><div class="diff-added">+  );</div><div class="diff-added">+}</div><div class="diff-added">+</div><div class="diff-added">+/**</div><div class="diff-added">+ * Hydrate a Suspense.</div><div class="diff-added">+ */</div><div class="diff-added">+function prepareToHydrateHostSuspenseInstance(fiber: Fiber) {</div><div class="diff-added">+  if (!supportsHydration) {</div><div class="diff-added">+    throw new Error('Never call this.');</div><div class="diff-added">+  }</div><div class="diff-added">+  const state = /** $FlowFix */</div><div class="diff-added">+    fiber.memoizedState;</div><div class="diff-added">+  if (state == null) {</div><div class="diff-added">+    throw new Error('Missing suspense state.');</div><div class="diff-added">+  }</div><div class="diff-added">+  hydrateSuspenseInstance(</div><div class="diff-added">+    /** $FlowFix */</div><div class="diff-added">+    state.dehydrated,</div><div class="diff-added">+    fiber,</div><div class="diff-added">+  );</div><div class="diff-added">+}</div><div class="diff-added">+</div><div class="diff-added">+/**</div><div class="diff-added">+ * Skip ahead after a Suspense.</div><div class="diff-added">+ */</div><div class="diff-added">+function skipPastDehydratedSuspenseInstance(</div><div class="diff-added">+  fiber: Fiber,</div><div class="diff-added">+): null | HydratableInstance {</div><div class="diff-added">+  const state = /** $FlowFix */ fiber.memoizedState;</div><div class="diff-added">+  if (state == null) {</div><div class="diff-added">+    throw new Error('Missing Suspense.');</div><div class="diff-added">+  }</div><div class="diff-added">+  return getNextHydratableInstanceAfterSuspenseInstance(</div><div class="diff-added">+    /** $FlowFix */</div><div class="diff-added">+    state.dehydrated,</div><div class="diff-added">+  );</div><div class="diff-added">+}</div><div class="diff-added">+</div><div class="diff-added">+/**</div><div class="diff-added">+ * Skip ahead after an Activity.</div><div class="diff-added">+ */</div><div class="diff-added">+function skipPastDehydratedActivityInstance(</div><div class="diff-added">+  fiber: Fiber,</div><div class="diff-added">+): null | HydratableInstance {</div><div class="diff-added">+  const state = /** $FlowFix */ fiber.memoizedState;</div><div class="diff-added">+  if (state == null) {</div><div class="diff-added">+    throw new Error('Missing Activity.');</div><div class="diff-added">+  }</div><div class="diff-added">+  return getNextHydratableInstanceAfterActivityInstance(</div><div class="diff-added">+    /** $FlowFix */</div><div class="diff-added">+    state.dehydrated,</div><div class="diff-added">+  );</div><div class="diff-added">+}</div><div class="diff-added">+</div><div class="diff-added">+/**</div><div class="diff-added">+ * When we have trailing unhydrated nodes, log a warning.</div><div class="diff-added">+ */</div><div class="diff-added">+function warnIfUnhydratedTailNodes(fiber: Fiber) {</div><div class="diff-added">+  if (__DEV__) {</div><div class="diff-added">+    let nextInstance = nextHydratableInstance;</div><div class="diff-added">+    while (nextInstance) {</div><div class="diff-added">+      const diffNode = buildHydrationDiffNode(fiber, 0);</div><div class="diff-added">+      const description = describeHydratableInstanceForDevWarnings(</div><div class="diff-added">+        /** $FlowFix */</div><div class="diff-added">+        nextInstance,</div><div class="diff-added">+      );</div><div class="diff-added">+      diffNode.serverTail.push(description);</div><div class="diff-added">+      if (description.type === 'Suspense') {</div><div class="diff-added">+        const suspenseInstance: SuspenseInstance = (nextInstance: any);</div><div class="diff-added">+        nextInstance = getNextHydratableInstanceAfterSuspenseInstance(</div><div class="diff-added">+          /** $FlowFix */</div><div class="diff-added">+          suspenseInstance,</div><div class="diff-added">+        );</div><div class="diff-added">+      } else {</div><div class="diff-added">+        nextInstance = getNextHydratableSibling(</div><div class="diff-added">+          /** $FlowFix */</div><div class="diff-added">+          nextInstance,</div><div class="diff-added">+        );</div><div class="diff-added">+      }</div><div class="diff-added">+    }</div><div class="diff-added">+  }</div><div class="diff-added">+}</div><div class="diff-added">+</div><div class="diff-added">+/**</div><div class="diff-added">+ * Queue a hydration error.</div><div class="diff-added">+ */</div><div class="diff-added">+export function queueHydrationError(error: CapturedValue<mixed>) {</div><div class="diff-added">+  if (hydrationErrors == null) {</div><div class="diff-added">+    hydrationErrors = [error];</div><div class="diff-added">+  } else {</div><div class="diff-added">+    (/** @type */ (hydrationErrors: any)).push(error);</div><div class="diff-added">+  }</div><div class="diff-added">+}</div><div class="diff-added">+</div><div class="diff-added">+/**</div><div class="diff-added">+ * Return any hydration errors.</div><div class="diff-added">+ */</div><div class="diff-added">+export function upgradeHydrationErrorsToRecoverable():</div><div class="diff-added">+  | $ReadOnlyArray<CapturedValue<mixed>></div><div class="diff-added">+  | null {</div><div class="diff-added">+  const errors = hydrationErrors;</div><div class="diff-added">+  if (errors != null && errors.length > 0) {</div><div class="diff-added">+    queueRecoverableErrors(errors);</div><div class="diff-added">+    hydrationErrors = null;</div><div class="diff-added">+  }</div><div class="diff-added">+  return errors;</div><div class="diff-added">+}</div><div class="diff-added">+</div><div class="diff-added">+/**</div><div class="diff-added">+ * Emit the pending warnings once a tree is</div><div class="diff-added">+ * fully hydrated without error.</div><div class="diff-added">+ */</div><div class="diff-added">+export function emitPendingHydrationWarnings(): void {</div><div class="diff-added">+  if (__DEV__) {</div><div class="diff-added">+    const root = hydrationDiffRootDEV;</div><div class="diff-added">+    if (root != null) {</div><div class="diff-added">+      const diff = describeDiff(root);</div><div class="diff-added">+      // See `C` for the calling stack.</div><div class="diff-added">+      runWithFiberInDEV(root.fiber, () => {</div><div class="diff-added">+        console.error(</div><div class="diff-added">+          `Some attributes didn't match server HTML. This isn't patched: ${diff}  see https://react.dev/link/hydration-mismatch`,</div><div class="diff-added">+        );</div><div class="diff-added">+      });</div><div class="diff-added">+    }</div><div class="diff-added">+  }</div><div class="diff-added">+}</div><div class="diff-added">+</div><div class="diff-added">+// ---------------------------------------------------------------------</div><div class="diff-added">+// Export API</div><div> </div><div> export {</div><div>   warnIfHydrating,</div><div>   enterHydrationState,</div><div class="diff-added">+  // Get if the hydration mode is active.</div><div>   getIsHydrating,</div><div>   reenterHydrationStateFromDehydratedActivityInstance,</div><div>   reenterHydrationStateFromDehydratedSuspenseInstance,</div><div class="diff-info">@@ -911,9 +1636,11 @@ export {</div><div>   tryToClaimNextHydratableTextInstance,</div><div>   claimNextHydratableActivityInstance,</div><div>   claimNextHydratableSuspenseInstance,</div><div class="diff-added">+  tryToClaimNextHydratableFormMarkerInstance,</div><div>   prepareToHydrateHostInstance,</div><div>   prepareToHydrateHostTextInstance,</div><div>   prepareToHydrateHostActivityInstance,</div><div>   prepareToHydrateHostSuspenseInstance,</div><div>   popHydrationState,</div><div class="diff-added">+  emitPendingHydrationWarnings,</div><div> };</div><div>\ No newline at end of file</div><div></div></pre>
                </div>
            </div>
        </section>
    </main>
    <footer>
        <p>LoCoDiff-bench - <a href="https://github.com/AbanteAI/LoCoDiff-bench">GitHub Repository</a></p>
    </footer>
</body>
</html>
    