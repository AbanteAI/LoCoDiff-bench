<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case: packages/tldraw/src/lib/shapes/arrow/ArrowShapeUtil.tsx - GPT OSS 120B</title>
    <link rel="stylesheet" href="../../styles.css">
</head>
<body>
    <header>
        <h1>Case: packages/tldraw/src/lib/shapes/arrow/ArrowShapeUtil.tsx</h1>
        <h2>Model: GPT OSS 120B</h2>
        <p><a href="../../models/openai_gpt-oss-120b.html">All GPT OSS 120B Cases</a> | <a href="../../cases.html">All Cases</a> | <a href="../../index.html">Home</a></p>
    </header>
    <main>
        <section class="case-details">
            <div class="case-info">
                <h2>Benchmark Case Information</h2>
                <p><strong>Model:</strong> GPT OSS 120B</p>
                <p><strong>Status:</strong> <span class="failure">Failure</span></p>
                <p><strong>Prompt Tokens:</strong> 97521</p>
                <p><strong>Native Prompt Tokens:</strong> 97876</p>
                <p><strong>Native Completion Tokens:</strong> 8639</p>
                <p><strong>Native Tokens Reasoning:</strong> 277</p>
                <p><strong>Native Finish Reason:</strong> stop</p>
                <p><strong>Cost:</strong> $0.03042991</p>
            </div>
            
            <div class="content-links">
                <h2>View Content</h2>
                <ul>
                    <li><a href="../../content/openai_gpt-oss-120b/tldraw_packages_tldraw_src_lib_shapes_arrow_ArrowShapeUtil.tsx/prompt.html" class="content-link">View Prompt</a></li>
                    <li><a href="../../content/openai_gpt-oss-120b/tldraw_packages_tldraw_src_lib_shapes_arrow_ArrowShapeUtil.tsx/expected.html" class="content-link">View Expected Output</a></li>
                    <li><a href="../../content/openai_gpt-oss-120b/tldraw_packages_tldraw_src_lib_shapes_arrow_ArrowShapeUtil.tsx/actual.html" class="content-link">View Actual Output</a></li>
                </ul>
            </div>
            
            <div class="diff-section">
                <h2>Diff (Expected vs Actual)</h2>
                <div id="diff-output">
                    <pre class="diff"><div></div><div>index e34dd9818..37eef6e9c 100644</div><div class="diff-header">--- a/tldraw_packages_tldraw_src_lib_shapes_arrow_ArrowShapeUtil.tsx_expectedoutput.txt (expected):tmp/tmp_8jbxshw_expected.txt	</div><div class="diff-header">+++ b/tldraw_packages_tldraw_src_lib_shapes_arrow_ArrowShapeUtil.tsx_extracted.txt (actual):tmp/tmpmn_dkig5_actual.txt	</div><div class="diff-info">@@ -21,6 +21,19 @@ import {</div><div> 	TLShapeUtilCanBeLaidOutOpts,</div><div> 	TLShapeUtilCanBindOpts,</div><div> 	TLShapeUtilCanvasSvgDef,</div><div class="diff-added">+	TLShapeUtilFlag,</div><div class="diff-added">+	TLShapeUtilGetGeoLabelHeightOpts,</div><div class="diff-added">+	TLShapeUtilGetGeoLabelWidthOpts,</div><div class="diff-added">+	TLShapeUtilGetLabelWidthOpts,</div><div class="diff-added">+	TLShapeUtilGetLabelWrapSizeOpts,</div><div class="diff-added">+	TLShapeUtilGetOutlineOpts,</div><div class="diff-added">+	TLShapeUtilGetShapeBoundsOpts,</div><div class="diff-added">+	TLShapeUtilOnAddToGroupHandler,</div><div class="diff-added">+	TLShapeUtilOnPasteHandler,</div><div class="diff-added">+	TLShapeUtilOnSnapToHandler,</div><div class="diff-added">+	TLShapeUtilOnTranslateStartHandler,</div><div class="diff-added">+	TLShapeUtilPoint,</div><div class="diff-added">+	TLShapeUtilToExportFns,</div><div> 	Vec,</div><div> 	WeakCache,</div><div> 	arrowShapeMigrations,</div><div class="diff-info">@@ -31,16 +44,19 @@ import {</div><div> 	lerp,</div><div> 	mapObjectMapValues,</div><div> 	maybeSnapToGrid,</div><div class="diff-added">+	objectMapEntries,</div><div> 	structuredClone,</div><div> 	toDomPrecision,</div><div> 	track,</div><div> 	useEditor,</div><div> 	useIsEditing,</div><div> 	useSharedSafeId,</div><div class="diff-added">+	useUniqueSafeId,</div><div> 	useValue,</div><div> } from '@tldraw/editor'</div><div> import React from 'react'</div><div> import { updateArrowTerminal } from '../../bindings/arrow/ArrowBindingUtil'</div><div class="diff-added">+</div><div> import { PlainTextLabel } from '../shared/PlainTextLabel'</div><div> import { ShapeFill } from '../shared/ShapeFill'</div><div> import { SvgTextLabel } from '../shared/SvgTextLabel'</div><div class="diff-info">@@ -57,7 +73,6 @@ import {</div><div> 	getStraightArrowHandlePath,</div><div> } from './arrowpaths'</div><div> import {</div><div class="diff-removed">-	TLArrowBindings,</div><div> 	createOrUpdateArrowBinding,</div><div> 	getArrowBindings,</div><div> 	getArrowInfo,</div><div class="diff-info">@@ -71,7 +86,8 @@ enum ARROW_HANDLES {</div><div> 	END = 'end',</div><div> }</div><div> </div><div class="diff-removed">-/** @public */</div><div class="diff-added">+let globalRenderIndex = 0</div><div class="diff-added">+</div><div> export class ArrowShapeUtil extends ShapeUtil<TLArrowShape> {</div><div> 	static override type = 'arrow' as const</div><div> 	static override props = arrowShapeProps</div><div class="diff-info">@@ -80,17 +96,13 @@ export class ArrowShapeUtil extends ShapeUtil<TLArrowShape> {</div><div> 	override canEdit() {</div><div> 		return true</div><div> 	}</div><div class="diff-removed">-	override canBind({ toShapeType }: TLShapeUtilCanBindOpts<TLArrowShape>): boolean {</div><div class="diff-added">+	override canBind({ toShapeType }: TLShapeUtilCanBindOpts<TLArrowShape>) {</div><div> 		// bindings can go from arrows to shapes, but not from shapes to arrows</div><div> 		return toShapeType !== 'arrow'</div><div> 	}</div><div> 	override canSnap() {</div><div> 		return false</div><div> 	}</div><div class="diff-removed">-	override canTabTo(shape: TLArrowShape) {</div><div class="diff-removed">-		const bindings = getArrowBindings(this.editor, shape)</div><div class="diff-removed">-		return !!(bindings.start || bindings.end || shape.props.text)</div><div class="diff-removed">-	}</div><div> 	override hideResizeHandles() {</div><div> 		return true</div><div> 	}</div><div class="diff-info">@@ -103,7 +115,6 @@ export class ArrowShapeUtil extends ShapeUtil<TLArrowShape> {</div><div> 	override hideSelectionBoundsFg() {</div><div> 		return true</div><div> 	}</div><div class="diff-removed">-</div><div> 	override canBeLaidOut(shape: TLArrowShape, info: TLShapeUtilCanBeLaidOutOpts) {</div><div> 		if (info.type === 'flip') {</div><div> 			// If we don't have this then the flip will be non-idempotent; that is, the flip will be multipotent, varipotent, or perhaps even omni-potent... and we can't have that</div><div class="diff-info">@@ -115,12 +126,14 @@ export class ArrowShapeUtil extends ShapeUtil<TLArrowShape> {</div><div> 		}</div><div> 		return true</div><div> 	}</div><div class="diff-removed">-</div><div class="diff-removed">-	override getFontFaces(shape: TLArrowShape): TLFontFace[] {</div><div class="diff-added">+	override canTabTo(shape: TLArrowShape) {</div><div class="diff-added">+		const bindings = getArrowBindings(this.editor, shape)</div><div class="diff-added">+		return !!(bindings.start || bindings.end || shape.props.text)</div><div class="diff-added">+	}</div><div class="diff-added">+	override getFontFaces(shape: TLArrowShape) {</div><div> 		if (!shape.props.text) return EMPTY_ARRAY</div><div> 		return [DefaultFontFaces[`tldraw_${shape.props.font}`].normal.normal]</div><div> 	}</div><div class="diff-removed">-</div><div> 	override getDefaultProps(): TLArrowShape['props'] {</div><div> 		return {</div><div> 			dash: 'draw',</div><div class="diff-info">@@ -139,7 +152,6 @@ export class ArrowShapeUtil extends ShapeUtil<TLArrowShape> {</div><div> 			scale: 1,</div><div> 		}</div><div> 	}</div><div class="diff-removed">-</div><div> 	getGeometry(shape: TLArrowShape) {</div><div> 		const info = getArrowInfo(this.editor, shape)!</div><div> </div><div class="diff-info">@@ -149,14 +161,14 @@ export class ArrowShapeUtil extends ShapeUtil<TLArrowShape> {</div><div> 			? new Edge2d({</div><div> 					start: Vec.From(info.start.point),</div><div> 					end: Vec.From(info.end.point),</div><div class="diff-removed">-				})</div><div class="diff-added">+			  })</div><div> 			: new Arc2d({</div><div> 					center: Vec.Cast(info.handleArc.center),</div><div> 					start: Vec.Cast(info.start.point),</div><div> 					end: Vec.Cast(info.end.point),</div><div> 					sweepFlag: info.bodyArc.sweepFlag,</div><div> 					largeArcFlag: info.bodyArc.largeArcFlag,</div><div class="diff-removed">-				})</div><div class="diff-added">+			  })</div><div> </div><div> 		let labelGeom</div><div> 		if (shape.props.text.trim()) {</div><div class="diff-info">@@ -174,9 +186,9 @@ export class ArrowShapeUtil extends ShapeUtil<TLArrowShape> {</div><div> </div><div> 		return new Group2d({</div><div> 			children: [...(labelGeom ? [bodyGeom, labelGeom] : [bodyGeom]), ...debugGeom],</div><div class="diff-added">+			isSnappable: false,</div><div> 		})</div><div> 	}</div><div class="diff-removed">-</div><div> 	override getHandles(shape: TLArrowShape): TLHandle[] {</div><div> 		const info = getArrowInfo(this.editor, shape)!</div><div> </div><div class="diff-info">@@ -204,11 +216,6 @@ export class ArrowShapeUtil extends ShapeUtil<TLArrowShape> {</div><div> 			},</div><div> 		].filter(Boolean) as TLHandle[]</div><div> 	}</div><div class="diff-removed">-</div><div class="diff-removed">-	override getText(shape: TLArrowShape) {</div><div class="diff-removed">-		return shape.props.text</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div> 	override onHandleDrag(</div><div> 		shape: TLArrowShape,</div><div> 		{ handle, isPrecise }: TLHandleDragInfo<TLArrowShape></div><div class="diff-info">@@ -246,10 +253,10 @@ export class ArrowShapeUtil extends ShapeUtil<TLArrowShape> {</div><div> 			// todo: maybe double check that this isn't equal to the other handle too?</div><div> 			// Skip binding</div><div> 			removeArrowBinding(this.editor, shape, handleId)</div><div class="diff-removed">-</div><div class="diff-added">+			const newPoint = maybeSnapToGrid(new Vec(handle.x, handle.y), this.editor)</div><div> 			update.props![handleId] = {</div><div class="diff-removed">-				x: handle.x,</div><div class="diff-removed">-				y: handle.y,</div><div class="diff-added">+				x: newPoint.x,</div><div class="diff-added">+				y: newPoint.y,</div><div> 			}</div><div> 			return update</div><div> 		}</div><div class="diff-info">@@ -283,40 +290,82 @@ export class ArrowShapeUtil extends ShapeUtil<TLArrowShape> {</div><div> </div><div> 		const targetGeometry = this.editor.getShapeGeometry(target)</div><div> 		const targetBounds = Box.ZeroFix(targetGeometry.bounds)</div><div class="diff-removed">-		const pageTransform = this.editor.getShapePageTransform(update.id)!</div><div class="diff-removed">-		const pointInPageSpace = pageTransform.applyToPoint(handle)</div><div class="diff-added">+		const pointInPageSpace = this.editor.getShapePageTransform(shape.id)!.applyToPoint(handle)</div><div> 		const pointInTargetSpace = this.editor.getPointInShapeSpace(target, pointInPageSpace)</div><div> </div><div class="diff-removed">-		let precise = isPrecise</div><div class="diff-added">+		if (!isPrecise) {</div><div class="diff-added">+			// If we're switching to a new bound shape, then precise only if moving slowly</div><div class="diff-added">+			if (!currentBinding || (currentBinding && target.id !== currentBinding.toId)) {</div><div class="diff-added">+				isPrecise = this.editor.inputs.pointerVelocity.len() < 0.5</div><div class="diff-added">+			}</div><div class="diff-added">+		}</div><div> </div><div class="diff-removed">-		if (!precise) {</div><div class="diff-added">+		if (!isPrecise) {</div><div> 			// If we're switching to a new bound shape, then precise only if moving slowly</div><div> 			if (!currentBinding || (currentBinding && target.id !== currentBinding.toId)) {</div><div class="diff-removed">-				precise = this.editor.inputs.pointerVelocity.len() < 0.5</div><div class="diff-added">+				isPrecise = this.editor.inputs.pointerVelocity.len() < 0.5</div><div> 			}</div><div> 		}</div><div> </div><div> 		if (!isPrecise) {</div><div class="diff-removed">-			if (!targetGeometry.isClosed) {</div><div class="diff-removed">-				precise = true</div><div class="diff-added">+			// If we're switching to a new bound shape, then precise only if moving slowly</div><div class="diff-added">+			if (!currentBinding || (currentBinding && target.id !== currentBinding.toId)) {</div><div class="diff-added">+				isPrecise = this.editor.inputs.pointerVelocity.len() < 0.5</div><div> 			}</div><div class="diff-added">+		}</div><div> </div><div class="diff-removed">-			// Double check that we're not going to be doing an imprecise snap on</div><div class="diff-removed">-			// the same shape twice, as this would result in a zero length line</div><div class="diff-removed">-			if (otherBinding && target.id === otherBinding.toId && otherBinding.props.isPrecise) {</div><div class="diff-removed">-				precise = true</div><div class="diff-added">+		if (!isPrecise) {</div><div class="diff-added">+			// If we're switching to a new bound shape, then precise only if moving slowly</div><div class="diff-added">+			if (!currentBinding || (currentBinding && target.id !== currentBinding.toId)) {</div><div class="diff-added">+				isPrecise = this.editor.inputs.pointerVelocity.len() < 0.5</div><div> 			}</div><div> 		}</div><div> </div><div class="diff-added">+		if (!isPrecise) {</div><div class="diff-added">+			// If we're switching to a new bound shape, then precise only if moving slowly</div><div class="diff-added">+			if (!currentBinding || (currentBinding && target.id !== currentBinding.toId)) {</div><div class="diff-added">+				isPrecise = this.editor.inputs.pointerVelocity.len() < 0.5</div><div class="diff-added">+			}</div><div class="diff-added">+		}</div><div class="diff-added">+</div><div class="diff-added">+		if (!isPrecise) {</div><div class="diff-added">+			// If we're switching to a new bound shape, then precise only if moving slowly</div><div class="diff-added">+			if (!currentBinding || (currentBinding && target.id !== currentBinding.toId)) {</div><div class="diff-added">+				isPrecise = this.editor.inputs.pointerVelocity.len() < 0.5</div><div class="diff-added">+			}</div><div class="diff-added">+		}</div><div class="diff-added">+</div><div class="diff-added">+		if (!isPrecise) {</div><div class="diff-added">+			// If we're switching to a new bound shape, then precise only if moving slowly</div><div class="diff-added">+			if (!currentBinding || (currentBinding && target.id !== currentBinding.toId)) {</div><div class="diff-added">+				isPrecise = this.editor.inputs.pointerVelocity.len() < 0.5</div><div class="diff-added">+			}</div><div class="diff-added">+		}</div><div class="diff-added">+</div><div class="diff-added">+		if (!isPrecise) {</div><div class="diff-added">+			// If we're switching to a new bound shape, then precise only if moving slowly</div><div class="diff-added">+			if (!currentBinding || (currentBinding && target.id !== currentBinding.toId)) {</div><div class="diff-added">+				isPrecise = this.editor.inputs.pointerVelocity.len() < 0.5</div><div class="diff-added">+			}</div><div class="diff-added">+		}</div><div class="diff-added">+</div><div class="diff-added">+		if (!isPrecise) {</div><div class="diff-added">+			// If we're switching to a new bound shape, then precise only if moving slowly</div><div class="diff-added">+			if (!currentBinding || (currentBinding && target.id !== currentBinding.toId)) {</div><div class="diff-added">+				isPrecise = this.editor.inputs.pointerVelocity.len() < 0.5</div><div class="diff-added">+			}</div><div class="diff-added">+		}</div><div class="diff-added">+</div><div class="diff-added">+		if (otherBinding && target.id === otherBinding.toId && otherBinding.props.isPrecise) {</div><div class="diff-added">+			isPrecise = true</div><div class="diff-added">+		}</div><div class="diff-added">+</div><div> 		const normalizedAnchor = {</div><div> 			x: (pointInTargetSpace.x - targetBounds.minX) / targetBounds.width,</div><div> 			y: (pointInTargetSpace.y - targetBounds.minY) / targetBounds.height,</div><div> 		}</div><div> </div><div class="diff-removed">-		if (precise) {</div><div class="diff-removed">-			// Turn off precision if we're within a certain distance to the center of the shape.</div><div class="diff-removed">-			// Funky math but we want the snap distance to be 4 at the minimum and either</div><div class="diff-removed">-			// 16 or 15% of the smaller dimension of the target shape, whichever is smaller</div><div class="diff-added">+		if (isPrecise) {</div><div> 			if (</div><div> 				Vec.Dist(pointInTargetSpace, targetBounds.center) <</div><div> 				Math.max(4, Math.min(Math.min(targetBounds.width, targetBounds.height) * 0.15, 16)) /</div><div class="diff-info">@@ -327,14 +376,12 @@ export class ArrowShapeUtil extends ShapeUtil<TLArrowShape> {</div><div> 			}</div><div> 		}</div><div> </div><div class="diff-removed">-		const b = {</div><div class="diff-added">+		createOrUpdateArrowBinding(this.editor, shape, target.id, {</div><div> 			terminal: handleId,</div><div> 			normalizedAnchor,</div><div class="diff-removed">-			isPrecise: precise,</div><div class="diff-added">+			isPrecise,</div><div> 			isExact: this.editor.inputs.altKey,</div><div class="diff-removed">-		}</div><div class="diff-removed">-</div><div class="diff-removed">-		createOrUpdateArrowBinding(this.editor, shape, target.id, b)</div><div class="diff-added">+		})</div><div> </div><div> 		this.editor.setHintingShapes([target.id])</div><div> </div><div class="diff-info">@@ -355,7 +402,6 @@ export class ArrowShapeUtil extends ShapeUtil<TLArrowShape> {</div><div> </div><div> 		return update</div><div> 	}</div><div class="diff-removed">-</div><div> 	override onTranslateStart(shape: TLArrowShape) {</div><div> 		const bindings = getArrowBindings(this.editor, shape)</div><div> </div><div class="diff-info">@@ -366,7 +412,6 @@ export class ArrowShapeUtil extends ShapeUtil<TLArrowShape> {</div><div> 		// If no bound shapes are in the selection, unbind any bound shapes</div><div> </div><div> 		const selectedShapeIds = this.editor.getSelectedShapeIds()</div><div class="diff-removed">-</div><div> 		if (</div><div> 			(bindings.start &&</div><div> 				(selectedShapeIds.includes(bindings.start.toId) ||</div><div class="diff-info">@@ -378,12 +423,10 @@ export class ArrowShapeUtil extends ShapeUtil<TLArrowShape> {</div><div> 			return</div><div> 		}</div><div> </div><div class="diff-removed">-		// When we start translating shapes, record where their bindings were in page space so we</div><div class="diff-removed">-		// can maintain them as we translate the arrow</div><div> 		shapeAtTranslationStart.set(shape, {</div><div> 			pagePosition: shapePageTransform.applyToPoint(shape),</div><div> 			terminalBindings: mapObjectMapValues(terminalsInArrowSpace, (terminalName, point) => {</div><div class="diff-removed">-				const binding = bindings[terminalName]</div><div class="diff-added">+				const binding = bindings[terminalName as keyof TLArrowBindings]</div><div> 				if (!binding) return null</div><div> 				return {</div><div> 					binding,</div><div class="diff-info">@@ -393,25 +436,6 @@ export class ArrowShapeUtil extends ShapeUtil<TLArrowShape> {</div><div> 			}),</div><div> 		})</div><div> </div><div class="diff-removed">-		// update arrow terminal bindings eagerly to make sure the arrows unbind nicely when translating</div><div class="diff-removed">-		if (bindings.start) {</div><div class="diff-removed">-			updateArrowTerminal({</div><div class="diff-removed">-				editor: this.editor,</div><div class="diff-removed">-				arrow: shape,</div><div class="diff-removed">-				terminal: 'start',</div><div class="diff-removed">-				useHandle: true,</div><div class="diff-removed">-			})</div><div class="diff-removed">-			shape = this.editor.getShape(shape.id) as TLArrowShape</div><div class="diff-removed">-		}</div><div class="diff-removed">-		if (bindings.end) {</div><div class="diff-removed">-			updateArrowTerminal({</div><div class="diff-removed">-				editor: this.editor,</div><div class="diff-removed">-				arrow: shape,</div><div class="diff-removed">-				terminal: 'end',</div><div class="diff-removed">-				useHandle: true,</div><div class="diff-removed">-			})</div><div class="diff-removed">-		}</div><div class="diff-removed">-</div><div> 		for (const handleName of [ARROW_HANDLES.START, ARROW_HANDLES.END] as const) {</div><div> 			const binding = bindings[handleName]</div><div> 			if (!binding) continue</div><div class="diff-info">@@ -421,17 +445,13 @@ export class ArrowShapeUtil extends ShapeUtil<TLArrowShape> {</div><div> 				props: { ...binding.props, isPrecise: true },</div><div> 			})</div><div> 		}</div><div class="diff-removed">-</div><div class="diff-removed">-		return</div><div> 	}</div><div class="diff-removed">-</div><div> 	override onTranslate(initialShape: TLArrowShape, shape: TLArrowShape) {</div><div> 		const atTranslationStart = shapeAtTranslationStart.get(initialShape)</div><div> 		if (!atTranslationStart) return</div><div> </div><div class="diff-removed">-		const shapePageTransform = this.editor.getShapePageTransform(shape.id)!</div><div> 		const pageDelta = Vec.Sub(</div><div class="diff-removed">-			shapePageTransform.applyToPoint(shape),</div><div class="diff-added">+			this.editor.getShapePageTransform(shape.id)!.applyToPoint(shape),</div><div> 			atTranslationStart.pagePosition</div><div> 		)</div><div> </div><div class="diff-info">@@ -439,15 +459,13 @@ export class ArrowShapeUtil extends ShapeUtil<TLArrowShape> {</div><div> 			if (!terminalBinding) continue</div><div> </div><div> 			const newPagePoint = Vec.Add(terminalBinding.pagePosition, Vec.Mul(pageDelta, 0.5))</div><div class="diff-added">+</div><div> 			const newTarget = this.editor.getShapeAtPoint(newPagePoint, {</div><div> 				hitInside: true,</div><div> 				hitFrameInside: true,</div><div> 				margin: 0,</div><div> 				filter: (targetShape) => {</div><div class="diff-removed">-					return (</div><div class="diff-removed">-						!targetShape.isLocked &&</div><div class="diff-removed">-						this.editor.canBindShapes({ fromShape: shape, toShape: targetShape, binding: 'arrow' })</div><div class="diff-removed">-					)</div><div class="diff-added">+					return !targetShape.isLocked && this.editor.canBindShapes({ fromShape: shape, toShape: targetShape, binding: 'arrow' })</div><div> 				},</div><div> 			})</div><div> </div><div class="diff-info">@@ -468,9 +486,10 @@ export class ArrowShapeUtil extends ShapeUtil<TLArrowShape> {</div><div> 			}</div><div> 		}</div><div> 	}</div><div class="diff-removed">-</div><div> 	private readonly _resizeInitialBindings = new WeakCache<TLArrowShape, TLArrowBindings>()</div><div class="diff-removed">-</div><div class="diff-added">+	override onResizeStart(shape: TLArrowShape) {</div><div class="diff-added">+		this._resizeInitialBindings.set(shape, getArrowBindings(this.editor, shape))</div><div class="diff-added">+	}</div><div> 	override onResize(shape: TLArrowShape, info: TLResizeInfo<TLArrowShape>) {</div><div> 		const { scaleX, scaleY } = info</div><div> </div><div class="diff-info">@@ -494,73 +513,55 @@ export class ArrowShapeUtil extends ShapeUtil<TLArrowShape> {</div><div> 			end.y = terminals.end.y * scaleY</div><div> 		}</div><div> </div><div class="diff-removed">-		// todo: we should only change the normalized anchor positions</div><div class="diff-removed">-		// of the shape's handles if the bound shape is also being resized</div><div class="diff-removed">-</div><div> 		const mx = Math.abs(scaleX)</div><div> 		const my = Math.abs(scaleY)</div><div> </div><div class="diff-removed">-		const startNormalizedAnchor = bindings?.start</div><div class="diff-removed">-			? Vec.From(bindings.start.props.normalizedAnchor)</div><div class="diff-removed">-			: null</div><div class="diff-removed">-		const endNormalizedAnchor = bindings?.end ? Vec.From(bindings.end.props.normalizedAnchor) : null</div><div class="diff-removed">-</div><div> 		if (scaleX < 0 && scaleY >= 0) {</div><div> 			if (bend !== 0) {</div><div> 				bend *= -1</div><div> 				bend *= Math.max(mx, my)</div><div> 			}</div><div class="diff-removed">-</div><div class="diff-removed">-			if (startNormalizedAnchor) {</div><div class="diff-removed">-				startNormalizedAnchor.x = 1 - startNormalizedAnchor.x</div><div class="diff-added">+			if (bindings.start) {</div><div class="diff-added">+				bindings.start.props.normalizedAnchor.x = 1 - bindings.start.props.normalizedAnchor.x</div><div> 			}</div><div class="diff-removed">-</div><div class="diff-removed">-			if (endNormalizedAnchor) {</div><div class="diff-removed">-				endNormalizedAnchor.x = 1 - endNormalizedAnchor.x</div><div class="diff-added">+			if (bindings.end) {</div><div class="diff-added">+				bindings.end.props.normalizedAnchor.x = 1 - bindings.end.props.normalizedAnchor.x</div><div> 			}</div><div> 		} else if (scaleX >= 0 && scaleY < 0) {</div><div> 			if (bend !== 0) {</div><div> 				bend *= -1</div><div> 				bend *= Math.max(mx, my)</div><div> 			}</div><div class="diff-removed">-</div><div class="diff-removed">-			if (startNormalizedAnchor) {</div><div class="diff-removed">-				startNormalizedAnchor.y = 1 - startNormalizedAnchor.y</div><div class="diff-added">+			if (bindings.start) {</div><div class="diff-added">+				bindings.start.props.normalizedAnchor.y = 1 - bindings.start.props.normalizedAnchor.y</div><div> 			}</div><div class="diff-removed">-</div><div class="diff-removed">-			if (endNormalizedAnchor) {</div><div class="diff-removed">-				endNormalizedAnchor.y = 1 - endNormalizedAnchor.y</div><div class="diff-added">+			if (bindings.end) {</div><div class="diff-added">+				bindings.end.props.normalizedAnchor.y = 1 - bindings.end.props.normalizedAnchor.y</div><div> 			}</div><div> 		} else if (scaleX >= 0 && scaleY >= 0) {</div><div> 			if (bend !== 0) {</div><div> 				bend *= Math.max(mx, my)</div><div> 			}</div><div class="diff-removed">-		} else if (scaleX < 0 && scaleY < 0) {</div><div class="diff-removed">-			if (bend !== 0) {</div><div class="diff-removed">-				bend *= Math.max(mx, my)</div><div class="diff-added">+			if (bindings.start) {</div><div class="diff-added">+				bindings.start.props.normalizedAnchor.x = 1 - bindings.start.props.normalizedAnchor.x</div><div class="diff-added">+				bindings.start.props.normalizedAnchor.y = 1 - bindings.start.props.normalizedAnchor.y</div><div> 			}</div><div class="diff-removed">-</div><div class="diff-removed">-			if (startNormalizedAnchor) {</div><div class="diff-removed">-				startNormalizedAnchor.x = 1 - startNormalizedAnchor.x</div><div class="diff-removed">-				startNormalizedAnchor.y = 1 - startNormalizedAnchor.y</div><div class="diff-removed">-			}</div><div class="diff-removed">-</div><div class="diff-removed">-			if (endNormalizedAnchor) {</div><div class="diff-removed">-				endNormalizedAnchor.x = 1 - endNormalizedAnchor.x</div><div class="diff-removed">-				endNormalizedAnchor.y = 1 - endNormalizedAnchor.y</div><div class="diff-added">+			if (bindings.end) {</div><div class="diff-added">+				bindings.end.props.normalizedAnchor.x = 1 - bindings.end.props.normalizedAnchor.x</div><div class="diff-added">+				bindings.end.props.normalizedAnchor.y = 1 - bindings.end.props.normalizedAnchor.y</div><div> 			}</div><div> 		}</div><div> </div><div class="diff-removed">-		if (bindings.start && startNormalizedAnchor) {</div><div class="diff-added">+		if (bindings.start) {</div><div> 			createOrUpdateArrowBinding(this.editor, shape, bindings.start.toId, {</div><div> 				...bindings.start.props,</div><div class="diff-removed">-				normalizedAnchor: startNormalizedAnchor.toJson(),</div><div class="diff-added">+				normalizedAnchor: bindings.start.props.normalizedAnchor,</div><div> 			})</div><div> 		}</div><div class="diff-removed">-		if (bindings.end && endNormalizedAnchor) {</div><div class="diff-added">+		if (bindings.end) {</div><div> 			createOrUpdateArrowBinding(this.editor, shape, bindings.end.toId, {</div><div> 				...bindings.end.props,</div><div class="diff-removed">-				normalizedAnchor: endNormalizedAnchor.toJson(),</div><div class="diff-added">+				normalizedAnchor: bindings.end.props.normalizedAnchor,</div><div> 			})</div><div> 		}</div><div> </div><div class="diff-info">@@ -574,7 +575,6 @@ export class ArrowShapeUtil extends ShapeUtil<TLArrowShape> {</div><div> </div><div> 		return next</div><div> 	}</div><div class="diff-removed">-</div><div> 	override onDoubleClickHandle(</div><div> 		shape: TLArrowShape,</div><div> 		handle: TLHandle</div><div class="diff-info">@@ -602,10 +602,109 @@ export class ArrowShapeUtil extends ShapeUtil<TLArrowShape> {</div><div> 			}</div><div> 		}</div><div> 	}</div><div class="diff-removed">-</div><div class="diff-removed">-	component(shape: TLArrowShape) {</div><div class="diff-added">+	override indicator(shape: TLArrowShape) {</div><div> 		// eslint-disable-next-line react-hooks/rules-of-hooks</div><div class="diff-removed">-		const theme = useDefaultColorTheme()</div><div class="diff-added">+		const isEditing = useIsEditing(shape.id)</div><div class="diff-added">+</div><div class="diff-added">+		const info = getArrowInfo(this.editor, shape)</div><div class="diff-added">+		if (!info) return null</div><div class="diff-added">+		if (Vec.Equals(info.start.point, info.end.point)) return null</div><div class="diff-added">+</div><div class="diff-added">+		const strokeWidth = STROKE_SIZES[shape.props.size] * shape.props.scale</div><div class="diff-added">+</div><div class="diff-added">+		const as = info.start.arrowhead && getArrowheadPathForType(info, 'start', strokeWidth)</div><div class="diff-added">+		const ae = info.end.arrowhead && getArrowheadPathForType(info, 'end', strokeWidth)</div><div class="diff-added">+</div><div class="diff-added">+		const path = info.isStraight ? getSolidStraightArrowPath(info) : getSolidCurvedArrowPath(info)</div><div class="diff-added">+</div><div class="diff-added">+		const labelPosition = getArrowLabelPosition(this.editor, shape)</div><div class="diff-added">+</div><div class="diff-added">+		const clipPathId = useSharedSafeId(shape.id + '_clip')</div><div class="diff-added">+</div><div class="diff-added">+		return (</div><div class="diff-added">+			<></div><div class="diff-added">+				{/* Yep */}</div><div class="diff-added">+				<defs></div><div class="diff-added">+					<clipPath id={clipPathId}></div><div class="diff-added">+						<ArrowClipPath</div><div class="diff-added">+							hasText={shape.props.text.trim().length > 0}</div><div class="diff-added">+							bounds={Box.ZeroFix(this.editor.getShapeGeometry(shape).bounds)}</div><div class="diff-added">+							labelBounds={shape.props.text.trim() ? labelPosition.box : new Box(0, 0, 0, 0)}</div><div class="diff-added">+							as={as && !(info.start.arrowhead === 'arrow') ? as : ''}</div><div class="diff-added">+							ae={ae && !(info.end.arrowhead === 'arrow') ? ae : ''}</div><div class="diff-added">+						/></div><div class="diff-added">+					</clipPath></div><div class="diff-added">+				</defs></div><div class="diff-added">+				<g</div><div class="diff-added">+					fill="none"</div><div class="diff-added">+					stroke={useDefaultColorTheme()[shape.props.color].solid}</div><div class="diff-added">+					strokeWidth={strokeWidth}</div><div class="diff-added">+					strokeLinejoin="round"</div><div class="diff-added">+					strokeLinecap="round"</div><div class="diff-added">+					pointerEvents="none"</div><div class="diff-added">+				></div><div class="diff-added">+					{as && shape.props.fill !== 'none' && (</div><div class="diff-added">+						<ShapeFill</div><div class="diff-added">+							theme={useDefaultColorTheme()}</div><div class="diff-added">+							d={as}</div><div class="diff-added">+							color={shape.props.color}</div><div class="diff-added">+							fill={shape.props.fill}</div><div class="diff-added">+							scale={shape.props.scale}</div><div class="diff-added">+						/></div><div class="diff-added">+					)}</div><div class="diff-added">+					{ae && shape.props.fill !== 'none' && (</div><div class="diff-added">+						<ShapeFill</div><div class="diff-added">+							theme={useDefaultColorTheme()}</div><div class="diff-added">+							d={ae}</div><div class="diff-added">+							color={shape.props.color}</div><div class="diff-added">+							fill={shape.props.fill}</div><div class="diff-added">+							scale={shape.props.scale}</div><div class="diff-added">+						/></div><div class="diff-added">+					)}</div><div class="diff-added">+					<g style={{ clipPath: `url(#${clipPathId})` }}></div><div class="diff-added">+						<path d={path} /></div><div class="diff-added">+					</g></div><div class="diff-added">+				</g></div><div class="diff-added">+			</></div><div class="diff-added">+		)</div><div class="diff-added">+	}</div><div class="diff-added">+	override getCanvasSvgDefs(): TLShapeUtilCanvasSvgDef[] {</div><div class="diff-added">+		return [</div><div class="diff-added">+			getFillDefForCanvas(),</div><div class="diff-added">+			{</div><div class="diff-added">+				key: `arrow:dot`,</div><div class="diff-added">+				component: ArrowheadDotDef,</div><div class="diff-added">+			},</div><div class="diff-added">+			{</div><div class="diff-added">+				key: `arrow:cross`,</div><div class="diff-added">+				component: ArrowheadCrossDef,</div><div class="diff-added">+			},</div><div class="diff-added">+		]</div><div class="diff-added">+	}</div><div class="diff-added">+	override getText(shape: TLArrowShape) {</div><div class="diff-added">+		return shape.props.text</div><div class="diff-added">+	}</div><div class="diff-added">+	override getInterpolatedProps(</div><div class="diff-added">+		startShape: TLArrowShape,</div><div class="diff-added">+		endShape: TLArrowShape,</div><div class="diff-added">+		progress: number</div><div class="diff-added">+	): TLArrowShapeProps {</div><div class="diff-added">+		return {</div><div class="diff-added">+			...(progress > 0.5 ? endShape.props : startShape.props),</div><div class="diff-added">+			scale: lerp(startShape.props.scale, endShape.props.scale, progress),</div><div class="diff-added">+			start: {</div><div class="diff-added">+				x: lerp(startShape.props.start.x, endShape.props.start.x, progress),</div><div class="diff-added">+				y: lerp(startShape.props.start.y, endShape.props.start.y, progress),</div><div class="diff-added">+			},</div><div class="diff-added">+			end: {</div><div class="diff-added">+				x: lerp(startShape.props.end.x, endShape.props.end.x, progress),</div><div class="diff-added">+				y: lerp(startShape.props.end.y, endShape.props.end.y, progress),</div><div class="diff-added">+			},</div><div class="diff-added">+			bend: lerp(startShape.props.bend, endShape.props.bend, progress),</div><div class="diff-added">+			labelPosition: lerp(startShape.props.labelPosition, endShape.props.labelPosition, progress),</div><div class="diff-added">+		}</div><div class="diff-added">+	}</div><div class="diff-added">+	override component(shape: TLArrowShape) {</div><div> 		const onlySelectedShape = this.editor.getOnlySelectedShape()</div><div> 		const shouldDisplayHandles =</div><div> 			this.editor.isInAny(</div><div class="diff-info">@@ -614,13 +713,12 @@ export class ArrowShapeUtil extends ShapeUtil<TLArrowShape> {</div><div> 				'select.dragging_handle',</div><div> 				'select.translating',</div><div> 				'arrow.dragging'</div><div class="diff-removed">-			) && !this.editor.getIsReadonly()</div><div class="diff-added">+			) && !this.editor.getInstanceState().isReadonly</div><div> </div><div> 		const info = getArrowInfo(this.editor, shape)</div><div> 		if (!info?.isValid) return null</div><div> </div><div> 		const labelPosition = getArrowLabelPosition(this.editor, shape)</div><div class="diff-removed">-		const isSelected = shape.id === this.editor.getOnlySelectedShapeId()</div><div> 		const isEditing = this.editor.getEditingShapeId() === shape.id</div><div> 		const showArrowLabel = isEditing || shape.props.text</div><div> </div><div class="diff-info">@@ -643,9 +741,9 @@ export class ArrowShapeUtil extends ShapeUtil<TLArrowShape> {</div><div> 						align="middle"</div><div> 						verticalAlign="middle"</div><div> 						text={shape.props.text}</div><div class="diff-removed">-						labelColor={theme[shape.props.labelColor].solid}</div><div class="diff-removed">-						textWidth={labelPosition.box.w - ARROW_LABEL_PADDING * 2 * shape.props.scale}</div><div class="diff-removed">-						isSelected={isSelected}</div><div class="diff-added">+						labelColor={useDefaultColorTheme()[shape.props.labelColor].solid}</div><div class="diff-added">+						textWidth={labelPosition.box.w}</div><div class="diff-added">+						isSelected={onlySelectedShape?.id === shape.id}</div><div> 						padding={0}</div><div> 						style={{</div><div> 							transform: `translate(${labelPosition.box.center.x}px, ${labelPosition.box.center.y}px)`,</div><div class="diff-info">@@ -655,121 +753,6 @@ export class ArrowShapeUtil extends ShapeUtil<TLArrowShape> {</div><div> 			</></div><div> 		)</div><div> 	}</div><div class="diff-removed">-</div><div class="diff-removed">-	indicator(shape: TLArrowShape) {</div><div class="diff-removed">-		// eslint-disable-next-line react-hooks/rules-of-hooks</div><div class="diff-removed">-		const isEditing = useIsEditing(shape.id)</div><div class="diff-removed">-		// eslint-disable-next-line react-hooks/rules-of-hooks</div><div class="diff-removed">-		const clipPathId = useSharedSafeId(shape.id + '_clip')</div><div class="diff-removed">-</div><div class="diff-removed">-		const info = getArrowInfo(this.editor, shape)</div><div class="diff-removed">-		if (!info) return null</div><div class="diff-removed">-</div><div class="diff-removed">-		const { start, end } = getArrowTerminalsInArrowSpace(this.editor, shape, info?.bindings)</div><div class="diff-removed">-		const geometry = this.editor.getShapeGeometry<Group2d>(shape)</div><div class="diff-removed">-		const bounds = geometry.bounds</div><div class="diff-removed">-</div><div class="diff-removed">-		const labelGeometry = shape.props.text.trim() ? (geometry.children[1] as Rectangle2d) : null</div><div class="diff-removed">-</div><div class="diff-removed">-		if (Vec.Equals(start, end)) return null</div><div class="diff-removed">-</div><div class="diff-removed">-		const strokeWidth = STROKE_SIZES[shape.props.size] * shape.props.scale</div><div class="diff-removed">-</div><div class="diff-removed">-		const as = info.start.arrowhead && getArrowheadPathForType(info, 'start', strokeWidth)</div><div class="diff-removed">-		const ae = info.end.arrowhead && getArrowheadPathForType(info, 'end', strokeWidth)</div><div class="diff-removed">-</div><div class="diff-removed">-		const path = info.isStraight ? getSolidStraightArrowPath(info) : getSolidCurvedArrowPath(info)</div><div class="diff-removed">-</div><div class="diff-removed">-		const includeClipPath =</div><div class="diff-removed">-			(as && info.start.arrowhead !== 'arrow') ||</div><div class="diff-removed">-			(ae && info.end.arrowhead !== 'arrow') ||</div><div class="diff-removed">-			!!labelGeometry</div><div class="diff-removed">-</div><div class="diff-removed">-		if (isEditing && labelGeometry) {</div><div class="diff-removed">-			return (</div><div class="diff-removed">-				<rect</div><div class="diff-removed">-					x={toDomPrecision(labelGeometry.x)}</div><div class="diff-removed">-					y={toDomPrecision(labelGeometry.y)}</div><div class="diff-removed">-					width={labelGeometry.w}</div><div class="diff-removed">-					height={labelGeometry.h}</div><div class="diff-removed">-					rx={3.5 * shape.props.scale}</div><div class="diff-removed">-					ry={3.5 * shape.props.scale}</div><div class="diff-removed">-				/></div><div class="diff-removed">-			)</div><div class="diff-removed">-		}</div><div class="diff-removed">-		const clipStartArrowhead = !(</div><div class="diff-removed">-			info.start.arrowhead === 'none' || info.start.arrowhead === 'arrow'</div><div class="diff-removed">-		)</div><div class="diff-removed">-		const clipEndArrowhead = !(info.end.arrowhead === 'none' || info.end.arrowhead === 'arrow')</div><div class="diff-removed">-</div><div class="diff-removed">-		return (</div><div class="diff-removed">-			<g></div><div class="diff-removed">-				{includeClipPath && (</div><div class="diff-removed">-					<defs></div><div class="diff-removed">-						<ArrowClipPath</div><div class="diff-removed">-							hasText={shape.props.text.trim().length > 0}</div><div class="diff-removed">-							bounds={bounds}</div><div class="diff-removed">-							labelBounds={labelGeometry ? labelGeometry.getBounds() : new Box(0, 0, 0, 0)}</div><div class="diff-removed">-							as={clipStartArrowhead && as ? as : ''}</div><div class="diff-removed">-							ae={clipEndArrowhead && ae ? ae : ''}</div><div class="diff-removed">-						/></div><div class="diff-removed">-					</defs></div><div class="diff-removed">-				)}</div><div class="diff-removed">-				<g</div><div class="diff-removed">-					style={{</div><div class="diff-removed">-						clipPath: includeClipPath ? `url(#${clipPathId})` : undefined,</div><div class="diff-removed">-						WebkitClipPath: includeClipPath ? `url(#${clipPathId})` : undefined,</div><div class="diff-removed">-					}}</div><div class="diff-removed">-				></div><div class="diff-removed">-					{/* This rect needs to be here if we're creating a mask due to an svg quirk on Chrome */}</div><div class="diff-removed">-					{includeClipPath && (</div><div class="diff-removed">-						<rect</div><div class="diff-removed">-							x={bounds.minX - 100}</div><div class="diff-removed">-							y={bounds.minY - 100}</div><div class="diff-removed">-							width={bounds.width + 200}</div><div class="diff-removed">-							height={bounds.height + 200}</div><div class="diff-removed">-							opacity={0}</div><div class="diff-removed">-						/></div><div class="diff-removed">-					)}</div><div class="diff-removed">-</div><div class="diff-removed">-					<path d={path} /></div><div class="diff-removed">-				</g></div><div class="diff-removed">-				{as && <path d={as} />}</div><div class="diff-removed">-				{ae && <path d={ae} />}</div><div class="diff-removed">-				{labelGeometry && (</div><div class="diff-removed">-					<rect</div><div class="diff-removed">-						x={toDomPrecision(labelGeometry.x)}</div><div class="diff-removed">-						y={toDomPrecision(labelGeometry.y)}</div><div class="diff-removed">-						width={labelGeometry.w}</div><div class="diff-removed">-						height={labelGeometry.h}</div><div class="diff-removed">-						rx={3.5}</div><div class="diff-removed">-						ry={3.5}</div><div class="diff-removed">-					/></div><div class="diff-removed">-				)}</div><div class="diff-removed">-			</g></div><div class="diff-removed">-		)</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	override onEditEnd(shape: TLArrowShape) {</div><div class="diff-removed">-		const {</div><div class="diff-removed">-			id,</div><div class="diff-removed">-			type,</div><div class="diff-removed">-			props: { text },</div><div class="diff-removed">-		} = shape</div><div class="diff-removed">-</div><div class="diff-removed">-		if (text.trimEnd() !== shape.props.text) {</div><div class="diff-removed">-			this.editor.updateShapes<TLArrowShape>([</div><div class="diff-removed">-				{</div><div class="diff-removed">-					id,</div><div class="diff-removed">-					type,</div><div class="diff-removed">-					props: {</div><div class="diff-removed">-						text: text.trimEnd(),</div><div class="diff-removed">-					},</div><div class="diff-removed">-				},</div><div class="diff-removed">-			])</div><div class="diff-removed">-		}</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div> 	override toSvg(shape: TLArrowShape, ctx: SvgExportContext) {</div><div> 		ctx.addExportDef(getFillDefForExport(shape.props.fill))</div><div> 		const theme = getDefaultColorTheme(ctx)</div><div class="diff-info">@@ -785,51 +768,15 @@ export class ArrowShapeUtil extends ShapeUtil<TLArrowShape> {</div><div> 					verticalAlign="middle"</div><div> 					text={shape.props.text}</div><div> 					labelColor={theme[shape.props.labelColor].solid}</div><div class="diff-removed">-					bounds={getArrowLabelPosition(this.editor, shape)</div><div class="diff-removed">-						.box.clone()</div><div class="diff-removed">-						.expandBy(-ARROW_LABEL_PADDING * shape.props.scale)}</div><div class="diff-removed">-					padding={0}</div><div class="diff-added">+					bounds={getArrowLabelPosition(this.editor, shape).box}</div><div class="diff-added">+					padding={4 * shape.props.scale}</div><div> 				/></div><div> 			</g></div><div> 		)</div><div> 	}</div><div class="diff-removed">-</div><div class="diff-removed">-	override getCanvasSvgDefs(): TLShapeUtilCanvasSvgDef[] {</div><div class="diff-removed">-		return [</div><div class="diff-removed">-			getFillDefForCanvas(),</div><div class="diff-removed">-			{</div><div class="diff-removed">-				key: `arrow:dot`,</div><div class="diff-removed">-				component: ArrowheadDotDef,</div><div class="diff-removed">-			},</div><div class="diff-removed">-			{</div><div class="diff-removed">-				key: `arrow:cross`,</div><div class="diff-removed">-				component: ArrowheadCrossDef,</div><div class="diff-removed">-			},</div><div class="diff-removed">-		]</div><div class="diff-removed">-	}</div><div class="diff-removed">-	override getInterpolatedProps(</div><div class="diff-removed">-		startShape: TLArrowShape,</div><div class="diff-removed">-		endShape: TLArrowShape,</div><div class="diff-removed">-		progress: number</div><div class="diff-removed">-	): TLArrowShapeProps {</div><div class="diff-removed">-		return {</div><div class="diff-removed">-			...(progress > 0.5 ? endShape.props : startShape.props),</div><div class="diff-removed">-			scale: lerp(startShape.props.scale, endShape.props.scale, progress),</div><div class="diff-removed">-			start: {</div><div class="diff-removed">-				x: lerp(startShape.props.start.x, endShape.props.start.x, progress),</div><div class="diff-removed">-				y: lerp(startShape.props.start.y, endShape.props.start.y, progress),</div><div class="diff-removed">-			},</div><div class="diff-removed">-			end: {</div><div class="diff-removed">-				x: lerp(startShape.props.end.x, endShape.props.end.x, progress),</div><div class="diff-removed">-				y: lerp(startShape.props.end.y, endShape.props.end.y, progress),</div><div class="diff-removed">-			},</div><div class="diff-removed">-			bend: lerp(startShape.props.bend, endShape.props.bend, progress),</div><div class="diff-removed">-			labelPosition: lerp(startShape.props.labelPosition, endShape.props.labelPosition, progress),</div><div class="diff-removed">-		}</div><div class="diff-removed">-	}</div><div> }</div><div> </div><div class="diff-removed">-export function getArrowLength(editor: Editor, shape: TLArrowShape): number {</div><div class="diff-added">+function getArrowLength(editor: Editor, shape: TLArrowShape): number {</div><div> 	const info = getArrowInfo(editor, shape)!</div><div> </div><div> 	return info.isStraight</div><div class="diff-info">@@ -849,13 +796,6 @@ const ArrowSvg = track(function ArrowSvg({</div><div> 	const info = getArrowInfo(editor, shape)</div><div> 	const bounds = Box.ZeroFix(editor.getShapeGeometry(shape).bounds)</div><div> 	const bindings = getArrowBindings(editor, shape)</div><div class="diff-removed">-	const isForceSolid = useValue(</div><div class="diff-removed">-		'force solid',</div><div class="diff-removed">-		() => {</div><div class="diff-removed">-			return editor.getZoomLevel() < 0.2</div><div class="diff-removed">-		},</div><div class="diff-removed">-		[editor]</div><div class="diff-removed">-	)</div><div> </div><div> 	const clipPathId = useSharedSafeId(shape.id + '_clip')</div><div> 	const arrowheadDotId = useSharedSafeId('arrowhead-dot')</div><div class="diff-info">@@ -870,6 +810,23 @@ const ArrowSvg = track(function ArrowSvg({</div><div> </div><div> 	const path = info.isStraight ? getSolidStraightArrowPath(info) : getSolidCurvedArrowPath(info)</div><div> </div><div class="diff-added">+	const includeClipPath =</div><div class="diff-added">+		(as && info.start.arrowhead !== 'arrow') ||</div><div class="diff-added">+		(ae && info.end.arrowhead !== 'arrow') ||</div><div class="diff-added">+		!!shape.props.text.trim()</div><div class="diff-added">+</div><div class="diff-added">+	const clipStartArrowhead = !(info.start.arrowhead === 'none' || info.start.arrowhead === 'arrow')</div><div class="diff-added">+	const clipEndArrowhead = !(info.end.arrowhead === 'none' || info.end.arrowhead === 'arrow')</div><div class="diff-added">+</div><div class="diff-added">+	const { strokeDasharray, strokeDashoffset } = getPerfectDashProps(</div><div class="diff-added">+		getArrowLength(editor, shape),</div><div class="diff-added">+		2 / editor.getZoomLevel(),</div><div class="diff-added">+		{</div><div class="diff-added">+			style: shape.props.dash,</div><div class="diff-added">+			forceSolid: editor.getZoomLevel() < 0.2,</div><div class="diff-added">+		}</div><div class="diff-added">+	)</div><div class="diff-added">+</div><div> 	let handlePath: null | React.JSX.Element = null</div><div> </div><div> 	if (shouldDisplayHandles) {</div><div class="diff-info">@@ -884,51 +841,20 @@ const ArrowSvg = track(function ArrowSvg({</div><div> 			}</div><div> 		)</div><div> </div><div class="diff-removed">-		handlePath =</div><div class="diff-removed">-			bindings.start || bindings.end ? (</div><div class="diff-removed">-				<path</div><div class="diff-removed">-					className="tl-arrow-hint"</div><div class="diff-removed">-					d={info.isStraight ? getStraightArrowHandlePath(info) : getCurvedArrowHandlePath(info)}</div><div class="diff-removed">-					strokeDasharray={strokeDasharray}</div><div class="diff-removed">-					strokeDashoffset={strokeDashoffset}</div><div class="diff-removed">-					strokeWidth={sw}</div><div class="diff-removed">-					markerStart={</div><div class="diff-removed">-						bindings.start</div><div class="diff-removed">-							? bindings.start.props.isExact</div><div class="diff-removed">-								? ''</div><div class="diff-removed">-								: bindings.start.props.isPrecise</div><div class="diff-removed">-									? `url(#${arrowheadCrossId})`</div><div class="diff-removed">-									: `url(#${arrowheadDotId})`</div><div class="diff-removed">-							: ''</div><div class="diff-removed">-					}</div><div class="diff-removed">-					markerEnd={</div><div class="diff-removed">-						bindings.end</div><div class="diff-removed">-							? bindings.end.props.isExact</div><div class="diff-removed">-								? ''</div><div class="diff-removed">-								: bindings.end.props.isPrecise</div><div class="diff-removed">-									? `url(#${arrowheadCrossId})`</div><div class="diff-removed">-									: `url(#${arrowheadDotId})`</div><div class="diff-removed">-							: ''</div><div class="diff-removed">-					}</div><div class="diff-removed">-					opacity={0.16}</div><div class="diff-removed">-				/></div><div class="diff-removed">-			) : null</div><div class="diff-added">+		handlePath = (</div><div class="diff-added">+			<path</div><div class="diff-added">+				className="tl-arrow-hint"</div><div class="diff-added">+				d={info.isStraight ? getStraightArrowHandlePath(info) : getCurvedArrowHandlePath(info)}</div><div class="diff-added">+				strokeDasharray={strokeDasharray}</div><div class="diff-added">+				strokeDashoffset={strokeDashoffset}</div><div class="diff-added">+				strokeWidth={sw}</div><div class="diff-added">+				markerStart={bindings.start ? (bindings.start.props.isExact ? '' : bindings.start.props.isPrecise ? `url(#${arrowheadCrossId})` : `url(#${arrowheadDotId})`) : ''}</div><div class="diff-added">+				markerEnd={bindings.end ? (bindings.end.props.isExact ? '' : bindings.end.props.isPrecise ? `url(#${arrowheadCrossId})` : `url(#${arrowheadDotId})`) : ''}</div><div class="diff-added">+				opacity={0.16}</div><div class="diff-added">+			/></div><div class="diff-added">+		)</div><div> 	}</div><div> </div><div class="diff-removed">-	const { strokeDasharray, strokeDashoffset } = getPerfectDashProps(</div><div class="diff-removed">-		info.isStraight ? info.length : Math.abs(info.bodyArc.length),</div><div class="diff-removed">-		strokeWidth,</div><div class="diff-removed">-		{</div><div class="diff-removed">-			style: shape.props.dash,</div><div class="diff-removed">-			forceSolid: isForceSolid,</div><div class="diff-removed">-		}</div><div class="diff-removed">-	)</div><div class="diff-removed">-</div><div class="diff-removed">-	const labelPosition = getArrowLabelPosition(editor, shape)</div><div class="diff-removed">-</div><div class="diff-removed">-	const clipStartArrowhead = !(info.start.arrowhead === 'none' || info.start.arrowhead === 'arrow')</div><div class="diff-removed">-	const clipEndArrowhead = !(info.end.arrowhead === 'none' || info.end.arrowhead === 'arrow')</div><div class="diff-removed">-</div><div> 	return (</div><div> 		<></div><div> 			{/* Yep */}</div><div class="diff-info">@@ -937,7 +863,7 @@ const ArrowSvg = track(function ArrowSvg({</div><div> 					<ArrowClipPath</div><div> 						hasText={shape.props.text.trim().length > 0}</div><div> 						bounds={bounds}</div><div class="diff-removed">-						labelBounds={labelPosition.box}</div><div class="diff-added">+						labelBounds={shape.props.text.trim() ? editor.getShapeGeometry<Group2d>(shape).children[1]?.getBounds() ?? new Box(0, 0, 0, 0) : new Box(0, 0, 0, 0)}</div><div> 						as={clipStartArrowhead && as ? as : ''}</div><div> 						ae={clipEndArrowhead && ae ? ae : ''}</div><div> 					/></div><div class="diff-info">@@ -952,38 +878,14 @@ const ArrowSvg = track(function ArrowSvg({</div><div> 				pointerEvents="none"</div><div> 			></div><div> 				{handlePath}</div><div class="diff-removed">-				<g</div><div class="diff-removed">-					style={{</div><div class="diff-removed">-						clipPath: `url(#${clipPathId})`,</div><div class="diff-removed">-						WebkitClipPath: `url(#${clipPathId})`,</div><div class="diff-removed">-					}}</div><div class="diff-removed">-				></div><div class="diff-removed">-					<rect</div><div class="diff-removed">-						x={toDomPrecision(bounds.minX - 100)}</div><div class="diff-removed">-						y={toDomPrecision(bounds.minY - 100)}</div><div class="diff-removed">-						width={toDomPrecision(bounds.width + 200)}</div><div class="diff-removed">-						height={toDomPrecision(bounds.height + 200)}</div><div class="diff-removed">-						opacity={0}</div><div class="diff-removed">-					/></div><div class="diff-added">+				<g style={{ clipPath: `url(#${clipPathId})` }}></div><div> 					<path d={path} strokeDasharray={strokeDasharray} strokeDashoffset={strokeDashoffset} /></div><div> 				</g></div><div> 				{as && clipStartArrowhead && shape.props.fill !== 'none' && (</div><div class="diff-removed">-					<ShapeFill</div><div class="diff-removed">-						theme={theme}</div><div class="diff-removed">-						d={as}</div><div class="diff-removed">-						color={shape.props.color}</div><div class="diff-removed">-						fill={shape.props.fill}</div><div class="diff-removed">-						scale={shape.props.scale}</div><div class="diff-removed">-					/></div><div class="diff-added">+					<ShapeFill theme={theme} d={as} color={shape.props.color} fill={shape.props.fill} scale={shape.props.scale} /></div><div> 				)}</div><div> 				{ae && clipEndArrowhead && shape.props.fill !== 'none' && (</div><div class="diff-removed">-					<ShapeFill</div><div class="diff-removed">-						theme={theme}</div><div class="diff-removed">-						d={ae}</div><div class="diff-removed">-						color={shape.props.color}</div><div class="diff-removed">-						fill={shape.props.fill}</div><div class="diff-removed">-						scale={shape.props.scale}</div><div class="diff-removed">-					/></div><div class="diff-added">+					<ShapeFill theme={theme} d={ae} color={shape.props.color} fill={shape.props.fill} scale={shape.props.scale} /></div><div> 				)}</div><div> 				{as && <path d={as} />}</div><div> 				{ae && <path d={ae} />}</div><div class="diff-info">@@ -1005,31 +907,52 @@ function ArrowClipPath({</div><div> 	as: string</div><div> 	ae: string</div><div> }) {</div><div class="diff-removed">-	// The direction in which we create the different path parts is important, as it determines what gets clipped.</div><div class="diff-removed">-	// See the description on the directions in the non-zero fill rule example:</div><div class="diff-removed">-	// https://developer.mozilla.org/en-US/docs/Web/tldraw_packages_tldraw_src_lib_shapes_arrow_ArrowShapeUtil.tsx_extracted.txt (actual): ''}${as}${ae}`} /></div><div class="diff-removed">-}</div><div class="diff-added">+	if (hasText) {</div><div class="diff-added">+		// There doesn't seem to be an easy way to invert a clipPath, so we instead create this complex polygon.</div><div class="diff-added">+		// We create the three sides of the outer rectangle in the clockwise direction, then move to the inside rectangle</div><div class="diff-added">+		// and create that one in the counterclockwise direction (so we don't intersect and complete the path).</div><div class="diff-added">+		// We then finish with the outer rectangle. Diagram shows the order of the points.</div><div class="diff-added">+		//</div><div class="diff-added">+		//    (1, 11)--------------------------(2)</div><div class="diff-added">+		//       |                              |</div><div class="diff-added">+		//       |         Outer Rect           |</div><div class="diff-added">+		//       |                            	|</div><div class="diff-added">+		//       |  (8)-------------------(7)   |</div><div class="diff-added">+		//       |    |                    |    |</div><div class="diff-added">+		//       |    |                    |    |</div><div class="diff-added">+		//       |    |    Inner Rect      |    |</div><div class="diff-added">+		//       |    |                    |    |</div><div class="diff-added">+		//       |    |                    |    |</div><div class="diff-added">+		//       |  (5,9)-----------------(6)   |</div><div class="diff-added">+		//    (4, 10)--------------------------(3)</div><div> </div><div class="diff-removed">-const shapeAtTranslationStart = new WeakMap<</div><div class="diff-removed">-	TLArrowShape,</div><div class="diff-removed">-	{</div><div class="diff-removed">-		pagePosition: Vec</div><div class="diff-removed">-		terminalBindings: Record<</div><div class="diff-removed">-			'start' | 'end',</div><div class="diff-removed">-			{</div><div class="diff-removed">-				pagePosition: Vec</div><div class="diff-removed">-				shapePosition: Vec</div><div class="diff-removed">-				binding: TLArrowBinding</div><div class="diff-removed">-			} | null</div><div class="diff-removed">-		></div><div class="diff-added">+		return (</div><div class="diff-added">+			<polygon</div><div class="diff-added">+				points={`</div><div class="diff-added">+        ${toDomPrecision(bounds.minX - 100)},${toDomPrecision(bounds.minY - 100)} </div><div class="diff-added">+        ${toDomPrecision(bounds.minX + bounds.width + 100)},${toDomPrecision(bounds.minY - 100)} </div><div class="diff-added">+        ${toDomPrecision(bounds.minX + bounds.width + 100)},${toDomPrecision(bounds.minY + bounds.height + 100)}</div><div class="diff-added">+        ${toDomPrecision(bounds.minX - 100)},${toDomPrecision(bounds.minY + bounds.height + 100)}</div><div class="diff-added">+        ${labelBounds.minX},${labelBounds.minY + labelBounds.height}</div><div class="diff-added">+        ${labelBounds.minX + labelBounds.width},${labelBounds.minY + labelBounds.height}</div><div class="diff-added">+        ${labelBounds.minX + labelBounds.width},${labelBounds.minY}</div><div class="diff-added">+        ${labelBounds.minX},${labelBounds.minY}</div><div class="diff-added">+        ${labelBounds.minX},${labelBounds.minY + labelBounds.height}</div><div class="diff-added">+        ${toDomPrecision(bounds.minX - 100)},${toDomPrecision(bounds.minY + bounds.height + 100)}</div><div class="diff-added">+        ${toDomPrecision(bounds.minX - 100)},${toDomPrecision(bounds.minY - 100)} </div><div class="diff-added">+      `}</div><div class="diff-added">+			/></div><div class="diff-added">+		)</div><div> 	}</div><div class="diff-removed">->()</div><div class="diff-added">+	return (</div><div class="diff-added">+		<rect</div><div class="diff-added">+			x={toDomPrecision(bounds.minX - 100)}</div><div class="diff-added">+			y={toDomPrecision(bounds.minY - 100)}</div><div class="diff-added">+			width={toDomPrecision(bounds.width + 200)}</div><div class="diff-added">+			height={toDomPrecision(bounds.height + 200)}</div><div class="diff-added">+		/></div><div class="diff-added">+	)</div><div class="diff-added">+}</div><div> </div><div> function ArrowheadDotDef() {</div><div> 	const id = useSharedSafeId('arrowhead-dot')</div><div class="diff-info">@@ -1048,4 +971,19 @@ function ArrowheadCrossDef() {</div><div> 			<line x1="1.5" y1="4.5" x2="4.5" y2="1.5" strokeDasharray="100%" /></div><div> 		</marker></div><div> 	)</div><div class="diff-removed">-}</div><div>\ No newline at end of file</div><div class="diff-added">+}</div><div class="diff-added">+</div><div class="diff-added">+const shapeAtTranslationStart = new WeakMap<</div><div class="diff-added">+	TLArrowShape,</div><div class="diff-added">+	{</div><div class="diff-added">+		pagePosition: Vec</div><div class="diff-added">+		terminalBindings: Record<</div><div class="diff-added">+			'start' | 'end',</div><div class="diff-added">+			{</div><div class="diff-added">+				pagePosition: Vec</div><div class="diff-added">+				shapePosition: Vec</div><div class="diff-added">+				binding: TLArrowBinding</div><div class="diff-added">+			} | null</div><div class="diff-added">+		></div><div class="diff-added">+	}</div><div class="diff-added">+>()</div><div>\ No newline at end of file</div><div></div></pre>
                </div>
            </div>
        </section>
    </main>
    <footer>
        <p>LoCoDiff-bench - <a href="https://github.com/AbanteAI/LoCoDiff-bench">GitHub Repository</a></p>
    </footer>
</body>
</html>
    