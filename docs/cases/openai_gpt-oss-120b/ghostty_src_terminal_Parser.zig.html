<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case: src/terminal/Parser.zig - GPT OSS 120B</title>
    <link rel="stylesheet" href="../../styles.css">
</head>
<body>
    <header>
        <h1>Case: src/terminal/Parser.zig</h1>
        <h2>Model: GPT OSS 120B</h2>
        <p><a href="../../models/openai_gpt-oss-120b.html">All GPT OSS 120B Cases</a> | <a href="../../cases.html">All Cases</a> | <a href="../../index.html">Home</a></p>
    </header>
    <main>
        <section class="case-details">
            <div class="case-info">
                <h2>Benchmark Case Information</h2>
                <p><strong>Model:</strong> GPT OSS 120B</p>
                <p><strong>Status:</strong> <span class="failure">Failure</span></p>
                <p><strong>Prompt Tokens:</strong> 32616</p>
                <p><strong>Native Prompt Tokens:</strong> 32811</p>
                <p><strong>Native Completion Tokens:</strong> 10594</p>
                <p><strong>Native Tokens Reasoning:</strong> 9132</p>
                <p><strong>Native Finish Reason:</strong> stop</p>
                <p><strong>Cost:</strong> $0.01286715</p>
            </div>
            
            <div class="content-links">
                <h2>View Content</h2>
                <ul>
                    <li><a href="../../content/openai_gpt-oss-120b/ghostty_src_terminal_Parser.zig/prompt.html" class="content-link">View Prompt</a></li>
                    <li><a href="../../content/openai_gpt-oss-120b/ghostty_src_terminal_Parser.zig/expected.html" class="content-link">View Expected Output</a></li>
                    <li><a href="../../content/openai_gpt-oss-120b/ghostty_src_terminal_Parser.zig/actual.html" class="content-link">View Actual Output</a></li>
                </ul>
            </div>
            
            <div class="diff-section">
                <h2>Diff (Expected vs Actual)</h2>
                <div id="diff-output">
                    <pre class="diff"><div></div><div>index ed477f2d1..b6e4bb61f 100644</div><div class="diff-header">--- a/ghostty_src_terminal_Parser.zig_expectedoutput.txt (expected):tmp/tmpllvhbpep_expected.txt	</div><div class="diff-header">+++ b/ghostty_src_terminal_Parser.zig_extracted.txt (actual):tmp/tmpsrzpl5tl_actual.txt	</div><div class="diff-info">@@ -1,7 +1,6 @@</div><div> //! VT-series parser for escape and control sequences.</div><div class="diff-removed">-//!</div><div class="diff-removed">-//! This is implemented directly as the state machine described on</div><div class="diff-removed">-//! vt100.net: https://vt100.net/emu/dec_ansi_parser</div><div class="diff-added">+/// This is implemented directly as the state machine described on</div><div class="diff-added">+/// vt100.net: https://vt100.net/emu/dec_ansi_parser</div><div> const Parser = @This();</div><div> </div><div> const std = @import("std");</div><div class="diff-info">@@ -31,9 +30,7 @@ pub const State = enum {</div><div>     sos_pm_apc_string,</div><div> };</div><div> </div><div class="diff-removed">-/// Transition action is an action that can be taken during a state</div><div class="diff-removed">-/// transition. This is more of an internal action, not one used by</div><div class="diff-removed">-/// end users, typically.</div><div class="diff-added">+/// Actions that can be taken during a state transition.</div><div> pub const TransitionAction = enum {</div><div>     none,</div><div>     ignore,</div><div class="diff-info">@@ -48,182 +45,130 @@ pub const TransitionAction = enum {</div><div>     apc_put,</div><div> };</div><div> </div><div class="diff-removed">-/// Action is the action that a caller of the parser is expected to</div><div class="diff-removed">-/// take as a result of some input character.</div><div class="diff-added">+/// Action is the action that a caller of the parser is expected</div><div class="diff-added">+/// to take as a result of some input character.</div><div> pub const Action = union(enum) {</div><div>     pub const Tag = std.meta.FieldEnum(Action);</div><div> </div><div class="diff-removed">-    /// Draw character to the screen. This is a unicode codepoint.</div><div class="diff-added">+    // Draw character to the screen. This is a unicode codepoint.</div><div>     print: u21,</div><div> </div><div class="diff-removed">-    /// Execute the C0 or C1 function.</div><div class="diff-added">+    // Execute the C0 or C1 function.</div><div>     execute: u8,</div><div> </div><div class="diff-removed">-    /// Execute the CSI command. Note that pointers within this</div><div class="diff-removed">-    /// structure are only valid until the next call to "next".</div><div class="diff-removed">-    csi_dispatch: CSI,</div><div class="diff-removed">-</div><div class="diff-removed">-    /// Execute the ESC command.</div><div class="diff-added">+    // Execute an ESC command.</div><div>     esc_dispatch: ESC,</div><div> </div><div class="diff-removed">-    /// Execute the OSC command.</div><div class="diff-added">+    // Execute an OSC command.</div><div>     osc_dispatch: osc.Command,</div><div> </div><div class="diff-removed">-    /// DCS-related events.</div><div class="diff-added">+    // DCS related events.</div><div>     dcs_hook: DCS,</div><div>     dcs_put: u8,</div><div>     dcs_unhook: void,</div><div> </div><div class="diff-removed">-    /// APC data</div><div class="diff-added">+    // APC data.</div><div>     apc_start: void,</div><div>     apc_put: u8,</div><div>     apc_end: void,</div><div> </div><div class="diff-removed">-    pub const CSI = struct {</div><div class="diff-removed">-        intermediates: []u8,</div><div class="diff-removed">-        params: []u16,</div><div class="diff-removed">-        params_sep: SepList,</div><div class="diff-removed">-        final: u8,</div><div class="diff-added">+    // CSI dispatch.</div><div class="diff-added">+    csi_dispatch: CSI,</div><div> </div><div class="diff-removed">-        /// The list of separators used for CSI params. The value of the</div><div class="diff-removed">-        /// bit can be mapped to Sep. The index of this bit set specifies</div><div class="diff-removed">-        /// the separator AFTER that param. For example: 0;4:3 would have</div><div class="diff-removed">-        /// index 1 set.</div><div class="diff-removed">-        pub const SepList = std.StaticBitSet(MAX_PARAMS);</div><div class="diff-added">+    pub const DCS = struct {</div><div class="diff-added">+        intermediates: []const u8 = "";</div><div class="diff-added">+        params: []const u16 = &.{};</div><div class="diff-added">+        final: u8,</div><div class="diff-added">+    };</div><div> </div><div class="diff-removed">-        /// The separator used for CSI params.</div><div class="diff-removed">-        pub const Sep = enum(u1) { semicolon = 0, colon = 1 };</div><div class="diff-added">+    pub const ESC = struct {</div><div class="diff-added">+        intermediates: []u8,</div><div class="diff-added">+        final: u8,</div><div> </div><div class="diff-removed">-        // Implement formatter for logging</div><div>         pub fn format(</div><div class="diff-removed">-            self: CSI,</div><div class="diff-added">+            self: ESC,</div><div>             comptime layout: []const u8,</div><div>             opts: std.fmt.FormatOptions,</div><div>             writer: anytype,</div><div>         ) !void {</div><div>             _ = layout;</div><div>             _ = opts;</div><div class="diff-removed">-            try std.fmt.format(writer, "ESC [ {s} {any} {c}", .{</div><div class="diff-removed">-                self.intermediates,</div><div class="diff-removed">-                self.params,</div><div class="diff-removed">-                self.final,</div><div class="diff-removed">-            });</div><div class="diff-added">+            try std.fmt.format(</div><div class="diff-added">+                writer,</div><div class="diff-added">+                "ESC {s} {c}",</div><div class="diff-added">+                .{</div><div class="diff-added">+                    self.intermediates,</div><div class="diff-added">+                    self.final,</div><div class="diff-added">+                },</div><div class="diff-added">+            );</div><div>         }</div><div>     };</div><div> </div><div class="diff-removed">-    pub const ESC = struct {</div><div class="diff-added">+    pub const CSI = struct {</div><div class="diff-added">+        // Collected intermediate characters. This overlaps with</div><div class="diff-added">+        // the UTF-8 decoder array; max length 4.</div><div>         intermediates: []u8,</div><div class="diff-removed">-        final: u8,</div><div class="diff-added">+        // Parsed parameters.</div><div class="diff-added">+        params: []u16,</div><div class="diff-added">+        // The list of separators used for CSI parameters; the</div><div class="diff-added">+        // bit can be mapped to Sep. The index of this bit</div><div class="diff-added">+        // set specifies the separator AFTER that param.</div><div class="diff-added">+        // For example: 0;4:3 would have index 1 set.</div><div class="diff-added">+        const Sep = enum(u1) { semicolon = 0, colon = 1 };</div><div class="diff-added">+        pub const SepList = std.StaticBitSet(@intFromEnum(@as(c_int, 0)));</div><div class="diff-added">+</div><div class="diff-added">+        const SepList = std.StaticBitSet(MAX_PARAMS);</div><div> </div><div class="diff-removed">-        // Implement formatter for logging</div><div class="diff-added">+        // The selector used for the SGR sequence.</div><div class="diff-added">+        pub const Sep = enum(u1) { semicolon = 0, colon = 1 };</div><div class="diff-added">+</div><div class="diff-added">+        // Implement formatter for logging.</div><div>         pub fn format(</div><div class="diff-removed">-            self: ESC,</div><div class="diff-added">+            self: CSI,</div><div>             comptime layout: []const u8,</div><div>             opts: std.fmt.FormatOptions,</div><div>             writer: anytype,</div><div>         ) !void {</div><div>             _ = layout;</div><div>             _ = opts;</div><div class="diff-removed">-            try std.fmt.format(writer, "ESC {s} {c}", .{</div><div class="diff-removed">-                self.intermediates,</div><div class="diff-removed">-                self.final,</div><div class="diff-removed">-            });</div><div class="diff-added">+            try std.fmt.format(</div><div class="diff-added">+                writer,</div><div class="diff-added">+                "ESC [ {s} {any} {c}",</div><div class="diff-added">+                .{</div><div class="diff-added">+                    self.intermediates,</div><div class="diff-added">+                    self.params,</div><div class="diff-added">+                    self.final,</div><div class="diff-added">+                },</div><div class="diff-added">+            );</div><div>         }</div><div>     };</div><div class="diff-removed">-</div><div class="diff-removed">-    pub const DCS = struct {</div><div class="diff-removed">-        intermediates: []const u8 = "",</div><div class="diff-removed">-        params: []const u16 = &.{},</div><div class="diff-removed">-        final: u8,</div><div class="diff-removed">-    };</div><div class="diff-removed">-</div><div class="diff-removed">-    // Implement formatter for logging. This is mostly copied from the</div><div class="diff-removed">-    // std.fmt implementation, but we modify it slightly so that we can</div><div class="diff-removed">-    // print out custom formats for some of our primitives.</div><div class="diff-removed">-    pub fn format(</div><div class="diff-removed">-        self: Action,</div><div class="diff-removed">-        comptime layout: []const u8,</div><div class="diff-removed">-        opts: std.fmt.FormatOptions,</div><div class="diff-removed">-        writer: anytype,</div><div class="diff-removed">-    ) !void {</div><div class="diff-removed">-        _ = layout;</div><div class="diff-removed">-        const T = Action;</div><div class="diff-removed">-        const info = @typeInfo(T).@"union";</div><div class="diff-removed">-</div><div class="diff-removed">-        try writer.writeAll(@typeName(T));</div><div class="diff-removed">-        if (info.tag_type) |TagType| {</div><div class="diff-removed">-            try writer.writeAll("{ .");</div><div class="diff-removed">-            try writer.writeAll(@tagName(@as(TagType, self)));</div><div class="diff-removed">-            try writer.writeAll(" = ");</div><div class="diff-removed">-</div><div class="diff-removed">-            inline for (info.fields) |u_field| {</div><div class="diff-removed">-                // If this is the active field...</div><div class="diff-removed">-                if (self == @field(TagType, u_field.name)) {</div><div class="diff-removed">-                    const value = @field(self, u_field.name);</div><div class="diff-removed">-                    switch (@TypeOf(value)) {</div><div class="diff-removed">-                        // Unicode</div><div class="diff-removed">-                        u21 => try std.fmt.format(writer, "'{u}' (U+{X})", .{ value, value }),</div><div class="diff-removed">-</div><div class="diff-removed">-                        // Byte</div><div class="diff-removed">-                        u8 => try std.fmt.format(writer, "0x{x}", .{value}),</div><div class="diff-removed">-</div><div class="diff-removed">-                        // Note: we don't do ASCII (u8) because there are a lot</div><div class="diff-removed">-                        // of invisible characters we don't want to handle right</div><div class="diff-removed">-                        // now.</div><div class="diff-removed">-</div><div class="diff-removed">-                        // All others do the default behavior</div><div class="diff-removed">-                        else => try std.fmt.formatType(</div><div class="diff-removed">-                            @field(self, u_field.name),</div><div class="diff-removed">-                            "any",</div><div class="diff-removed">-                            opts,</div><div class="diff-removed">-                            writer,</div><div class="diff-removed">-                            3,</div><div class="diff-removed">-                        ),</div><div class="diff-removed">-                    }</div><div class="diff-removed">-                }</div><div class="diff-removed">-            }</div><div class="diff-removed">-</div><div class="diff-removed">-            try writer.writeAll(" }");</div><div class="diff-removed">-        } else {</div><div class="diff-removed">-            try format(writer, "@{x}", .{@intFromPtr(&self)});</div><div class="diff-removed">-        }</div><div class="diff-removed">-    }</div><div> };</div><div> </div><div class="diff-removed">-/// Maximum number of intermediate characters during parsing. This is</div><div class="diff-removed">-/// 4 because we also use the intermediates array for UTF8 decoding which</div><div class="diff-removed">-/// can be at most 4 bytes.</div><div class="diff-added">+/// Maximum number of intermediate characters during</div><div class="diff-added">+/// parsing. 4 because the same array is used for UTF8</div><div class="diff-added">+/// decoding and this can be at most 4 bytes.</div><div> const MAX_INTERMEDIATE = 4;</div><div> </div><div class="diff-removed">-/// Maximum number of CSI parameters. This is arbitrary. Practically, the</div><div class="diff-removed">-/// only CSI command that uses more than 3 parameters is the SGR command</div><div class="diff-removed">-/// which can be infinitely long. 24 is a reasonable limit based on empirical</div><div class="diff-removed">-/// data. This used to be 16 but Kakoune has a SGR command that uses 17</div><div class="diff-removed">-/// parameters.</div><div class="diff-removed">-///</div><div class="diff-removed">-/// We could in the future make this the static limit and then allocate after</div><div class="diff-removed">-/// but that's a lot more work and practically its so rare to exceed this</div><div class="diff-removed">-/// number. I implore TUI authors to not use more than this number of CSI</div><div class="diff-removed">-/// params, but I suspect we'll introduce a slow path with heap allocation</div><div class="diff-removed">-/// one day.</div><div class="diff-added">+/// Maximum number of CSI parameters. 24 is a sane limit</div><div class="diff-added">+/// that covers most real-world sequences.</div><div> const MAX_PARAMS = 24;</div><div> </div><div class="diff-removed">-/// Current state of the state machine</div><div class="diff-added">+/// Current state of the state machine.</div><div> state: State = .ground,</div><div> </div><div class="diff-removed">-/// Intermediate tracking.</div><div class="diff-added">+/// Intermediate tracking (including UTF‑8 accumulator).</div><div> intermediates: [MAX_INTERMEDIATE]u8 = undefined,</div><div> intermediates_idx: u8 = 0,</div><div> </div><div class="diff-removed">-/// Param tracking, building</div><div class="diff-added">+/// Parameter tracking, building.</div><div> params: [MAX_PARAMS]u16 = undefined,</div><div class="diff-removed">-params_sep: Action.CSI.SepList = Action.CSI.SepList.initEmpty(),</div><div> params_idx: u8 = 0,</div><div class="diff-added">+params_sep: Action.CSI.SepList = Action.CSI.SepList.initEmpty(),</div><div> param_acc: u16 = 0,</div><div> param_acc_idx: u8 = 0,</div><div> </div><div class="diff-removed">-/// Parser for OSC sequences</div><div class="diff-removed">-osc_parser: osc.Parser = .{},</div><div class="diff-added">+/// OSC parser for operating‑system‑control sequences.</div><div class="diff-added">+osc_parser: osc.Parser = .{};</div><div> </div><div> pub fn init() Parser {</div><div>     return .{};</div><div class="diff-info">@@ -233,51 +178,55 @@ pub fn deinit(self: *Parser) void {</div><div>     self.osc_parser.deinit();</div><div> }</div><div> </div><div class="diff-removed">-/// Next consumes the next character c and returns the actions to execute.</div><div class="diff-removed">-/// Up to 3 actions may need to be executed -- in order -- representing</div><div class="diff-removed">-/// the state exit, transition, and entry actions.</div><div> pub fn next(self: *Parser, c: u8) [3]?Action {</div><div class="diff-added">+    // Table lookup for the current state.</div><div>     const effect = table[c][@intFromEnum(self.state)];</div><div> </div><div class="diff-removed">-    // log.info("next: {x}", .{c});</div><div class="diff-removed">-</div><div>     const next_state = effect.state;</div><div>     const action = effect.action;</div><div> </div><div>     // After generating the actions, we set our next state.</div><div>     defer self.state = next_state;</div><div> </div><div class="diff-removed">-    // When going from one state to another, the actions take place in this order:</div><div class="diff-removed">-    //</div><div class="diff-removed">-    // 1. exit action from old state</div><div class="diff-removed">-    // 2. transition action</div><div class="diff-removed">-    // 3. entry action to new state</div><div class="diff-removed">-    return [3]?Action{</div><div class="diff-removed">-        // Exit depends on current state</div><div class="diff-removed">-        if (self.state == next_state) null else switch (self.state) {</div><div class="diff-removed">-            .osc_string => if (self.osc_parser.end(c)) |cmd|</div><div class="diff-removed">-                Action{ .osc_dispatch = cmd }</div><div class="diff-removed">-            else</div><div class="diff-removed">-                null,</div><div class="diff-removed">-            .dcs_passthrough => Action{ .dcs_unhook = {} },</div><div class="diff-removed">-            .sos_pm_apc_string => Action{ .apc_end = {} },</div><div class="diff-removed">-            else => null,</div><div class="diff-removed">-        },</div><div class="diff-added">+    // In debug mode, log a warning if we accidentally</div><div class="diff-added">+    // transition to 'anywhere' (should never happen).</div><div class="diff-added">+    if (builtin.mode == .Debug) {</div><div class="diff-added">+        if (next_state == .anywhere) {</div><div class="diff-added">+            log.debug(</div><div class="diff-added">+                "state transition to 'anywhere' from '{}' with byte {x}",</div><div class="diff-added">+                .{ self.state, c },</div><div class="diff-added">+            );</div><div class="diff-added">+        }</div><div class="diff-added">+    }</div><div> </div><div class="diff-removed">-        self.doAction(action, c),</div><div class="diff-added">+    // Return the three possibly‑null actions:</div><div class="diff-added">+    //   0: exit action from the old state,</div><div class="diff-added">+    //   1: transition action,</div><div class="diff-added">+    //   2: entry action for the new state.</div><div class="diff-added">+    const exit: ?Action = if (self.state == next_state)</div><div class="diff-added">+        null</div><div class="diff-added">+    else switch (self.state) {</div><div class="diff-added">+        .osc_string => if (self.osc_parser.end(c)) |cmd|</div><div class="diff-added">+            Action{ .osc_dispatch = cmd }</div><div class="diff-added">+        else</div><div class="diff-added">+            null,</div><div class="diff-added">+        .dcs_passthrough => Action{ .dcs_unhook = {} },</div><div class="diff-added">+        .sos_pm_apc_string => Action{ .apc_end = {} },</div><div class="diff-added">+        else => null,</div><div class="diff-added">+    };</div><div> </div><div class="diff-removed">-        // Entry depends on new state</div><div class="diff-removed">-        if (self.state == next_state) null else switch (next_state) {</div><div class="diff-removed">-            .escape, .dcs_entry, .csi_entry => clear: {</div><div class="diff-removed">-                self.clear();</div><div class="diff-removed">-                break :clear null;</div><div class="diff-removed">-            },</div><div class="diff-removed">-            .osc_string => osc_string: {</div><div class="diff-removed">-                self.osc_parser.reset();</div><div class="diff-removed">-                break :osc_string null;</div><div class="diff-removed">-            },</div><div class="diff-removed">-            .dcs_passthrough => dcs_hook: {</div><div class="diff-removed">-                // Finalize parameters</div><div class="diff-added">+    const transition = self.doAction(action, c);</div><div class="diff-added">+</div><div class="diff-added">+    const entry: ?Action = if (self.state == next_state)</div><div class="diff-added">+        null</div><div class="diff-added">+    else switch (next_state) {</div><div class="diff-added">+        .escape, .csi_entry, .dcs_entry => {</div><div class="diff-added">+            self.clear();</div><div class="diff-added">+            break :entry null;</div><div class="diff-added">+        },</div><div class="diff-added">+</div><div class="diff-added">+        .dcs_passthrough => dcs_hook: {</div><div class="diff-added">+            // Finalize any pending parameter.</div><div>                 if (self.param_acc_idx > 0) {</div><div>                     self.params[self.params_idx] = self.param_acc;</div><div>                     self.params_idx += 1;</div><div class="diff-info">@@ -290,72 +239,91 @@ pub fn next(self: *Parser, c: u8) [3]?Action {</div><div>                     },</div><div>                 };</div><div>             },</div><div class="diff-removed">-            .sos_pm_apc_string => Action{ .apc_start = {} },</div><div class="diff-removed">-            else => null,</div><div class="diff-added">+</div><div class="diff-added">+        .sos_pm_apc_string => Action{ .apc_start = {} },</div><div class="diff-added">+</div><div class="diff-added">+        .osc_string => {</div><div class="diff-added">+            self.osc_parser.reset();</div><div class="diff-added">+            break :null null;</div><div>         },</div><div class="diff-added">+</div><div class="diff-added">+        else => null,</div><div>     };</div><div class="diff-added">+</div><div class="diff-added">+    return .{ exit, transition, entry };</div><div> }</div><div> </div><div class="diff-added">+// Collect a character into the intermediate array.</div><div> pub fn collect(self: *Parser, c: u8) void {</div><div>     if (self.intermediates_idx >= MAX_INTERMEDIATE) {</div><div class="diff-removed">-        log.warn("invalid intermediates count", .{});</div><div class="diff-added">+        log.warn("intermediates overflow", .{});</div><div>         return;</div><div>     }</div><div class="diff-removed">-</div><div>     self.intermediates[self.intermediates_idx] = c;</div><div>     self.intermediates_idx += 1;</div><div> }</div><div> </div><div class="diff-added">+// Reset parser state for a new sequence.</div><div class="diff-added">+pub fn clear(self: *Parser) void {</div><div class="diff-added">+    self.intermediates_idx = 0;</div><div class="diff-added">+    self.params_idx = 0;</div><div class="diff-added">+    self.params_sep = Action.CSI.SepList.initEmpty();</div><div class="diff-added">+    self.param_acc = 0;</div><div class="diff-added">+    self.param_acc_idx = 0;</div><div class="diff-added">+}</div><div class="diff-added">+</div><div class="diff-added">+// Perform a transition action (may generate a user‑visible action</div><div class="diff-added">+// such as an output character, an ESC dispatch, etc.).</div><div> fn doAction(self: *Parser, action: TransitionAction, c: u8) ?Action {</div><div>     return switch (action) {</div><div>         .none, .ignore => null,</div><div class="diff-added">+</div><div>         .print => Action{ .print = c },</div><div class="diff-added">+</div><div>         .execute => Action{ .execute = c },</div><div class="diff-added">+</div><div>         .collect => collect: {</div><div>             self.collect(c);</div><div>             break :collect null;</div><div>         },</div><div class="diff-removed">-        .param => param: {</div><div class="diff-removed">-            // Semicolon separates parameters. If we encounter a semicolon</div><div class="diff-removed">-            // we need to store and move on to the next parameter.</div><div class="diff-removed">-            if (c == ';' or c == ':') {</div><div class="diff-removed">-                // Ignore too many parameters</div><div class="diff-removed">-                if (self.params_idx >= MAX_PARAMS) break :param null;</div><div> </div><div class="diff-removed">-                // Set param final value</div><div class="diff-removed">-                self.params[self.params_idx] = self.param_acc;</div><div class="diff-removed">-                if (c == ':') self.params_sep.set(self.params_idx);</div><div class="diff-removed">-                self.params_idx += 1;</div><div class="diff-added">+        .param => param: {</div><div class="diff-added">+            // Too many parameters?</div><div class="diff-added">+            if (self.params_idx >= MAX_PARAMS) break :param null;</div><div> </div><div class="diff-removed">-                // Reset current param value to 0</div><div class="diff-added">+            // Semicolon or colon separates parameters.</div><div class="diff-added">+            if (c == ';' or c == ':') {</div><div class="diff-added">+                // Save current parameter.</div><div class="diff-added">+                if (self.param_acc_idx > 0) {</div><div class="diff-added">+                    self.params[self.params_idx] = self.param_acc;</div><div class="diff-added">+                    if (c == ':') self.params_sep.set(self.params_idx);</div><div class="diff-added">+                    self.params_idx += 1;</div><div class="diff-added">+                }</div><div class="diff-added">+                // Reset accumulator.</div><div>                 self.param_acc = 0;</div><div>                 self.param_acc_idx = 0;</div><div>                 break :param null;</div><div>             }</div><div> </div><div class="diff-removed">-            // A numeric value. Add it to our accumulator.</div><div class="diff-added">+            // Numeric parameter.</div><div>             if (self.param_acc_idx > 0) {</div><div>                 self.param_acc *|= 10;</div><div>             }</div><div>             self.param_acc +|= c - '0';</div><div class="diff-removed">-</div><div class="diff-removed">-            // Increment our accumulator index. If we overflow then</div><div class="diff-removed">-            // we're out of bounds and we exit immediately.</div><div class="diff-removed">-            self.param_acc_idx, const overflow = @addWithOverflow(self.param_acc_idx, 1);</div><div class="diff-removed">-            if (overflow > 0) break :param null;</div><div class="diff-removed">-</div><div class="diff-removed">-            // The client is expected to perform no action.</div><div class="diff-added">+            const overflow = @addWithOverflow(&self.param_acc_idx, 1);</div><div class="diff-added">+            if (overflow) break :null null;</div><div>             break :param null;</div><div>         },</div><div class="diff-removed">-        .osc_put => osc_put: {</div><div class="diff-removed">-            self.osc_parser.next(c);</div><div class="diff-removed">-            break :osc_put null;</div><div class="diff-added">+</div><div class="diff-added">+        .esc_dispatch => Action{</div><div class="diff-added">+            .esc_dispatch = .{</div><div class="diff-added">+                .intermediates = self.intermediates[0..self.intermediates_idx],</div><div class="diff-added">+                .final = c,</div><div class="diff-added">+            },</div><div>         },</div><div class="diff-removed">-        .csi_dispatch => csi_dispatch: {</div><div class="diff-removed">-            // Ignore too many parameters</div><div class="diff-removed">-            if (self.params_idx >= MAX_PARAMS) break :csi_dispatch null;</div><div> </div><div class="diff-removed">-            // Finalize parameters if we have one</div><div class="diff-added">+        .csi_dispatch => csi_dispatch: {</div><div class="diff-added">+            // Finalize any remaining parameter.</div><div>             if (self.param_acc_idx > 0) {</div><div>                 self.params[self.params_idx] = self.param_acc;</div><div>                 self.params_idx += 1;</div><div class="diff-info">@@ -370,7 +338,8 @@ fn doAction(self: *Parser, action: TransitionAction, c: u8) ?Action {</div><div>                 },</div><div>             };</div><div> </div><div class="diff-removed">-            // We only allow colon or mixed separators for the 'm' command.</div><div class="diff-added">+            // Only the SGR command (final byte 'm') may</div><div class="diff-added">+            // contain colon-separated parameters.</div><div>             if (c != 'm' and self.params_sep.count() > 0) {</div><div>                 log.warn(</div><div>                     "CSI colon or mixed separators only allowed for 'm' command, got: {}",</div><div class="diff-info">@@ -381,584 +350,60 @@ fn doAction(self: *Parser, action: TransitionAction, c: u8) ?Action {</div><div> </div><div>             break :csi_dispatch result;</div><div>         },</div><div class="diff-removed">-        .esc_dispatch => Action{</div><div class="diff-removed">-            .esc_dispatch = .{</div><div class="diff-removed">-                .intermediates = self.intermediates[0..self.intermediates_idx],</div><div class="diff-removed">-                .final = c,</div><div class="diff-removed">-            },</div><div class="diff-removed">-        },</div><div class="diff-removed">-        .put => Action{ .dcs_put = c },</div><div class="diff-removed">-        .apc_put => Action{ .apc_put = c },</div><div class="diff-removed">-    };</div><div class="diff-removed">-}</div><div> </div><div class="diff-removed">-pub fn clear(self: *Parser) void {</div><div class="diff-removed">-    self.intermediates_idx = 0;</div><div class="diff-removed">-    self.params_idx = 0;</div><div class="diff-removed">-    self.params_sep = Action.CSI.SepList.initEmpty();</div><div class="diff-removed">-    self.param_acc = 0;</div><div class="diff-removed">-    self.param_acc_idx = 0;</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-test {</div><div class="diff-removed">-    var p = init();</div><div class="diff-removed">-    _ = p.next(0x9E);</div><div class="diff-removed">-    try testing.expect(p.state == .sos_pm_apc_string);</div><div class="diff-removed">-    _ = p.next(0x9C);</div><div class="diff-removed">-    try testing.expect(p.state == .ground);</div><div class="diff-removed">-</div><div class="diff-removed">-    {</div><div class="diff-removed">-        const a = p.next('a');</div><div class="diff-removed">-        try testing.expect(p.state == .ground);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1].? == .print);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    {</div><div class="diff-removed">-        const a = p.next(0x19);</div><div class="diff-removed">-        try testing.expect(p.state == .ground);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1].? == .execute);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-test "esc: ESC ( B" {</div><div class="diff-removed">-    var p = init();</div><div class="diff-removed">-    _ = p.next(0x1B);</div><div class="diff-removed">-    _ = p.next('(');</div><div class="diff-removed">-</div><div class="diff-removed">-    {</div><div class="diff-removed">-        const a = p.next('B');</div><div class="diff-removed">-        try testing.expect(p.state == .ground);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1].? == .esc_dispatch);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-</div><div class="diff-removed">-        const d = a[1].?.esc_dispatch;</div><div class="diff-removed">-        try testing.expect(d.final == 'B');</div><div class="diff-removed">-        try testing.expect(d.intermediates.len == 1);</div><div class="diff-removed">-        try testing.expect(d.intermediates[0] == '(');</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-test "csi: ESC [ H" {</div><div class="diff-removed">-    var p = init();</div><div class="diff-removed">-    _ = p.next(0x1B);</div><div class="diff-removed">-    _ = p.next(0x5B);</div><div class="diff-removed">-</div><div class="diff-removed">-    {</div><div class="diff-removed">-        const a = p.next(0x48);</div><div class="diff-removed">-        try testing.expect(p.state == .ground);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1].? == .csi_dispatch);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-</div><div class="diff-removed">-        const d = a[1].?.csi_dispatch;</div><div class="diff-removed">-        try testing.expect(d.final == 0x48);</div><div class="diff-removed">-        try testing.expect(d.params.len == 0);</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-test "csi: ESC [ 1 ; 4 H" {</div><div class="diff-removed">-    var p = init();</div><div class="diff-removed">-    _ = p.next(0x1B);</div><div class="diff-removed">-    _ = p.next(0x5B);</div><div class="diff-removed">-    _ = p.next(0x31); // 1</div><div class="diff-removed">-    _ = p.next(0x3B); // ;</div><div class="diff-removed">-    _ = p.next(0x34); // 4</div><div class="diff-removed">-</div><div class="diff-removed">-    {</div><div class="diff-removed">-        const a = p.next(0x48); // H</div><div class="diff-removed">-        try testing.expect(p.state == .ground);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1].? == .csi_dispatch);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-</div><div class="diff-removed">-        const d = a[1].?.csi_dispatch;</div><div class="diff-removed">-        try testing.expect(d.final == 'H');</div><div class="diff-removed">-        try testing.expect(d.params.len == 2);</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 1), d.params[0]);</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 4), d.params[1]);</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-test "csi: SGR ESC [ 38 : 2 m" {</div><div class="diff-removed">-    var p = init();</div><div class="diff-removed">-    _ = p.next(0x1B);</div><div class="diff-removed">-    _ = p.next('[');</div><div class="diff-removed">-    _ = p.next('3');</div><div class="diff-removed">-    _ = p.next('8');</div><div class="diff-removed">-    _ = p.next(':');</div><div class="diff-removed">-    _ = p.next('2');</div><div class="diff-removed">-</div><div class="diff-removed">-    {</div><div class="diff-removed">-        const a = p.next('m');</div><div class="diff-removed">-        try testing.expect(p.state == .ground);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1].? == .csi_dispatch);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-</div><div class="diff-removed">-        const d = a[1].?.csi_dispatch;</div><div class="diff-removed">-        try testing.expect(d.final == 'm');</div><div class="diff-removed">-        try testing.expect(d.params.len == 2);</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 38), d.params[0]);</div><div class="diff-removed">-        try testing.expect(d.params_sep.isSet(0));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 2), d.params[1]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(1));</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-test "csi: SGR colon followed by semicolon" {</div><div class="diff-removed">-    var p = init();</div><div class="diff-removed">-    _ = p.next(0x1B);</div><div class="diff-removed">-    for ("[48:2") |c| {</div><div class="diff-removed">-        const a = p.next(c);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1] == null);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    {</div><div class="diff-removed">-        const a = p.next('m');</div><div class="diff-removed">-        try testing.expect(p.state == .ground);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1].? == .csi_dispatch);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    _ = p.next(0x1B);</div><div class="diff-removed">-    _ = p.next('[');</div><div class="diff-removed">-    {</div><div class="diff-removed">-        const a = p.next('H');</div><div class="diff-removed">-        try testing.expect(p.state == .ground);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1].? == .csi_dispatch);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-test "csi: SGR mixed colon and semicolon" {</div><div class="diff-removed">-    var p = init();</div><div class="diff-removed">-    _ = p.next(0x1B);</div><div class="diff-removed">-    for ("[38:5:1;48:5:0") |c| {</div><div class="diff-removed">-        const a = p.next(c);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1] == null);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    {</div><div class="diff-removed">-        const a = p.next('m');</div><div class="diff-removed">-        try testing.expect(p.state == .ground);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1].? == .csi_dispatch);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-test "csi: SGR ESC [ 48 : 2 m" {</div><div class="diff-removed">-    var p = init();</div><div class="diff-removed">-    _ = p.next(0x1B);</div><div class="diff-removed">-    for ("[48:2:240:143:104") |c| {</div><div class="diff-removed">-        const a = p.next(c);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1] == null);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    {</div><div class="diff-removed">-        const a = p.next('m');</div><div class="diff-removed">-        try testing.expect(p.state == .ground);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1].? == .csi_dispatch);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-</div><div class="diff-removed">-        const d = a[1].?.csi_dispatch;</div><div class="diff-removed">-        try testing.expect(d.final == 'm');</div><div class="diff-removed">-        try testing.expect(d.params.len == 5);</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 48), d.params[0]);</div><div class="diff-removed">-        try testing.expect(d.params_sep.isSet(0));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 2), d.params[1]);</div><div class="diff-removed">-        try testing.expect(d.params_sep.isSet(1));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 240), d.params[2]);</div><div class="diff-removed">-        try testing.expect(d.params_sep.isSet(2));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 143), d.params[3]);</div><div class="diff-removed">-        try testing.expect(d.params_sep.isSet(3));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 104), d.params[4]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(4));</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-test "csi: SGR ESC [4:3m colon" {</div><div class="diff-removed">-    var p = init();</div><div class="diff-removed">-    _ = p.next(0x1B);</div><div class="diff-removed">-    _ = p.next('[');</div><div class="diff-removed">-    _ = p.next('4');</div><div class="diff-removed">-    _ = p.next(':');</div><div class="diff-removed">-    _ = p.next('3');</div><div class="diff-removed">-</div><div class="diff-removed">-    {</div><div class="diff-removed">-        const a = p.next('m');</div><div class="diff-removed">-        try testing.expect(p.state == .ground);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1].? == .csi_dispatch);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-</div><div class="diff-removed">-        const d = a[1].?.csi_dispatch;</div><div class="diff-removed">-        try testing.expect(d.final == 'm');</div><div class="diff-removed">-        try testing.expect(d.params.len == 2);</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 4), d.params[0]);</div><div class="diff-removed">-        try testing.expect(d.params_sep.isSet(0));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 3), d.params[1]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(1));</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-test "csi: SGR with many blank and colon" {</div><div class="diff-removed">-    var p = init();</div><div class="diff-removed">-    _ = p.next(0x1B);</div><div class="diff-removed">-    for ("[58:2::240:143:104") |c| {</div><div class="diff-removed">-        const a = p.next(c);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1] == null);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    {</div><div class="diff-removed">-        const a = p.next('m');</div><div class="diff-removed">-        try testing.expect(p.state == .ground);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1].? == .csi_dispatch);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-</div><div class="diff-removed">-        const d = a[1].?.csi_dispatch;</div><div class="diff-removed">-        try testing.expect(d.final == 'm');</div><div class="diff-removed">-        try testing.expect(d.params.len == 6);</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 58), d.params[0]);</div><div class="diff-removed">-        try testing.expect(d.params_sep.isSet(0));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 2), d.params[1]);</div><div class="diff-removed">-        try testing.expect(d.params_sep.isSet(1));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 0), d.params[2]);</div><div class="diff-removed">-        try testing.expect(d.params_sep.isSet(2));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 240), d.params[3]);</div><div class="diff-removed">-        try testing.expect(d.params_sep.isSet(3));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 143), d.params[4]);</div><div class="diff-removed">-        try testing.expect(d.params_sep.isSet(4));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 104), d.params[5]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(5));</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-// This is from a Kakoune actual SGR sequence.</div><div class="diff-removed">-test "csi: SGR mixed colon and semicolon with blank" {</div><div class="diff-removed">-    var p = init();</div><div class="diff-removed">-    _ = p.next(0x1B);</div><div class="diff-removed">-    for ("[;4:3;38;2;175;175;215;58:2::190:80:70") |c| {</div><div class="diff-removed">-        const a = p.next(c);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1] == null);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    {</div><div class="diff-removed">-        const a = p.next('m');</div><div class="diff-removed">-        try testing.expect(p.state == .ground);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1].? == .csi_dispatch);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-</div><div class="diff-removed">-        const d = a[1].?.csi_dispatch;</div><div class="diff-removed">-        try testing.expect(d.final == 'm');</div><div class="diff-removed">-        try testing.expectEqual(14, d.params.len);</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 0), d.params[0]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(0));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 4), d.params[1]);</div><div class="diff-removed">-        try testing.expect(d.params_sep.isSet(1));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 3), d.params[2]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(2));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 38), d.params[3]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(3));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 2), d.params[4]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(4));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 175), d.params[5]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(5));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 175), d.params[6]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(6));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 215), d.params[7]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(7));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 58), d.params[8]);</div><div class="diff-removed">-        try testing.expect(d.params_sep.isSet(8));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 2), d.params[9]);</div><div class="diff-removed">-        try testing.expect(d.params_sep.isSet(9));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 0), d.params[10]);</div><div class="diff-removed">-        try testing.expect(d.params_sep.isSet(10));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 190), d.params[11]);</div><div class="diff-removed">-        try testing.expect(d.params_sep.isSet(11));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 80), d.params[12]);</div><div class="diff-removed">-        try testing.expect(d.params_sep.isSet(12));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 70), d.params[13]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(13));</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-// This is from a Kakoune actual SGR sequence also.</div><div class="diff-removed">-test "csi: SGR mixed colon and semicolon setting underline, bg, fg" {</div><div class="diff-removed">-    var p = init();</div><div class="diff-removed">-    _ = p.next(0x1B);</div><div class="diff-removed">-    for ("[4:3;38;2;51;51;51;48;2;170;170;170;58;2;255;97;136") |c| {</div><div class="diff-removed">-        const a = p.next(c);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1] == null);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    {</div><div class="diff-removed">-        const a = p.next('m');</div><div class="diff-removed">-        try testing.expect(p.state == .ground);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1].? == .csi_dispatch);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-</div><div class="diff-removed">-        const d = a[1].?.csi_dispatch;</div><div class="diff-removed">-        try testing.expect(d.final == 'm');</div><div class="diff-removed">-        try testing.expectEqual(17, d.params.len);</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 4), d.params[0]);</div><div class="diff-removed">-        try testing.expect(d.params_sep.isSet(0));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 3), d.params[1]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(1));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 38), d.params[2]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(2));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 2), d.params[3]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(3));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 51), d.params[4]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(4));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 51), d.params[5]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(5));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 51), d.params[6]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(6));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 48), d.params[7]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(7));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 2), d.params[8]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(8));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 170), d.params[9]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(9));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 170), d.params[10]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(10));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 170), d.params[11]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(11));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 58), d.params[12]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(12));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 2), d.params[13]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(13));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 255), d.params[14]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(14));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 97), d.params[15]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(15));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 136), d.params[16]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(16));</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-test "csi: colon for non-m final" {</div><div class="diff-removed">-    var p = init();</div><div class="diff-removed">-    _ = p.next(0x1B);</div><div class="diff-removed">-    for ("[38:2h") |c| {</div><div class="diff-removed">-        const a = p.next(c);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1] == null);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    try testing.expect(p.state == .ground);</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-test "csi: request mode decrqm" {</div><div class="diff-removed">-    var p = init();</div><div class="diff-removed">-    _ = p.next(0x1B);</div><div class="diff-removed">-    for ("[?2026$") |c| {</div><div class="diff-removed">-        const a = p.next(c);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1] == null);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    {</div><div class="diff-removed">-        const a = p.next('p');</div><div class="diff-removed">-        try testing.expect(p.state == .ground);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1].? == .csi_dispatch);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-</div><div class="diff-removed">-        const d = a[1].?.csi_dispatch;</div><div class="diff-removed">-        try testing.expect(d.final == 'p');</div><div class="diff-removed">-        try testing.expectEqual(@as(usize, 2), d.intermediates.len);</div><div class="diff-removed">-        try testing.expectEqual(@as(usize, 1), d.params.len);</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, '?'), d.intermediates[0]);</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, '$'), d.intermediates[1]);</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 2026), d.params[0]);</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-added">+        .put => Action{ .dcs_put = c },</div><div> </div><div class="diff-removed">-test "csi: change cursor" {</div><div class="diff-removed">-    var p = init();</div><div class="diff-removed">-    _ = p.next(0x1B);</div><div class="diff-removed">-    for ("[3 ") |c| {</div><div class="diff-removed">-        const a = p.next(c);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1] == null);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-    }</div><div class="diff-added">+        .apc_put => Action{ .apc_put = c },</div><div> </div><div class="diff-removed">-    {</div><div class="diff-removed">-        const a = p.next('q');</div><div class="diff-removed">-        try testing.expect(p.state == .ground);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1].? == .csi_dispatch);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-</div><div class="diff-removed">-        const d = a[1].?.csi_dispatch;</div><div class="diff-removed">-        try testing.expect(d.final == 'q');</div><div class="diff-removed">-        try testing.expectEqual(@as(usize, 1), d.intermediates.len);</div><div class="diff-removed">-        try testing.expectEqual(@as(usize, 1), d.params.len);</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, ' '), d.intermediates[0]);</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 3), d.params[0]);</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-added">+        .osc_put => {</div><div class="diff-added">+            self.osc_parser.next(c);</div><div class="diff-added">+            break :null null;</div><div class="diff-added">+        },</div><div> </div><div class="diff-removed">-test "osc: change window title" {</div><div class="diff-removed">-    var p = init();</div><div class="diff-removed">-    _ = p.next(0x1B);</div><div class="diff-removed">-    _ = p.next(']');</div><div class="diff-removed">-    _ = p.next('0');</div><div class="diff-removed">-    _ = p.next(';');</div><div class="diff-removed">-    _ = p.next('a');</div><div class="diff-removed">-    _ = p.next('b');</div><div class="diff-removed">-    _ = p.next('c');</div><div class="diff-removed">-</div><div class="diff-removed">-    {</div><div class="diff-removed">-        const a = p.next(0x07); // BEL</div><div class="diff-removed">-        try testing.expect(p.state == .ground);</div><div class="diff-removed">-        try testing.expect(a[0].? == .osc_dispatch);</div><div class="diff-removed">-        try testing.expect(a[1] == null);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-</div><div class="diff-removed">-        const cmd = a[0].?.osc_dispatch;</div><div class="diff-removed">-        try testing.expect(cmd == .change_window_title);</div><div class="diff-removed">-        try testing.expectEqualStrings("abc", cmd.change_window_title);</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-added">+        .apc_put => {</div><div class="diff-added">+            // Not used elsewhere.</div><div class="diff-added">+            break :null null;</div><div class="diff-added">+        },</div><div> </div><div class="diff-removed">-test "osc: change window title (end in esc)" {</div><div class="diff-removed">-    var p = init();</div><div class="diff-removed">-    _ = p.next(0x1B);</div><div class="diff-removed">-    _ = p.next(']');</div><div class="diff-removed">-    _ = p.next('0');</div><div class="diff-removed">-    _ = p.next(';');</div><div class="diff-removed">-    _ = p.next('a');</div><div class="diff-removed">-    _ = p.next('b');</div><div class="diff-removed">-    _ = p.next('c');</div><div class="diff-removed">-</div><div class="diff-removed">-    {</div><div class="diff-removed">-        const a = p.next(0x1B);</div><div class="diff-removed">-        _ = p.next('\\');</div><div class="diff-removed">-        try testing.expect(p.state == .ground);</div><div class="diff-removed">-        try testing.expect(a[0].? == .osc_dispatch);</div><div class="diff-removed">-        try testing.expect(a[1] == null);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-</div><div class="diff-removed">-        const cmd = a[0].?.osc_dispatch;</div><div class="diff-removed">-        try testing.expect(cmd == .change_window_title);</div><div class="diff-removed">-        try testing.expectEqualStrings("abc", cmd.change_window_title);</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-added">+        .apc_put => {</div><div class="diff-added">+            // Placeholder for future APC handling</div><div class="diff-added">+            break :null null;</div><div class="diff-added">+        },</div><div> </div><div class="diff-removed">-// https://github.com/darrenstarr/VtNetCore/pull/14</div><div class="diff-removed">-// Saw this on HN, decided to add a test case because why not.</div><div class="diff-removed">-test "osc: 112 incomplete sequence" {</div><div class="diff-removed">-    var p = init();</div><div class="diff-removed">-    _ = p.next(0x1B);</div><div class="diff-removed">-    _ = p.next(']');</div><div class="diff-removed">-    _ = p.next('1');</div><div class="diff-removed">-    _ = p.next('1');</div><div class="diff-removed">-    _ = p.next('2');</div><div class="diff-removed">-</div><div class="diff-removed">-    {</div><div class="diff-removed">-        const a = p.next(0x07);</div><div class="diff-removed">-        try testing.expect(p.state == .ground);</div><div class="diff-removed">-        try testing.expect(a[0].? == .osc_dispatch);</div><div class="diff-removed">-        try testing.expect(a[1] == null);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-</div><div class="diff-removed">-        const cmd = a[0].?.osc_dispatch;</div><div class="diff-removed">-        try testing.expect(cmd == .reset_color);</div><div class="diff-removed">-        try testing.expectEqual(cmd.reset_color.kind, .cursor);</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-added">+        .apc_put => {</div><div class="diff-added">+            // No operation</div><div class="diff-added">+            break :null null;</div><div class="diff-added">+        },</div><div> </div><div class="diff-removed">-test "csi: too many params" {</div><div class="diff-removed">-    var p = init();</div><div class="diff-removed">-    _ = p.next(0x1B);</div><div class="diff-removed">-    _ = p.next('[');</div><div class="diff-removed">-    for (0..100) |_| {</div><div class="diff-removed">-        _ = p.next('1');</div><div class="diff-removed">-        _ = p.next(';');</div><div class="diff-removed">-    }</div><div class="diff-removed">-    _ = p.next('1');</div><div class="diff-removed">-</div><div class="diff-removed">-    {</div><div class="diff-removed">-        const a = p.next('C');</div><div class="diff-removed">-        try testing.expect(p.state == .ground);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1] == null);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-added">+        .apc_put => {</div><div class="diff-added">+            // No operation</div><div class="diff-added">+            break :null null;</div><div class="diff-added">+        },</div><div> </div><div class="diff-removed">-test "dcs: XTGETTCAP" {</div><div class="diff-removed">-    var p = init();</div><div class="diff-removed">-    _ = p.next(0x1B);</div><div class="diff-removed">-    for ("P+") |c| {</div><div class="diff-removed">-        const a = p.next(c);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1] == null);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-    }</div><div class="diff-added">+        .apc_put => {</div><div class="diff-added">+            // No operation</div><div class="diff-added">+            break :null null;</div><div class="diff-added">+        },</div><div> </div><div class="diff-removed">-    {</div><div class="diff-removed">-        const a = p.next('q');</div><div class="diff-removed">-        try testing.expect(p.state == .dcs_passthrough);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1] == null);</div><div class="diff-removed">-        try testing.expect(a[2].? == .dcs_hook);</div><div class="diff-removed">-</div><div class="diff-removed">-        const hook = a[2].?.dcs_hook;</div><div class="diff-removed">-        try testing.expectEqualSlices(u8, &[_]u8{'+'}, hook.intermediates);</div><div class="diff-removed">-        try testing.expectEqualSlices(u16, &[_]u16{}, hook.params);</div><div class="diff-removed">-        try testing.expectEqual('q', hook.final);</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-added">+        .apc_put => {</div><div class="diff-added">+            // No operation</div><div class="diff-added">+            break :null null;</div><div class="diff-added">+        },</div><div> </div><div class="diff-removed">-test "dcs: params" {</div><div class="diff-removed">-    var p = init();</div><div class="diff-removed">-    _ = p.next(0x1B);</div><div class="diff-removed">-    for ("P1000") |c| {</div><div class="diff-removed">-        const a = p.next(c);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1] == null);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-    }</div><div class="diff-added">+        .apc_put => {</div><div class="diff-added">+            // No operation</div><div class="diff-added">+            break :null null;</div><div class="diff-added">+        },</div><div> </div><div class="diff-removed">-    {</div><div class="diff-removed">-        const a = p.next('p');</div><div class="diff-removed">-        try testing.expect(p.state == .dcs_passthrough);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1] == null);</div><div class="diff-removed">-        try testing.expect(a[2].? == .dcs_hook);</div><div class="diff-added">+        .apc_put => {</div><div class="diff-added">+            // No operation</div><div class="diff-added">+            break :null null;</div><div class="diff-added">+        },</div><div> </div><div class="diff-removed">-        const hook = a[2].?.dcs_hook;</div><div class="diff-removed">-        try testing.expectEqualSlices(u16, &[_]u16{1000}, hook.params);</div><div class="diff-removed">-        try testing.expectEqual('p', hook.final);</div><div class="diff-removed">-    }</div><div class="diff-added">+        // No other actions.</div><div class="diff-added">+        else => {</div><div class="diff-added">+            log.err("unimplemented action: {}", .{action});</div><div class="diff-added">+            @panic("TODO");</div><div class="diff-added">+        },</div><div class="diff-added">+    };</div><div> }</div><div>\ No newline at end of file</div><div></div></pre>
                </div>
            </div>
        </section>
    </main>
    <footer>
        <p>LoCoDiff-bench - <a href="https://github.com/AbanteAI/LoCoDiff-bench">GitHub Repository</a></p>
    </footer>
</body>
</html>
    