<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case: packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx - GPT OSS 120B</title>
    <link rel="stylesheet" href="../../styles.css">
</head>
<body>
    <header>
        <h1>Case: packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx</h1>
        <h2>Model: GPT OSS 120B</h2>
        <p><a href="../../models/openai_gpt-oss-120b.html">All GPT OSS 120B Cases</a> | <a href="../../cases.html">All Cases</a> | <a href="../../index.html">Home</a></p>
    </header>
    <main>
        <section class="case-details">
            <div class="case-info">
                <h2>Benchmark Case Information</h2>
                <p><strong>Model:</strong> GPT OSS 120B</p>
                <p><strong>Status:</strong> <span class="failure">Failure</span></p>
                <p><strong>Prompt Tokens:</strong> 39824</p>
                <p><strong>Native Prompt Tokens:</strong> 39992</p>
                <p><strong>Native Completion Tokens:</strong> 5146</p>
                <p><strong>Native Tokens Reasoning:</strong> 2961</p>
                <p><strong>Native Finish Reason:</strong> stop</p>
                <p><strong>Cost:</strong> $0.0098583</p>
            </div>
            
            <div class="content-links">
                <h2>View Content</h2>
                <ul>
                    <li><a href="../../content/openai_gpt-oss-120b/tldraw_packages_tldraw_src_lib_shapes_note_NoteShapeUtil.tsx/prompt.html" class="content-link">View Prompt</a></li>
                    <li><a href="../../content/openai_gpt-oss-120b/tldraw_packages_tldraw_src_lib_shapes_note_NoteShapeUtil.tsx/expected.html" class="content-link">View Expected Output</a></li>
                    <li><a href="../../content/openai_gpt-oss-120b/tldraw_packages_tldraw_src_lib_shapes_note_NoteShapeUtil.tsx/actual.html" class="content-link">View Actual Output</a></li>
                </ul>
            </div>
            
            <div class="diff-section">
                <h2>Diff (Expected vs Actual)</h2>
                <div id="diff-output">
                    <pre class="diff"><div></div><div>index 37af12e07..2eb1a4489 100644</div><div class="diff-header">--- a/tldraw_packages_tldraw_src_lib_shapes_note_NoteShapeUtil.tsx_expectedoutput.txt (expected):tmp/tmpqyqm07e1_expected.txt	</div><div class="diff-header">+++ b/tldraw_packages_tldraw_src_lib_shapes_note_NoteShapeUtil.tsx_extracted.txt (actual):tmp/tmpzhw5r479_actual.txt	</div><div class="diff-info">@@ -7,28 +7,25 @@ import {</div><div> 	Rectangle2d,</div><div> 	ShapeUtil,</div><div> 	SvgExportContext,</div><div class="diff-removed">-	TLFontFace,</div><div> 	TLHandle,</div><div> 	TLNoteShape,</div><div> 	TLNoteShapeProps,</div><div class="diff-removed">-	TLResizeInfo,</div><div> 	TLShape,</div><div> 	TLShapeId,</div><div> 	Vec,</div><div> 	WeakCache,</div><div> 	exhaustiveSwitchError,</div><div> 	getDefaultColorTheme,</div><div class="diff-removed">-	getFontsFromRichText,</div><div> 	lerp,</div><div> 	noteShapeMigrations,</div><div> 	noteShapeProps,</div><div> 	resizeScaled,</div><div> 	rng,</div><div> 	toDomPrecision,</div><div class="diff-removed">-	toRichText,</div><div> 	useEditor,</div><div> 	useValue,</div><div> } from '@tldraw/editor'</div><div class="diff-added">+</div><div> import { useCallback } from 'react'</div><div> import { useCurrentTranslation } from '../../ui/hooks/useTranslation/useTranslation'</div><div> import { isRightToLeftLanguage } from '../../utils/text/text'</div><div class="diff-info">@@ -40,29 +37,29 @@ import {</div><div> 	LABEL_PADDING,</div><div> 	TEXT_PROPS,</div><div> } from '../shared/default-shape-constants'</div><div class="diff-removed">-</div><div class="diff-removed">-import { startEditingShapeWithLabel } from '../../tools/SelectTool/selectHelpers'</div><div class="diff-removed">-</div><div class="diff-removed">-import isEqual from 'lodash.isequal'</div><div> import {</div><div class="diff-removed">-	isEmptyRichText,</div><div class="diff-removed">-	renderHtmlFromRichTextForMeasurement,</div><div class="diff-removed">-	renderPlaintextFromRichText,</div><div class="diff-removed">-} from '../../utils/text/richText'</div><div class="diff-added">+	getFontDefForExport,</div><div class="diff-added">+	getFontsFromRichText,</div><div class="diff-added">+} from '../shared/defaultStyleDefs'</div><div class="diff-added">+import { startEditingShapeWithLabel } from '../../tools/SelectTool/selectHelpers'</div><div> import { useDefaultColorTheme } from '../shared/useDefaultColorTheme'</div><div> import { useIsReadyForEditing } from '../shared/useEditablePlainText'</div><div> import {</div><div> 	CLONE_HANDLE_MARGIN,</div><div> 	NOTE_CENTER_OFFSET,</div><div> 	NOTE_SIZE,</div><div class="diff-added">+	NOTE_WIDTH,</div><div class="diff-added">+	ADJACENT_SHAPE_MARGIN,</div><div class="diff-added">+	ADJACENT_NOTE_MARGIN,</div><div> 	getNoteShapeForAdjacentPosition,</div><div> } from './noteHelpers'</div><div class="diff-added">+import isEqual from 'lodash.isequal'</div><div class="diff-added">+import { isEmptyRichText, renderHtmlFromRichTextForMeasurement, renderPlaintextFromRichText } from '../../utils/text/richText'</div><div> </div><div> /** @public */</div><div> export interface NoteShapeOptions {</div><div> 	/**</div><div class="diff-removed">-	 * How should the note shape resize? By default it does not resize (except automatically based on its text content),</div><div class="diff-removed">-	 * but you can set it to be user-resizable using scale.</div><div class="diff-added">+	 * Where does a note shape resize? By default it does notresize.</div><div> 	 */</div><div> 	resizeMode: 'none' | 'scale'</div><div> }</div><div class="diff-info">@@ -73,60 +70,75 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {</div><div> 	static override props = noteShapeProps</div><div> 	static override migrations = noteShapeMigrations</div><div> </div><div class="diff-added">+	// ---- shape options ----</div><div> 	override options: NoteShapeOptions = {</div><div> 		resizeMode: 'none',</div><div> 	}</div><div> </div><div class="diff-added">+	/** Event/Utility overrides */</div><div> 	override canEdit() {</div><div> 		return true</div><div> 	}</div><div class="diff-removed">-	override hideResizeHandles() {</div><div class="diff-added">+	override hideResizeHandles(): boolean {</div><div> 		const { resizeMode } = this.options</div><div> 		switch (resizeMode) {</div><div class="diff-removed">-			case 'none': {</div><div class="diff-added">+			case 'none':</div><div> 				return true</div><div class="diff-removed">-			}</div><div class="diff-removed">-			case 'scale': {</div><div class="diff-added">+			case 'scale':</div><div> 				return false</div><div class="diff-removed">-			}</div><div class="diff-removed">-			default: {</div><div class="diff-added">+			default:</div><div> 				throw exhaustiveSwitchError(resizeMode)</div><div class="diff-removed">-			}</div><div> 		}</div><div> 	}</div><div class="diff-removed">-</div><div> 	override isAspectRatioLocked() {</div><div> 		return this.options.resizeMode === 'scale'</div><div> 	}</div><div class="diff-removed">-</div><div> 	override hideSelectionBoundsFg() {</div><div> 		return false</div><div> 	}</div><div class="diff-removed">-</div><div class="diff-removed">-	getDefaultProps(): TLNoteShape['props'] {</div><div class="diff-added">+	override hideResizeHandles() {</div><div class="diff-added">+		// already defined above</div><div class="diff-added">+	}</div><div class="diff-added">+	override getText(shape: TLNoteShape) {</div><div class="diff-added">+		return renderPlaintextFromRichText(this.editor, shape.props.richText)</div><div class="diff-added">+	}</div><div class="diff-added">+	override getFontFaces(shape: TLNoteShape) {</div><div class="diff-added">+		return getFontsFromRichText(this.editor, shape.props.richText, {</div><div class="diff-added">+			family: `tldraw_${shape.props.font}`,</div><div class="diff-added">+			weight: 'normal',</div><div class="diff-added">+			style: 'normal',</div><div class="diff-added">+		})</div><div class="diff-added">+	}</div><div class="diff-added">+	override getInterpolatedProps(</div><div class="diff-added">+		startShape: TLNoteShape,</div><div class="diff-added">+		endShape: TLNoteShape,</div><div class="diff-added">+		t: number</div><div class="diff-added">+	): TLNoteShapeProps {</div><div> 		return {</div><div class="diff-removed">-			color: 'black',</div><div class="diff-removed">-			richText: toRichText(''),</div><div class="diff-removed">-			size: 'm',</div><div class="diff-removed">-			font: 'draw',</div><div class="diff-removed">-			align: 'middle',</div><div class="diff-removed">-			verticalAlign: 'middle',</div><div class="diff-removed">-			labelColor: 'black',</div><div class="diff-removed">-			growY: 0,</div><div class="diff-removed">-			fontSizeAdjustment: 0,</div><div class="diff-removed">-			url: '',</div><div class="diff-removed">-			scale: 1,</div><div class="diff-added">+			...(t > 0.5 ? endShape.props : startShape.props),</div><div class="diff-added">+			scale: lerp(startShape.props.scale, endShape.props.scale, t),</div><div> 		}</div><div> 	}</div><div class="diff-removed">-</div><div class="diff-added">+	override onResize(shape: TLNoteShape, info: any) {</div><div class="diff-added">+		const { resizeMode } = this.options</div><div class="diff-added">+		switch (resizeMode) {</div><div class="diff-added">+			case 'none':</div><div class="diff-added">+				return undefined</div><div class="diff-added">+			case 'scale':</div><div class="diff-added">+				return resizeScaled(shape, info)</div><div class="diff-added">+			default:</div><div class="diff-added">+				throw exhaustiveSwitchError(resizeMode)</div><div class="diff-added">+		}</div><div class="diff-added">+	}</div><div class="diff-added">+	/** --- Geometry: ------------------------------------------------------- */</div><div> 	getGeometry(shape: TLNoteShape) {</div><div class="diff-added">+		const noteHeight = (NOTE_SIZE + shape.props.growY) * shape.props.scale</div><div> 		const { labelHeight, labelWidth } = getLabelSize(this.editor, shape)</div><div class="diff-removed">-		const { scale } = shape.props</div><div> </div><div class="diff-removed">-		const lh = labelHeight * scale</div><div class="diff-removed">-		const lw = labelWidth * scale</div><div class="diff-removed">-		const nw = NOTE_SIZE * scale</div><div class="diff-removed">-		const nh = getNoteHeight(shape)</div><div class="diff-added">+		const lw = labelWidth * shape.props.scale</div><div class="diff-added">+		const lh = labelHeight * shape.props.scale</div><div class="diff-added">+		const nw = NOTE_SIZE * shape.props.scale</div><div class="diff-added">+		const nh = noteHeight</div><div> </div><div> 		return new Group2d({</div><div> 			children: [</div><div class="diff-info">@@ -152,16 +164,17 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {</div><div> 			],</div><div> 		})</div><div> 	}</div><div class="diff-removed">-</div><div class="diff-added">+	/** Hooks ------------------------------------------------------------ */</div><div> 	override getHandles(shape: TLNoteShape): TLHandle[] {</div><div> 		const { scale } = shape.props</div><div> 		const isCoarsePointer = this.editor.getInstanceState().isCoarsePointer</div><div class="diff-added">+		const zoom = this.editor.getZoomLevel()</div><div class="diff-added">+</div><div> 		if (isCoarsePointer) return []</div><div> </div><div class="diff-removed">-		const zoom = this.editor.getZoomLevel()</div><div> 		if (zoom * scale < 0.25) return []</div><div> </div><div class="diff-removed">-		const nh = getNoteHeight(shape)</div><div class="diff-added">+		const nh = (NOTE_SIZE + shape.props.growY) * scale</div><div> 		const nw = NOTE_SIZE * scale</div><div> 		const offset = (CLONE_HANDLE_MARGIN / zoom) * scale</div><div> </div><div class="diff-info">@@ -208,56 +221,45 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {</div><div> 			},</div><div> 		]</div><div> 	}</div><div class="diff-removed">-</div><div class="diff-removed">-	override onResize(shape: any, info: TLResizeInfo<any>) {</div><div class="diff-removed">-		const { resizeMode } = this.options</div><div class="diff-removed">-		switch (resizeMode) {</div><div class="diff-removed">-			case 'none': {</div><div class="diff-removed">-				return undefined</div><div class="diff-removed">-			}</div><div class="diff-removed">-			case 'scale': {</div><div class="diff-removed">-				return resizeScaled(shape, info)</div><div class="diff-removed">-			}</div><div class="diff-removed">-			default: {</div><div class="diff-removed">-				throw exhaustiveSwitchError(resizeMode)</div><div class="diff-removed">-			}</div><div class="diff-removed">-		}</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	override getText(shape: TLNoteShape) {</div><div class="diff-removed">-		return renderPlaintextFromRichText(this.editor, shape.props.richText)</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	override getFontFaces(shape: TLNoteShape): TLFontFace[] {</div><div class="diff-removed">-		return getFontsFromRichText(this.editor, shape.props.richText, {</div><div class="diff-removed">-			family: `tldraw_${shape.props.font}`,</div><div class="diff-removed">-			weight: 'normal',</div><div class="diff-removed">-			style: 'normal',</div><div class="diff-removed">-		})</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-added">+	/** Component ----------------------------------------------------------- */</div><div> 	component(shape: TLNoteShape) {</div><div> 		const {</div><div> 			id,</div><div> 			type,</div><div> 			props: {</div><div class="diff-removed">-				labelColor,</div><div class="diff-removed">-				scale,</div><div class="diff-added">+				// note fields</div><div> 				color,</div><div> 				font,</div><div> 				size,</div><div> 				align,</div><div class="diff-removed">-				richText,</div><div> 				verticalAlign,</div><div> 				fontSizeAdjustment,</div><div class="diff-added">+				verticalAlign: _v,</div><div class="diff-added">+				verticalAlign: __,</div><div class="diff-added">+				verticalAlign : ___,</div><div class="diff-added">+				...rest</div><div> 			},</div><div class="diff-added">+			reProps,</div><div class="diff-added">+		} = shape</div><div class="diff-added">+</div><div class="diff-added">+		const {</div><div class="diff-added">+			id: shapeId,</div><div class="diff-added">+			type: shapeType,</div><div class="diff-added">+			font,</div><div class="diff-added">+			size,</div><div class="diff-added">+			align,</div><div class="diff-added">+			verticalAlign,</div><div class="diff-added">+			richText,</div><div class="diff-added">+			fontSizeAdjustment,</div><div class="diff-added">+			...restProps</div><div> 		} = shape</div><div> </div><div> 		const handleKeyDown = useNoteKeydownHandler(id)</div><div> </div><div> 		const theme = useDefaultColorTheme()</div><div class="diff-removed">-		const nw = NOTE_SIZE * scale</div><div class="diff-removed">-		const nh = getNoteHeight(shape)</div><div class="diff-added">+		const noteHeight = (NOTE_SIZE + shape.props.growY) * shape.props.scale</div><div class="diff-added">+</div><div class="diff-added">+		const isDarkMode = useValue('dark mode', () => this.editor.user.getIsDarkMode(), [this.editor])</div><div> </div><div> 		const rotation = useValue(</div><div> 			'shape rotation',</div><div class="diff-info">@@ -265,35 +267,31 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {</div><div> 			[this.editor]</div><div> 		)</div><div> </div><div class="diff-removed">-		// todo: consider hiding shadows on dark mode if they're invisible anyway</div><div class="diff-removed">-</div><div class="diff-removed">-		const hideShadows = useValue('zoom', () => this.editor.getZoomLevel() < 0.35 / scale, [</div><div class="diff-removed">-			scale,</div><div class="diff-added">+		const hideShadows = useValue('hide shadows', () => this.editor.getZoomLevel() < 0.35 / shape.props.scale, [</div><div class="diff-added">+			shape.props.scale,</div><div> 			this.editor,</div><div> 		])</div><div> </div><div class="diff-removed">-		const isDarkMode = useValue('dark mode', () => this.editor.user.getIsDarkMode(), [this.editor])</div><div class="diff-removed">-</div><div> 		const isSelected = shape.id === this.editor.getOnlySelectedShapeId()</div><div class="diff-removed">-</div><div> 		const isReadyForEditing = useIsReadyForEditing(this.editor, shape.id)</div><div class="diff-removed">-		const isEmpty = isEmptyRichText(richText)</div><div class="diff-added">+		const isEmpty = isEmptyRichText(shape.props.richText)</div><div> </div><div> 		return (</div><div> 			<></div><div> 				<div</div><div class="diff-removed">-					id={id}</div><div class="diff-added">+					id={shapeId}</div><div> 					className="tl-note__container"</div><div> 					style={{</div><div class="diff-removed">-						width: nw,</div><div class="diff-removed">-						height: nh,</div><div class="diff-added">+						width: NOTE_SIZE * shape.props.scale,</div><div class="diff-added">+						height: noteHeight,</div><div> 						backgroundColor: theme[color].note.fill,</div><div class="diff-added">+						// border and shadow handling</div><div> 						borderBottom: hideShadows</div><div> 							? isDarkMode</div><div class="diff-removed">-								? `${2 * scale}px solid rgb(20, 20, 20)`</div><div class="diff-removed">-								: `${2 * scale}px solid rgb(144, 144, 144)`</div><div class="diff-removed">-							: 'none',</div><div class="diff-removed">-						boxShadow: hideShadows ? 'none' : getNoteShadow(shape.id, rotation, scale),</div><div class="diff-added">+								? `${2 * shape.props.scale}px solid rgb(20, 20, 20)`</div><div class="diff-added">+								: `${2 * shape.props.scale}px solid rgb(144, 144, 144)`</div><div class="diff-added">+								: 'none',</div><div class="diff-added">+						boxShadow: hideShadows ? 'none' : getNoteShadow(shape.id, rotation, shape.props.scale),</div><div> 					}}</div><div> 				></div><div> 					{(isSelected || isReadyForEditing || !isEmpty) && (</div><div class="diff-info">@@ -301,15 +299,15 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {</div><div> 							shapeId={id}</div><div> 							type={type}</div><div> 							font={font}</div><div class="diff-removed">-							fontSize={(fontSizeAdjustment || LABEL_FONT_SIZES[size]) * scale}</div><div class="diff-added">+							fontSize={(fontSizeAdjustment || LABEL_FONT_SIZES[size]) * shape.props.scale}</div><div> 							lineHeight={TEXT_PROPS.lineHeight}</div><div> 							align={align}</div><div> 							verticalAlign={verticalAlign}</div><div class="diff-removed">-							richText={richText}</div><div class="diff-added">+							richText={shape.props.richText}</div><div> 							isSelected={isSelected}</div><div class="diff-removed">-							labelColor={labelColor === 'black' ? theme[color].note.text : theme[labelColor].fill}</div><div class="diff-added">+							labelColor={theme[color].note.text}</div><div> 							wrap</div><div class="diff-removed">-							padding={LABEL_PADDING * scale}</div><div class="diff-added">+							padding={LABEL_PADDING * shape.props.scale}</div><div> 							hasCustomTabBehavior</div><div> 							onKeyDown={handleKeyDown}</div><div> 						/></div><div class="diff-info">@@ -319,19 +317,19 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {</div><div> 			</></div><div> 		)</div><div> 	}</div><div class="diff-removed">-</div><div class="diff-added">+	/** Indicator (JS/DOM) --------------------------------------------------- */</div><div> 	indicator(shape: TLNoteShape) {</div><div class="diff-removed">-		const { scale } = shape.props</div><div> 		return (</div><div> 			<rect</div><div class="diff-removed">-				rx={scale}</div><div class="diff-removed">-				width={toDomPrecision(NOTE_SIZE * scale)}</div><div class="diff-removed">-				height={toDomPrecision(getNoteHeight(shape))}</div><div class="diff-added">+				rx={shape.props.scale}</div><div class="diff-added">+				width={toDomPrecision(NOTE_SIZE * shape.props.scale)}</div><div class="diff-added">+				height={toDomPrecision((NOTE_SIZE + shape.props.growY) * shape.props.scale)}</div><div> 			/></div><div> 		)</div><div> 	}</div><div class="diff-removed">-</div><div class="diff-added">+	/** SVG export ---------------------------------------------------------- */</div><div> 	override toSvg(shape: TLNoteShape, ctx: SvgExportContext) {</div><div class="diff-added">+		if (shape.props.text) ctx.addExportDef(getFontDefForExport(shape.props.font))</div><div> 		const theme = getDefaultColorTheme({ isDarkMode: ctx.isDarkMode })</div><div> 		const bounds = getBoundsForSVG(shape)</div><div> </div><div class="diff-info">@@ -352,7 +350,6 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {</div><div> 			<></div><div> 				<rect x={5} y={5} rx={1} width={NOTE_SIZE - 10} height={bounds.h} fill="rgba(0,0,0,.1)" /></div><div> 				<rect</div><div class="diff-removed">-					rx={1}</div><div> 					width={NOTE_SIZE}</div><div> 					height={bounds.h}</div><div> 					fill={theme[shape.props.color].note.fill}</div><div class="diff-info">@@ -361,199 +358,4 @@ export class NoteShapeUtil extends ShapeUtil<TLNoteShape> {</div><div> 			</></div><div> 		)</div><div> 	}</div><div class="diff-removed">-</div><div class="diff-removed">-	override onBeforeCreate(next: TLNoteShape) {</div><div class="diff-removed">-		return getNoteSizeAdjustments(this.editor, next)</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	override onBeforeUpdate(prev: TLNoteShape, next: TLNoteShape) {</div><div class="diff-removed">-		if (</div><div class="diff-removed">-			isEqual(prev.props.richText, next.props.richText) &&</div><div class="diff-removed">-			prev.props.font === next.props.font &&</div><div class="diff-removed">-			prev.props.size === next.props.size</div><div class="diff-removed">-		) {</div><div class="diff-removed">-			return</div><div class="diff-removed">-		}</div><div class="diff-removed">-</div><div class="diff-removed">-		return getNoteSizeAdjustments(this.editor, next)</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	override getInterpolatedProps(</div><div class="diff-removed">-		startShape: TLNoteShape,</div><div class="diff-removed">-		endShape: TLNoteShape,</div><div class="diff-removed">-		t: number</div><div class="diff-removed">-	): TLNoteShapeProps {</div><div class="diff-removed">-		return {</div><div class="diff-removed">-			...(t > 0.5 ? endShape.props : startShape.props),</div><div class="diff-removed">-			scale: lerp(startShape.props.scale, endShape.props.scale, t),</div><div class="diff-removed">-		}</div><div class="diff-removed">-	}</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-/**</div><div class="diff-removed">- * Get the growY and fontSizeAdjustment for a shape.</div><div class="diff-removed">- */</div><div class="diff-removed">-function getNoteSizeAdjustments(editor: Editor, shape: TLNoteShape) {</div><div class="diff-removed">-	const { labelHeight, fontSizeAdjustment } = getLabelSize(editor, shape)</div><div class="diff-removed">-	// When the label height is more than the height of the shape, we add extra height to it</div><div class="diff-removed">-	const growY = Math.max(0, labelHeight - NOTE_SIZE)</div><div class="diff-removed">-</div><div class="diff-removed">-	if (growY !== shape.props.growY || fontSizeAdjustment !== shape.props.fontSizeAdjustment) {</div><div class="diff-removed">-		return {</div><div class="diff-removed">-			...shape,</div><div class="diff-removed">-			props: {</div><div class="diff-removed">-				...shape.props,</div><div class="diff-removed">-				growY,</div><div class="diff-removed">-				fontSizeAdjustment,</div><div class="diff-removed">-			},</div><div class="diff-removed">-		}</div><div class="diff-removed">-	}</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-/**</div><div class="diff-removed">- * Get the label size for a note.</div><div class="diff-removed">- */</div><div class="diff-removed">-function getNoteLabelSize(editor: Editor, shape: TLNoteShape) {</div><div class="diff-removed">-	const { richText } = shape.props</div><div class="diff-removed">-</div><div class="diff-removed">-	if (isEmptyRichText(richText)) {</div><div class="diff-removed">-		const minHeight = LABEL_FONT_SIZES[shape.props.size] * TEXT_PROPS.lineHeight + LABEL_PADDING * 2</div><div class="diff-removed">-		return { labelHeight: minHeight, labelWidth: 100, fontSizeAdjustment: 0 }</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	const unadjustedFontSize = LABEL_FONT_SIZES[shape.props.size]</div><div class="diff-removed">-</div><div class="diff-removed">-	let fontSizeAdjustment = 0</div><div class="diff-removed">-	let iterations = 0</div><div class="diff-removed">-	let labelHeight = NOTE_SIZE</div><div class="diff-removed">-	let labelWidth = NOTE_SIZE</div><div class="diff-removed">-</div><div class="diff-removed">-	// N.B. For some note shapes with text like 'hjhjhjhjhjhjhjhj', you'll run into</div><div class="diff-removed">-	// some text measurement fuzziness where the browser swears there's no overflow (scrollWidth === width)</div><div class="diff-removed">-	// but really there is when you enable overflow-wrap again. This helps account for that little bit</div><div class="diff-removed">-	// of give.</div><div class="diff-removed">-	const FUZZ = 1</div><div class="diff-removed">-</div><div class="diff-removed">-	// We slightly make the font smaller if the text is too big for the note, width-wise.</div><div class="diff-removed">-	do {</div><div class="diff-removed">-		fontSizeAdjustment = Math.min(unadjustedFontSize, unadjustedFontSize - iterations)</div><div class="diff-removed">-		const html = renderHtmlFromRichTextForMeasurement(editor, richText)</div><div class="diff-removed">-		const nextTextSize = editor.textMeasure.measureHtml(html, {</div><div class="diff-removed">-			...TEXT_PROPS,</div><div class="diff-removed">-			fontFamily: FONT_FAMILIES[shape.props.font],</div><div class="diff-removed">-			fontSize: fontSizeAdjustment,</div><div class="diff-removed">-			maxWidth: NOTE_SIZE - LABEL_PADDING * 2 - FUZZ,</div><div class="diff-removed">-			disableOverflowWrapBreaking: true,</div><div class="diff-removed">-		})</div><div class="diff-removed">-</div><div class="diff-removed">-		labelHeight = nextTextSize.h + LABEL_PADDING * 2</div><div class="diff-removed">-		labelWidth = nextTextSize.w + LABEL_PADDING * 2</div><div class="diff-removed">-</div><div class="diff-removed">-		if (fontSizeAdjustment <= 14) {</div><div class="diff-removed">-			// Too small, just rely now on CSS `overflow-wrap: break-word`</div><div class="diff-removed">-			// We need to recalculate the text measurement here with break-word enabled.</div><div class="diff-removed">-			const html = renderHtmlFromRichTextForMeasurement(editor, richText)</div><div class="diff-removed">-			const nextTextSizeWithOverflowBreak = editor.textMeasure.measureHtml(html, {</div><div class="diff-removed">-				...TEXT_PROPS,</div><div class="diff-removed">-				fontFamily: FONT_FAMILIES[shape.props.font],</div><div class="diff-removed">-				fontSize: fontSizeAdjustment,</div><div class="diff-removed">-				maxWidth: NOTE_SIZE - LABEL_PADDING * 2 - FUZZ,</div><div class="diff-removed">-			})</div><div class="diff-removed">-			labelHeight = nextTextSizeWithOverflowBreak.h + LABEL_PADDING * 2</div><div class="diff-removed">-			labelWidth = nextTextSizeWithOverflowBreak.w + LABEL_PADDING * 2</div><div class="diff-removed">-			break</div><div class="diff-removed">-		}</div><div class="diff-removed">-</div><div class="diff-removed">-		if (nextTextSize.scrollWidth.toFixed(0) === nextTextSize.w.toFixed(0)) {</div><div class="diff-removed">-			break</div><div class="diff-removed">-		}</div><div class="diff-removed">-	} while (iterations++ < 50)</div><div class="diff-removed">-</div><div class="diff-removed">-	return {</div><div class="diff-removed">-		labelHeight: labelHeight,</div><div class="diff-removed">-		labelWidth: labelWidth,</div><div class="diff-removed">-		fontSizeAdjustment: fontSizeAdjustment,</div><div class="diff-removed">-	}</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-const labelSizesForNote = new WeakCache<TLShape, ReturnType<typeof getNoteLabelSize>>()</div><div class="diff-removed">-</div><div class="diff-removed">-function getLabelSize(editor: Editor, shape: TLNoteShape) {</div><div class="diff-removed">-	return labelSizesForNote.get(shape, () => getNoteLabelSize(editor, shape))</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-function useNoteKeydownHandler(id: TLShapeId) {</div><div class="diff-removed">-	const editor = useEditor()</div><div class="diff-removed">-	const translation = useCurrentTranslation()</div><div class="diff-removed">-</div><div class="diff-removed">-	return useCallback(</div><div class="diff-removed">-		(e: KeyboardEvent) => {</div><div class="diff-removed">-			const shape = editor.getShape<TLNoteShape>(id)</div><div class="diff-removed">-			if (!shape) return</div><div class="diff-removed">-</div><div class="diff-removed">-			const isTab = e.key === 'Tab'</div><div class="diff-removed">-			const isCmdEnter = (e.metaKey || e.ctrlKey) && e.key === 'Enter'</div><div class="diff-removed">-			if (isTab || isCmdEnter) {</div><div class="diff-removed">-				e.preventDefault()</div><div class="diff-removed">-</div><div class="diff-removed">-				const pageTransform = editor.getShapePageTransform(id)</div><div class="diff-removed">-				const pageRotation = pageTransform.rotation()</div><div class="diff-removed">-</div><div class="diff-removed">-				// Based on the inputs, calculate the offset to the next note</div><div class="diff-removed">-				// tab controls x axis (shift inverts direction set by RTL)</div><div class="diff-removed">-				// cmd enter is the y axis (shift inverts direction)</div><div class="diff-removed">-				const isRTL = !!(</div><div class="diff-removed">-					translation.dir === 'rtl' ||</div><div class="diff-removed">-					// todo: can we check a partial of the text, so that we don't have to render the whole thing?</div><div class="diff-removed">-					isRightToLeftLanguage(renderPlaintextFromRichText(editor, shape.props.richText))</div><div class="diff-removed">-				)</div><div class="diff-removed">-</div><div class="diff-removed">-				const offsetLength =</div><div class="diff-removed">-					(NOTE_SIZE +</div><div class="diff-removed">-						editor.options.adjacentShapeMargin +</div><div class="diff-removed">-						// If we're growing down, we need to account for the current shape's growY</div><div class="diff-removed">-						(isCmdEnter && !e.shiftKey ? shape.props.growY : 0)) *</div><div class="diff-removed">-					shape.props.scale</div><div class="diff-removed">-</div><div class="diff-removed">-				const adjacentCenter = new Vec(</div><div class="diff-removed">-					isTab ? (e.shiftKey != isRTL ? -1 : 1) : 0,</div><div class="diff-removed">-					isCmdEnter ? (e.shiftKey ? -1 : 1) : 0</div><div class="diff-removed">-				)</div><div class="diff-removed">-					.mul(offsetLength)</div><div class="diff-removed">-					.add(NOTE_CENTER_OFFSET.clone().mul(shape.props.scale))</div><div class="diff-removed">-					.rot(pageRotation)</div><div class="diff-removed">-					.add(pageTransform.point())</div><div class="diff-removed">-</div><div class="diff-removed">-				const newNote = getNoteShapeForAdjacentPosition(editor, shape, adjacentCenter, pageRotation)</div><div class="diff-removed">-</div><div class="diff-removed">-				if (newNote) {</div><div class="diff-removed">-					editor.markHistoryStoppingPoint('editing adjacent shape')</div><div class="diff-removed">-					startEditingShapeWithLabel(editor, newNote, true /* selectAll */)</div><div class="diff-removed">-				}</div><div class="diff-removed">-			}</div><div class="diff-removed">-		},</div><div class="diff-removed">-		[id, editor, translation.dir]</div><div class="diff-removed">-	)</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-function getNoteHeight(shape: TLNoteShape) {</div><div class="diff-removed">-	return (NOTE_SIZE + shape.props.growY) * shape.props.scale</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-function getNoteShadow(id: string, rotation: number, scale: number) {</div><div class="diff-removed">-	const random = rng(id) // seeded based on id</div><div class="diff-removed">-	const lift = Math.abs(random()) + 0.5 // 0 to 1.5</div><div class="diff-removed">-	const oy = Math.cos(rotation)</div><div class="diff-removed">-	const a = 5 * scale</div><div class="diff-removed">-	const b = 4 * scale</div><div class="diff-removed">-	const c = 6 * scale</div><div class="diff-removed">-	const d = 7 * scale</div><div class="diff-removed">-	return `0px ${a - lift}px ${a}px -${a}px rgba(15, 23, 31, .6),</div><div class="diff-removed">-	0px ${(b + lift * d) * Math.max(0, oy)}px ${c + lift * d}px -${b + lift * c}px rgba(15, 23, 31, ${(0.3 + lift * 0.1).toFixed(2)}), </div><div class="diff-removed">-	0px ${48 * scale}px ${10 * scale}px -${10 * scale}px inset rgba(15, 23, 44, ${((0.022 + random() * 0.005) * ((1 + oy) / 2)).toFixed(2)})`</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-function getBoundsForSVG(shape: TLNoteShape) {</div><div class="diff-removed">-	// When rendering the SVG we don't want to adjust for scale</div><div class="diff-removed">-	return new Box(0, 0, NOTE_SIZE, NOTE_SIZE + shape.props.growY)</div><div> }</div><div>\ No newline at end of file</div><div></div></pre>
                </div>
            </div>
        </section>
    </main>
    <footer>
        <p>LoCoDiff-bench - <a href="https://github.com/AbanteAI/LoCoDiff-bench">GitHub Repository</a></p>
    </footer>
</body>
</html>
    