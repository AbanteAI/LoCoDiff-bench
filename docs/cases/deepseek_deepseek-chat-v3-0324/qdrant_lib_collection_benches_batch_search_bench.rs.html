<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case: lib/collection/benches/batch_search_bench.rs - DeepSeek Chat v3-0324</title>
    <link rel="stylesheet" href="../../styles.css">
</head>
<body>
    <header>
        <h1>Case: lib/collection/benches/batch_search_bench.rs</h1>
        <p><a href="../../models/deepseek_deepseek-chat-v3-0324.html">‚Üê Back to DeepSeek Chat v3-0324 Cases</a> | <a href="../../index.html">Home</a></p>
    </header>
    <main>
        <section class="case-details">
            <div class="case-info">
                <h2>Benchmark Case Information</h2>
                <p><strong>Model:</strong> DeepSeek Chat v3-0324</p>
                <p><strong>Status:</strong> <span class="failure">Failure</span></p>
                <p><strong>Prompt Tokens:</strong> 24820</p>
                <p><strong>Output Tokens:</strong> N/A</p>
                <p><strong>Native Prompt Tokens:</strong> 24823</p>
                <p><strong>Native Completion Tokens:</strong> 231</p>
                <p><strong>Native Tokens Reasoning:</strong> 0</p>
                <p><strong>Native Finish Reason:</strong> stop</p>
                <p><strong>Runtime:</strong> N/As</p>
                <p><strong>Cost:</strong> $0.0086431</p>
            </div>
            
            <div class="content-links">
                <h2>View Content</h2>
                <ul>
                    <li><a href="../../content/deepseek_deepseek-chat-v3-0324/qdrant_lib_collection_benches_batch_search_bench.rs/prompt.html" class="content-link">View Prompt</a></li>
                    <li><a href="../../content/deepseek_deepseek-chat-v3-0324/qdrant_lib_collection_benches_batch_search_bench.rs/expected.html" class="content-link">View Expected Output</a></li>
                    <li><a href="../../content/deepseek_deepseek-chat-v3-0324/qdrant_lib_collection_benches_batch_search_bench.rs/actual.html" class="content-link">View Actual Output</a></li>
                </ul>
            </div>
            
            <div class="diff-section">
                <h2>Diff (Expected vs Actual)</h2>
                <div id="diff-output">
                    <pre class="diff"><div class="diff-header">--- qdrant_lib_collection_benches_batch_search_bench.rs_expectedoutput.txt (expected)+++ qdrant_lib_collection_benches_batch_search_bench.rs_extracted.txt (actual)@@ -1,217 +0,0 @@-use std::sync::Arc;</div><div class="diff-removed">-</div><div class="diff-removed">-use api::rest::SearchRequestInternal;</div><div class="diff-removed">-use collection::config::{CollectionConfigInternal, CollectionParams, WalConfig};</div><div class="diff-removed">-use collection::operations::CollectionUpdateOperations;</div><div class="diff-removed">-use collection::operations::point_ops::{</div><div class="diff-removed">-    PointInsertOperationsInternal, PointOperations, PointStructPersisted,</div><div class="diff-removed">-};</div><div class="diff-removed">-use collection::operations::types::CoreSearchRequestBatch;</div><div class="diff-removed">-use collection::operations::vector_params_builder::VectorParamsBuilder;</div><div class="diff-removed">-use collection::optimizers_builder::OptimizersConfig;</div><div class="diff-removed">-use collection::save_on_disk::SaveOnDisk;</div><div class="diff-removed">-use collection::shards::local_shard::LocalShard;</div><div class="diff-removed">-use collection::shards::shard_trait::ShardOperation;</div><div class="diff-removed">-use common::budget::ResourceBudget;</div><div class="diff-removed">-use common::counter::hardware_accumulator::HwMeasurementAcc;</div><div class="diff-removed">-use criterion::{Criterion, criterion_group, criterion_main};</div><div class="diff-removed">-use rand::rng;</div><div class="diff-removed">-use segment::data_types::vectors::{VectorStructInternal, only_default_vector};</div><div class="diff-removed">-use segment::fixtures::payload_fixtures::random_vector;</div><div class="diff-removed">-use segment::types::{Condition, Distance, FieldCondition, Filter, Payload, Range};</div><div class="diff-removed">-use serde_json::Map;</div><div class="diff-removed">-use tempfile::Builder;</div><div class="diff-removed">-use tokio::runtime::Runtime;</div><div class="diff-removed">-use tokio::sync::RwLock;</div><div class="diff-removed">-</div><div class="diff-removed">-#[cfg(not(target_os = "windows"))]</div><div class="diff-removed">-mod prof;</div><div class="diff-removed">-</div><div class="diff-removed">-fn create_rnd_batch() -> CollectionUpdateOperations {</div><div class="diff-removed">-    let mut rng = rng();</div><div class="diff-removed">-    let num_points = 2000;</div><div class="diff-removed">-    let dim = 100;</div><div class="diff-removed">-    let mut points = Vec::with_capacity(num_points);</div><div class="diff-removed">-    for i in 0..num_points {</div><div class="diff-removed">-        let mut payload_map = Map::new();</div><div class="diff-removed">-        payload_map.insert("a".to_string(), (i % 5).into());</div><div class="diff-removed">-        let vector = random_vector(&mut rng, dim);</div><div class="diff-removed">-        let vectors = only_default_vector(&vector);</div><div class="diff-removed">-        let point = PointStructPersisted {</div><div class="diff-removed">-            id: (i as u64).into(),</div><div class="diff-removed">-            vector: VectorStructInternal::from(vectors).into(),</div><div class="diff-removed">-            payload: Some(Payload(payload_map)),</div><div class="diff-removed">-        };</div><div class="diff-removed">-        points.push(point);</div><div class="diff-removed">-    }</div><div class="diff-removed">-    CollectionUpdateOperations::PointOperation(PointOperations::UpsertPoints(</div><div class="diff-removed">-        PointInsertOperationsInternal::PointsList(points),</div><div class="diff-removed">-    ))</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-fn batch_search_bench(c: &mut Criterion) {</div><div class="diff-removed">-    let storage_dir = Builder::new().prefix("storage").tempdir().unwrap();</div><div class="diff-removed">-</div><div class="diff-removed">-    let runtime = Runtime::new().unwrap();</div><div class="diff-removed">-    let search_runtime = Runtime::new().unwrap();</div><div class="diff-removed">-    let search_runtime_handle = search_runtime.handle();</div><div class="diff-removed">-    let handle = runtime.handle().clone();</div><div class="diff-removed">-</div><div class="diff-removed">-    let wal_config = WalConfig {</div><div class="diff-removed">-        wal_capacity_mb: 1,</div><div class="diff-removed">-        wal_segments_ahead: 0,</div><div class="diff-removed">-    };</div><div class="diff-removed">-</div><div class="diff-removed">-    let collection_params = CollectionParams {</div><div class="diff-removed">-        vectors: VectorParamsBuilder::new(100, Distance::Dot).build().into(),</div><div class="diff-removed">-        ..CollectionParams::empty()</div><div class="diff-removed">-    };</div><div class="diff-removed">-</div><div class="diff-removed">-    let collection_config = CollectionConfigInternal {</div><div class="diff-removed">-        params: collection_params,</div><div class="diff-removed">-        optimizer_config: OptimizersConfig {</div><div class="diff-removed">-            deleted_threshold: 0.9,</div><div class="diff-removed">-            vacuum_min_vector_number: 1000,</div><div class="diff-removed">-            default_segment_number: 2,</div><div class="diff-removed">-            max_segment_size: Some(100_000),</div><div class="diff-removed">-            memmap_threshold: Some(100_000),</div><div class="diff-removed">-            indexing_threshold: Some(50_000),</div><div class="diff-removed">-            flush_interval_sec: 30,</div><div class="diff-removed">-            max_optimization_threads: Some(2),</div><div class="diff-removed">-        },</div><div class="diff-removed">-        wal_config,</div><div class="diff-removed">-        hnsw_config: Default::default(),</div><div class="diff-removed">-        quantization_config: Default::default(),</div><div class="diff-removed">-        strict_mode_config: Default::default(),</div><div class="diff-removed">-        uuid: None,</div><div class="diff-removed">-    };</div><div class="diff-removed">-</div><div class="diff-removed">-    let optimizers_config = collection_config.optimizer_config.clone();</div><div class="diff-removed">-</div><div class="diff-removed">-    let shared_config = Arc::new(RwLock::new(collection_config));</div><div class="diff-removed">-</div><div class="diff-removed">-    let payload_index_schema_dir = Builder::new().prefix("qdrant-test").tempdir().unwrap();</div><div class="diff-removed">-    let payload_index_schema_file = payload_index_schema_dir.path().join("payload-schema.json");</div><div class="diff-removed">-    let payload_index_schema =</div><div class="diff-removed">-        Arc::new(SaveOnDisk::load_or_init_default(payload_index_schema_file).unwrap());</div><div class="diff-removed">-</div><div class="diff-removed">-    let shard = handle</div><div class="diff-removed">-        .block_on(LocalShard::build_local(</div><div class="diff-removed">-            0,</div><div class="diff-removed">-            "test_collection".to_string(),</div><div class="diff-removed">-            storage_dir.path(),</div><div class="diff-removed">-            shared_config,</div><div class="diff-removed">-            Default::default(),</div><div class="diff-removed">-            payload_index_schema,</div><div class="diff-removed">-            handle.clone(),</div><div class="diff-removed">-            handle.clone(),</div><div class="diff-removed">-            ResourceBudget::default(),</div><div class="diff-removed">-            optimizers_config,</div><div class="diff-removed">-        ))</div><div class="diff-removed">-        .unwrap();</div><div class="diff-removed">-</div><div class="diff-removed">-    let rnd_batch = create_rnd_batch();</div><div class="diff-removed">-</div><div class="diff-removed">-    handle</div><div class="diff-removed">-        .block_on(shard.update(rnd_batch.into(), true, HwMeasurementAcc::new()))</div><div class="diff-removed">-        .unwrap();</div><div class="diff-removed">-</div><div class="diff-removed">-    let mut group = c.benchmark_group("batch-search-bench");</div><div class="diff-removed">-</div><div class="diff-removed">-    let filters = vec![</div><div class="diff-removed">-        None,</div><div class="diff-removed">-        Some(Filter::new_must(Condition::Field(</div><div class="diff-removed">-            FieldCondition::new_match("a".parse().unwrap(), 3.into()),</div><div class="diff-removed">-        ))),</div><div class="diff-removed">-        Some(Filter::new_must(Condition::Field(</div><div class="diff-removed">-            FieldCondition::new_range(</div><div class="diff-removed">-                "a".parse().unwrap(),</div><div class="diff-removed">-                Range {</div><div class="diff-removed">-                    lt: None,</div><div class="diff-removed">-                    gt: Some(-1.),</div><div class="diff-removed">-                    gte: None,</div><div class="diff-removed">-                    lte: Some(100.0),</div><div class="diff-removed">-                },</div><div class="diff-removed">-            ),</div><div class="diff-removed">-        ))),</div><div class="diff-removed">-    ];</div><div class="diff-removed">-</div><div class="diff-removed">-    let batch_size = 100;</div><div class="diff-removed">-</div><div class="diff-removed">-    for (fid, filter) in filters.into_iter().enumerate() {</div><div class="diff-removed">-        group.bench_function(format!("search-{fid}"), |b| {</div><div class="diff-removed">-            b.iter(|| {</div><div class="diff-removed">-                runtime.block_on(async {</div><div class="diff-removed">-                    let mut rng = rng();</div><div class="diff-removed">-                    for _i in 0..batch_size {</div><div class="diff-removed">-                        let query = random_vector(&mut rng, 100);</div><div class="diff-removed">-                        let search_query = SearchRequestInternal {</div><div class="diff-removed">-                            vector: query.into(),</div><div class="diff-removed">-                            filter: filter.clone(),</div><div class="diff-removed">-                            params: None,</div><div class="diff-removed">-                            limit: 10,</div><div class="diff-removed">-                            offset: None,</div><div class="diff-removed">-                            with_payload: None,</div><div class="diff-removed">-                            with_vector: None,</div><div class="diff-removed">-                            score_threshold: None,</div><div class="diff-removed">-                        };</div><div class="diff-removed">-                        let hw_acc = HwMeasurementAcc::new();</div><div class="diff-removed">-                        let result = shard</div><div class="diff-removed">-                            .core_search(</div><div class="diff-removed">-                                Arc::new(CoreSearchRequestBatch {</div><div class="diff-removed">-                                    searches: vec![search_query.into()],</div><div class="diff-removed">-                                }),</div><div class="diff-removed">-                                search_runtime_handle,</div><div class="diff-removed">-                                None,</div><div class="diff-removed">-                                hw_acc,</div><div class="diff-removed">-                            )</div><div class="diff-removed">-                            .await</div><div class="diff-removed">-                            .unwrap();</div><div class="diff-removed">-                        assert!(!result.is_empty());</div><div class="diff-removed">-                    }</div><div class="diff-removed">-                });</div><div class="diff-removed">-            })</div><div class="diff-removed">-        });</div><div class="diff-removed">-</div><div class="diff-removed">-        group.bench_function(format!("search-batch-{fid}"), |b| {</div><div class="diff-removed">-            b.iter(|| {</div><div class="diff-removed">-                runtime.block_on(async {</div><div class="diff-removed">-                    let mut rng = rng();</div><div class="diff-removed">-                    let mut searches = Vec::with_capacity(batch_size);</div><div class="diff-removed">-                    for _i in 0..batch_size {</div><div class="diff-removed">-                        let query = random_vector(&mut rng, 100);</div><div class="diff-removed">-                        let search_query = SearchRequestInternal {</div><div class="diff-removed">-                            vector: query.into(),</div><div class="diff-removed">-                            filter: filter.clone(),</div><div class="diff-removed">-                            params: None,</div><div class="diff-removed">-                            limit: 10,</div><div class="diff-removed">-                            offset: None,</div><div class="diff-removed">-                            with_payload: None,</div><div class="diff-removed">-                            with_vector: None,</div><div class="diff-removed">-                            score_threshold: None,</div><div class="diff-removed">-                        };</div><div class="diff-removed">-                        searches.push(search_query.into());</div><div class="diff-removed">-                    }</div><div class="diff-removed">-</div><div class="diff-removed">-                    let hw_acc = HwMeasurementAcc::new();</div><div class="diff-removed">-                    let search_query = CoreSearchRequestBatch { searches };</div><div class="diff-removed">-                    let result = shard</div><div class="diff-removed">-                        .core_search(Arc::new(search_query), search_runtime_handle, None, hw_acc)</div><div class="diff-removed">-                        .await</div><div class="diff-removed">-                        .unwrap();</div><div class="diff-removed">-                    assert!(!result.is_empty());</div><div class="diff-removed">-                });</div><div class="diff-removed">-            })</div><div class="diff-removed">-        });</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    group.finish();</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-criterion_group! {</div><div class="diff-removed">-    name = benches;</div><div class="diff-removed">-    config = Criterion::default();</div><div class="diff-removed">-    targets = batch_search_bench,</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-criterion_main!(benches);</div></pre>
                </div>
            </div>
        </section>
    </main>
    <footer>
        <p>LoCoDiff-bench - <a href="https://github.com/AbanteAI/LoCoDiff-bench">GitHub Repository</a></p>
    </footer>
</body>
</html>
    