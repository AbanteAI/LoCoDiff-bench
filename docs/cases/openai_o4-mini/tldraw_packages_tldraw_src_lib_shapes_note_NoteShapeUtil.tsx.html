<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case: packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx - o4-mini-medium</title>
    <link rel="stylesheet" href="../../styles.css">
</head>
<body>
    <header>
        <h1>Case: packages/tldraw/src/lib/shapes/note/NoteShapeUtil.tsx</h1>
        <p><a href="../../models/openai_o4-mini.html">‚Üê Back to o4-mini-medium Cases</a> | <a href="../../index.html">Home</a></p>
    </header>
    <main>
        <section class="case-details">
            <div class="case-info">
                <h2>Benchmark Case Information</h2>
                <p><strong>Model:</strong> o4-mini-medium</p>
                <p><strong>Status:</strong> <span class="failure">Failure</span></p>
                <p><strong>Prompt Tokens:</strong> 39824</p>
                <p><strong>Output Tokens:</strong> N/A</p>
                <p><strong>Runtime:</strong> N/As</p>
                <p><strong>Cost:</strong> $0.1787665</p>
            </div>
            
            <div class="content-links">
                <h2>View Content</h2>
                <ul>
                    <li><a href="../../content/openai_o4-mini/tldraw_packages_tldraw_src_lib_shapes_note_NoteShapeUtil.tsx/prompt.html" class="content-link">View Prompt</a></li>
                    <li><a href="../../content/openai_o4-mini/tldraw_packages_tldraw_src_lib_shapes_note_NoteShapeUtil.tsx/expected.html" class="content-link">View Expected Output</a></li>
                    <li><a href="../../content/openai_o4-mini/tldraw_packages_tldraw_src_lib_shapes_note_NoteShapeUtil.tsx/actual.html" class="content-link">View Actual Output</a></li>
                </ul>
            </div>
            
            <div class="diff-section">
                <h2>Diff (Expected vs Actual)</h2>
                <div id="diff-output">
                    <pre class="diff"><div class="diff-header">--- tldraw_packages_tldraw_src_lib_shapes_note_NoteShapeUtil.tsx_expectedoutput.txt (expected)+++ tldraw_packages_tldraw_src_lib_shapes_note_NoteShapeUtil.tsx_extracted.txt (actual)@@ -11,7 +11,6 @@ 	TLHandle,</div><div> 	TLNoteShape,</div><div> 	TLNoteShapeProps,</div><div class="diff-removed">-	TLResizeInfo,</div><div> 	TLShape,</div><div> 	TLShapeId,</div><div> 	Vec,</div><div class="diff-info">@@ -40,14 +39,12 @@ 	LABEL_PADDING,</div><div> 	TEXT_PROPS,</div><div> } from '../shared/default-shape-constants'</div><div class="diff-removed">-</div><div> import { startEditingShapeWithLabel } from '../../tools/SelectTool/selectHelpers'</div><div class="diff-removed">-</div><div> import isEqual from 'lodash.isequal'</div><div> import {</div><div class="diff-removed">-	isEmptyRichText,</div><div> 	renderHtmlFromRichTextForMeasurement,</div><div> 	renderPlaintextFromRichText,</div><div class="diff-added">+	isEmptyRichText,</div><div> } from '../../utils/text/richText'</div><div> import { useDefaultColorTheme } from '../shared/useDefaultColorTheme'</div><div> import { useIsReadyForEditing } from '../shared/useEditablePlainText'</div><div class="diff-info">@@ -80,6 +77,7 @@ 	override canEdit() {</div><div> 		return true</div><div> 	}</div><div class="diff-added">+</div><div> 	override hideResizeHandles() {</div><div> 		const { resizeMode } = this.options</div><div> 		switch (resizeMode) {</div><div class="diff-info">@@ -114,12 +112,12 @@ 			labelColor: 'black',</div><div> 			growY: 0,</div><div> 			fontSizeAdjustment: 0,</div><div class="diff-added">+			scale: 1,</div><div> 			url: '',</div><div class="diff-removed">-			scale: 1,</div><div class="diff-removed">-		}</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	getGeometry(shape: TLNoteShape) {</div><div class="diff-added">+		}</div><div class="diff-added">+	}</div><div class="diff-added">+</div><div class="diff-added">+	override getGeometry(shape: TLNoteShape) {</div><div> 		const { labelHeight, labelWidth } = getLabelSize(this.editor, shape)</div><div> 		const { scale } = shape.props</div><div> </div><div class="diff-info">@@ -136,14 +134,14 @@ 						shape.props.align === 'start'</div><div> 							? 0</div><div> 							: shape.props.align === 'end'</div><div class="diff-removed">-								? nw - lw</div><div class="diff-removed">-								: (nw - lw) / 2,</div><div class="diff-added">+							? nw - lw</div><div class="diff-added">+							: (nw - lw) / 2,</div><div> 					y:</div><div> 						shape.props.verticalAlign === 'start'</div><div> 							? 0</div><div> 							: shape.props.verticalAlign === 'end'</div><div class="diff-removed">-								? nh - lh</div><div class="diff-removed">-								: (nh - lh) / 2,</div><div class="diff-added">+							? nh - lh</div><div class="diff-added">+							: (nh - lh) / 2,</div><div> 					width: lw,</div><div> 					height: lh,</div><div> 					isFilled: true,</div><div class="diff-info">@@ -153,7 +151,7 @@ 		})</div><div> 	}</div><div> </div><div class="diff-removed">-	override getHandles(shape: TLNoteShape): TLHandle[] {</div><div class="diff-added">+	override getHandles(shape: TLNoteShape) {</div><div> 		const { scale } = shape.props</div><div> 		const isCoarsePointer = this.editor.getInstanceState().isCoarsePointer</div><div> 		if (isCoarsePointer) return []</div><div class="diff-info">@@ -209,26 +207,11 @@ 		]</div><div> 	}</div><div> </div><div class="diff-removed">-	override onResize(shape: any, info: TLResizeInfo<any>) {</div><div class="diff-removed">-		const { resizeMode } = this.options</div><div class="diff-removed">-		switch (resizeMode) {</div><div class="diff-removed">-			case 'none': {</div><div class="diff-removed">-				return undefined</div><div class="diff-removed">-			}</div><div class="diff-removed">-			case 'scale': {</div><div class="diff-removed">-				return resizeScaled(shape, info)</div><div class="diff-removed">-			}</div><div class="diff-removed">-			default: {</div><div class="diff-removed">-				throw exhaustiveSwitchError(resizeMode)</div><div class="diff-removed">-			}</div><div class="diff-removed">-		}</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div> 	override getText(shape: TLNoteShape) {</div><div> 		return renderPlaintextFromRichText(this.editor, shape.props.richText)</div><div> 	}</div><div> </div><div class="diff-removed">-	override getFontFaces(shape: TLNoteShape): TLFontFace[] {</div><div class="diff-added">+	override getFontFaces(shape: TLNoteShape) {</div><div> 		return getFontsFromRichText(this.editor, shape.props.richText, {</div><div> 			family: `tldraw_${shape.props.font}`,</div><div> 			weight: 'normal',</div><div class="diff-info">@@ -254,7 +237,6 @@ 		} = shape</div><div> </div><div> 		const handleKeyDown = useNoteKeydownHandler(id)</div><div class="diff-removed">-</div><div> 		const theme = useDefaultColorTheme()</div><div> 		const nw = NOTE_SIZE * scale</div><div> 		const nh = getNoteHeight(shape)</div><div class="diff-info">@@ -265,17 +247,19 @@ 			[this.editor]</div><div> 		)</div><div> </div><div class="diff-removed">-		// todo: consider hiding shadows on dark mode if they're invisible anyway</div><div class="diff-removed">-</div><div class="diff-removed">-		const hideShadows = useValue('zoom', () => this.editor.getZoomLevel() < 0.35 / scale, [</div><div class="diff-removed">-			scale,</div><div class="diff-removed">-			this.editor,</div><div class="diff-removed">-		])</div><div class="diff-removed">-</div><div class="diff-removed">-		const isDarkMode = useValue('dark mode', () => this.editor.user.getIsDarkMode(), [this.editor])</div><div class="diff-added">+		const hideShadows = useValue(</div><div class="diff-added">+			'zoom',</div><div class="diff-added">+			() => this.editor.getZoomLevel() < 0.35 / scale,</div><div class="diff-added">+			[scale, this.editor]</div><div class="diff-added">+		)</div><div class="diff-added">+</div><div class="diff-added">+		const isDarkMode = useValue(</div><div class="diff-added">+			'dark mode',</div><div class="diff-added">+			() => this.editor.user.getIsDarkMode(),</div><div class="diff-added">+			[this.editor]</div><div class="diff-added">+		)</div><div> </div><div> 		const isSelected = shape.id === this.editor.getOnlySelectedShapeId()</div><div class="diff-removed">-</div><div> 		const isReadyForEditing = useIsReadyForEditing(this.editor, shape.id)</div><div> 		const isEmpty = isEmptyRichText(richText)</div><div> </div><div class="diff-info">@@ -307,7 +291,9 @@ 							verticalAlign={verticalAlign}</div><div> 							richText={richText}</div><div> 							isSelected={isSelected}</div><div class="diff-removed">-							labelColor={labelColor === 'black' ? theme[color].note.text : theme[labelColor].fill}</div><div class="diff-added">+							labelColor={</div><div class="diff-added">+								labelColor === 'black' ? theme[color].note.text : theme[labelColor].fill</div><div class="diff-added">+							}</div><div> 							wrap</div><div> 							padding={LABEL_PADDING * scale}</div><div> 							hasCustomTabBehavior</div><div class="diff-info">@@ -351,12 +337,7 @@ 		return (</div><div> 			<></div><div> 				<rect x={5} y={5} rx={1} width={NOTE_SIZE - 10} height={bounds.h} fill="rgba(0,0,0,.1)" /></div><div class="diff-removed">-				<rect</div><div class="diff-removed">-					rx={1}</div><div class="diff-removed">-					width={NOTE_SIZE}</div><div class="diff-removed">-					height={bounds.h}</div><div class="diff-removed">-					fill={theme[shape.props.color].note.fill}</div><div class="diff-removed">-				/></div><div class="diff-added">+				<rect rx={1} width={NOTE_SIZE} height={bounds.h} fill={theme[shape.props.color].note.fill} /></div><div> 				{textLabel}</div><div> 			</></div><div> 		)</div><div class="diff-info">@@ -374,7 +355,6 @@ 		) {</div><div> 			return</div><div> 		}</div><div class="diff-removed">-</div><div> 		return getNoteSizeAdjustments(this.editor, next)</div><div> 	}</div><div> </div><div class="diff-info">@@ -388,17 +368,31 @@ 			scale: lerp(startShape.props.scale, endShape.props.scale, t),</div><div> 		}</div><div> 	}</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-/**</div><div class="diff-removed">- * Get the growY and fontSizeAdjustment for a shape.</div><div class="diff-removed">- */</div><div class="diff-added">+</div><div class="diff-added">+	override onResize(shape: any, info: TLResizeInfo<any>) {</div><div class="diff-added">+		const { resizeMode } = this.options</div><div class="diff-added">+		switch (resizeMode) {</div><div class="diff-added">+			case 'none': {</div><div class="diff-added">+				return undefined</div><div class="diff-added">+			}</div><div class="diff-added">+			case 'scale': {</div><div class="diff-added">+				return resizeScaled(shape, info)</div><div class="diff-added">+			}</div><div class="diff-added">+			default: {</div><div class="diff-added">+				throw exhaustiveSwitchError(resizeMode)</div><div class="diff-added">+			}</div><div class="diff-added">+		}</div><div class="diff-added">+	}</div><div class="diff-added">+}</div><div class="diff-added">+</div><div> function getNoteSizeAdjustments(editor: Editor, shape: TLNoteShape) {</div><div> 	const { labelHeight, fontSizeAdjustment } = getLabelSize(editor, shape)</div><div class="diff-removed">-	// When the label height is more than the height of the shape, we add extra height to it</div><div> 	const growY = Math.max(0, labelHeight - NOTE_SIZE)</div><div> </div><div class="diff-removed">-	if (growY !== shape.props.growY || fontSizeAdjustment !== shape.props.fontSizeAdjustment) {</div><div class="diff-added">+	if (</div><div class="diff-added">+		growY !== shape.props.growY ||</div><div class="diff-added">+		fontSizeAdjustment !== shape.props.fontSizeAdjustment</div><div class="diff-added">+	) {</div><div> 		return {</div><div> 			...shape,</div><div> 			props: {</div><div class="diff-info">@@ -410,9 +404,6 @@ 	}</div><div> }</div><div> </div><div class="diff-removed">-/**</div><div class="diff-removed">- * Get the label size for a note.</div><div class="diff-removed">- */</div><div> function getNoteLabelSize(editor: Editor, shape: TLNoteShape) {</div><div> 	const { richText } = shape.props</div><div> </div><div class="diff-info">@@ -427,12 +418,6 @@ 	let iterations = 0</div><div> 	let labelHeight = NOTE_SIZE</div><div> 	let labelWidth = NOTE_SIZE</div><div class="diff-removed">-</div><div class="diff-removed">-	// N.B. For some note shapes with text like 'hjhjhjhjhjhjhjhj', you'll run into</div><div class="diff-removed">-	// some text measurement fuzziness where the browser swears there's no overflow (scrollWidth === width)</div><div class="diff-removed">-	// but really there is when you enable overflow-wrap again. This helps account for that little bit</div><div class="diff-removed">-	// of give.</div><div class="diff-removed">-	const FUZZ = 1</div><div> </div><div> 	// We slightly make the font smaller if the text is too big for the note, width-wise.</div><div> 	do {</div><div class="diff-info">@@ -442,7 +427,7 @@ 			...TEXT_PROPS,</div><div> 			fontFamily: FONT_FAMILIES[shape.props.font],</div><div> 			fontSize: fontSizeAdjustment,</div><div class="diff-removed">-			maxWidth: NOTE_SIZE - LABEL_PADDING * 2 - FUZZ,</div><div class="diff-added">+			maxWidth: NOTE_SIZE - LABEL_PADDING * 2,</div><div> 			disableOverflowWrapBreaking: true,</div><div> 		})</div><div> </div><div class="diff-info">@@ -450,14 +435,12 @@ 		labelWidth = nextTextSize.w + LABEL_PADDING * 2</div><div> </div><div> 		if (fontSizeAdjustment <= 14) {</div><div class="diff-removed">-			// Too small, just rely now on CSS `overflow-wrap: break-word`</div><div class="diff-removed">-			// We need to recalculate the text measurement here with break-word enabled.</div><div class="diff-removed">-			const html = renderHtmlFromRichTextForMeasurement(editor, richText)</div><div class="diff-removed">-			const nextTextSizeWithOverflowBreak = editor.textMeasure.measureHtml(html, {</div><div class="diff-added">+			const html2 = renderHtmlFromRichTextForMeasurement(editor, richText)</div><div class="diff-added">+			const nextTextSizeWithOverflowBreak = editor.textMeasure.measureHtml(html2, {</div><div> 				...TEXT_PROPS,</div><div> 				fontFamily: FONT_FAMILIES[shape.props.font],</div><div> 				fontSize: fontSizeAdjustment,</div><div class="diff-removed">-				maxWidth: NOTE_SIZE - LABEL_PADDING * 2 - FUZZ,</div><div class="diff-added">+				maxWidth: NOTE_SIZE - LABEL_PADDING * 2,</div><div> 			})</div><div> 			labelHeight = nextTextSizeWithOverflowBreak.h + LABEL_PADDING * 2</div><div> 			labelWidth = nextTextSizeWithOverflowBreak.w + LABEL_PADDING * 2</div><div class="diff-info">@@ -470,9 +453,9 @@ 	} while (iterations++ < 50)</div><div> </div><div> 	return {</div><div class="diff-removed">-		labelHeight: labelHeight,</div><div class="diff-removed">-		labelWidth: labelWidth,</div><div class="diff-removed">-		fontSizeAdjustment: fontSizeAdjustment,</div><div class="diff-added">+		labelHeight,</div><div class="diff-added">+		labelWidth,</div><div class="diff-added">+		fontSizeAdjustment,</div><div> 	}</div><div> }</div><div> </div><div class="diff-info">@@ -499,19 +482,13 @@ 				const pageTransform = editor.getShapePageTransform(id)</div><div> 				const pageRotation = pageTransform.rotation()</div><div> </div><div class="diff-removed">-				// Based on the inputs, calculate the offset to the next note</div><div class="diff-removed">-				// tab controls x axis (shift inverts direction set by RTL)</div><div class="diff-removed">-				// cmd enter is the y axis (shift inverts direction)</div><div class="diff-removed">-				const isRTL = !!(</div><div class="diff-added">+				const isRTL =</div><div> 					translation.dir === 'rtl' ||</div><div class="diff-removed">-					// todo: can we check a partial of the text, so that we don't have to render the whole thing?</div><div> 					isRightToLeftLanguage(renderPlaintextFromRichText(editor, shape.props.richText))</div><div class="diff-removed">-				)</div><div> </div><div> 				const offsetLength =</div><div> 					(NOTE_SIZE +</div><div> 						editor.options.adjacentShapeMargin +</div><div class="diff-removed">-						// If we're growing down, we need to account for the current shape's growY</div><div> 						(isCmdEnter && !e.shiftKey ? shape.props.growY : 0)) *</div><div> 					shape.props.scale</div><div> </div><div class="diff-info">@@ -524,7 +501,12 @@ 					.rot(pageRotation)</div><div> 					.add(pageTransform.point())</div><div> </div><div class="diff-removed">-				const newNote = getNoteShapeForAdjacentPosition(editor, shape, adjacentCenter, pageRotation)</div><div class="diff-added">+				const newNote = getNoteShapeForAdjacentPosition(</div><div class="diff-added">+					editor,</div><div class="diff-added">+					shape,</div><div class="diff-added">+					adjacentCenter,</div><div class="diff-added">+					pageRotation</div><div class="diff-added">+				)</div><div> </div><div> 				if (newNote) {</div><div> 					editor.markHistoryStoppingPoint('editing adjacent shape')</div><div class="diff-info">@@ -549,11 +531,13 @@ 	const c = 6 * scale</div><div> 	const d = 7 * scale</div><div> 	return `0px ${a - lift}px ${a}px -${a}px rgba(15, 23, 31, .6),</div><div class="diff-removed">-	0px ${(b + lift * d) * Math.max(0, oy)}px ${c + lift * d}px -${b + lift * c}px rgba(15, 23, 31, ${(0.3 + lift * 0.1).toFixed(2)}), </div><div class="diff-removed">-	0px ${48 * scale}px ${10 * scale}px -${10 * scale}px inset rgba(15, 23, 44, ${((0.022 + random() * 0.005) * ((1 + oy) / 2)).toFixed(2)})`</div><div class="diff-added">+	0px ${(b + lift * d) * Math.max(0, oy)}px ${c + lift * d}px -${b + lift * c}px rgba(15, 23, 31, ${(0.3 +</div><div class="diff-added">+		lift * 0.1).toFixed(2)}), </div><div class="diff-added">+	0px ${48 * scale}px ${10 * scale}px -${10 * scale}px inset rgba(15, 23, 44, ${(</div><div class="diff-added">+		(0.022 + random() * 0.005) * ((1 + oy) / 2)</div><div class="diff-added">+	).toFixed(2)})`</div><div> }</div><div> </div><div> function getBoundsForSVG(shape: TLNoteShape) {</div><div class="diff-removed">-	// When rendering the SVG we don't want to adjust for scale</div><div> 	return new Box(0, 0, NOTE_SIZE, NOTE_SIZE + shape.props.growY)</div><div> }</div></pre>
                </div>
            </div>
        </section>
    </main>
    <footer>
        <p>LoCoDiff-bench - <a href="https://github.com/AbanteAI/LoCoDiff-bench">GitHub Repository</a></p>
    </footer>
</body>
</html>
    