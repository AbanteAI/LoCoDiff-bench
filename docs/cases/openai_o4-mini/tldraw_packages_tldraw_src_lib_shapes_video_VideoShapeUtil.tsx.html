<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case: packages/tldraw/src/lib/shapes/video/VideoShapeUtil.tsx - o4-mini-medium</title>
    <link rel="stylesheet" href="../../styles.css">
</head>
<body>
    <header>
        <h1>Case: packages/tldraw/src/lib/shapes/video/VideoShapeUtil.tsx</h1>
        <p><a href="../../models/openai_o4-mini.html">‚Üê Back to o4-mini-medium Cases</a> | <a href="../../index.html">Home</a></p>
    </header>
    <main>
        <section class="case-details">
            <div class="case-info">
                <h2>Benchmark Case Information</h2>
                <p><strong>Model:</strong> o4-mini-medium</p>
                <p><strong>Status:</strong> <span class="failure">Failure</span></p>
                <p><strong>Prompt Tokens:</strong> 26964</p>
                <p><strong>Output Tokens:</strong> N/A</p>
                <p><strong>Native Prompt Tokens:</strong> 27183</p>
                <p><strong>Native Completion Tokens:</strong> 6104</p>
                <p><strong>Native Tokens Reasoning:</strong> 4800</p>
                <p><strong>Native Finish Reason:</strong> stop</p>
                <p><strong>Runtime:</strong> N/As</p>
                <p><strong>Cost:</strong> $0.0567589</p>
            </div>
            
            <div class="content-links">
                <h2>View Content</h2>
                <ul>
                    <li><a href="../../content/openai_o4-mini/tldraw_packages_tldraw_src_lib_shapes_video_VideoShapeUtil.tsx/prompt.html" class="content-link">View Prompt</a></li>
                    <li><a href="../../content/openai_o4-mini/tldraw_packages_tldraw_src_lib_shapes_video_VideoShapeUtil.tsx/expected.html" class="content-link">View Expected Output</a></li>
                    <li><a href="../../content/openai_o4-mini/tldraw_packages_tldraw_src_lib_shapes_video_VideoShapeUtil.tsx/actual.html" class="content-link">View Actual Output</a></li>
                </ul>
            </div>
            
            <div class="diff-section">
                <h2>Diff (Expected vs Actual)</h2>
                <div id="diff-output">
                    <pre class="diff"><div class="diff-header">--- tldraw_packages_tldraw_src_lib_shapes_video_VideoShapeUtil.tsx_expectedoutput.txt (expected)+++ tldraw_packages_tldraw_src_lib_shapes_video_VideoShapeUtil.tsx_extracted.txt (actual)@@ -1,17 +1,18 @@ import {</div><div class="diff-removed">-	BaseBoxShapeUtil,</div><div class="diff-removed">-	HTMLContainer,</div><div class="diff-removed">-	MediaHelpers,</div><div class="diff-removed">-	SvgExportContext,</div><div class="diff-removed">-	TLAsset,</div><div class="diff-removed">-	TLVideoShape,</div><div class="diff-removed">-	toDomPrecision,</div><div class="diff-removed">-	useEditor,</div><div class="diff-removed">-	useEditorComponents,</div><div class="diff-removed">-	useIsEditing,</div><div class="diff-removed">-	videoShapeMigrations,</div><div class="diff-removed">-	videoShapeProps,</div><div class="diff-removed">-	WeakCache,</div><div class="diff-added">+  BaseBoxShapeUtil,</div><div class="diff-added">+  Editor,</div><div class="diff-added">+  HTMLContainer,</div><div class="diff-added">+  MediaHelpers,</div><div class="diff-added">+  SvgExportContext,</div><div class="diff-added">+  TLAsset,</div><div class="diff-added">+  TLVideoShape,</div><div class="diff-added">+  toDomPrecision,</div><div class="diff-added">+  useEditor,</div><div class="diff-added">+  useEditorComponents,</div><div class="diff-added">+  useIsEditing,</div><div class="diff-added">+  videoShapeMigrations,</div><div class="diff-added">+  videoShapeProps,</div><div class="diff-added">+  WeakCache,</div><div> } from '@tldraw/editor'</div><div> import classNames from 'classnames'</div><div> import { memo, ReactEventHandler, useCallback, useEffect, useRef, useState } from 'react'</div><div class="diff-info">@@ -24,166 +25,163 @@ </div><div> /** @public */</div><div> export class VideoShapeUtil extends BaseBoxShapeUtil<TLVideoShape> {</div><div class="diff-removed">-	static override type = 'video' as const</div><div class="diff-removed">-	static override props = videoShapeProps</div><div class="diff-removed">-	static override migrations = videoShapeMigrations</div><div class="diff-added">+  static override type = 'video' as const</div><div class="diff-added">+  static override props = videoShapeProps</div><div class="diff-added">+  static override migrations = videoShapeMigrations</div><div> </div><div class="diff-removed">-	override canEdit() {</div><div class="diff-removed">-		return true</div><div class="diff-removed">-	}</div><div class="diff-removed">-	override isAspectRatioLocked() {</div><div class="diff-removed">-		return true</div><div class="diff-removed">-	}</div><div class="diff-added">+  override canEdit() {</div><div class="diff-added">+    return true</div><div class="diff-added">+  }</div><div class="diff-added">+  override isAspectRatioLocked() {</div><div class="diff-added">+    return true</div><div class="diff-added">+  }</div><div> </div><div class="diff-removed">-	override getDefaultProps(): TLVideoShape['props'] {</div><div class="diff-removed">-		return {</div><div class="diff-removed">-			w: 100,</div><div class="diff-removed">-			h: 100,</div><div class="diff-removed">-			assetId: null,</div><div class="diff-removed">-			time: 0,</div><div class="diff-removed">-			playing: true,</div><div class="diff-removed">-			url: '',</div><div class="diff-removed">-			altText: '',</div><div class="diff-removed">-		}</div><div class="diff-removed">-	}</div><div class="diff-added">+  override getDefaultProps(): TLVideoShape['props'] {</div><div class="diff-added">+    return {</div><div class="diff-added">+      w: 100,</div><div class="diff-added">+      h: 100,</div><div class="diff-added">+      assetId: null,</div><div class="diff-added">+      time: 0,</div><div class="diff-added">+      playing: true,</div><div class="diff-added">+      url: '',</div><div class="diff-added">+      altText: '',</div><div class="diff-added">+    }</div><div class="diff-added">+  }</div><div> </div><div class="diff-removed">-	override getAriaDescriptor(shape: TLVideoShape) {</div><div class="diff-removed">-		return shape.props.altText</div><div class="diff-removed">-	}</div><div class="diff-added">+  override getAriaDescriptor(shape: TLVideoShape) {</div><div class="diff-added">+    return shape.props.altText</div><div class="diff-added">+  }</div><div> </div><div class="diff-removed">-	component(shape: TLVideoShape) {</div><div class="diff-removed">-		return <VideoShape shape={shape} /></div><div class="diff-removed">-	}</div><div class="diff-added">+  component(shape: TLVideoShape) {</div><div class="diff-added">+    return <VideoShape shape={shape} /></div><div class="diff-added">+  }</div><div> </div><div class="diff-removed">-	indicator(shape: TLVideoShape) {</div><div class="diff-removed">-		return <rect width={toDomPrecision(shape.props.w)} height={toDomPrecision(shape.props.h)} /></div><div class="diff-removed">-	}</div><div class="diff-added">+  indicator(shape: TLVideoShape) {</div><div class="diff-added">+    return <rect width={toDomPrecision(shape.props.w)} height={toDomPrecision(shape.props.h)} /></div><div class="diff-added">+  }</div><div> </div><div class="diff-removed">-	override async toSvg(shape: TLVideoShape, ctx: SvgExportContext) {</div><div class="diff-removed">-		if (!shape.props.assetId) return null</div><div class="diff-added">+  override async toSvg(shape: TLVideoShape, ctx: SvgExportContext) {</div><div class="diff-added">+    if (!shape.props.assetId) return null</div><div> </div><div class="diff-removed">-		const asset = this.editor.getAsset<TLAsset>(shape.props.assetId)</div><div class="diff-removed">-		if (!asset) return null</div><div class="diff-added">+    const asset = this.editor.getAsset<TLAsset>(shape.props.assetId)</div><div class="diff-added">+    if (!asset) return null</div><div> </div><div class="diff-removed">-		const src = await videoSvgExportCache.get(asset, async () => {</div><div class="diff-removed">-			const assetUrl = await ctx.resolveAssetUrl(asset.id, shape.props.w)</div><div class="diff-removed">-			if (!assetUrl) return null</div><div class="diff-removed">-			const video = await MediaHelpers.loadVideo(assetUrl)</div><div class="diff-removed">-			return await MediaHelpers.getVideoFrameAsDataUrl(video, 0)</div><div class="diff-removed">-		})</div><div class="diff-added">+    const src = await videoSvgExportCache.get(asset, async () => {</div><div class="diff-added">+      const assetUrl = await ctx.resolveAssetUrl(asset.id, shape.props.w)</div><div class="diff-added">+      if (!assetUrl) return null</div><div class="diff-added">+      const video = await MediaHelpers.loadVideo(assetUrl)</div><div class="diff-added">+      return await MediaHelpers.getVideoFrameAsDataUrl(video, 0)</div><div class="diff-added">+    })</div><div> </div><div class="diff-removed">-		if (!src) return null</div><div class="diff-added">+    if (!src) return null</div><div> </div><div class="diff-removed">-		return <image href={src} width={shape.props.w} height={shape.props.h} /></div><div class="diff-removed">-	}</div><div class="diff-added">+    return <image href={src} width={shape.props.w} height={shape.props.h} /></div><div class="diff-added">+  }</div><div> }</div><div> </div><div> const VideoShape = memo(function VideoShape({ shape }: { shape: TLVideoShape }) {</div><div class="diff-removed">-	const editor = useEditor()</div><div class="diff-removed">-	const showControls = editor.getShapeGeometry(shape).bounds.w * editor.getZoomLevel() >= 110</div><div class="diff-removed">-	const isEditing = useIsEditing(shape.id)</div><div class="diff-removed">-	const prefersReducedMotion = usePrefersReducedMotion()</div><div class="diff-removed">-	const { Spinner } = useEditorComponents()</div><div class="diff-added">+  const editor = useEditor()</div><div class="diff-added">+  const showControls = editor.getShapeGeometry(shape).bounds.w * editor.getZoomLevel() >= 110</div><div class="diff-added">+  const { asset, url } = useImageOrVideoAsset({</div><div class="diff-added">+    shapeId: shape.id,</div><div class="diff-added">+    assetId: shape.props.assetId,</div><div class="diff-added">+    width: shape.props.w,</div><div class="diff-added">+  })</div><div class="diff-added">+  const isEditing = useIsEditing(shape.id)</div><div class="diff-added">+  const prefersReducedMotion = usePrefersReducedMotion()</div><div class="diff-added">+  const { Spinner } = useEditorComponents()</div><div> </div><div class="diff-removed">-	const { asset, url } = useImageOrVideoAsset({</div><div class="diff-removed">-		shapeId: shape.id,</div><div class="diff-removed">-		assetId: shape.props.assetId,</div><div class="diff-removed">-		width: shape.props.w,</div><div class="diff-removed">-	})</div><div class="diff-added">+  const rVideo = useRef<HTMLVideoElement>(null!)</div><div> </div><div class="diff-removed">-	const rVideo = useRef<HTMLVideoElement>(null!)</div><div class="diff-added">+  const [isLoaded, setIsLoaded] = useState(false)</div><div> </div><div class="diff-removed">-	const [isLoaded, setIsLoaded] = useState(false)</div><div class="diff-added">+  const [isFullscreen, setIsFullscreen] = useState(false)</div><div> </div><div class="diff-removed">-	const [isFullscreen, setIsFullscreen] = useState(false)</div><div class="diff-added">+  useEffect(() => {</div><div class="diff-added">+    const fullscreenChange = () => setIsFullscreen(document.fullscreenElement === rVideo.current)</div><div class="diff-added">+    document.addEventListener('fullscreenchange', fullscreenChange)</div><div class="diff-added">+    return () => document.removeEventListener('fullscreenchange', fullscreenChange)</div><div class="diff-added">+  })</div><div> </div><div class="diff-removed">-	useEffect(() => {</div><div class="diff-removed">-		const fullscreenChange = () => setIsFullscreen(document.fullscreenElement === rVideo.current)</div><div class="diff-removed">-		document.addEventListener('fullscreenchange', fullscreenChange)</div><div class="diff-added">+  const handleLoadedData = useCallback<ReactEventHandler<HTMLVideoElement>>((e) => {</div><div class="diff-added">+    const video = e.currentTarget</div><div class="diff-added">+    if (!video) return</div><div class="diff-added">+    setIsLoaded(true)</div><div class="diff-added">+  }, [])</div><div> </div><div class="diff-removed">-		return () => document.removeEventListener('fullscreenchange', fullscreenChange)</div><div class="diff-removed">-	})</div><div class="diff-added">+  useEffect(() => {</div><div class="diff-added">+    const video = rVideo.current</div><div class="diff-added">+    if (!video) return</div><div class="diff-added">+    if (isEditing) {</div><div class="diff-added">+      if (document.activeElement !== video) {</div><div class="diff-added">+        video.focus()</div><div class="diff-added">+      }</div><div class="diff-added">+    }</div><div class="diff-added">+  }, [isEditing, isLoaded])</div><div> </div><div class="diff-removed">-	const handleLoadedData = useCallback<ReactEventHandler<HTMLVideoElement>>((e) => {</div><div class="diff-removed">-		const video = e.currentTarget</div><div class="diff-removed">-		if (!video) return</div><div class="diff-added">+  useEffect(() => {</div><div class="diff-added">+    if (prefersReducedMotion) {</div><div class="diff-added">+      const video = rVideo.current</div><div class="diff-added">+      if (!video) return</div><div class="diff-added">+      video.pause()</div><div class="diff-added">+      video.currentTime = 0</div><div class="diff-added">+    }</div><div class="diff-added">+  }, [rVideo, prefersReducedMotion])</div><div> </div><div class="diff-removed">-		setIsLoaded(true)</div><div class="diff-removed">-	}, [])</div><div class="diff-added">+  return (</div><div class="diff-added">+    <></div><div class="diff-added">+      <HTMLContainer</div><div class="diff-added">+        id={shape.id}</div><div class="diff-added">+        style={{</div><div class="diff-added">+          color: 'var(--color-text-3)',</div><div class="diff-added">+          backgroundColor: asset ? 'transparent' : 'var(--color-low)',</div><div class="diff-added">+          border: asset ? 'none' : '1px solid var(--color-low-border)',</div><div class="diff-added">+        }}</div><div class="diff-added">+      ></div><div class="diff-added">+        <div className="tl-counter-scaled"></div><div class="diff-added">+          <div className="tl-video-container"></div><div class="diff-added">+            {!asset ? (</div><div class="diff-added">+              <BrokenAssetIcon /></div><div class="diff-added">+            ) : Spinner && !asset.props.src ? (</div><div class="diff-added">+              <Spinner /></div><div class="diff-added">+            ) : url ? (</div><div class="diff-added">+              <></div><div class="diff-added">+                <video</div><div class="diff-added">+                  ref={rVideo}</div><div class="diff-added">+                  style={</div><div class="diff-added">+                    isEditing</div><div class="diff-added">+                      ? { pointerEvents: 'all' }</div><div class="diff-added">+                      : !isLoaded</div><div class="diff-added">+                        ? { display: 'none' }</div><div class="diff-added">+                        : undefined</div><div class="diff-added">+                  }</div><div class="diff-added">+                  className={classNames('tl-video', `tl-video-shape-${shape.id.split(':')[1]}`, {</div><div class="diff-added">+                    'tl-video-is-fullscreen': isFullscreen,</div><div class="diff-added">+                  })}</div><div class="diff-added">+                  width="100%"</div><div class="diff-added">+                  height="100%"</div><div class="diff-added">+                  draggable={false}</div><div class="diff-added">+                  playsInline</div><div class="diff-added">+                  autoPlay</div><div class="diff-added">+                  muted</div><div class="diff-added">+                  loop</div><div class="diff-added">+                  disableRemotePlayback</div><div class="diff-added">+                  disablePictureInPicture</div><div class="diff-added">+                  controls={isEditing && showControls}</div><div class="diff-added">+                  onLoadedData={handleLoadedData}</div><div class="diff-added">+                  hidden={!isLoaded}</div><div class="diff-added">+                ></div><div class="diff-added">+                  <source src={url} /></div><div class="diff-added">+                </video></div><div class="diff-added">+                {!isLoaded && Spinner && <Spinner />}</div><div class="diff-added">+              </></div><div class="diff-added">+            ) : null}</div><div class="diff-added">+          </div></div><div class="diff-added">+        </div></div><div class="diff-added">+      </HTMLContainer></div><div class="diff-added">+      {'url' in shape.props && shape.props.url && <HyperlinkButton url={shape.props.url} />}</div><div class="diff-added">+    </></div><div class="diff-added">+  )</div><div class="diff-added">+})</div><div> </div><div class="diff-removed">-	// If the current time changes and we're not editing the video, update the video time</div><div class="diff-removed">-	useEffect(() => {</div><div class="diff-removed">-		const video = rVideo.current</div><div class="diff-removed">-		if (!video) return</div><div class="diff-removed">-</div><div class="diff-removed">-		if (isEditing) {</div><div class="diff-removed">-			if (document.activeElement !== video) {</div><div class="diff-removed">-				video.focus()</div><div class="diff-removed">-			}</div><div class="diff-removed">-		}</div><div class="diff-removed">-	}, [isEditing, isLoaded])</div><div class="diff-removed">-</div><div class="diff-removed">-	useEffect(() => {</div><div class="diff-removed">-		if (prefersReducedMotion) {</div><div class="diff-removed">-			const video = rVideo.current</div><div class="diff-removed">-			if (!video) return</div><div class="diff-removed">-			video.pause()</div><div class="diff-removed">-			video.currentTime = 0</div><div class="diff-removed">-		}</div><div class="diff-removed">-	}, [rVideo, prefersReducedMotion])</div><div class="diff-removed">-</div><div class="diff-removed">-	return (</div><div class="diff-removed">-		<></div><div class="diff-removed">-			<HTMLContainer</div><div class="diff-removed">-				id={shape.id}</div><div class="diff-removed">-				style={{</div><div class="diff-removed">-					color: 'var(--color-text-3)',</div><div class="diff-removed">-					backgroundColor: asset ? 'transparent' : 'var(--color-low)',</div><div class="diff-removed">-					border: asset ? 'none' : '1px solid var(--color-low-border)',</div><div class="diff-removed">-				}}</div><div class="diff-removed">-			></div><div class="diff-removed">-				<div className="tl-counter-scaled"></div><div class="diff-removed">-					<div className="tl-video-container"></div><div class="diff-removed">-						{!asset ? (</div><div class="diff-removed">-							<BrokenAssetIcon /></div><div class="diff-removed">-						) : Spinner && !asset.props.src ? (</div><div class="diff-removed">-							<Spinner /></div><div class="diff-removed">-						) : url ? (</div><div class="diff-removed">-							<></div><div class="diff-removed">-								<video</div><div class="diff-removed">-									ref={rVideo}</div><div class="diff-removed">-									style={</div><div class="diff-removed">-										isEditing</div><div class="diff-removed">-											? { pointerEvents: 'all' }</div><div class="diff-removed">-											: !isLoaded</div><div class="diff-removed">-												? { display: 'none' }</div><div class="diff-removed">-												: undefined</div><div class="diff-removed">-									}</div><div class="diff-removed">-									className={classNames('tl-video', `tl-video-shape-${shape.id.split(':')[1]}`, {</div><div class="diff-removed">-										'tl-video-is-fullscreen': isFullscreen,</div><div class="diff-removed">-									})}</div><div class="diff-removed">-									width="100%"</div><div class="diff-removed">-									height="100%"</div><div class="diff-removed">-									draggable={false}</div><div class="diff-removed">-									playsInline</div><div class="diff-removed">-									autoPlay</div><div class="diff-removed">-									muted</div><div class="diff-removed">-									loop</div><div class="diff-removed">-									disableRemotePlayback</div><div class="diff-removed">-									disablePictureInPicture</div><div class="diff-removed">-									controls={isEditing && showControls}</div><div class="diff-removed">-									onLoadedData={handleLoadedData}</div><div class="diff-removed">-									hidden={!isLoaded}</div><div class="diff-removed">-								></div><div class="diff-removed">-									<source src={url} /></div><div class="diff-removed">-								</video></div><div class="diff-removed">-								{!isLoaded && Spinner && <Spinner />}</div><div class="diff-removed">-							</></div><div class="diff-removed">-						) : null}</div><div class="diff-removed">-					</div></div><div class="diff-removed">-				</div></div><div class="diff-removed">-			</HTMLContainer></div><div class="diff-removed">-			{'url' in shape.props && shape.props.url && <HyperlinkButton url={shape.props.url} />}</div><div class="diff-removed">-		</></div><div class="diff-removed">-	)</div><div class="diff-removed">-})+export { VideoShapeUtil }</div></pre>
                </div>
            </div>
        </section>
    </main>
    <footer>
        <p>LoCoDiff-bench - <a href="https://github.com/AbanteAI/LoCoDiff-bench">GitHub Repository</a></p>
    </footer>
</body>
</html>
    