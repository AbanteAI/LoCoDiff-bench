<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case: apps/dotcom/sync-worker/src/TLDrawDurableObject.ts - o4-mini-medium</title>
    <link rel="stylesheet" href="../../styles.css">
</head>
<body>
    <header>
        <h1>Case: apps/dotcom/sync-worker/src/TLDrawDurableObject.ts</h1>
        <p><a href="../../models/openai_o4-mini.html">‚Üê Back to o4-mini-medium Cases</a> | <a href="../../index.html">Home</a></p>
    </header>
    <main>
        <section class="case-details">
            <div class="case-info">
                <h2>Benchmark Case Information</h2>
                <p><strong>Model:</strong> o4-mini-medium</p>
                <p><strong>Status:</strong> <span class="failure">Failure</span></p>
                <p><strong>Prompt Tokens:</strong> 47089</p>
                <p><strong>Output Tokens:</strong> N/A</p>
                <p><strong>Runtime:</strong> N/As</p>
                <p><strong>Cost:</strong> $0.005250135</p>
            </div>
            
            <div class="content-links">
                <h2>View Content</h2>
                <ul>
                    <li><a href="../../content/openai_o4-mini/tldraw_apps_dotcom_sync-worker_src_TLDrawDurableObject.ts/prompt.html" class="content-link">View Prompt</a></li>
                    <li><a href="../../content/openai_o4-mini/tldraw_apps_dotcom_sync-worker_src_TLDrawDurableObject.ts/expected.html" class="content-link">View Expected Output</a></li>
                    <li><a href="../../content/openai_o4-mini/tldraw_apps_dotcom_sync-worker_src_TLDrawDurableObject.ts/actual.html" class="content-link">View Actual Output</a></li>
                </ul>
            </div>
            
            <div class="diff-section">
                <h2>Diff (Expected vs Actual)</h2>
                <div id="diff-output">
                    <pre class="diff"><div class="diff-header">--- tldraw_apps_dotcom_sync-worker_src_TLDrawDurableObject.ts_expectedoutput.txt (expected)+++ tldraw_apps_dotcom_sync-worker_src_TLDrawDurableObject.ts_extracted.txt (actual)@@ -3,45 +3,40 @@ </div><div> import { SupabaseClient } from '@supabase/supabase-js'</div><div> import {</div><div class="diff-removed">-	APP_ASSET_UPLOAD_ENDPOINT,</div><div class="diff-removed">-	DB,</div><div class="diff-removed">-	FILE_PREFIX,</div><div class="diff-removed">-	LOCAL_FILE_PREFIX,</div><div class="diff-removed">-	PUBLISH_PREFIX,</div><div class="diff-removed">-	READ_ONLY_LEGACY_PREFIX,</div><div class="diff-removed">-	READ_ONLY_PREFIX,</div><div class="diff-removed">-	ROOM_OPEN_MODE,</div><div class="diff-removed">-	ROOM_PREFIX,</div><div class="diff-removed">-	SNAPSHOT_PREFIX,</div><div class="diff-removed">-	TlaFile,</div><div class="diff-removed">-	type RoomOpenMode,</div><div class="diff-added">+ 	DB,</div><div class="diff-added">+ 	FILE_PREFIX,</div><div class="diff-added">+ 	PUBLISH_PREFIX,</div><div class="diff-added">+ 	READ_ONLY_LEGACY_PREFIX,</div><div class="diff-added">+ 	READ_ONLY_PREFIX,</div><div class="diff-added">+ 	ROOM_OPEN_MODE,</div><div class="diff-added">+ 	ROOM_PREFIX,</div><div class="diff-added">+ 	SNAPSHOT_PREFIX,</div><div class="diff-added">+ 	type RoomOpenMode,</div><div> } from '@tldraw/dotcom-shared'</div><div> import {</div><div class="diff-removed">-	RoomSnapshot,</div><div class="diff-removed">-	TLSocketRoom,</div><div class="diff-removed">-	TLSyncErrorCloseEventCode,</div><div class="diff-removed">-	TLSyncErrorCloseEventReason,</div><div class="diff-removed">-	TLSyncRoom,</div><div class="diff-removed">-	type PersistedRoomSnapshotForSupabase,</div><div class="diff-added">+ 	RoomSnapshot,</div><div class="diff-added">+ 	TLSocketRoom,</div><div class="diff-added">+ 	TLSyncErrorCloseEventCode,</div><div class="diff-added">+ 	TLSyncErrorCloseEventReason,</div><div class="diff-added">+ 	TLSyncRoom,</div><div class="diff-added">+ 	type PersistedRoomSnapshotForSupabase,</div><div> } from '@tldraw/sync-core'</div><div> import { TLDOCUMENT_ID, TLDocument, TLRecord, createTLSchema } from '@tldraw/tlschema'</div><div> import {</div><div class="diff-removed">-	ExecutionQueue,</div><div class="diff-removed">-	assert,</div><div class="diff-removed">-	assertExists,</div><div class="diff-removed">-	exhaustiveSwitchError,</div><div class="diff-removed">-	retry,</div><div class="diff-removed">-	uniqueId,</div><div class="diff-added">+ 	ExecutionQueue,</div><div class="diff-added">+ 	assert,</div><div class="diff-added">+ 	assertExists,</div><div class="diff-added">+ 	exhaustiveSwitchError,</div><div class="diff-added">+ 	retry,</div><div class="diff-added">+ 	uniqueId,</div><div> } from '@tldraw/utils'</div><div> import { createSentry } from '@tldraw/worker-shared'</div><div> import { DurableObject } from 'cloudflare:workers'</div><div> import { IRequest, Router } from 'itty-router'</div><div class="diff-removed">-import { Kysely } from 'kysely'</div><div> import { AlarmScheduler } from './AlarmScheduler'</div><div> import { PERSIST_INTERVAL_MS } from './config'</div><div> import { createPostgresConnectionPool } from './postgres'</div><div> import { getR2KeyForRoom } from './r2'</div><div class="diff-removed">-import { getPublishedRoomSnapshot } from './routes/tla/getPublishedFile'</div><div> import { Analytics, DBLoadResult, Environment, TLServerEvent } from './types'</div><div> import { EventData, writeDataPoint } from './utils/analytics'</div><div> import { createSupabaseClient } from './utils/createSupabaseClient'</div><div class="diff-info">@@ -52,847 +47,695 @@ import { getAuth } from './utils/tla/getAuth'</div><div> import { getLegacyRoomData } from './utils/tla/getLegacyRoomData'</div><div> </div><div class="diff-removed">-const MAX_CONNECTIONS = 50</div><div class="diff-removed">-</div><div class="diff-removed">-// increment this any time you make a change to this type</div><div class="diff-removed">-const CURRENT_DOCUMENT_INFO_VERSION = 3</div><div> interface DocumentInfo {</div><div class="diff-removed">-	version: number</div><div class="diff-removed">-	slug: string</div><div class="diff-removed">-	isApp: boolean</div><div class="diff-removed">-	deleted: boolean</div><div class="diff-added">+ 	version: number</div><div class="diff-added">+ 	slug: string</div><div class="diff-added">+ 	isApp: boolean</div><div class="diff-added">+ 	deleted: boolean</div><div> }</div><div> </div><div class="diff-removed">-const ROOM_NOT_FOUND = Symbol('room_not_found')</div><div class="diff-removed">-</div><div> interface SessionMeta {</div><div class="diff-removed">-	storeId: string</div><div class="diff-removed">-	userId: string | null</div><div class="diff-added">+ 	storeId: string</div><div class="diff-added">+ 	userId: string | null</div><div> }</div><div> </div><div> export class TLDrawDurableObject extends DurableObject {</div><div class="diff-removed">-	// A unique identifier for this instance of the Durable Object</div><div class="diff-removed">-	id: DurableObjectId</div><div class="diff-removed">-</div><div class="diff-removed">-	_room: Promise<TLSocketRoom<TLRecord, SessionMeta>> | null = null</div><div class="diff-removed">-</div><div class="diff-removed">-	sentry: ReturnType<typeof createSentry> | null = null</div><div class="diff-removed">-</div><div class="diff-removed">-	getRoom() {</div><div class="diff-removed">-		if (!this._documentInfo) {</div><div class="diff-removed">-			throw new Error('documentInfo must be present when accessing room')</div><div class="diff-removed">-		}</div><div class="diff-removed">-		const slug = this._documentInfo.slug</div><div class="diff-removed">-		if (!this._room) {</div><div class="diff-removed">-			this._room = this.loadFromDatabase(slug).then(async (result) => {</div><div class="diff-removed">-				switch (result.type) {</div><div class="diff-removed">-					case 'room_found': {</div><div class="diff-removed">-						const room = new TLSocketRoom<TLRecord, SessionMeta>({</div><div class="diff-removed">-							initialSnapshot: result.snapshot,</div><div class="diff-removed">-							onSessionRemoved: async (room, args) => {</div><div class="diff-removed">-								this.logEvent({</div><div class="diff-removed">-									type: 'client',</div><div class="diff-removed">-									roomId: slug,</div><div class="diff-removed">-									name: 'leave',</div><div class="diff-removed">-									instanceId: args.sessionId,</div><div class="diff-removed">-									localClientId: args.meta.storeId,</div><div class="diff-removed">-								})</div><div class="diff-removed">-</div><div class="diff-removed">-								if (args.numSessionsRemaining > 0) return</div><div class="diff-removed">-								if (!this._room) return</div><div class="diff-removed">-								this.logEvent({</div><div class="diff-removed">-									type: 'client',</div><div class="diff-removed">-									roomId: slug,</div><div class="diff-removed">-									name: 'last_out',</div><div class="diff-removed">-									instanceId: args.sessionId,</div><div class="diff-removed">-									localClientId: args.meta.storeId,</div><div class="diff-removed">-								})</div><div class="diff-removed">-								try {</div><div class="diff-removed">-									await this.persistToDatabase()</div><div class="diff-removed">-								} catch {</div><div class="diff-removed">-									// already logged</div><div class="diff-removed">-								}</div><div class="diff-removed">-								// make sure nobody joined the room while we were persisting</div><div class="diff-removed">-								if (room.getNumActiveSessions() > 0) return</div><div class="diff-removed">-								this._room = null</div><div class="diff-removed">-								this.logEvent({ type: 'room', roomId: slug, name: 'room_empty' })</div><div class="diff-removed">-								room.close()</div><div class="diff-removed">-							},</div><div class="diff-removed">-							onDataChange: () => {</div><div class="diff-removed">-								this.triggerPersistSchedule()</div><div class="diff-removed">-							},</div><div class="diff-removed">-							onBeforeSendMessage: ({ message, stringified }) => {</div><div class="diff-removed">-								this.logEvent({</div><div class="diff-removed">-									type: 'send_message',</div><div class="diff-removed">-									roomId: slug,</div><div class="diff-removed">-									messageType: message.type,</div><div class="diff-removed">-									messageLength: stringified.length,</div><div class="diff-removed">-								})</div><div class="diff-removed">-							},</div><div class="diff-removed">-						})</div><div class="diff-removed">-</div><div class="diff-removed">-						this.logEvent({ type: 'room', roomId: slug, name: 'room_start' })</div><div class="diff-removed">-						// Also associate file assets after we load the room</div><div class="diff-removed">-						setTimeout(this.maybeAssociateFileAssets.bind(this), PERSIST_INTERVAL_MS)</div><div class="diff-removed">-						return room</div><div class="diff-removed">-					}</div><div class="diff-removed">-					case 'room_not_found': {</div><div class="diff-removed">-						throw ROOM_NOT_FOUND</div><div class="diff-removed">-					}</div><div class="diff-removed">-					case 'error': {</div><div class="diff-removed">-						throw result.error</div><div class="diff-removed">-					}</div><div class="diff-removed">-					default: {</div><div class="diff-removed">-						exhaustiveSwitchError(result)</div><div class="diff-removed">-					}</div><div class="diff-removed">-				}</div><div class="diff-removed">-			})</div><div class="diff-removed">-		}</div><div class="diff-removed">-		return this._room</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	// For storage</div><div class="diff-removed">-	storage: DurableObjectStorage</div><div class="diff-removed">-</div><div class="diff-removed">-	// For persistence</div><div class="diff-removed">-	supabaseClient: SupabaseClient | void</div><div class="diff-removed">-</div><div class="diff-removed">-	// For analytics</div><div class="diff-removed">-	measure: Analytics | undefined</div><div class="diff-removed">-</div><div class="diff-removed">-	// For error tracking</div><div class="diff-removed">-	sentryDSN: string | undefined</div><div class="diff-removed">-</div><div class="diff-removed">-	readonly supabaseTable: string</div><div class="diff-removed">-	readonly r2: {</div><div class="diff-removed">-		readonly rooms: R2Bucket</div><div class="diff-removed">-		readonly versionCache: R2Bucket</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	_documentInfo: DocumentInfo | null = null</div><div class="diff-removed">-</div><div class="diff-removed">-	db: Kysely<DB></div><div class="diff-removed">-</div><div class="diff-removed">-	constructor(</div><div class="diff-removed">-		private state: DurableObjectState,</div><div class="diff-removed">-		override env: Environment</div><div class="diff-removed">-	) {</div><div class="diff-removed">-		super(state, env)</div><div class="diff-removed">-		this.id = state.id</div><div class="diff-removed">-		this.storage = state.storage</div><div class="diff-removed">-		this.sentryDSN = env.SENTRY_DSN</div><div class="diff-removed">-		this.measure = env.MEASURE</div><div class="diff-removed">-		this.sentry = createSentry(this.state, this.env)</div><div class="diff-removed">-		this.supabaseClient = createSupabaseClient(env)</div><div class="diff-removed">-</div><div class="diff-removed">-		this.supabaseTable = env.TLDRAW_ENV === 'production' ? 'drawings' : 'drawings_staging'</div><div class="diff-removed">-		this.r2 = {</div><div class="diff-removed">-			rooms: env.ROOMS,</div><div class="diff-removed">-			versionCache: env.ROOMS_HISTORY_EPHEMERAL,</div><div class="diff-removed">-		}</div><div class="diff-removed">-</div><div class="diff-removed">-		state.blockConcurrencyWhile(async () => {</div><div class="diff-removed">-			const existingDocumentInfo = (await this.storage.get('documentInfo')) as DocumentInfo | null</div><div class="diff-removed">-			if (existingDocumentInfo?.version !== CURRENT_DOCUMENT_INFO_VERSION) {</div><div class="diff-removed">-				this._documentInfo = null</div><div class="diff-removed">-			} else {</div><div class="diff-removed">-				this._documentInfo = existingDocumentInfo</div><div class="diff-removed">-			}</div><div class="diff-removed">-		})</div><div class="diff-removed">-		this.db = createPostgresConnectionPool(env, 'TLDrawDurableObject')</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	readonly router = Router()</div><div class="diff-removed">-		.get(</div><div class="diff-removed">-			`/${ROOM_PREFIX}/:roomId`,</div><div class="diff-removed">-			(req) => this.extractDocumentInfoFromRequest(req, ROOM_OPEN_MODE.READ_WRITE),</div><div class="diff-removed">-			(req) => this.onRequest(req, ROOM_OPEN_MODE.READ_WRITE)</div><div class="diff-removed">-		)</div><div class="diff-removed">-		.get(</div><div class="diff-removed">-			`/${READ_ONLY_LEGACY_PREFIX}/:roomId`,</div><div class="diff-removed">-			(req) => this.extractDocumentInfoFromRequest(req, ROOM_OPEN_MODE.READ_ONLY_LEGACY),</div><div class="diff-removed">-			(req) => this.onRequest(req, ROOM_OPEN_MODE.READ_ONLY_LEGACY)</div><div class="diff-removed">-		)</div><div class="diff-removed">-		.get(</div><div class="diff-removed">-			`/${READ_ONLY_PREFIX}/:roomId`,</div><div class="diff-removed">-			(req) => this.extractDocumentInfoFromRequest(req, ROOM_OPEN_MODE.READ_ONLY),</div><div class="diff-removed">-			(req) => this.onRequest(req, ROOM_OPEN_MODE.READ_ONLY)</div><div class="diff-removed">-		)</div><div class="diff-removed">-		.get(</div><div class="diff-removed">-			`/app/file/:roomId`,</div><div class="diff-removed">-			(req) => this.extractDocumentInfoFromRequest(req, ROOM_OPEN_MODE.READ_WRITE),</div><div class="diff-removed">-			(req) => this.onRequest(req, ROOM_OPEN_MODE.READ_WRITE)</div><div class="diff-removed">-		)</div><div class="diff-removed">-		.post(</div><div class="diff-removed">-			`/${ROOM_PREFIX}/:roomId/restore`,</div><div class="diff-removed">-			(req) => this.extractDocumentInfoFromRequest(req, ROOM_OPEN_MODE.READ_WRITE),</div><div class="diff-removed">-			(req) => this.onRestore(req)</div><div class="diff-removed">-		)</div><div class="diff-removed">-		.all('*', () => new Response('Not found', { status: 404 }))</div><div class="diff-removed">-</div><div class="diff-removed">-	readonly scheduler = new AlarmScheduler({</div><div class="diff-removed">-		storage: () => this.storage,</div><div class="diff-removed">-		alarms: {</div><div class="diff-removed">-			persist: async () => {</div><div class="diff-removed">-				this.persistToDatabase()</div><div class="diff-removed">-			},</div><div class="diff-removed">-		},</div><div class="diff-removed">-	})</div><div class="diff-removed">-</div><div class="diff-removed">-	// eslint-disable-next-line no-restricted-syntax</div><div class="diff-removed">-	get documentInfo() {</div><div class="diff-removed">-		return assertExists(this._documentInfo, 'documentInfo must be present')</div><div class="diff-removed">-	}</div><div class="diff-removed">-	setDocumentInfo(info: DocumentInfo) {</div><div class="diff-removed">-		this._documentInfo = info</div><div class="diff-removed">-		this.storage.put('documentInfo', info)</div><div class="diff-removed">-	}</div><div class="diff-removed">-	async extractDocumentInfoFromRequest(req: IRequest, roomOpenMode: RoomOpenMode) {</div><div class="diff-removed">-		const slug = assertExists(</div><div class="diff-removed">-			await getSlug(this.env, req.params.roomId, roomOpenMode),</div><div class="diff-removed">-			'roomId must be present'</div><div class="diff-removed">-		)</div><div class="diff-removed">-		const isApp = new URL(req.url).pathname.startsWith('/app/')</div><div class="diff-removed">-</div><div class="diff-removed">-		if (this._documentInfo) {</div><div class="diff-removed">-			assert(this._documentInfo.slug === slug, 'slug must match')</div><div class="diff-removed">-		} else {</div><div class="diff-removed">-			this.setDocumentInfo({</div><div class="diff-removed">-				version: CURRENT_DOCUMENT_INFO_VERSION,</div><div class="diff-removed">-				slug,</div><div class="diff-removed">-				isApp,</div><div class="diff-removed">-				deleted: false,</div><div class="diff-removed">-			})</div><div class="diff-removed">-		}</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	// Handle a request to the Durable Object.</div><div class="diff-removed">-	override async fetch(req: IRequest) {</div><div class="diff-removed">-		const sentry = createSentry(this.state, this.env, req)</div><div class="diff-removed">-</div><div class="diff-removed">-		try {</div><div class="diff-removed">-			return await this.router.fetch(req)</div><div class="diff-removed">-		} catch (err) {</div><div class="diff-removed">-			console.error(err)</div><div class="diff-removed">-			// eslint-disable-next-line @typescript-eslint/no-deprecated</div><div class="diff-removed">-			sentry?.captureException(err)</div><div class="diff-removed">-			return new Response('Something went wrong', {</div><div class="diff-removed">-				status: 500,</div><div class="diff-removed">-				statusText: 'Internal Server Error',</div><div class="diff-removed">-			})</div><div class="diff-removed">-		}</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	_isRestoring = false</div><div class="diff-removed">-	async onRestore(req: IRequest) {</div><div class="diff-removed">-		this._isRestoring = true</div><div class="diff-removed">-		try {</div><div class="diff-removed">-			const roomId = this.documentInfo.slug</div><div class="diff-removed">-			const roomKey = getR2KeyForRoom({ slug: roomId, isApp: this.documentInfo.isApp })</div><div class="diff-removed">-			const timestamp = ((await req.json()) as any).timestamp</div><div class="diff-removed">-			if (!timestamp) {</div><div class="diff-removed">-				return new Response('Missing timestamp', { status: 400 })</div><div class="diff-removed">-			}</div><div class="diff-removed">-			const data = await this.r2.versionCache.get(`${roomKey}/${timestamp}`)</div><div class="diff-removed">-			if (!data) {</div><div class="diff-removed">-				return new Response('Version not found', { status: 400 })</div><div class="diff-removed">-			}</div><div class="diff-removed">-			const dataText = await data.text()</div><div class="diff-removed">-			await this.r2.rooms.put(roomKey, dataText)</div><div class="diff-removed">-			const room = await this.getRoom()</div><div class="diff-removed">-</div><div class="diff-removed">-			const snapshot: RoomSnapshot = JSON.parse(dataText)</div><div class="diff-removed">-			room.loadSnapshot(snapshot)</div><div class="diff-removed">-			this.maybeAssociateFileAssets()</div><div class="diff-removed">-</div><div class="diff-removed">-			return new Response()</div><div class="diff-removed">-		} finally {</div><div class="diff-removed">-			this._isRestoring = false</div><div class="diff-removed">-		}</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	// this might return null if the file doesn't exist yet in the backend, or if it was deleted</div><div class="diff-removed">-	_fileRecordCache: TlaFile | null = null</div><div class="diff-removed">-	async getAppFileRecord(): Promise<TlaFile | null> {</div><div class="diff-removed">-		try {</div><div class="diff-removed">-			return await retry(</div><div class="diff-removed">-				async () => {</div><div class="diff-removed">-					if (this._fileRecordCache) {</div><div class="diff-removed">-						return this._fileRecordCache</div><div class="diff-removed">-					}</div><div class="diff-removed">-					const result = await this.db</div><div class="diff-removed">-						.selectFrom('file')</div><div class="diff-removed">-						.where('id', '=', this.documentInfo.slug)</div><div class="diff-removed">-						.selectAll()</div><div class="diff-removed">-						.executeTakeFirst()</div><div class="diff-removed">-					if (!result) {</div><div class="diff-removed">-						throw new Error('File not found')</div><div class="diff-removed">-					}</div><div class="diff-removed">-					this._fileRecordCache = result</div><div class="diff-removed">-					return this._fileRecordCache</div><div class="diff-removed">-				},</div><div class="diff-removed">-				{</div><div class="diff-removed">-					attempts: 10,</div><div class="diff-removed">-					waitDuration: 100,</div><div class="diff-removed">-				}</div><div class="diff-removed">-			)</div><div class="diff-removed">-		} catch (_e) {</div><div class="diff-removed">-			return null</div><div class="diff-removed">-		}</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	async onRequest(req: IRequest, openMode: RoomOpenMode) {</div><div class="diff-removed">-		// extract query params from request, should include instanceId</div><div class="diff-removed">-		const url = new URL(req.url)</div><div class="diff-removed">-		const params = Object.fromEntries(url.searchParams.entries())</div><div class="diff-removed">-		let { sessionId, storeId } = params</div><div class="diff-removed">-</div><div class="diff-removed">-		// handle legacy param names</div><div class="diff-removed">-		sessionId ??= params.sessionKey ?? params.instanceId</div><div class="diff-removed">-		storeId ??= params.localClientId</div><div class="diff-removed">-		const isNewSession = !this._room</div><div class="diff-removed">-</div><div class="diff-removed">-		// Create the websocket pair for the client</div><div class="diff-removed">-		const { 0: clientWebSocket, 1: serverWebSocket } = new WebSocketPair()</div><div class="diff-removed">-		serverWebSocket.accept()</div><div class="diff-removed">-</div><div class="diff-removed">-		const closeSocket = (reason: TLSyncErrorCloseEventReason) => {</div><div class="diff-removed">-			serverWebSocket.close(TLSyncErrorCloseEventCode, reason)</div><div class="diff-removed">-			return new Response(null, { status: 101, webSocket: clientWebSocket })</div><div class="diff-removed">-		}</div><div class="diff-removed">-</div><div class="diff-removed">-		if (this.documentInfo.deleted) {</div><div class="diff-removed">-			return closeSocket(TLSyncErrorCloseEventReason.NOT_FOUND)</div><div class="diff-removed">-		}</div><div class="diff-removed">-</div><div class="diff-removed">-		const auth = await getAuth(req, this.env)</div><div class="diff-removed">-		if (this.documentInfo.isApp) {</div><div class="diff-removed">-			openMode = ROOM_OPEN_MODE.READ_WRITE</div><div class="diff-removed">-			const file = await this.getAppFileRecord()</div><div class="diff-removed">-</div><div class="diff-removed">-			if (file) {</div><div class="diff-removed">-				if (file.isDeleted) {</div><div class="diff-removed">-					return closeSocket(TLSyncErrorCloseEventReason.NOT_FOUND)</div><div class="diff-removed">-				}</div><div class="diff-removed">-				if (!auth && !file.shared) {</div><div class="diff-removed">-					return closeSocket(TLSyncErrorCloseEventReason.NOT_AUTHENTICATED)</div><div class="diff-removed">-				}</div><div class="diff-removed">-				if (auth?.userId) {</div><div class="diff-removed">-					const rateLimited = await isRateLimited(this.env, auth?.userId)</div><div class="diff-removed">-					if (rateLimited) {</div><div class="diff-removed">-						this.logEvent({</div><div class="diff-removed">-							type: 'client',</div><div class="diff-removed">-							userId: auth.userId,</div><div class="diff-removed">-							localClientId: storeId,</div><div class="diff-removed">-							name: 'rate_limited',</div><div class="diff-removed">-						})</div><div class="diff-removed">-						return closeSocket(TLSyncErrorCloseEventReason.RATE_LIMITED)</div><div class="diff-removed">-					}</div><div class="diff-removed">-				} else {</div><div class="diff-removed">-					const rateLimited = await isRateLimited(this.env, sessionId)</div><div class="diff-removed">-					if (rateLimited) {</div><div class="diff-removed">-						this.logEvent({</div><div class="diff-removed">-							type: 'client',</div><div class="diff-removed">-							userId: auth?.userId,</div><div class="diff-removed">-							localClientId: storeId,</div><div class="diff-removed">-							name: 'rate_limited',</div><div class="diff-removed">-						})</div><div class="diff-removed">-						return closeSocket(TLSyncErrorCloseEventReason.RATE_LIMITED)</div><div class="diff-removed">-					}</div><div class="diff-removed">-				}</div><div class="diff-removed">-				if (file.ownerId !== auth?.userId) {</div><div class="diff-removed">-					if (!file.shared) {</div><div class="diff-removed">-						return closeSocket(TLSyncErrorCloseEventReason.FORBIDDEN)</div><div class="diff-removed">-					}</div><div class="diff-removed">-					if (file.sharedLinkType === 'view') {</div><div class="diff-removed">-						openMode = ROOM_OPEN_MODE.READ_ONLY</div><div class="diff-removed">-					}</div><div class="diff-removed">-				}</div><div class="diff-removed">-			}</div><div class="diff-removed">-		}</div><div class="diff-removed">-</div><div class="diff-removed">-		try {</div><div class="diff-removed">-			const room = await this.getRoom()</div><div class="diff-removed">-			// Don't connect if we're already at max connections</div><div class="diff-removed">-			if (room.getNumActiveSessions() > MAX_CONNECTIONS) {</div><div class="diff-removed">-				return closeSocket(TLSyncErrorCloseEventReason.ROOM_FULL)</div><div class="diff-removed">-			}</div><div class="diff-removed">-</div><div class="diff-removed">-			// all good</div><div class="diff-removed">-			room.handleSocketConnect({</div><div class="diff-removed">-				sessionId: sessionId,</div><div class="diff-removed">-				socket: serverWebSocket,</div><div class="diff-removed">-				meta: {</div><div class="diff-removed">-					storeId,</div><div class="diff-removed">-					userId: auth?.userId ? auth.userId : null,</div><div class="diff-removed">-				},</div><div class="diff-removed">-				isReadonly:</div><div class="diff-removed">-					openMode === ROOM_OPEN_MODE.READ_ONLY || openMode === ROOM_OPEN_MODE.READ_ONLY_LEGACY,</div><div class="diff-removed">-			})</div><div class="diff-removed">-			if (isNewSession) {</div><div class="diff-removed">-				this.logEvent({</div><div class="diff-removed">-					type: 'client',</div><div class="diff-removed">-					roomId: this.documentInfo.slug,</div><div class="diff-removed">-					name: 'room_reopen',</div><div class="diff-removed">-					instanceId: sessionId,</div><div class="diff-removed">-					localClientId: storeId,</div><div class="diff-removed">-				})</div><div class="diff-removed">-			}</div><div class="diff-removed">-			this.logEvent({</div><div class="diff-removed">-				type: 'client',</div><div class="diff-removed">-				roomId: this.documentInfo.slug,</div><div class="diff-removed">-				name: 'enter',</div><div class="diff-removed">-				instanceId: sessionId,</div><div class="diff-removed">-				localClientId: storeId,</div><div class="diff-removed">-			})</div><div class="diff-removed">-			return new Response(null, { status: 101, webSocket: clientWebSocket })</div><div class="diff-removed">-		} catch (e) {</div><div class="diff-removed">-			if (e === ROOM_NOT_FOUND) {</div><div class="diff-removed">-				return closeSocket(TLSyncErrorCloseEventReason.NOT_FOUND)</div><div class="diff-removed">-			}</div><div class="diff-removed">-			throw e</div><div class="diff-removed">-		}</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	triggerPersistSchedule = throttle(() => {</div><div class="diff-removed">-		this.schedulePersist()</div><div class="diff-removed">-	}, 2000)</div><div class="diff-removed">-</div><div class="diff-removed">-	private writeEvent(name: string, eventData: EventData) {</div><div class="diff-removed">-		writeDataPoint(this.sentry, this.measure, this.env, name, eventData)</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	logEvent(event: TLServerEvent) {</div><div class="diff-removed">-		switch (event.type) {</div><div class="diff-removed">-			case 'room': {</div><div class="diff-removed">-				// we would add user/connection ids here if we could</div><div class="diff-removed">-				this.writeEvent(event.name, { blobs: [event.roomId] })</div><div class="diff-removed">-				break</div><div class="diff-removed">-			}</div><div class="diff-removed">-			case 'client': {</div><div class="diff-removed">-				if (event.name === 'rate_limited') {</div><div class="diff-removed">-					this.writeEvent(event.name, {</div><div class="diff-removed">-						blobs: [event.userId ?? 'anon-user'],</div><div class="diff-removed">-						indexes: [event.localClientId],</div><div class="diff-removed">-					})</div><div class="diff-removed">-				} else {</div><div class="diff-removed">-					// we would add user/connection ids here if we could</div><div class="diff-removed">-					this.writeEvent(event.name, {</div><div class="diff-removed">-						blobs: [event.roomId, 'unused', event.instanceId],</div><div class="diff-removed">-						indexes: [event.localClientId],</div><div class="diff-removed">-					})</div><div class="diff-removed">-				}</div><div class="diff-removed">-				break</div><div class="diff-removed">-			}</div><div class="diff-removed">-			case 'send_message': {</div><div class="diff-removed">-				this.writeEvent(event.type, {</div><div class="diff-removed">-					blobs: [event.roomId, event.messageType],</div><div class="diff-removed">-					doubles: [event.messageLength],</div><div class="diff-removed">-				})</div><div class="diff-removed">-				break</div><div class="diff-removed">-			}</div><div class="diff-removed">-			default: {</div><div class="diff-removed">-				exhaustiveSwitchError(event)</div><div class="diff-removed">-			}</div><div class="diff-removed">-		}</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	async handleFileCreateFromSource() {</div><div class="diff-removed">-		assert(this._fileRecordCache, 'we need to have a file record to create a file from source')</div><div class="diff-removed">-		const split = this._fileRecordCache.createSource?.split('/')</div><div class="diff-removed">-		if (!split || split?.length !== 2) {</div><div class="diff-removed">-			return { type: 'room_not_found' as const }</div><div class="diff-removed">-		}</div><div class="diff-removed">-</div><div class="diff-removed">-		let data: RoomSnapshot | string | null | undefined = undefined</div><div class="diff-removed">-		const [prefix, id] = split</div><div class="diff-removed">-		switch (prefix) {</div><div class="diff-removed">-			case FILE_PREFIX: {</div><div class="diff-removed">-				await getRoomDurableObject(this.env, id).awaitPersist()</div><div class="diff-removed">-				data = await this.r2.rooms</div><div class="diff-removed">-					.get(getR2KeyForRoom({ slug: id, isApp: true }))</div><div class="diff-removed">-					.then((r) => r?.text())</div><div class="diff-removed">-				break</div><div class="diff-removed">-			}</div><div class="diff-removed">-			case ROOM_PREFIX:</div><div class="diff-removed">-				data = await getLegacyRoomData(this.env, id, ROOM_OPEN_MODE.READ_WRITE)</div><div class="diff-removed">-				break</div><div class="diff-removed">-			case READ_ONLY_PREFIX:</div><div class="diff-removed">-				data = await getLegacyRoomData(this.env, id, ROOM_OPEN_MODE.READ_ONLY)</div><div class="diff-removed">-				break</div><div class="diff-removed">-			case READ_ONLY_LEGACY_PREFIX:</div><div class="diff-removed">-				data = await getLegacyRoomData(this.env, id, ROOM_OPEN_MODE.READ_ONLY_LEGACY)</div><div class="diff-removed">-				break</div><div class="diff-removed">-			case SNAPSHOT_PREFIX:</div><div class="diff-removed">-				data = await getLegacyRoomData(this.env, id, 'snapshot')</div><div class="diff-removed">-				break</div><div class="diff-removed">-			case PUBLISH_PREFIX:</div><div class="diff-removed">-				data = await getPublishedRoomSnapshot(this.env, id)</div><div class="diff-removed">-				break</div><div class="diff-removed">-			case LOCAL_FILE_PREFIX:</div><div class="diff-removed">-				// create empty room, the client will populate it</div><div class="diff-removed">-				data = new TLSyncRoom({ schema: createTLSchema() }).getSnapshot()</div><div class="diff-removed">-				break</div><div class="diff-removed">-		}</div><div class="diff-removed">-</div><div class="diff-removed">-		if (!data) {</div><div class="diff-removed">-			return { type: 'room_not_found' as const }</div><div class="diff-removed">-		}</div><div class="diff-removed">-		const serialized = typeof data === 'string' ? data : JSON.stringify(data)</div><div class="diff-removed">-		const snapshot = typeof data === 'string' ? JSON.parse(data) : data</div><div class="diff-removed">-		await this.r2.rooms.put(this._fileRecordCache.id, serialized)</div><div class="diff-removed">-		return { type: 'room_found' as const, snapshot }</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	// Load the room's drawing data. First we check the R2 bucket, then we fallback to supabase (legacy).</div><div class="diff-removed">-	async loadFromDatabase(slug: string): Promise<DBLoadResult> {</div><div class="diff-removed">-		try {</div><div class="diff-removed">-			const key = getR2KeyForRoom({ slug, isApp: this.documentInfo.isApp })</div><div class="diff-removed">-			// when loading, prefer to fetch documents from the bucket</div><div class="diff-removed">-			const roomFromBucket = await this.r2.rooms.get(key)</div><div class="diff-removed">-			if (roomFromBucket) {</div><div class="diff-removed">-				return { type: 'room_found', snapshot: await roomFromBucket.json() }</div><div class="diff-removed">-			}</div><div class="diff-removed">-			if (this._fileRecordCache?.createSource) {</div><div class="diff-removed">-				const res = await this.handleFileCreateFromSource()</div><div class="diff-removed">-				if (res.type === 'room_found') {</div><div class="diff-removed">-					// save it to the bucket so we don't try to create from source again</div><div class="diff-removed">-					await this.r2.rooms.put(key, JSON.stringify(res.snapshot))</div><div class="diff-removed">-				}</div><div class="diff-removed">-				return res</div><div class="diff-removed">-			}</div><div class="diff-removed">-</div><div class="diff-removed">-			if (this.documentInfo.isApp) {</div><div class="diff-removed">-				// finally check whether the file exists in the DB but not in R2 yet</div><div class="diff-removed">-				const file = await this.getAppFileRecord()</div><div class="diff-removed">-				if (!file) {</div><div class="diff-removed">-					return { type: 'room_not_found' }</div><div class="diff-removed">-				}</div><div class="diff-removed">-				return {</div><div class="diff-removed">-					type: 'room_found',</div><div class="diff-removed">-					snapshot: new TLSyncRoom({ schema: createTLSchema() }).getSnapshot(),</div><div class="diff-removed">-				}</div><div class="diff-removed">-			}</div><div class="diff-removed">-</div><div class="diff-removed">-			// if we don't have a room in the bucket, try to load from supabase</div><div class="diff-removed">-			if (!this.supabaseClient) return { type: 'room_not_found' }</div><div class="diff-removed">-			const { data, error } = await this.supabaseClient</div><div class="diff-removed">-				.from(this.supabaseTable)</div><div class="diff-removed">-				.select('*')</div><div class="diff-removed">-				.eq('slug', slug)</div><div class="diff-removed">-</div><div class="diff-removed">-			if (error) {</div><div class="diff-removed">-				this.logEvent({ type: 'room', roomId: slug, name: 'failed_load_from_db' })</div><div class="diff-removed">-</div><div class="diff-removed">-				console.error('failed to retrieve document', slug, error)</div><div class="diff-removed">-				return { type: 'error', error: new Error(error.message) }</div><div class="diff-removed">-			}</div><div class="diff-removed">-			// if it didn't find a document, data will be an empty array</div><div class="diff-removed">-			if (data.length === 0) {</div><div class="diff-removed">-				return { type: 'room_not_found' }</div><div class="diff-removed">-			}</div><div class="diff-removed">-</div><div class="diff-removed">-			const roomFromSupabase = data[0] as PersistedRoomSnapshotForSupabase</div><div class="diff-removed">-			return { type: 'room_found', snapshot: roomFromSupabase.drawing }</div><div class="diff-removed">-		} catch (error) {</div><div class="diff-removed">-			this.logEvent({ type: 'room', roomId: slug, name: 'failed_load_from_db' })</div><div class="diff-removed">-</div><div class="diff-removed">-			console.error('failed to fetch doc', slug, error)</div><div class="diff-removed">-			return { type: 'error', error: error as Error }</div><div class="diff-removed">-		}</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	_lastPersistedClock: number | null = null</div><div class="diff-removed">-</div><div class="diff-removed">-	executionQueue = new ExecutionQueue()</div><div class="diff-removed">-</div><div class="diff-removed">-	// We use this to make sure that all of the assets in a tldraw app file are associated with that file.</div><div class="diff-removed">-	// This is needed for a few cases like duplicating a file, copy pasting images between files, slurping legacy files.</div><div class="diff-removed">-	async maybeAssociateFileAssets() {</div><div class="diff-removed">-		if (!this.documentInfo.isApp) return</div><div class="diff-removed">-</div><div class="diff-removed">-		const slug = this.documentInfo.slug</div><div class="diff-removed">-		const room = await this.getRoom()</div><div class="diff-removed">-		const assetsToUpdate: { objectName: string; fileId: string }[] = []</div><div class="diff-removed">-		await room.updateStore(async (store) => {</div><div class="diff-removed">-			const records = store.getAll()</div><div class="diff-removed">-			for (const record of records) {</div><div class="diff-removed">-				if (record.typeName !== 'asset') continue</div><div class="diff-removed">-				const asset = record as any</div><div class="diff-removed">-				const meta = asset.meta</div><div class="diff-removed">-</div><div class="diff-removed">-				if (meta?.fileId === slug) continue</div><div class="diff-removed">-				const src = asset.props.src</div><div class="diff-removed">-				if (!src) continue</div><div class="diff-removed">-				const objectName = src.split('/').pop()</div><div class="diff-removed">-				if (!objectName) continue</div><div class="diff-removed">-				const currentAsset = await this.env.UPLOADS.get(objectName)</div><div class="diff-removed">-				if (!currentAsset) continue</div><div class="diff-removed">-</div><div class="diff-removed">-				const split = objectName.split('-')</div><div class="diff-removed">-				const fileType = split.length > 1 ? split.pop() : null</div><div class="diff-removed">-				const id = uniqueId()</div><div class="diff-removed">-				const newObjectName = fileType ? `${id}-${fileType}` : id</div><div class="diff-removed">-				await this.env.UPLOADS.put(newObjectName, currentAsset.body, {</div><div class="diff-removed">-					httpMetadata: currentAsset.httpMetadata,</div><div class="diff-removed">-				})</div><div class="diff-removed">-				asset.props.src = asset.props.src.replace(objectName, newObjectName)</div><div class="diff-removed">-				assert(this.env.MULTIPLAYER_SERVER, 'MULTIPLAYER_SERVER must be present')</div><div class="diff-removed">-				asset.props.src = `${this.env.MULTIPLAYER_SERVER.replace(/^ws/, 'http')}${APP_ASSET_UPLOAD_ENDPOINT}${newObjectName}`</div><div class="diff-removed">-</div><div class="diff-removed">-				asset.meta.fileId = slug</div><div class="diff-removed">-				store.put(asset)</div><div class="diff-removed">-				assetsToUpdate.push({ objectName: newObjectName, fileId: slug })</div><div class="diff-removed">-			}</div><div class="diff-removed">-		})</div><div class="diff-removed">-</div><div class="diff-removed">-		if (assetsToUpdate.length === 0) return</div><div class="diff-removed">-</div><div class="diff-removed">-		await this.db</div><div class="diff-removed">-			.insertInto('asset')</div><div class="diff-removed">-			.values(assetsToUpdate)</div><div class="diff-removed">-			.onConflict((oc) => {</div><div class="diff-removed">-				return oc.column('objectName').doUpdateSet({ fileId: slug })</div><div class="diff-removed">-			})</div><div class="diff-removed">-			.execute()</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	// Save the room to r2</div><div class="diff-removed">-	async persistToDatabase() {</div><div class="diff-removed">-		try {</div><div class="diff-removed">-			await this.executionQueue.push(async () => {</div><div class="diff-removed">-				// check whether the worker was woken up to persist after having gone to sleep</div><div class="diff-removed">-				if (!this._room) return</div><div class="diff-removed">-				const slug = this.documentInfo.slug</div><div class="diff-removed">-				const room = await this.getRoom()</div><div class="diff-removed">-				const clock = room.getCurrentDocumentClock()</div><div class="diff-removed">-				if (this._lastPersistedClock === clock) return</div><div class="diff-removed">-				if (this._isRestoring) return</div><div class="diff-removed">-</div><div class="diff-removed">-				const snapshot = JSON.stringify(room.getCurrentSnapshot())</div><div class="diff-removed">-				this.maybeAssociateFileAssets()</div><div class="diff-removed">-</div><div class="diff-removed">-				const key = getR2KeyForRoom({ slug: slug, isApp: this.documentInfo.isApp })</div><div class="diff-removed">-				await Promise.all([</div><div class="diff-removed">-					this.r2.rooms.put(key, snapshot),</div><div class="diff-removed">-					this.r2.versionCache.put(key + `/` + new Date().toISOString(), snapshot),</div><div class="diff-removed">-				])</div><div class="diff-removed">-				this._lastPersistedClock = clock</div><div class="diff-removed">-</div><div class="diff-removed">-				// Update the updatedAt timestamp in the database</div><div class="diff-removed">-				if (this.documentInfo.isApp) {</div><div class="diff-removed">-					// don't await on this because otherwise</div><div class="diff-removed">-					// if this logic is invoked during another db transaction</div><div class="diff-removed">-					// (e.g. when publishing a file)</div><div class="diff-removed">-					// that transaction will deadlock</div><div class="diff-removed">-					this.db</div><div class="diff-removed">-						.updateTable('file')</div><div class="diff-removed">-						.set({ updatedAt: new Date().getTime() })</div><div class="diff-removed">-						.where('id', '=', this.documentInfo.slug)</div><div class="diff-removed">-						.execute()</div><div class="diff-removed">-						.catch((e) => this.reportError(e))</div><div class="diff-removed">-				}</div><div class="diff-removed">-			})</div><div class="diff-removed">-		} catch (e) {</div><div class="diff-removed">-			this.reportError(e)</div><div class="diff-removed">-		}</div><div class="diff-removed">-	}</div><div class="diff-removed">-	private reportError(e: unknown) {</div><div class="diff-removed">-		// eslint-disable-next-line @typescript-eslint/no-deprecated</div><div class="diff-removed">-		this.sentry?.captureException(e)</div><div class="diff-removed">-		console.error(e)</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	async schedulePersist() {</div><div class="diff-removed">-		await this.scheduler.scheduleAlarmAfter('persist', PERSIST_INTERVAL_MS, {</div><div class="diff-removed">-			overwrite: 'if-sooner',</div><div class="diff-removed">-		})</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	// Will be called automatically when the alarm ticks.</div><div class="diff-removed">-	override async alarm() {</div><div class="diff-removed">-		await this.scheduler.onAlarm()</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	async appFileRecordCreated(file: TlaFile) {</div><div class="diff-removed">-		if (this._fileRecordCache) return</div><div class="diff-removed">-		this._fileRecordCache = file</div><div class="diff-removed">-</div><div class="diff-removed">-		this.setDocumentInfo({</div><div class="diff-removed">-			version: CURRENT_DOCUMENT_INFO_VERSION,</div><div class="diff-removed">-			slug: file.id,</div><div class="diff-removed">-			isApp: true,</div><div class="diff-removed">-			deleted: false,</div><div class="diff-removed">-		})</div><div class="diff-removed">-		await this.getRoom()</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	async appFileRecordDidUpdate(file: TlaFile) {</div><div class="diff-removed">-		if (!file) {</div><div class="diff-removed">-			console.error('file record updated but no file found')</div><div class="diff-removed">-			return</div><div class="diff-removed">-		}</div><div class="diff-removed">-		this._fileRecordCache = file</div><div class="diff-removed">-		if (!this._documentInfo) {</div><div class="diff-removed">-			this.setDocumentInfo({</div><div class="diff-removed">-				version: CURRENT_DOCUMENT_INFO_VERSION,</div><div class="diff-removed">-				slug: file.id,</div><div class="diff-removed">-				isApp: true,</div><div class="diff-removed">-				deleted: false,</div><div class="diff-removed">-			})</div><div class="diff-removed">-		}</div><div class="diff-removed">-		const room = await this.getRoom()</div><div class="diff-removed">-</div><div class="diff-removed">-		// if the app file record updated, it might mean that the file name changed</div><div class="diff-removed">-		const documentRecord = room.getRecord(TLDOCUMENT_ID) as TLDocument</div><div class="diff-removed">-		if (documentRecord.name !== file.name) {</div><div class="diff-removed">-			room.updateStore((store) => {</div><div class="diff-removed">-				store.put({ ...documentRecord, name: file.name })</div><div class="diff-removed">-			})</div><div class="diff-removed">-		}</div><div class="diff-removed">-</div><div class="diff-removed">-		// if the app file record updated, it might mean that the sharing state was updated</div><div class="diff-removed">-		// in which case we should kick people out or change their permissions</div><div class="diff-removed">-		const roomIsReadOnlyForGuests = file.shared && file.sharedLinkType === 'view'</div><div class="diff-removed">-</div><div class="diff-removed">-		for (const session of room.getSessions()) {</div><div class="diff-removed">-			if (file.isDeleted) {</div><div class="diff-removed">-				room.closeSession(session.sessionId, TLSyncErrorCloseEventReason.NOT_FOUND)</div><div class="diff-removed">-				continue</div><div class="diff-removed">-			}</div><div class="diff-removed">-			// allow the owner to stay connected</div><div class="diff-removed">-			if (session.meta.userId === file.ownerId) continue</div><div class="diff-removed">-</div><div class="diff-removed">-			if (!file.shared) {</div><div class="diff-removed">-				room.closeSession(session.sessionId, TLSyncErrorCloseEventReason.FORBIDDEN)</div><div class="diff-removed">-			} else if (</div><div class="diff-removed">-				// if the file is still shared but the readonly state changed, make them reconnect</div><div class="diff-removed">-				(session.isReadonly && !roomIsReadOnlyForGuests) ||</div><div class="diff-removed">-				(!session.isReadonly && roomIsReadOnlyForGuests)</div><div class="diff-removed">-			) {</div><div class="diff-removed">-				// not passing a reason means they will try to reconnect</div><div class="diff-removed">-				room.closeSession(session.sessionId)</div><div class="diff-removed">-			}</div><div class="diff-removed">-		}</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	async appFileRecordDidDelete({</div><div class="diff-removed">-		id,</div><div class="diff-removed">-		publishedSlug,</div><div class="diff-removed">-	}: Pick<TlaFile, 'id' | 'ownerId' | 'publishedSlug'>) {</div><div class="diff-removed">-		if (this._documentInfo?.deleted) return</div><div class="diff-removed">-</div><div class="diff-removed">-		this._fileRecordCache = null</div><div class="diff-removed">-</div><div class="diff-removed">-		// prevent new connections while we clean everything up</div><div class="diff-removed">-		this.setDocumentInfo({</div><div class="diff-removed">-			version: CURRENT_DOCUMENT_INFO_VERSION,</div><div class="diff-removed">-			slug: this.documentInfo.slug,</div><div class="diff-removed">-			isApp: true,</div><div class="diff-removed">-			deleted: true,</div><div class="diff-removed">-		})</div><div class="diff-removed">-</div><div class="diff-removed">-		await this.executionQueue.push(async () => {</div><div class="diff-removed">-			if (this._room) {</div><div class="diff-removed">-				const room = await this.getRoom()</div><div class="diff-removed">-				for (const session of room.getSessions()) {</div><div class="diff-removed">-					room.closeSession(session.sessionId, TLSyncErrorCloseEventReason.NOT_FOUND)</div><div class="diff-removed">-				}</div><div class="diff-removed">-				room.close()</div><div class="diff-removed">-			}</div><div class="diff-removed">-			// setting _room to null will prevent any further persists from going through</div><div class="diff-removed">-			this._room = null</div><div class="diff-removed">-			// delete should be handled by the delete endpoint now</div><div class="diff-removed">-</div><div class="diff-removed">-			// Delete published slug mapping</div><div class="diff-removed">-			await this.env.SNAPSHOT_SLUG_TO_PARENT_SLUG.delete(publishedSlug)</div><div class="diff-removed">-</div><div class="diff-removed">-			// remove published files</div><div class="diff-removed">-			const publishedPrefixKey = getR2KeyForRoom({</div><div class="diff-removed">-				slug: `${id}/${publishedSlug}`,</div><div class="diff-removed">-				isApp: true,</div><div class="diff-removed">-			})</div><div class="diff-removed">-</div><div class="diff-removed">-			const publishedHistory = await listAllObjectKeys(this.env.ROOM_SNAPSHOTS, publishedPrefixKey)</div><div class="diff-removed">-			if (publishedHistory.length > 0) {</div><div class="diff-removed">-				await this.env.ROOM_SNAPSHOTS.delete(publishedHistory)</div><div class="diff-removed">-			}</div><div class="diff-removed">-</div><div class="diff-removed">-			// remove edit history</div><div class="diff-removed">-			const r2Key = getR2KeyForRoom({ slug: id, isApp: true })</div><div class="diff-removed">-			const editHistory = await listAllObjectKeys(this.env.ROOMS_HISTORY_EPHEMERAL, r2Key)</div><div class="diff-removed">-			if (editHistory.length > 0) {</div><div class="diff-removed">-				await this.env.ROOMS_HISTORY_EPHEMERAL.delete(editHistory)</div><div class="diff-removed">-			}</div><div class="diff-removed">-</div><div class="diff-removed">-			// remove main file</div><div class="diff-removed">-			await this.env.ROOMS.delete(r2Key)</div><div class="diff-removed">-</div><div class="diff-removed">-			// finally clear storage so we don't keep the data around</div><div class="diff-removed">-			this.ctx.storage.deleteAll()</div><div class="diff-removed">-		})</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	/**</div><div class="diff-removed">-	 * @internal</div><div class="diff-removed">-	 */</div><div class="diff-removed">-	async awaitPersist() {</div><div class="diff-removed">-		if (!this._documentInfo) return</div><div class="diff-removed">-		await this.persistToDatabase()</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	async __admin__hardDeleteIfLegacy() {</div><div class="diff-removed">-		if (!this._documentInfo || this.documentInfo.deleted || this.documentInfo.isApp) return false</div><div class="diff-removed">-		this.setDocumentInfo({</div><div class="diff-removed">-			version: CURRENT_DOCUMENT_INFO_VERSION,</div><div class="diff-removed">-			slug: this.documentInfo.slug,</div><div class="diff-removed">-			isApp: false,</div><div class="diff-removed">-			deleted: true,</div><div class="diff-removed">-		})</div><div class="diff-removed">-		if (this._room) {</div><div class="diff-removed">-			const room = await this.getRoom()</div><div class="diff-removed">-			room.close()</div><div class="diff-removed">-		}</div><div class="diff-removed">-		const slug = this.documentInfo.slug</div><div class="diff-removed">-		const roomKey = getR2KeyForRoom({ slug, isApp: false })</div><div class="diff-removed">-</div><div class="diff-removed">-		// remove edit history</div><div class="diff-removed">-		const editHistory = await listAllObjectKeys(this.env.ROOMS_HISTORY_EPHEMERAL, roomKey)</div><div class="diff-removed">-		if (editHistory.length > 0) {</div><div class="diff-removed">-			await this.env.ROOMS_HISTORY_EPHEMERAL.delete(editHistory)</div><div class="diff-removed">-		}</div><div class="diff-removed">-</div><div class="diff-removed">-		// remove main file</div><div class="diff-removed">-		await this.env.ROOMS.delete(roomKey)</div><div class="diff-removed">-</div><div class="diff-removed">-		return true</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	async __admin__createLegacyRoom(id: string) {</div><div class="diff-removed">-		this.setDocumentInfo({</div><div class="diff-removed">-			version: CURRENT_DOCUMENT_INFO_VERSION,</div><div class="diff-removed">-			slug: id,</div><div class="diff-removed">-			isApp: false,</div><div class="diff-removed">-			deleted: false,</div><div class="diff-removed">-		})</div><div class="diff-removed">-		const key = getR2KeyForRoom({ slug: id, isApp: false })</div><div class="diff-removed">-		await this.r2.rooms.put(</div><div class="diff-removed">-			key,</div><div class="diff-removed">-			JSON.stringify(new TLSyncRoom({ schema: createTLSchema() }).getSnapshot())</div><div class="diff-removed">-		)</div><div class="diff-removed">-		await this.getRoom()</div><div class="diff-removed">-	}</div><div class="diff-added">+ 	id: DurableObjectId</div><div class="diff-added">+ 	_room: Promise<TLSocketRoom<TLRecord, SessionMeta>> | null = null</div><div class="diff-added">+ 	sentry: ReturnType<typeof createSentry> | null = null</div><div class="diff-added">+</div><div class="diff-added">+ 	storage: DurableObjectStorage</div><div class="diff-added">+ 	supabaseClient: SupabaseClient | void</div><div class="diff-added">+ 	measure: Analytics | undefined</div><div class="diff-added">+ 	sentryDSN: string | undefined</div><div class="diff-added">+ 	db: import('kysely').Kysely<DB></div><div class="diff-added">+ 	supabaseTable: string</div><div class="diff-added">+ 	r2: {</div><div class="diff-added">+ 		rooms: R2Bucket</div><div class="diff-added">+ 		versionCache: R2Bucket</div><div class="diff-added">+ 	}</div><div class="diff-added">+ 	_documentInfo: DocumentInfo | null = null</div><div class="diff-added">+ 	_fileRecordCache: TlaFile | null = null</div><div class="diff-added">+ 	executionQueue = new ExecutionQueue()</div><div class="diff-added">+ 	_lastPersistedClock: number | null = null</div><div class="diff-added">+ 	_isRestoring = false</div><div class="diff-added">+</div><div class="diff-added">+ 	constructor(state: DurableObjectState, override env: Environment) {</div><div class="diff-added">+ 		super(state, env)</div><div class="diff-added">+ 		this.id = state.id</div><div class="diff-added">+ 		this.storage = state.storage</div><div class="diff-added">+ 		this.sentryDSN = env.SENTRY_DSN</div><div class="diff-added">+ 		this.measure = env.MEASURE</div><div class="diff-added">+ 		this.sentry = createSentry(this.state, this.env)</div><div class="diff-added">+ 		this.supabaseClient = createSupabaseClient(env)</div><div class="diff-added">+</div><div class="diff-added">+ 		this.supabaseTable = env.TLDRAW_ENV === 'production' ? 'drawings' : 'drawings_staging'</div><div class="diff-added">+ 		this.r2 = {</div><div class="diff-added">+ 			rooms: env.ROOMS,</div><div class="diff-added">+ 			versionCache: env.ROOMS_HISTORY_EPHEMERAL,</div><div class="diff-added">+ 		}</div><div class="diff-added">+</div><div class="diff-added">+ 		this.db = createPostgresConnectionPool(env, 'TLDrawDurableObject')</div><div class="diff-added">+</div><div class="diff-added">+ 		state.blockConcurrencyWhile(async () => {</div><div class="diff-added">+ 			const existingDocumentInfo = (await this.storage.get('documentInfo')) as DocumentInfo | null</div><div class="diff-added">+ 			if (existingDocumentInfo?.version !== CURRENT_DOCUMENT_INFO_VERSION) {</div><div class="diff-added">+ 				this._documentInfo = null</div><div class="diff-added">+ 			} else {</div><div class="diff-added">+ 				this._documentInfo = existingDocumentInfo</div><div class="diff-added">+ 			}</div><div class="diff-added">+ 		})</div><div class="diff-added">+ 	}</div><div class="diff-added">+</div><div class="diff-added">+ 	readonly router = Router()</div><div class="diff-added">+ 		.get(</div><div class="diff-added">+ 			`/${ROOM_PREFIX}/:roomId`,</div><div class="diff-added">+ 			(req) => this.extractDocumentInfoFromRequest(req, ROOM_OPEN_MODE.READ_WRITE),</div><div class="diff-added">+ 			(req) => this.onRequest(req, ROOM_OPEN_MODE.READ_WRITE)</div><div class="diff-added">+ 		)</div><div class="diff-added">+ 		.get(</div><div class="diff-added">+ 			`/${READ_ONLY_LEGACY_PREFIX}/:roomId`,</div><div class="diff-added">+ 			(req) => this.extractDocumentInfoFromRequest(req, ROOM_OPEN_MODE.READ_ONLY_LEGACY),</div><div class="diff-added">+ 			(req) => this.onRequest(req, ROOM_OPEN_MODE.READ_ONLY_LEGACY)</div><div class="diff-added">+ 		)</div><div class="diff-added">+ 		.get(</div><div class="diff-added">+ 			`/${READ_ONLY_PREFIX}/:roomId`,</div><div class="diff-added">+ 			(req) => this.extractDocumentInfoFromRequest(req, ROOM_OPEN_MODE.READ_ONLY),</div><div class="diff-added">+ 			(req) => this.onRequest(req, ROOM_OPEN_MODE.READ_ONLY)</div><div class="diff-added">+ 		)</div><div class="diff-added">+ 		.get(</div><div class="diff-added">+ 			`/app/file/:roomId`,</div><div class="diff-added">+ 			(req) => this.extractDocumentInfoFromRequest(req, ROOM_OPEN_MODE.READ_WRITE),</div><div class="diff-added">+ 			(req) => this.onRequest(req, ROOM_OPEN_MODE.READ_WRITE)</div><div class="diff-added">+ 		)</div><div class="diff-added">+ 		.post(</div><div class="diff-added">+ 			`/${ROOM_PREFIX}/:roomId/restore`,</div><div class="diff-added">+ 			(req) => this.extractDocumentInfoFromRequest(req, ROOM_OPEN_MODE.READ_WRITE),</div><div class="diff-added">+ 			(req) => this.onRestore(req)</div><div class="diff-added">+ 		)</div><div class="diff-added">+ 		.all('*', () => new Response('Not found', { status: 404 }))</div><div class="diff-added">+</div><div class="diff-added">+ 	readonly scheduler = new AlarmScheduler({</div><div class="diff-added">+ 		storage: () => this.storage,</div><div class="diff-added">+ 		alarms: {</div><div class="diff-added">+ 			persist: async () => {</div><div class="diff-added">+ 				this.persistToDatabase()</div><div class="diff-added">+ 			},</div><div class="diff-added">+ 		},</div><div class="diff-added">+ 	})</div><div class="diff-added">+</div><div class="diff-added">+ 	get documentInfo() {</div><div class="diff-added">+ 		return assertExists(this._documentInfo, 'documentInfo must be present')</div><div class="diff-added">+ 	}</div><div class="diff-added">+ 	setDocumentInfo(info: DocumentInfo) {</div><div class="diff-added">+ 		this._documentInfo = info</div><div class="diff-added">+ 		this.storage.put('documentInfo', info)</div><div class="diff-added">+ 	}</div><div class="diff-added">+</div><div class="diff-added">+ 	async extractDocumentInfoFromRequest(req: IRequest, roomOpenMode: RoomOpenMode) {</div><div class="diff-added">+ 		const slug = assertExists(</div><div class="diff-added">+ 			await getSlug(this.env, req.params.roomId, roomOpenMode),</div><div class="diff-added">+ 			'roomId must be present'</div><div class="diff-added">+ 		)</div><div class="diff-added">+ 		const isApp = new URL(req.url).pathname.startsWith('/app/')</div><div class="diff-added">+</div><div class="diff-added">+ 		if (this._documentInfo) {</div><div class="diff-added">+ 			assert(this._documentInfo.slug === slug, 'slug must match')</div><div class="diff-added">+ 		} else {</div><div class="diff-added">+ 			this.setDocumentInfo({</div><div class="diff-added">+ 				version: CURRENT_DOCUMENT_INFO_VERSION,</div><div class="diff-added">+ 				slug,</div><div class="diff-added">+ 				isApp,</div><div class="diff-added">+ 				deleted: false,</div><div class="diff-added">+ 			})</div><div class="diff-added">+ 		}</div><div class="diff-added">+ 	}</div><div class="diff-added">+</div><div class="diff-added">+ 	override async fetch(req: IRequest) {</div><div class="diff-added">+ 		const sentry = createSentry(this.state, this.env, req)</div><div class="diff-added">+</div><div class="diff-added">+ 		try {</div><div class="diff-added">+ 			return await this.router.fetch(req)</div><div class="diff-added">+ 		} catch (err) {</div><div class="diff-added">+ 			console.error(err)</div><div class="diff-added">+ 			// eslint-disable-next-line @typescript-eslint/no-deprecated</div><div class="diff-added">+ 			sentry?.captureException(err)</div><div class="diff-added">+ 			return new Response('Something went wrong', {</div><div class="diff-added">+ 				status: 500,</div><div class="diff-added">+ 				statusText: 'Internal Server Error',</div><div class="diff-added">+ 			})</div><div class="diff-added">+ 		}</div><div class="diff-added">+ 	}</div><div class="diff-added">+</div><div class="diff-added">+ 	async onRestore(req: IRequest) {</div><div class="diff-added">+ 		this._isRestoring = true</div><div class="diff-added">+ 		try {</div><div class="diff-added">+ 			const roomId = this.documentInfo.slug</div><div class="diff-added">+ 			const roomKey = getR2KeyForRoom({ slug: roomId, isApp: this.documentInfo.isApp })</div><div class="diff-added">+ 			const timestamp = ((await req.json()) as any).timestamp</div><div class="diff-added">+ 			if (!timestamp) {</div><div class="diff-added">+ 				return new Response('Missing timestamp', { status: 400 })</div><div class="diff-added">+ 			}</div><div class="diff-added">+ 			const data = await this.r2.versionCache.get(`${roomKey}/${timestamp}`)</div><div class="diff-added">+ 			if (!data) {</div><div class="diff-added">+ 				return new Response('Version not found', { status: 400 })</div><div class="diff-added">+ 			}</div><div class="diff-added">+ 			const dataText = await data.text()</div><div class="diff-added">+ 			await this.r2.rooms.put(roomKey, dataText)</div><div class="diff-added">+ 			const room = await this.getRoom()</div><div class="diff-added">+</div><div class="diff-added">+ 			const snapshot: RoomSnapshot = JSON.parse(dataText)</div><div class="diff-added">+ 			room.loadSnapshot(snapshot)</div><div class="diff-added">+ 			this.maybeAssociateFileAssets()</div><div class="diff-added">+</div><div class="diff-added">+ 			return new Response()</div><div class="diff-added">+ 		} finally {</div><div class="diff-added">+ 			this._isRestoring = false</div><div class="diff-added">+ 		}</div><div class="diff-added">+ 	}</div><div class="diff-added">+</div><div class="diff-added">+ 	async onRequest(req: IRequest, openMode: RoomOpenMode) {</div><div class="diff-added">+ 		const url = new URL(req.url)</div><div class="diff-added">+ 		const params = Object.fromEntries(url.searchParams.entries())</div><div class="diff-added">+ 		let { sessionId, storeId } = params</div><div class="diff-added">+</div><div class="diff-added">+ 		sessionId ??= params.sessionKey ?? params.instanceId</div><div class="diff-added">+ 		storeId ??= params.localClientId</div><div class="diff-added">+ 		const isNewSession = !this._room</div><div class="diff-added">+</div><div class="diff-added">+ 		const { 0: clientWebSocket, 1: serverWebSocket } = new WebSocketPair()</div><div class="diff-added">+ 		serverWebSocket.accept()</div><div class="diff-added">+</div><div class="diff-added">+ 		const closeSocket = (reason: TLSyncErrorCloseEventReason) => {</div><div class="diff-added">+ 			serverWebSocket.close(TLSyncErrorCloseEventCode, reason)</div><div class="diff-added">+ 			return new Response(null, { status: 101, webSocket: clientWebSocket })</div><div class="diff-added">+ 		}</div><div class="diff-added">+</div><div class="diff-added">+ 		try {</div><div class="diff-added">+ 			const room = await this.getRoom()</div><div class="diff-added">+</div><div class="diff-added">+ 			if (room.getNumActiveSessions() > MAX_CONNECTIONS) {</div><div class="diff-added">+ 				return closeSocket(TLSyncErrorCloseEventReason.ROOM_FULL)</div><div class="diff-added">+ 			}</div><div class="diff-added">+</div><div class="diff-added">+ 			room.handleSocketConnect({</div><div class="diff-added">+ 				sessionId,</div><div class="diff-added">+ 				socket: serverWebSocket,</div><div class="diff-added">+ 				meta: { storeId, userId: auth?.userId ?? null },</div><div class="diff-added">+ 				isReadonly:</div><div class="diff-added">+ 					openMode === ROOM_OPEN_MODE.READ_ONLY || openMode === ROOM_OPEN_MODE.READ_ONLY_LEGACY,</div><div class="diff-added">+ 			})</div><div class="diff-added">+ 			if (isNewSession) {</div><div class="diff-added">+ 				this.logEvent({</div><div class="diff-added">+ 					type: 'client',</div><div class="diff-added">+ 					roomId: this.documentInfo.slug,</div><div class="diff-added">+ 					name: 'room_reopen',</div><div class="diff-added">+ 					instanceId: sessionId,</div><div class="diff-added">+ 					localClientId: storeId,</div><div class="diff-added">+ 				})</div><div class="diff-added">+ 			}</div><div class="diff-added">+ 			this.logEvent({</div><div class="diff-added">+ 				type: 'client',</div><div class="diff-added">+ 				roomId: this.documentInfo.slug,</div><div class="diff-added">+ 				name: 'enter',</div><div class="diff-added">+ 				instanceId: sessionId,</div><div class="diff-added">+ 				localClientId: storeId,</div><div class="diff-added">+ 			})</div><div class="diff-added">+ 			return new Response(null, { status: 101, webSocket: clientWebSocket })</div><div class="diff-added">+ 		} catch (e) {</div><div class="diff-added">+ 			if (e === ROOM_NOT_FOUND) {</div><div class="diff-added">+ 				return closeSocket(TLSyncErrorCloseEventReason.NOT_FOUND)</div><div class="diff-added">+ 			}</div><div class="diff-added">+ 			throw e</div><div class="diff-added">+ 		}</div><div class="diff-added">+ 	}</div><div class="diff-added">+</div><div class="diff-added">+ 	triggerPersistSchedule = throttle(() => {</div><div class="diff-added">+ 		this.schedulePersist()</div><div class="diff-added">+ 	}, 2000)</div><div class="diff-added">+</div><div class="diff-added">+ 	private writeEvent(name: string, eventData: EventData) {</div><div class="diff-added">+ 		try {</div><div class="diff-added">+ 			writeDataPoint(this.sentry, this.measure, this.env, name, eventData)</div><div class="diff-added">+ 		} catch {</div><div class="diff-added">+ 			/* ignore analytics errors */</div><div class="diff-added">+ 		}</div><div class="diff-added">+ 	}</div><div class="diff-added">+</div><div class="diff-added">+ 	logEvent(event: TLServerEvent) {</div><div class="diff-added">+ 		switch (event.type) {</div><div class="diff-added">+ 			case 'room': {</div><div class="diff-added">+ 				this.writeEvent(event.name, { blobs: [event.roomId] })</div><div class="diff-added">+ 				break</div><div class="diff-added">+ 			}</div><div class="diff-added">+ 			case 'client': {</div><div class="diff-added">+ 				if (event.name === 'rate_limited') {</div><div class="diff-added">+ 					this.writeEvent(event.name, {</div><div class="diff-added">+ 						blobs: [event.userId ?? 'anon-user'],</div><div class="diff-added">+ 						indexes: [event.localClientId],</div><div class="diff-added">+ 					})</div><div class="diff-added">+ 				} else {</div><div class="diff-added">+ 					this.writeEvent(event.name, {</div><div class="diff-added">+ 						blobs: [event.roomId, 'unused', event.instanceId],</div><div class="diff-added">+ 						indexes: [event.localClientId],</div><div class="diff-added">+ 					})</div><div class="diff-added">+ 				}</div><div class="diff-added">+ 				break</div><div class="diff-added">+ 			}</div><div class="diff-added">+ 			case 'send_message': {</div><div class="diff-added">+ 				this.writeEvent(event.type, {</div><div class="diff-added">+ 					blobs: [event.roomId, event.messageType],</div><div class="diff-added">+ 					doubles: [event.messageLength],</div><div class="diff-added">+ 				})</div><div class="diff-added">+ 				break</div><div class="diff-added">+ 			}</div><div class="diff-added">+ 			default: {</div><div class="diff-added">+ 				exhaustiveSwitchError(event)</div><div class="diff-added">+ 			}</div><div class="diff-added">+ 		}</div><div class="diff-added">+ 	}</div><div class="diff-added">+</div><div class="diff-added">+ 	private reportError(e: unknown) {</div><div class="diff-added">+ 		this.sentry?.captureException(e)</div><div class="diff-added">+ 		console.error(e)</div><div class="diff-added">+ 	}</div><div class="diff-added">+</div><div class="diff-added">+ 	async getRoom() {</div><div class="diff-added">+ 		if (!this._documentInfo) {</div><div class="diff-added">+ 			throw new Error('documentInfo must be present when accessing room')</div><div class="diff-added">+ 		}</div><div class="diff-added">+ 		const slug = this._documentInfo.slug</div><div class="diff-added">+ 		if (!this._room) {</div><div class="diff-added">+ 			this._room = this.loadFromDatabase(slug).then((result) => {</div><div class="diff-added">+ 				switch (result.type) {</div><div class="diff-added">+ 					case 'room_found': {</div><div class="diff-added">+ 						const room = new TLSocketRoom<TLRecord, SessionMeta>({</div><div class="diff-added">+ 							initialSnapshot: result.snapshot,</div><div class="diff-added">+ 							onSessionRemoved: async (room, args) => {</div><div class="diff-added">+ 								this.logEvent({</div><div class="diff-added">+ 									type: 'client',</div><div class="diff-added">+ 									roomId: slug,</div><div class="diff-added">+ 									name: 'leave',</div><div class="diff-added">+ 									instanceId: args.sessionId,</div><div class="diff-added">+ 									localClientId: args.meta.storeId,</div><div class="diff-added">+ 								})</div><div class="diff-added">+</div><div class="diff-added">+ 								if (args.numSessionsRemaining > 0) return</div><div class="diff-added">+ 								this.logEvent({</div><div class="diff-added">+ 									type: 'client',</div><div class="diff-added">+ 									roomId: slug,</div><div class="diff-added">+ 									name: 'last_out',</div><div class="diff-added">+ 									instanceId: args.sessionId,</div><div class="diff-added">+ 									localClientId: args.meta.storeId,</div><div class="diff-added">+ 								})</div><div class="diff-added">+ 								try {</div><div class="diff-added">+ 									await this.persistToDatabase()</div><div class="diff-added">+ 								} catch {</div><div class="diff-added">+ 									// already logged</div><div class="diff-added">+ 								}</div><div class="diff-added">+ 								if (room.getNumActiveSessions() > 0) return</div><div class="diff-added">+ 								this._room = null</div><div class="diff-added">+ 								this.logEvent({ type: 'room', roomId: slug, name: 'room_empty' })</div><div class="diff-added">+ 								room.close()</div><div class="diff-added">+ 							},</div><div class="diff-added">+ 							onDataChange: () => {</div><div class="diff-added">+ 								this.triggerPersistSchedule()</div><div class="diff-added">+ 							},</div><div class="diff-added">+ 							onBeforeSendMessage: ({ message, stringified }) => {</div><div class="diff-added">+ 								this.logEvent({</div><div class="diff-added">+ 									type: 'send_message',</div><div class="diff-added">+ 									roomId: slug,</div><div class="diff-added">+ 									messageType: message.type,</div><div class="diff-added">+ 									messageLength: stringified.length,</div><div class="diff-added">+ 								})</div><div class="diff-added">+ 							},</div><div class="diff-added">+ 						})</div><div class="diff-added">+ 						this.logEvent({ type: 'room', roomId: slug, name: 'room_start' })</div><div class="diff-added">+ 						// Also associate file assets after we load the room</div><div class="diff-added">+ 						setTimeout(this.maybeAssociateFileAssets.bind(this), PERSIST_INTERVAL_MS)</div><div class="diff-added">+ 						return room</div><div class="diff-added">+ 					}</div><div class="diff-added">+ 					case 'room_not_found': {</div><div class="diff-added">+ 						throw ROOM_NOT_FOUND</div><div class="diff-added">+ 					}</div><div class="diff-added">+ 					case 'error': {</div><div class="diff-added">+ 						throw result.error</div><div class="diff-added">+ 					}</div><div class="diff-added">+ 					default: {</div><div class="diff-added">+ 						exhaustiveSwitchError(result)</div><div class="diff-added">+ 					}</div><div class="diff-added">+ 				}</div><div class="diff-added">+ 			})</div><div class="diff-added">+ 		}</div><div class="diff-added">+ 		return this._room</div><div class="diff-added">+ 	}</div><div class="diff-added">+</div><div class="diff-added">+ 	// Load the app file record from Postgres, retrying until available</div><div class="diff-added">+ 	async getAppFileRecord(): Promise<TlaFile | null> {</div><div class="diff-added">+ 		try {</div><div class="diff-added">+ 			return await retry(</div><div class="diff-added">+ 				async () => {</div><div class="diff-added">+ 					if (this._fileRecordCache) {</div><div class="diff-added">+ 						return this._fileRecordCache</div><div class="diff-added">+ 					}</div><div class="diff-added">+ 					const result = await this.db</div><div class="diff-added">+ 						.selectFrom('file')</div><div class="diff-added">+ 						.where('id', '=', this.documentInfo.slug)</div><div class="diff-added">+ 						.selectAll()</div><div class="diff-added">+ 						.executeTakeFirst()</div><div class="diff-added">+ 					if (!result) {</div><div class="diff-added">+ 						throw new Error('File not found')</div><div class="diff-added">+ 					}</div><div class="diff-added">+ 					this._fileRecordCache = result</div><div class="diff-added">+ 					return this._fileRecordCache</div><div class="diff-added">+ 				},</div><div class="diff-added">+ 				{ attempts: 10, waitDuration: 100 }</div><div class="diff-added">+ 			)</div><div class="diff-added">+ 		} catch {</div><div class="diff-added">+ 			return null</div><div class="diff-added">+ 		}</div><div class="diff-added">+ 	}</div><div class="diff-added">+</div><div class="diff-added">+ 	// Possibly associate any stray assets in the room with the file</div><div class="diff-added">+ 	async maybeAssociateFileAssets() {</div><div class="diff-added">+ 		if (!this.documentInfo.isApp) return</div><div class="diff-added">+</div><div class="diff-added">+ 		const slug = this.documentInfo.slug</div><div class="diff-added">+ 		const room = await this.getRoom()</div><div class="diff-added">+ 		const assetsToUpdate: { objectName: string; fileId: string }[] = []</div><div class="diff-added">+ 		await room.updateStore(async (store) => {</div><div class="diff-added">+ 			const records = store.getAll()</div><div class="diff-added">+ 			for (const record of records) {</div><div class="diff-added">+ 				if (record.typeName !== 'asset') continue</div><div class="diff-added">+ 				const asset = record as any</div><div class="diff-added">+ 				const meta = asset.meta</div><div class="diff-added">+ 				if (meta?.fileId === slug) continue</div><div class="diff-added">+ 				const src = asset.props.src</div><div class="diff-added">+ 				if (!src) continue</div><div class="diff-added">+ 				const objectName = src.split('/').pop()</div><div class="diff-added">+ 				if (!objectName) continue</div><div class="diff-added">+ 				const currentAsset = await this.env.UPLOADS.get(objectName)</div><div class="diff-added">+ 				if (!currentAsset) continue</div><div class="diff-added">+</div><div class="diff-added">+ 				const split = objectName.split('-')</div><div class="diff-added">+ 				const fileType = split.length > 1 ? split.pop() : null</div><div class="diff-added">+ 				const id = uniqueId()</div><div class="diff-added">+ 				const newObjectName = fileType ? `${id}-${fileType}` : id</div><div class="diff-added">+ 				await this.env.UPLOADS.put(newObjectName, currentAsset.body, {</div><div class="diff-added">+ 					httpMetadata: currentAsset.httpMetadata,</div><div class="diff-added">+ 				})</div><div class="diff-added">+ 				assert(this.env.MULTIPLAYER_SERVER, 'MULTIPLAYER_SERVER must be present')</div><div class="diff-added">+ 				asset.props.src = `${this.env.MULTIPLAYER_SERVER.replace(/^ws/, 'http')}${APP_ASSET_UPLOAD_ENDPOINT}${newObjectName}`</div><div class="diff-added">+</div><div class="diff-added">+ 				asset.meta.fileId = slug</div><div class="diff-added">+ 				store.put(asset)</div><div class="diff-added">+ 				assetsToUpdate.push({ objectName: newObjectName, fileId: slug })</div><div class="diff-added">+ 			}</div><div class="diff-added">+ 		})</div><div class="diff-added">+</div><div class="diff-added">+ 		if (assetsToUpdate.length === 0) return</div><div class="diff-added">+</div><div class="diff-added">+ 		await this.db</div><div class="diff-added">+ 			.insertInto('asset')</div><div class="diff-added">+ 			.values(assetsToUpdate)</div><div class="diff-added">+ 			.onConflict((oc) => oc.column('objectName').doUpdateSet({ fileId: slug }))</div><div class="diff-added">+ 			.execute()</div><div class="diff-added">+ 	}</div><div class="diff-added">+</div><div class="diff-added">+ 	// Load the room's drawing data.</div><div class="diff-added">+ 	async loadFromDatabase(slug: string): Promise<DBLoadResult> {</div><div class="diff-added">+ 		try {</div><div class="diff-added">+ 			const key = getR2KeyForRoom({ slug, isApp: this.documentInfo.isApp })</div><div class="diff-added">+ 			const roomFromBucket = await this.r2.rooms.get(key)</div><div class="diff-added">+ 			if (roomFromBucket) {</div><div class="diff-added">+ 				return { type: 'room_found', snapshot: await roomFromBucket.json() }</div><div class="diff-added">+ 			}</div><div class="diff-added">+</div><div class="diff-added">+ 			if (this._fileRecordCache?.createSource) {</div><div class="diff-added">+ 				const roomData = await this.handleFileCreateFromSource()</div><div class="diff-added">+ 				if (roomData.type === 'room_found') {</div><div class="diff-added">+ 					await this.r2.rooms.put(key, JSON.stringify(roomData.snapshot))</div><div class="diff-added">+ 				}</div><div class="diff-added">+ 				return roomData</div><div class="diff-added">+ 			}</div><div class="diff-added">+</div><div class="diff-added">+ 			if (this.documentInfo.isApp) {</div><div class="diff-added">+ 				return {</div><div class="diff-added">+ 					type: 'room_found',</div><div class="diff-added">+ 					snapshot: new TLSyncRoom({ schema: createTLSchema() }).getSnapshot(),</div><div class="diff-added">+ 				}</div><div class="diff-added">+ 			}</div><div class="diff-added">+</div><div class="diff-added">+ 			if (!this.supabaseClient) return { type: 'room_not_found' }</div><div class="diff-added">+ 			const { data, error } = await this.supabaseClient</div><div class="diff-added">+ 				.from(this.supabaseTable)</div><div class="diff-added">+ 				.select('*')</div><div class="diff-added">+ 				.eq('slug', slug)</div><div class="diff-added">+</div><div class="diff-added">+ 			if (error) {</div><div class="diff-added">+ 				this.logEvent({ type: 'room', roomId: slug, name: 'failed_load_from_db' })</div><div class="diff-added">+ 				console.error('failed to retrieve document', slug, error)</div><div class="diff-added">+ 				return { type: 'error', error: new Error(error.message) }</div><div class="diff-added">+ 			}</div><div class="diff-added">+ 			if (data.length === 0) {</div><div class="diff-added">+ 				return { type: 'room_not_found' }</div><div class="diff-added">+ 			}</div><div class="diff-added">+ 			const roomFromSupabase = data[0] as PersistedRoomSnapshotForSupabase</div><div class="diff-added">+ 			return { type: 'room_found', snapshot: roomFromSupabase.drawing }</div><div class="diff-added">+ 		} catch (error) {</div><div class="diff-added">+ 			this.logEvent({ type: 'room', roomId: slug, name: 'failed_load_from_db' })</div><div class="diff-added">+ 			console.error('failed to fetch doc', slug, error)</div><div class="diff-added">+ 			return { type: 'error', error: error as Error }</div><div class="diff-added">+ 		}</div><div class="diff-added">+ 	}</div><div class="diff-added">+</div><div class="diff-added">+ 	// Handle create-from-source logic for duplications and legacy slurps</div><div class="diff-added">+ 	async handleFileCreateFromSource(): Promise<DBLoadResult> {</div><div class="diff-added">+ 		assert(this._fileRecordCache, 'we need to have a file record to create a file from source')</div><div class="diff-added">+ 		const split = this._fileRecordCache.createSource?.split('/')</div><div class="diff-added">+ 		if (!split || split.length !== 2) {</div><div class="diff-added">+ 			return { type: 'room_not_found' }</div><div class="diff-added">+ 		}</div><div class="diff-added">+ 		const [prefix, id] = split</div><div class="diff-added">+ 		let data: string | null | undefined = undefined</div><div class="diff-added">+ 		switch (prefix) {</div><div class="diff-added">+ 			case FILE_PREFIX: {</div><div class="diff-added">+ 				await getRoomDurableObject(this.env, id).awaitPersist()</div><div class="diff-added">+ 				data = await this.r2.rooms</div><div class="diff-added">+ 					.get(getR2KeyForRoom({ slug: id, isApp: true }))</div><div class="diff-added">+ 					.then((r) => r?.text())</div><div class="diff-added">+ 				break</div><div class="diff-added">+ 			}</div><div class="diff-added">+ 			case ROOM_PREFIX:</div><div class="diff-added">+ 				data = await getLegacyRoomData(this.env, id, ROOM_OPEN_MODE.READ_WRITE)</div><div class="diff-added">+ 				break</div><div class="diff-added">+ 			case READ_ONLY_PREFIX:</div><div class="diff-added">+ 				data = await getLegacyRoomData(this.env, id, ROOM_OPEN_MODE.READ_ONLY)</div><div class="diff-added">+ 				break</div><div class="diff-added">+ 			case READ_ONLY_LEGACY_PREFIX:</div><div class="diff-added">+ 				data = await getLegacyRoomData(this.env, id, ROOM_OPEN_MODE.READ_ONLY_LEGACY)</div><div class="diff-added">+ 				break</div><div class="diff-added">+ 			case SNAPSHOT_PREFIX:</div><div class="diff-added">+ 				data = await getLegacyRoomData(this.env, id, 'snapshot')</div><div class="diff-added">+ 				break</div><div class="diff-added">+ 			case PUBLISH_PREFIX:</div><div class="diff-added">+ 				data = await getPublishedRoomSnapshot(this.env, id)</div><div class="diff-added">+ 				break</div><div class="diff-added">+ 		}</div><div class="diff-added">+</div><div class="diff-added">+ 		if (!data) {</div><div class="diff-added">+ 			return { type: 'room_not_found' }</div><div class="diff-added">+ 		}</div><div class="diff-added">+ 		const snapshot = typeof data === 'string' ? JSON.parse(data) : data</div><div class="diff-added">+ 		return { type: 'room_found', snapshot }</div><div class="diff-added">+ 	}</div><div class="diff-added">+</div><div class="diff-added">+ 	_lastPersistedClock: number | null = null</div><div class="diff-added">+</div><div class="diff-added">+ 	// Save the room to R2 & update updatedAt</div><div class="diff-added">+ 	async persistToDatabase() {</div><div class="diff-added">+ 		try {</div><div class="diff-added">+ 			await this.executionQueue.push(async () => {</div><div class="diff-added">+ 				if (!this._room) return</div><div class="diff-added">+ 				const slug = this.documentInfo.slug</div><div class="diff-added">+ 				const room = await this.getRoom()</div><div class="diff-added">+ 				const clock = room.getCurrentDocumentClock()</div><div class="diff-added">+ 				if (this._lastPersistedClock === clock) return</div><div class="diff-added">+ 				if (this._isRestoring) return</div><div class="diff-added">+</div><div class="diff-added">+ 				const snapshot = JSON.stringify(room.getCurrentSnapshot())</div><div class="diff-added">+ 				await Promise.all([</div><div class="diff-added">+ 					this.r2.rooms.put(getR2KeyForRoom({ slug, isApp: this.documentInfo.isApp }), snapshot),</div><div class="diff-added">+ 					this.r2.versionCache.put(</div><div class="diff-added">+ 						getR2KeyForRoom({ slug, isApp: this.documentInfo.isApp }) + `/${new Date().toISOString()}`,</div><div class="diff-added">+ 						snapshot</div><div class="diff-added">+ 					),</div><div class="diff-added">+ 				])</div><div class="diff-added">+ 				this._lastPersistedClock = clock</div><div class="diff-added">+</div><div class="diff-added">+ 				if (this.documentInfo.isApp) {</div><div class="diff-added">+ 					this.db</div><div class="diff-added">+ 						.updateTable('file')</div><div class="diff-added">+ 						.set({ updatedAt: new Date().getTime() })</div><div class="diff-added">+ 						.where('id', '=', this.documentInfo.slug)</div><div class="diff-added">+ 						.execute()</div><div class="diff-added">+ 						.catch((e) => this.reportError(e))</div><div class="diff-added">+ 				}</div><div class="diff-added">+ 			})</div><div class="diff-added">+ 		} catch (e) {</div><div class="diff-added">+ 			this.reportError(e)</div><div class="diff-added">+ 		}</div><div class="diff-added">+ 	}</div><div class="diff-added">+</div><div class="diff-added">+ 	async schedulePersist() {</div><div class="diff-added">+ 		await this.scheduler.scheduleAlarmAfter('persist', PERSIST_INTERVAL_MS, {</div><div class="diff-added">+ 			overwrite: 'if-sooner',</div><div class="diff-added">+ 		})</div><div class="diff-added">+ 	}</div><div class="diff-added">+</div><div class="diff-added">+ 	async alarm() {</div><div class="diff-added">+ 		await this.scheduler.onAlarm()</div><div class="diff-added">+ 	}</div><div class="diff-added">+</div><div class="diff-added">+ 	async appFileRecordCreated(file: TlaFile) {</div><div class="diff-added">+ 		if (this._fileRecordCache) return</div><div class="diff-added">+ 		this._fileRecordCache = file</div><div class="diff-added">+ 		this.setDocumentInfo({</div><div class="diff-added">+ 			version: CURRENT_DOCUMENT_INFO_VERSION,</div><div class="diff-added">+ 			slug: file.id,</div><div class="diff-added">+ 			isApp: true,</div><div class="diff-added">+ 			deleted: false,</div><div class="diff-added">+ 		})</div><div class="diff-added">+ 		await this.getRoom()</div><div class="diff-added">+ 	}</div><div class="diff-added">+</div><div class="diff-added">+ 	async appFileRecordDidUpdate(file: TlaFile) {</div><div class="diff-added">+ 		if (!file) {</div><div class="diff-added">+ 			console.error('file record updated but no file found')</div><div class="diff-added">+ 			return</div><div class="diff-added">+ 		}</div><div class="diff-added">+ 		this._fileRecordCache = file</div><div class="diff-added">+ 		if (!this._documentInfo) {</div><div class="diff-added">+ 			this.setDocumentInfo({</div><div class="diff-added">+ 				version: CURRENT_DOCUMENT_INFO_VERSION,</div><div class="diff-added">+ 				slug: file.id,</div><div class="diff-added">+ 				isApp: true,</div><div class="diff-added">+ 				deleted: false,</div><div class="diff-added">+ 			})</div><div class="diff-added">+ 		}</div><div class="diff-added">+ 		const room = await this.getRoom()</div><div class="diff-added">+</div><div class="diff-added">+ 		const documentRecord = room.getRecord(TLDOCUMENT_ID) as TLDocument</div><div class="diff-added">+ 		if (documentRecord.name !== file.name) {</div><div class="diff-added">+ 			room.updateStore((store) => {</div><div class="diff-added">+ 				store.put({ ...documentRecord, name: file.name })</div><div class="diff-added">+ 			})</div><div class="diff-added">+ 		}</div><div class="diff-added">+</div><div class="diff-added">+ 		const roomIsReadOnlyForGuests = file.shared && file.sharedLinkType === 'view'</div><div class="diff-added">+ 		for (const session of room.getSessions()) {</div><div class="diff-added">+ 			if (session.meta.userId === file.ownerId) continue</div><div class="diff-added">+ 			if (!file.shared) {</div><div class="diff-added">+ 				room.closeSession(session.sessionId, TLSyncErrorCloseEventReason.FORBIDDEN)</div><div class="diff-added">+ 			} else if (</div><div class="diff-added">+ 				(session.isReadonly && !roomIsReadOnlyForGuests) ||</div><div class="diff-added">+ 				(!session.isReadonly && roomIsReadOnlyForGuests)</div><div class="diff-added">+ 			) {</div><div class="diff-added">+ 				room.closeSession(session.sessionId)</div><div class="diff-added">+ 			}</div><div class="diff-added">+ 		}</div><div class="diff-added">+ 	}</div><div class="diff-added">+</div><div class="diff-added">+ 	async appFileRecordDidDelete({ id, publishedSlug }: Pick<TlaFile, 'id' | 'publishedSlug'>) {</div><div class="diff-added">+ 		if (this._documentInfo?.deleted) return</div><div class="diff-added">+</div><div class="diff-added">+ 		this._fileRecordCache = null</div><div class="diff-added">+ 		this.setDocumentInfo({</div><div class="diff-added">+ 			version: CURRENT_DOCUMENT_INFO_VERSION,</div><div class="diff-added">+ 			slug: this.documentInfo.slug,</div><div class="diff-added">+ 			isApp: true,</div><div class="diff-added">+ 			deleted: true,</div><div class="diff-added">+ 		})</div><div class="diff-added">+</div><div class="diff-added">+ 		await this.executionQueue.push(async () => {</div><div class="diff-added">+ 			if (this._room) {</div><div class="diff-added">+ 				const room = await this.getRoom()</div><div class="diff-added">+ 				for (const session of room.getSessions()) {</div><div class="diff-added">+ 					room.closeSession(session.sessionId, TLSyncErrorCloseEventReason.NOT_FOUND)</div><div class="diff-added">+ 				}</div><div class="diff-added">+ 				room.close()</div><div class="diff-added">+ 			}</div><div class="diff-added">+ 			this._room = null</div><div class="diff-added">+</div><div class="diff-added">+ 			if (publishedSlug) {</div><div class="diff-added">+ 				await this.env.SNAPSHOT_SLUG_TO_PARENT_SLUG.delete(publishedSlug)</div><div class="diff-added">+ 				const publishedPrefixKey = getR2KeyForRoom({</div><div class="diff-added">+ 					slug: `${id}/${publishedSlug}`,</div><div class="diff-added">+ 					isApp: true,</div><div class="diff-added">+ 				})</div><div class="diff-added">+ 				const publishedHistory = await listAllObjectKeys(this.env.ROOM_SNAPSHOTS, publishedPrefixKey)</div><div class="diff-added">+ 				if (publishedHistory.length > 0) {</div><div class="diff-added">+ 					await this.env.ROOM_SNAPSHOTS.delete(publishedHistory)</div><div class="diff-added">+ 				}</div><div class="diff-added">+ 			}</div><div class="diff-added">+</div><div class="diff-added">+ 			const r2Key = getR2KeyForRoom({ slug: id, isApp: true })</div><div class="diff-added">+ 			const editHistory = await listAllObjectKeys(this.env.ROOMS_HISTORY_EPHEMERAL, r2Key)</div><div class="diff-added">+ 			if (editHistory.length > 0) {</div><div class="diff-added">+ 				await this.env.ROOMS_HISTORY_EPHEMERAL.delete(editHistory)</div><div class="diff-added">+ 			}</div><div class="diff-added">+ 			await this.env.ROOMS.delete(r2Key)</div><div class="diff-added">+ 			this.ctx.storage.deleteAll()</div><div class="diff-added">+ 		})</div><div class="diff-added">+ 	}</div><div class="diff-added">+</div><div class="diff-added">+ 	async __admin__hardDeleteIfLegacy() {</div><div class="diff-added">+ 		if (!this._documentInfo || this._documentInfo.deleted || this._documentInfo.isApp) return false</div><div class="diff-added">+ 		this.setDocumentInfo({</div><div class="diff-added">+ 			version: CURRENT_DOCUMENT_INFO_VERSION,</div><div class="diff-added">+ 			slug: this.documentInfo.slug,</div><div class="diff-added">+ 			isApp: false,</div><div class="diff-added">+ 			deleted: true,</div><div class="diff-added">+ 		})</div><div class="diff-added">+ 		if (this._room) {</div><div class="diff-added">+ 			const room = await this.getRoom()</div><div class="diff-added">+ 			room.close()</div><div class="diff-added">+ 		}</div><div class="diff-added">+ 		const slug = this.documentInfo.slug</div><div class="diff-added">+ 		const roomKey = getR2KeyForRoom({ slug, isApp: false })</div><div class="diff-added">+ 		const editHistory = await listAllObjectKeys(this.env.ROOMS_HISTORY_EPHEMERAL, roomKey)</div><div class="diff-added">+ 		if (editHistory.length > 0) {</div><div class="diff-added">+ 			await this.env.ROOMS_HISTORY_EPHEMERAL.delete(editHistory)</div><div class="diff-added">+ 		}</div><div class="diff-added">+ 		await this.env.ROOMS.delete(roomKey)</div><div class="diff-added">+ 		return true</div><div class="diff-added">+ 	}</div><div class="diff-added">+</div><div class="diff-added">+ 	async __admin__createLegacyRoom(id: string) {</div><div class="diff-added">+ 		this.setDocumentInfo({</div><div class="diff-added">+ 			version: CURRENT_DOCUMENT_INFO_VERSION,</div><div class="diff-added">+ 			slug: id,</div><div class="diff-added">+ 			isApp: false,</div><div class="diff-added">+ 			deleted: false,</div><div class="diff-added">+ 		})</div><div class="diff-added">+ 		const key = getR2KeyForRoom({ slug: id, isApp: false })</div><div class="diff-added">+ 		await this.r2.rooms.put(</div><div class="diff-added">+ 			key,</div><div class="diff-added">+ 			JSON.stringify(new TLSyncRoom({ schema: createTLSchema() }).getSnapshot())</div><div class="diff-added">+ 		)</div><div class="diff-added">+ 		await this.getRoom()</div><div class="diff-added">+ 	}</div><div> }</div><div> </div><div> async function listAllObjectKeys(bucket: R2Bucket, prefix: string): Promise<string[]> {</div><div class="diff-removed">-	const keys: string[] = []</div><div class="diff-removed">-	let cursor: string | undefined</div><div class="diff-removed">-</div><div class="diff-removed">-	do {</div><div class="diff-removed">-		const result = await bucket.list({ prefix, cursor })</div><div class="diff-removed">-		keys.push(...result.objects.map((o) => o.key))</div><div class="diff-removed">-		cursor = result.truncated ? result.cursor : undefined</div><div class="diff-removed">-	} while (cursor)</div><div class="diff-removed">-</div><div class="diff-removed">-	return keys</div><div class="diff-added">+ 	const keys: string[] = []</div><div class="diff-added">+ 	let cursor: string | undefined</div><div class="diff-added">+</div><div class="diff-added">+ 	do {</div><div class="diff-added">+ 		const result = await bucket.list({ prefix, cursor })</div><div class="diff-added">+ 		keys.push(...result.objects.map((o) => o.key))</div><div class="diff-added">+ 		cursor = result.truncated ? result.cursor : undefined</div><div class="diff-added">+ 	} while (cursor)</div><div class="diff-added">+</div><div class="diff-added">+ 	return keys</div><div> }</div></pre>
                </div>
            </div>
        </section>
    </main>
    <footer>
        <p>LoCoDiff-bench - <a href="https://github.com/AbanteAI/LoCoDiff-bench">GitHub Repository</a></p>
    </footer>
</body>
</html>
    