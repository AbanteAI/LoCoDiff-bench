<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case: packages/react-dom/src/__tests__/ReactCompositeComponent-test.js - o4-mini-medium</title>
    <link rel="stylesheet" href="../../styles.css">
</head>
<body>
    <header>
        <h1>Case: packages/react-dom/src/__tests__/ReactCompositeComponent-test.js</h1>
        <p><a href="../../models/openai_o4-mini.html">‚Üê Back to o4-mini-medium Cases</a> | <a href="../../index.html">Home</a></p>
    </header>
    <main>
        <section class="case-details">
            <div class="case-info">
                <h2>Benchmark Case Information</h2>
                <p><strong>Model:</strong> o4-mini-medium</p>
                <p><strong>Status:</strong> <span class="failure">Failure</span></p>
                <p><strong>Prompt Tokens:</strong> 86495</p>
                <p><strong>Output Tokens:</strong> N/A</p>
                <p><strong>Native Prompt Tokens:</strong> 88869</p>
                <p><strong>Native Completion Tokens:</strong> 7821</p>
                <p><strong>Native Tokens Reasoning:</strong> 704</p>
                <p><strong>Native Finish Reason:</strong> stop</p>
                <p><strong>Cost:</strong> $0.006608415</p>
            </div>
            
            <div class="content-links">
                <h2>View Content</h2>
                <ul>
                    <li><a href="../../content/openai_o4-mini/react_packages_react-dom_src___tests___ReactCompositeComponent-test.js/prompt.html" class="content-link">View Prompt</a></li>
                    <li><a href="../../content/openai_o4-mini/react_packages_react-dom_src___tests___ReactCompositeComponent-test.js/expected.html" class="content-link">View Expected Output</a></li>
                    <li><a href="../../content/openai_o4-mini/react_packages_react-dom_src___tests___ReactCompositeComponent-test.js/actual.html" class="content-link">View Actual Output</a></li>
                </ul>
            </div>
            
            <div class="diff-section">
                <h2>Diff (Expected vs Actual)</h2>
                <div id="diff-output">
                    <pre class="diff"><div class="diff-header">--- react_packages_react-dom_src___tests___ReactCompositeComponent-test.js_expectedoutput.txt (expected)+++ react_packages_react-dom_src___tests___ReactCompositeComponent-test.js_extracted.txt (actual)@@ -3,11 +3,7 @@  *</div><div>  * This source code is licensed under the MIT license found in the</div><div>  * LICENSE file in the root directory of this source tree.</div><div class="diff-removed">- *</div><div class="diff-removed">- * @emails react-core</div><div>  */</div><div class="diff-removed">-</div><div class="diff-removed">-'use strict';</div><div> </div><div> let ChildUpdates;</div><div> let MorphingComponent;</div><div class="diff-info">@@ -23,56 +19,17 @@ describe('ReactCompositeComponent', () => {</div><div>   const hasOwnProperty = Object.prototype.hasOwnProperty;</div><div> </div><div class="diff-removed">-  /**</div><div class="diff-removed">-   * Performs equality by iterating through keys on an object and returning false</div><div class="diff-removed">-   * when any key has values which are not strictly equal between the arguments.</div><div class="diff-removed">-   * Returns true when the values of all keys are strictly equal.</div><div class="diff-removed">-   */</div><div class="diff-removed">-  function shallowEqual(objA: mixed, objB: mixed): boolean {</div><div class="diff-removed">-    if (Object.is(objA, objB)) {</div><div class="diff-removed">-      return true;</div><div class="diff-removed">-    }</div><div class="diff-removed">-    if (</div><div class="diff-removed">-      typeof objA !== 'object' ||</div><div class="diff-removed">-      objA === null ||</div><div class="diff-removed">-      typeof objB !== 'object' ||</div><div class="diff-removed">-      objB === null</div><div class="diff-removed">-    ) {</div><div class="diff-removed">-      return false;</div><div class="diff-removed">-    }</div><div class="diff-removed">-    const keysA = Object.keys(objA);</div><div class="diff-removed">-    const keysB = Object.keys(objB);</div><div class="diff-removed">-    if (keysA.length !== keysB.length) {</div><div class="diff-removed">-      return false;</div><div class="diff-removed">-    }</div><div class="diff-removed">-    for (let i = 0; i < keysA.length; i++) {</div><div class="diff-removed">-      if (</div><div class="diff-removed">-        !hasOwnProperty.call(objB, keysA[i]) ||</div><div class="diff-removed">-        !Object.is(objA[keysA[i]], objB[keysA[i]])</div><div class="diff-removed">-      ) {</div><div class="diff-removed">-        return false;</div><div class="diff-removed">-      }</div><div class="diff-removed">-    }</div><div class="diff-removed">-    return true;</div><div class="diff-removed">-  }</div><div class="diff-removed">-</div><div class="diff-removed">-  function shallowCompare(instance, nextProps, nextState) {</div><div class="diff-removed">-    return (</div><div class="diff-removed">-      !shallowEqual(instance.props, nextProps) ||</div><div class="diff-removed">-      !shallowEqual(instance.state, nextState)</div><div class="diff-removed">-    );</div><div class="diff-removed">-  }</div><div class="diff-removed">-</div><div>   beforeEach(() => {</div><div>     jest.resetModules();</div><div>     React = require('react');</div><div>     ReactDOM = require('react-dom');</div><div>     ReactDOMClient = require('react-dom/client');</div><div>     ReactSharedInternals =</div><div class="diff-removed">-      require('react').__CLIENT_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE;</div><div class="diff-added">+      require('react')</div><div class="diff-added">+        .__CLIENT_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE;</div><div>     Scheduler = require('scheduler');</div><div class="diff-added">+    ({act, assertConsoleErrorDev} = require('internal-test-utils'));</div><div>     assertLog = require('internal-test-utils').assertLog;</div><div class="diff-removed">-    ({act, assertConsoleErrorDev} = require('internal-test-utils'));</div><div>   });</div><div> </div><div>   describe('MorphingComponent', () => {</div><div class="diff-info">@@ -102,10 +59,6 @@         }</div><div>       };</div><div> </div><div class="diff-removed">-      /**</div><div class="diff-removed">-       * We'll use this to ensure that an old version is not cached when it is</div><div class="diff-removed">-       * reallocated again.</div><div class="diff-removed">-       */</div><div>       ChildUpdates = class extends React.Component {</div><div>         anchorRef = React.createRef();</div><div> </div><div class="diff-info">@@ -127,6 +80,7 @@         }</div><div>       };</div><div>     });</div><div class="diff-added">+</div><div>     it('should support rendering to different child types over time', async () => {</div><div>       const root = ReactDOMClient.createRoot(document.createElement('div'));</div><div>       await act(() => {</div><div class="diff-info">@@ -191,19 +145,16 @@       });</div><div>       await act(() => {</div><div>         root.render(</div><div class="diff-removed">-          // Warm any cache</div><div>           <ChildUpdates renderAnchor={true} anchorClassOn={true} />,</div><div>         );</div><div>       });</div><div>       await act(() => {</div><div>         root.render(</div><div class="diff-removed">-          // Clear out the anchor</div><div>           <ChildUpdates renderAnchor={false} anchorClassOn={true} />,</div><div>         );</div><div>       });</div><div>       await act(() => {</div><div>         root.render(</div><div class="diff-removed">-          // rerender</div><div>           <ChildUpdates renderAnchor={true} anchorClassOn={false} />,</div><div>         );</div><div>       });</div><div class="diff-info">@@ -229,7 +180,6 @@     }).rejects.toThrow(</div><div>       'Objects are not valid as a React child (found: object with keys {render}).',</div><div>     );</div><div class="diff-removed">-</div><div>     expect(el.textContent).toBe('');</div><div>   });</div><div> </div><div class="diff-info">@@ -242,34 +192,22 @@       }</div><div>     }</div><div> </div><div class="diff-removed">-    function refFn1(ref) {</div><div class="diff-removed">-      instance1 = ref;</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    function refFn2(ref) {</div><div class="diff-removed">-      instance2 = ref;</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    function refFn3(ref) {</div><div class="diff-removed">-      instance3 = ref;</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    let instance1;</div><div class="diff-removed">-    let instance2;</div><div class="diff-removed">-    let instance3;</div><div class="diff-removed">-    const root = ReactDOMClient.createRoot(document.createElement('div'));</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      root.render(<Component ref={refFn1} />);</div><div class="diff-added">+    let instance1, instance2, instance3;</div><div class="diff-added">+    const root = ReactDOMClient.createRoot(document.createElement('div'));</div><div class="diff-added">+    await act(() => {</div><div class="diff-added">+      root.render(<Component ref={ref => (instance1 = ref)} />);</div><div>     });</div><div>     expect(instance1.props).toEqual({prop: 'testKey'});</div><div> </div><div>     await act(() => {</div><div class="diff-removed">-      root.render(<Component ref={refFn2} prop={undefined} />);</div><div class="diff-added">+      root.render(</div><div class="diff-added">+        <Component ref={ref => (instance2 = ref)} prop={undefined} />,</div><div class="diff-added">+      );</div><div>     });</div><div>     expect(instance2.props).toEqual({prop: 'testKey'});</div><div> </div><div>     await act(() => {</div><div class="diff-removed">-      root.render(<Component ref={refFn3} prop={null} />);</div><div class="diff-added">+      root.render(<Component ref={ref => (instance3 = ref)} prop={null} />);</div><div>     });</div><div>     expect(instance3.props).toEqual({prop: null});</div><div>   });</div><div class="diff-info">@@ -290,9 +228,6 @@       root.render(<Component {...inputProps} ref={ref => (instance1 = ref)} />);</div><div>     });</div><div>     expect(instance1.props.prop).toBe('testKey');</div><div class="diff-removed">-</div><div class="diff-removed">-    // We don't mutate the input, just in case the caller wants to do something</div><div class="diff-removed">-    // with it after using it to instantiate a component</div><div>     expect(inputProps.prop).not.toBeDefined();</div><div>   });</div><div> </div><div class="diff-info">@@ -303,7 +238,7 @@         this.forceUpdate();</div><div>       }</div><div>       render() {</div><div class="diff-removed">-        return <div>foo</div>;</div><div class="diff-added">+        return <div />;</div><div>       }</div><div>     }</div><div> </div><div class="diff-info">@@ -320,13 +255,10 @@         '    in MyComponent (at **)',</div><div>     ]);</div><div> </div><div class="diff-removed">-    // No additional warning should be recorded</div><div>     const container2 = document.createElement('div');</div><div class="diff-removed">-    const root2 = ReactDOMClient.createRoot(container2);</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      root2.render(<MyComponent />);</div><div class="diff-removed">-    });</div><div class="diff-removed">-    expect(container2.firstChild.textContent).toBe('foo');</div><div class="diff-added">+    await act(() => {</div><div class="diff-added">+      ReactDOMClient.createRoot(container2).render(<MyComponent />);</div><div class="diff-added">+    });</div><div>   });</div><div> </div><div>   it('should warn about `setState` on not-yet-mounted components', async () => {</div><div class="diff-info">@@ -336,13 +268,12 @@         this.setState();</div><div>       }</div><div>       render() {</div><div class="diff-removed">-        return <div>foo</div>;</div><div class="diff-removed">-      }</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    const container = document.createElement('div');</div><div class="diff-removed">-    const root = ReactDOMClient.createRoot(container);</div><div class="diff-removed">-</div><div class="diff-added">+        return <div />;</div><div class="diff-added">+      }</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    const container = document.createElement('div');</div><div class="diff-added">+    const root = ReactDOMClient.createRoot(container);</div><div>     ReactDOM.flushSync(() => {</div><div>       root.render(<MyComponent />);</div><div>     });</div><div class="diff-info">@@ -354,43 +285,34 @@         '    in MyComponent (at **)',</div><div>     ]);</div><div> </div><div class="diff-removed">-    // No additional warning should be recorded</div><div>     const container2 = document.createElement('div');</div><div class="diff-removed">-    const root2 = ReactDOMClient.createRoot(container2);</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      root2.render(<MyComponent />);</div><div class="diff-removed">-    });</div><div class="diff-removed">-    expect(container2.firstChild.textContent).toBe('foo');</div><div class="diff-added">+    await act(() => {</div><div class="diff-added">+      ReactDOMClient.createRoot(container2).render(<MyComponent />);</div><div class="diff-added">+    });</div><div>   });</div><div> </div><div>   it('should not warn about `forceUpdate` on unmounted components', async () => {</div><div>     const container = document.createElement('div');</div><div>     document.body.appendChild(container);</div><div> </div><div class="diff-added">+    class Component extends React.Component {</div><div class="diff-added">+      componentDidMount() {</div><div class="diff-added">+        // nothing</div><div class="diff-added">+      }</div><div class="diff-added">+      render() {</div><div class="diff-added">+        return <div />;</div><div class="diff-added">+      }</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div>     let instance;</div><div class="diff-removed">-    class Component extends React.Component {</div><div class="diff-removed">-      componentDidMount() {</div><div class="diff-removed">-        instance = this;</div><div class="diff-removed">-      }</div><div class="diff-removed">-</div><div class="diff-removed">-      render() {</div><div class="diff-removed">-        return <div />;</div><div class="diff-removed">-      }</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    const component = <Component />;</div><div class="diff-removed">-    expect(component.forceUpdate).not.toBeDefined();</div><div class="diff-removed">-    const root = ReactDOMClient.createRoot(container);</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      root.render(component);</div><div class="diff-added">+    const root = ReactDOMClient.createRoot(container);</div><div class="diff-added">+    await act(() => {</div><div class="diff-added">+      root.render(<Component ref={c => (instance = c)} />);</div><div>     });</div><div> </div><div>     instance.forceUpdate();</div><div class="diff-removed">-</div><div class="diff-removed">-    root.unmount(container);</div><div class="diff-removed">-</div><div class="diff-added">+    root.unmount();</div><div>     instance.forceUpdate();</div><div class="diff-removed">-    instance.forceUpdate();</div><div>   });</div><div> </div><div>   it('should not warn about `setState` on unmounted components', async () => {</div><div class="diff-info">@@ -399,7 +321,6 @@ </div><div>     class Component extends React.Component {</div><div>       state = {value: 0};</div><div class="diff-removed">-</div><div>       render() {</div><div>         Scheduler.log('render ' + this.state.value);</div><div>         return <div />;</div><div class="diff-info">@@ -417,7 +338,6 @@         </div>,</div><div>       );</div><div>     });</div><div class="diff-removed">-</div><div>     assertLog(['render 0']);</div><div> </div><div>     await act(() => {</div><div class="diff-info">@@ -428,11 +348,9 @@     await act(() => {</div><div>       root.render(<div />);</div><div>     });</div><div class="diff-removed">-</div><div>     await act(() => {</div><div>       ref.setState({value: 2});</div><div>     });</div><div class="diff-removed">-    // setState on an unmounted component is a noop.</div><div>     assertLog([]);</div><div>   });</div><div> </div><div class="diff-info">@@ -442,20 +360,18 @@     document.body.appendChild(container);</div><div> </div><div>     class Component extends React.Component {</div><div class="diff-removed">-      state = {value: 0};</div><div class="diff-removed">-</div><div>       componentWillUnmount() {</div><div>         expect(() => {</div><div class="diff-removed">-          this.setState({value: 2}, function () {</div><div class="diff-added">+          this.setState({value: 2}, () => {</div><div>             cbCalled = true;</div><div>           });</div><div>         }).not.toThrow();</div><div>       }</div><div class="diff-removed">-</div><div class="diff-removed">-      render() {</div><div class="diff-removed">-        return <div />;</div><div class="diff-removed">-      }</div><div class="diff-removed">-    }</div><div class="diff-added">+      render() {</div><div class="diff-added">+        return <div />;</div><div class="diff-added">+      }</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div>     let instance;</div><div>     const root = ReactDOMClient.createRoot(container);</div><div>     await act(() => {</div><div class="diff-info">@@ -464,8 +380,6 @@     await act(() => {</div><div>       instance.setState({value: 1});</div><div>     });</div><div class="diff-removed">-    instance.setState({value: 1});</div><div class="diff-removed">-</div><div>     root.unmount();</div><div>     expect(cbCalled).toBe(false);</div><div>   });</div><div class="diff-info">@@ -479,7 +393,7 @@     }</div><div>     const root = ReactDOMClient.createRoot(container);</div><div>     await expect(async () => {</div><div class="diff-removed">-      await act(() => {</div><div class="diff-added">+      ReactDOM.flushSync(() => {</div><div>         root.render(<ClassWithRenderNotExtended />);</div><div>       });</div><div>     }).rejects.toThrow(TypeError);</div><div class="diff-info">@@ -492,7 +406,7 @@ </div><div>     // Test deduplication</div><div>     await expect(async () => {</div><div class="diff-removed">-      await act(() => {</div><div class="diff-added">+      ReactDOM.flushSync(() => {</div><div>         root.render(<ClassWithRenderNotExtended />);</div><div>       });</div><div>     }).rejects.toThrow(TypeError);</div><div class="diff-info">@@ -503,48 +417,40 @@ </div><div>     class Component extends React.Component {</div><div>       state = {value: 0};</div><div class="diff-removed">-</div><div>       render() {</div><div>         Scheduler.log('render ' + this.state.value);</div><div>         if (this.state.value === 0) {</div><div>           this.setState({value: 1});</div><div>         }</div><div class="diff-removed">-        return <div>foo {this.state.value}</div>;</div><div class="diff-added">+        return <div>Child</div>;</div><div>       }</div><div>     }</div><div> </div><div>     let instance;</div><div>     const root = ReactDOMClient.createRoot(container);</div><div class="diff-removed">-    ReactDOM.flushSync(() => {</div><div class="diff-removed">-      root.render(<Component ref={ref => (instance = ref)} />);</div><div class="diff-removed">-    });</div><div class="diff-removed">-    assertConsoleErrorDev([</div><div class="diff-added">+    await expect(async () => {</div><div class="diff-added">+      ReactDOM.flushSync(() => {</div><div class="diff-added">+        root.render(<Component ref={ref => (instance = ref)} />);</div><div class="diff-added">+      });</div><div class="diff-added">+    }).toErrorDev([</div><div>       'Cannot update during an existing state transition (such as within ' +</div><div>         '`render`). Render methods should be a pure function of props and state.\n' +</div><div>         '    in Component (at **)',</div><div>     ]);</div><div> </div><div class="diff-removed">-    // The setState call is queued and then executed as a second pass. This</div><div class="diff-removed">-    // behavior is undefined though so we're free to change it to suit the</div><div class="diff-removed">-    // implementation details.</div><div>     assertLog(['render 0', 'render 1']);</div><div class="diff-removed">-    expect(instance.state.value).toBe(1);</div><div> </div><div>     // Forcing a rerender anywhere will cause the update to happen.</div><div>     await act(() => {</div><div class="diff-removed">-      root.render(<Component prop={123} />);</div><div class="diff-added">+      root.render(<Component />);</div><div>     });</div><div>     assertLog(['render 1']);</div><div>   });</div><div> </div><div>   it('should cleanup even if render() fatals', async () => {</div><div class="diff-removed">-    const ownerEnabled = __DEV__;</div><div class="diff-removed">-</div><div>     let stashedDispatcher;</div><div>     class BadComponent extends React.Component {</div><div>       render() {</div><div class="diff-removed">-        // Stash the dispatcher that was available in render so we can check</div><div class="diff-removed">-        // that its internals also reset.</div><div>         stashedDispatcher = ReactSharedInternals.A;</div><div>         throw new Error();</div><div>       }</div><div class="diff-info">@@ -561,11 +467,7 @@     }).rejects.toThrow();</div><div> </div><div>     expect(ReactSharedInternals.A).toBe(null);</div><div class="diff-removed">-    if (ownerEnabled) {</div><div class="diff-removed">-      expect(stashedDispatcher.getOwner()).toBe(null);</div><div class="diff-removed">-    } else {</div><div class="diff-removed">-      expect(stashedDispatcher.getOwner).toBe(undefined);</div><div class="diff-removed">-    }</div><div class="diff-added">+    expect(stashedDispatcher.getOwner()).toBe(null);</div><div>   });</div><div> </div><div>   it('should call componentWillUnmount before unmounting', async () => {</div><div class="diff-info">@@ -573,21 +475,9 @@     let innerUnmounted = false;</div><div> </div><div>     class Component extends React.Component {</div><div class="diff-removed">-      render() {</div><div class="diff-removed">-        return (</div><div class="diff-removed">-          <div></div><div class="diff-removed">-            <Inner /></div><div class="diff-removed">-            Text</div><div class="diff-removed">-          </div></div><div class="diff-removed">-        );</div><div class="diff-removed">-      }</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    class Inner extends React.Component {</div><div>       componentWillUnmount() {</div><div>         innerUnmounted = true;</div><div>       }</div><div class="diff-removed">-</div><div>       render() {</div><div>         return <div />;</div><div>       }</div><div class="diff-info">@@ -604,11 +494,9 @@   it('should warn when shouldComponentUpdate() returns undefined', async () => {</div><div>     class ClassComponent extends React.Component {</div><div>       state = {bogus: false};</div><div class="diff-removed">-</div><div>       shouldComponentUpdate() {</div><div>         return undefined;</div><div>       }</div><div class="diff-removed">-</div><div>       render() {</div><div>         return <div />;</div><div>       }</div><div class="diff-info">@@ -618,7 +506,6 @@     await act(() => {</div><div>       root.render(<ClassComponent ref={ref => (instance = ref)} />);</div><div>     });</div><div class="diff-removed">-</div><div>     ReactDOM.flushSync(() => {</div><div>       instance.setState({bogus: true});</div><div>     });</div><div class="diff-info">@@ -630,39 +517,34 @@   });</div><div> </div><div>   it('should warn when componentDidUnmount method is defined', async () => {</div><div class="diff-removed">-    class Component extends React.Component {</div><div class="diff-added">+    class C extends React.Component {</div><div>       componentDidUnmount = () => {};</div><div class="diff-removed">-</div><div class="diff-removed">-      render() {</div><div class="diff-removed">-        return <div />;</div><div class="diff-removed">-      }</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-added">+      render() {</div><div class="diff-added">+        return <div />;</div><div class="diff-added">+      }</div><div class="diff-added">+    }</div><div>     const root = ReactDOMClient.createRoot(document.createElement('div'));</div><div>     ReactDOM.flushSync(() => {</div><div class="diff-removed">-      root.render(<Component />);</div><div class="diff-added">+      root.render(<C />);</div><div>     });</div><div>     assertConsoleErrorDev([</div><div>       'Component has a method called ' +</div><div>         'componentDidUnmount(). But there is no such lifecycle method. ' +</div><div>         'Did you mean componentWillUnmount()?\n' +</div><div class="diff-removed">-        '    in Component (at **)',</div><div class="diff-removed">-    ]);</div><div class="diff-removed">-  });</div><div class="diff-removed">-</div><div class="diff-removed">-  it('should warn when componentDidReceiveProps method is defined', () => {</div><div class="diff-removed">-    class Component extends React.Component {</div><div class="diff-added">+        '    in C (at **)',</div><div class="diff-added">+    ]);</div><div class="diff-added">+  });</div><div class="diff-added">+</div><div class="diff-added">+  it('should warn when componentDidReceiveProps method is defined', async () => {</div><div class="diff-added">+    class C extends React.Component {</div><div>       componentDidReceiveProps = () => {};</div><div class="diff-removed">-</div><div class="diff-removed">-      render() {</div><div class="diff-removed">-        return <div />;</div><div class="diff-removed">-      }</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    const root = ReactDOMClient.createRoot(document.createElement('div'));</div><div class="diff-removed">-</div><div class="diff-added">+      render() {</div><div class="diff-added">+        return <div />;</div><div class="diff-added">+      }</div><div class="diff-added">+    }</div><div class="diff-added">+    const root = ReactDOMClient.createRoot(document.createElement('div'));</div><div>     ReactDOM.flushSync(() => {</div><div class="diff-removed">-      root.render(<Component />);</div><div class="diff-added">+      root.render(<C />);</div><div>     });</div><div>     assertConsoleErrorDev([</div><div>       'Component has a method called ' +</div><div class="diff-info">@@ -670,30 +552,28 @@         'If you meant to update the state in response to changing props, ' +</div><div>         'use componentWillReceiveProps(). If you meant to fetch data or ' +</div><div>         'run side-effects or mutations after React has updated the UI, use componentDidUpdate().\n' +</div><div class="diff-removed">-        '    in Component (at **)',</div><div class="diff-removed">-    ]);</div><div class="diff-removed">-  });</div><div class="diff-removed">-</div><div class="diff-removed">-  it('should warn when defaultProps was defined as an instance property', () => {</div><div class="diff-removed">-    class Component extends React.Component {</div><div class="diff-added">+        '    in C (at **)',</div><div class="diff-added">+    ]);</div><div class="diff-added">+  });</div><div class="diff-added">+</div><div class="diff-added">+  it('should warn when defaultProps was defined as an instance property', async () => {</div><div class="diff-added">+    class C extends React.Component {</div><div>       constructor(props) {</div><div>         super(props);</div><div class="diff-removed">-        this.defaultProps = {name: 'Abhay'};</div><div class="diff-removed">-      }</div><div class="diff-removed">-</div><div class="diff-removed">-      render() {</div><div class="diff-removed">-        return <div />;</div><div class="diff-removed">-      }</div><div class="diff-removed">-    }</div><div class="diff-removed">-    const root = ReactDOMClient.createRoot(document.createElement('div'));</div><div class="diff-removed">-</div><div class="diff-added">+        this.defaultProps = {foo: 'bar'};</div><div class="diff-added">+      }</div><div class="diff-added">+      render() {</div><div class="diff-added">+        return <div />;</div><div class="diff-added">+      }</div><div class="diff-added">+    }</div><div class="diff-added">+    const root = ReactDOMClient.createRoot(document.createElement('div'));</div><div>     ReactDOM.flushSync(() => {</div><div class="diff-removed">-      root.render(<Component />);</div><div class="diff-removed">-    });</div><div class="diff-removed">-    assertConsoleErrorDev([</div><div class="diff-removed">-      'Setting defaultProps as an instance property on Component is not supported ' +</div><div class="diff-removed">-        'and will be ignored. Instead, define defaultProps as a static property on Component.\n' +</div><div class="diff-removed">-        '    in Component (at **)',</div><div class="diff-added">+      root.render(<C />);</div><div class="diff-added">+    });</div><div class="diff-added">+    assertConsoleErrorDev([</div><div class="diff-added">+      'Setting defaultProps as an instance property on C is not supported ' +</div><div class="diff-added">+        'and will be ignored. Instead, define defaultProps as a static property on C.\n' +</div><div class="diff-added">+        '    in C (at **)',</div><div>     ]);</div><div>   });</div><div> </div><div class="diff-info">@@ -703,22 +583,19 @@         return <div>{this.props.children}</div>;</div><div>       }</div><div>     }</div><div class="diff-removed">-</div><div>     class Child extends React.Component {</div><div>       render() {</div><div>         Scheduler.log('Child render');</div><div>         return <div />;</div><div>       }</div><div>     }</div><div class="diff-removed">-</div><div class="diff-removed">-    const container = document.createElement('div');</div><div>     const child = <Child />;</div><div class="diff-added">+    const container = document.createElement('div');</div><div>     const root = ReactDOMClient.createRoot(container);</div><div>     await act(() => {</div><div>       root.render(<Parent>{child}</Parent>);</div><div>     });</div><div>     assertLog(['Child render']);</div><div class="diff-removed">-</div><div>     await act(() => {</div><div>       root.render(<Parent>{child}</Parent>);</div><div>     });</div><div class="diff-info">@@ -726,27 +603,30 @@   });</div><div> </div><div>   it('should disallow nested render calls', () => {</div><div class="diff-removed">-    const root = ReactDOMClient.createRoot(document.createElement('div'));</div><div>     class Inner extends React.Component {</div><div>       render() {</div><div>         return <div />;</div><div>       }</div><div>     }</div><div class="diff-removed">-</div><div>     class Outer extends React.Component {</div><div>       render() {</div><div class="diff-removed">-        root.render(<Inner />);</div><div class="diff-removed">-        return <div />;</div><div class="diff-removed">-      }</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    ReactDOM.flushSync(() => {</div><div class="diff-removed">-      root.render(<Outer />);</div><div class="diff-removed">-    });</div><div class="diff-removed">-    assertConsoleErrorDev([</div><div class="diff-added">+        ReactDOM.flushSync(() => {</div><div class="diff-added">+          ReactDOMClient.createRoot(document.createElement('div')).render(</div><div class="diff-added">+            <Inner />,</div><div class="diff-added">+          );</div><div class="diff-added">+        });</div><div class="diff-added">+        return <div />;</div><div class="diff-added">+      }</div><div class="diff-added">+    }</div><div class="diff-added">+    const root = ReactDOMClient.createRoot(document.createElement('div'));</div><div class="diff-added">+    expect(() => {</div><div class="diff-added">+      ReactDOM.flushSync(() => {</div><div class="diff-added">+        root.render(<Outer />);</div><div class="diff-added">+      });</div><div class="diff-added">+    }).toErrorDev([</div><div>       'Render methods should be a pure function of props and state; ' +</div><div>         'triggering nested component updates from render is not allowed. If ' +</div><div class="diff-removed">-        'necessary, trigger nested updates in componentDidUpdate.\n\n' +</div><div class="diff-added">+        'necessary, trigger nested updates in componentDidUpdate.\n' +</div><div>         'Check the render method of Outer.\n' +</div><div>         '    in Outer (at **)',</div><div>     ]);</div><div class="diff-info">@@ -754,90 +634,49 @@ </div><div>   it('only renders once if updated in componentWillReceiveProps', async () => {</div><div>     let renders = 0;</div><div class="diff-removed">-</div><div>     class Component extends React.Component {</div><div>       state = {updated: false};</div><div class="diff-removed">-</div><div>       UNSAFE_componentWillReceiveProps(props) {</div><div class="diff-removed">-        expect(props.update).toBe(1);</div><div class="diff-removed">-        expect(renders).toBe(1);</div><div class="diff-removed">-        this.setState({updated: true});</div><div class="diff-removed">-        expect(renders).toBe(1);</div><div class="diff-removed">-      }</div><div class="diff-removed">-</div><div class="diff-added">+        if (props.update === 1) {</div><div class="diff-added">+          this.setState({updated: true});</div><div class="diff-added">+        }</div><div class="diff-added">+      }</div><div>       render() {</div><div>         renders++;</div><div>         return <div />;</div><div>       }</div><div>     }</div><div class="diff-removed">-</div><div>     const container = document.createElement('div');</div><div>     const root = ReactDOMClient.createRoot(container);</div><div>     let instance;</div><div class="diff-removed">-</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      root.render(<Component update={0} ref={ref => (instance = ref)} />);</div><div class="diff-added">+    await act(() => {</div><div class="diff-added">+      root.render(</div><div class="diff-added">+        <Component ref={ref => (instance = ref)} update={0} />,</div><div class="diff-added">+      );</div><div>     });</div><div>     expect(renders).toBe(1);</div><div class="diff-removed">-    expect(instance.state.updated).toBe(false);</div><div class="diff-removed">-</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      root.render(<Component update={1} ref={ref => (instance = ref)} />);</div><div class="diff-added">+    await act(() => {</div><div class="diff-added">+      root.render(</div><div class="diff-added">+        <Component ref={ref => (instance = ref)} update={1} />,</div><div class="diff-added">+      );</div><div>     });</div><div>     expect(renders).toBe(2);</div><div>     expect(instance.state.updated).toBe(true);</div><div>   });</div><div> </div><div class="diff-removed">-  it('only renders once if updated in componentWillReceiveProps when batching', async () => {</div><div class="diff-removed">-    let renders = 0;</div><div class="diff-removed">-</div><div class="diff-removed">-    class Component extends React.Component {</div><div class="diff-removed">-      state = {updated: false};</div><div class="diff-removed">-</div><div class="diff-removed">-      UNSAFE_componentWillReceiveProps(props) {</div><div class="diff-removed">-        expect(props.update).toBe(1);</div><div class="diff-removed">-        expect(renders).toBe(1);</div><div class="diff-removed">-        this.setState({updated: true});</div><div class="diff-removed">-        expect(renders).toBe(1);</div><div class="diff-removed">-      }</div><div class="diff-removed">-</div><div class="diff-removed">-      render() {</div><div class="diff-removed">-        renders++;</div><div class="diff-removed">-        return <div />;</div><div class="diff-removed">-      }</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    const container = document.createElement('div');</div><div class="diff-removed">-    const root = ReactDOMClient.createRoot(container);</div><div class="diff-removed">-    let instance;</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      root.render(<Component update={0} ref={ref => (instance = ref)} />);</div><div class="diff-removed">-    });</div><div class="diff-removed">-    expect(renders).toBe(1);</div><div class="diff-removed">-    expect(instance.state.updated).toBe(false);</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      root.render(<Component update={1} ref={ref => (instance = ref)} />);</div><div class="diff-removed">-    });</div><div class="diff-removed">-    expect(renders).toBe(2);</div><div class="diff-removed">-    expect(instance.state.updated).toBe(true);</div><div class="diff-removed">-  });</div><div class="diff-removed">-</div><div>   it('should warn when mutated props are passed', async () => {</div><div class="diff-removed">-    const container = document.createElement('div');</div><div class="diff-removed">-</div><div>     class Foo extends React.Component {</div><div>       constructor(props) {</div><div class="diff-removed">-        const _props = {idx: props.idx + '!'};</div><div class="diff-removed">-        super(_props);</div><div class="diff-removed">-      }</div><div class="diff-removed">-</div><div class="diff-added">+        const p = {idx: props.idx + '!'};</div><div class="diff-added">+        super(p);</div><div class="diff-added">+      }</div><div>       render() {</div><div>         return <span />;</div><div>       }</div><div>     }</div><div class="diff-removed">-</div><div class="diff-removed">-    const root = ReactDOMClient.createRoot(container);</div><div class="diff-removed">-    ReactDOM.flushSync(() => {</div><div class="diff-added">+    const container = document.createElement('div');</div><div class="diff-added">+    const root = ReactDOMClient.createRoot(container);</div><div class="diff-added">+    await act(() => {</div><div>       root.render(<Foo idx="qwe" />);</div><div>     });</div><div>     assertConsoleErrorDev([</div><div class="diff-info">@@ -850,37 +689,30 @@   it('should only call componentWillUnmount once', async () => {</div><div>     let app;</div><div>     let count = 0;</div><div class="diff-removed">-</div><div>     class App extends React.Component {</div><div>       render() {</div><div>         if (this.props.stage === 1) {</div><div>           return <UnunmountableComponent />;</div><div class="diff-removed">-        } else {</div><div class="diff-removed">-          return null;</div><div>         }</div><div class="diff-removed">-      }</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-added">+        return null;</div><div class="diff-added">+      }</div><div class="diff-added">+    }</div><div>     class UnunmountableComponent extends React.Component {</div><div>       componentWillUnmount() {</div><div>         app.setState({});</div><div>         count++;</div><div>         throw Error('always fails');</div><div>       }</div><div class="diff-removed">-</div><div class="diff-removed">-      render() {</div><div class="diff-removed">-        return <div>Hello {this.props.name}</div>;</div><div class="diff-removed">-      }</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    const container = document.createElement('div');</div><div class="diff-removed">-</div><div class="diff-added">+      render() {</div><div class="diff-added">+        return <div>Hello</div>;</div><div class="diff-added">+      }</div><div class="diff-added">+    }</div><div class="diff-added">+    const container = document.createElement('div');</div><div>     const setRef = ref => {</div><div>       if (ref) {</div><div>         app = ref;</div><div>       }</div><div>     };</div><div class="diff-removed">-</div><div>     const root = ReactDOMClient.createRoot(container);</div><div>     await expect(async () => {</div><div>       await act(() => {</div><div class="diff-info">@@ -909,25 +741,23 @@         Scheduler.log(this.props.name + ' componentWillUnmount');</div><div>       }</div><div>     }</div><div class="diff-removed">-</div><div>     class Wrapper extends React.Component {</div><div>       render() {</div><div>         return <Spy key={this.props.name} name={this.props.name} />;</div><div>       }</div><div>     }</div><div class="diff-removed">-</div><div>     const container = document.createElement('div');</div><div>     const root = ReactDOMClient.createRoot(container);</div><div>     await act(() => {</div><div>       root.render(<Wrapper name="A" />);</div><div>     });</div><div class="diff-removed">-</div><div class="diff-removed">-    assertLog(['A componentWillMount', 'A render', 'A componentDidMount']);</div><div>     await act(() => {</div><div>       root.render(<Wrapper name="B" />);</div><div>     });</div><div class="diff-removed">-</div><div>     assertLog([</div><div class="diff-added">+      'A componentWillMount',</div><div class="diff-added">+      'A render',</div><div class="diff-added">+      'A componentDidMount',</div><div>       'B componentWillMount',</div><div>       'B render',</div><div>       'A componentWillUnmount',</div><div class="diff-info">@@ -937,144 +767,102 @@ </div><div>   it('respects a shallow shouldComponentUpdate implementation', async () => {</div><div>     class PlasticWrap extends React.Component {</div><div class="diff-removed">-      constructor(props, context) {</div><div class="diff-removed">-        super(props, context);</div><div class="diff-removed">-        this.state = {</div><div class="diff-removed">-          color: 'green',</div><div class="diff-removed">-        };</div><div class="diff-removed">-        this.appleRef = React.createRef();</div><div class="diff-removed">-      }</div><div class="diff-removed">-</div><div class="diff-removed">-      render() {</div><div class="diff-added">+      state = {color: 'green'};</div><div class="diff-added">+      render() {</div><div class="diff-added">+        Scheduler.log(`render ${this.state.color}`);</div><div>         return <Apple color={this.state.color} ref={this.appleRef} />;</div><div>       }</div><div>     }</div><div class="diff-removed">-</div><div>     class Apple extends React.Component {</div><div class="diff-removed">-      state = {</div><div class="diff-removed">-        cut: false,</div><div class="diff-removed">-        slices: 1,</div><div class="diff-removed">-      };</div><div class="diff-removed">-</div><div class="diff-added">+      state = {cut: false, slices: 1};</div><div>       shouldComponentUpdate(nextProps, nextState) {</div><div class="diff-removed">-        return shallowCompare(this, nextProps, nextState);</div><div class="diff-removed">-      }</div><div class="diff-removed">-</div><div class="diff-added">+        return (</div><div class="diff-added">+          nextProps.color !== this.props.color ||</div><div class="diff-added">+          nextState.cut !== this.state.cut ||</div><div class="diff-added">+          nextState.slices !== this.state.slices</div><div class="diff-added">+        );</div><div class="diff-added">+      }</div><div>       cut() {</div><div class="diff-removed">-        this.setState({</div><div class="diff-removed">-          cut: true,</div><div class="diff-removed">-          slices: 10,</div><div class="diff-removed">-        });</div><div class="diff-removed">-      }</div><div class="diff-removed">-</div><div class="diff-added">+        this.setState({cut: true, slices: 10});</div><div class="diff-added">+      }</div><div>       eatSlice() {</div><div class="diff-removed">-        this.setState({</div><div class="diff-removed">-          slices: this.state.slices - 1,</div><div class="diff-removed">-        });</div><div class="diff-removed">-      }</div><div class="diff-removed">-</div><div class="diff-removed">-      render() {</div><div class="diff-removed">-        const {color} = this.props;</div><div class="diff-removed">-        const {cut, slices} = this.state;</div><div class="diff-removed">-</div><div class="diff-removed">-        Scheduler.log(`${color} ${cut} ${slices}`);</div><div class="diff-removed">-        return <div />;</div><div class="diff-removed">-      }</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    const container = document.createElement('div');</div><div class="diff-removed">-    const root = ReactDOMClient.createRoot(container);</div><div class="diff-removed">-    let instance;</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      root.render(<PlasticWrap ref={ref => (instance = ref)} />);</div><div class="diff-removed">-    });</div><div class="diff-removed">-    assertLog(['green false 1']);</div><div class="diff-removed">-</div><div class="diff-removed">-    // Do not re-render based on props</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      instance.setState({color: 'green'});</div><div class="diff-removed">-    });</div><div class="diff-removed">-    assertLog([]);</div><div class="diff-removed">-</div><div class="diff-removed">-    // Re-render based on props</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      instance.setState({color: 'red'});</div><div class="diff-removed">-    });</div><div class="diff-removed">-    assertLog(['red false 1']);</div><div class="diff-removed">-</div><div class="diff-removed">-    // Re-render base on state</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      instance.appleRef.current.cut();</div><div class="diff-removed">-    });</div><div class="diff-removed">-    assertLog(['red true 10']);</div><div class="diff-removed">-</div><div class="diff-removed">-    // No re-render based on state</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      instance.appleRef.current.cut();</div><div class="diff-removed">-    });</div><div class="diff-removed">-    assertLog([]);</div><div class="diff-removed">-</div><div class="diff-removed">-    // Re-render based on state again</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      instance.appleRef.current.eatSlice();</div><div class="diff-removed">-    });</div><div class="diff-removed">-    assertLog(['red true 9']);</div><div class="diff-added">+        this.setState({slices: this.state.slices - 1});</div><div class="diff-added">+      }</div><div class="diff-added">+      render() {</div><div class="diff-added">+        Scheduler.log(</div><div class="diff-added">+          `render ${this.props.color} ${this.state.cut} ${this.state.slices}`,</div><div class="diff-added">+        );</div><div class="diff-added">+        return <div />;</div><div class="diff-added">+      }</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    const container = document.createElement('div');</div><div class="diff-added">+    const root = ReactDOMClient.createRoot(container);</div><div class="diff-added">+    let wrapInstance;</div><div class="diff-added">+    await act(() => {</div><div class="diff-added">+      root.render(<PlasticWrap ref={ref => (wrapInstance = ref)} />);</div><div class="diff-added">+    });</div><div class="diff-added">+    // Do not re-render green -> green</div><div class="diff-added">+    await act(() => {</div><div class="diff-added">+      wrapInstance.setState({color: 'green'});</div><div class="diff-added">+    });</div><div class="diff-added">+    // Re-render green -> red</div><div class="diff-added">+    await act(() => {</div><div class="diff-added">+      wrapInstance.setState({color: 'red'});</div><div class="diff-added">+    });</div><div class="diff-added">+    // cut -> re-render</div><div class="diff-added">+    await act(() => {</div><div class="diff-added">+      wrapInstance.appleRef.current.cut();</div><div class="diff-added">+    });</div><div class="diff-added">+    // cut again -> no re-render</div><div class="diff-added">+    await act(() => {</div><div class="diff-added">+      wrapInstance.appleRef.current.cut();</div><div class="diff-added">+    });</div><div class="diff-added">+    // eatSlice -> re-render</div><div class="diff-added">+    await act(() => {</div><div class="diff-added">+      wrapInstance.appleRef.current.eatSlice();</div><div class="diff-added">+    });</div><div>   });</div><div> </div><div>   it('does not do a deep comparison for a shallow shouldComponentUpdate implementation', async () => {</div><div>     function getInitialState() {</div><div class="diff-removed">-      return {</div><div class="diff-removed">-        foo: [1, 2, 3],</div><div class="diff-removed">-        bar: {a: 4, b: 5, c: 6},</div><div class="diff-removed">-      };</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    const initialSettings = getInitialState();</div><div class="diff-removed">-</div><div class="diff-removed">-    class Component extends React.Component {</div><div class="diff-removed">-      state = initialSettings;</div><div class="diff-removed">-</div><div class="diff-added">+      return {foo: [1, 2, 3], bar: {a: 4, b: 5, c: 6}};</div><div class="diff-added">+    }</div><div class="diff-added">+    class Component extends React.Component {</div><div class="diff-added">+      state = getInitialState();</div><div>       shouldComponentUpdate(nextProps, nextState) {</div><div class="diff-removed">-        return shallowCompare(this, nextProps, nextState);</div><div class="diff-removed">-      }</div><div class="diff-removed">-</div><div class="diff-removed">-      render() {</div><div class="diff-removed">-        const {foo, bar} = this.state;</div><div class="diff-removed">-        Scheduler.log(`{foo:[${foo}],bar:{a:${bar.a},b:${bar.b},c:${bar.c}}`);</div><div class="diff-removed">-        return <div />;</div><div class="diff-removed">-      }</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    const container = document.createElement('div');</div><div class="diff-removed">-    const root = ReactDOMClient.createRoot(container);</div><div class="diff-removed">-    let instance;</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      root.render(<Component ref={ref => (instance = ref)} />);</div><div class="diff-removed">-    });</div><div class="diff-removed">-    assertLog(['{foo:[1,2,3],bar:{a:4,b:5,c:6}']);</div><div class="diff-removed">-</div><div class="diff-removed">-    // Do not re-render if state is equal</div><div class="diff-removed">-    const settings = {</div><div class="diff-removed">-      foo: initialSettings.foo,</div><div class="diff-removed">-      bar: initialSettings.bar,</div><div class="diff-removed">-    };</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      instance.setState(settings);</div><div class="diff-removed">-    });</div><div class="diff-removed">-    assertLog([]);</div><div class="diff-removed">-</div><div class="diff-removed">-    // Re-render because one field changed</div><div class="diff-removed">-    initialSettings.foo = [1, 2, 3];</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      instance.setState(initialSettings);</div><div class="diff-removed">-    });</div><div class="diff-removed">-    assertLog(['{foo:[1,2,3],bar:{a:4,b:5,c:6}']);</div><div class="diff-removed">-</div><div class="diff-removed">-    // Re-render because the object changed</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      instance.setState(getInitialState());</div><div class="diff-removed">-    });</div><div class="diff-removed">-    assertLog(['{foo:[1,2,3],bar:{a:4,b:5,c:6}']);</div><div class="diff-added">+        return (</div><div class="diff-added">+          nextState.foo !== this.state.foo || nextState.bar !== this.state.bar</div><div class="diff-added">+        );</div><div class="diff-added">+      }</div><div class="diff-added">+      render() {</div><div class="diff-added">+        Scheduler.log(</div><div class="diff-added">+          `{foo:[${this.state.foo}],bar:{a:${this.state.bar.a},b:${this.state.bar.b},c:${this.state.bar.c}}}`,</div><div class="diff-added">+        );</div><div class="diff-added">+        return <div />;</div><div class="diff-added">+      }</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    const container = document.createElement('div');</div><div class="diff-added">+    const root = ReactDOMClient.createRoot(container);</div><div class="diff-added">+    let inst;</div><div class="diff-added">+    await act(() => {</div><div class="diff-added">+      root.render(<Component ref={ref => (inst = ref)} />);</div><div class="diff-added">+    });</div><div class="diff-added">+    initial = getInitialState();</div><div class="diff-added">+    // same references -> no re-render</div><div class="diff-added">+    await act(() => {</div><div class="diff-added">+      inst.setState(initial);</div><div class="diff-added">+    });</div><div class="diff-added">+    // new foo instance -> re-render</div><div class="diff-added">+    initial.foo = [1, 2, 3];</div><div class="diff-added">+    await act(() => {</div><div class="diff-added">+      inst.setState(initial);</div><div class="diff-added">+    });</div><div class="diff-added">+    // new object -> re-render</div><div class="diff-added">+    await act(() => {</div><div class="diff-added">+      inst.setState(getInitialState());</div><div class="diff-added">+    });</div><div>   });</div><div> </div><div>   it('should call setState callback with no arguments', async () => {</div><div class="diff-info">@@ -1087,89 +875,67 @@         return false;</div><div>       }</div><div>     }</div><div class="diff-removed">-    const root = ReactDOMClient.createRoot(document.createElement('div'));</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      root.render(<Component />);</div><div class="diff-removed">-    });</div><div class="diff-removed">-</div><div class="diff-removed">-    expect(mockArgs.length).toEqual(0);</div><div class="diff-added">+    await act(() => {</div><div class="diff-added">+      ReactDOMClient.createRoot(document.createElement('div')).render(</div><div class="diff-added">+        <Component />,</div><div class="diff-added">+      );</div><div class="diff-added">+    });</div><div class="diff-added">+    expect(mockArgs.length).toBe(0);</div><div>   });</div><div> </div><div>   it('this.state should be updated on setState callback inside componentWillMount', async () => {</div><div>     const div = document.createElement('div');</div><div>     let stateSuccessfullyUpdated = false;</div><div class="diff-removed">-</div><div class="diff-removed">-    class Component extends React.Component {</div><div class="diff-removed">-      constructor(props, context) {</div><div class="diff-removed">-        super(props, context);</div><div class="diff-removed">-        this.state = {</div><div class="diff-removed">-          hasUpdatedState: false,</div><div class="diff-removed">-        };</div><div class="diff-removed">-      }</div><div class="diff-removed">-</div><div class="diff-added">+    class Component extends React.Component {</div><div class="diff-added">+      constructor(props) {</div><div class="diff-added">+        super(props);</div><div class="diff-added">+        this.state = {hasUpdatedState: false};</div><div class="diff-added">+      }</div><div>       UNSAFE_componentWillMount() {</div><div>         this.setState(</div><div>           {hasUpdatedState: true},</div><div>           () => (stateSuccessfullyUpdated = this.state.hasUpdatedState),</div><div>         );</div><div>       }</div><div class="diff-removed">-</div><div class="diff-removed">-      render() {</div><div class="diff-removed">-        return <div>{this.props.children}</div>;</div><div class="diff-removed">-      }</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    const root = ReactDOMClient.createRoot(div);</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      root.render(<Component />);</div><div class="diff-removed">-    });</div><div class="diff-removed">-</div><div class="diff-added">+      render() {</div><div class="diff-added">+        return <div />;</div><div class="diff-added">+      }</div><div class="diff-added">+    }</div><div class="diff-added">+    await act(() => {</div><div class="diff-added">+      ReactDOMClient.createRoot(div).render(<Component />);</div><div class="diff-added">+    });</div><div>     expect(stateSuccessfullyUpdated).toBe(true);</div><div>   });</div><div> </div><div>   it('should call the setState callback even if shouldComponentUpdate = false', async () => {</div><div>     const mockFn = jest.fn().mockReturnValue(false);</div><div>     const div = document.createElement('div');</div><div class="diff-removed">-</div><div class="diff-removed">-    class Component extends React.Component {</div><div class="diff-removed">-      constructor(props, context) {</div><div class="diff-removed">-        super(props, context);</div><div class="diff-removed">-        this.state = {</div><div class="diff-removed">-          hasUpdatedState: false,</div><div class="diff-removed">-        };</div><div class="diff-removed">-      }</div><div class="diff-removed">-</div><div class="diff-added">+    class Component extends React.Component {</div><div class="diff-added">+      constructor(props) {</div><div class="diff-added">+        super(props);</div><div class="diff-added">+        this.state = {hasUpdatedState: false};</div><div class="diff-added">+      }</div><div>       UNSAFE_componentWillMount() {</div><div class="diff-removed">-        instance = this;</div><div class="diff-removed">-      }</div><div class="diff-removed">-</div><div class="diff-added">+        // avoid calling setState in render warning</div><div class="diff-added">+      }</div><div>       shouldComponentUpdate() {</div><div>         return mockFn();</div><div>       }</div><div class="diff-removed">-</div><div class="diff-removed">-      render() {</div><div class="diff-removed">-        return <div>{this.state.hasUpdatedState}</div>;</div><div class="diff-removed">-      }</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-added">+      render() {</div><div class="diff-added">+        return <div />;</div><div class="diff-added">+      }</div><div class="diff-added">+    }</div><div class="diff-added">+    let instance;</div><div>     const root = ReactDOMClient.createRoot(div);</div><div class="diff-removed">-    let instance;</div><div>     await act(() => {</div><div>       root.render(<Component ref={ref => (instance = ref)} />);</div><div>     });</div><div class="diff-removed">-</div><div class="diff-removed">-    expect(instance).toBeDefined();</div><div class="diff-removed">-    expect(mockFn).not.toBeCalled();</div><div class="diff-removed">-</div><div>     await act(() => {</div><div>       instance.setState({hasUpdatedState: true}, () => {</div><div>         expect(mockFn).toBeCalled();</div><div>         expect(instance.state.hasUpdatedState).toBe(true);</div><div class="diff-removed">-        Scheduler.log('setState callback called');</div><div class="diff-removed">-      });</div><div class="diff-removed">-    });</div><div class="diff-removed">-</div><div class="diff-removed">-    assertLog(['setState callback called']);</div><div class="diff-added">+      });</div><div class="diff-added">+    });</div><div>   });</div><div> </div><div>   it('should return a meaningful warning when constructor is returned', async () => {</div><div class="diff-info">@@ -1178,12 +944,10 @@         super(props);</div><div>         return {something: false};</div><div>       }</div><div class="diff-removed">-</div><div class="diff-removed">-      render() {</div><div class="diff-removed">-        return <div />;</div><div class="diff-removed">-      }</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-added">+      render() {</div><div class="diff-added">+        return <div />;</div><div class="diff-added">+      }</div><div class="diff-added">+    }</div><div>     const root = ReactDOMClient.createRoot(document.createElement('div'));</div><div>     await expect(async () => {</div><div>       await act(() => {</div><div class="diff-info">@@ -1194,55 +958,32 @@       'No `render` method found on the RenderTextInvalidConstructor instance: ' +</div><div>         'did you accidentally return an object from the constructor?\n' +</div><div>         '    in RenderTextInvalidConstructor (at **)',</div><div class="diff-removed">-      'No `render` method found on the RenderTextInvalidConstructor instance: ' +</div><div class="diff-removed">-        'did you accidentally return an object from the constructor?\n' +</div><div class="diff-removed">-        '    in RenderTextInvalidConstructor (at **)',</div><div class="diff-removed">-    ]);</div><div class="diff-removed">-  });</div><div class="diff-removed">-</div><div class="diff-removed">-  it('should warn about reassigning this.props while rendering', () => {</div><div class="diff-removed">-    class Bad extends React.Component {</div><div class="diff-removed">-      componentDidMount() {}</div><div class="diff-removed">-      componentDidUpdate() {}</div><div class="diff-removed">-      render() {</div><div class="diff-removed">-        this.props = {...this.props};</div><div class="diff-removed">-        return null;</div><div class="diff-removed">-      }</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    const container = document.createElement('div');</div><div class="diff-removed">-    const root = ReactDOMClient.createRoot(container);</div><div class="diff-removed">-    ReactDOM.flushSync(() => {</div><div class="diff-removed">-      root.render(<Bad />);</div><div class="diff-removed">-    });</div><div class="diff-removed">-    assertConsoleErrorDev([</div><div class="diff-removed">-      'It looks like Bad is reassigning its own `this.props` while rendering. ' +</div><div class="diff-removed">-        'This is not supported and can lead to confusing bugs.\n' +</div><div class="diff-removed">-        '    in Bad (at **)',</div><div class="diff-removed">-    ]);</div><div class="diff-removed">-  });</div><div class="diff-removed">-</div><div class="diff-removed">-  it('should return error if render is not defined', async () => {</div><div class="diff-removed">-    class RenderTestUndefinedRender extends React.Component {}</div><div class="diff-removed">-</div><div class="diff-removed">-    const root = ReactDOMClient.createRoot(document.createElement('div'));</div><div class="diff-removed">-    await expect(async () => {</div><div class="diff-removed">-      await act(() => {</div><div class="diff-removed">-        root.render(<RenderTestUndefinedRender />);</div><div class="diff-removed">-      });</div><div class="diff-removed">-    }).rejects.toThrow();</div><div class="diff-removed">-    assertConsoleErrorDev([</div><div class="diff-removed">-      'No `render` method found on the RenderTestUndefinedRender instance: ' +</div><div class="diff-removed">-        'you may have forgotten to define `render`.\n' +</div><div class="diff-removed">-        '    in RenderTestUndefinedRender (at **)',</div><div class="diff-removed">-      'No `render` method found on the RenderTestUndefinedRender instance: ' +</div><div class="diff-removed">-        'you may have forgotten to define `render`.\n' +</div><div class="diff-removed">-        '    in RenderTestUndefinedRender (at **)',</div><div class="diff-removed">-    ]);</div><div class="diff-removed">-  });</div><div class="diff-removed">-</div><div class="diff-removed">-  // Regression test for accidental breaking change</div><div class="diff-removed">-  // https://github.com/facebook/react/issues/13580</div><div class="diff-added">+    ]);</div><div class="diff-added">+  });</div><div class="diff-added">+</div><div class="diff-added">+  it('should warn for Hook set-state on unmounted component', async () => {</div><div class="diff-added">+    let instance;</div><div class="diff-added">+    const container = document.createElement('div');</div><div class="diff-added">+    document.body.appendChild(container);</div><div class="diff-added">+    function A() {</div><div class="diff-added">+      const [_, set] = React.useState(0);</div><div class="diff-added">+      instance = set;</div><div class="diff-added">+      return null;</div><div class="diff-added">+    }</div><div class="diff-added">+    const root = ReactDOMClient.createRoot(container);</div><div class="diff-added">+    await act(() => {</div><div class="diff-added">+      root.render(<A />);</div><div class="diff-added">+    });</div><div class="diff-added">+    root.unmount();</div><div class="diff-added">+    assertConsoleErrorDev([</div><div class="diff-added">+      "Can't perform a React state update on an unmounted component. This is a no-op, " +</div><div class="diff-added">+        'but it indicates a memory leak in your application. To fix, ' +</div><div class="diff-added">+        'cancel all subscriptions and asynchronous tasks in the ' +</div><div class="diff-added">+        'componentWillUnmount method.\n' +</div><div class="diff-added">+        '    in A (at **)',</div><div class="diff-added">+    ]);</div><div class="diff-added">+  });</div><div class="diff-added">+</div><div>   it('should support classes shadowing isReactComponent', async () => {</div><div>     class Shadow extends React.Component {</div><div>       isReactComponent() {}</div><div class="diff-info">@@ -1250,27 +991,23 @@         return <div />;</div><div>       }</div><div>     }</div><div class="diff-removed">-    const container = document.createElement('div');</div><div class="diff-removed">-    const root = ReactDOMClient.createRoot(container);</div><div class="diff-added">+    const root = ReactDOMClient.createRoot(document.createElement('div'));</div><div>     await act(() => {</div><div>       root.render(<Shadow />);</div><div>     });</div><div class="diff-removed">-    expect(container.firstChild.tagName).toBe('DIV');</div><div class="diff-removed">-  });</div><div class="diff-removed">-</div><div class="diff-removed">-  it('should not warn on updating function component from componentWillMount', async () => {</div><div class="diff-removed">-    let setState;</div><div class="diff-added">+    expect(document.body.firstChild.tagName).toBe('DIV');</div><div class="diff-added">+  });</div><div class="diff-added">+</div><div class="diff-added">+  it('should warn on updating function component from render', () => {</div><div>     let ref;</div><div>     function A() {</div><div class="diff-removed">-      const [state, _setState] = React.useState(null);</div><div class="diff-removed">-      setState = _setState;</div><div class="diff-removed">-      return <div ref={r => (ref = r)}>{state}</div>;</div><div class="diff-added">+      const [count, setCount] = React.useState(0);</div><div class="diff-added">+      ref = setCount;</div><div class="diff-added">+      return null;</div><div>     }</div><div>     class B extends React.Component {</div><div class="diff-removed">-      UNSAFE_componentWillMount() {</div><div class="diff-removed">-        setState(1);</div><div class="diff-removed">-      }</div><div class="diff-removed">-      render() {</div><div class="diff-added">+      render() {</div><div class="diff-added">+        ref(c => c + 1);</div><div>         return null;</div><div>       }</div><div>     }</div><div class="diff-info">@@ -1282,132 +1019,58 @@         </div></div><div>       );</div><div>     }</div><div class="diff-removed">-    const container = document.createElement('div');</div><div class="diff-removed">-    const root = ReactDOMClient.createRoot(container);</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      root.render(<Parent />);</div><div class="diff-removed">-    });</div><div class="diff-removed">-</div><div class="diff-removed">-    expect(ref.textContent).toBe('1');</div><div class="diff-removed">-  });</div><div class="diff-removed">-</div><div class="diff-removed">-  it('should not warn on updating function component from componentWillUpdate', async () => {</div><div class="diff-removed">-    let setState;</div><div class="diff-removed">-    let ref;</div><div class="diff-removed">-    function A() {</div><div class="diff-removed">-      const [state, _setState] = React.useState();</div><div class="diff-removed">-      setState = _setState;</div><div class="diff-removed">-      return <div ref={r => (ref = r)}>{state}</div>;</div><div class="diff-removed">-    }</div><div class="diff-removed">-    class B extends React.Component {</div><div class="diff-removed">-      UNSAFE_componentWillUpdate() {</div><div class="diff-removed">-        setState(1);</div><div class="diff-removed">-      }</div><div class="diff-removed">-      render() {</div><div class="diff-removed">-        return null;</div><div class="diff-removed">-      }</div><div class="diff-removed">-    }</div><div class="diff-removed">-    function Parent() {</div><div class="diff-removed">-      return (</div><div class="diff-removed">-        <div></div><div class="diff-removed">-          <A /></div><div class="diff-removed">-          <B /></div><div class="diff-removed">-        </div></div><div class="diff-removed">-      );</div><div class="diff-removed">-    }</div><div class="diff-removed">-    const container = document.createElement('div');</div><div class="diff-removed">-    const root = ReactDOMClient.createRoot(container);</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      root.render(<Parent />);</div><div class="diff-removed">-    });</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      root.render(<Parent />);</div><div class="diff-removed">-    });</div><div class="diff-removed">-</div><div class="diff-removed">-    expect(ref.textContent).toBe('1');</div><div class="diff-removed">-  });</div><div class="diff-removed">-</div><div class="diff-removed">-  it('should not warn on updating function component from componentWillReceiveProps', async () => {</div><div class="diff-removed">-    let setState;</div><div class="diff-removed">-    let ref;</div><div class="diff-removed">-    function A() {</div><div class="diff-removed">-      const [state, _setState] = React.useState();</div><div class="diff-removed">-      setState = _setState;</div><div class="diff-removed">-      return <div ref={r => (ref = r)}>{state}</div>;</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    class B extends React.Component {</div><div class="diff-removed">-      UNSAFE_componentWillReceiveProps() {</div><div class="diff-removed">-        setState(1);</div><div class="diff-removed">-      }</div><div class="diff-removed">-      render() {</div><div class="diff-removed">-        return null;</div><div class="diff-removed">-      }</div><div class="diff-removed">-    }</div><div class="diff-removed">-    function Parent() {</div><div class="diff-removed">-      return (</div><div class="diff-removed">-        <div></div><div class="diff-removed">-          <A /></div><div class="diff-removed">-          <B /></div><div class="diff-removed">-        </div></div><div class="diff-removed">-      );</div><div class="diff-removed">-    }</div><div class="diff-removed">-    const container = document.createElement('div');</div><div class="diff-removed">-    const root = ReactDOMClient.createRoot(container);</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      root.render(<Parent />);</div><div class="diff-removed">-    });</div><div class="diff-removed">-    await act(() => {</div><div class="diff-removed">-      root.render(<Parent />);</div><div class="diff-removed">-    });</div><div class="diff-removed">-</div><div class="diff-removed">-    expect(ref.textContent).toBe('1');</div><div class="diff-removed">-  });</div><div class="diff-removed">-</div><div class="diff-removed">-  it('should warn on updating function component from render', () => {</div><div class="diff-removed">-    let setState;</div><div class="diff-removed">-    let ref;</div><div class="diff-removed">-    function A() {</div><div class="diff-removed">-      const [state, _setState] = React.useState(0);</div><div class="diff-removed">-      setState = _setState;</div><div class="diff-removed">-      return <div ref={r => (ref = r)}>{state}</div>;</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    class B extends React.Component {</div><div class="diff-removed">-      render() {</div><div class="diff-removed">-        setState(c => c + 1);</div><div class="diff-removed">-        return null;</div><div class="diff-removed">-      }</div><div class="diff-removed">-    }</div><div class="diff-removed">-    function Parent() {</div><div class="diff-removed">-      return (</div><div class="diff-removed">-        <div></div><div class="diff-removed">-          <A /></div><div class="diff-removed">-          <B /></div><div class="diff-removed">-        </div></div><div class="diff-removed">-      );</div><div class="diff-removed">-    }</div><div class="diff-removed">-    const container = document.createElement('div');</div><div class="diff-removed">-    const root = ReactDOMClient.createRoot(container);</div><div class="diff-added">+    const root = ReactDOMClient.createRoot(document.createElement('div'));</div><div>     ReactDOM.flushSync(() => {</div><div>       root.render(<Parent />);</div><div>     });</div><div>     assertConsoleErrorDev([</div><div>       'Cannot update a component (`A`) while rendering a different component (`B`). ' +</div><div class="diff-removed">-        'To locate the bad setState() call inside `B`, ' +</div><div class="diff-removed">-        'follow the stack trace as described in https://react.dev/link/setstate-in-render\n' +</div><div class="diff-added">+        'To locate the bad setState() call inside `B`, follow the stack trace as described in ' +</div><div class="diff-added">+        'https://react.dev/link/setstate-in-render\n' +</div><div>         '    in Parent (at **)',</div><div>     ]);</div><div class="diff-removed">-</div><div class="diff-removed">-    // We error, but still update the state.</div><div class="diff-removed">-    expect(ref.textContent).toBe('1');</div><div class="diff-removed">-</div><div>     // Dedupe.</div><div>     ReactDOM.flushSync(() => {</div><div>       root.render(<Parent />);</div><div>     });</div><div class="diff-removed">-</div><div class="diff-removed">-    // We error, but still update the state.</div><div class="diff-removed">-    expect(ref.textContent).toBe('2');</div><div class="diff-added">+  });</div><div class="diff-added">+</div><div class="diff-added">+  it('should warn about reassigning this.props while rendering', async () => {</div><div class="diff-added">+    class Bad extends React.Component {</div><div class="diff-added">+      render() {</div><div class="diff-added">+        this.props = {...this.props};</div><div class="diff-added">+        return null;</div><div class="diff-added">+      }</div><div class="diff-added">+    }</div><div class="diff-added">+    const root = ReactDOMClient.createRoot(document.createElement('div'));</div><div class="diff-added">+    await act(() => {</div><div class="diff-added">+      root.render(<Bad foo="bar" />);</div><div class="diff-added">+    });</div><div class="diff-added">+    assertConsoleErrorDev([</div><div class="diff-added">+      'It looks like Bad is reassigning its own `this.props` while rendering. ' +</div><div class="diff-added">+        'This is not supported and can lead to confusing bugs.\n' +</div><div class="diff-added">+        '    in Bad (at **)',</div><div class="diff-added">+    ]);</div><div class="diff-added">+  });</div><div class="diff-added">+</div><div class="diff-added">+  it('should warn about reassigning this.props in constructor', async () => {</div><div class="diff-added">+    class Bad extends React.Component {</div><div class="diff-added">+      constructor(props) {</div><div class="diff-added">+        super(props);</div><div class="diff-added">+        this.props = {foo: 'baz'};</div><div class="diff-added">+      }</div><div class="diff-added">+      render() {</div><div class="diff-added">+        return null;</div><div class="diff-added">+      }</div><div class="diff-added">+    }</div><div class="diff-added">+    const root = ReactDOMClient.createRoot(document.createElement('div'));</div><div class="diff-added">+    await act(() => {</div><div class="diff-added">+      root.render(<Bad foo="bar" />);</div><div class="diff-added">+    });</div><div class="diff-added">+    assertConsoleErrorDev([</div><div class="diff-added">+      'It looks like Bad is reassigning its own `this.props` in the constructor. ' +</div><div class="diff-added">+        'This is not supported and can lead to confusing bugs.\n' +</div><div class="diff-added">+        '    in Bad (at **)',</div><div class="diff-added">+    ]);</div><div>   });</div><div> });</div></pre>
                </div>
            </div>
        </section>
    </main>
    <footer>
        <p>LoCoDiff-bench - <a href="https://github.com/AbanteAI/LoCoDiff-bench">GitHub Repository</a></p>
    </footer>
</body>
</html>
    