<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case: packages/tldraw/src/lib/shapes/arrow/ArrowShapeUtil.tsx - o4-mini-medium</title>
    <link rel="stylesheet" href="../../styles.css">
</head>
<body>
    <header>
        <h1>Case: packages/tldraw/src/lib/shapes/arrow/ArrowShapeUtil.tsx</h1>
        <p><a href="../../models/openai_o4-mini.html">‚Üê Back to o4-mini-medium Cases</a> | <a href="../../index.html">Home</a></p>
    </header>
    <main>
        <section class="case-details">
            <div class="case-info">
                <h2>Benchmark Case Information</h2>
                <p><strong>Model:</strong> o4-mini-medium</p>
                <p><strong>Status:</strong> <span class="failure">Failure</span></p>
                <p><strong>Prompt Tokens:</strong> 97521</p>
                <p><strong>Output Tokens:</strong> N/A</p>
                <p><strong>Native Prompt Tokens:</strong> 97815</p>
                <p><strong>Native Completion Tokens:</strong> 7541</p>
                <p><strong>Native Tokens Reasoning:</strong> 1280</p>
                <p><strong>Native Finish Reason:</strong> stop</p>
                <p><strong>Runtime:</strong> N/As</p>
                <p><strong>Cost:</strong> $0.007038845</p>
            </div>
            
            <div class="content-links">
                <h2>View Content</h2>
                <ul>
                    <li><a href="../../content/openai_o4-mini/tldraw_packages_tldraw_src_lib_shapes_arrow_ArrowShapeUtil.tsx/prompt.html" class="content-link">View Prompt</a></li>
                    <li><a href="../../content/openai_o4-mini/tldraw_packages_tldraw_src_lib_shapes_arrow_ArrowShapeUtil.tsx/expected.html" class="content-link">View Expected Output</a></li>
                    <li><a href="../../content/openai_o4-mini/tldraw_packages_tldraw_src_lib_shapes_arrow_ArrowShapeUtil.tsx/actual.html" class="content-link">View Actual Output</a></li>
                </ul>
            </div>
            
            <div class="diff-section">
                <h2>Diff (Expected vs Actual)</h2>
                <div id="diff-output">
                    <pre class="diff"><div class="diff-header">--- tldraw_packages_tldraw_src_lib_shapes_arrow_ArrowShapeUtil.tsx_expectedoutput.txt (expected)+++ tldraw_packages_tldraw_src_lib_shapes_arrow_ArrowShapeUtil.tsx_extracted.txt (actual)@@ -1,43 +1,42 @@ import {</div><div class="diff-removed">-	Arc2d,</div><div class="diff-removed">-	Box,</div><div class="diff-removed">-	EMPTY_ARRAY,</div><div class="diff-removed">-	Edge2d,</div><div class="diff-removed">-	Editor,</div><div class="diff-removed">-	Geometry2d,</div><div class="diff-removed">-	Group2d,</div><div class="diff-removed">-	Rectangle2d,</div><div class="diff-removed">-	SVGContainer,</div><div class="diff-removed">-	ShapeUtil,</div><div class="diff-removed">-	SvgExportContext,</div><div class="diff-removed">-	TLArrowBinding,</div><div class="diff-removed">-	TLArrowShape,</div><div class="diff-removed">-	TLArrowShapeProps,</div><div class="diff-removed">-	TLFontFace,</div><div class="diff-removed">-	TLHandle,</div><div class="diff-removed">-	TLHandleDragInfo,</div><div class="diff-removed">-	TLResizeInfo,</div><div class="diff-removed">-	TLShapePartial,</div><div class="diff-removed">-	TLShapeUtilCanBeLaidOutOpts,</div><div class="diff-removed">-	TLShapeUtilCanBindOpts,</div><div class="diff-removed">-	TLShapeUtilCanvasSvgDef,</div><div class="diff-removed">-	Vec,</div><div class="diff-removed">-	WeakCache,</div><div class="diff-removed">-	arrowShapeMigrations,</div><div class="diff-removed">-	arrowShapeProps,</div><div class="diff-removed">-	debugFlags,</div><div class="diff-removed">-	getDefaultColorTheme,</div><div class="diff-removed">-	getPerfectDashProps,</div><div class="diff-removed">-	lerp,</div><div class="diff-removed">-	mapObjectMapValues,</div><div class="diff-removed">-	maybeSnapToGrid,</div><div class="diff-removed">-	structuredClone,</div><div class="diff-removed">-	toDomPrecision,</div><div class="diff-removed">-	track,</div><div class="diff-removed">-	useEditor,</div><div class="diff-removed">-	useIsEditing,</div><div class="diff-removed">-	useSharedSafeId,</div><div class="diff-removed">-	useValue,</div><div class="diff-added">+  Arc2d,</div><div class="diff-added">+  Box,</div><div class="diff-added">+  EMPTY_ARRAY,</div><div class="diff-added">+  Edge2d,</div><div class="diff-added">+  Editor,</div><div class="diff-added">+  Geometry2d,</div><div class="diff-added">+  Group2d,</div><div class="diff-added">+  Rectangle2d,</div><div class="diff-added">+  SVGContainer,</div><div class="diff-added">+  ShapeUtil,</div><div class="diff-added">+  SvgExportContext,</div><div class="diff-added">+  TLArrowBinding,</div><div class="diff-added">+  TLArrowShape,</div><div class="diff-added">+  TLArrowShapeProps,</div><div class="diff-added">+  TLHandle,</div><div class="diff-added">+  TLHandleDragInfo,</div><div class="diff-added">+  TLResizeInfo,</div><div class="diff-added">+  TLShapePartial,</div><div class="diff-added">+  TLShapeUtilCanBindOpts,</div><div class="diff-added">+  TLShapeUtilCanvasSvgDef,</div><div class="diff-added">+  TLShapeUtilCanBeLaidOutOpts,</div><div class="diff-added">+  Vec,</div><div class="diff-added">+  WeakCache,</div><div class="diff-added">+  arrowShapeMigrations,</div><div class="diff-added">+  arrowShapeProps,</div><div class="diff-added">+  debugFlags,</div><div class="diff-added">+  getDefaultColorTheme,</div><div class="diff-added">+  getPerfectDashProps,</div><div class="diff-added">+  lerp,</div><div class="diff-added">+  mapObjectMapValues,</div><div class="diff-added">+  maybeSnapToGrid,</div><div class="diff-added">+  structuredClone,</div><div class="diff-added">+  toDomPrecision,</div><div class="diff-added">+  track,</div><div class="diff-added">+  useEditor,</div><div class="diff-added">+  useIsEditing,</div><div class="diff-added">+  useSharedSafeId,</div><div class="diff-added">+  useValue,</div><div> } from '@tldraw/editor'</div><div> import React from 'react'</div><div> import { updateArrowTerminal } from '../../bindings/arrow/ArrowBindingUtil'</div><div class="diff-info">@@ -46,1006 +45,641 @@ import { SvgTextLabel } from '../shared/SvgTextLabel'</div><div> import { ARROW_LABEL_PADDING, STROKE_SIZES, TEXT_PROPS } from '../shared/default-shape-constants'</div><div> import { DefaultFontFaces } from '../shared/defaultFonts'</div><div class="diff-removed">-import { getFillDefForCanvas, getFillDefForExport } from '../shared/defaultStyleDefs'</div><div class="diff-added">+import {</div><div class="diff-added">+  getFillDefForCanvas,</div><div class="diff-added">+  getFillDefForExport,</div><div class="diff-added">+} from '../shared/defaultStyleDefs'</div><div> import { useDefaultColorTheme } from '../shared/useDefaultColorTheme'</div><div> import { getArrowLabelFontSize, getArrowLabelPosition } from './arrowLabel'</div><div> import { getArrowheadPathForType } from './arrowheads'</div><div> import {</div><div class="diff-removed">-	getCurvedArrowHandlePath,</div><div class="diff-removed">-	getSolidCurvedArrowPath,</div><div class="diff-removed">-	getSolidStraightArrowPath,</div><div class="diff-removed">-	getStraightArrowHandlePath,</div><div class="diff-added">+  getCurvedArrowHandlePath,</div><div class="diff-added">+  getSolidCurvedArrowPath,</div><div class="diff-added">+  getSolidStraightArrowPath,</div><div class="diff-added">+  getStraightArrowHandlePath,</div><div> } from './arrowpaths'</div><div class="diff-removed">-import {</div><div class="diff-removed">-	TLArrowBindings,</div><div class="diff-removed">-	createOrUpdateArrowBinding,</div><div class="diff-removed">-	getArrowBindings,</div><div class="diff-removed">-	getArrowInfo,</div><div class="diff-removed">-	getArrowTerminalsInArrowSpace,</div><div class="diff-removed">-	removeArrowBinding,</div><div class="diff-removed">-} from './shared'</div><div> </div><div> enum ARROW_HANDLES {</div><div class="diff-removed">-	START = 'start',</div><div class="diff-removed">-	MIDDLE = 'middle',</div><div class="diff-removed">-	END = 'end',</div><div class="diff-added">+  START = 'start',</div><div class="diff-added">+  MIDDLE = 'middle',</div><div class="diff-added">+  END = 'end',</div><div> }</div><div> </div><div> /** @public */</div><div> export class ArrowShapeUtil extends ShapeUtil<TLArrowShape> {</div><div class="diff-removed">-	static override type = 'arrow' as const</div><div class="diff-removed">-	static override props = arrowShapeProps</div><div class="diff-removed">-	static override migrations = arrowShapeMigrations</div><div class="diff-removed">-</div><div class="diff-removed">-	override canEdit() {</div><div class="diff-removed">-		return true</div><div class="diff-removed">-	}</div><div class="diff-removed">-	override canBind({ toShapeType }: TLShapeUtilCanBindOpts<TLArrowShape>): boolean {</div><div class="diff-removed">-		// bindings can go from arrows to shapes, but not from shapes to arrows</div><div class="diff-removed">-		return toShapeType !== 'arrow'</div><div class="diff-removed">-	}</div><div class="diff-removed">-	override canSnap() {</div><div class="diff-removed">-		return false</div><div class="diff-removed">-	}</div><div class="diff-removed">-	override canTabTo(shape: TLArrowShape) {</div><div class="diff-removed">-		const bindings = getArrowBindings(this.editor, shape)</div><div class="diff-removed">-		return !!(bindings.start || bindings.end || shape.props.text)</div><div class="diff-removed">-	}</div><div class="diff-removed">-	override hideResizeHandles() {</div><div class="diff-removed">-		return true</div><div class="diff-removed">-	}</div><div class="diff-removed">-	override hideRotateHandle() {</div><div class="diff-removed">-		return true</div><div class="diff-removed">-	}</div><div class="diff-removed">-	override hideSelectionBoundsBg() {</div><div class="diff-removed">-		return true</div><div class="diff-removed">-	}</div><div class="diff-removed">-	override hideSelectionBoundsFg() {</div><div class="diff-removed">-		return true</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	override canBeLaidOut(shape: TLArrowShape, info: TLShapeUtilCanBeLaidOutOpts) {</div><div class="diff-removed">-		if (info.type === 'flip') {</div><div class="diff-removed">-			// If we don't have this then the flip will be non-idempotent; that is, the flip will be multipotent, varipotent, or perhaps even omni-potent... and we can't have that</div><div class="diff-removed">-			const bindings = getArrowBindings(this.editor, shape)</div><div class="diff-removed">-			const { start, end } = bindings</div><div class="diff-removed">-			const { shapes = [] } = info</div><div class="diff-removed">-			if (start && !shapes.find((s) => s.id === start.toId)) return false</div><div class="diff-removed">-			if (end && !shapes.find((s) => s.id === end.toId)) return false</div><div class="diff-removed">-		}</div><div class="diff-removed">-		return true</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	override getFontFaces(shape: TLArrowShape): TLFontFace[] {</div><div class="diff-removed">-		if (!shape.props.text) return EMPTY_ARRAY</div><div class="diff-removed">-		return [DefaultFontFaces[`tldraw_${shape.props.font}`].normal.normal]</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	override getDefaultProps(): TLArrowShape['props'] {</div><div class="diff-removed">-		return {</div><div class="diff-removed">-			dash: 'draw',</div><div class="diff-removed">-			size: 'm',</div><div class="diff-removed">-			fill: 'none',</div><div class="diff-removed">-			color: 'black',</div><div class="diff-removed">-			labelColor: 'black',</div><div class="diff-removed">-			bend: 0,</div><div class="diff-removed">-			start: { x: 0, y: 0 },</div><div class="diff-removed">-			end: { x: 2, y: 0 },</div><div class="diff-removed">-			arrowheadStart: 'none',</div><div class="diff-removed">-			arrowheadEnd: 'arrow',</div><div class="diff-removed">-			text: '',</div><div class="diff-removed">-			labelPosition: 0.5,</div><div class="diff-removed">-			font: 'draw',</div><div class="diff-removed">-			scale: 1,</div><div class="diff-removed">-		}</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	getGeometry(shape: TLArrowShape) {</div><div class="diff-removed">-		const info = getArrowInfo(this.editor, shape)!</div><div class="diff-removed">-</div><div class="diff-removed">-		const debugGeom: Geometry2d[] = []</div><div class="diff-removed">-</div><div class="diff-removed">-		const bodyGeom = info.isStraight</div><div class="diff-removed">-			? new Edge2d({</div><div class="diff-removed">-					start: Vec.From(info.start.point),</div><div class="diff-removed">-					end: Vec.From(info.end.point),</div><div class="diff-removed">-				})</div><div class="diff-removed">-			: new Arc2d({</div><div class="diff-removed">-					center: Vec.Cast(info.handleArc.center),</div><div class="diff-removed">-					start: Vec.Cast(info.start.point),</div><div class="diff-removed">-					end: Vec.Cast(info.end.point),</div><div class="diff-removed">-					sweepFlag: info.bodyArc.sweepFlag,</div><div class="diff-removed">-					largeArcFlag: info.bodyArc.largeArcFlag,</div><div class="diff-removed">-				})</div><div class="diff-removed">-</div><div class="diff-removed">-		let labelGeom</div><div class="diff-removed">-		if (shape.props.text.trim()) {</div><div class="diff-removed">-			const labelPosition = getArrowLabelPosition(this.editor, shape)</div><div class="diff-removed">-			if (debugFlags.debugGeometry.get()) debugGeom.push(...labelPosition.debugGeom)</div><div class="diff-removed">-			labelGeom = new Rectangle2d({</div><div class="diff-removed">-				x: labelPosition.box.x,</div><div class="diff-removed">-				y: labelPosition.box.y,</div><div class="diff-removed">-				width: labelPosition.box.w,</div><div class="diff-removed">-				height: labelPosition.box.h,</div><div class="diff-removed">-				isFilled: true,</div><div class="diff-removed">-				isLabel: true,</div><div class="diff-removed">-			})</div><div class="diff-removed">-		}</div><div class="diff-removed">-</div><div class="diff-removed">-		return new Group2d({</div><div class="diff-removed">-			children: [...(labelGeom ? [bodyGeom, labelGeom] : [bodyGeom]), ...debugGeom],</div><div class="diff-removed">-		})</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	override getHandles(shape: TLArrowShape): TLHandle[] {</div><div class="diff-removed">-		const info = getArrowInfo(this.editor, shape)!</div><div class="diff-removed">-</div><div class="diff-removed">-		return [</div><div class="diff-removed">-			{</div><div class="diff-removed">-				id: ARROW_HANDLES.START,</div><div class="diff-removed">-				type: 'vertex',</div><div class="diff-removed">-				index: 'a0',</div><div class="diff-removed">-				x: info.start.handle.x,</div><div class="diff-removed">-				y: info.start.handle.y,</div><div class="diff-removed">-			},</div><div class="diff-removed">-			{</div><div class="diff-removed">-				id: ARROW_HANDLES.MIDDLE,</div><div class="diff-removed">-				type: 'virtual',</div><div class="diff-removed">-				index: 'a2',</div><div class="diff-removed">-				x: info.middle.x,</div><div class="diff-removed">-				y: info.middle.y,</div><div class="diff-removed">-			},</div><div class="diff-removed">-			{</div><div class="diff-removed">-				id: ARROW_HANDLES.END,</div><div class="diff-removed">-				type: 'vertex',</div><div class="diff-removed">-				index: 'a3',</div><div class="diff-removed">-				x: info.end.handle.x,</div><div class="diff-removed">-				y: info.end.handle.y,</div><div class="diff-removed">-			},</div><div class="diff-removed">-		].filter(Boolean) as TLHandle[]</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	override getText(shape: TLArrowShape) {</div><div class="diff-removed">-		return shape.props.text</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	override onHandleDrag(</div><div class="diff-removed">-		shape: TLArrowShape,</div><div class="diff-removed">-		{ handle, isPrecise }: TLHandleDragInfo<TLArrowShape></div><div class="diff-removed">-	) {</div><div class="diff-removed">-		const handleId = handle.id as ARROW_HANDLES</div><div class="diff-removed">-		const bindings = getArrowBindings(this.editor, shape)</div><div class="diff-removed">-</div><div class="diff-removed">-		if (handleId === ARROW_HANDLES.MIDDLE) {</div><div class="diff-removed">-			// Bending the arrow...</div><div class="diff-removed">-			const { start, end } = getArrowTerminalsInArrowSpace(this.editor, shape, bindings)</div><div class="diff-removed">-</div><div class="diff-removed">-			const delta = Vec.Sub(end, start)</div><div class="diff-removed">-			const v = Vec.Per(delta)</div><div class="diff-removed">-</div><div class="diff-removed">-			const med = Vec.Med(end, start)</div><div class="diff-removed">-			const A = Vec.Sub(med, v)</div><div class="diff-removed">-			const B = Vec.Add(med, v)</div><div class="diff-removed">-</div><div class="diff-removed">-			const point = Vec.NearestPointOnLineSegment(A, B, handle, false)</div><div class="diff-removed">-			let bend = Vec.Dist(point, med)</div><div class="diff-removed">-			if (Vec.Clockwise(point, end, med)) bend *= -1</div><div class="diff-removed">-			return { id: shape.id, type: shape.type, props: { bend } }</div><div class="diff-removed">-		}</div><div class="diff-removed">-</div><div class="diff-removed">-		// Start or end, pointing the arrow...</div><div class="diff-removed">-</div><div class="diff-removed">-		const update: TLShapePartial<TLArrowShape> = { id: shape.id, type: 'arrow', props: {} }</div><div class="diff-removed">-</div><div class="diff-removed">-		const currentBinding = bindings[handleId]</div><div class="diff-removed">-</div><div class="diff-removed">-		const otherHandleId = handleId === ARROW_HANDLES.START ? ARROW_HANDLES.END : ARROW_HANDLES.START</div><div class="diff-removed">-		const otherBinding = bindings[otherHandleId]</div><div class="diff-removed">-</div><div class="diff-removed">-		if (this.editor.inputs.ctrlKey) {</div><div class="diff-removed">-			// todo: maybe double check that this isn't equal to the other handle too?</div><div class="diff-removed">-			// Skip binding</div><div class="diff-removed">-			removeArrowBinding(this.editor, shape, handleId)</div><div class="diff-removed">-</div><div class="diff-removed">-			update.props![handleId] = {</div><div class="diff-removed">-				x: handle.x,</div><div class="diff-removed">-				y: handle.y,</div><div class="diff-removed">-			}</div><div class="diff-removed">-			return update</div><div class="diff-removed">-		}</div><div class="diff-removed">-</div><div class="diff-removed">-		const point = this.editor.getShapePageTransform(shape.id)!.applyToPoint(handle)</div><div class="diff-removed">-</div><div class="diff-removed">-		const target = this.editor.getShapeAtPoint(point, {</div><div class="diff-removed">-			hitInside: true,</div><div class="diff-removed">-			hitFrameInside: true,</div><div class="diff-removed">-			margin: 0,</div><div class="diff-removed">-			filter: (targetShape) => {</div><div class="diff-removed">-				return (</div><div class="diff-removed">-					!targetShape.isLocked &&</div><div class="diff-removed">-					this.editor.canBindShapes({ fromShape: shape, toShape: targetShape, binding: 'arrow' })</div><div class="diff-removed">-				)</div><div class="diff-removed">-			},</div><div class="diff-removed">-		})</div><div class="diff-removed">-</div><div class="diff-removed">-		if (!target) {</div><div class="diff-removed">-			// todo: maybe double check that this isn't equal to the other handle too?</div><div class="diff-removed">-			removeArrowBinding(this.editor, shape, handleId)</div><div class="diff-removed">-			const newPoint = maybeSnapToGrid(new Vec(handle.x, handle.y), this.editor)</div><div class="diff-removed">-			update.props![handleId] = {</div><div class="diff-removed">-				x: newPoint.x,</div><div class="diff-removed">-				y: newPoint.y,</div><div class="diff-removed">-			}</div><div class="diff-removed">-			return update</div><div class="diff-removed">-		}</div><div class="diff-removed">-</div><div class="diff-removed">-		// we've got a target! the handle is being dragged over a shape, bind to it</div><div class="diff-removed">-</div><div class="diff-removed">-		const targetGeometry = this.editor.getShapeGeometry(target)</div><div class="diff-removed">-		const targetBounds = Box.ZeroFix(targetGeometry.bounds)</div><div class="diff-removed">-		const pageTransform = this.editor.getShapePageTransform(update.id)!</div><div class="diff-removed">-		const pointInPageSpace = pageTransform.applyToPoint(handle)</div><div class="diff-removed">-		const pointInTargetSpace = this.editor.getPointInShapeSpace(target, pointInPageSpace)</div><div class="diff-removed">-</div><div class="diff-removed">-		let precise = isPrecise</div><div class="diff-removed">-</div><div class="diff-removed">-		if (!precise) {</div><div class="diff-removed">-			// If we're switching to a new bound shape, then precise only if moving slowly</div><div class="diff-removed">-			if (!currentBinding || (currentBinding && target.id !== currentBinding.toId)) {</div><div class="diff-removed">-				precise = this.editor.inputs.pointerVelocity.len() < 0.5</div><div class="diff-removed">-			}</div><div class="diff-removed">-		}</div><div class="diff-removed">-</div><div class="diff-removed">-		if (!isPrecise) {</div><div class="diff-removed">-			if (!targetGeometry.isClosed) {</div><div class="diff-removed">-				precise = true</div><div class="diff-removed">-			}</div><div class="diff-removed">-</div><div class="diff-removed">-			// Double check that we're not going to be doing an imprecise snap on</div><div class="diff-removed">-			// the same shape twice, as this would result in a zero length line</div><div class="diff-removed">-			if (otherBinding && target.id === otherBinding.toId && otherBinding.props.isPrecise) {</div><div class="diff-removed">-				precise = true</div><div class="diff-removed">-			}</div><div class="diff-removed">-		}</div><div class="diff-removed">-</div><div class="diff-removed">-		const normalizedAnchor = {</div><div class="diff-removed">-			x: (pointInTargetSpace.x - targetBounds.minX) / targetBounds.width,</div><div class="diff-removed">-			y: (pointInTargetSpace.y - targetBounds.minY) / targetBounds.height,</div><div class="diff-removed">-		}</div><div class="diff-removed">-</div><div class="diff-removed">-		if (precise) {</div><div class="diff-removed">-			// Turn off precision if we're within a certain distance to the center of the shape.</div><div class="diff-removed">-			// Funky math but we want the snap distance to be 4 at the minimum and either</div><div class="diff-removed">-			// 16 or 15% of the smaller dimension of the target shape, whichever is smaller</div><div class="diff-removed">-			if (</div><div class="diff-removed">-				Vec.Dist(pointInTargetSpace, targetBounds.center) <</div><div class="diff-removed">-				Math.max(4, Math.min(Math.min(targetBounds.width, targetBounds.height) * 0.15, 16)) /</div><div class="diff-removed">-					this.editor.getZoomLevel()</div><div class="diff-removed">-			) {</div><div class="diff-removed">-				normalizedAnchor.x = 0.5</div><div class="diff-removed">-				normalizedAnchor.y = 0.5</div><div class="diff-removed">-			}</div><div class="diff-removed">-		}</div><div class="diff-removed">-</div><div class="diff-removed">-		const b = {</div><div class="diff-removed">-			terminal: handleId,</div><div class="diff-removed">-			normalizedAnchor,</div><div class="diff-removed">-			isPrecise: precise,</div><div class="diff-removed">-			isExact: this.editor.inputs.altKey,</div><div class="diff-removed">-		}</div><div class="diff-removed">-</div><div class="diff-removed">-		createOrUpdateArrowBinding(this.editor, shape, target.id, b)</div><div class="diff-removed">-</div><div class="diff-removed">-		this.editor.setHintingShapes([target.id])</div><div class="diff-removed">-</div><div class="diff-removed">-		const newBindings = getArrowBindings(this.editor, shape)</div><div class="diff-removed">-		if (newBindings.start && newBindings.end && newBindings.start.toId === newBindings.end.toId) {</div><div class="diff-removed">-			if (</div><div class="diff-removed">-				Vec.Equals(newBindings.start.props.normalizedAnchor, newBindings.end.props.normalizedAnchor)</div><div class="diff-removed">-			) {</div><div class="diff-removed">-				createOrUpdateArrowBinding(this.editor, shape, newBindings.end.toId, {</div><div class="diff-removed">-					...newBindings.end.props,</div><div class="diff-removed">-					normalizedAnchor: {</div><div class="diff-removed">-						x: newBindings.end.props.normalizedAnchor.x + 0.05,</div><div class="diff-removed">-						y: newBindings.end.props.normalizedAnchor.y,</div><div class="diff-removed">-					},</div><div class="diff-removed">-				})</div><div class="diff-removed">-			}</div><div class="diff-removed">-		}</div><div class="diff-removed">-</div><div class="diff-removed">-		return update</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	override onTranslateStart(shape: TLArrowShape) {</div><div class="diff-removed">-		const bindings = getArrowBindings(this.editor, shape)</div><div class="diff-removed">-</div><div class="diff-removed">-		const terminalsInArrowSpace = getArrowTerminalsInArrowSpace(this.editor, shape, bindings)</div><div class="diff-removed">-		const shapePageTransform = this.editor.getShapePageTransform(shape.id)!</div><div class="diff-removed">-</div><div class="diff-removed">-		// If at least one bound shape is in the selection, do nothing;</div><div class="diff-removed">-		// If no bound shapes are in the selection, unbind any bound shapes</div><div class="diff-removed">-</div><div class="diff-removed">-		const selectedShapeIds = this.editor.getSelectedShapeIds()</div><div class="diff-removed">-</div><div class="diff-removed">-		if (</div><div class="diff-removed">-			(bindings.start &&</div><div class="diff-removed">-				(selectedShapeIds.includes(bindings.start.toId) ||</div><div class="diff-removed">-					this.editor.isAncestorSelected(bindings.start.toId))) ||</div><div class="diff-removed">-			(bindings.end &&</div><div class="diff-removed">-				(selectedShapeIds.includes(bindings.end.toId) ||</div><div class="diff-removed">-					this.editor.isAncestorSelected(bindings.end.toId)))</div><div class="diff-removed">-		) {</div><div class="diff-removed">-			return</div><div class="diff-removed">-		}</div><div class="diff-removed">-</div><div class="diff-removed">-		// When we start translating shapes, record where their bindings were in page space so we</div><div class="diff-removed">-		// can maintain them as we translate the arrow</div><div class="diff-removed">-		shapeAtTranslationStart.set(shape, {</div><div class="diff-removed">-			pagePosition: shapePageTransform.applyToPoint(shape),</div><div class="diff-removed">-			terminalBindings: mapObjectMapValues(terminalsInArrowSpace, (terminalName, point) => {</div><div class="diff-removed">-				const binding = bindings[terminalName]</div><div class="diff-removed">-				if (!binding) return null</div><div class="diff-removed">-				return {</div><div class="diff-removed">-					binding,</div><div class="diff-removed">-					shapePosition: point,</div><div class="diff-removed">-					pagePosition: shapePageTransform.applyToPoint(point),</div><div class="diff-removed">-				}</div><div class="diff-removed">-			}),</div><div class="diff-removed">-		})</div><div class="diff-removed">-</div><div class="diff-removed">-		// update arrow terminal bindings eagerly to make sure the arrows unbind nicely when translating</div><div class="diff-removed">-		if (bindings.start) {</div><div class="diff-removed">-			updateArrowTerminal({</div><div class="diff-removed">-				editor: this.editor,</div><div class="diff-removed">-				arrow: shape,</div><div class="diff-removed">-				terminal: 'start',</div><div class="diff-removed">-				useHandle: true,</div><div class="diff-removed">-			})</div><div class="diff-removed">-			shape = this.editor.getShape(shape.id) as TLArrowShape</div><div class="diff-removed">-		}</div><div class="diff-removed">-		if (bindings.end) {</div><div class="diff-removed">-			updateArrowTerminal({</div><div class="diff-removed">-				editor: this.editor,</div><div class="diff-removed">-				arrow: shape,</div><div class="diff-removed">-				terminal: 'end',</div><div class="diff-removed">-				useHandle: true,</div><div class="diff-removed">-			})</div><div class="diff-removed">-		}</div><div class="diff-removed">-</div><div class="diff-removed">-		for (const handleName of [ARROW_HANDLES.START, ARROW_HANDLES.END] as const) {</div><div class="diff-removed">-			const binding = bindings[handleName]</div><div class="diff-removed">-			if (!binding) continue</div><div class="diff-removed">-</div><div class="diff-removed">-			this.editor.updateBinding({</div><div class="diff-removed">-				...binding,</div><div class="diff-removed">-				props: { ...binding.props, isPrecise: true },</div><div class="diff-removed">-			})</div><div class="diff-removed">-		}</div><div class="diff-removed">-</div><div class="diff-removed">-		return</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	override onTranslate(initialShape: TLArrowShape, shape: TLArrowShape) {</div><div class="diff-removed">-		const atTranslationStart = shapeAtTranslationStart.get(initialShape)</div><div class="diff-removed">-		if (!atTranslationStart) return</div><div class="diff-removed">-</div><div class="diff-removed">-		const shapePageTransform = this.editor.getShapePageTransform(shape.id)!</div><div class="diff-removed">-		const pageDelta = Vec.Sub(</div><div class="diff-removed">-			shapePageTransform.applyToPoint(shape),</div><div class="diff-removed">-			atTranslationStart.pagePosition</div><div class="diff-removed">-		)</div><div class="diff-removed">-</div><div class="diff-removed">-		for (const terminalBinding of Object.values(atTranslationStart.terminalBindings)) {</div><div class="diff-removed">-			if (!terminalBinding) continue</div><div class="diff-removed">-</div><div class="diff-removed">-			const newPagePoint = Vec.Add(terminalBinding.pagePosition, Vec.Mul(pageDelta, 0.5))</div><div class="diff-removed">-			const newTarget = this.editor.getShapeAtPoint(newPagePoint, {</div><div class="diff-removed">-				hitInside: true,</div><div class="diff-removed">-				hitFrameInside: true,</div><div class="diff-removed">-				margin: 0,</div><div class="diff-removed">-				filter: (targetShape) => {</div><div class="diff-removed">-					return (</div><div class="diff-removed">-						!targetShape.isLocked &&</div><div class="diff-removed">-						this.editor.canBindShapes({ fromShape: shape, toShape: targetShape, binding: 'arrow' })</div><div class="diff-removed">-					)</div><div class="diff-removed">-				},</div><div class="diff-removed">-			})</div><div class="diff-removed">-</div><div class="diff-removed">-			if (newTarget?.id === terminalBinding.binding.toId) {</div><div class="diff-removed">-				const targetBounds = Box.ZeroFix(this.editor.getShapeGeometry(newTarget).bounds)</div><div class="diff-removed">-				const pointInTargetSpace = this.editor.getPointInShapeSpace(newTarget, newPagePoint)</div><div class="diff-removed">-				const normalizedAnchor = {</div><div class="diff-removed">-					x: (pointInTargetSpace.x - targetBounds.minX) / targetBounds.width,</div><div class="diff-removed">-					y: (pointInTargetSpace.y - targetBounds.minY) / targetBounds.height,</div><div class="diff-removed">-				}</div><div class="diff-removed">-				createOrUpdateArrowBinding(this.editor, shape, newTarget.id, {</div><div class="diff-removed">-					...terminalBinding.binding.props,</div><div class="diff-removed">-					normalizedAnchor,</div><div class="diff-removed">-					isPrecise: true,</div><div class="diff-removed">-				})</div><div class="diff-removed">-			} else {</div><div class="diff-removed">-				removeArrowBinding(this.editor, shape, terminalBinding.binding.props.terminal)</div><div class="diff-removed">-			}</div><div class="diff-removed">-		}</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	private readonly _resizeInitialBindings = new WeakCache<TLArrowShape, TLArrowBindings>()</div><div class="diff-removed">-</div><div class="diff-removed">-	override onResize(shape: TLArrowShape, info: TLResizeInfo<TLArrowShape>) {</div><div class="diff-removed">-		const { scaleX, scaleY } = info</div><div class="diff-removed">-</div><div class="diff-removed">-		const bindings = this._resizeInitialBindings.get(shape, () =></div><div class="diff-removed">-			getArrowBindings(this.editor, shape)</div><div class="diff-removed">-		)</div><div class="diff-removed">-		const terminals = getArrowTerminalsInArrowSpace(this.editor, shape, bindings)</div><div class="diff-removed">-</div><div class="diff-removed">-		const { start, end } = structuredClone<TLArrowShape['props']>(shape.props)</div><div class="diff-removed">-		let { bend } = shape.props</div><div class="diff-removed">-</div><div class="diff-removed">-		// Rescale start handle if it's not bound to a shape</div><div class="diff-removed">-		if (!bindings.start) {</div><div class="diff-removed">-			start.x = terminals.start.x * scaleX</div><div class="diff-removed">-			start.y = terminals.start.y * scaleY</div><div class="diff-removed">-		}</div><div class="diff-removed">-</div><div class="diff-removed">-		// Rescale end handle if it's not bound to a shape</div><div class="diff-removed">-		if (!bindings.end) {</div><div class="diff-removed">-			end.x = terminals.end.x * scaleX</div><div class="diff-removed">-			end.y = terminals.end.y * scaleY</div><div class="diff-removed">-		}</div><div class="diff-removed">-</div><div class="diff-removed">-		// todo: we should only change the normalized anchor positions</div><div class="diff-removed">-		// of the shape's handles if the bound shape is also being resized</div><div class="diff-removed">-</div><div class="diff-removed">-		const mx = Math.abs(scaleX)</div><div class="diff-removed">-		const my = Math.abs(scaleY)</div><div class="diff-removed">-</div><div class="diff-removed">-		const startNormalizedAnchor = bindings?.start</div><div class="diff-removed">-			? Vec.From(bindings.start.props.normalizedAnchor)</div><div class="diff-removed">-			: null</div><div class="diff-removed">-		const endNormalizedAnchor = bindings?.end ? Vec.From(bindings.end.props.normalizedAnchor) : null</div><div class="diff-removed">-</div><div class="diff-removed">-		if (scaleX < 0 && scaleY >= 0) {</div><div class="diff-removed">-			if (bend !== 0) {</div><div class="diff-removed">-				bend *= -1</div><div class="diff-removed">-				bend *= Math.max(mx, my)</div><div class="diff-removed">-			}</div><div class="diff-removed">-</div><div class="diff-removed">-			if (startNormalizedAnchor) {</div><div class="diff-removed">-				startNormalizedAnchor.x = 1 - startNormalizedAnchor.x</div><div class="diff-removed">-			}</div><div class="diff-removed">-</div><div class="diff-removed">-			if (endNormalizedAnchor) {</div><div class="diff-removed">-				endNormalizedAnchor.x = 1 - endNormalizedAnchor.x</div><div class="diff-removed">-			}</div><div class="diff-removed">-		} else if (scaleX >= 0 && scaleY < 0) {</div><div class="diff-removed">-			if (bend !== 0) {</div><div class="diff-removed">-				bend *= -1</div><div class="diff-removed">-				bend *= Math.max(mx, my)</div><div class="diff-removed">-			}</div><div class="diff-removed">-</div><div class="diff-removed">-			if (startNormalizedAnchor) {</div><div class="diff-removed">-				startNormalizedAnchor.y = 1 - startNormalizedAnchor.y</div><div class="diff-removed">-			}</div><div class="diff-removed">-</div><div class="diff-removed">-			if (endNormalizedAnchor) {</div><div class="diff-removed">-				endNormalizedAnchor.y = 1 - endNormalizedAnchor.y</div><div class="diff-removed">-			}</div><div class="diff-removed">-		} else if (scaleX >= 0 && scaleY >= 0) {</div><div class="diff-removed">-			if (bend !== 0) {</div><div class="diff-removed">-				bend *= Math.max(mx, my)</div><div class="diff-removed">-			}</div><div class="diff-removed">-		} else if (scaleX < 0 && scaleY < 0) {</div><div class="diff-removed">-			if (bend !== 0) {</div><div class="diff-removed">-				bend *= Math.max(mx, my)</div><div class="diff-removed">-			}</div><div class="diff-removed">-</div><div class="diff-removed">-			if (startNormalizedAnchor) {</div><div class="diff-removed">-				startNormalizedAnchor.x = 1 - startNormalizedAnchor.x</div><div class="diff-removed">-				startNormalizedAnchor.y = 1 - startNormalizedAnchor.y</div><div class="diff-removed">-			}</div><div class="diff-removed">-</div><div class="diff-removed">-			if (endNormalizedAnchor) {</div><div class="diff-removed">-				endNormalizedAnchor.x = 1 - endNormalizedAnchor.x</div><div class="diff-removed">-				endNormalizedAnchor.y = 1 - endNormalizedAnchor.y</div><div class="diff-removed">-			}</div><div class="diff-removed">-		}</div><div class="diff-removed">-</div><div class="diff-removed">-		if (bindings.start && startNormalizedAnchor) {</div><div class="diff-removed">-			createOrUpdateArrowBinding(this.editor, shape, bindings.start.toId, {</div><div class="diff-removed">-				...bindings.start.props,</div><div class="diff-removed">-				normalizedAnchor: startNormalizedAnchor.toJson(),</div><div class="diff-removed">-			})</div><div class="diff-removed">-		}</div><div class="diff-removed">-		if (bindings.end && endNormalizedAnchor) {</div><div class="diff-removed">-			createOrUpdateArrowBinding(this.editor, shape, bindings.end.toId, {</div><div class="diff-removed">-				...bindings.end.props,</div><div class="diff-removed">-				normalizedAnchor: endNormalizedAnchor.toJson(),</div><div class="diff-removed">-			})</div><div class="diff-removed">-		}</div><div class="diff-removed">-</div><div class="diff-removed">-		const next = {</div><div class="diff-removed">-			props: {</div><div class="diff-removed">-				start,</div><div class="diff-removed">-				end,</div><div class="diff-removed">-				bend,</div><div class="diff-removed">-			},</div><div class="diff-removed">-		}</div><div class="diff-removed">-</div><div class="diff-removed">-		return next</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	override onDoubleClickHandle(</div><div class="diff-removed">-		shape: TLArrowShape,</div><div class="diff-removed">-		handle: TLHandle</div><div class="diff-removed">-	): TLShapePartial<TLArrowShape> | void {</div><div class="diff-removed">-		switch (handle.id) {</div><div class="diff-removed">-			case ARROW_HANDLES.START: {</div><div class="diff-removed">-				return {</div><div class="diff-removed">-					id: shape.id,</div><div class="diff-removed">-					type: shape.type,</div><div class="diff-removed">-					props: {</div><div class="diff-removed">-						...shape.props,</div><div class="diff-removed">-						arrowheadStart: shape.props.arrowheadStart === 'none' ? 'arrow' : 'none',</div><div class="diff-removed">-					},</div><div class="diff-removed">-				}</div><div class="diff-removed">-			}</div><div class="diff-removed">-			case ARROW_HANDLES.END: {</div><div class="diff-removed">-				return {</div><div class="diff-removed">-					id: shape.id,</div><div class="diff-removed">-					type: shape.type,</div><div class="diff-removed">-					props: {</div><div class="diff-removed">-						...shape.props,</div><div class="diff-removed">-						arrowheadEnd: shape.props.arrowheadEnd === 'none' ? 'arrow' : 'none',</div><div class="diff-removed">-					},</div><div class="diff-removed">-				}</div><div class="diff-removed">-			}</div><div class="diff-removed">-		}</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	component(shape: TLArrowShape) {</div><div class="diff-removed">-		// eslint-disable-next-line react-hooks/rules-of-hooks</div><div class="diff-removed">-		const theme = useDefaultColorTheme()</div><div class="diff-removed">-		const onlySelectedShape = this.editor.getOnlySelectedShape()</div><div class="diff-removed">-		const shouldDisplayHandles =</div><div class="diff-removed">-			this.editor.isInAny(</div><div class="diff-removed">-				'select.idle',</div><div class="diff-removed">-				'select.pointing_handle',</div><div class="diff-removed">-				'select.dragging_handle',</div><div class="diff-removed">-				'select.translating',</div><div class="diff-removed">-				'arrow.dragging'</div><div class="diff-removed">-			) && !this.editor.getIsReadonly()</div><div class="diff-removed">-</div><div class="diff-removed">-		const info = getArrowInfo(this.editor, shape)</div><div class="diff-removed">-		if (!info?.isValid) return null</div><div class="diff-removed">-</div><div class="diff-removed">-		const labelPosition = getArrowLabelPosition(this.editor, shape)</div><div class="diff-removed">-		const isSelected = shape.id === this.editor.getOnlySelectedShapeId()</div><div class="diff-removed">-		const isEditing = this.editor.getEditingShapeId() === shape.id</div><div class="diff-removed">-		const showArrowLabel = isEditing || shape.props.text</div><div class="diff-removed">-</div><div class="diff-removed">-		return (</div><div class="diff-removed">-			<></div><div class="diff-removed">-				<SVGContainer style={{ minWidth: 50, minHeight: 50 }}></div><div class="diff-removed">-					<ArrowSvg</div><div class="diff-removed">-						shape={shape}</div><div class="diff-removed">-						shouldDisplayHandles={shouldDisplayHandles && onlySelectedShape?.id === shape.id}</div><div class="diff-removed">-					/></div><div class="diff-removed">-				</SVGContainer></div><div class="diff-removed">-				{showArrowLabel && (</div><div class="diff-removed">-					<PlainTextLabel</div><div class="diff-removed">-						shapeId={shape.id}</div><div class="diff-removed">-						classNamePrefix="tl-arrow"</div><div class="diff-removed">-						type="arrow"</div><div class="diff-removed">-						font={shape.props.font}</div><div class="diff-removed">-						fontSize={getArrowLabelFontSize(shape)}</div><div class="diff-removed">-						lineHeight={TEXT_PROPS.lineHeight}</div><div class="diff-removed">-						align="middle"</div><div class="diff-removed">-						verticalAlign="middle"</div><div class="diff-removed">-						text={shape.props.text}</div><div class="diff-removed">-						labelColor={theme[shape.props.labelColor].solid}</div><div class="diff-removed">-						textWidth={labelPosition.box.w - ARROW_LABEL_PADDING * 2 * shape.props.scale}</div><div class="diff-removed">-						isSelected={isSelected}</div><div class="diff-removed">-						padding={0}</div><div class="diff-removed">-						style={{</div><div class="diff-removed">-							transform: `translate(${labelPosition.box.center.x}px, ${labelPosition.box.center.y}px)`,</div><div class="diff-removed">-						}}</div><div class="diff-removed">-					/></div><div class="diff-removed">-				)}</div><div class="diff-removed">-			</></div><div class="diff-removed">-		)</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	indicator(shape: TLArrowShape) {</div><div class="diff-removed">-		// eslint-disable-next-line react-hooks/rules-of-hooks</div><div class="diff-removed">-		const isEditing = useIsEditing(shape.id)</div><div class="diff-removed">-		// eslint-disable-next-line react-hooks/rules-of-hooks</div><div class="diff-removed">-		const clipPathId = useSharedSafeId(shape.id + '_clip')</div><div class="diff-removed">-</div><div class="diff-removed">-		const info = getArrowInfo(this.editor, shape)</div><div class="diff-removed">-		if (!info) return null</div><div class="diff-removed">-</div><div class="diff-removed">-		const { start, end } = getArrowTerminalsInArrowSpace(this.editor, shape, info?.bindings)</div><div class="diff-removed">-		const geometry = this.editor.getShapeGeometry<Group2d>(shape)</div><div class="diff-removed">-		const bounds = geometry.bounds</div><div class="diff-removed">-</div><div class="diff-removed">-		const labelGeometry = shape.props.text.trim() ? (geometry.children[1] as Rectangle2d) : null</div><div class="diff-removed">-</div><div class="diff-removed">-		if (Vec.Equals(start, end)) return null</div><div class="diff-removed">-</div><div class="diff-removed">-		const strokeWidth = STROKE_SIZES[shape.props.size] * shape.props.scale</div><div class="diff-removed">-</div><div class="diff-removed">-		const as = info.start.arrowhead && getArrowheadPathForType(info, 'start', strokeWidth)</div><div class="diff-removed">-		const ae = info.end.arrowhead && getArrowheadPathForType(info, 'end', strokeWidth)</div><div class="diff-removed">-</div><div class="diff-removed">-		const path = info.isStraight ? getSolidStraightArrowPath(info) : getSolidCurvedArrowPath(info)</div><div class="diff-removed">-</div><div class="diff-removed">-		const includeClipPath =</div><div class="diff-removed">-			(as && info.start.arrowhead !== 'arrow') ||</div><div class="diff-removed">-			(ae && info.end.arrowhead !== 'arrow') ||</div><div class="diff-removed">-			!!labelGeometry</div><div class="diff-removed">-</div><div class="diff-removed">-		if (isEditing && labelGeometry) {</div><div class="diff-removed">-			return (</div><div class="diff-removed">-				<rect</div><div class="diff-removed">-					x={toDomPrecision(labelGeometry.x)}</div><div class="diff-removed">-					y={toDomPrecision(labelGeometry.y)}</div><div class="diff-removed">-					width={labelGeometry.w}</div><div class="diff-removed">-					height={labelGeometry.h}</div><div class="diff-removed">-					rx={3.5 * shape.props.scale}</div><div class="diff-removed">-					ry={3.5 * shape.props.scale}</div><div class="diff-removed">-				/></div><div class="diff-removed">-			)</div><div class="diff-removed">-		}</div><div class="diff-removed">-		const clipStartArrowhead = !(</div><div class="diff-removed">-			info.start.arrowhead === 'none' || info.start.arrowhead === 'arrow'</div><div class="diff-removed">-		)</div><div class="diff-removed">-		const clipEndArrowhead = !(info.end.arrowhead === 'none' || info.end.arrowhead === 'arrow')</div><div class="diff-removed">-</div><div class="diff-removed">-		return (</div><div class="diff-removed">-			<g></div><div class="diff-removed">-				{includeClipPath && (</div><div class="diff-removed">-					<defs></div><div class="diff-removed">-						<ArrowClipPath</div><div class="diff-removed">-							hasText={shape.props.text.trim().length > 0}</div><div class="diff-removed">-							bounds={bounds}</div><div class="diff-removed">-							labelBounds={labelGeometry ? labelGeometry.getBounds() : new Box(0, 0, 0, 0)}</div><div class="diff-removed">-							as={clipStartArrowhead && as ? as : ''}</div><div class="diff-removed">-							ae={clipEndArrowhead && ae ? ae : ''}</div><div class="diff-removed">-						/></div><div class="diff-removed">-					</defs></div><div class="diff-removed">-				)}</div><div class="diff-removed">-				<g</div><div class="diff-removed">-					style={{</div><div class="diff-removed">-						clipPath: includeClipPath ? `url(#${clipPathId})` : undefined,</div><div class="diff-removed">-						WebkitClipPath: includeClipPath ? `url(#${clipPathId})` : undefined,</div><div class="diff-removed">-					}}</div><div class="diff-removed">-				></div><div class="diff-removed">-					{/* This rect needs to be here if we're creating a mask due to an svg quirk on Chrome */}</div><div class="diff-removed">-					{includeClipPath && (</div><div class="diff-removed">-						<rect</div><div class="diff-removed">-							x={bounds.minX - 100}</div><div class="diff-removed">-							y={bounds.minY - 100}</div><div class="diff-removed">-							width={bounds.width + 200}</div><div class="diff-removed">-							height={bounds.height + 200}</div><div class="diff-removed">-							opacity={0}</div><div class="diff-removed">-						/></div><div class="diff-removed">-					)}</div><div class="diff-removed">-</div><div class="diff-removed">-					<path d={path} /></div><div class="diff-removed">-				</g></div><div class="diff-removed">-				{as && <path d={as} />}</div><div class="diff-removed">-				{ae && <path d={ae} />}</div><div class="diff-removed">-				{labelGeometry && (</div><div class="diff-removed">-					<rect</div><div class="diff-removed">-						x={toDomPrecision(labelGeometry.x)}</div><div class="diff-removed">-						y={toDomPrecision(labelGeometry.y)}</div><div class="diff-removed">-						width={labelGeometry.w}</div><div class="diff-removed">-						height={labelGeometry.h}</div><div class="diff-removed">-						rx={3.5}</div><div class="diff-removed">-						ry={3.5}</div><div class="diff-removed">-					/></div><div class="diff-removed">-				)}</div><div class="diff-removed">-			</g></div><div class="diff-removed">-		)</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	override onEditEnd(shape: TLArrowShape) {</div><div class="diff-removed">-		const {</div><div class="diff-removed">-			id,</div><div class="diff-removed">-			type,</div><div class="diff-removed">-			props: { text },</div><div class="diff-removed">-		} = shape</div><div class="diff-removed">-</div><div class="diff-removed">-		if (text.trimEnd() !== shape.props.text) {</div><div class="diff-removed">-			this.editor.updateShapes<TLArrowShape>([</div><div class="diff-removed">-				{</div><div class="diff-removed">-					id,</div><div class="diff-removed">-					type,</div><div class="diff-removed">-					props: {</div><div class="diff-removed">-						text: text.trimEnd(),</div><div class="diff-removed">-					},</div><div class="diff-removed">-				},</div><div class="diff-removed">-			])</div><div class="diff-removed">-		}</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	override toSvg(shape: TLArrowShape, ctx: SvgExportContext) {</div><div class="diff-removed">-		ctx.addExportDef(getFillDefForExport(shape.props.fill))</div><div class="diff-removed">-		const theme = getDefaultColorTheme(ctx)</div><div class="diff-removed">-		const scaleFactor = 1 / shape.props.scale</div><div class="diff-removed">-</div><div class="diff-removed">-		return (</div><div class="diff-removed">-			<g transform={`scale(${scaleFactor})`}></div><div class="diff-removed">-				<ArrowSvg shape={shape} shouldDisplayHandles={false} /></div><div class="diff-removed">-				<SvgTextLabel</div><div class="diff-removed">-					fontSize={getArrowLabelFontSize(shape)}</div><div class="diff-removed">-					font={shape.props.font}</div><div class="diff-removed">-					align="middle"</div><div class="diff-removed">-					verticalAlign="middle"</div><div class="diff-removed">-					text={shape.props.text}</div><div class="diff-removed">-					labelColor={theme[shape.props.labelColor].solid}</div><div class="diff-removed">-					bounds={getArrowLabelPosition(this.editor, shape)</div><div class="diff-removed">-						.box.clone()</div><div class="diff-removed">-						.expandBy(-ARROW_LABEL_PADDING * shape.props.scale)}</div><div class="diff-removed">-					padding={0}</div><div class="diff-removed">-				/></div><div class="diff-removed">-			</g></div><div class="diff-removed">-		)</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	override getCanvasSvgDefs(): TLShapeUtilCanvasSvgDef[] {</div><div class="diff-removed">-		return [</div><div class="diff-removed">-			getFillDefForCanvas(),</div><div class="diff-removed">-			{</div><div class="diff-removed">-				key: `arrow:dot`,</div><div class="diff-removed">-				component: ArrowheadDotDef,</div><div class="diff-removed">-			},</div><div class="diff-removed">-			{</div><div class="diff-removed">-				key: `arrow:cross`,</div><div class="diff-removed">-				component: ArrowheadCrossDef,</div><div class="diff-removed">-			},</div><div class="diff-removed">-		]</div><div class="diff-removed">-	}</div><div class="diff-removed">-	override getInterpolatedProps(</div><div class="diff-removed">-		startShape: TLArrowShape,</div><div class="diff-removed">-		endShape: TLArrowShape,</div><div class="diff-removed">-		progress: number</div><div class="diff-removed">-	): TLArrowShapeProps {</div><div class="diff-removed">-		return {</div><div class="diff-removed">-			...(progress > 0.5 ? endShape.props : startShape.props),</div><div class="diff-removed">-			scale: lerp(startShape.props.scale, endShape.props.scale, progress),</div><div class="diff-removed">-			start: {</div><div class="diff-removed">-				x: lerp(startShape.props.start.x, endShape.props.start.x, progress),</div><div class="diff-removed">-				y: lerp(startShape.props.start.y, endShape.props.start.y, progress),</div><div class="diff-removed">-			},</div><div class="diff-removed">-			end: {</div><div class="diff-removed">-				x: lerp(startShape.props.end.x, endShape.props.end.x, progress),</div><div class="diff-removed">-				y: lerp(startShape.props.end.y, endShape.props.end.y, progress),</div><div class="diff-removed">-			},</div><div class="diff-removed">-			bend: lerp(startShape.props.bend, endShape.props.bend, progress),</div><div class="diff-removed">-			labelPosition: lerp(startShape.props.labelPosition, endShape.props.labelPosition, progress),</div><div class="diff-removed">-		}</div><div class="diff-removed">-	}</div><div class="diff-added">+  static override type = 'arrow' as const</div><div class="diff-added">+  static override props = arrowShapeProps</div><div class="diff-added">+  static override migrations = arrowShapeMigrations</div><div class="diff-added">+</div><div class="diff-added">+  override canEdit() {</div><div class="diff-added">+    return true</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  override canBind({ toShapeType }: TLShapeUtilCanBindOpts<TLArrowShape>): boolean {</div><div class="diff-added">+    return toShapeType !== 'arrow'</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  override canSnap() {</div><div class="diff-added">+    return false</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  override hideResizeHandles() {</div><div class="diff-added">+    return true</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  override hideRotateHandle() {</div><div class="diff-added">+    return true</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  override hideSelectionBoundsBg() {</div><div class="diff-added">+    return true</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  override hideSelectionBoundsFg() {</div><div class="diff-added">+    return true</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  override canBeLaidOut(shape: TLArrowShape, info: TLShapeUtilCanBeLaidOutOpts) {</div><div class="diff-added">+    if (info.type === 'flip') {</div><div class="diff-added">+      const bindings = getArrowBindings(this.editor, shape)</div><div class="diff-added">+      const { start, end } = bindings</div><div class="diff-added">+      const { shapes = [] } = info</div><div class="diff-added">+      if (start && !shapes.find((s) => s.id === start.toId)) return false</div><div class="diff-added">+      if (end && !shapes.find((s) => s.id === end.toId)) return false</div><div class="diff-added">+    }</div><div class="diff-added">+    return true</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  override getDefaultProps(): TLArrowShape['props'] {</div><div class="diff-added">+    return {</div><div class="diff-added">+      dash: 'draw',</div><div class="diff-added">+      size: 'm',</div><div class="diff-added">+      fill: 'none',</div><div class="diff-added">+      color: 'black',</div><div class="diff-added">+      labelColor: 'black',</div><div class="diff-added">+      bend: 0,</div><div class="diff-added">+      start: { x: 0, y: 0 },</div><div class="diff-added">+      end: { x: 2, y: 0 },</div><div class="diff-added">+      arrowheadStart: 'none',</div><div class="diff-added">+      arrowheadEnd: 'arrow',</div><div class="diff-added">+      text: '',</div><div class="diff-added">+      labelPosition: 0.5,</div><div class="diff-added">+      font: 'draw',</div><div class="diff-added">+      scale: 1,</div><div class="diff-added">+    }</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  override getFontFaces(shape: TLArrowShape) {</div><div class="diff-added">+    if (!shape.props.text) return EMPTY_ARRAY</div><div class="diff-added">+    return [DefaultFontFaces[`tldraw_${shape.props.font}`].normal.normal]</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  getGeometry(shape: TLArrowShape) {</div><div class="diff-added">+    const info = getArrowInfo(this.editor, shape)!</div><div class="diff-added">+    const debugGeom: Geometry2d[] = []</div><div class="diff-added">+    const bodyGeom = info.isStraight</div><div class="diff-added">+      ? new Edge2d({</div><div class="diff-added">+          start: Vec.From(info.start.point),</div><div class="diff-added">+          end: Vec.From(info.end.point),</div><div class="diff-added">+        })</div><div class="diff-added">+      : new Arc2d({</div><div class="diff-added">+          center: Vec.Cast(info.handleArc.center),</div><div class="diff-added">+          start: Vec.Cast(info.start.point),</div><div class="diff-added">+          end: Vec.Cast(info.end.point),</div><div class="diff-added">+          sweepFlag: info.bodyArc.sweepFlag,</div><div class="diff-added">+          largeArcFlag: info.bodyArc.largeArcFlag,</div><div class="diff-added">+        })</div><div class="diff-added">+    let labelGeom: Rectangle2d | undefined</div><div class="diff-added">+    if (shape.props.text.trim()) {</div><div class="diff-added">+      const labelPosition = getArrowLabelPosition(this.editor, shape)</div><div class="diff-added">+      if (debugFlags.debugGeometry.get()) debugGeom.push(...labelPosition.debugGeom)</div><div class="diff-added">+      labelGeom = new Rectangle2d({</div><div class="diff-added">+        x: labelPosition.box.x,</div><div class="diff-added">+        y: labelPosition.box.y,</div><div class="diff-added">+        width: labelPosition.box.w,</div><div class="diff-added">+        height: labelPosition.box.h,</div><div class="diff-added">+        isFilled: true,</div><div class="diff-added">+        isLabel: true,</div><div class="diff-added">+      })</div><div class="diff-added">+    }</div><div class="diff-added">+    return new Group2d({</div><div class="diff-added">+      children: [...(labelGeom ? [bodyGeom, labelGeom] : [bodyGeom]), ...(debugFlags.debugGeometry.get() ? debugGeom : [])],</div><div class="diff-added">+    })</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  override getHandles(shape: TLArrowShape): TLHandle[] {</div><div class="diff-added">+    const info = getArrowInfo(this.editor, shape)!</div><div class="diff-added">+    const bindings = getArrowBindings(this.editor, shape)</div><div class="diff-added">+    const geometry = this.editor.getShapeGeometry<Group2d>(shape)</div><div class="diff-added">+    const labelGeometry = shape.props.text.trim() ? (geometry.children[1] as Rectangle2d) : null</div><div class="diff-added">+</div><div class="diff-added">+    return [</div><div class="diff-added">+      {</div><div class="diff-added">+        id: ARROW_HANDLES.START,</div><div class="diff-added">+        type: 'vertex',</div><div class="diff-added">+        index: 'a0',</div><div class="diff-added">+        x: info.start.handle.x,</div><div class="diff-added">+        y: info.start.handle.y,</div><div class="diff-added">+        canBind: true,</div><div class="diff-added">+      },</div><div class="diff-added">+      {</div><div class="diff-added">+        id: ARROW_HANDLES.MIDDLE,</div><div class="diff-added">+        type: 'virtual',</div><div class="diff-added">+        index: 'a2',</div><div class="diff-added">+        x: info.middle.x,</div><div class="diff-added">+        y: info.middle.y,</div><div class="diff-added">+        canBind: false,</div><div class="diff-added">+      },</div><div class="diff-added">+      labelGeometry && {</div><div class="diff-added">+        id: ARROW_HANDLES.END,</div><div class="diff-added">+        type: 'vertex',</div><div class="diff-added">+        index: 'a3',</div><div class="diff-added">+        x: info.end.handle.x,</div><div class="diff-added">+        y: info.end.handle.y,</div><div class="diff-added">+        canBind: true,</div><div class="diff-added">+      },</div><div class="diff-added">+    ].filter(Boolean) as TLHandle[]</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  override onHandleDrag(shape: TLArrowShape, { handle, isPrecise }: TLHandleDragInfo<TLArrowShape>) {</div><div class="diff-added">+    const handleId = handle.id as ARROW_HANDLES</div><div class="diff-added">+    const bindings = getArrowBindings(this.editor, shape)</div><div class="diff-added">+</div><div class="diff-added">+    if (handleId === ARROW_HANDLES.MIDDLE) {</div><div class="diff-added">+      const { start, end } = getArrowTerminalsInArrowSpace(this.editor, shape, bindings)</div><div class="diff-added">+      const delta = Vec.Sub(end, start)</div><div class="diff-added">+      const v = Vec.Per(delta)</div><div class="diff-added">+      const med = Vec.Med(end, start)</div><div class="diff-added">+      const A = Vec.Sub(med, v)</div><div class="diff-added">+      const B = Vec.Add(med, v)</div><div class="diff-added">+      const point = Vec.NearestPointOnLineSegment(A, B, handle, false)</div><div class="diff-added">+      let bend = Vec.Dist(point, med)</div><div class="diff-added">+      if (Vec.Clockwise(point, end, med)) bend *= -1</div><div class="diff-added">+      return { id: shape.id, type: shape.type, props: { bend } }</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    const update: TLShapePartial<TLArrowShape> = { id: shape.id, type: 'arrow', props: {} }</div><div class="diff-added">+    const currentBinding = bindings[handleId]</div><div class="diff-added">+    const otherHandleId = handleId === ARROW_HANDLES.START ? ARROW_HANDLES.END : ARROW_HANDLES.START</div><div class="diff-added">+    const otherBinding = bindings[otherHandleId]</div><div class="diff-added">+</div><div class="diff-added">+    if (this.editor.inputs.ctrlKey) {</div><div class="diff-added">+      removeArrowBinding(this.editor, shape, handleId)</div><div class="diff-added">+      update.props![handleId] = { x: handle.x, y: handle.y }</div><div class="diff-added">+      return update</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    const newPagePt = this.editor.getShapePageTransform(shape.id)!.applyToPoint(handle)</div><div class="diff-added">+    const target = this.editor.getShapeAtPoint(newPagePt, {</div><div class="diff-added">+      hitInside: true,</div><div class="diff-added">+      hitFrameInside: true,</div><div class="diff-added">+      margin: 0,</div><div class="diff-added">+      filter: (t) => !t.isLocked && this.editor.canBindShapes({ fromShape: shape, toShape: t, binding: 'arrow' }),</div><div class="diff-added">+    })</div><div class="diff-added">+</div><div class="diff-added">+    if (!target) {</div><div class="diff-added">+      removeArrowBinding(this.editor, shape, handleId)</div><div class="diff-added">+      const snapped = maybeSnapToGrid(new Vec(handle.x, handle.y), this.editor)</div><div class="diff-added">+      update.props![handleId] = { x: snapped.x, y: snapped.y }</div><div class="diff-added">+      return update</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    const targetGeom = this.editor.getShapeGeometry(target)</div><div class="diff-added">+    const targetBounds = Box.ZeroFix(targetGeom.bounds)</div><div class="diff-added">+    const pointInTarget = this.editor.getPointInShapeSpace(target, newPagePt)</div><div class="diff-added">+</div><div class="diff-added">+    let preciseSnap = isPrecise || (!targetGeom.isClosed && !currentBinding)</div><div class="diff-added">+    if (!preciseSnap && currentBinding && target.id !== currentBinding.toId) {</div><div class="diff-added">+      preciseSnap = this.editor.inputs.pointerVelocity.len() < 0.5</div><div class="diff-added">+    }</div><div class="diff-added">+    if (!preciseSnap && otherBinding && target.id === otherBinding.toId && otherBinding.props.isPrecise) {</div><div class="diff-added">+      preciseSnap = true</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    const normalizedAnchor = preciseSnap</div><div class="diff-added">+      ? { x: (pointInTarget.x - targetBounds.minX) / targetBounds.width, y: (pointInTarget.y - targetBounds.minY) / targetBounds.height }</div><div class="diff-added">+      : { x: 0.5, y: 0.5 }</div><div class="diff-added">+</div><div class="diff-added">+    createOrUpdateArrowBinding(this.editor, shape, target.id, {</div><div class="diff-added">+      terminal: handleId,</div><div class="diff-added">+      normalizedAnchor,</div><div class="diff-added">+      isPrecise: preciseSnap,</div><div class="diff-added">+      isExact: this.editor.inputs.altKey,</div><div class="diff-added">+    })</div><div class="diff-added">+</div><div class="diff-added">+    this.editor.setHintingShapes([target.id])</div><div class="diff-added">+</div><div class="diff-added">+    const newBindings = getArrowBindings(this.editor, shape)</div><div class="diff-added">+    if (newBindings.start && newBindings.end && newBindings.start.toId === newBindings.end.toId) {</div><div class="diff-added">+      const both = newBindings.start</div><div class="diff-added">+      const bothOther = newBindings.end</div><div class="diff-added">+      if (Vec.Equals(both.props.normalizedAnchor, bothOther.props.normalizedAnchor)) {</div><div class="diff-added">+        createOrUpdateArrowBinding(this.editor, shape, bothOther.toId, {</div><div class="diff-added">+          ...bothOther.props,</div><div class="diff-added">+          normalizedAnchor: {</div><div class="diff-added">+            x: bothOther.props.normalizedAnchor.x + 0.05,</div><div class="diff-added">+            y: bothOther.props.normalizedAnchor.y,</div><div class="diff-added">+          },</div><div class="diff-added">+        })</div><div class="diff-added">+      }</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    return update</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  override onTranslateStart(shape: TLArrowShape) {</div><div class="diff-added">+    const bindings = getArrowBindings(this.editor, shape)</div><div class="diff-added">+    const terminals = getArrowTerminalsInArrowSpace(this.editor, shape, bindings)</div><div class="diff-added">+    const pageT = this.editor.getShapePageTransform(shape.id)!</div><div class="diff-added">+</div><div class="diff-added">+    const selIds = this.editor.getSelectedShapeIds()</div><div class="diff-added">+    if (</div><div class="diff-added">+      (bindings.start && (selIds.includes(bindings.start.toId) || this.editor.isAncestorSelected(bindings.start.toId))) ||</div><div class="diff-added">+      (bindings.end && (selIds.includes(bindings.end.toId) || this.editor.isAncestorSelected(bindings.end.toId)))</div><div class="diff-added">+    ) {</div><div class="diff-added">+      return</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    shapeAtTranslationStart.set(shape, {</div><div class="diff-added">+      pagePosition: pageT.applyToPoint(shape),</div><div class="diff-added">+      terminalBindings: mapObjectMapValues(terminals, (tn, pt) => {</div><div class="diff-added">+        const b = bindings[tn]</div><div class="diff-added">+        if (!b) return null</div><div class="diff-added">+        return { binding: b, shapePosition: pt, pagePosition: pageT.applyToPoint(pt) }</div><div class="diff-added">+      }),</div><div class="diff-added">+    })</div><div class="diff-added">+</div><div class="diff-added">+    for (const tn of ['start', 'end'] as const) {</div><div class="diff-added">+      const b = bindings[tn]</div><div class="diff-added">+      if (!b) continue</div><div class="diff-added">+      this.editor.updateBinding({ ...b, props: { ...b.props, isPrecise: true } })</div><div class="diff-added">+    }</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  override onTranslate(initial: TLArrowShape, shape: TLArrowShape) {</div><div class="diff-added">+    const atStart = shapeAtTranslationStart.get(initial)</div><div class="diff-added">+    if (!atStart) return</div><div class="diff-added">+    const pageT = this.editor.getShapePageTransform(shape.id)!</div><div class="diff-added">+    const delta = Vec.Sub(pageT.applyToPoint(shape), atStart.pagePosition)</div><div class="diff-added">+</div><div class="diff-added">+    for (const tb of Object.values(atStart.terminalBindings)) {</div><div class="diff-added">+      if (!tb) continue</div><div class="diff-added">+      const newPt = Vec.Add(tb.pagePosition, Vec.Mul(delta, 0.5))</div><div class="diff-added">+      const tgt = this.editor.getShapeAtPoint(newPt, {</div><div class="diff-added">+        hitInside: true,</div><div class="diff-added">+        hitFrameInside: true,</div><div class="diff-added">+        margin: 0,</div><div class="diff-added">+        filter: (t) => !t.isLocked && this.editor.canBindShapes({ fromShape: shape, toShape: t, binding: 'arrow' }),</div><div class="diff-added">+      })</div><div class="diff-added">+      if (tgt && tb.binding.toId === tgt.id) {</div><div class="diff-added">+        const tbounds = Box.ZeroFix(this.editor.getShapeGeometry(tgt).bounds)</div><div class="diff-added">+        const pts = this.editor.getPointInShapeSpace(tgt, newPt)</div><div class="diff-added">+        createOrUpdateArrowBinding(this.editor, shape, tgt.id, {</div><div class="diff-added">+          terminal: tb.binding.terminal,</div><div class="diff-added">+          normalizedAnchor: { x: (pts.x - tbounds.minX) / tbounds.width, y: (pts.y - tbounds.minY) / tbounds.height },</div><div class="diff-added">+          isPrecise: true,</div><div class="diff-added">+          isExact: false,</div><div class="diff-added">+        })</div><div class="diff-added">+      } else {</div><div class="diff-added">+        removeArrowBinding(this.editor, shape, tb.binding.terminal)</div><div class="diff-added">+      }</div><div class="diff-added">+    }</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  private readonly _resizeInitialBindings = new WeakCache<TLArrowShape, ReturnType<typeof getArrowBindings>>()</div><div class="diff-added">+</div><div class="diff-added">+  override onResize(shape: TLArrowShape, info: TLResizeInfo<TLArrowShape>) {</div><div class="diff-added">+    const { scaleX, scaleY } = info</div><div class="diff-added">+    const bindings = this._resizeInitialBindings.get(shape, () => getArrowBindings(this.editor, shape))</div><div class="diff-added">+    const terminals = getArrowTerminalsInArrowSpace(this.editor, shape, bindings)</div><div class="diff-added">+    const props = structuredClone<TLArrowShapeProps>(shape.props)</div><div class="diff-added">+    let { start, end, bend } = props</div><div class="diff-added">+</div><div class="diff-added">+    if (!bindings.start) {</div><div class="diff-added">+      start.x = terminals.start.x * scaleX</div><div class="diff-added">+      start.y = terminals.start.y * scaleY</div><div class="diff-added">+    }</div><div class="diff-added">+    if (!bindings.end) {</div><div class="diff-added">+      end.x = terminals.end.x * scaleX</div><div class="diff-added">+      end.y = terminals.end.y * scaleY</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    const mx = Math.abs(scaleX)</div><div class="diff-added">+    const my = Math.abs(scaleY)</div><div class="diff-added">+    const sa = bindings.start ? Vec.From(bindings.start.props.normalizedAnchor) : null</div><div class="diff-added">+    const ea = bindings.end ? Vec.From(bindings.end.props.normalizedAnchor) : null</div><div class="diff-added">+</div><div class="diff-added">+    if (scaleX < 0 && scaleY >= 0) {</div><div class="diff-added">+      if (bend !== 0) bend = -bend * Math.max(mx, my)</div><div class="diff-added">+      if (sa) sa.x = 1 - sa.x</div><div class="diff-added">+      if (ea) ea.x = 1 - ea.x</div><div class="diff-added">+    } else if (scaleX >= 0 && scaleY < 0) {</div><div class="diff-added">+      if (bend !== 0) bend = -bend * Math.max(mx, my)</div><div class="diff-added">+      if (sa) sa.y = 1 - sa.y</div><div class="diff-added">+      if (ea) ea.y = 1 - ea.y</div><div class="diff-added">+    } else if (scaleX < 0 && scaleY < 0) {</div><div class="diff-added">+      if (bend !== 0) bend *= Math.max(mx, my)</div><div class="diff-added">+      if (sa) { sa.x = 1 - sa.x; sa.y = 1 - sa.y }</div><div class="diff-added">+      if (ea) { ea.x = 1 - ea.x; ea.y = 1 - ea.y }</div><div class="diff-added">+    } else if (bend !== 0) {</div><div class="diff-added">+      bend *= Math.max(mx, my)</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    if (bindings.start && sa) {</div><div class="diff-added">+      createOrUpdateArrowBinding(this.editor, shape, bindings.start.toId, { ...bindings.start.props, normalizedAnchor: sa.toJson() })</div><div class="diff-added">+    }</div><div class="diff-added">+    if (bindings.end && ea) {</div><div class="diff-added">+      createOrUpdateArrowBinding(this.editor, shape, bindings.end.toId, { ...bindings.end.props, normalizedAnchor: ea.toJson() })</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    return { props: { start, end, bend } }</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  override onDoubleClickHandle(shape: TLArrowShape, handle: TLHandle) {</div><div class="diff-added">+    switch (handle.id) {</div><div class="diff-added">+      case ARROW_HANDLES.START:</div><div class="diff-added">+        return { id: shape.id, type: shape.type, props: { ...shape.props, arrowheadStart: shape.props.arrowheadStart === 'none' ? 'arrow' : 'none' } }</div><div class="diff-added">+      case ARROW_HANDLES.END:</div><div class="diff-added">+        return { id: shape.id, type: shape.type, props: { ...shape.props, arrowheadEnd: shape.props.arrowheadEnd === 'none' ? 'arrow' : 'none' } }</div><div class="diff-added">+    }</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  override getText(shape: TLArrowShape) {</div><div class="diff-added">+    return shape.props.text</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  override getInterpolatedProps(start: TLArrowShape, end: TLArrowShape, progress: number): TLArrowShapeProps {</div><div class="diff-added">+    return {</div><div class="diff-added">+      ...(progress > 0.5 ? end.props : start.props),</div><div class="diff-added">+      scale: lerp(start.props.scale, end.props.scale, progress),</div><div class="diff-added">+      start: {</div><div class="diff-added">+        x: lerp(start.props.start.x, end.props.start.x, progress),</div><div class="diff-added">+        y: lerp(start.props.start.y, end.props.start.y, progress),</div><div class="diff-added">+      },</div><div class="diff-added">+      end: {</div><div class="diff-added">+        x: lerp(start.props.end.x, end.props.end.x, progress),</div><div class="diff-added">+        y: lerp(start.props.end.y, end.props.end.y, progress),</div><div class="diff-added">+      },</div><div class="diff-added">+      bend: lerp(start.props.bend, end.props.bend, progress),</div><div class="diff-added">+      labelPosition: lerp(start.props.labelPosition, end.props.labelPosition, progress),</div><div class="diff-added">+    }</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  component(shape: TLArrowShape) {</div><div class="diff-added">+    const theme = useDefaultColorTheme()</div><div class="diff-added">+    const only = this.editor.getOnlySelectedShape()</div><div class="diff-added">+    const hand = this.editor.isInAny('select.idle', 'select.pointing_handle', 'select.dragging_handle', 'select.translating', 'arrow.dragging') && !this.editor.getIsReadonly()</div><div class="diff-added">+    const info = getArrowInfo(this.editor, shape)</div><div class="diff-added">+    const bounds = Box.ZeroFix(this.editor.getShapeGeometry(shape).bounds)</div><div class="diff-added">+    const labelPos = getArrowLabelPosition(this.editor, shape)</div><div class="diff-added">+    const isEdit = useIsEditing(shape.id)</div><div class="diff-added">+    const showLabel = isEdit || shape.props.text</div><div class="diff-added">+</div><div class="diff-added">+    return (</div><div class="diff-added">+      <></div><div class="diff-added">+        <SVGContainer style={{ minWidth: 50, minHeight: 50 }}></div><div class="diff-added">+          <ArrowSvg shape={shape} shouldDisplayHandles={hand && only?.id === shape.id} /></div><div class="diff-added">+        </SVGContainer></div><div class="diff-added">+        {showLabel && (</div><div class="diff-added">+          <PlainTextLabel</div><div class="diff-added">+            shapeId={shape.id}</div><div class="diff-added">+            classNamePrefix="tl-arrow"</div><div class="diff-added">+            type="arrow"</div><div class="diff-added">+            font={shape.props.font}</div><div class="diff-added">+            fontSize={getArrowLabelFontSize(shape)}</div><div class="diff-added">+            lineHeight={TEXT_PROPS.lineHeight}</div><div class="diff-added">+            align="middle"</div><div class="diff-added">+            verticalAlign="middle"</div><div class="diff-added">+            text={shape.props.text}</div><div class="diff-added">+            labelColor={theme[shape.props.labelColor].solid}</div><div class="diff-added">+            textWidth={labelPos.box.w - ARROW_LABEL_PADDING * 2 * shape.props.scale}</div><div class="diff-added">+            isSelected={shape.id === only?.id}</div><div class="diff-added">+            padding={0}</div><div class="diff-added">+            style={{ transform: `translate(${labelPos.box.center.x}px, ${labelPos.box.center.y}px)` }}</div><div class="diff-added">+          /></div><div class="diff-added">+        )}</div><div class="diff-added">+      </></div><div class="diff-added">+    )</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  override indicator(shape: TLArrowShape) {</div><div class="diff-added">+    const only = this.editor.getOnlySelectedShape()</div><div class="diff-added">+    const hand = this.editor.isInAny('select.idle', 'select.pointing_handle', 'select.dragging_handle', 'select.translating', 'arrow.dragging') && !this.editor.getIsReadonly()</div><div class="diff-added">+    const info = getArrowInfo(this.editor, shape)</div><div class="diff-added">+    if (!info) return null</div><div class="diff-added">+    const { start, end } = getArrowTerminalsInArrowSpace(this.editor, shape, info.bindings)</div><div class="diff-added">+    const geometry = this.editor.getShapeGeometry<Group2d>(shape)</div><div class="diff-added">+    const bounds = geometry.bounds</div><div class="diff-added">+    const labelGeom = shape.props.text.trim() ? (geometry.children[1] as Rectangle2d) : null</div><div class="diff-added">+    const isEdit = useIsEditing(shape.id)</div><div class="diff-added">+</div><div class="diff-added">+    const clipStart = !(info.start.arrowhead === 'none' || info.start.arrowhead === 'arrow')</div><div class="diff-added">+    const clipEnd = !(info.end.arrowhead === 'none' || info.end.arrowhead === 'arrow')</div><div class="diff-added">+</div><div class="diff-added">+    const clipId = useSharedSafeId(shape.id + '_clip')</div><div class="diff-added">+</div><div class="diff-added">+    const path = info.isStraight ? getSolidStraightArrowPath(info) : getSolidCurvedArrowPath(info)</div><div class="diff-added">+</div><div class="diff-added">+    return (</div><div class="diff-added">+      <g></div><div class="diff-added">+        {hand && only?.id === shape.id && (</div><div class="diff-added">+          <ArrowSvg shape={shape} shouldDisplayHandles={true} /></div><div class="diff-added">+        )}</div><div class="diff-added">+        <SvgTextLabel</div><div class="diff-added">+          fontSize={getArrowLabelFontSize(shape)}</div><div class="diff-added">+          font={shape.props.font}</div><div class="diff-added">+          align="middle"</div><div class="diff-added">+          verticalAlign="middle"</div><div class="diff-added">+          text={shape.props.text}</div><div class="diff-added">+          labelColor={theme[shape.props.labelColor].solid}</div><div class="diff-added">+          bounds={labelPos.box.clone().expandBy(-ARROW_LABEL_PADDING * shape.props.scale)}</div><div class="diff-added">+          padding={0}</div><div class="diff-added">+        /></div><div class="diff-added">+      </g></div><div class="diff-added">+    )</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  override toSvg(shape: TLArrowShape, ctx: SvgExportContext) {</div><div class="diff-added">+    ctx.addExportDef(getFillDefForExport(shape.props.fill))</div><div class="diff-added">+    const theme = getDefaultColorTheme(ctx)</div><div class="diff-added">+    const scaleFactor = 1 / shape.props.scale</div><div class="diff-added">+</div><div class="diff-added">+    return (</div><div class="diff-added">+      <g transform={`scale(${scaleFactor})`}></div><div class="diff-added">+        <ArrowSvg shape={shape} shouldDisplayHandles={false} /></div><div class="diff-added">+        <SvgTextLabel</div><div class="diff-added">+          fontSize={getArrowLabelFontSize(shape)}</div><div class="diff-added">+          font={shape.props.font}</div><div class="diff-added">+          align="middle"</div><div class="diff-added">+          verticalAlign="middle"</div><div class="diff-added">+          text={shape.props.text}</div><div class="diff-added">+          labelColor={theme[shape.props.labelColor].solid}</div><div class="diff-added">+          bounds={getArrowLabelPosition(this.editor, shape).box}</div><div class="diff-added">+          padding={4 * shape.props.scale}</div><div class="diff-added">+        /></div><div class="diff-added">+      </g></div><div class="diff-added">+    )</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  override getCanvasSvgDefs(): TLShapeUtilCanvasSvgDef[] {</div><div class="diff-added">+    return [</div><div class="diff-added">+      getFillDefForCanvas(),</div><div class="diff-added">+      { key: `arrow:dot`, component: ArrowheadDotDef },</div><div class="diff-added">+      { key: `arrow:cross`, component: ArrowheadCrossDef },</div><div class="diff-added">+    ]</div><div class="diff-added">+  }</div><div> }</div><div> </div><div class="diff-removed">-export function getArrowLength(editor: Editor, shape: TLArrowShape): number {</div><div class="diff-removed">-	const info = getArrowInfo(editor, shape)!</div><div class="diff-removed">-</div><div class="diff-removed">-	return info.isStraight</div><div class="diff-removed">-		? Vec.Dist(info.start.handle, info.end.handle)</div><div class="diff-removed">-		: Math.abs(info.handleArc.length)</div><div class="diff-added">+const shapeAtTranslationStart = new WeakMap<</div><div class="diff-added">+  TLArrowShape,</div><div class="diff-added">+  {</div><div class="diff-added">+    pagePosition: Vec</div><div class="diff-added">+    terminalBindings: Record<</div><div class="diff-added">+      'start' | 'end',</div><div class="diff-added">+      { binding: TLArrowBinding; shapePosition: Vec; pagePosition: Vec } | null</div><div class="diff-added">+    ></div><div class="diff-added">+  }</div><div class="diff-added">+>()</div><div class="diff-added">+</div><div class="diff-added">+const ArrowSvg = track(function ArrowSvg({</div><div class="diff-added">+  shape,</div><div class="diff-added">+  shouldDisplayHandles,</div><div class="diff-added">+}: {</div><div class="diff-added">+  shape: TLArrowShape</div><div class="diff-added">+  shouldDisplayHandles: boolean</div><div class="diff-added">+}) {</div><div class="diff-added">+  const editor = useEditor()</div><div class="diff-added">+  const theme = useDefaultColorTheme()</div><div class="diff-added">+  const info = getArrowInfo(editor, shape)</div><div class="diff-added">+  const bounds = Box.ZeroFix(editor.getShapeGeometry(shape).bounds)</div><div class="diff-added">+  const bindings = getArrowBindings(editor, shape)</div><div class="diff-added">+  const isForceSolid = useValue(</div><div class="diff-added">+    'force solid',</div><div class="diff-added">+    () => editor.getZoomLevel() < 0.2,</div><div class="diff-added">+    [editor]</div><div class="diff-added">+  )</div><div class="diff-added">+</div><div class="diff-added">+  if (!info?.isValid) return null</div><div class="diff-added">+</div><div class="diff-added">+  const strokeWidth = STROKESIZES[shape.props.size] * shape.props.scale</div><div class="diff-added">+  const as = info.start.arrowhead && getArrowheadPathForType(info, 'start', strokeWidth)</div><div class="diff-added">+  const ae = info.end.arrowhead && getArrowheadPathForType(info, 'end', strokeWidth)</div><div class="diff-added">+  let handlePath: React.JSX.Element | null = null</div><div class="diff-added">+</div><div class="diff-added">+  if (shouldDisplayHandles) {</div><div class="diff-added">+    const sw = 2 / editor.getZoomLevel()</div><div class="diff-added">+    const { strokeDasharray, strokeDashoffset } = getPerfectDashProps(</div><div class="diff-added">+      getArrowLength(editor, shape),</div><div class="diff-added">+      sw,</div><div class="diff-added">+      {</div><div class="diff-added">+        end: 'skip',</div><div class="diff-added">+        start: 'skip',</div><div class="diff-added">+        lengthRatio: 2.5,</div><div class="diff-added">+        forceSolid: isForceSolid,</div><div class="diff-added">+      }</div><div class="diff-added">+    )</div><div class="diff-added">+    handlePath = bindings.start || bindings.end ? (</div><div class="diff-added">+      <path</div><div class="diff-added">+        className="tl-arrow-hint"</div><div class="diff-added">+        d={info.isStraight ? getStraightArrowHandlePath(info) : getCurvedArrowHandlePath(info)}</div><div class="diff-added">+        strokeDasharray={strokeDasharray}</div><div class="diff-added">+        strokeDashoffset={strokeDashoffset}</div><div class="diff-added">+        strokeWidth={sw}</div><div class="diff-added">+        markerStart={</div><div class="diff-added">+          bindings.start</div><div class="diff-added">+            ? bindings.start.props.isExact</div><div class="diff-added">+              ? ''</div><div class="diff-added">+              : bindings.start.props.isPrecise</div><div class="diff-added">+              ? `url(#${arrowheadCrossId})`</div><div class="diff-added">+              : `url(#${arrowheadDotId})`</div><div class="diff-added">+            : ''</div><div class="diff-added">+        }</div><div class="diff-added">+        markerEnd={</div><div class="diff-added">+          bindings.end</div><div class="diff-added">+            ? bindings.end.props.isExact</div><div class="diff-added">+              ? ''</div><div class="diff-added">+              : bindings.end.props.isPrecise</div><div class="diff-added">+              ? `url(#${arrowheadCrossId})`</div><div class="diff-added">+              : `url(#${arrowheadDotId})`</div><div class="diff-added">+            : ''</div><div class="diff-added">+        }</div><div class="diff-added">+        opacity={0.16}</div><div class="diff-added">+      /></div><div class="diff-added">+    ) : null</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  const { strokeDasharray, strokeDashoffset } = getPerfectDashProps(</div><div class="diff-added">+    info.isStraight ? info.length : Math.abs(info.bodyArc.length),</div><div class="diff-added">+    strokeWidth,</div><div class="diff-added">+    { style: shape.props.dash, forceSolid: isForceSolid }</div><div class="diff-added">+  )</div><div class="diff-added">+</div><div class="diff-added">+  const clipStartArrowhead = !(info.start.arrowhead === 'none' || info.start.arrowhead === 'arrow')</div><div class="diff-added">+  const clipEndArrowhead = !(info.end.arrowhead === 'none' || info.end.arrowhead === 'arrow')</div><div class="diff-added">+  const clipPathId = useSharedSafeId(shape.id + '_clip')</div><div class="diff-added">+  return (</div><div class="diff-added">+    <></div><div class="diff-added">+      <defs></div><div class="diff-added">+        <clipPath id={clipPathId}></div><div class="diff-added">+          <ArrowClipPath</div><div class="diff-added">+            hasText={shape.props.text.trim().length > 0}</div><div class="diff-added">+            bounds={bounds}</div><div class="diff-added">+            labelBounds={getArrowLabelPosition(editor, shape).box}</div><div class="diff-added">+            as={clipStartArrowhead && as ? as : ''}</div><div class="diff-added">+            ae={clipEndArrowhead && ae ? ae : ''}</div><div class="diff-added">+          /></div><div class="diff-added">+        </clipPath></div><div class="diff-added">+      </defs></div><div class="diff-added">+      <g fill="none" stroke={theme[shape.props.color].solid} strokeWidth={strokeWidth} strokeLinejoin="round" strokeLinecap="round" pointerEvents="none"></div><div class="diff-added">+        {handlePath}</div><div class="diff-added">+        <g style={{ clipPath: `url(#${clipPathId})`, WebkitClipPath: `url(#${clipPathId})` }}></div><div class="diff-added">+          <rect x={toDomPrecision(bounds.minX - 100)} y={toDomPrecision(bounds.minY - 100)} width={toDomPrecision(bounds.width + 200)} height={toDomPrecision(bounds.height + 200)} opacity={0} /></div><div class="diff-added">+          <path d={info.isStraight ? getSolidStraightArrowPath(info) : getSolidCurvedArrowPath(info)} strokeDasharray={strokeDasharray} strokeDashoffset={strokeDashoffset} /></div><div class="diff-added">+        </g></div><div class="diff-added">+        {as && clipStartArrowhead && shape.props.fill !== 'none' && <ShapeFill theme={theme} d={as} color={shape.props.color} fill={shape.props.fill} scale={shape.props.scale} />}</div><div class="diff-added">+        {ae && clipEndArrowhead && shape.props.fill !== 'none' && <ShapeFill theme={theme} d={ae} color={shape.props.color} fill={shape.props.fill} scale={shape.props.scale} />}</div><div class="diff-added">+        {as && <path d={as} />}</div><div class="diff-added">+        {ae && <path d={ae} />}</div><div class="diff-added">+      </g></div><div class="diff-added">+    </></div><div class="diff-added">+  )</div><div class="diff-added">+})</div><div class="diff-added">+</div><div class="diff-added">+function ArrowheadDotDef() {</div><div class="diff-added">+  const id = useSharedSafeId('arrowhead-dot')</div><div class="diff-added">+  return (</div><div class="diff-added">+    <marker id={id} className="tl-arrow-hint" refX="3.0" refY="3.0" orient="0"></div><div class="diff-added">+      <circle cx="3" cy="3" r="2" strokeDasharray="100%" /></div><div class="diff-added">+    </marker></div><div class="diff-added">+  )</div><div> }</div><div> </div><div class="diff-removed">-const ArrowSvg = track(function ArrowSvg({</div><div class="diff-removed">-	shape,</div><div class="diff-removed">-	shouldDisplayHandles,</div><div class="diff-added">+function ArrowheadCrossDef() {</div><div class="diff-added">+  const id = useSharedSafeId('arrowhead-cross')</div><div class="diff-added">+  return (</div><div class="diff-added">+    <marker id={id} className="tl-arrow-hint" refX="3.0" refY="3.0" orient="auto"></div><div class="diff-added">+      <line x1="1.5" y1="1.5" x2="4.5" y2="4.5" strokeDasharray="100%" /></div><div class="diff-added">+      <line x1="1.5" y1="4.5" x2="4.5" y2="1.5" strokeDasharray="100%" /></div><div class="diff-added">+    </marker></div><div class="diff-added">+  )</div><div class="diff-added">+}</div><div class="diff-added">+</div><div class="diff-added">+function ArrowClipPath({</div><div class="diff-added">+  hasText,</div><div class="diff-added">+  bounds,</div><div class="diff-added">+  labelBounds,</div><div class="diff-added">+  as,</div><div class="diff-added">+  ae,</div><div> }: {</div><div class="diff-removed">-	shape: TLArrowShape</div><div class="diff-removed">-	shouldDisplayHandles: boolean</div><div class="diff-added">+  hasText: boolean</div><div class="diff-added">+  bounds: Box</div><div class="diff-added">+  labelBounds: Box</div><div class="diff-added">+  as: string</div><div class="diff-added">+  ae: string</div><div> }) {</div><div class="diff-removed">-	const editor = useEditor()</div><div class="diff-removed">-	const theme = useDefaultColorTheme()</div><div class="diff-removed">-	const info = getArrowInfo(editor, shape)</div><div class="diff-removed">-	const bounds = Box.ZeroFix(editor.getShapeGeometry(shape).bounds)</div><div class="diff-removed">-	const bindings = getArrowBindings(editor, shape)</div><div class="diff-removed">-	const isForceSolid = useValue(</div><div class="diff-removed">-		'force solid',</div><div class="diff-removed">-		() => {</div><div class="diff-removed">-			return editor.getZoomLevel() < 0.2</div><div class="diff-removed">-		},</div><div class="diff-removed">-		[editor]</div><div class="diff-removed">-	)</div><div class="diff-removed">-</div><div class="diff-removed">-	const clipPathId = useSharedSafeId(shape.id + '_clip')</div><div class="diff-removed">-	const arrowheadDotId = useSharedSafeId('arrowhead-dot')</div><div class="diff-removed">-	const arrowheadCrossId = useSharedSafeId('arrowhead-cross')</div><div class="diff-removed">-</div><div class="diff-removed">-	if (!info?.isValid) return null</div><div class="diff-removed">-</div><div class="diff-removed">-	const strokeWidth = STROKE_SIZES[shape.props.size] * shape.props.scale</div><div class="diff-removed">-</div><div class="diff-removed">-	const as = info.start.arrowhead && getArrowheadPathForType(info, 'start', strokeWidth)</div><div class="diff-removed">-	const ae = info.end.arrowhead && getArrowheadPathForType(info, 'end', strokeWidth)</div><div class="diff-removed">-</div><div class="diff-removed">-	const path = info.isStraight ? getSolidStraightArrowPath(info) : getSolidCurvedArrowPath(info)</div><div class="diff-removed">-</div><div class="diff-removed">-	let handlePath: null | React.JSX.Element = null</div><div class="diff-removed">-</div><div class="diff-removed">-	if (shouldDisplayHandles) {</div><div class="diff-removed">-		const sw = 2 / editor.getZoomLevel()</div><div class="diff-removed">-		const { strokeDasharray, strokeDashoffset } = getPerfectDashProps(</div><div class="diff-removed">-			getArrowLength(editor, shape),</div><div class="diff-removed">-			sw,</div><div class="diff-removed">-			{</div><div class="diff-removed">-				end: 'skip',</div><div class="diff-removed">-				start: 'skip',</div><div class="diff-removed">-				lengthRatio: 2.5,</div><div class="diff-removed">-			}</div><div class="diff-removed">-		)</div><div class="diff-removed">-</div><div class="diff-removed">-		handlePath =</div><div class="diff-removed">-			bindings.start || bindings.end ? (</div><div class="diff-removed">-				<path</div><div class="diff-removed">-					className="tl-arrow-hint"</div><div class="diff-removed">-					d={info.isStraight ? getStraightArrowHandlePath(info) : getCurvedArrowHandlePath(info)}</div><div class="diff-removed">-					strokeDasharray={strokeDasharray}</div><div class="diff-removed">-					strokeDashoffset={strokeDashoffset}</div><div class="diff-removed">-					strokeWidth={sw}</div><div class="diff-removed">-					markerStart={</div><div class="diff-removed">-						bindings.start</div><div class="diff-removed">-							? bindings.start.props.isExact</div><div class="diff-removed">-								? ''</div><div class="diff-removed">-								: bindings.start.props.isPrecise</div><div class="diff-removed">-									? `url(#${arrowheadCrossId})`</div><div class="diff-removed">-									: `url(#${arrowheadDotId})`</div><div class="diff-removed">-							: ''</div><div class="diff-removed">-					}</div><div class="diff-removed">-					markerEnd={</div><div class="diff-removed">-						bindings.end</div><div class="diff-removed">-							? bindings.end.props.isExact</div><div class="diff-removed">-								? ''</div><div class="diff-removed">-								: bindings.end.props.isPrecise</div><div class="diff-removed">-									? `url(#${arrowheadCrossId})`</div><div class="diff-removed">-									: `url(#${arrowheadDotId})`</div><div class="diff-removed">-							: ''</div><div class="diff-removed">-					}</div><div class="diff-removed">-					opacity={0.16}</div><div class="diff-removed">-				/></div><div class="diff-removed">-			) : null</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	const { strokeDasharray, strokeDashoffset } = getPerfectDashProps(</div><div class="diff-removed">-		info.isStraight ? info.length : Math.abs(info.bodyArc.length),</div><div class="diff-removed">-		strokeWidth,</div><div class="diff-removed">-		{</div><div class="diff-removed">-			style: shape.props.dash,</div><div class="diff-removed">-			forceSolid: isForceSolid,</div><div class="diff-removed">-		}</div><div class="diff-removed">-	)</div><div class="diff-removed">-</div><div class="diff-removed">-	const labelPosition = getArrowLabelPosition(editor, shape)</div><div class="diff-removed">-</div><div class="diff-removed">-	const clipStartArrowhead = !(info.start.arrowhead === 'none' || info.start.arrowhead === 'arrow')</div><div class="diff-removed">-	const clipEndArrowhead = !(info.end.arrowhead === 'none' || info.end.arrowhead === 'arrow')</div><div class="diff-removed">-</div><div class="diff-removed">-	return (</div><div class="diff-removed">-		<></div><div class="diff-removed">-			{/* Yep */}</div><div class="diff-removed">-			<defs></div><div class="diff-removed">-				<clipPath id={clipPathId}></div><div class="diff-removed">-					<ArrowClipPath</div><div class="diff-removed">-						hasText={shape.props.text.trim().length > 0}</div><div class="diff-removed">-						bounds={bounds}</div><div class="diff-removed">-						labelBounds={labelPosition.box}</div><div class="diff-removed">-						as={clipStartArrowhead && as ? as : ''}</div><div class="diff-removed">-						ae={clipEndArrowhead && ae ? ae : ''}</div><div class="diff-removed">-					/></div><div class="diff-removed">-				</clipPath></div><div class="diff-removed">-			</defs></div><div class="diff-removed">-			<g</div><div class="diff-removed">-				fill="none"</div><div class="diff-removed">-				stroke={theme[shape.props.color].solid}</div><div class="diff-removed">-				strokeWidth={strokeWidth}</div><div class="diff-removed">-				strokeLinejoin="round"</div><div class="diff-removed">-				strokeLinecap="round"</div><div class="diff-removed">-				pointerEvents="none"</div><div class="diff-removed">-			></div><div class="diff-removed">-				{handlePath}</div><div class="diff-removed">-				<g</div><div class="diff-removed">-					style={{</div><div class="diff-removed">-						clipPath: `url(#${clipPathId})`,</div><div class="diff-removed">-						WebkitClipPath: `url(#${clipPathId})`,</div><div class="diff-removed">-					}}</div><div class="diff-removed">-				></div><div class="diff-removed">-					<rect</div><div class="diff-removed">-						x={toDomPrecision(bounds.minX - 100)}</div><div class="diff-removed">-						y={toDomPrecision(bounds.minY - 100)}</div><div class="diff-removed">-						width={toDomPrecision(bounds.width + 200)}</div><div class="diff-removed">-						height={toDomPrecision(bounds.height + 200)}</div><div class="diff-removed">-						opacity={0}</div><div class="diff-removed">-					/></div><div class="diff-removed">-					<path d={path} strokeDasharray={strokeDasharray} strokeDashoffset={strokeDashoffset} /></div><div class="diff-removed">-				</g></div><div class="diff-removed">-				{as && clipStartArrowhead && shape.props.fill !== 'none' && (</div><div class="diff-removed">-					<ShapeFill</div><div class="diff-removed">-						theme={theme}</div><div class="diff-removed">-						d={as}</div><div class="diff-removed">-						color={shape.props.color}</div><div class="diff-removed">-						fill={shape.props.fill}</div><div class="diff-removed">-						scale={shape.props.scale}</div><div class="diff-removed">-					/></div><div class="diff-removed">-				)}</div><div class="diff-removed">-				{ae && clipEndArrowhead && shape.props.fill !== 'none' && (</div><div class="diff-removed">-					<ShapeFill</div><div class="diff-removed">-						theme={theme}</div><div class="diff-removed">-						d={ae}</div><div class="diff-removed">-						color={shape.props.color}</div><div class="diff-removed">-						fill={shape.props.fill}</div><div class="diff-removed">-						scale={shape.props.scale}</div><div class="diff-removed">-					/></div><div class="diff-removed">-				)}</div><div class="diff-removed">-				{as && <path d={as} />}</div><div class="diff-removed">-				{ae && <path d={ae} />}</div><div class="diff-removed">-			</g></div><div class="diff-removed">-		</></div><div class="diff-removed">-	)</div><div class="diff-removed">-})</div><div class="diff-removed">-</div><div class="diff-removed">-function ArrowClipPath({</div><div class="diff-removed">-	hasText,</div><div class="diff-removed">-	bounds,</div><div class="diff-removed">-	labelBounds,</div><div class="diff-removed">-	as,</div><div class="diff-removed">-	ae,</div><div class="diff-removed">-}: {</div><div class="diff-removed">-	hasText: boolean</div><div class="diff-removed">-	bounds: Box</div><div class="diff-removed">-	labelBounds: Box</div><div class="diff-removed">-	as: string</div><div class="diff-removed">-	ae: string</div><div class="diff-removed">-}) {</div><div class="diff-removed">-	// The direction in which we create the different path parts is important, as it determines what gets clipped.</div><div class="diff-removed">-	// See the description on the directions in the non-zero fill rule example:</div><div class="diff-removed">-	// https://developer.mozilla.org/en-US/docs/Web/SVG/Attribute/fill-rule#nonzero</div><div class="diff-removed">-	// We create this one in the clockwise direction</div><div class="diff-removed">-	const boundingBoxPath = `M${toDomPrecision(bounds.minX - 100)},${toDomPrecision(bounds.minY - 100)} h${bounds.width + 200} v${bounds.height + 200} h-${bounds.width + 200} Z`</div><div class="diff-removed">-	// We create this one in the counter-clockwise direction, which cuts out the label box</div><div class="diff-removed">-	const labelBoxPath = `M${toDomPrecision(labelBounds.minX)},${toDomPrecision(labelBounds.minY)} v${labelBounds.height} h${labelBounds.width} v-${labelBounds.height} Z`</div><div class="diff-removed">-	// We also append the arrowhead paths to the clip path, so that we also clip the arrowheads</div><div class="diff-removed">-	return <path d={`${boundingBoxPath}${hasText ? labelBoxPath : ''}${as}${ae}`} /></div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-const shapeAtTranslationStart = new WeakMap<</div><div class="diff-removed">-	TLArrowShape,</div><div class="diff-removed">-	{</div><div class="diff-removed">-		pagePosition: Vec</div><div class="diff-removed">-		terminalBindings: Record<</div><div class="diff-removed">-			'start' | 'end',</div><div class="diff-removed">-			{</div><div class="diff-removed">-				pagePosition: Vec</div><div class="diff-removed">-				shapePosition: Vec</div><div class="diff-removed">-				binding: TLArrowBinding</div><div class="diff-removed">-			} | null</div><div class="diff-removed">-		></div><div class="diff-removed">-	}</div><div class="diff-removed">->()</div><div class="diff-removed">-</div><div class="diff-removed">-function ArrowheadDotDef() {</div><div class="diff-removed">-	const id = useSharedSafeId('arrowhead-dot')</div><div class="diff-removed">-	return (</div><div class="diff-removed">-		<marker id={id} className="tl-arrow-hint" refX="3.0" refY="3.0" orient="0"></div><div class="diff-removed">-			<circle cx="3" cy="3" r="2" strokeDasharray="100%" /></div><div class="diff-removed">-		</marker></div><div class="diff-removed">-	)</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-function ArrowheadCrossDef() {</div><div class="diff-removed">-	const id = useSharedSafeId('arrowhead-cross')</div><div class="diff-removed">-	return (</div><div class="diff-removed">-		<marker id={id} className="tl-arrow-hint" refX="3.0" refY="3.0" orient="auto"></div><div class="diff-removed">-			<line x1="1.5" y1="1.5" x2="4.5" y2="4.5" strokeDasharray="100%" /></div><div class="diff-removed">-			<line x1="1.5" y1="4.5" x2="4.5" y2="1.5" strokeDasharray="100%" /></div><div class="diff-removed">-		</marker></div><div class="diff-removed">-	)</div><div class="diff-added">+  const boundingBoxPath = `M${toDomPrecision(bounds.minX - 100)},${toDomPrecision(bounds.minY - 100)} h${bounds.width + 200} v${bounds.height + 200} h-${bounds.width + 200} Z`</div><div class="diff-added">+  const labelBoxPath = hasText</div><div class="diff-added">+    ? `M${toDomPrecision(labelBounds.minX)},${toDomPrecision(labelBounds.minY)} v${labelBounds.height} h${labelBounds.width} v-${labelBounds.height} Z`</div><div class="diff-added">+    : ''</div><div class="diff-added">+  return <path d={`${boundingBoxPath}${labelBoxPath}${as}${ae}`} /></div><div> }</div></pre>
                </div>
            </div>
        </section>
    </main>
    <footer>
        <p>LoCoDiff-bench - <a href="https://github.com/AbanteAI/LoCoDiff-bench">GitHub Repository</a></p>
    </footer>
</body>
</html>
    