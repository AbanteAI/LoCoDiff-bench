<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case: apps/dotcom/client/src/tla/app/TldrawApp.ts - o4-mini-medium</title>
    <link rel="stylesheet" href="../../styles.css">
</head>
<body>
    <header>
        <h1>Case: apps/dotcom/client/src/tla/app/TldrawApp.ts</h1>
        <p><a href="../../models/openai_o4-mini.html">‚Üê Back to o4-mini-medium Cases</a> | <a href="../../index.html">Home</a></p>
    </header>
    <main>
        <section class="case-details">
            <div class="case-info">
                <h2>Benchmark Case Information</h2>
                <p><strong>Model:</strong> o4-mini-medium</p>
                <p><strong>Status:</strong> <span class="failure">Failure</span></p>
                <p><strong>Prompt Tokens:</strong> 77021</p>
                <p><strong>Output Tokens:</strong> N/A</p>
                <p><strong>Native Prompt Tokens:</strong> 78273</p>
                <p><strong>Native Completion Tokens:</strong> 8551</p>
                <p><strong>Native Tokens Reasoning:</strong> 5184</p>
                <p><strong>Native Finish Reason:</strong> stop</p>
                <p><strong>Cost:</strong> $0.006186235</p>
            </div>
            
            <div class="content-links">
                <h2>View Content</h2>
                <ul>
                    <li><a href="../../content/openai_o4-mini/tldraw_apps_dotcom_client_src_tla_app_TldrawApp.ts/prompt.html" class="content-link">View Prompt</a></li>
                    <li><a href="../../content/openai_o4-mini/tldraw_apps_dotcom_client_src_tla_app_TldrawApp.ts/expected.html" class="content-link">View Expected Output</a></li>
                    <li><a href="../../content/openai_o4-mini/tldraw_apps_dotcom_client_src_tla_app_TldrawApp.ts/actual.html" class="content-link">View Actual Output</a></li>
                </ul>
            </div>
            
            <div class="diff-section">
                <h2>Diff (Expected vs Actual)</h2>
                <div id="diff-output">
                    <pre class="diff"><div></div><div>index 1724dd1c..6d32211c 100644</div><div class="diff-header">--- a/tldraw_apps_dotcom_client_src_tla_app_TldrawApp.ts_expectedoutput.txt (expected):tmp/tmpgt0ehmdv_expected.txt	</div><div class="diff-header">+++ b/tldraw_apps_dotcom_client_src_tla_app_TldrawApp.ts_extracted.txt (actual):tmp/tmp7jvcln28_actual.txt	</div><div class="diff-info">@@ -2,53 +2,43 @@</div><div> import { Zero } from '@rocicorp/zero'</div><div> import { captureException } from '@sentry/react'</div><div> import {</div><div class="diff-removed">-	CreateFilesResponseBody,</div><div class="diff-removed">-	createMutators,</div><div class="diff-removed">-	CreateSnapshotRequestBody,</div><div class="diff-removed">-	LOCAL_FILE_PREFIX,</div><div class="diff-removed">-	MAX_NUMBER_OF_FILES,</div><div class="diff-removed">-	TlaFile,</div><div class="diff-removed">-	TlaFileState,</div><div class="diff-removed">-	TlaMutators,</div><div class="diff-removed">-	TlaSchema,</div><div class="diff-removed">-	TlaUser,</div><div class="diff-removed">-	UserPreferencesKeys,</div><div class="diff-removed">-	Z_PROTOCOL_VERSION,</div><div class="diff-removed">-	schema as zeroSchema,</div><div class="diff-removed">-	ZErrorCode,</div><div class="diff-added">+  CreateFilesResponseBody,</div><div class="diff-added">+  createMutators,</div><div class="diff-added">+  CreateSnapshotRequestBody,</div><div class="diff-added">+  LOCAL_FILE_PREFIX,</div><div class="diff-added">+  MAX_NUMBER_OF_FILES,</div><div class="diff-added">+  TlaFile,</div><div class="diff-added">+  TlaFileState,</div><div class="diff-added">+  TlaSchema,</div><div class="diff-added">+  TlaUser,</div><div class="diff-added">+  UserPreferencesKeys,</div><div class="diff-added">+  Z_PROTOCOL_VERSION,</div><div class="diff-added">+  ZErrorCode,</div><div> } from '@tldraw/dotcom-shared'</div><div> import {</div><div class="diff-removed">-	assert,</div><div class="diff-removed">-	fetch,</div><div class="diff-removed">-	getFromLocalStorage,</div><div class="diff-removed">-	promiseWithResolve,</div><div class="diff-removed">-	Result,</div><div class="diff-removed">-	setInLocalStorage,</div><div class="diff-removed">-	structuredClone,</div><div class="diff-removed">-	throttle,</div><div class="diff-removed">-	uniqueId,</div><div class="diff-added">+  assert,</div><div class="diff-added">+  fetch,</div><div class="diff-added">+  getFromLocalStorage,</div><div class="diff-added">+  promiseWithResolve,</div><div class="diff-added">+  Result,</div><div class="diff-added">+  setInLocalStorage,</div><div class="diff-added">+  structuredClone,</div><div class="diff-added">+  throttle,</div><div class="diff-added">+  uniqueId,</div><div> } from '@tldraw/utils'</div><div> import pick from 'lodash.pick'</div><div> import {</div><div class="diff-removed">-	assertExists,</div><div class="diff-removed">-	Atom,</div><div class="diff-removed">-	atom,</div><div class="diff-removed">-	computed,</div><div class="diff-removed">-	createTLSchema,</div><div class="diff-removed">-	createTLUser,</div><div class="diff-removed">-	dataUrlToFile,</div><div class="diff-removed">-	defaultUserPreferences,</div><div class="diff-removed">-	getUserPreferences,</div><div class="diff-removed">-	objectMapFromEntries,</div><div class="diff-removed">-	objectMapKeys,</div><div class="diff-removed">-	parseTldrawJsonFile,</div><div class="diff-removed">-	react,</div><div class="diff-removed">-	Signal,</div><div class="diff-removed">-	TLDocument,</div><div class="diff-removed">-	TLSessionStateSnapshot,</div><div class="diff-removed">-	TLUiToastsContextType,</div><div class="diff-removed">-	TLUserPreferences,</div><div class="diff-removed">-	transact,</div><div class="diff-added">+  Atom,</div><div class="diff-added">+  atom,</div><div class="diff-added">+  computed,</div><div class="diff-added">+  createTLSchema,</div><div class="diff-added">+  react,</div><div class="diff-added">+  Signal,</div><div class="diff-added">+  TLDocument,</div><div class="diff-added">+  TLSessionStateSnapshot,</div><div class="diff-added">+  TLUiToastsContextType,</div><div class="diff-added">+  TLUserPreferences,</div><div class="diff-added">+  transact,</div><div> } from 'tldraw'</div><div> import { MULTIPLAYER_SERVER, ZERO_SERVER } from '../../utils/config'</div><div> import { multiplayerAssetStore } from '../../utils/multiplayerAssetStore'</div><div class="diff-info">@@ -56,837 +46,384 @@ import { getScratchPersistenceKey } from '../../utils/scratch-persistence-key'</div><div> import { TLAppUiContextType } from '../utils/app-ui-events'</div><div> import { getDateFormat } from '../utils/dates'</div><div> import { createIntl, defineMessages, setupCreateIntl } from '../utils/i18n'</div><div class="diff-removed">-import { updateLocalSessionState } from '../utils/local-session-state'</div><div class="diff-removed">-import { Zero as ZeroPolyfill } from './zero-polyfill'</div><div class="diff-added">+import { updateLocalSessionState, getLocalSessionStateUnsafe } from '../utils/local-session-state'</div><div> </div><div> export const TLDR_FILE_ENDPOINT = `/api/app/tldr`</div><div> export const PUBLISH_ENDPOINT = `/api/app/publish`</div><div> </div><div> let appId = 0</div><div class="diff-added">+</div><div> const useProperZero = getFromLocalStorage('useProperZero') === 'true'</div><div> // eslint-disable-next-line no-console</div><div> console.log('useProperZero', useProperZero)</div><div> // @ts-expect-error</div><div> window.zero = () => {</div><div class="diff-removed">-	setInLocalStorage('useProperZero', String(!useProperZero))</div><div class="diff-removed">-	location.reload()</div><div class="diff-added">+  setInLocalStorage('useProperZero', String(!useProperZero))</div><div class="diff-added">+  location.reload()</div><div> }</div><div> </div><div> export class TldrawApp {</div><div class="diff-removed">-	config = {</div><div class="diff-removed">-		maxNumberOfFiles: MAX_NUMBER_OF_FILES,</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	readonly id = appId++</div><div class="diff-removed">-</div><div class="diff-removed">-	readonly z: ZeroPolyfill | Zero<TlaSchema, TlaMutators></div><div class="diff-removed">-</div><div class="diff-removed">-	private readonly user$: Signal<TlaUser | undefined></div><div class="diff-removed">-	private readonly fileStates$: Signal<(TlaFileState & { file: TlaFile })[]></div><div class="diff-removed">-</div><div class="diff-removed">-	private readonly abortController = new AbortController()</div><div class="diff-removed">-	readonly disposables: (() => void)[] = [() => this.abortController.abort(), () => this.z.close()]</div><div class="diff-removed">-</div><div class="diff-removed">-	changes: Map<Atom<any, unknown>, any> = new Map()</div><div class="diff-removed">-	changesFlushed = null as null | ReturnType<typeof promiseWithResolve></div><div class="diff-removed">-</div><div class="diff-removed">-	private signalizeQuery<TReturn>(name: string, query: any): Signal<TReturn> {</div><div class="diff-removed">-		// fail if closed?</div><div class="diff-removed">-		const view = query.materialize()</div><div class="diff-removed">-		const val$ = atom(name, view.data)</div><div class="diff-removed">-		view.addListener((res: any) => {</div><div class="diff-removed">-			this.changes.set(val$, structuredClone(res))</div><div class="diff-removed">-			if (!this.changesFlushed) {</div><div class="diff-removed">-				this.changesFlushed = promiseWithResolve()</div><div class="diff-removed">-			}</div><div class="diff-removed">-			queueMicrotask(() => {</div><div class="diff-removed">-				transact(() => {</div><div class="diff-removed">-					this.changes.forEach((value, key) => {</div><div class="diff-removed">-						key.set(value)</div><div class="diff-removed">-					})</div><div class="diff-removed">-					this.changes.clear()</div><div class="diff-removed">-				})</div><div class="diff-removed">-				this.changesFlushed?.resolve(undefined)</div><div class="diff-removed">-				this.changesFlushed = null</div><div class="diff-removed">-			})</div><div class="diff-removed">-		})</div><div class="diff-removed">-		this.disposables.push(() => {</div><div class="diff-removed">-			view.destroy()</div><div class="diff-removed">-		})</div><div class="diff-removed">-		return val$</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	toasts: TLUiToastsContextType | null = null</div><div class="diff-removed">-</div><div class="diff-removed">-	private constructor(</div><div class="diff-removed">-		public readonly userId: string,</div><div class="diff-removed">-		getToken: () => Promise<string | undefined>,</div><div class="diff-removed">-		onClientTooOld: () => void,</div><div class="diff-removed">-		trackEvent: TLAppUiContextType</div><div class="diff-removed">-	) {</div><div class="diff-removed">-		const sessionId = uniqueId()</div><div class="diff-removed">-		this.z = useProperZero</div><div class="diff-removed">-			? new Zero<TlaSchema, TlaMutators>({</div><div class="diff-removed">-					auth: getToken,</div><div class="diff-removed">-					userID: userId,</div><div class="diff-removed">-					schema: zeroSchema,</div><div class="diff-removed">-					server: ZERO_SERVER,</div><div class="diff-removed">-					mutators: createMutators(userId),</div><div class="diff-removed">-					onUpdateNeeded(reason) {</div><div class="diff-removed">-						console.error('update needed', reason)</div><div class="diff-removed">-						onClientTooOld()</div><div class="diff-removed">-					},</div><div class="diff-removed">-					kvStore: window.navigator.webdriver ? 'mem' : 'idb',</div><div class="diff-removed">-				})</div><div class="diff-removed">-			: new ZeroPolyfill({</div><div class="diff-removed">-					userId,</div><div class="diff-removed">-					// auth: encodedJWT,</div><div class="diff-removed">-					getUri: async () => {</div><div class="diff-removed">-						const params = new URLSearchParams({</div><div class="diff-removed">-							sessionId,</div><div class="diff-removed">-							protocolVersion: String(Z_PROTOCOL_VERSION),</div><div class="diff-removed">-						})</div><div class="diff-removed">-						const token = await getToken()</div><div class="diff-removed">-						params.set('accessToken', token || 'no-token-found')</div><div class="diff-removed">-						return `${MULTIPLAYER_SERVER}/app/${userId}/connect?${params}`</div><div class="diff-removed">-					},</div><div class="diff-removed">-					// schema,</div><div class="diff-removed">-					// This is often easier to develop with if you're frequently changing</div><div class="diff-removed">-					// the schema. Switch to 'idb' for local-persistence.</div><div class="diff-removed">-					onMutationRejected: this.showMutationRejectionToast,</div><div class="diff-removed">-					onClientTooOld: () => onClientTooOld(),</div><div class="diff-removed">-					trackEvent,</div><div class="diff-removed">-				})</div><div class="diff-removed">-</div><div class="diff-removed">-		this.user$ = this.signalizeQuery('user signal', this.userQuery())</div><div class="diff-removed">-		this.fileStates$ = this.signalizeQuery('file states signal', this.fileStateQuery())</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	private userQuery() {</div><div class="diff-removed">-		return this.z.query.user.where('id', '=', this.userId).one()</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	private fileStateQuery() {</div><div class="diff-removed">-		return this.z.query.file_state</div><div class="diff-removed">-			.where('userId', '=', this.userId)</div><div class="diff-removed">-			.related('file', (q: any) => q.one())</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	async preload(initialUserData: TlaUser) {</div><div class="diff-removed">-		let didCreate = false</div><div class="diff-removed">-		await this.userQuery().preload().complete</div><div class="diff-removed">-		await this.changesFlushed</div><div class="diff-removed">-		if (!this.user$.get()) {</div><div class="diff-removed">-			didCreate = true</div><div class="diff-removed">-			this.z.mutate.user.insert(initialUserData)</div><div class="diff-removed">-			updateLocalSessionState((state) => ({ ...state, shouldShowWelcomeDialog: true }))</div><div class="diff-removed">-		}</div><div class="diff-removed">-		await new Promise((resolve) => {</div><div class="diff-removed">-			let unsub = () => {}</div><div class="diff-removed">-			unsub = react('wait for user', () => this.user$.get() && resolve(unsub()))</div><div class="diff-removed">-		})</div><div class="diff-removed">-		if (!this.user$.get()) {</div><div class="diff-removed">-			throw Error('could not create user')</div><div class="diff-removed">-		}</div><div class="diff-removed">-		await this.fileStateQuery().preload().complete</div><div class="diff-removed">-		return didCreate</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	messages = defineMessages({</div><div class="diff-removed">-		// toast title</div><div class="diff-removed">-		mutation_error_toast_title: { defaultMessage: 'Error' },</div><div class="diff-removed">-		// toast descriptions</div><div class="diff-removed">-		publish_failed: {</div><div class="diff-removed">-			defaultMessage: 'Unable to publish the file.',</div><div class="diff-removed">-		},</div><div class="diff-removed">-		unpublish_failed: {</div><div class="diff-removed">-			defaultMessage: 'Unable to unpublish the file.',</div><div class="diff-removed">-		},</div><div class="diff-removed">-		republish_failed: {</div><div class="diff-removed">-			defaultMessage: 'Unable to publish the changes.',</div><div class="diff-removed">-		},</div><div class="diff-removed">-		unknown_error: {</div><div class="diff-removed">-			defaultMessage: 'An unexpected error occurred.',</div><div class="diff-removed">-		},</div><div class="diff-removed">-		forbidden: {</div><div class="diff-removed">-			defaultMessage: 'You do not have the necessary permissions to perform this action.',</div><div class="diff-removed">-		},</div><div class="diff-removed">-		bad_request: {</div><div class="diff-removed">-			defaultMessage: 'Invalid request.',</div><div class="diff-removed">-		},</div><div class="diff-removed">-		rate_limit_exceeded: {</div><div class="diff-removed">-			defaultMessage: 'Rate limit exceeded, try again later.',</div><div class="diff-removed">-		},</div><div class="diff-removed">-		client_too_old: {</div><div class="diff-removed">-			defaultMessage: 'Please refresh the page to get the latest version of tldraw.',</div><div class="diff-removed">-		},</div><div class="diff-removed">-		max_files_title: {</div><div class="diff-removed">-			defaultMessage: 'File limit reached',</div><div class="diff-removed">-		},</div><div class="diff-removed">-		max_files_reached: {</div><div class="diff-removed">-			defaultMessage:</div><div class="diff-removed">-				'You have reached the maximum number of files. You need to delete old files before creating new ones.',</div><div class="diff-removed">-		},</div><div class="diff-removed">-		uploadingTldrFiles: {</div><div class="diff-removed">-			defaultMessage:</div><div class="diff-removed">-				'{total, plural, one {Uploading .tldr file‚Ä¶} other {Uploading {uploaded} of {total} .tldr files‚Ä¶}}',</div><div class="diff-removed">-		},</div><div class="diff-removed">-		addingTldrFiles: {</div><div class="diff-removed">-			// no need for pluralization, if there was only one file we navigated to it</div><div class="diff-removed">-			// so there's no need to show a toast.</div><div class="diff-removed">-			defaultMessage: 'Added {total} .tldr files.',</div><div class="diff-removed">-		},</div><div class="diff-removed">-	})</div><div class="diff-removed">-</div><div class="diff-removed">-	getMessage(id: keyof typeof this.messages) {</div><div class="diff-removed">-		let msg = this.messages[id]</div><div class="diff-removed">-		if (!msg) {</div><div class="diff-removed">-			console.error('Could not find a translation for this error code', id)</div><div class="diff-removed">-			msg = this.messages.unknown_error</div><div class="diff-removed">-		}</div><div class="diff-removed">-		return msg</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	showMutationRejectionToast = throttle((errorCode: ZErrorCode) => {</div><div class="diff-removed">-		const descriptor = this.getMessage(errorCode)</div><div class="diff-removed">-		this.toasts?.addToast({</div><div class="diff-removed">-			title: this.getIntl().formatMessage(this.messages.mutation_error_toast_title),</div><div class="diff-removed">-			description: this.getIntl().formatMessage(descriptor),</div><div class="diff-removed">-		})</div><div class="diff-removed">-	}, 3000)</div><div class="diff-removed">-</div><div class="diff-removed">-	dispose() {</div><div class="diff-removed">-		this.disposables.forEach((d) => d())</div><div class="diff-removed">-		// this.store.dispose()</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	getUser() {</div><div class="diff-removed">-		return assertExists(this.user$.get(), 'no user')</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	tlUser = createTLUser({</div><div class="diff-removed">-		userPreferences: computed('user prefs', () => {</div><div class="diff-removed">-			const user = this.getUser()</div><div class="diff-removed">-			return {</div><div class="diff-removed">-				...(pick(user, UserPreferencesKeys) as TLUserPreferences),</div><div class="diff-removed">-				id: this.userId,</div><div class="diff-removed">-			}</div><div class="diff-removed">-		}),</div><div class="diff-removed">-		setUserPreferences: ({ id: _, ...others }: Partial<TLUserPreferences>) => {</div><div class="diff-removed">-			const user = this.getUser()</div><div class="diff-removed">-</div><div class="diff-removed">-			const nonNull = Object.fromEntries(</div><div class="diff-removed">-				Object.entries(others).filter(([_, value]) => value !== null)</div><div class="diff-removed">-			) as Partial<TLUserPreferences></div><div class="diff-removed">-</div><div class="diff-removed">-			this.z.mutate.user.update({</div><div class="diff-removed">-				id: user.id,</div><div class="diff-removed">-				...(nonNull as any),</div><div class="diff-removed">-			})</div><div class="diff-removed">-		},</div><div class="diff-removed">-	})</div><div class="diff-removed">-</div><div class="diff-removed">-	getUserOwnFiles() {</div><div class="diff-removed">-		const fileStates = this.getUserFileStates()</div><div class="diff-removed">-		const files: TlaFile[] = []</div><div class="diff-removed">-		fileStates.forEach((f) => {</div><div class="diff-removed">-			if (f.file) files.push(f.file)</div><div class="diff-removed">-		})</div><div class="diff-removed">-		return files</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	getUserFileStates() {</div><div class="diff-removed">-		return this.fileStates$.get()</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	lastRecentFileOrdering = null as null | Array<{</div><div class="diff-removed">-		fileId: TlaFile['id']</div><div class="diff-removed">-		isPinned: boolean</div><div class="diff-removed">-		date: number</div><div class="diff-removed">-	}></div><div class="diff-removed">-</div><div class="diff-removed">-	@computed</div><div class="diff-removed">-	getUserRecentFiles() {</div><div class="diff-removed">-		const myFiles = objectMapFromEntries(this.getUserOwnFiles().map((f) => [f.id, f]))</div><div class="diff-removed">-		const myStates = objectMapFromEntries(this.getUserFileStates().map((f) => [f.fileId, f]))</div><div class="diff-removed">-</div><div class="diff-removed">-		const myFileIds = new Set<string>([...objectMapKeys(myFiles), ...objectMapKeys(myStates)])</div><div class="diff-removed">-</div><div class="diff-removed">-		const nextRecentFileOrdering: {</div><div class="diff-removed">-			fileId: TlaFile['id']</div><div class="diff-removed">-			isPinned: boolean</div><div class="diff-removed">-			date: number</div><div class="diff-removed">-		}[] = []</div><div class="diff-removed">-</div><div class="diff-removed">-		for (const fileId of myFileIds) {</div><div class="diff-removed">-			const file = myFiles[fileId]</div><div class="diff-removed">-			let state: (typeof myStates)[string] | undefined = myStates[fileId]</div><div class="diff-removed">-			if (!file) continue</div><div class="diff-removed">-			if (!state && !file.isDeleted && file.ownerId === this.userId) {</div><div class="diff-removed">-				// create a file state for this file</div><div class="diff-removed">-				// this allows us to 'undelete' soft-deleted files by manually toggling 'isDeleted' in the backend</div><div class="diff-removed">-				state = this.fileStates$.get().find((fs) => fs.fileId === fileId)</div><div class="diff-removed">-			}</div><div class="diff-removed">-			if (!state) {</div><div class="diff-removed">-				// if the file is deleted, we don't want to show it in the recent files</div><div class="diff-removed">-				continue</div><div class="diff-removed">-			}</div><div class="diff-removed">-			const existing = this.lastRecentFileOrdering?.find((f) => f.fileId === fileId)</div><div class="diff-removed">-			if (existing && existing.isPinned === state.isPinned) {</div><div class="diff-removed">-				nextRecentFileOrdering.push(existing)</div><div class="diff-removed">-				continue</div><div class="diff-removed">-			}</div><div class="diff-removed">-</div><div class="diff-removed">-			nextRecentFileOrdering.push({</div><div class="diff-removed">-				fileId,</div><div class="diff-removed">-				isPinned: state.isPinned ?? false,</div><div class="diff-removed">-				date: state.lastEditAt ?? state.firstVisitAt ?? file.createdAt ?? 0,</div><div class="diff-removed">-			})</div><div class="diff-removed">-		}</div><div class="diff-removed">-</div><div class="diff-removed">-		// sort by date with most recent first</div><div class="diff-removed">-		nextRecentFileOrdering.sort((a, b) => b.date - a.date)</div><div class="diff-removed">-</div><div class="diff-removed">-		// stash the ordering for next time</div><div class="diff-removed">-		this.lastRecentFileOrdering = nextRecentFileOrdering</div><div class="diff-removed">-</div><div class="diff-removed">-		return nextRecentFileOrdering</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	getUserSharedFiles() {</div><div class="diff-removed">-		return Array.from(</div><div class="diff-removed">-			new Set(</div><div class="diff-removed">-				this.getUserFileStates()</div><div class="diff-removed">-					.map((s) => {</div><div class="diff-removed">-						// skip files where the owner is the current user</div><div class="diff-removed">-						if (s.file!.ownerId === this.userId) return</div><div class="diff-removed">-						return s.file</div><div class="diff-removed">-					})</div><div class="diff-removed">-					.filter(Boolean) as TlaFile[]</div><div class="diff-removed">-			)</div><div class="diff-removed">-		)</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	private canCreateNewFile() {</div><div class="diff-removed">-		const numberOfFiles = this.getUserOwnFiles().length</div><div class="diff-removed">-		return numberOfFiles < this.config.maxNumberOfFiles</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	private showMaxFilesToast() {</div><div class="diff-removed">-		this.toasts?.addToast({</div><div class="diff-removed">-			title: this.getIntl().formatMessage(this.messages.max_files_title),</div><div class="diff-removed">-			description: this.getIntl().formatMessage(this.messages.max_files_reached),</div><div class="diff-removed">-			keepOpen: true,</div><div class="diff-removed">-		})</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	async createFile(</div><div class="diff-removed">-		fileOrId?: string | Partial<TlaFile></div><div class="diff-removed">-	): Promise<Result<{ file: TlaFile }, 'max number of files reached'>> {</div><div class="diff-removed">-		if (!this.canCreateNewFile()) {</div><div class="diff-removed">-			this.showMaxFilesToast()</div><div class="diff-removed">-			return Result.err('max number of files reached')</div><div class="diff-removed">-		}</div><div class="diff-removed">-</div><div class="diff-removed">-		const file: TlaFile = {</div><div class="diff-removed">-			id: typeof fileOrId === 'string' ? fileOrId : uniqueId(),</div><div class="diff-removed">-			ownerId: this.userId,</div><div class="diff-removed">-			// these two owner properties are overridden by postgres triggers</div><div class="diff-removed">-			ownerAvatar: this.getUser().avatar,</div><div class="diff-removed">-			ownerName: this.getUser().name,</div><div class="diff-removed">-			isEmpty: true,</div><div class="diff-removed">-			createdAt: Date.now(),</div><div class="diff-removed">-			lastPublished: 0,</div><div class="diff-removed">-			name: this.getFallbackFileName(Date.now()),</div><div class="diff-removed">-			published: false,</div><div class="diff-removed">-			publishedSlug: uniqueId(),</div><div class="diff-removed">-			shared: true,</div><div class="diff-removed">-			sharedLinkType: 'edit',</div><div class="diff-removed">-			thumbnail: '',</div><div class="diff-removed">-			updatedAt: Date.now(),</div><div class="diff-removed">-			isDeleted: false,</div><div class="diff-removed">-			createSource: null,</div><div class="diff-removed">-		}</div><div class="diff-removed">-		if (typeof fileOrId === 'object') {</div><div class="diff-removed">-			Object.assign(file, fileOrId)</div><div class="diff-removed">-			if (!file.name) {</div><div class="diff-removed">-				Object.assign(file, { name: this.getFallbackFileName(file.createdAt) })</div><div class="diff-removed">-			}</div><div class="diff-removed">-		}</div><div class="diff-removed">-		const fileState = {</div><div class="diff-removed">-			isFileOwner: true,</div><div class="diff-removed">-			fileId: file.id,</div><div class="diff-removed">-			userId: this.userId,</div><div class="diff-removed">-			firstVisitAt: null,</div><div class="diff-removed">-			isPinned: false,</div><div class="diff-removed">-			lastEditAt: null,</div><div class="diff-removed">-			lastSessionState: null,</div><div class="diff-removed">-			lastVisitAt: null,</div><div class="diff-removed">-		}</div><div class="diff-removed">-		await this.z.mutate.file.insertWithFileState({ file, fileState })</div><div class="diff-removed">-		// todo: add server error handling for real Zero</div><div class="diff-removed">-		// .server.catch((res: { error: string; details: string }) => {</div><div class="diff-removed">-		// 	if (res.details === ZErrorCode.max_files_reached) {</div><div class="diff-removed">-		// 		this.showMaxFilesToast()</div><div class="diff-removed">-		// 	}</div><div class="diff-removed">-		// })</div><div class="diff-removed">-</div><div class="diff-removed">-		return Result.ok({ file })</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	getFallbackFileName(time: number) {</div><div class="diff-removed">-		const createdAt = new Date(time)</div><div class="diff-removed">-		const format = getDateFormat(createdAt)</div><div class="diff-removed">-		return this.getIntl().formatDate(createdAt, format)</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	getFileName(file: TlaFile | string | null, useDateFallback: false): string | undefined</div><div class="diff-removed">-	getFileName(file: TlaFile | string | null, useDateFallback?: true): string</div><div class="diff-removed">-	getFileName(file: TlaFile | string | null, useDateFallback = true) {</div><div class="diff-removed">-		if (typeof file === 'string') {</div><div class="diff-removed">-			file = this.getFile(file)</div><div class="diff-removed">-		}</div><div class="diff-removed">-		if (!file) {</div><div class="diff-removed">-			// possibly a published file</div><div class="diff-removed">-			return ''</div><div class="diff-removed">-		}</div><div class="diff-removed">-		assert(typeof file !== 'string', 'ok')</div><div class="diff-removed">-</div><div class="diff-removed">-		if (typeof file.name === 'undefined') {</div><div class="diff-removed">-			captureException(new Error('file name is undefined somehow: ' + JSON.stringify(file)))</div><div class="diff-removed">-		}</div><div class="diff-removed">-		// need a ? here because we were seeing issues on sentry where file.name was undefined</div><div class="diff-removed">-		const name = file.name?.trim()</div><div class="diff-removed">-		if (name) {</div><div class="diff-removed">-			return name</div><div class="diff-removed">-		}</div><div class="diff-removed">-</div><div class="diff-removed">-		if (useDateFallback) {</div><div class="diff-removed">-			return this.getFallbackFileName(file.createdAt)</div><div class="diff-removed">-		}</div><div class="diff-removed">-</div><div class="diff-removed">-		return</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	async slurpFile() {</div><div class="diff-removed">-		return await this.createFile({</div><div class="diff-removed">-			createSource: `${LOCAL_FILE_PREFIX}/${getScratchPersistenceKey()}`,</div><div class="diff-removed">-		})</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	getFilePk(fileId: string) {</div><div class="diff-removed">-		const file = this.getFile(fileId)</div><div class="diff-removed">-		return { id: fileId, ownerId: file!.ownerId, publishedSlug: file!.publishedSlug }</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	toggleFileShared(fileId: string) {</div><div class="diff-removed">-		const file = this.getUserOwnFiles().find((f) => f.id === fileId)</div><div class="diff-removed">-		if (!file) throw Error('no file with id ' + fileId)</div><div class="diff-removed">-</div><div class="diff-removed">-		if (file.ownerId !== this.userId) throw Error('user cannot edit that file')</div><div class="diff-removed">-</div><div class="diff-removed">-		this.z.mutate.file.update({</div><div class="diff-removed">-			id: fileId,</div><div class="diff-removed">-			shared: !file.shared,</div><div class="diff-removed">-		})</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	/**</div><div class="diff-removed">-	 * Publish a file or re-publish changes.</div><div class="diff-removed">-	 *</div><div class="diff-removed">-	 * @param fileId - The file id to unpublish.</div><div class="diff-removed">-	 * @returns A result indicating success or failure.</div><div class="diff-removed">-	 */</div><div class="diff-removed">-	publishFile(fileId: string) {</div><div class="diff-removed">-		const file = this.getUserOwnFiles().find((f) => f.id === fileId)</div><div class="diff-removed">-		if (!file) throw Error(`No file with that id`)</div><div class="diff-removed">-		if (file.ownerId !== this.userId) throw Error('user cannot publish that file')</div><div class="diff-removed">-</div><div class="diff-removed">-		// We're going to bake the name of the file, if it's undefined</div><div class="diff-removed">-		const name = this.getFileName(file)</div><div class="diff-removed">-</div><div class="diff-removed">-		// Optimistic update</div><div class="diff-removed">-		this.z.mutate.file.update({</div><div class="diff-removed">-			id: fileId,</div><div class="diff-removed">-			name,</div><div class="diff-removed">-			published: true,</div><div class="diff-removed">-			lastPublished: Date.now(),</div><div class="diff-removed">-		})</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	getFile(fileId?: string): TlaFile | null {</div><div class="diff-removed">-		if (!fileId) return null</div><div class="diff-removed">-		return this.getUserOwnFiles().find((f) => f.id === fileId) ?? null</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	isFileOwner(fileId: string) {</div><div class="diff-removed">-		const file = this.getFile(fileId)</div><div class="diff-removed">-		return file && file.ownerId === this.userId</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	requireFile(fileId: string): TlaFile {</div><div class="diff-removed">-		return assertExists(this.getFile(fileId), 'no file with id ' + fileId)</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	/**</div><div class="diff-removed">-	 * Unpublish a file.</div><div class="diff-removed">-	 *</div><div class="diff-removed">-	 * @param fileId - The file id to unpublish.</div><div class="diff-removed">-	 * @returns A result indicating success or failure.</div><div class="diff-removed">-	 */</div><div class="diff-removed">-	unpublishFile(fileId: string) {</div><div class="diff-removed">-		const file = this.requireFile(fileId)</div><div class="diff-removed">-		if (file.ownerId !== this.userId) throw Error('user cannot edit that file')</div><div class="diff-removed">-</div><div class="diff-removed">-		if (!file.published) return Result.ok('success')</div><div class="diff-removed">-</div><div class="diff-removed">-		// Optimistic update</div><div class="diff-removed">-		this.z.mutate.file.update({</div><div class="diff-removed">-			id: fileId,</div><div class="diff-removed">-			published: false,</div><div class="diff-removed">-		})</div><div class="diff-removed">-</div><div class="diff-removed">-		return Result.ok('success')</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	/**</div><div class="diff-removed">-	 * Remove a user's file states for a file and delete the file if the user is the owner of the file.</div><div class="diff-removed">-	 *</div><div class="diff-removed">-	 * @param fileId - The file id.</div><div class="diff-removed">-	 */</div><div class="diff-removed">-	async deleteOrForgetFile(fileId: string) {</div><div class="diff-removed">-		const file = this.getFile(fileId)</div><div class="diff-removed">-		if (!file) return</div><div class="diff-removed">-</div><div class="diff-removed">-		// Optimistic update, remove file and file states</div><div class="diff-removed">-		await this.z.mutate.file.deleteOrForget(file)</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	/**</div><div class="diff-removed">-	 * Pin a file (or unpin it if it's already pinned).</div><div class="diff-removed">-	 *</div><div class="diff-removed">-	 * @param fileId - The file id.</div><div class="diff-removed">-	 */</div><div class="diff-removed">-	async pinOrUnpinFile(fileId: string) {</div><div class="diff-removed">-		const fileState = this.getFileState(fileId)</div><div class="diff-removed">-</div><div class="diff-removed">-		if (!fileState) return</div><div class="diff-removed">-</div><div class="diff-removed">-		return this.z.mutate.file_state.update({</div><div class="diff-removed">-			fileId,</div><div class="diff-removed">-			userId: this.userId,</div><div class="diff-removed">-			isPinned: !fileState.isPinned,</div><div class="diff-removed">-		})</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	setFileSharedLinkType(fileId: string, sharedLinkType: TlaFile['sharedLinkType'] | 'no-access') {</div><div class="diff-removed">-		const file = this.requireFile(fileId)</div><div class="diff-removed">-</div><div class="diff-removed">-		if (this.userId !== file.ownerId) {</div><div class="diff-removed">-			throw Error('user cannot edit that file')</div><div class="diff-removed">-		}</div><div class="diff-removed">-</div><div class="diff-removed">-		if (sharedLinkType === 'no-access') {</div><div class="diff-removed">-			this.z.mutate.file.update({ id: fileId, shared: false })</div><div class="diff-removed">-			return</div><div class="diff-removed">-		}</div><div class="diff-removed">-		this.z.mutate.file.update({ id: fileId, shared: true, sharedLinkType })</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	updateUser(partial: Partial<TlaUser>) {</div><div class="diff-removed">-		const user = this.getUser()</div><div class="diff-removed">-		return this.z.mutate.user.update({</div><div class="diff-removed">-			id: user.id,</div><div class="diff-removed">-			...partial,</div><div class="diff-removed">-		})</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	updateUserExportPreferences(</div><div class="diff-removed">-		exportPreferences: Partial<</div><div class="diff-removed">-			Pick<TlaUser, 'exportFormat' | 'exportPadding' | 'exportBackground' | 'exportTheme'></div><div class="diff-removed">-		></div><div class="diff-removed">-	) {</div><div class="diff-removed">-		this.updateUser(exportPreferences)</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	async createFileStateIfNotExists(fileId: string) {</div><div class="diff-removed">-		await this.changesFlushed</div><div class="diff-removed">-		const fileState = this.getFileState(fileId)</div><div class="diff-removed">-		if (!fileState) {</div><div class="diff-removed">-			const fs: TlaFileState = {</div><div class="diff-removed">-				fileId,</div><div class="diff-removed">-				userId: this.userId,</div><div class="diff-removed">-				firstVisitAt: Date.now(),</div><div class="diff-removed">-				lastEditAt: null,</div><div class="diff-removed">-				lastSessionState: null,</div><div class="diff-removed">-				lastVisitAt: null,</div><div class="diff-removed">-				isPinned: false,</div><div class="diff-removed">-				// doesn't really matter what this is because it is</div><div class="diff-removed">-				// overwritten by postgres</div><div class="diff-removed">-				isFileOwner: this.isFileOwner(fileId),</div><div class="diff-removed">-			}</div><div class="diff-removed">-			this.z.mutate.file_state.insert(fs)</div><div class="diff-removed">-		}</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	getFileState(fileId: string) {</div><div class="diff-removed">-		return this.getUserFileStates().find((f) => f.fileId === fileId)</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	updateFileState(fileId: string, partial: Partial<TlaFileState>) {</div><div class="diff-removed">-		const fileState = this.getFileState(fileId)</div><div class="diff-removed">-		if (!fileState) return</div><div class="diff-removed">-		this.z.mutate.file_state.update({ ...partial, fileId, userId: fileState.userId })</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	updateFile(fileId: string, partial: Partial<TlaFile>) {</div><div class="diff-removed">-		this.z.mutate.file.update({ id: fileId, ...partial })</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	async onFileEnter(fileId: string) {</div><div class="diff-removed">-		await this.createFileStateIfNotExists(fileId)</div><div class="diff-removed">-		this.updateFileState(fileId, {</div><div class="diff-removed">-			lastVisitAt: Date.now(),</div><div class="diff-removed">-		})</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	onFileEdit(fileId: string) {</div><div class="diff-removed">-		this.updateFileState(fileId, { lastEditAt: Date.now() })</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	onFileSessionStateUpdate(fileId: string, sessionState: TLSessionStateSnapshot) {</div><div class="diff-removed">-		this.updateFileState(fileId, {</div><div class="diff-removed">-			lastSessionState: JSON.stringify(sessionState),</div><div class="diff-removed">-			lastVisitAt: Date.now(),</div><div class="diff-removed">-		})</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	onFileExit(fileId: string) {</div><div class="diff-removed">-		this.updateFileState(fileId, { lastVisitAt: Date.now() })</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	static async create(opts: {</div><div class="diff-removed">-		userId: string</div><div class="diff-removed">-		fullName: string</div><div class="diff-removed">-		email: string</div><div class="diff-removed">-		avatar: string</div><div class="diff-removed">-		getToken(): Promise<string | undefined></div><div class="diff-removed">-		onClientTooOld(): void</div><div class="diff-removed">-		trackEvent: TLAppUiContextType</div><div class="diff-removed">-	}) {</div><div class="diff-removed">-		// This is an issue: we may have a user record but not in the store.</div><div class="diff-removed">-		// Could be just old accounts since before the server had a version</div><div class="diff-removed">-		// of the store... but we should probably identify that better.</div><div class="diff-removed">-</div><div class="diff-removed">-		const { id: _id, name: _name, color, ...restOfPreferences } = getUserPreferences()</div><div class="diff-removed">-		const app = new TldrawApp(opts.userId, opts.getToken, opts.onClientTooOld, opts.trackEvent)</div><div class="diff-removed">-		// @ts-expect-error</div><div class="diff-removed">-		window.app = app</div><div class="diff-removed">-		const didCreate = await app.preload({</div><div class="diff-removed">-			id: opts.userId,</div><div class="diff-removed">-			name: opts.fullName,</div><div class="diff-removed">-			email: opts.email,</div><div class="diff-removed">-			color: color ?? defaultUserPreferences.color,</div><div class="diff-removed">-			avatar: opts.avatar,</div><div class="diff-removed">-			exportFormat: 'png',</div><div class="diff-removed">-			exportTheme: 'light',</div><div class="diff-removed">-			exportBackground: false,</div><div class="diff-removed">-			exportPadding: false,</div><div class="diff-removed">-			createdAt: Date.now(),</div><div class="diff-removed">-			updatedAt: Date.now(),</div><div class="diff-removed">-			flags: '',</div><div class="diff-removed">-			allowAnalyticsCookie: null,</div><div class="diff-removed">-			...restOfPreferences,</div><div class="diff-removed">-			locale: restOfPreferences.locale ?? null,</div><div class="diff-removed">-			animationSpeed: restOfPreferences.animationSpeed ?? null,</div><div class="diff-removed">-			edgeScrollSpeed: restOfPreferences.edgeScrollSpeed ?? null,</div><div class="diff-removed">-			colorScheme: restOfPreferences.colorScheme ?? null,</div><div class="diff-removed">-			isSnapMode: restOfPreferences.isSnapMode ?? null,</div><div class="diff-removed">-			isWrapMode: restOfPreferences.isWrapMode ?? null,</div><div class="diff-removed">-			isDynamicSizeMode: restOfPreferences.isDynamicSizeMode ?? null,</div><div class="diff-removed">-			isPasteAtCursorMode: restOfPreferences.isPasteAtCursorMode ?? null,</div><div class="diff-removed">-		})</div><div class="diff-removed">-		if (didCreate) {</div><div class="diff-removed">-			opts.trackEvent('create-user', { source: 'app' })</div><div class="diff-removed">-		}</div><div class="diff-removed">-		return { app, userId: opts.userId }</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	getIntl() {</div><div class="diff-removed">-		const intl = createIntl()</div><div class="diff-removed">-		if (intl) return intl</div><div class="diff-removed">-		// intl should exists since IntlWrapper should create it before we get here, but let's use this just in case</div><div class="diff-removed">-		setupCreateIntl({</div><div class="diff-removed">-			defaultLocale: 'en',</div><div class="diff-removed">-			locale: this.user$.get()?.locale ?? 'en',</div><div class="diff-removed">-			messages: {},</div><div class="diff-removed">-		})</div><div class="diff-removed">-		return createIntl()!</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	async uploadTldrFiles(files: File[], onFirstFileUploaded?: (file: TlaFile) => void) {</div><div class="diff-removed">-		const totalFiles = files.length</div><div class="diff-removed">-		let uploadedFiles = 0</div><div class="diff-removed">-		if (totalFiles === 0) return</div><div class="diff-removed">-</div><div class="diff-removed">-		// this is only approx since we upload the files in pieces and they are base64 encoded</div><div class="diff-removed">-		// in the json blob, so this will usually be a big overestimate. But that's fine because</div><div class="diff-removed">-		// if the upload finishes before the number hits 100% people are pleasantly surprised.</div><div class="diff-removed">-		const approxTotalBytes = files.reduce((acc, f) => acc + f.size, 0)</div><div class="diff-removed">-		let bytesUploaded = 0</div><div class="diff-removed">-		const getApproxPercentage = () =></div><div class="diff-removed">-			Math.min(Math.round((bytesUploaded / approxTotalBytes) * 100), 100)</div><div class="diff-removed">-		const updateProgress = () => updateToast({ description: `${getApproxPercentage()}%` })</div><div class="diff-removed">-</div><div class="diff-removed">-		// only bother showing the percentage if it's going to take a while</div><div class="diff-removed">-</div><div class="diff-removed">-		let uploadingToastId = undefined as undefined | string</div><div class="diff-removed">-		let didFinishUploading = false</div><div class="diff-removed">-</div><div class="diff-removed">-		// give it a second before we show the toast, in case the upload is fast</div><div class="diff-removed">-		setTimeout(() => {</div><div class="diff-removed">-			if (didFinishUploading || this.abortController.signal.aborted) return</div><div class="diff-removed">-			// if it's close to the end, don't show the progress toast</div><div class="diff-removed">-			if (getApproxPercentage() > 50) return</div><div class="diff-removed">-			uploadingToastId = this.toasts?.addToast({</div><div class="diff-removed">-				severity: 'info',</div><div class="diff-removed">-				title: this.getIntl().formatMessage(this.messages.uploadingTldrFiles, {</div><div class="diff-removed">-					total: totalFiles,</div><div class="diff-removed">-					uploaded: uploadedFiles,</div><div class="diff-removed">-				}),</div><div class="diff-removed">-</div><div class="diff-removed">-				description: `${getApproxPercentage()}%`,</div><div class="diff-removed">-				keepOpen: true,</div><div class="diff-removed">-			})</div><div class="diff-removed">-		}, 800)</div><div class="diff-removed">-</div><div class="diff-removed">-		const updateToast = (args: { title?: string; description?: string }) => {</div><div class="diff-removed">-			if (!uploadingToastId) return</div><div class="diff-removed">-			this.toasts?.toasts.update((toasts) =></div><div class="diff-removed">-				toasts.map((t) =></div><div class="diff-removed">-					t.id === uploadingToastId</div><div class="diff-removed">-						? {</div><div class="diff-removed">-								...t,</div><div class="diff-removed">-								...args,</div><div class="diff-removed">-							}</div><div class="diff-removed">-						: t</div><div class="diff-removed">-				)</div><div class="diff-removed">-			)</div><div class="diff-removed">-		}</div><div class="diff-removed">-</div><div class="diff-removed">-		for (const f of files) {</div><div class="diff-removed">-			const res = await this.uploadTldrFile(f, (bytes) => {</div><div class="diff-removed">-				bytesUploaded += bytes</div><div class="diff-removed">-				updateProgress()</div><div class="diff-removed">-			}).catch((e) => Result.err(e))</div><div class="diff-removed">-			if (!res.ok) {</div><div class="diff-removed">-				if (uploadingToastId) this.toasts?.removeToast(uploadingToastId)</div><div class="diff-removed">-				this.toasts?.addToast({</div><div class="diff-removed">-					severity: 'error',</div><div class="diff-removed">-					title: this.getIntl().formatMessage(this.messages.unknown_error),</div><div class="diff-removed">-					keepOpen: true,</div><div class="diff-removed">-				})</div><div class="diff-removed">-				console.error(res.error)</div><div class="diff-removed">-				return</div><div class="diff-removed">-			}</div><div class="diff-removed">-</div><div class="diff-removed">-			updateToast({</div><div class="diff-removed">-				title: this.getIntl().formatMessage(this.messages.uploadingTldrFiles, {</div><div class="diff-removed">-					total: totalFiles,</div><div class="diff-removed">-					uploaded: ++uploadedFiles + 1,</div><div class="diff-removed">-				}),</div><div class="diff-removed">-			})</div><div class="diff-removed">-</div><div class="diff-removed">-			if (onFirstFileUploaded) {</div><div class="diff-removed">-				onFirstFileUploaded(res.value.file)</div><div class="diff-removed">-				onFirstFileUploaded = undefined</div><div class="diff-removed">-			}</div><div class="diff-removed">-		}</div><div class="diff-removed">-		didFinishUploading = true</div><div class="diff-removed">-</div><div class="diff-removed">-		if (uploadingToastId) this.toasts?.removeToast(uploadingToastId)</div><div class="diff-removed">-</div><div class="diff-removed">-		if (totalFiles > 1) {</div><div class="diff-removed">-			this.toasts?.addToast({</div><div class="diff-removed">-				severity: 'success',</div><div class="diff-removed">-				title: this.getIntl().formatMessage(this.messages.addingTldrFiles, {</div><div class="diff-removed">-					total: files.length,</div><div class="diff-removed">-				}),</div><div class="diff-removed">-				keepOpen: true,</div><div class="diff-removed">-			})</div><div class="diff-removed">-		}</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	private async uploadTldrFile(</div><div class="diff-removed">-		file: File,</div><div class="diff-removed">-		onProgress?: (bytesUploadedSinceLastProgressUpdate: number) => void</div><div class="diff-removed">-	) {</div><div class="diff-removed">-		const json = await file.text()</div><div class="diff-removed">-		const parseFileResult = parseTldrawJsonFile({</div><div class="diff-removed">-			schema: createTLSchema(),</div><div class="diff-removed">-			json,</div><div class="diff-removed">-		})</div><div class="diff-removed">-</div><div class="diff-removed">-		if (!parseFileResult.ok) {</div><div class="diff-removed">-			return Result.err('could not parse file')</div><div class="diff-removed">-		}</div><div class="diff-removed">-</div><div class="diff-removed">-		const snapshot = parseFileResult.value.getStoreSnapshot()</div><div class="diff-removed">-</div><div class="diff-removed">-		for (const record of Object.values(snapshot.store)) {</div><div class="diff-removed">-			if (</div><div class="diff-removed">-				record.typeName !== 'asset' ||</div><div class="diff-removed">-				record.type === 'bookmark' ||</div><div class="diff-removed">-				!record.props.src?.startsWith('data:')</div><div class="diff-removed">-			) {</div><div class="diff-removed">-				snapshot.store[record.id] = record</div><div class="diff-removed">-				continue</div><div class="diff-removed">-			}</div><div class="diff-removed">-			const src = record.props.src</div><div class="diff-removed">-			const file = await dataUrlToFile(</div><div class="diff-removed">-				src,</div><div class="diff-removed">-				record.props.name,</div><div class="diff-removed">-				record.props.mimeType ?? 'application/octet-stream'</div><div class="diff-removed">-			)</div><div class="diff-removed">-			// TODO: this creates duplicate versions of the assets because we'll re-upload them when the user opens</div><div class="diff-removed">-			// the file to associate them with the file id. To avoid this we'd need a way to create the file row</div><div class="diff-removed">-			// in postgres so we can do the association while uploading the first time. Or just tolerate foreign key</div><div class="diff-removed">-			// constraints being violated for a moment.</div><div class="diff-removed">-			const assetsStore = multiplayerAssetStore()</div><div class="diff-removed">-			const { src: newSrc } = await assetsStore.upload(record, file, this.abortController.signal)</div><div class="diff-removed">-			onProgress?.(file.size)</div><div class="diff-removed">-			snapshot.store[record.id] = {</div><div class="diff-removed">-				...record,</div><div class="diff-removed">-				props: {</div><div class="diff-removed">-					...record.props,</div><div class="diff-removed">-					src: newSrc,</div><div class="diff-removed">-				},</div><div class="diff-removed">-			}</div><div class="diff-removed">-		}</div><div class="diff-removed">-		const body = JSON.stringify({</div><div class="diff-removed">-			snapshots: [</div><div class="diff-removed">-				{</div><div class="diff-removed">-					schema: snapshot.schema,</div><div class="diff-removed">-					snapshot: snapshot.store,</div><div class="diff-removed">-				} satisfies CreateSnapshotRequestBody,</div><div class="diff-removed">-			],</div><div class="diff-removed">-		})</div><div class="diff-removed">-</div><div class="diff-removed">-		const res = await fetch(TLDR_FILE_ENDPOINT, { method: 'POST', body })</div><div class="diff-removed">-		onProgress?.(body.length)</div><div class="diff-removed">-		if (!res.ok) {</div><div class="diff-removed">-			throw Error('could not upload file ' + (await res.text()))</div><div class="diff-removed">-		}</div><div class="diff-removed">-		const response = (await res.json()) as CreateFilesResponseBody</div><div class="diff-removed">-		if (response.error) {</div><div class="diff-removed">-			throw Error(response.message)</div><div class="diff-removed">-		}</div><div class="diff-removed">-		const id = response.slugs[0]</div><div class="diff-removed">-		const name =</div><div class="diff-removed">-			file.name?.replace(/\.tldr$/, '') ??</div><div class="diff-removed">-			Object.values(snapshot.store).find((d): d is TLDocument => d.typeName === 'document')?.name ??</div><div class="diff-removed">-			''</div><div class="diff-removed">-</div><div class="diff-removed">-		return this.createFile({ id, name })</div><div class="diff-removed">-	}</div><div class="diff-added">+  config = {</div><div class="diff-added">+    maxNumberOfFiles: MAX_NUMBER_OF_FILES,</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  readonly id = appId++</div><div class="diff-added">+  readonly z: Zero<TlaSchema, any> | Zero<any, any></div><div class="diff-added">+</div><div class="diff-added">+  private readonly user$: Signal<TlaUser | undefined></div><div class="diff-added">+  private readonly fileStates$: Signal<(TlaFileState & { file: TlaFile })[]></div><div class="diff-added">+</div><div class="diff-added">+  private readonly abortController = new AbortController()</div><div class="diff-added">+  readonly disposables: (() => void)[] = [</div><div class="diff-added">+    () => this.abortController.abort(),</div><div class="diff-added">+    () => this.z.close(),</div><div class="diff-added">+  ]</div><div class="diff-added">+</div><div class="diff-added">+  private changes = new Map<Atom<any, unknown>, any>()</div><div class="diff-added">+  private changesFlushed = null as null | ReturnType<typeof promiseWithResolve></div><div class="diff-added">+</div><div class="diff-added">+  private signalizeQuery<TReturn>(name: string, query: any): Signal<TReturn> {</div><div class="diff-added">+    const view = query.materialize()</div><div class="diff-added">+    const val$ = atom(name, view.data)</div><div class="diff-added">+    view.addListener((res: any) => {</div><div class="diff-added">+      this.changes.set(val$, structuredClone(res))</div><div class="diff-added">+      if (!this.changesFlushed) this.changesFlushed = promiseWithResolve()</div><div class="diff-added">+      queueMicrotask(() => {</div><div class="diff-added">+        transact(() => {</div><div class="diff-added">+          this.changes.forEach((value, key) => key.set(value))</div><div class="diff-added">+          this.changes.clear()</div><div class="diff-added">+        })</div><div class="diff-added">+        this.changesFlushed?.resolve(undefined)</div><div class="diff-added">+        this.changesFlushed = null</div><div class="diff-added">+      })</div><div class="diff-added">+    })</div><div class="diff-added">+    this.disposables.push(() => view.destroy())</div><div class="diff-added">+    return val$</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  private userQuery() {</div><div class="diff-added">+    return this.z.query.user.where('id', '=', this.userId).one()</div><div class="diff-added">+  }</div><div class="diff-added">+  private fileStateQuery() {</div><div class="diff-added">+    return this.z.query</div><div class="diff-added">+      .file_state.where('userId', '=', this.userId)</div><div class="diff-added">+      .related('file', (q: any) => q.one())</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  private constructor(</div><div class="diff-added">+    public readonly userId: string,</div><div class="diff-added">+    getToken: () => Promise<string | undefined>,</div><div class="diff-added">+    onClientTooOld: () => void,</div><div class="diff-added">+    trackEvent: TLAppUiContextType</div><div class="diff-added">+  ) {</div><div class="diff-added">+    const sessionId = uniqueId()</div><div class="diff-added">+    this.z = useProperZero</div><div class="diff-added">+      ? new Zero({</div><div class="diff-added">+          auth: getToken,</div><div class="diff-added">+          userID: userId,</div><div class="diff-added">+          schema: (window as any).ZeroSchema || createTLSchema(),</div><div class="diff-added">+          server: ZERO_SERVER,</div><div class="diff-added">+          onUpdateNeeded: (reason: any) => {</div><div class="diff-added">+            console.error('update needed', reason)</div><div class="diff-added">+            onClientTooOld()</div><div class="diff-added">+          },</div><div class="diff-added">+          kvStore: window.navigator.webdriver ? 'mem' : 'idb',</div><div class="diff-added">+          mutators: createMutators?.(userId),</div><div class="diff-added">+        })</div><div class="diff-added">+      : new (Zero as any)({</div><div class="diff-added">+          userId,</div><div class="diff-added">+          getUri: async () => {</div><div class="diff-added">+            const params = new URLSearchParams({</div><div class="diff-added">+              sessionId,</div><div class="diff-added">+              protocolVersion: String(Z_PROTOCOL_VERSION),</div><div class="diff-added">+            })</div><div class="diff-added">+            const token = await getToken()</div><div class="diff-added">+            params.set('accessToken', token || 'no-token-found')</div><div class="diff-added">+            return `${MULTIPLAYER_SERVER}/app/${userId}/connect?${params}`</div><div class="diff-added">+          },</div><div class="diff-added">+          onMutationRejected: this.showMutationRejectionToast,</div><div class="diff-added">+          onClientTooOld: () => onClientTooOld(),</div><div class="diff-added">+          trackEvent,</div><div class="diff-added">+        })</div><div class="diff-added">+</div><div class="diff-added">+    this.user$ = this.signalizeQuery('user signal', this.userQuery())</div><div class="diff-added">+    this.fileStates$ = this.signalizeQuery('file states signal', this.fileStateQuery())</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  messages = defineMessages({</div><div class="diff-added">+    mutation_error_toast_title: { defaultMessage: 'Error' },</div><div class="diff-added">+    publish_failed: { defaultMessage: 'Unable to publish the file.' },</div><div class="diff-added">+    unpublish_failed: { defaultMessage: 'Unable to unpublish the file.' },</div><div class="diff-added">+    republish_failed: { defaultMessage: 'Unable to publish the changes.' },</div><div class="diff-added">+    unknown_error: { defaultMessage: 'An unexpected error occurred.' },</div><div class="diff-added">+    forbidden: {</div><div class="diff-added">+      defaultMessage: 'You do not have the necessary permissions to perform this action.',</div><div class="diff-added">+    },</div><div class="diff-added">+    bad_request: { defaultMessage: 'Invalid request.' },</div><div class="diff-added">+    rate_limit_exceeded: { defaultMessage: 'Rate limit exceeded, try again later.' },</div><div class="diff-added">+    client_too_old: {</div><div class="diff-added">+      defaultMessage: 'Please refresh the page to get the latest version of tldraw.',</div><div class="diff-added">+    },</div><div class="diff-added">+    max_files_title: { defaultMessage: 'File limit reached' },</div><div class="diff-added">+    max_files_reached: {</div><div class="diff-added">+      defaultMessage:</div><div class="diff-added">+        'You have reached the maximum number of files. You need to delete old files before creating new ones.',</div><div class="diff-added">+    },</div><div class="diff-added">+    uploadingTldrFiles: {</div><div class="diff-added">+      defaultMessage:</div><div class="diff-added">+        '{total, plural, one {Uploading .tldr file‚Ä¶} other {Uploading {uploaded} of {total} .tldr files‚Ä¶}}',</div><div class="diff-added">+    },</div><div class="diff-added">+    addingTldrFiles: { defaultMessage: 'Added {total} .tldr files.' },</div><div class="diff-added">+  })</div><div class="diff-added">+</div><div class="diff-added">+  private getMessage(id: keyof typeof this.messages) {</div><div class="diff-added">+    const msg = this.messages[id] || this.messages.unknown_error</div><div class="diff-added">+    if (!this.messages[id]) console.error('Missing translation for', id)</div><div class="diff-added">+    return msg</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  private getIntl() {</div><div class="diff-added">+    let intl = createIntl()</div><div class="diff-added">+    if (!intl) {</div><div class="diff-added">+      setupCreateIntl({ defaultLocale: 'en', locale: this.user$.get()?.locale ?? 'en', messages: {} })</div><div class="diff-added">+      intl = createIntl()!</div><div class="diff-added">+    }</div><div class="diff-added">+    return intl</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  private showMutationRejectionToast = throttle((errorCode: ZErrorCode) => {</div><div class="diff-added">+    const desc = this.getMessage(errorCode)</div><div class="diff-added">+    this.toasts?.addToast({</div><div class="diff-added">+      title: this.getIntl().formatMessage(this.messages.mutation_error_toast_title),</div><div class="diff-added">+      description: this.getIntl().formatMessage(desc),</div><div class="diff-added">+    })</div><div class="diff-added">+  }, 3000)</div><div class="diff-added">+</div><div class="diff-added">+  toasts: TLUiToastsContextType | null = null</div><div class="diff-added">+</div><div class="diff-added">+  async preload(initialUserData: TlaUser) {</div><div class="diff-added">+    let didCreate = false</div><div class="diff-added">+    await this.userQuery().preload().complete</div><div class="diff-added">+    if (!this.user$.get()) {</div><div class="diff-added">+      didCreate = true</div><div class="diff-added">+      this.z.mutate.user.insert(initialUserData)</div><div class="diff-added">+      updateLocalSessionState((s) => ({ ...s, shouldShowWelcomeDialog: true }))</div><div class="diff-added">+    }</div><div class="diff-added">+    await this.fileStateQuery().preload().complete</div><div class="diff-added">+    return didCreate</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  private canCreateNewFile() {</div><div class="diff-added">+    return this.getUserOwnFiles().length < this.config.maxNumberOfFiles</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  private showMaxFilesToast() {</div><div class="diff-added">+    this.toasts?.addToast({</div><div class="diff-added">+      title: this.getIntl().formatMessage(this.messages.max_files_title),</div><div class="diff-added">+      description: this.getIntl().formatMessage(this.messages.max_files_reached),</div><div class="diff-added">+      keepOpen: true,</div><div class="diff-added">+    })</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  async createFile(fileOrId?: string | Partial<TlaFile>) {</div><div class="diff-added">+    if (!this.canCreateNewFile()) {</div><div class="diff-added">+      this.showMaxFilesToast()</div><div class="diff-added">+      return Result.err('max number of files reached')</div><div class="diff-added">+    }</div><div class="diff-added">+    const file: TlaFile = {</div><div class="diff-added">+      id: typeof fileOrId === 'string' ? fileOrId : uniqueId(),</div><div class="diff-added">+      ownerId: this.userId,</div><div class="diff-added">+      createSource: null,</div><div class="diff-added">+      isEmpty: true,</div><div class="diff-added">+      createdAt: Date.now(),</div><div class="diff-added">+      lastPublished: 0,</div><div class="diff-added">+      name: this.getFallbackFileName(Date.now()),</div><div class="diff-added">+      published: false,</div><div class="diff-added">+      publishedSlug: uniqueId(),</div><div class="diff-added">+      shared: true,</div><div class="diff-added">+      sharedLinkType: 'edit',</div><div class="diff-added">+      thumbnail: '',</div><div class="diff-added">+      updatedAt: Date.now(),</div><div class="diff-added">+      isDeleted: false,</div><div class="diff-added">+    }</div><div class="diff-added">+    if (typeof fileOrId === 'object') {</div><div class="diff-added">+      Object.assign(file, fileOrId)</div><div class="diff-added">+      if (!file.name) file.name = this.getFallbackFileName(file.createdAt)</div><div class="diff-added">+    }</div><div class="diff-added">+    const fs: TlaFileState = {</div><div class="diff-added">+      fileId: file.id,</div><div class="diff-added">+      userId: this.userId,</div><div class="diff-added">+      firstVisitAt: null,</div><div class="diff-added">+      lastEditAt: null,</div><div class="diff-added">+      lastSessionState: null,</div><div class="diff-added">+      lastVisitAt: null,</div><div class="diff-added">+      isFileOwner: true,</div><div class="diff-added">+      isPinned: false,</div><div class="diff-added">+    }</div><div class="diff-added">+    await this.z.mutate.file.insertWithFileState({ file, fileState: fs })</div><div class="diff-added">+    return Result.ok({ file })</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  private getFallbackFileName(time: number) {</div><div class="diff-added">+    const d = new Date(time)</div><div class="diff-added">+    return this.getIntl().formatDate(d, getDateFormat(d))</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  getFileName(file: TlaFile | string | null, useDateFallback = true): string | undefined {</div><div class="diff-added">+    if (typeof file === 'string') file = this.getFile(file)</div><div class="diff-added">+    if (!file) return</div><div class="diff-added">+    if (typeof file.name === 'undefined') {</div><div class="diff-added">+      captureException(new Error('file.name undefined: ' + JSON.stringify(file)))</div><div class="diff-added">+    }</div><div class="diff-added">+    const name = file.name?.trim()</div><div class="diff-added">+    if (name) return name</div><div class="diff-added">+    if (useDateFallback) return this.getFallbackFileName(file.createdAt)</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  async slurpFile() {</div><div class="diff-added">+    return this.createFile({</div><div class="diff-added">+      createSource: `${LOCAL_FILE_PREFIX}/${getScratchPersistenceKey()}`,</div><div class="diff-added">+    })</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  toggleFileShared(fileId: string) {</div><div class="diff-added">+    const f = this.getFile(fileId)</div><div class="diff-added">+    if (!f || f.ownerId !== this.userId) throw Error('user cannot edit that file')</div><div class="diff-added">+    this.z.mutate.file.update({ id: fileId, shared: !f.shared })</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  getFile(fileId?: string) {</div><div class="diff-added">+    return fileId ? this.getUserOwnFiles().find((f) => f.id === fileId) ?? null : null</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  isFileOwner(fileId: string) {</div><div class="diff-added">+    const f = this.getFile(fileId)</div><div class="diff-added">+    return !!f && f.ownerId === this.userId</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  async publishFile(fileId: string) {</div><div class="diff-added">+    const f = this.getFile(fileId)</div><div class="diff-added">+    if (!f || !this.isFileOwner(fileId)) throw Error('user cannot edit that file')</div><div class="diff-added">+    const name = this.getFileName(f) || ''</div><div class="diff-added">+    this.z.mutate.file.update({ id: fileId, name, published: true, lastPublished: Date.now() })</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  async unpublishFile(fileId: string) {</div><div class="diff-added">+    const f = this.getFile(fileId)</div><div class="diff-added">+    if (!f || !this.isFileOwner(fileId)) throw Error('user cannot edit that file')</div><div class="diff-added">+    if (!f.published) return</div><div class="diff-added">+    this.z.mutate.file.update({ id: fileId, published: false })</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  async deleteOrForgetFile(fileId: string) {</div><div class="diff-added">+    const f = this.getFile(fileId)</div><div class="diff-added">+    if (!f) return</div><div class="diff-added">+    await this.z.mutate.file.deleteOrForget(f)</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  async pinOrUnpinFile(fileId: string) {</div><div class="diff-added">+    const fs = this.getFileState(fileId)</div><div class="diff-added">+    if (!fs) return</div><div class="diff-added">+    await this.z.mutate.file_state.update({</div><div class="diff-added">+      fileId,</div><div class="diff-added">+      userId: this.userId,</div><div class="diff-added">+      isPinned: !fs.isPinned,</div><div class="diff-added">+    })</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  getUserOwnFiles() {</div><div class="diff-added">+    return this.getUserFileStates().map((s) => s.file!).filter(Boolean)</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  getUserFileStates() {</div><div class="diff-added">+    return this.fileStates$.get()</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  private getOrCreateFileState(fileId: string) {</div><div class="diff-added">+    const existing = this.getFileState(fileId)</div><div class="diff-added">+    if (!existing) {</div><div class="diff-added">+      this.z.mutate.file_state.insert({</div><div class="diff-added">+        fileId,</div><div class="diff-added">+        userId: this.userId,</div><div class="diff-added">+        firstVisitAt: Date.now(),</div><div class="diff-added">+        lastEditAt: null,</div><div class="diff-added">+        lastSessionState: null,</div><div class="diff-added">+        lastVisitAt: null,</div><div class="diff-added">+        isFileOwner: this.isFileOwner(fileId),</div><div class="diff-added">+        isPinned: false,</div><div class="diff-added">+      })</div><div class="diff-added">+    }</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  getFileState(fileId: string) {</div><div class="diff-added">+    return this.getUserFileStates().find((s) => s.fileId === fileId)</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  onFileEnter(fileId: string) {</div><div class="diff-added">+    this.getOrCreateFileState(fileId)</div><div class="diff-added">+    this.updateFileState(fileId, { lastVisitAt: Date.now() })</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  onFileEdit(fileId: string) {</div><div class="diff-added">+    this.updateFileState(fileId, { lastEditAt: Date.now() })</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  onFileSessionStateUpdate(fileId: string, sessionState: TLSessionStateSnapshot) {</div><div class="diff-added">+    this.updateFileState(fileId, {</div><div class="diff-added">+      lastSessionState: JSON.stringify(sessionState),</div><div class="diff-added">+      lastVisitAt: Date.now(),</div><div class="diff-added">+    })</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  onFileExit(fileId: string) {</div><div class="diff-added">+    this.updateFileState(fileId, { lastVisitAt: Date.now() })</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  private updateFileState(fileId: string, partial: Partial<TlaFileState>) {</div><div class="diff-added">+    const fs = this.getFileState(fileId)</div><div class="diff-added">+    if (fs) {</div><div class="diff-added">+      this.z.mutate.file_state.update({ fileId, userId: fs.userId, ...partial })</div><div class="diff-added">+    }</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  getCurrentUserId() {</div><div class="diff-added">+    return assert(getLocalSessionStateUnsafe().auth?.userId, 'no user')</div><div class="diff-added">+  }</div><div class="diff-added">+  getCurrentUser() {</div><div class="diff-added">+    const u = this.getUser(this.getCurrentUserId())</div><div class="diff-added">+    if (!u) throw Error('no user')</div><div class="diff-added">+    return u</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  getUser(userId: string) {</div><div class="diff-added">+    // @ts-ignore</div><div class="diff-added">+    return this.user$.get()</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  static async create(opts: {</div><div class="diff-added">+    userId: string</div><div class="diff-added">+    fullName: string</div><div class="diff-added">+    email: string</div><div class="diff-added">+    avatar: string</div><div class="diff-added">+    getToken(): Promise<string | undefined></div><div class="diff-added">+    onClientTooOld(): void</div><div class="diff-added">+    trackEvent: TLAppUiContextType</div><div class="diff-added">+  }) {</div><div class="diff-added">+    const initial = {</div><div class="diff-added">+      id: opts.userId,</div><div class="diff-added">+      name: opts.fullName,</div><div class="diff-added">+      email: opts.email,</div><div class="diff-added">+      avatar: opts.avatar,</div><div class="diff-added">+    }</div><div class="diff-added">+    const app = new TldrawApp(</div><div class="diff-added">+      opts.userId,</div><div class="diff-added">+      opts.getToken,</div><div class="diff-added">+      opts.onClientTooOld,</div><div class="diff-added">+      opts.trackEvent</div><div class="diff-added">+    )</div><div class="diff-added">+    window.app = app</div><div class="diff-added">+    const didCreate = await app.preload(initial)</div><div class="diff-added">+    if (didCreate) opts.trackEvent('create-user', { source: 'app' })</div><div class="diff-added">+    return { app, userId: opts.userId }</div><div class="diff-added">+  }</div><div> }</div><div>\ No newline at end of file</div><div></div></pre>
                </div>
            </div>
        </section>
    </main>
    <footer>
        <p>LoCoDiff-bench - <a href="https://github.com/AbanteAI/LoCoDiff-bench">GitHub Repository</a></p>
    </footer>
</body>
</html>
    