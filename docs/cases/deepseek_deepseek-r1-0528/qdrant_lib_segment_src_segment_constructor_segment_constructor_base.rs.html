<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case: lib/segment/src/segment_constructor/segment_constructor_base.rs - DeepSeek R1 0528</title>
    <link rel="stylesheet" href="../../styles.css">
</head>
<body>
    <header>
        <h1>Case: lib/segment/src/segment_constructor/segment_constructor_base.rs</h1>
        <h2>Model: DeepSeek R1 0528</h2>
        <p><a href="../../models/deepseek_deepseek-r1-0528.html">All DeepSeek R1 0528 Cases</a> | <a href="../../cases.html">All Cases</a> | <a href="../../index.html">Home</a></p>
    </header>
    <main>
        <section class="case-details">
            <div class="case-info">
                <h2>Benchmark Case Information</h2>
                <p><strong>Model:</strong> DeepSeek R1 0528</p>
                <p><strong>Status:</strong> <span class="failure">Failure</span></p>
                <p><strong>Prompt Tokens:</strong> 72082</p>
                <p><strong>Native Prompt Tokens:</strong> 77954</p>
                <p><strong>Native Completion Tokens:</strong> 13712</p>
                <p><strong>Native Tokens Reasoning:</strong> 5915</p>
                <p><strong>Native Finish Reason:</strong> stop</p>
                <p><strong>Cost:</strong> $0.2205703</p>
            </div>
            
            <div class="content-links">
                <h2>View Content</h2>
                <ul>
                    <li><a href="../../content/deepseek_deepseek-r1-0528/qdrant_lib_segment_src_segment_constructor_segment_constructor_base.rs/prompt.html" class="content-link">View Prompt</a></li>
                    <li><a href="../../content/deepseek_deepseek-r1-0528/qdrant_lib_segment_src_segment_constructor_segment_constructor_base.rs/expected.html" class="content-link">View Expected Output</a></li>
                    <li><a href="../../content/deepseek_deepseek-r1-0528/qdrant_lib_segment_src_segment_constructor_segment_constructor_base.rs/actual.html" class="content-link">View Actual Output</a></li>
                </ul>
            </div>
            
            <div class="diff-section">
                <h2>Diff (Expected vs Actual)</h2>
                <div id="diff-output">
                    <pre class="diff"><div></div><div>index 5dbd9e9bd..9a144dfd0 100644</div><div class="diff-header">--- a/qdrant_lib_segment_src_segment_constructor_segment_constructor_base.rs_expectedoutput.txt (expected):tmp/tmp09arpwnv_expected.txt	</div><div class="diff-header">+++ b/qdrant_lib_segment_src_segment_constructor_segment_constructor_base.rs_extracted.txt (actual):tmp/tmp632sa943_actual.txt	</div><div class="diff-info">@@ -2,12 +2,11 @@ use std::collections::HashMap;</div><div> use std::fs::File;</div><div> use std::io::Read;</div><div> use std::path::{Path, PathBuf};</div><div class="diff-removed">-use std::sync::Arc;</div><div> use std::sync::atomic::AtomicBool;</div><div class="diff-added">+use std::sync::Arc;</div><div> </div><div> use atomic_refcell::AtomicRefCell;</div><div> use common::budget::ResourcePermit;</div><div class="diff-removed">-use common::flags::FeatureFlags;</div><div> use io::storage_version::StorageVersion;</div><div> use log::info;</div><div> use parking_lot::{Mutex, RwLock};</div><div class="diff-info">@@ -15,8 +14,8 @@ use rocksdb::DB;</div><div> use serde::Deserialize;</div><div> use uuid::Uuid;</div><div> </div><div class="diff-removed">-use crate::common::operation_error::{OperationError, OperationResult, check_process_stopped};</div><div class="diff-removed">-use crate::common::rocksdb_wrapper::{DB_MAPPING_CF, DB_VECTOR_CF, open_db};</div><div class="diff-added">+use crate::common::operation_error::{check_process_stopped, OperationError, OperationResult};</div><div class="diff-added">+use crate::common::rocksdb_wrapper::{open_db, DB_MAPPING_CF, DB_VECTOR_CF};</div><div> use crate::data_types::vectors::DEFAULT_VECTOR_NAME;</div><div> use crate::id_tracker::immutable_id_tracker::ImmutableIdTracker;</div><div> use crate::id_tracker::mutable_id_tracker::MutableIdTracker;</div><div class="diff-info">@@ -35,11 +34,10 @@ use crate::payload_storage::mmap_payload_storage::MmapPayloadStorage;</div><div> use crate::payload_storage::on_disk_payload_storage::OnDiskPayloadStorage;</div><div> use crate::payload_storage::payload_storage_enum::PayloadStorageEnum;</div><div> use crate::payload_storage::simple_payload_storage::SimplePayloadStorage;</div><div class="diff-removed">-use crate::segment::{SEGMENT_STATE_FILE, Segment, SegmentVersion, VectorData};</div><div class="diff-added">+use crate::segment::{Segment, SegmentVersion, VectorData, SEGMENT_STATE_FILE};</div><div> use crate::types::{</div><div>     Distance, Indexes, PayloadStorageType, SegmentConfig, SegmentState, SegmentType, SeqNumberType,</div><div class="diff-removed">-    SparseVectorStorageType, VectorDataConfig, VectorName, VectorStorageDatatype,</div><div class="diff-removed">-    VectorStorageType,</div><div class="diff-added">+    SparseVectorStorageType, VectorDataConfig, VectorName, VectorStorageDatatype, VectorStorageType,</div><div> };</div><div> use crate::vector_storage::dense::appendable_dense_vector_storage::{</div><div>     open_appendable_in_ram_vector_storage, open_appendable_in_ram_vector_storage_byte,</div><div class="diff-info">@@ -53,16 +51,16 @@ use crate::vector_storage::dense::simple_dense_vector_storage::{</div><div>     open_simple_dense_byte_vector_storage, open_simple_dense_half_vector_storage,</div><div>     open_simple_dense_vector_storage,</div><div> };</div><div class="diff-added">+use crate::vector_storage::dense::simple_multi_dense_vector_storage::{</div><div class="diff-added">+    open_simple_multi_dense_vector_storage, open_simple_multi_dense_vector_storage_byte,</div><div class="diff-added">+    open_simple_multi_dense_vector_storage_half,</div><div class="diff-added">+};</div><div> use crate::vector_storage::multi_dense::appendable_mmap_multi_dense_vector_storage::{</div><div>     open_appendable_in_ram_multi_vector_storage, open_appendable_in_ram_multi_vector_storage_byte,</div><div>     open_appendable_in_ram_multi_vector_storage_half, open_appendable_memmap_multi_vector_storage,</div><div>     open_appendable_memmap_multi_vector_storage_byte,</div><div>     open_appendable_memmap_multi_vector_storage_half,</div><div> };</div><div class="diff-removed">-use crate::vector_storage::multi_dense::simple_multi_dense_vector_storage::{</div><div class="diff-removed">-    open_simple_multi_dense_vector_storage, open_simple_multi_dense_vector_storage_byte,</div><div class="diff-removed">-    open_simple_multi_dense_vector_storage_half,</div><div class="diff-removed">-};</div><div> use crate::vector_storage::quantized::quantized_vectors::QuantizedVectors;</div><div> use crate::vector_storage::sparse::mmap_sparse_vector_storage::MmapSparseVectorStorage;</div><div> use crate::vector_storage::sparse::simple_sparse_vector_storage::open_simple_sparse_vector_storage;</div><div class="diff-info">@@ -108,8 +106,7 @@ pub(crate) fn open_vector_storage(</div><div>         // In memory</div><div>         VectorStorageType::Memory => {</div><div>             let db_column_name = get_vector_name_with_prefix(DB_VECTOR_CF, vector_name);</div><div class="diff-removed">-</div><div class="diff-removed">-            if let Some(multi_vec_config) = &vector_config.multivector_config {</div><div class="diff-added">+            if let Some(multi_vec_config) = &vector_config.multivec_config {</div><div>                 match storage_element_type {</div><div>                     VectorStorageDatatype::Float32 => open_simple_multi_dense_vector_storage(</div><div>                         database.clone(),</div><div class="diff-info">@@ -164,7 +161,7 @@ pub(crate) fn open_vector_storage(</div><div>         }</div><div>         // Mmap on disk, not appendable</div><div>         VectorStorageType::Mmap => {</div><div class="diff-removed">-            if let Some(multi_vec_config) = &vector_config.multivector_config {</div><div class="diff-added">+            if let Some(multi_vec_config) = &vector_config.multivec_config {</div><div>                 // there are no mmap multi vector storages, appendable only</div><div>                 match storage_element_type {</div><div>                     VectorStorageDatatype::Float32 => open_appendable_memmap_multi_vector_storage(</div><div class="diff-info">@@ -212,7 +209,7 @@ pub(crate) fn open_vector_storage(</div><div>         }</div><div>         // Chunked mmap on disk, appendable</div><div>         VectorStorageType::ChunkedMmap => {</div><div class="diff-removed">-            if let Some(multi_vec_config) = &vector_config.multivector_config {</div><div class="diff-added">+            if let Some(multi_vec_config) = &vector_config.multivec_config {</div><div>                 match storage_element_type {</div><div>                     VectorStorageDatatype::Float32 => open_appendable_memmap_multi_vector_storage(</div><div>                         vector_storage_path,</div><div class="diff-info">@@ -257,8 +254,9 @@ pub(crate) fn open_vector_storage(</div><div>                 }</div><div>             }</div><div>         }</div><div class="diff-added">+        // In RAM with mmap for persistence (appendable)</div><div>         VectorStorageType::InRamChunkedMmap => {</div><div class="diff-removed">-            if let Some(multi_vec_config) = &vector_config.multivector_config {</div><div class="diff-added">+            if let Some(multi_vec_config) = &vector_config.multivec_config {</div><div>                 match storage_element_type {</div><div>                     VectorStorageDatatype::Float32 => open_appendable_in_ram_multi_vector_storage(</div><div>                         vector_storage_path,</div><div class="diff-info">@@ -337,9 +335,9 @@ pub(crate) fn create_payload_storage(</div><div>     path: &Path,</div><div> ) -> OperationResult<PayloadStorageEnum> {</div><div>     let payload_storage = match config.payload_storage_type {</div><div class="diff-removed">-        PayloadStorageType::InMemory => {</div><div class="diff-removed">-            PayloadStorageEnum::from(SimplePayloadStorage::open(database)?)</div><div class="diff-removed">-        }</div><div class="diff-added">+        PayloadStorageType::InMemory => PayloadStorageEnum::from(SimplePayloadStorage::open(</div><div class="diff-added">+            database,</div><div class="diff-added">+        )?),</div><div>         PayloadStorageType::OnDisk => {</div><div>             PayloadStorageEnum::from(OnDiskPayloadStorage::open(database)?)</div><div>         }</div><div class="diff-info">@@ -350,7 +348,9 @@ pub(crate) fn create_payload_storage(</div><div>     Ok(payload_storage)</div><div> }</div><div> </div><div class="diff-removed">-pub(crate) fn create_mutable_id_tracker(segment_path: &Path) -> OperationResult<MutableIdTracker> {</div><div class="diff-added">+pub(crate) fn create_mutable_id_tracker(</div><div class="diff-added">+    segment_path: &Path,</div><div class="diff-added">+) -> OperationResult<MutableIdTracker> {</div><div>     MutableIdTracker::open(segment_path)</div><div> }</div><div> </div><div class="diff-info">@@ -465,7 +465,7 @@ pub(crate) fn create_sparse_vector_index(</div><div>     ) {</div><div>         (_, a @ (VectorStorageDatatype::Float16 | VectorStorageDatatype::Uint8), false) => {</div><div>             Err(OperationError::ValidationError {</div><div class="diff-removed">-                description: format!("{a:?} datatype is not supported"),</div><div class="diff-added">+                description: format!("{:?} datatype is not supported", a),</div><div>             })?</div><div>         }</div><div> </div><div class="diff-info">@@ -543,27 +543,20 @@ fn create_segment(</div><div>         appendable_flag || !ImmutableIdTracker::mappings_file_path(segment_path).is_file();</div><div> </div><div>     let id_tracker = if mutable_id_tracker {</div><div class="diff-removed">-        // Determine whether we use the new (file based) or old (RocksDB) mutable ID tracker</div><div class="diff-removed">-        // Decide based on the feature flag and state on disk</div><div class="diff-removed">-        let use_new_mutable_tracker = {</div><div class="diff-removed">-            // New ID tracker is enabled by default, but we still use the old tracker if we have</div><div class="diff-removed">-            // any mappings stored in RocksDB</div><div class="diff-removed">-            // TODO(1.15 or later): remove this check and use new mutable ID tracker unconditionally</div><div class="diff-removed">-            let db = database.read();</div><div class="diff-removed">-            match db.cf_handle(DB_MAPPING_CF) {</div><div class="diff-removed">-                Some(cf_handle) => {</div><div class="diff-removed">-                    let count = db</div><div class="diff-removed">-                        .property_int_value_cf(cf_handle, rocksdb::properties::ESTIMATE_NUM_KEYS)</div><div class="diff-removed">-                        .map_err(|err| {</div><div class="diff-removed">-                            OperationError::service_error(format!(</div><div class="diff-removed">-                                "Failed to get estimated number of keys from RocksDB: {err}"</div><div class="diff-removed">-                            ))</div><div class="diff-removed">-                        })?</div><div class="diff-removed">-                        .unwrap_or_default();</div><div class="diff-removed">-                    count == 0</div><div class="diff-removed">-                }</div><div class="diff-removed">-                None => true,</div><div class="diff-added">+        let db = database.read();</div><div class="diff-added">+        let use_new_mutable_tracker = match db.cf_handle(DB_MAPPING_CF) {</div><div class="diff-added">+            Some(cf_handle) => {</div><div class="diff-added">+                let count = db</div><div class="diff-added">+                    .property_int_value_cf(cf_handle, rocksdb::properties::ESTIMATE_NUM_KEYS)</div><div class="diff-added">+                    .map_err(|err| {</div><div class="diff-added">+                        OperationError::service_error(format!(</div><div class="diff-added">+                            "Failed to get estimated number of keys from RocksDB: {err}"</div><div class="diff-added">+                        ))</div><div class="diff-added">+                    })?</div><div class="diff-added">+                    .unwrap_or_default();</div><div class="diff-added">+                count == 0</div><div>             }</div><div class="diff-added">+            None => true,</div><div>         };</div><div> </div><div>         if use_new_mutable_tracker {</div><div class="diff-info">@@ -581,6 +574,14 @@ fn create_segment(</div><div>         ))</div><div>     };</div><div> </div><div class="diff-added">+    let payload_index_path = get_payload_index_path(segment_path);</div><div class="diff-added">+    let payload_index: Arc<AtomicRefCell<StructPayloadIndex>> = sp(StructPayloadIndex::open(</div><div class="diff-added">+        payload_storage.clone(),</div><div class="diff-added">+        id_tracker.clone(),</div><div class="diff-added">+        &payload_index_path,</div><div class="diff-added">+        appendable_flag,</div><div class="diff-added">+    )?);</div><div class="diff-added">+</div><div>     let mut vector_storages = HashMap::new();</div><div> </div><div>     for (vector_name, vector_config) in &config.vector_data {</div><div class="diff-info">@@ -628,6 +629,7 @@ fn create_segment(</div><div>         let vector_storage = vector_storages.remove(vector_name).unwrap();</div><div> </div><div>         let vector_index_path = get_vector_index_path(segment_path, vector_name);</div><div class="diff-added">+</div><div>         // Warn when number of points between ID tracker and storage differs</div><div>         let point_count = id_tracker.borrow().total_point_count();</div><div>         let vector_count = vector_storage.borrow().total_vector_count();</div><div class="diff-info">@@ -667,8 +669,8 @@ fn create_segment(</div><div>         vector_data.insert(</div><div>             vector_name.to_owned(),</div><div>             VectorData {</div><div class="diff-removed">-                vector_index,</div><div>                 vector_storage,</div><div class="diff-added">+                vector_index,</div><div>                 quantized_vectors,</div><div>             },</div><div>         );</div><div class="diff-info">@@ -711,6 +713,13 @@ fn create_segment(</div><div>         );</div><div>     }</div><div> </div><div class="diff-added">+    // Check if there are any vectors left in storage that weren't processed</div><div class="diff-added">+    if !vector_storages.is_empty() {</div><div class="diff-added">+        return Err(OperationError::service_error(</div><div class="diff-added">+            "Some vector storages were not assigned to any vector data",</div><div class="diff-added">+        ));</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div>     let segment_type = if config.is_any_vector_indexed() {</div><div>         SegmentType::Indexed</div><div>     } else {</div><div class="diff-info">@@ -746,7 +755,7 @@ pub fn load_segment(path: &Path, stopped: &AtomicBool) -> OperationResult<Option</div><div>         return Ok(None);</div><div>     }</div><div> </div><div class="diff-removed">-    let Some(stored_version) = SegmentVersion::load(path)? else {</div><div class="diff-added">+    if !SegmentVersion::check_exists(path) {</div><div>         // Assume segment was not properly saved.</div><div>         // Server might have crashed before saving the segment fully.</div><div>         log::warn!(</div><div class="diff-info">@@ -754,8 +763,9 @@ pub fn load_segment(path: &Path, stopped: &AtomicBool) -> OperationResult<Option</div><div>             path.display()</div><div>         );</div><div>         return Ok(None);</div><div class="diff-removed">-    };</div><div class="diff-added">+    }</div><div> </div><div class="diff-added">+    let stored_version = SegmentVersion::load(path)?;</div><div>     let app_version = SegmentVersion::current();</div><div> </div><div>     if stored_version != app_version {</div><div></div></pre>
                </div>
            </div>
        </section>
    </main>
    <footer>
        <p>LoCoDiff-bench - <a href="https://github.com/AbanteAI/LoCoDiff-bench">GitHub Repository</a></p>
    </footer>
</body>
</html>
    