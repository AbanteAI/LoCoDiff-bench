<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case: packages/tldraw/src/lib/shapes/geo/GeoShapeUtil.tsx - DeepSeek R1 0528</title>
    <link rel="stylesheet" href="../../styles.css">
</head>
<body>
    <header>
        <h1>Case: packages/tldraw/src/lib/shapes/geo/GeoShapeUtil.tsx</h1>
        <h2>Model: DeepSeek R1 0528</h2>
        <p><a href="../../models/deepseek_deepseek-r1-0528.html">All DeepSeek R1 0528 Cases</a> | <a href="../../cases.html">All Cases</a> | <a href="../../index.html">Home</a></p>
    </header>
    <main>
        <section class="case-details">
            <div class="case-info">
                <h2>Benchmark Case Information</h2>
                <p><strong>Model:</strong> DeepSeek R1 0528</p>
                <p><strong>Status:</strong> <span class="failure">Failure</span></p>
                <p><strong>Prompt Tokens:</strong> 67029</p>
                <p><strong>Native Prompt Tokens:</strong> 70277</p>
                <p><strong>Native Completion Tokens:</strong> 15536</p>
                <p><strong>Native Tokens Reasoning:</strong> 8434</p>
                <p><strong>Native Finish Reason:</strong> stop</p>
                <p><strong>Cost:</strong> $0.06900698</p>
            </div>
            
            <div class="content-links">
                <h2>View Content</h2>
                <ul>
                    <li><a href="../../content/deepseek_deepseek-r1-0528/tldraw_packages_tldraw_src_lib_shapes_geo_GeoShapeUtil.tsx/prompt.html" class="content-link">View Prompt</a></li>
                    <li><a href="../../content/deepseek_deepseek-r1-0528/tldraw_packages_tldraw_src_lib_shapes_geo_GeoShapeUtil.tsx/expected.html" class="content-link">View Expected Output</a></li>
                    <li><a href="../../content/deepseek_deepseek-r1-0528/tldraw_packages_tldraw_src_lib_shapes_geo_GeoShapeUtil.tsx/actual.html" class="content-link">View Actual Output</a></li>
                </ul>
            </div>
            
            <div class="diff-section">
                <h2>Diff (Expected vs Actual)</h2>
                <div id="diff-output">
                    <pre class="diff"><div></div><div>index 751af1b8f..40a753361 100644</div><div class="diff-header">--- a/tldraw_packages_tldraw_src_lib_shapes_geo_GeoShapeUtil.tsx_expectedoutput.txt (expected):tmp/tmp3y80whhb_expected.txt	</div><div class="diff-header">+++ b/tldraw_packages_tldraw_src_lib_shapes_geo_GeoShapeUtil.tsx_extracted.txt (actual):tmp/tmp0t3usxeu_actual.txt	</div><div class="diff-info">@@ -1,878 +1,1101 @@</div><div class="diff-removed">-/* eslint-disable react-hooks/rules-of-hooks */</div><div> import {</div><div class="diff-removed">-	BaseBoxShapeUtil,</div><div class="diff-removed">-	Box,</div><div class="diff-removed">-	Editor,</div><div class="diff-removed">-	Ellipse2d,</div><div class="diff-removed">-	Geometry2d,</div><div class="diff-removed">-	Group2d,</div><div class="diff-removed">-	HALF_PI,</div><div class="diff-removed">-	HTMLContainer,</div><div class="diff-removed">-	HandleSnapGeometry,</div><div class="diff-removed">-	PI2,</div><div class="diff-removed">-	Polygon2d,</div><div class="diff-removed">-	Polyline2d,</div><div class="diff-removed">-	Rectangle2d,</div><div class="diff-removed">-	SVGContainer,</div><div class="diff-removed">-	Stadium2d,</div><div class="diff-removed">-	SvgExportContext,</div><div class="diff-removed">-	TLFontFace,</div><div class="diff-removed">-	TLGeoShape,</div><div class="diff-removed">-	TLGeoShapeProps,</div><div class="diff-removed">-	TLResizeInfo,</div><div class="diff-removed">-	TLShapeUtilCanvasSvgDef,</div><div class="diff-removed">-	Vec,</div><div class="diff-removed">-	exhaustiveSwitchError,</div><div class="diff-removed">-	geoShapeMigrations,</div><div class="diff-removed">-	geoShapeProps,</div><div class="diff-removed">-	getDefaultColorTheme,</div><div class="diff-removed">-	getFontsFromRichText,</div><div class="diff-removed">-	getPolygonVertices,</div><div class="diff-removed">-	lerp,</div><div class="diff-removed">-	toRichText,</div><div class="diff-removed">-	useValue,</div><div class="diff-added">+  BaseBoxShapeUtil,</div><div class="diff-added">+  DefaultFontFamilies,</div><div class="diff-added">+  Editor,</div><div class="diff-added">+  Ellipse2d,</div><div class="diff-added">+  Geometry2d,</div><div class="diff-added">+  Group2d,</div><div class="diff-added">+  PI2,</div><div class="diff-added">+  Polygon2d,</div><div class="diff-added">+  Polyline2d,</div><div class="diff-added">+  Rectangle2d,</div><div class="diff-added">+  SVGContainer,</div><div class="diff-added">+  Stadium2d,</div><div class="diff-added">+  SvgExportContext,</div><div class="diff-added">+  TAU,</div><div class="diff-added">+  TLDefaultDashStyle,</div><div class="diff-added">+  TLGeoShape,</div><div class="diff-added">+  TLOnEditEndHandler,</div><div class="diff-added">+  TLOnResizeHandler,</div><div class="diff-added">+  TLShapeUtilCanvasSvgDef,</div><div class="diff-added">+  Vec2d,</div><div class="diff-added">+  geoShapeMigrations,</div><div class="diff-added">+  geoShapeProps,</div><div class="diff-added">+  getDefaultColorTheme,</div><div class="diff-added">+  getPolygonVertices,</div><div> } from '@tldraw/editor'</div><div> </div><div class="diff-removed">-import isEqual from 'lodash.isequal'</div><div class="diff-removed">-import {</div><div class="diff-removed">-	isEmptyRichText,</div><div class="diff-removed">-	renderHtmlFromRichTextForMeasurement,</div><div class="diff-removed">-	renderPlaintextFromRichText,</div><div class="diff-removed">-} from '../../utils/text/richText'</div><div> import { HyperlinkButton } from '../shared/HyperlinkButton'</div><div class="diff-removed">-import { RichTextLabel, RichTextSVG } from '../shared/RichTextLabel'</div><div class="diff-added">+import { TextLabel } from '../shared/TextLabel'</div><div> import {</div><div class="diff-removed">-	FONT_FAMILIES,</div><div class="diff-removed">-	LABEL_FONT_SIZES,</div><div class="diff-removed">-	LABEL_PADDING,</div><div class="diff-removed">-	STROKE_SIZES,</div><div class="diff-removed">-	TEXT_PROPS,</div><div class="diff-added">+  FONT_FAMILIES,</div><div class="diff-added">+  LABEL_FONT_SIZES,</div><div class="diff-added">+  STROKE_SIZES,</div><div class="diff-added">+  TEXT_PROPS,</div><div> } from '../shared/default-shape-constants'</div><div class="diff-removed">-import { getFillDefForCanvas, getFillDefForExport } from '../shared/defaultStyleDefs'</div><div class="diff-removed">-import { useDefaultColorTheme } from '../shared/useDefaultColorTheme'</div><div class="diff-removed">-import { useIsReadyForEditing } from '../shared/useEditablePlainText'</div><div class="diff-removed">-import { GeoShapeBody } from './components/GeoShapeBody'</div><div> import {</div><div class="diff-removed">-	cloudOutline,</div><div class="diff-removed">-	getCloudPath,</div><div class="diff-removed">-	getEllipseDrawIndicatorPath,</div><div class="diff-removed">-	getHeartParts,</div><div class="diff-removed">-	getHeartPath,</div><div class="diff-removed">-	getRoundedInkyPolygonPath,</div><div class="diff-removed">-	getRoundedPolygonPoints,</div><div class="diff-removed">-} from './geo-shape-helpers'</div><div class="diff-removed">-import { getLines } from './getLines'</div><div class="diff-added">+  getFillDefForCanvas,</div><div class="diff-added">+  getFillDefForExport,</div><div class="diff-added">+  getFontDefForExport,</div><div class="diff-added">+} from '../shared/defaultStyleDefs'</div><div class="diff-added">+import { getTextLabelSvgElement } from '../shared/getTextLabelSvgElement'</div><div class="diff-added">+import { getRoundedInkyPolygonPath, getRoundedPolygonPoints } from '../shared/polygon-helpers'</div><div class="diff-added">+import { useForceSolid } from '../shared/useForceSolid'</div><div class="diff-added">+import { cloudOutline, cloudSvgPath } from './cloudOutline'</div><div class="diff-added">+import { DashStyleCloud, DashStyleCloudSvg } from './components/DashStyleCloud'</div><div class="diff-added">+import { DashStyleEllipse, DashStyleEllipseSvg } from './components/DashStyleEllipse'</div><div class="diff-added">+import { DashStyleOval, DashStyleOvalSvg } from './components/DashStyleOval'</div><div class="diff-added">+import { DashStylePolygon, DashStylePolygonSvg } from './components/DashStylePolygon'</div><div class="diff-added">+import { DrawStyleCloud, DrawStyleCloudSvg } from './components/DrawStyleCloud'</div><div class="diff-added">+import { DrawStyleEllipseSvg, getEllipseIndicatorPath } from './components/DrawStyleEllipse'</div><div class="diff-added">+import { DrawStylePolygon, DrawStylePolygonSvg } from './components/DrawStylePolygon'</div><div class="diff-added">+import { SolidStyleCloud, SolidStyleCloudSvg } from './components/SolidStyleCloud'</div><div class="diff-added">+import { SolidStyleEllipse, SolidStyleEllipseSvg } from './components/SolidStyleEllipse'</div><div class="diff-added">+import {</div><div class="diff-added">+  SolidStyleOval,</div><div class="diff-added">+  SolidStyleOvalSvg,</div><div class="diff-added">+  getOvalIndicatorPath,</div><div class="diff-added">+} from './components/SolidStyleOval'</div><div class="diff-added">+import { SolidStylePolygon, SolidStylePolygonSvg } from './components/SolidStylePolygon'</div><div> </div><div class="diff-added">+const LABEL_PADDING = 16</div><div> const MIN_SIZE_WITH_LABEL = 17 * 3</div><div> </div><div> /** @public */</div><div> export class GeoShapeUtil extends BaseBoxShapeUtil<TLGeoShape> {</div><div class="diff-removed">-	static override type = 'geo' as const</div><div class="diff-removed">-	static override props = geoShapeProps</div><div class="diff-removed">-	static override migrations = geoShapeMigrations</div><div class="diff-removed">-</div><div class="diff-removed">-	override canEdit() {</div><div class="diff-removed">-		return true</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	override getDefaultProps(): TLGeoShape['props'] {</div><div class="diff-removed">-		return {</div><div class="diff-removed">-			w: 100,</div><div class="diff-removed">-			h: 100,</div><div class="diff-removed">-			geo: 'rectangle',</div><div class="diff-removed">-			color: 'black',</div><div class="diff-removed">-			labelColor: 'black',</div><div class="diff-removed">-			fill: 'none',</div><div class="diff-removed">-			dash: 'draw',</div><div class="diff-removed">-			size: 'm',</div><div class="diff-removed">-			font: 'draw',</div><div class="diff-removed">-			align: 'middle',</div><div class="diff-removed">-			verticalAlign: 'middle',</div><div class="diff-removed">-			growY: 0,</div><div class="diff-removed">-			url: '',</div><div class="diff-removed">-			scale: 1,</div><div class="diff-removed">-			richText: toRichText(''),</div><div class="diff-removed">-		}</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	override getGeometry(shape: TLGeoShape) {</div><div class="diff-removed">-		const w = Math.max(1, shape.props.w)</div><div class="diff-removed">-		const h = Math.max(1, shape.props.h + shape.props.growY)</div><div class="diff-removed">-		const cx = w / 2</div><div class="diff-removed">-		const cy = h / 2</div><div class="diff-removed">-</div><div class="diff-removed">-		const isFilled = shape.props.fill !== 'none'</div><div class="diff-removed">-</div><div class="diff-removed">-		let body: Geometry2d</div><div class="diff-removed">-</div><div class="diff-removed">-		switch (shape.props.geo) {</div><div class="diff-removed">-			case 'cloud': {</div><div class="diff-removed">-				body = new Polygon2d({</div><div class="diff-removed">-					points: cloudOutline(w, h, shape.id, shape.props.size, shape.props.scale),</div><div class="diff-removed">-					isFilled,</div><div class="diff-removed">-				})</div><div class="diff-removed">-				break</div><div class="diff-removed">-			}</div><div class="diff-removed">-			case 'triangle': {</div><div class="diff-removed">-				body = new Polygon2d({</div><div class="diff-removed">-					points: [new Vec(cx, 0), new Vec(w, h), new Vec(0, h)],</div><div class="diff-removed">-					isFilled,</div><div class="diff-removed">-				})</div><div class="diff-removed">-				break</div><div class="diff-removed">-			}</div><div class="diff-removed">-			case 'diamond': {</div><div class="diff-removed">-				body = new Polygon2d({</div><div class="diff-removed">-					points: [new Vec(cx, 0), new Vec(w, cy), new Vec(cx, h), new Vec(0, cy)],</div><div class="diff-removed">-					isFilled,</div><div class="diff-removed">-				})</div><div class="diff-removed">-				break</div><div class="diff-removed">-			}</div><div class="diff-removed">-			case 'pentagon': {</div><div class="diff-removed">-				body = new Polygon2d({</div><div class="diff-removed">-					points: getPolygonVertices(w, h, 5),</div><div class="diff-removed">-					isFilled,</div><div class="diff-removed">-				})</div><div class="diff-removed">-				break</div><div class="diff-removed">-			}</div><div class="diff-removed">-			case 'hexagon': {</div><div class="diff-removed">-				body = new Polygon2d({</div><div class="diff-removed">-					points: getPolygonVertices(w, h, 6),</div><div class="diff-removed">-					isFilled,</div><div class="diff-removed">-				})</div><div class="diff-removed">-				break</div><div class="diff-removed">-			}</div><div class="diff-removed">-			case 'octagon': {</div><div class="diff-removed">-				body = new Polygon2d({</div><div class="diff-removed">-					points: getPolygonVertices(w, h, 8),</div><div class="diff-removed">-					isFilled,</div><div class="diff-removed">-				})</div><div class="diff-removed">-				break</div><div class="diff-removed">-			}</div><div class="diff-removed">-			case 'ellipse': {</div><div class="diff-removed">-				body = new Ellipse2d({</div><div class="diff-removed">-					width: w,</div><div class="diff-removed">-					height: h,</div><div class="diff-removed">-					isFilled,</div><div class="diff-removed">-				})</div><div class="diff-removed">-				break</div><div class="diff-removed">-			}</div><div class="diff-removed">-			case 'oval': {</div><div class="diff-removed">-				body = new Stadium2d({</div><div class="diff-removed">-					width: w,</div><div class="diff-removed">-					height: h,</div><div class="diff-removed">-					isFilled,</div><div class="diff-removed">-				})</div><div class="diff-removed">-				break</div><div class="diff-removed">-			}</div><div class="diff-removed">-			case 'star': {</div><div class="diff-removed">-				// Most of this code is to offset the center, a 5 point star</div><div class="diff-removed">-				// will need to be moved downward because from its center [0,0]</div><div class="diff-removed">-				// it will have a bigger minY than maxY. This is because it'll</div><div class="diff-removed">-				// have 2 points at the bottom.</div><div class="diff-removed">-				const sides = 5</div><div class="diff-removed">-				const step = PI2 / sides / 2</div><div class="diff-removed">-				const rightMostIndex = Math.floor(sides / 4) * 2</div><div class="diff-removed">-				const leftMostIndex = sides * 2 - rightMostIndex</div><div class="diff-removed">-				const topMostIndex = 0</div><div class="diff-removed">-				const bottomMostIndex = Math.floor(sides / 2) * 2</div><div class="diff-removed">-				const maxX = (Math.cos(-HALF_PI + rightMostIndex * step) * w) / 2</div><div class="diff-removed">-				const minX = (Math.cos(-HALF_PI + leftMostIndex * step) * w) / 2</div><div class="diff-removed">-</div><div class="diff-removed">-				const minY = (Math.sin(-HALF_PI + topMostIndex * step) * h) / 2</div><div class="diff-removed">-				const maxY = (Math.sin(-HALF_PI + bottomMostIndex * step) * h) / 2</div><div class="diff-removed">-				const diffX = w - Math.abs(maxX - minX)</div><div class="diff-removed">-				const diffY = h - Math.abs(maxY - minY)</div><div class="diff-removed">-				const offsetX = w / 2 + minX - (w / 2 - maxX)</div><div class="diff-removed">-				const offsetY = h / 2 + minY - (h / 2 - maxY)</div><div class="diff-removed">-</div><div class="diff-removed">-				const ratio = 1</div><div class="diff-removed">-				const cx = (w - offsetX) / 2</div><div class="diff-removed">-				const cy = (h - offsetY) / 2</div><div class="diff-removed">-				const ox = (w + diffX) / 2</div><div class="diff-removed">-				const oy = (h + diffY) / 2</div><div class="diff-removed">-				const ix = (ox * ratio) / 2</div><div class="diff-removed">-				const iy = (oy * ratio) / 2</div><div class="diff-removed">-</div><div class="diff-removed">-				body = new Polygon2d({</div><div class="diff-removed">-					points: Array.from(Array(sides * 2)).map((_, i) => {</div><div class="diff-removed">-						const theta = -HALF_PI + i * step</div><div class="diff-removed">-						return new Vec(</div><div class="diff-removed">-							cx + (i % 2 ? ix : ox) * Math.cos(theta),</div><div class="diff-removed">-							cy + (i % 2 ? iy : oy) * Math.sin(theta)</div><div class="diff-removed">-						)</div><div class="diff-removed">-					}),</div><div class="diff-removed">-					isFilled,</div><div class="diff-removed">-				})</div><div class="diff-removed">-				break</div><div class="diff-removed">-			}</div><div class="diff-removed">-			case 'rhombus': {</div><div class="diff-removed">-				const offset = Math.min(w * 0.38, h * 0.38)</div><div class="diff-removed">-				body = new Polygon2d({</div><div class="diff-removed">-					points: [new Vec(offset, 0), new Vec(w, 0), new Vec(w - offset, h), new Vec(0, h)],</div><div class="diff-removed">-					isFilled,</div><div class="diff-removed">-				})</div><div class="diff-removed">-				break</div><div class="diff-removed">-			}</div><div class="diff-removed">-			case 'rhombus-2': {</div><div class="diff-removed">-				const offset = Math.min(w * 0.38, h * 0.38)</div><div class="diff-removed">-				body = new Polygon2d({</div><div class="diff-removed">-					points: [new Vec(0, 0), new Vec(w - offset, 0), new Vec(w, h), new Vec(offset, h)],</div><div class="diff-removed">-					isFilled,</div><div class="diff-removed">-				})</div><div class="diff-removed">-				break</div><div class="diff-removed">-			}</div><div class="diff-removed">-			case 'trapezoid': {</div><div class="diff-removed">-				const offset = Math.min(w * 0.38, h * 0.38)</div><div class="diff-removed">-				body = new Polygon2d({</div><div class="diff-removed">-					points: [new Vec(offset, 0), new Vec(w - offset, 0), new Vec(w, h), new Vec(0, h)],</div><div class="diff-removed">-					isFilled,</div><div class="diff-removed">-				})</div><div class="diff-removed">-				break</div><div class="diff-removed">-			}</div><div class="diff-removed">-			case 'arrow-right': {</div><div class="diff-removed">-				const ox = Math.min(w, h) * 0.38</div><div class="diff-removed">-				const oy = h * 0.16</div><div class="diff-removed">-				body = new Polygon2d({</div><div class="diff-removed">-					points: [</div><div class="diff-removed">-						new Vec(0, oy),</div><div class="diff-removed">-						new Vec(w - ox, oy),</div><div class="diff-removed">-						new Vec(w - ox, 0),</div><div class="diff-removed">-						new Vec(w, h / 2),</div><div class="diff-removed">-						new Vec(w - ox, h),</div><div class="diff-removed">-						new Vec(w - ox, h - oy),</div><div class="diff-removed">-						new Vec(0, h - oy),</div><div class="diff-removed">-					],</div><div class="diff-removed">-					isFilled,</div><div class="diff-removed">-				})</div><div class="diff-removed">-				break</div><div class="diff-removed">-			}</div><div class="diff-removed">-			case 'arrow-left': {</div><div class="diff-removed">-				const ox = Math.min(w, h) * 0.38</div><div class="diff-removed">-				const oy = h * 0.16</div><div class="diff-removed">-				body = new Polygon2d({</div><div class="diff-removed">-					points: [</div><div class="diff-removed">-						new Vec(ox, 0),</div><div class="diff-removed">-						new Vec(ox, oy),</div><div class="diff-removed">-						new Vec(w, oy),</div><div class="diff-removed">-						new Vec(w, h - oy),</div><div class="diff-removed">-						new Vec(ox, h - oy),</div><div class="diff-removed">-						new Vec(ox, h),</div><div class="diff-removed">-						new Vec(0, h / 2),</div><div class="diff-removed">-					],</div><div class="diff-removed">-					isFilled,</div><div class="diff-removed">-				})</div><div class="diff-removed">-				break</div><div class="diff-removed">-			}</div><div class="diff-removed">-			case 'arrow-up': {</div><div class="diff-removed">-				const ox = w * 0.16</div><div class="diff-removed">-				const oy = Math.min(w, h) * 0.38</div><div class="diff-removed">-				body = new Polygon2d({</div><div class="diff-removed">-					points: [</div><div class="diff-removed">-						new Vec(w / 2, 0),</div><div class="diff-removed">-						new Vec(w, oy),</div><div class="diff-removed">-						new Vec(w - ox, oy),</div><div class="diff-removed">-						new Vec(w - ox, h),</div><div class="diff-removed">-						new Vec(ox, h),</div><div class="diff-removed">-						new Vec(ox, oy),</div><div class="diff-removed">-						new Vec(0, oy),</div><div class="diff-removed">-					],</div><div class="diff-removed">-					isFilled,</div><div class="diff-removed">-				})</div><div class="diff-removed">-				break</div><div class="diff-removed">-			}</div><div class="diff-removed">-			case 'arrow-down': {</div><div class="diff-removed">-				const ox = w * 0.16</div><div class="diff-removed">-				const oy = Math.min(w, h) * 0.38</div><div class="diff-removed">-				body = new Polygon2d({</div><div class="diff-removed">-					points: [</div><div class="diff-removed">-						new Vec(ox, 0),</div><div class="diff-removed">-						new Vec(w - ox, 0),</div><div class="diff-removed">-						new Vec(w - ox, h - oy),</div><div class="diff-removed">-						new Vec(w, h - oy),</div><div class="diff-removed">-						new Vec(w / 2, h),</div><div class="diff-removed">-						new Vec(0, h - oy),</div><div class="diff-removed">-						new Vec(ox, h - oy),</div><div class="diff-removed">-					],</div><div class="diff-removed">-					isFilled,</div><div class="diff-removed">-				})</div><div class="diff-removed">-				break</div><div class="diff-removed">-			}</div><div class="diff-removed">-			case 'check-box':</div><div class="diff-removed">-			case 'x-box':</div><div class="diff-removed">-			case 'rectangle': {</div><div class="diff-removed">-				body = new Rectangle2d({</div><div class="diff-removed">-					width: w,</div><div class="diff-removed">-					height: h,</div><div class="diff-removed">-					isFilled,</div><div class="diff-removed">-				})</div><div class="diff-removed">-				break</div><div class="diff-removed">-			}</div><div class="diff-removed">-			case 'heart': {</div><div class="diff-removed">-				// kind of expensive (creating the primitives to create a different primitive) but hearts are rare and beautiful things</div><div class="diff-removed">-				const parts = getHeartParts(w, h)</div><div class="diff-removed">-				const points = parts.reduce<Vec[]>((acc, part) => {</div><div class="diff-removed">-					acc.push(...part.vertices)</div><div class="diff-removed">-					return acc</div><div class="diff-removed">-				}, [])</div><div class="diff-removed">-</div><div class="diff-removed">-				body = new Polygon2d({</div><div class="diff-removed">-					points,</div><div class="diff-removed">-					isFilled,</div><div class="diff-removed">-				})</div><div class="diff-removed">-				break</div><div class="diff-removed">-			}</div><div class="diff-removed">-			default: {</div><div class="diff-removed">-				exhaustiveSwitchError(shape.props.geo)</div><div class="diff-removed">-			}</div><div class="diff-removed">-		}</div><div class="diff-removed">-</div><div class="diff-removed">-		const unscaledlabelSize = getUnscaledLabelSize(this.editor, shape)</div><div class="diff-removed">-		// unscaled w and h</div><div class="diff-removed">-		const unscaledW = w / shape.props.scale</div><div class="diff-removed">-		const unscaledH = h / shape.props.scale</div><div class="diff-removed">-		const unscaledminWidth = Math.min(100, unscaledW / 2)</div><div class="diff-removed">-		const unscaledMinHeight = Math.min(</div><div class="diff-removed">-			LABEL_FONT_SIZES[shape.props.size] * TEXT_PROPS.lineHeight + LABEL_PADDING * 2,</div><div class="diff-removed">-			unscaledH / 2</div><div class="diff-removed">-		)</div><div class="diff-removed">-</div><div class="diff-removed">-		const unscaledLabelWidth = Math.min(</div><div class="diff-removed">-			unscaledW,</div><div class="diff-removed">-			Math.max(unscaledlabelSize.w, Math.min(unscaledminWidth, Math.max(1, unscaledW - 8)))</div><div class="diff-removed">-		)</div><div class="diff-removed">-		const unscaledLabelHeight = Math.min(</div><div class="diff-removed">-			unscaledH,</div><div class="diff-removed">-			Math.max(unscaledlabelSize.h, Math.min(unscaledMinHeight, Math.max(1, unscaledH - 8)))</div><div class="diff-removed">-		)</div><div class="diff-removed">-</div><div class="diff-removed">-		// not sure if bug</div><div class="diff-removed">-</div><div class="diff-removed">-		const lines = getLines(shape.props, STROKE_SIZES[shape.props.size] * shape.props.scale)</div><div class="diff-removed">-		const edges = lines ? lines.map((line) => new Polyline2d({ points: line })) : []</div><div class="diff-removed">-</div><div class="diff-removed">-		// todo: use centroid for label position</div><div class="diff-removed">-</div><div class="diff-removed">-		return new Group2d({</div><div class="diff-removed">-			children: [</div><div class="diff-removed">-				body,</div><div class="diff-removed">-				new Rectangle2d({</div><div class="diff-removed">-					x:</div><div class="diff-removed">-						shape.props.align === 'start'</div><div class="diff-removed">-							? 0</div><div class="diff-removed">-							: shape.props.align === 'end'</div><div class="diff-removed">-								? (unscaledW - unscaledLabelWidth) * shape.props.scale</div><div class="diff-removed">-								: ((unscaledW - unscaledLabelWidth) / 2) * shape.props.scale,</div><div class="diff-removed">-					y:</div><div class="diff-removed">-						shape.props.verticalAlign === 'start'</div><div class="diff-removed">-							? 0</div><div class="diff-removed">-							: shape.props.verticalAlign === 'end'</div><div class="diff-removed">-								? (unscaledH - unscaledLabelHeight) * shape.props.scale</div><div class="diff-removed">-								: ((unscaledH - unscaledLabelHeight) / 2) * shape.props.scale,</div><div class="diff-removed">-					width: unscaledLabelWidth * shape.props.scale,</div><div class="diff-removed">-					height: unscaledLabelHeight * shape.props.scale,</div><div class="diff-removed">-					isFilled: true,</div><div class="diff-removed">-					isLabel: true,</div><div class="diff-removed">-				}),</div><div class="diff-removed">-				...edges,</div><div class="diff-removed">-			],</div><div class="diff-removed">-		})</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	override getHandleSnapGeometry(shape: TLGeoShape): HandleSnapGeometry {</div><div class="diff-removed">-		const geometry = this.getGeometry(shape)</div><div class="diff-removed">-		// we only want to snap handles to the outline of the shape - not to its label etc.</div><div class="diff-removed">-		const outline = geometry.children[0]</div><div class="diff-removed">-		switch (shape.props.geo) {</div><div class="diff-removed">-			case 'arrow-down':</div><div class="diff-removed">-			case 'arrow-left':</div><div class="diff-removed">-			case 'arrow-right':</div><div class="diff-removed">-			case 'arrow-up':</div><div class="diff-removed">-			case 'check-box':</div><div class="diff-removed">-			case 'diamond':</div><div class="diff-removed">-			case 'hexagon':</div><div class="diff-removed">-			case 'octagon':</div><div class="diff-removed">-			case 'pentagon':</div><div class="diff-removed">-			case 'rectangle':</div><div class="diff-removed">-			case 'rhombus':</div><div class="diff-removed">-			case 'rhombus-2':</div><div class="diff-removed">-			case 'star':</div><div class="diff-removed">-			case 'trapezoid':</div><div class="diff-removed">-			case 'triangle':</div><div class="diff-removed">-			case 'x-box':</div><div class="diff-removed">-				// poly-line type shapes hand snap points for each vertex & the center</div><div class="diff-removed">-				return { outline: outline, points: [...outline.vertices, geometry.bounds.center] }</div><div class="diff-removed">-			case 'cloud':</div><div class="diff-removed">-			case 'ellipse':</div><div class="diff-removed">-			case 'heart':</div><div class="diff-removed">-			case 'oval':</div><div class="diff-removed">-				// blobby shapes only have a snap point in their center</div><div class="diff-removed">-				return { outline: outline, points: [geometry.bounds.center] }</div><div class="diff-removed">-			default:</div><div class="diff-removed">-				exhaustiveSwitchError(shape.props.geo)</div><div class="diff-removed">-		}</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	override getText(shape: TLGeoShape) {</div><div class="diff-removed">-		return renderPlaintextFromRichText(this.editor, shape.props.richText)</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	override getFontFaces(shape: TLGeoShape): TLFontFace[] {</div><div class="diff-removed">-		return getFontsFromRichText(this.editor, shape.props.richText, {</div><div class="diff-removed">-			family: `tldraw_${shape.props.font}`,</div><div class="diff-removed">-			weight: 'normal',</div><div class="diff-removed">-			style: 'normal',</div><div class="diff-removed">-		})</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	component(shape: TLGeoShape) {</div><div class="diff-removed">-		const { id, type, props } = shape</div><div class="diff-removed">-		const { fill, font, align, verticalAlign, size, richText } = props</div><div class="diff-removed">-		const theme = useDefaultColorTheme()</div><div class="diff-removed">-		const { editor } = this</div><div class="diff-removed">-		const isOnlySelected = useValue(</div><div class="diff-removed">-			'isGeoOnlySelected',</div><div class="diff-removed">-			() => shape.id === editor.getOnlySelectedShapeId(),</div><div class="diff-removed">-			[editor]</div><div class="diff-removed">-		)</div><div class="diff-removed">-		const isReadyForEditing = useIsReadyForEditing(editor, shape.id)</div><div class="diff-removed">-		const isEmpty = isEmptyRichText(shape.props.richText)</div><div class="diff-removed">-		const showHtmlContainer = isReadyForEditing || !isEmpty</div><div class="diff-removed">-		const isForceSolid = useValue('force solid', () => editor.getZoomLevel() < 0.2, [editor])</div><div class="diff-removed">-</div><div class="diff-removed">-		return (</div><div class="diff-removed">-			<></div><div class="diff-removed">-				<SVGContainer></div><div class="diff-removed">-					<GeoShapeBody shape={shape} shouldScale={true} forceSolid={isForceSolid} /></div><div class="diff-removed">-				</SVGContainer></div><div class="diff-removed">-				{showHtmlContainer && (</div><div class="diff-removed">-					<HTMLContainer</div><div class="diff-removed">-						style={{</div><div class="diff-removed">-							overflow: 'hidden',</div><div class="diff-removed">-							width: shape.props.w,</div><div class="diff-removed">-							height: shape.props.h + props.growY,</div><div class="diff-removed">-						}}</div><div class="diff-removed">-					></div><div class="diff-removed">-						<RichTextLabel</div><div class="diff-removed">-							shapeId={id}</div><div class="diff-removed">-							type={type}</div><div class="diff-removed">-							font={font}</div><div class="diff-removed">-							fontSize={LABEL_FONT_SIZES[size] * shape.props.scale}</div><div class="diff-removed">-							lineHeight={TEXT_PROPS.lineHeight}</div><div class="diff-removed">-							padding={LABEL_PADDING * shape.props.scale}</div><div class="diff-removed">-							fill={fill}</div><div class="diff-removed">-							align={align}</div><div class="diff-removed">-							verticalAlign={verticalAlign}</div><div class="diff-removed">-							richText={richText}</div><div class="diff-removed">-							isSelected={isOnlySelected}</div><div class="diff-removed">-							labelColor={theme[props.labelColor].solid}</div><div class="diff-removed">-							wrap</div><div class="diff-removed">-						/></div><div class="diff-removed">-					</HTMLContainer></div><div class="diff-removed">-				)}</div><div class="diff-removed">-				{shape.props.url && <HyperlinkButton url={shape.props.url} />}</div><div class="diff-removed">-			</></div><div class="diff-removed">-		)</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	indicator(shape: TLGeoShape) {</div><div class="diff-removed">-		const { id, props } = shape</div><div class="diff-removed">-		const { w, size } = props</div><div class="diff-removed">-		const h = props.h + props.growY</div><div class="diff-removed">-</div><div class="diff-removed">-		const strokeWidth = STROKE_SIZES[size]</div><div class="diff-removed">-</div><div class="diff-removed">-		const geometry = this.editor.getShapeGeometry(shape)</div><div class="diff-removed">-</div><div class="diff-removed">-		switch (props.geo) {</div><div class="diff-removed">-			case 'ellipse': {</div><div class="diff-removed">-				if (props.dash === 'draw') {</div><div class="diff-removed">-					return <path d={getEllipseDrawIndicatorPath(id, w, h, strokeWidth)} /></div><div class="diff-removed">-				}</div><div class="diff-removed">-</div><div class="diff-removed">-				return <path d={geometry.getSvgPathData(true)} /></div><div class="diff-removed">-			}</div><div class="diff-removed">-			case 'heart': {</div><div class="diff-removed">-				return <path d={getHeartPath(w, h)} /></div><div class="diff-removed">-			}</div><div class="diff-removed">-			case 'oval': {</div><div class="diff-removed">-				return <path d={geometry.getSvgPathData(true)} /></div><div class="diff-removed">-			}</div><div class="diff-removed">-			case 'cloud': {</div><div class="diff-removed">-				return <path d={getCloudPath(w, h, id, size, shape.props.scale)} /></div><div class="diff-removed">-			}</div><div class="diff-removed">-</div><div class="diff-removed">-			default: {</div><div class="diff-removed">-				const geometry = this.editor.getShapeGeometry(shape)</div><div class="diff-removed">-				const outline =</div><div class="diff-removed">-					geometry instanceof Group2d ? geometry.children[0].vertices : geometry.vertices</div><div class="diff-removed">-				let path: string</div><div class="diff-removed">-</div><div class="diff-removed">-				if (props.dash === 'draw') {</div><div class="diff-removed">-					const polygonPoints = getRoundedPolygonPoints(</div><div class="diff-removed">-						id,</div><div class="diff-removed">-						outline,</div><div class="diff-removed">-						0,</div><div class="diff-removed">-						strokeWidth * 2 * shape.props.scale,</div><div class="diff-removed">-						1</div><div class="diff-removed">-					)</div><div class="diff-removed">-					path = getRoundedInkyPolygonPath(polygonPoints)</div><div class="diff-removed">-				} else {</div><div class="diff-removed">-					path = 'M' + outline[0] + 'L' + outline.slice(1) + 'Z'</div><div class="diff-removed">-				}</div><div class="diff-removed">-</div><div class="diff-removed">-				const lines = getLines(shape.props, strokeWidth)</div><div class="diff-removed">-</div><div class="diff-removed">-				if (lines) {</div><div class="diff-removed">-					for (const [A, B] of lines) {</div><div class="diff-removed">-						path += `M${A.x},${A.y}L${B.x},${B.y}`</div><div class="diff-removed">-					}</div><div class="diff-removed">-				}</div><div class="diff-removed">-</div><div class="diff-removed">-				return <path d={path} /></div><div class="diff-removed">-			}</div><div class="diff-removed">-		}</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	override toSvg(shape: TLGeoShape, ctx: SvgExportContext) {</div><div class="diff-removed">-		// We need to scale the shape to 1x for export</div><div class="diff-removed">-		const newShape = {</div><div class="diff-removed">-			...shape,</div><div class="diff-removed">-			props: {</div><div class="diff-removed">-				...shape.props,</div><div class="diff-removed">-				w: shape.props.w / shape.props.scale,</div><div class="diff-removed">-				h: shape.props.h / shape.props.scale,</div><div class="diff-removed">-			},</div><div class="diff-removed">-		}</div><div class="diff-removed">-		const props = newShape.props</div><div class="diff-removed">-		ctx.addExportDef(getFillDefForExport(props.fill))</div><div class="diff-removed">-</div><div class="diff-removed">-		let textEl</div><div class="diff-removed">-		if (!isEmptyRichText(props.richText)) {</div><div class="diff-removed">-			const theme = getDefaultColorTheme(ctx)</div><div class="diff-removed">-			const bounds = new Box(0, 0, props.w, props.h + props.growY)</div><div class="diff-removed">-			textEl = (</div><div class="diff-removed">-				<RichTextSVG</div><div class="diff-removed">-					fontSize={LABEL_FONT_SIZES[props.size]}</div><div class="diff-removed">-					font={props.font}</div><div class="diff-removed">-					align={props.align}</div><div class="diff-removed">-					verticalAlign={props.verticalAlign}</div><div class="diff-removed">-					richText={props.richText}</div><div class="diff-removed">-					labelColor={theme[props.labelColor].solid}</div><div class="diff-removed">-					bounds={bounds}</div><div class="diff-removed">-					padding={LABEL_PADDING * shape.props.scale}</div><div class="diff-removed">-				/></div><div class="diff-removed">-			)</div><div class="diff-removed">-		}</div><div class="diff-removed">-</div><div class="diff-removed">-		return (</div><div class="diff-removed">-			<></div><div class="diff-removed">-				<GeoShapeBody shouldScale={false} shape={newShape} forceSolid={false} /></div><div class="diff-removed">-				{textEl}</div><div class="diff-removed">-			</></div><div class="diff-removed">-		)</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	override getCanvasSvgDefs(): TLShapeUtilCanvasSvgDef[] {</div><div class="diff-removed">-		return [getFillDefForCanvas()]</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	override onResize(</div><div class="diff-removed">-		shape: TLGeoShape,</div><div class="diff-removed">-		{ handle, newPoint, scaleX, scaleY, initialShape }: TLResizeInfo<TLGeoShape></div><div class="diff-removed">-	) {</div><div class="diff-removed">-		const unscaledInitialW = initialShape.props.w / initialShape.props.scale</div><div class="diff-removed">-		const unscaledInitialH = initialShape.props.h / initialShape.props.scale</div><div class="diff-removed">-		const unscaledGrowY = initialShape.props.growY / initialShape.props.scale</div><div class="diff-removed">-		// use the w/h from props here instead of the initialBounds here,</div><div class="diff-removed">-		// since cloud shapes calculated bounds can differ from the props w/h.</div><div class="diff-removed">-		let unscaledW = unscaledInitialW * scaleX</div><div class="diff-removed">-		let unscaledH = (unscaledInitialH + unscaledGrowY) * scaleY</div><div class="diff-removed">-		let overShrinkX = 0</div><div class="diff-removed">-		let overShrinkY = 0</div><div class="diff-removed">-</div><div class="diff-removed">-		const min = MIN_SIZE_WITH_LABEL</div><div class="diff-removed">-</div><div class="diff-removed">-		if (!isEmptyRichText(shape.props.richText)) {</div><div class="diff-removed">-			let newW = Math.max(Math.abs(unscaledW), min)</div><div class="diff-removed">-			let newH = Math.max(Math.abs(unscaledH), min)</div><div class="diff-removed">-</div><div class="diff-removed">-			if (newW < min && newH === min) newW = min</div><div class="diff-removed">-			if (newW === min && newH < min) newH = min</div><div class="diff-removed">-</div><div class="diff-removed">-			const unscaledLabelSize = getUnscaledLabelSize(this.editor, {</div><div class="diff-removed">-				...shape,</div><div class="diff-removed">-				props: {</div><div class="diff-removed">-					...shape.props,</div><div class="diff-removed">-					w: newW * shape.props.scale,</div><div class="diff-removed">-					h: newH * shape.props.scale,</div><div class="diff-removed">-				},</div><div class="diff-removed">-			})</div><div class="diff-removed">-</div><div class="diff-removed">-			const nextW = Math.max(Math.abs(unscaledW), unscaledLabelSize.w) * Math.sign(unscaledW)</div><div class="diff-removed">-			const nextH = Math.max(Math.abs(unscaledH), unscaledLabelSize.h) * Math.sign(unscaledH)</div><div class="diff-removed">-			overShrinkX = Math.abs(nextW) - Math.abs(unscaledW)</div><div class="diff-removed">-			overShrinkY = Math.abs(nextH) - Math.abs(unscaledH)</div><div class="diff-removed">-</div><div class="diff-removed">-			unscaledW = nextW</div><div class="diff-removed">-			unscaledH = nextH</div><div class="diff-removed">-		}</div><div class="diff-removed">-</div><div class="diff-removed">-		const scaledW = unscaledW * shape.props.scale</div><div class="diff-removed">-		const scaledH = unscaledH * shape.props.scale</div><div class="diff-removed">-</div><div class="diff-removed">-		const offset = new Vec(0, 0)</div><div class="diff-removed">-</div><div class="diff-removed">-		// x offsets</div><div class="diff-removed">-</div><div class="diff-removed">-		if (scaleX < 0) {</div><div class="diff-removed">-			offset.x += scaledW</div><div class="diff-removed">-		}</div><div class="diff-removed">-</div><div class="diff-removed">-		if (handle === 'left' || handle === 'top_left' || handle === 'bottom_left') {</div><div class="diff-removed">-			offset.x += scaleX < 0 ? overShrinkX : -overShrinkX</div><div class="diff-removed">-		}</div><div class="diff-removed">-</div><div class="diff-removed">-		// y offsets</div><div class="diff-removed">-</div><div class="diff-removed">-		if (scaleY < 0) {</div><div class="diff-removed">-			offset.y += scaledH</div><div class="diff-removed">-		}</div><div class="diff-removed">-</div><div class="diff-removed">-		if (handle === 'top' || handle === 'top_left' || handle === 'top_right') {</div><div class="diff-removed">-			offset.y += scaleY < 0 ? overShrinkY : -overShrinkY</div><div class="diff-removed">-		}</div><div class="diff-removed">-</div><div class="diff-removed">-		const { x, y } = offset.rot(shape.rotation).add(newPoint)</div><div class="diff-removed">-</div><div class="diff-removed">-		return {</div><div class="diff-removed">-			x,</div><div class="diff-removed">-			y,</div><div class="diff-removed">-			props: {</div><div class="diff-removed">-				w: Math.max(Math.abs(scaledW), 1),</div><div class="diff-removed">-				h: Math.max(Math.abs(scaledH), 1),</div><div class="diff-removed">-				growY: 0,</div><div class="diff-removed">-			},</div><div class="diff-removed">-		}</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	override onBeforeCreate(shape: TLGeoShape) {</div><div class="diff-removed">-		if (isEmptyRichText(shape.props.richText)) {</div><div class="diff-removed">-			if (shape.props.growY) {</div><div class="diff-removed">-				// No text / some growY, set growY to 0</div><div class="diff-removed">-				return {</div><div class="diff-removed">-					...shape,</div><div class="diff-removed">-					props: {</div><div class="diff-removed">-						...shape.props,</div><div class="diff-removed">-						growY: 0,</div><div class="diff-removed">-					},</div><div class="diff-removed">-				}</div><div class="diff-removed">-			} else {</div><div class="diff-removed">-				// No text / no growY, nothing to change</div><div class="diff-removed">-				return</div><div class="diff-removed">-			}</div><div class="diff-removed">-		}</div><div class="diff-removed">-</div><div class="diff-removed">-		const unscaledPrevHeight = shape.props.h / shape.props.scale</div><div class="diff-removed">-		const unscaledNextHeight = getUnscaledLabelSize(this.editor, shape).h</div><div class="diff-removed">-</div><div class="diff-removed">-		let growY: number | null = null</div><div class="diff-removed">-</div><div class="diff-removed">-		if (unscaledNextHeight > unscaledPrevHeight) {</div><div class="diff-removed">-			growY = unscaledNextHeight - unscaledPrevHeight</div><div class="diff-removed">-		} else {</div><div class="diff-removed">-			if (shape.props.growY) {</div><div class="diff-removed">-				growY = 0</div><div class="diff-removed">-			}</div><div class="diff-removed">-		}</div><div class="diff-removed">-</div><div class="diff-removed">-		if (growY !== null) {</div><div class="diff-removed">-			return {</div><div class="diff-removed">-				...shape,</div><div class="diff-removed">-				props: {</div><div class="diff-removed">-					...shape.props,</div><div class="diff-removed">-					// scale the growY</div><div class="diff-removed">-					growY: growY * shape.props.scale,</div><div class="diff-removed">-				},</div><div class="diff-removed">-			}</div><div class="diff-removed">-		}</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	override onBeforeUpdate(prev: TLGeoShape, next: TLGeoShape) {</div><div class="diff-removed">-		// No change to text, font, or size, no need to update update</div><div class="diff-removed">-		if (</div><div class="diff-removed">-			isEqual(prev.props.richText, next.props.richText) &&</div><div class="diff-removed">-			prev.props.font === next.props.font &&</div><div class="diff-removed">-			prev.props.size === next.props.size</div><div class="diff-removed">-		) {</div><div class="diff-removed">-			return</div><div class="diff-removed">-		}</div><div class="diff-removed">-</div><div class="diff-removed">-		// If we got rid of the text, cancel out any growY from the prev text</div><div class="diff-removed">-		const wasEmpty = isEmptyRichText(prev.props.richText)</div><div class="diff-removed">-		const isEmpty = isEmptyRichText(next.props.richText)</div><div class="diff-removed">-		if (!wasEmpty && isEmpty) {</div><div class="diff-removed">-			return {</div><div class="diff-removed">-				...next,</div><div class="diff-removed">-				props: {</div><div class="diff-removed">-					...next.props,</div><div class="diff-removed">-					growY: 0,</div><div class="diff-removed">-				},</div><div class="diff-removed">-			}</div><div class="diff-removed">-		}</div><div class="diff-removed">-</div><div class="diff-removed">-		// Get the prev width and height in unscaled values</div><div class="diff-removed">-		const unscaledPrevWidth = prev.props.w / prev.props.scale</div><div class="diff-removed">-		const unscaledPrevHeight = prev.props.h / prev.props.scale</div><div class="diff-removed">-		const unscaledPrevGrowY = prev.props.growY / prev.props.scale</div><div class="diff-removed">-</div><div class="diff-removed">-		// Get the next width and height in unscaled values</div><div class="diff-removed">-		const unscaledNextLabelSize = getUnscaledLabelSize(this.editor, next)</div><div class="diff-removed">-</div><div class="diff-removed">-		// When entering the first character in a label (not pasting in multiple characters...)</div><div class="diff-removed">-		if (wasEmpty && !isEmpty && renderPlaintextFromRichText(this.editor, next.props.richText)) {</div><div class="diff-removed">-			let unscaledW = Math.max(unscaledPrevWidth, unscaledNextLabelSize.w)</div><div class="diff-removed">-			let unscaledH = Math.max(unscaledPrevHeight, unscaledNextLabelSize.h)</div><div class="diff-removed">-</div><div class="diff-removed">-			const min = MIN_SIZE_WITH_LABEL</div><div class="diff-removed">-</div><div class="diff-removed">-			// If both the width and height were less than the minimum size, make the shape square</div><div class="diff-removed">-			if (unscaledPrevWidth < min && unscaledPrevHeight < min) {</div><div class="diff-removed">-				unscaledW = Math.max(unscaledW, min)</div><div class="diff-removed">-				unscaledH = Math.max(unscaledH, min)</div><div class="diff-removed">-				unscaledW = Math.max(unscaledW, unscaledH)</div><div class="diff-removed">-				unscaledH = Math.max(unscaledW, unscaledH)</div><div class="diff-removed">-			}</div><div class="diff-removed">-</div><div class="diff-removed">-			// Don't set a growY—at least, not until we've implemented a growX property</div><div class="diff-removed">-			return {</div><div class="diff-removed">-				...next,</div><div class="diff-removed">-				props: {</div><div class="diff-removed">-					...next.props,</div><div class="diff-removed">-					// Scale the results</div><div class="diff-removed">-					w: unscaledW * next.props.scale,</div><div class="diff-removed">-					h: unscaledH * next.props.scale,</div><div class="diff-removed">-					growY: 0,</div><div class="diff-removed">-				},</div><div class="diff-removed">-			}</div><div class="diff-removed">-		}</div><div class="diff-removed">-</div><div class="diff-removed">-		let growY: number | null = null</div><div class="diff-removed">-</div><div class="diff-removed">-		if (unscaledNextLabelSize.h > unscaledPrevHeight) {</div><div class="diff-removed">-			growY = unscaledNextLabelSize.h - unscaledPrevHeight</div><div class="diff-removed">-		} else {</div><div class="diff-removed">-			if (unscaledPrevGrowY) {</div><div class="diff-removed">-				growY = 0</div><div class="diff-removed">-			}</div><div class="diff-removed">-		}</div><div class="diff-removed">-</div><div class="diff-removed">-		if (growY !== null) {</div><div class="diff-removed">-			const unscaledNextWidth = next.props.w / next.props.scale</div><div class="diff-removed">-			return {</div><div class="diff-removed">-				...next,</div><div class="diff-removed">-				props: {</div><div class="diff-removed">-					...next.props,</div><div class="diff-removed">-					// Scale the results</div><div class="diff-removed">-					growY: growY * next.props.scale,</div><div class="diff-removed">-					w: Math.max(unscaledNextWidth, unscaledNextLabelSize.w) * next.props.scale,</div><div class="diff-removed">-				},</div><div class="diff-removed">-			}</div><div class="diff-removed">-		}</div><div class="diff-removed">-</div><div class="diff-removed">-		if (unscaledNextLabelSize.w > unscaledPrevWidth) {</div><div class="diff-removed">-			return {</div><div class="diff-removed">-				...next,</div><div class="diff-removed">-				props: {</div><div class="diff-removed">-					...next.props,</div><div class="diff-removed">-					// Scale the results</div><div class="diff-removed">-					w: unscaledNextLabelSize.w * next.props.scale,</div><div class="diff-removed">-				},</div><div class="diff-removed">-			}</div><div class="diff-removed">-		}</div><div class="diff-removed">-</div><div class="diff-removed">-		// otherwise, no update needed</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	override onDoubleClick(shape: TLGeoShape) {</div><div class="diff-removed">-		// Little easter egg: double-clicking a rectangle / checkbox while</div><div class="diff-removed">-		// holding alt will toggle between check-box and rectangle</div><div class="diff-removed">-		if (this.editor.inputs.altKey) {</div><div class="diff-removed">-			switch (shape.props.geo) {</div><div class="diff-removed">-				case 'rectangle': {</div><div class="diff-removed">-					return {</div><div class="diff-removed">-						...shape,</div><div class="diff-removed">-						props: {</div><div class="diff-removed">-							geo: 'check-box' as const,</div><div class="diff-removed">-						},</div><div class="diff-removed">-					}</div><div class="diff-removed">-				}</div><div class="diff-removed">-				case 'check-box': {</div><div class="diff-removed">-					return {</div><div class="diff-removed">-						...shape,</div><div class="diff-removed">-						props: {</div><div class="diff-removed">-							geo: 'rectangle' as const,</div><div class="diff-removed">-						},</div><div class="diff-removed">-					}</div><div class="diff-removed">-				}</div><div class="diff-removed">-			}</div><div class="diff-removed">-		}</div><div class="diff-removed">-</div><div class="diff-removed">-		return</div><div class="diff-removed">-	}</div><div class="diff-removed">-	override getInterpolatedProps(</div><div class="diff-removed">-		startShape: TLGeoShape,</div><div class="diff-removed">-		endShape: TLGeoShape,</div><div class="diff-removed">-		t: number</div><div class="diff-removed">-	): TLGeoShapeProps {</div><div class="diff-removed">-		return {</div><div class="diff-removed">-			...(t > 0.5 ? endShape.props : startShape.props),</div><div class="diff-removed">-			w: lerp(startShape.props.w, endShape.props.w, t),</div><div class="diff-removed">-			h: lerp(startShape.props.h, endShape.props.h, t),</div><div class="diff-removed">-			scale: lerp(startShape.props.scale, endShape.props.scale, t),</div><div class="diff-removed">-		}</div><div class="diff-removed">-	}</div><div class="diff-added">+  static override type = 'geo' as const</div><div class="diff-added">+  static override props = geoShapeProps</div><div class="diff-added">+  static override migrations = geoShapeMigrations</div><div class="diff-added">+</div><div class="diff-added">+  override canEdit = () => true</div><div class="diff-added">+</div><div class="diff-added">+  override getDefaultProps(): TLGeoShape['props'] {</div><div class="diff-added">+    return {</div><div class="diff-added">+      w: 100,</div><div class="diff-added">+      h: 100,</div><div class="diff-added">+      geo: 'rectangle',</div><div class="diff-added">+      color: 'black',</div><div class="diff-added">+      labelColor: 'black',</div><div class="diff-added">+      fill: 'none',</div><div class="diff-added">+      dash: 'draw',</div><div class="diff-added">+      size: 'm',</div><div class="diff-added">+      font: 'draw',</div><div class="diff-added">+      text: '',</div><div class="diff-added">+      align: 'middle',</div><div class="diff-added">+      verticalAlign: 'middle',</div><div class="diff-added">+      growY: 0,</div><div class="diff-added">+      url: '',</div><div class="diff-added">+    }</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  override getGeometry(shape: TLGeoShape) {</div><div class="diff-added">+    const w = Math.max(1, shape.props.w)</div><div class="diff-added">+    const h = Math.max(1, shape.props.h + shape.props.growY)</div><div class="diff-added">+    const cx = w / 2</div><div class="diff-added">+    const cy = h / 2</div><div class="diff-added">+</div><div class="diff-added">+    const strokeWidth = STROKE_SIZES[shape.props.size]</div><div class="diff-added">+    const isFilled = shape.props.fill !== 'none' // || shape.props.text.trim().length > 0</div><div class="diff-added">+</div><div class="diff-added">+    let body: Geometry2d</div><div class="diff-added">+</div><div class="diff-added">+    switch (shape.props.geo) {</div><div class="diff-added">+      case 'cloud': {</div><div class="diff-added">+        body = new Polygon2d({</div><div class="diff-added">+          points: cloudOutline(w, h, shape.id, shape.props.size),</div><div class="diff-added">+          isFilled,</div><div class="diff-added">+        })</div><div class="diff-added">+        break</div><div class="diff-added">+      }</div><div class="diff-added">+      case 'triangle': {</div><div class="diff-added">+        body = new Polygon2d({</div><div class="diff-added">+          points: [new Vec2d(cx, 0), new Vec2d(w, h), new Vec2d(0, h)],</div><div class="diff-added">+          isFilled,</div><div class="diff-added">+        })</div><div class="diff-added">+        break</div><div class="diff-added">+      }</div><div class="diff-added">+      case 'diamond': {</div><div class="diff-added">+        body = new Polygon2d({</div><div class="diff-added">+          points: [new Vec2d(cx, 0), new Vec2d(w, cy), new Vec2d(cx, h), new Vec2d(0, cy)],</div><div class="diff-added">+          isFilled,</div><div class="diff-added">+        })</div><div class="diff-added">+        break</div><div class="diff-added">+      }</div><div class="diff-added">+      case 'pentagon': {</div><div class="diff-added">+        body = new Polygon2d({</div><div class="diff-added">+          points: getPolygonVertices(w, h, 5),</div><div class="diff-added">+          isFilled,</div><div class="diff-added">+        })</div><div class="diff-added">+        break</div><div class="diff-added">+      }</div><div class="diff-added">+      case 'hexagon': {</div><div class="diff-added">+        body = new Polygon2d({</div><div class="diff-added">+          points: getPolygonVertices(w, h, 6),</div><div class="diff-added">+          isFilled,</div><div class="diff-added">+        })</div><div class="diff-added">+        break</div><div class="diff-added">+      }</div><div class="diff-added">+      case 'octagon': {</div><div class="diff-added">+        body = new Polygon2d({</div><div class="diff-added">+          points: getPolygonVertices(w, h, 8),</div><div class="diff-added">+          isFilled,</div><div class="diff-added">+        })</div><div class="diff-added">+        break</div><div class="diff-added">+      }</div><div class="diff-added">+      case 'ellipse': {</div><div class="diff-added">+        body = new Ellipse2d({</div><div class="diff-added">+          width: w,</div><div class="diff-added">+          height: h,</div><div class="diff-added">+          isFilled,</div><div class="diff-added">+        })</div><div class="diff-added">+        break</div><div class="diff-added">+      }</div><div class="diff-added">+      case 'oval': {</div><div class="diff-added">+        body = new Stadium2d({</div><div class="diff-added">+          width: w,</div><div class="diff-added">+          height: h,</div><div class="diff-added">+          isFilled,</div><div class="diff-added">+        })</div><div class="diff-added">+        break</div><div class="diff-added">+      }</div><div class="diff-added">+      case 'star': {</div><div class="diff-added">+        // Most of this code is to offset the center, a 5 point star</div><div class="diff-added">+        // will need to be moved downward because from its center [0,0]</div><div class="diff-added">+        // it will have a bigger minY than maxY. This is because it'll</div><div class="diff-added">+        // have 2 points at the bottom.</div><div class="diff-added">+        const sides = 5</div><div class="diff-added">+        const step = PI2 / sides / 2</div><div class="diff-added">+        const rightMostIndex = Math.floor(sides / 4) * 2</div><div class="diff-added">+        const leftMostIndex = sides * 2 - rightMostIndex</div><div class="diff-added">+        const topMostIndex = 0</div><div class="diff-added">+        const bottomMostIndex = Math.floor(sides / 2) * 2</div><div class="diff-added">+        const maxX = (Math.cos(-TAU + rightMostIndex * step) * w) / 2</div><div class="diff-added">+        const minX = (Math.cos(-TAU + leftMostIndex * step) * w) / 2</div><div class="diff-added">+</div><div class="diff-added">+        const minY = (Math.sin(-TAU + topMostIndex * step) * h) / 2</div><div class="diff-added">+        const maxY = (Math.sin(-TAU + bottomMostIndex * step) * h) / 2</div><div class="diff-added">+        const diffX = w - Math.abs(maxX - minX)</div><div class="diff-added">+        const diffY = h - Math.abs(maxY - minY)</div><div class="diff-added">+        const offsetX = w / 2 + minX - (w / 2 - maxX)</div><div class="diff-added">+        const offsetY = h / 2 + minY - (h / 2 - maxY)</div><div class="diff-added">+</div><div class="diff-added">+        const ratio = 1</div><div class="diff-added">+        const cx = (w - offsetX) / 2</div><div class="diff-added">+        const cy = (h - offsetY) / 2</div><div class="diff-added">+        const ox = (w + diffX) / 2</div><div class="diff-added">+        const oy = (h + diffY) / 2</div><div class="diff-added">+        const ix = (ox * ratio) / 2</div><div class="diff-added">+        const iy = (oy * ratio) / 2</div><div class="diff-added">+</div><div class="diff-added">+        body = new Polygon2d({</div><div class="diff-added">+          points: Array.from(Array(sides * 2)).map((_, i) => {</div><div class="diff-added">+            const theta = -TAU + i * step</div><div class="diff-added">+            return new Vec2d(</div><div class="diff-added">+              cx + (i % 2 ? ix : ox) * Math.cos(theta),</div><div class="diff-added">+              cy + (i % 2 ? iy : oy) * Math.sin(theta)</div><div class="diff-added">+            )</div><div class="diff-added">+          }),</div><div class="diff-added">+          isFilled,</div><div class="diff-added">+        })</div><div class="diff-added">+        break</div><div class="diff-added">+      }</div><div class="diff-added">+      case 'rhombus': {</div><div class="diff-added">+        const offset = Math.min(w * 0.38, h * 0.38)</div><div class="diff-added">+        body = new Polygon2d({</div><div class="diff-added">+          points: [new Vec2d(offset, 0), new Vec2d(w, 0), new Vec2d(w - offset, h), new Vec2d(0, h)],</div><div class="diff-added">+          isFilled,</div><div class="diff-added">+        })</div><div class="diff-added">+        break</div><div class="diff-added">+      }</div><div class="diff-added">+      case 'rhombus-2': {</div><div class="diff-added">+        const offset = Math.min(w * 0.38, h * 0.38)</div><div class="diff-added">+        body = new Polygon2d({</div><div class="diff-added">+          points: [new Vec2d(0, 0), new Vec2d(w - offset, 0), new Vec2d(w, h), new Vec2d(offset, h)],</div><div class="diff-added">+          isFilled,</div><div class="diff-added">+        })</div><div class="diff-added">+        break</div><div class="diff-added">+      }</div><div class="diff-added">+      case 'trapezoid': {</div><div class="diff-added">+        const offset = Math.min(w * 0.38, h * 0.38)</div><div class="diff-added">+        body = new Polygon2d({</div><div class="diff-added">+          points: [new Vec2d(offset, 0), new Vec2d(w - offset, 0), new Vec2d(w, h), new Vec2d(0, h)],</div><div class="diff-added">+          isFilled,</div><div class="diff-added">+        })</div><div class="diff-added">+        break</div><div class="diff-added">+      }</div><div class="diff-added">+      case 'arrow-right': {</div><div class="diff-added">+        const ox = Math.min(w, h) * 0.38</div><div class="diff-added">+        const oy = h * 0.16</div><div class="diff-added">+        body = new Polygon2d({</div><div class="diff-added">+          points: [</div><div class="diff-added">+            new Vec2d(0, oy),</div><div class="diff-added">+            new Vec2d(w - ox, oy),</div><div class="diff-added">+            new Vec2d(w - ox, 0),</div><div class="diff-added">+            new极2d(w, h / 2),</div><div class="diff-added">+            new Vec2d(w - ox, h),</div><div class="diff-added">+            new Vec2d(w - ox, h - oy),</div><div class="diff-added">+            new Vec2d(0, h - oy),</div><div class="diff-added">+          ],</div><div class="diff-added">+          isFilled,</div><div class="diff-added">+        })</div><div class="diff-added">+        break</div><div class="diff-added">+      }</div><div class="diff-added">+      case 'arrow-left': {</div><div class="diff-added">+        const ox = Math.min(w, h) * 0.38</div><div class="diff-added">+        const oy = h * 0.16</div><div class="diff-added">+        body = new Polygon2d({</div><div class="diff-added">+          points: [</div><div class="diff-added">+            new Vec2d(ox, 0),</div><div class="diff-added">+            new Vec2d(ox, o极),</div><div class="diff-added">+            new Vec2d(w, oy),</div><div class="diff-added">+            new Vec2d(w, h - oy),</div><div class="diff-added">+            new Vec2d(ox, h - oy),</div><div class="diff-added">+            new Vec2d(ox, h),</div><div class="diff-added">+            new Vec2d(0, h / 2),</div><div class="diff-added">+          ],</div><div class="diff-added">+          isFilled,</div><div class="diff-added">+        })</div><div class="diff-added">+        break</div><div class="diff-added">+      }</div><div class="diff-added">+      case 'arrow-up': {</div><div class="diff-added">+        const ox = w * 0.16</div><div class="diff-added">+        const oy = Math.min(w, h) * 0.38</div><div class="diff-added">+        body = new Polygon2d({</div><div class="diff-added">+          points: [</div><div class="diff-added">+            new Vec2d(w / 2, 0),</div><div class="diff-added">+            new Vec2d(w, oy),</div><div class="diff-added">+            new Vec2d(w - ox, oy),</div><div class="diff-added">+            new Vec2d(w - ox, h),</div><div class="diff-added">+            new Vec2d(ox, h),</div><div class="diff-added">+            new Vec2d(ox, oy),</div><div class="diff-added">+            new Vec2d(0, oy),</div><div class="diff-added">+          ],</div><div class="diff-added">+          isFilled,</div><div class="diff-added">+        })</div><div class="diff-added">+        break</div><div class="diff-added">+      }</div><div class="diff-added">+      case 'arrow-down': {</div><div class="diff-added">+        const ox = w * 0.16</div><div class="diff-added">+        const oy = Math.min(w, h) * 0.38</div><div class="diff-added">+        body = new Polygon2d({</div><div class="diff-added">+          points: [</div><div class="diff-added">+            new Vec2d(ox, 0),</div><div class="diff-added">+            new Vec2d(w - ox, 0),</div><div class="diff-added">+            new Vec2d(w - ox, h - oy),</div><div class="diff-added">+            new Vec2d(w, h - oy),</div><div class="diff-added">+            new Vec2d(w / 2, h),</div><div class="diff-added">+            new Vec2d(0, h - oy),</div><div class="diff-added">+            new Vec2d(ox, h - oy),</div><div class="diff-added">+          ],</div><div class="diff-added">+          isFilled,</div><div class="diff-added">+        })</div><div class="diff-added">+        break</div><div class="diff-added">+      }</div><div class="diff-added">+      case 'check-box':</div><div class="diff-added">+      case 'x-box':</div><div class="diff-added">+      case 'rectangle': {</div><div class="diff-added">+        body = new Rectangle2d({</div><div class="diff-added">+          width: w,</div><div class="diff-added">+          height: h,</div><div class="diff-added">+          isFilled,</div><div class="diff-added">+          isSnappable: true,</div><div class="diff-added">+        })</div><div class="diff-added">+        break</div><div class="diff-added">+      }</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    // const labelSize = getLabelSize(this.editor, shape)</div><div class="diff-added">+    // const labelWidth = Math.min(w, Math.max(labelSize.w, Math.min(32, Math.max(1, w - 8)))</div><div class="diff-added">+    // const labelHeight = Math.min(h, Math.max(labelSize.h, Math.min(32, Math.max(1, w - 8)))</div><div class="diff-added">+</div><div class="diff-added">+    const lines = getLines(shape.props, strokeWidth)</div><div class="diff-added">+    const edges = lines ? lines.map((line) => new Polyline2d({ points: line })) : []</div><div class="diff-added">+</div><div class="diff-added">+    return new Group2d({</div><div class="diff-added">+      children: [</div><div class="diff-added">+        body,</div><div class="diff-added">+        // new Rectangle2d({</div><div class="diff-added">+        //   x: w / 2 - labelWidth / 2,</div><div class="diff-added">+        //   y: h / 2 - labelHeight / 2,</div><div class="diff-added">+        //   width: labelWidth,</div><div class="diff-added">+        //   height: labelHeight,</div><div class="diff-added">+        //   isFilled: true,</div><div class="diff-added">+        //   isSnappable: false,</div><div class="diff-added">+        //   margin: 12,</div><div class="diff-added">+        // }),</div><div class="diff-added">+        ...edges,</div><div class="diff-added">+      ],</div><div class="diff-added">+      operation: 'union',</div><div class="diff-added">+      isSnappable: false,</div><div class="diff-added">+    })</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  override onEditEnd: TLOnEditEndHandler<TLGeoShape> = (shape) => {</div><div class="diff-added">+    const {</div><div class="diff-added">+      id,</div><div class="diff-added">+      type,</div><div class="diff-added">+      props: { text },</div><div class="diff-added">+    } = shape</div><div class="diff-added">+</div><div class="diff-added">+    if (text.trimEnd() !== shape.props.text) {</div><div class="diff-added">+      this.editor.updateShapes([</div><div class="diff-added">+        {</div><div class="diff-added">+          id,</div><div class="diff-added">+          type,</div><div class="diff-added">+          props: {</div><div class="diff-added">+            text: text.trimEnd(),</div><div class="diff-added">+          },</div><div class="diff-added">+        },</div><div class="diff-added">+      ])</div><div class="diff-added">+    }</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  component(shape: TLGeoShape) {</div><div class="diff-added">+    const { id, type, props } = shape</div><div class="diff-added">+</div><div class="diff-added">+    const forceSolid = useForceSolid()</div><div class="diff-added">+    const strokeWidth = STROKE_SIZES[props.size]</div><div class="diff-added">+</div><div class="diff-added">+    const { w, color, labelColor, fill, dash, growY, font, align, verticalAlign, size, text } =</div><div class="diff-added">+      props</div><div class="diff-added">+</div><div class="diff-added">+    const getShape = () => {</div><div class="diff-added">+      const h = props.h + growY</div><div class="diff-added">+</div><div class="diff-added">+      switch (props.geo) {</div><div class="diff-added">+        case 'cloud': {</div><div class="diff-added">+          if (dash === 'solid' || (dash === 'draw' && forceSolid)) {</div><div class="diff-added">+            return (</div><div class="diff-added">+              <SolidStyleCloud</div><div class="diff-added">+                color={color}</div><div class="diff-added">+                fill={fill}</div><div class="diff-added">+                strokeWidth={strokeWidth}</div><div class="diff-added">+                w={w}</div><div class="diff-added">+                h={h}</div><div class="diff-added">+                id={id}</div><div class="diff-added">+                size={size}</div><div class="diff-added">+              /></div><div class="diff-added">+            )</div><div class="diff-added">+          } else if (dash === 'dashed' || dash === 'dotted') {</div><div class="diff-added">+            return (</div><div class="diff-added">+              <DashStyleCloud</div><div class="diff-added">+                color={color}</div><div class="diff-added">+                fill={fill}</div><div class="diff-added">+                strokeWidth={strokeWidth}</div><div class="diff-added">+                w={w}</div><div class="diff-added">+                h={h}</div><div class="diff-added">+                id={id}</div><div class="diff-added">+                size={size}</div><div class="diff-added">+                dash={dash === 'dashed' ? dash : size === 's' && forceSolid ? 'dashed' : dash}</div><div class="diff-added">+              /></div><div class="diff-added">+            )</div><div class="diff-added">+          } else if (dash === 'draw') {</div><div class="diff-added">+            return (</div><div class="diff-added">+              <DrawStyleCloud</div><div class="diff-added">+                color={color}</div><div class="diff-added">+                fill={fill}</div><div class="diff-added">+                strokeWidth={strokeWidth}</div><div class="diff-added">+                w={w}</div><div class="diff-added">+                h={h}</div><div class="diff-added">+                id={id}</div><div class="diff-added">+                size={极}</div><div class="diff-added">+              /></div><div class="diff-added">+            )</div><div class="diff-added">+          }</div><div class="diff-added">+</div><div class="diff-added">+          break</div><div class="diff-added">+        }</div><div class="diff-added">+        case 'ellipse': {</div><div class="diff-added">+          if (dash === 'solid' || (dash === 'draw' && forceSolid)) {</div><div class="diff-added">+            return (</div><div class="diff-added">+              <SolidStyleEllipse strokeWidth={strokeWidth} w={w} h={h} color={color} fill={fill} /></div><div class="diff-added">+            )</div><div class="diff-added">+          } else if (dash === 'dashed' || dash === 'dotted') {</div><div class="diff-added">+            return (</div><div class="diff-added">+              <DashStyleEllipse</div><div class="diff-added">+                id={id}</div><div class="diff-added">+                strokeWidth={strokeWidth}</div><div class="diff-added">+                w={w}</div><div class="diff-added">+                h={h}</div><div class="diff-added">+                dash={dash === 'dashed' ? dash : size === 's' && forceSolid ? 'dashed' : dash}</div><div class="diff-added">+                color={color}</div><div class="diff-added">+                fill={fill}</div><div class="diff-added">+              /></div><div class="diff-added">+            )</div><div class="diff-added">+          } else if (dash === 'draw') {</div><div class="diff-added">+            return (</div><div class="diff-added">+              <SolidStyleEllipse strokeWidth={strokeWidth} w={w} h={h} color={color} fill={fill} /></div><div class="diff-added">+            )</div><div class="diff-added">+          }</div><div class="diff-added">+          break</div><div class="diff-added">+        }</div><div class="diff-added">+        case 'oval': {</div><div class="diff-added">+          if (dash === 'solid' || (dash === 'draw' && forceSolid)) {</div><div class="diff-added">+            return (</div><div class="diff-added">+              <SolidStyleOval strokeWidth={strokeWidth} w={w} h={h} color={color} fill={fill} /></div><div class="diff-added">+            )</div><div class="diff-added">+          } else if (dash === 'dashed' || dash === 'dotted') {</div><div class="diff-added">+            return (</div><div class="diff-added">+              <DashStyleOval</div><div class="diff-added">+                id={id}</div><div class="diff-added">+                strokeWidth={strokeWidth}</div><div class="diff-added">+                w={w}</div><div class="diff-added">+                h={h}</div><div class="diff-added">+                dash={dash === 'dashed' ? dash : size === 's' && forceSolid ? 'dashed' : dash}</div><div class="diff-added">+                color={color}</div><div class="diff-added">+                fill={fill}</div><div class="diff-added">+              /></div><div class="diff-added">+            )</div><div class="diff-added">+          } else if (dash === 'draw') {</div><div class="diff-added">+            return (</div><div class="diff-added">+              <SolidStyleOval strokeWidth={strokeWidth} w={w} h={h} color={color} fill={fill} /></div><div class="diff-added">+            )</div><div class="diff-added">+          }</div><div class="diff-added">+          break</div><div class="diff-added">+        }</div><div class="diff-added">+        default: {</div><div class="diff-added">+          const outline = this.editor.getOutline(shape)</div><div class="diff-added">+          const lines = getLines(shape.props, strokeWidth)</div><div class="diff-added">+</div><div class="diff-added">+          if (dash === 'solid' || (dash === 'draw' && forceSolid)) {</div><div class="diff-added">+            return (</div><div class="diff-added">+              <SolidStylePolygon</div><div class="diff-added">+                fill={fill}</div><div class="diff-added">+                color={color}</div><div class="diff-added">+                strokeWidth={strokeWidth}</div><div class="diff-added">+                outline={outline}</div><div class="diff-added">+                lines={lines}</div><div class="diff-added">+              /></div><div class="diff-added">+            )</div><div class="diff-added">+          } else if (dash === 'dashed' || dash === 'dotted') {</div><div class="diff-added">+            return (</div><div class="diff-added">+              <DashStylePolygon</div><div class="diff-added">+                dash={dash === 'dashed' ? dash : size === 's' && forceSolid ? 'dashed' : dash}</div><div class="diff-added">+                fill={fill}</div><div class="diff-added">+                color={color}</div><div class="diff-added">+                strokeWidth={strokeWidth}</div><div class="diff-added">+                outline={outline}</div><div class="diff-added">+                lines={lines}</div><div class="diff-added">+              /></div><div class="diff-added">+            )</div><div class="diff-added">+          } else if (dash === 'draw') {</div><div class="diff-added">+            return (</div><div class="diff-added">+              <DrawStylePolygon</div><div class="diff-added">+                id={id}</div><div class="diff-added">+                fill={fill}</div><div class="diff-added">+                color={color}</div><div class="diff-added">+                strokeWidth={strokeWidth}</div><div class="diff-added">+                outline={outline}</div><div class="diff-added">+                lines={lines}</div><div class="diff-added">+              /></div><div class="diff-added">+            )</div><div class="diff-added">+          }</div><div class="diff-added">+        }</div><div class="diff-added">+      }</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    return (</div><div class="diff-added">+      <></div><div class="diff-added">+        <SVGContainer id={id}>{getShape()}</SVGContainer></div><div class="diff-added">+        <TextLabel</div><div class="diff-added">+          id={id}</div><div class="diff-added">+          type={type}</div><div class="diff-added">+          font={font}</div><div class="diff-added">+          fill={fill}</div><div class="diff-added">+          size={size}</div><div class="diff-added">+          align={align}</div><div class="diff-added">+          verticalAlign={verticalAlign}</div><div class="diff-added">+          text={text}</div><div class="diff-added">+          labelColor={labelColor}</div><div class="diff-added">+          wrap</div><div class="diff-added">+        /></div><div class="diff-added">+        {shape.props.url && (</div><div class="diff-added">+          <HyperlinkButton url={shape.props.url} zoomLevel={this.editor.zoomLevel} /></div><div class="diff-added">+        )}</div><div class="diff-added">+      </></div><div class="diff-added">+    )</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  indicator(shape: TLGeoShape) {</div><div class="diff-added">+    const { id, props } = shape</div><div class="diff-added">+    const { w, size } = props</div><div class="diff-added">+    const h = props.h + props.growY</div><div class="diff-added">+</div><div class="diff-added">+    const forceSolid = useForceSolid()</div><div class="diff-added">+    const strokeWidth = STROKE_SIZES[size]</div><div class="diff-added">+</div><div class="diff-added">+    switch (props.geo) {</div><div class="diff-added">+      case 'ellipse': {</div><div class="diff-added">+        if (props.dash === 'draw' && !forceSolid) {</div><div class="diff-added">+          return <path d={getEllipseIndicatorPath(id, w, h, strokeWidth)} /></div><div class="diff-added">+        }</div><div class="diff-added">+</div><div class="diff-added">+        return <ellipse cx={w / 2} cy={h / 2} rx={w / 2} ry={h / 2} /></div><div class="diff-added">+      }</div><div class="diff-added">+      case 'oval': {</div><div class="diff-added">+        return <path d={getOvalIndicatorPath(w, h)} /></div><div class="diff-added">+      }</div><div class="diff-added">+      case 'cloud': {</div><div class="diff-added">+        return <path d={cloudSvgPath(w, h, id, size)} /></div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+      default: {</div><div class="diff-added">+        const outline = this.editor.getOutline(shape)</div><div class="diff-added">+        let path: string</div><div class="diff-added">+</div><div class="diff-added">+        if (props.dash === 'draw' && !forceSolid) {</div><div class="diff-added">+          const polygonPoints = getRoundedPolygonPoints(id, outline, 0, strokeWidth * 2, 1)</div><div class="diff-added">+          path = getRoundedInkyPolygonPath(polygonPoints)</div><div class="diff-added">+        } else {</div><div class="diff-added">+          path = 'M' + outline[0] + 'L' + outline.slice(1) + 'Z'</div><div class="diff-added">+        }</div><div class="diff-added">+</div><div class="diff-added">+        const lines = getLines(shape.props, strokeWidth)</div><div class="diff-added">+</div><div class="diff-added">+        if (lines) {</div><div class="diff-added">+          for (const [A, B] of lines) {</div><div class="diff-added">+            path += `M${A.x},${A.y}L${B.x},${B.y}`</div><div class="diff-added">+          }</div><div class="diff-added">+        }</div><div class="diff-added">+</div><div class="diff-added">+        return <path d={path} /></div><div class="diff-added">+      }</div><div class="diff-added">+    }</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  override toSvg(shape: TLGeoShape, ctx: SvgExportContext) {</div><div class="diff-added">+    const { id, props } = shape</div><div class="diff-added">+    const strokeWidth = STROKE_SIZES[props.size]</div><div class="diff-added">+    const theme = getDefaultColorTheme({ isDarkMode: this.editor.user.isDarkMode })</div><div class="diff-added">+    ctx.addExportDef(getFillDefForExport(shape.props.fill, theme))</div><div class="diff-added">+</div><div class="diff-added">+    let svgElm: SVGElement</div><div class="diff-added">+</div><div class="diff-added">+    switch (props.geo) {</div><div class="diff-added">+      case 'ellipse': {</div><div class="diff-added">+        switch (props.dash) {</div><div class="diff-added">+          case 'draw':</div><div class="diff-added">+            svgElm = DrawStyleEllipseSvg({</div><div class="diff-added">+              id,</div><div class="diff-added">+              w: props.w,</div><div class="diff-added">+              h: props.h,</div><div class="diff-added">+              color: props.color,</div><div class="diff-added">+              fill: props.fill,</div><div class="diff-added">+              strokeWidth,</div><div class="diff-added">+              theme,</div><div class="diff-added">+            })</div><div class="diff-added">+            break</div><div class="diff-added">+</div><div class="diff-added">+          case 'solid':</div><div class="diff-added">+            svgElm = SolidStyleEllipseSvg({</div><div class="diff-added">+              strokeWidth,</div><div class="diff-added">+              w: props.w,</div><div class="diff-added">+              h: props.h,</div><div class="diff-added">+              color: props.color,</div><div class="diff-added">+              fill极props.fill,</div><div class="diff-added">+              theme,</div><div class="diff-added">+            })</div><div class="diff-added">+            break</div><div class="diff-added">+</div><div class="diff-added">+          default:</div><div class="diff-added">+            svgElm = DashStyleEllipseSvg({</div><div class="diff-added">+              id,</div><div class="diff-added">+              strokeWidth,</div><div class="diff-added">+              w: props.w,</div><div class="diff-added">+              h: props.h,</div><div class="diff-added">+              dash: props.dash,</div><div class="diff-added">+              color: props.color,</div><div class="diff-added">+              fill: props.fill,</div><div class="diff-added">+              theme,</div><div class="diff-added">+            })</div><div class="diff-added">+            break</div><div class="diff-added">+        }</div><div class="diff-added">+        break</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+      case 'oval': {</div><div class="diff-added">+        switch (props.dash) {</div><div class="diff-added">+          case 'draw':</div><div class="diff-added">+            svgElm = DashStyleOvalSvg({</div><div class="diff-added">+              id,</div><div class="diff-added">+              strokeWidth,</div><div class="diff-added">+              w: props.w,</div><div class="diff-added">+              h: props.h,</div><div class="diff-added">+              dash: props.dash,</div><div class="diff-added">+              color: props.color,</div><div class="diff-added">+              fill: props.fill,</div><div class="diff-added">+              theme,</div><div class="diff-added">+            })</div><div class="diff-added">+            break</div><div class="diff-added">+</div><div class="diff-added">+          case 'solid':</div><div class="diff-added">+            svgElm = SolidStyleOvalSvg({</div><div class="diff-added">+              strokeWidth,</div><div class="diff-added">+              w: props.w,</div><div class="diff-added">+              h: props.h,</div><div class="diff-added">+              color: props.color,</div><div class="diff-added">+              fill: props.fill,</div><div class="diff-added">+              theme,</div><div class="diff-added">+            })</div><div class="diff-added">+            break</div><div class="diff-added">+</div><div class="diff-added">+          default:</div><div class="diff-added">+            svgElm = DashStyleOvalSvg({</div><div class="diff-added">+              id,</div><div class="diff-added">+              strokeWidth,</div><div class="diff-added">+              w: props.w,</div><div class="diff-added">+              h: props.h,</div><div class="diff-added">+              dash: props.dash,</div><div class="diff-added">+              color: props.color,</div><div class="diff-added">+              fill: props.fill,</div><div class="diff-added">+              theme,</div><div class="diff-added">+            })</div><div class="diff-added">+        }</div><div class="diff-added">+        break</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+      case 'cloud': {</div><div class="diff-added">+        switch (props.dash) {</div><div class="diff-added">+          case 'draw':</div><div class="diff-added">+            svgElm = DrawStyleCloudSvg({</div><div class="diff-added">+              id,</div><div class="diff-added">+              strokeWidth,</div><div class="diff-added">+              w: props.w,</div><div class="diff-added">+              h: props.h,</div><div class="diff-added">+              color: props.color,</div><div class="diff-added">+              fill: props.fill,</div><div class="diff-added">+              size: props.size,</div><div class="diff-added">+              theme,</div><div class="diff-added">+            })</div><div class="diff-added">+            break</div><div class="diff-added">+</div><div class="diff-added">+          case 'solid':</div><div class="diff-added">+            svgElm = SolidStyleCloudSvg({</div><div class="diff-added">+              strokeWidth,</div><div class="diff-added">+              w: props.w,</div><div class="diff-added">+              h: props.h,</div><div class="diff-added">+              color: props.color,</div><div class="diff-added">+              fill: props.fill,</div><div class="diff-added">+              size: props.size,</div><div class="diff-added">+              id,</div><div class="diff-added">+              theme,</div><div class="diff-added">+            })</div><div class="diff-added">+            break</div><div class="diff-added">+</div><div class="diff-added">+          default:</div><div class="diff-added">+            svgElm = DashStyleCloudSvg({</div><div class="diff-added">+              id,</div><div class="diff-added">+              strokeWidth,</div><div class="diff-added">+              w: props.w,</div><div class="diff-added">+              h: props.h,</div><div class="diff-added">+              dash: props.dash,</div><div class="diff-added">+              color: props.color,</div><div class="diff-added">+              fill: props.fill,</div><div class="diff-added">+              theme,</div><div class="diff-added">+              size: props.size,</div><div class="diff-added">+            })</div><div class="diff-added">+        }</div><div class="diff-added">+        break</div><div class="diff-added">+      }</div><div class="diff-added">+      default: {</div><div class="diff-added">+        const outline = this.editor.getOutline(shape)</div><div class="diff-added">+        const lines = getLines(shape.props, strokeWidth)</div><div class="diff-added">+</div><div class="diff-added">+        switch (props.dash) {</div><div class="diff-added">+          case 'draw':</div><div class="diff-added">+            svgElm = DrawStylePolygonSvg({</div><div class="diff-added">+              id,</div><div class="diff-added">+              fill: props.fill,</div><div class="diff-added">+              color: props.color,</div><div class="diff-added">+              strokeWidth,</div><div class="diff-added">+              outline,</div><div class="diff-added">+              lines,</div><div class="diff-added">+              theme,</div><div class="diff-added">+            })</div><div class="diff-added">+            break</div><div class="diff-added">+</div><div class="diff-added">+          case 'solid':</div><div class="diff-added">+            svgElm = SolidStylePolygonSvg({</div><div class="diff-added">+              fill: props.fill,</div><div class="diff-added">+              color: props.color,</div><div class="diff-added">+              strokeWidth,</div><div class="diff-added">+              outline,</div><div class="diff-added">+              lines,</div><div class="diff-added">+              theme,</div><div class="diff-added">+            })</div><div class="diff-added">+            break</div><div class="diff-added">+</div><div class="diff-added">+          default:</div><div class="diff-added">+            svgElm = DashStylePolygonSvg({</div><div class="diff-added">+              dash: props.dash,</div><div class="diff-added">+              fill: props.fill,</div><div class="diff-added">+              color: props.color,</div><div class="diff-added">+              strokeWidth,</div><div class="diff-added">+              outline,</div><div class="diff-added">+              lines,</div><div class="diff-added">+              theme,</div><div class="diff-added">+            })</div><div class="diff-added">+            break</div><div class="diff-added">+        }</div><div class="diff-added">+        break</div><div class="diff-added">+      }</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    if (props.text) {</div><div class="diff-added">+      const bounds = this.editor.getBounds(shape)</div><div class="diff-added">+</div><div class="diff-added">+      ctx.addExportDef(getFontDefForExport(shape.props.font))</div><div class="diff-added">+</div><div class="diff-added">+      const rootTextElm = getTextLabelSvgElement({</div><div class="diff-added">+        editor: this.editor,</div><div class="diff-added">+        shape,</div><div class="diff-added">+        font: DefaultFontFamilies[shape.props.font],</div><div class="diff-added">+        bounds,</div><div class="diff-added">+      })</div><div class="diff-added">+</div><div class="diff-added">+      const textElm = rootTextElm.cloneNode(true) as SVGTextElement</div><div class="diff-added">+      textElm.setAttribute('fill', theme[shape.props.labelColor].solid)</div><div class="diff-added">+      textElm.setAttribute('stroke', 'none')</div><div class="diff-added">+</div><div class="diff-added">+      const textBgEl = rootTextElm.cloneNode(true) as SVGTextElement</div><div class="diff-added">+      textBgEl.setAttribute('stroke-width', '2')</div><div class="diff-added">+      textBgEl.setAttribute('fill', theme.background)</div><div class="diff-added">+      textBgEl.setAttribute('stroke', theme.background)</div><div class="diff-added">+</div><div class="diff-added">+      const groupEl = document.createElementNS('http://www.w3.org/2000/svg', 'g')</div><div class="diff-added">+      groupEl.append(textBgEl)</div><div class="diff-added">+      groupEl.append(textElm)</div><div class="diff-added">+</div><div class="diff-added">+      if (svgElm.nodeName === 'g') {</div><div class="diff-added">+        svgElm.appendChild(groupEl)</div><div class="diff-added">+        return svgElm</div><div class="diff-added">+      } else {</div><div class="diff-added">+        const g = document.createElementNS('http://www.w3.org/2000/svg', 'g')</div><div class="diff-added">+        g.appendChild(svgElm)</div><div class="diff-added">+        g.appendChild(groupEl)</div><div class="diff-added">+        return g</div><div class="diff-added">+      }</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    return svgElm</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  override getCanvasSvgDefs(): TLShapeUtilCanvasSvgDef[] {</div><div class="diff-added">+    return [getFillDefForCanvas()]</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  override onResize: TLOnResizeHandler<TLGeoShape> = (</div><div class="diff-added">+    shape,</div><div class="diff-added">+    { initialBounds, handle, newPoint, scaleX, scaleY }</div><div class="diff-added">+  ) => {</div><div class="diff-added">+    let w = initialBounds.width * scaleX</div><div class="diff-added">+    let h = initialBounds.height * scaleY</div><div class="diff-added">+    let overShrinkX = 0</div><div class="diff-added">+    let overShrinkY = 0</div><div class="diff-added">+</div><div class="diff-added">+    if (shape.props.text.trim()) {</div><div class="diff-added">+      let newW = Math.max(Math.abs(w), MIN_SIZE_WITH_LABEL)</div><div class="diff-added">+      let newH = Math.max(Math.abs(h), MIN_SIZE_WITH_LABEL)</div><div class="diff-added">+</div><div class="diff-added">+      if (newW < MIN_SIZE_WITH_LABEL && newH === MIN_SIZE_WITH_LABEL) {</div><div class="diff-added">+        newW = MIN_SIZE_WITH_LABEL</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+      if (newW === MIN_SIZE_WITH_LABEL && newH < MIN_SIZE_WITH_LABEL) {</div><div class="diff-added">+        newH = MIN_SIZE_WITH_LABEL</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+      const labelSize = getLabelSize(this.editor, {</div><div class="diff-added">+        ...shape,</div><div class="diff-added">+        props: {</div><div class="diff-added">+          ...shape.props,</div><div class="diff-added">+          w: newW,</div><div class="diff-added">+          h: newH,</div><div class="diff-added">+        },</div><div class="diff-added">+      })</div><div class="diff-added">+</div><div class="diff-added">+      const nextW = Math.max(Math.abs(w), labelSize.w) * Math.sign(w)</div><div class="diff-added">+      const nextH = Math.max(Math.abs(h), labelSize.h) * Math.sign(h)</div><div class="diff-added">+      overShrinkX = Math.abs(nextW) - Math.abs(w)</div><div class="diff-added">+      overShrinkY = Math.abs(nextH) - Math.abs(h)</div><div class="diff-added">+</div><div class="diff-added">+      w = nextW</div><div class="diff-added">+      h = nextH</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    const offset = new Vec2d(0, 0)</div><div class="diff-added">+</div><div class="diff-added">+    // x offsets</div><div class="diff-added">+</div><div class="diff-added">+    if (scaleX < 0) {</div><div class="diff-added">+      offset.x += w</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    if (handle === 'left' || handle === 'top_left' || handle === 'bottom_left') {</div><div class="diff-added">+      offset.x += scaleX < 0 ? overShrinkX : -overShrinkX</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    // y offsets</div><div class="diff-added">+</div><div class="diff-added">+    if (scaleY < 0) {</div><div class="diff-added">+      offset.y += h</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    if (handle === 'top' || handle === 'top_left' || handle === 'top_right') {</div><div class="diff-added">+      offset.y += scaleY < 0 ? overShrinkY : -overShrinkY</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    const { x, y } = offset.rot(shape.rotation).add(newPoint)</div><div class="diff-added">+</div><div class="diff-added">+    return {</div><div class="diff-added">+      x,</div><div class="diff-added">+      y,</div><div class="diff-added">+      props: {</div><div class="diff-added">+        w: Math.max(Math.abs(w), 1),</div><div class="diff-added">+        h: Math.max(Math.abs(h), 1),</div><div class="diff-added">+        growY: 0,</div><div class="diff-added">+      },</div><div class="diff-added">+    }</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  override onBeforeCreate = (shape: TLGeoShape) => {</div><div class="diff-added">+    if (!shape.props.text) {</div><div class="diff-added">+      if (shape.props.growY) {</div><div class="diff-added">+        // No text / some growY, set growY to 0</div><div class="diff-added">+        return {</div><div class="diff-added">+          ...shape,</div><div class="diff-added">+          props: {</div><div class="diff-added">+            ...shape.props,</div><div class="diff-added">+            growY: 0,</div><div class="diff-added">+          },</div><div class="diff-added">+        }</div><div class="diff-added">+      } else {</div><div class="diff-added">+        // No text / no growY, nothing to change</div><div class="diff-added">+        return</div><div class="diff-added">+      }</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    const prevHeight = shape.props.h</div><div class="diff-added">+    const nextHeight = getLabelSize(this.editor, shape).h</div><div class="diff-added">+</div><div class="diff-added">+    let growY: number | null = null</div><div class="diff-added">+</div><div class="diff-added">+    if (nextHeight > prevHeight) {</div><div class="diff-added">+      growY = nextHeight - prevHeight</div><div class="diff-added">+    } else {</div><div class="diff-added">+      if (shape.props.growY) {</div><div class="diff-added">+        growY = 0</div><div class="diff-added">+      }</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    if (growY !== null) {</div><div class="diff-added">+      return {</div><div class="diff-added">+        ...shape,</div><div class="diff-added">+        props: {</div><div class="diff-added">+          ...shape.props,</div><div class="diff-added">+          growY,</div><div class="diff-added">+        },</div><div class="diff-added">+      }</div><div class="diff-added">+    }</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  override onBeforeUpdate = (prev: TLGeoShape, next: TLGeoShape) => {</div><div class="diff-added">+    const prevText = prev.props.text.trimEnd()</div><div class="diff-added">+    const nextText = next.props.text.trimEnd()</div><div class="diff-added">+</div><div class="diff-added">+    if (</div><div class="diff-added">+      prevText === nextText &&</div><div class="diff-added">+      prev.props.font === next.props.font &&</div><div class="diff-added">+      prev.props.size === next.props.size</div><div class="diff-added">+    ) {</div><div class="diff-added">+      return</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    if (prevText && !nextText) {</div><div class="diff-added">+      return {</div><div class="diff-added">+        ...next,</div><div class="diff-added">+        props: {</div><div class="diff-added">+          ...next.props,</div><div class="diff-added">+          growY: 0,</div><div class="diff-added">+        },</div><div class="diff-added">+      }</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    const prevWidth = prev.props.w</div><div class="diff-added">+    const prevHeight = prev.props.h</div><div class="diff-added">+    const nextSize = getLabelSize(this.editor, next)</div><div class="diff-added">+    const nextWidth = nextSize.w</div><div class="diff-added">+    const nextHeight = nextSize.h</div><div class="diff-added">+</div><div class="diff-added">+    // When entering the first character in a label (not pasting in multiple characters...)</div><div class="diff-added">+    if (!prevText && nextText && nextText.length === 1) {</div><div class="diff-added">+      let w = Math.max(prevWidth, nextWidth)</div><div class="diff-added">+      let h = Math.max(prevHeight, nextHeight)</div><div class="diff-added">+</div><div class="diff-added">+      // If both the width and height were less than the minimum size, make the shape square</div><div class="diff-added">+      if (prev.props.w < MIN_SIZE_WITH_LABEL && prev.props.h < MIN_SIZE_WITH_LAB极) {</div><div class="diff-added">+        w = Math.max(w, MIN_SIZE_WITH_LABEL)</div><div class="diff-added">+        h = Math.max(h, MIN_SIZE_WITH_LABEL)</div><div class="diff-added">+        w = Math.max(w, h)</div><div class="diff-added">+        h = Math.max(w, h)</div><div class="diff-added">+      }</div><div class="diff-added">+</div><div class="diff-added">+      // Don't set a growY—at least, not until we've implemented a growX property</div><div class="diff-added">+      return {</div><div class="diff-added">+        ...next,</div><div class="diff-added">+        props: {</div><div class="diff-added">+          ...next.props,</div><div class="diff-added">+          w,</div><div class="diff-added">+          h,</div><div class="diff-added">+          growY: 0,</div><div class="diff-added">+        },</div><div class="diff-added">+      }</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    let growY: number | null = null</div><div class="diff-added">+</div><div class="diff-added">+    if (nextHeight > prevHeight) {</div><div class="diff-added">+      growY = nextHeight - prevHeight</div><div class="diff-added">+    } else {</div><div class="diff-added">+      if (prev.props.growY) {</div><div class="diff-added">+        growY = 0</div><div class="diff-added">+      }</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    if (growY !== null) {</div><div class="diff-added">+      return {</div><div class="diff-added">+        ...next,</div><div class="diff-added">+        props: {</div><div class="diff-added">+          ...next.props,</div><div class="diff-added">+          growY,</div><div class="diff-added">+          w: Math.max(next.props.w, nextWidth),</div><div class="diff-added">+        },</div><div class="diff-added">+      }</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    if (nextWidth > prev.props.w) {</div><div class="diff-added">+      return {</div><div class="diff-added">+        ...next,</div><div class="diff-added">+        props: {</div><div class="diff-added">+          ...next.props,</div><div class="diff-added">+          w: nextWidth,</div><div class="diff-added">+        },</div><div class="diff-added">+      }</div><div class="diff-added">+    }</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  override onDoubleClick = (shape: TLGeoShape) => {</div><div class="diff-added">+    // Little easter egg: double-clicking a rectangle / checkbox while</div><div class="diff-added">+    // holding alt will toggle between check-box and rectangle</div><div class="diff-added">+    if (this.editor.inputs.altKey) {</div><div class="diff-added">+      switch (shape.props.geo) {</div><div class="diff-added">+        case 'rectangle': {</div><div class="diff-added">+          return {</div><div class="diff-added">+            ...shape,</div><div class="diff-added">+            props: {</div><div class="diff-added">+              geo: 'check-box' as const,</div><div class="diff-added">+            },</div><div class="diff-added">+          }</div><div class="diff-added">+        }</div><div class="diff-added">+        case 'check-box': {</div><div class="diff-added">+          return {</div><div class="diff-added">+            ...shape,</div><div class="diff-added">+            props: {</div><div class="diff-added">+              geo: 'rectangle' as const,</div><div class="diff-added">+            },</div><div class="diff-added">+          }</div><div class="diff-added">+        }</div><div class="diff-added">+      }</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    return</div><div class="diff-added">+  }</div><div class="diff-added">+}</div><div class="diff-added">+</div><div class="diff-added">+function getLabelSize(editor: Editor, shape: TLGeoShape) {</div><div class="diff-added">+  const text = shape.props.text.trimEnd()</div><div class="diff-added">+</div><div class="diff-added">+  if (!text) {</div><div class="diff-added">+    return { w: 0, h: 0 }</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  const minSize = editor.textMeasure.measureText('w', {</div><div class="diff-added">+    ...TEXT_PROPS,</div><div class="diff-added">+    fontFamily: FONT_FAMILIES[shape.props.font],</div><div class="diff-added">+    fontSize: LABEL_FONT_SIZES[shape.props.size],</div><div class="diff-added">+    width: 'fit-content',</div><div class="diff-added">+    maxWidth: '100px',</div><div class="diff-added">+  })</div><div class="diff-added">+</div><div class="diff-added">+  // TODO: Can I get these from somewhere?</div><div class="diff-added">+  const sizes = {</div><div class="diff-added">+    s: 2,</div><div class="diff-added">+    m: 3.5,</div><div class="diff-added">+    l: 5,</div><div class="diff-added">+    xl: 10,</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  const size = editor.textMeasure.measureText(text, {</div><div class="diff-added">+    ...TEXT_PROPS,</div><div class="diff-added">+    fontFamily: FONT_FAMILIES[shape.props.font],</div><div class="diff-added">+    fontSize: LABEL_FONT_SIZES[shape.props.size],</div><div class="diff-added">+    width: 'fit-content',</div><div class="diff-added">+    minWidth: minSize.w + 'px',</div><div class="diff-added">+    maxWidth:</div><div class="diff-added">+      Math.max(</div><div class="diff-added">+        // Guard because a DOM nodes can't be less 0</div><div class="diff-added">+        0,</div><div class="diff-added">+        // A 'w' width that we're setting as the min-width</div><div class="diff-added">+        Math.ceil(minSize.w + sizes[shape.props.size]),</div><div class="diff-added">+        // The actual text size</div><div class="diff-added">+        Math.ceil(shape.props.w - LABEL_PADDING * 2)</div><div class="diff-added">+      ) + 'px',</div><div class="diff-added">+  })</div><div class="diff-added">+</div><div class="diff-added">+  return {</div><div class="diff-added">+    w: size.w + LABEL_PADDING * 2,</div><div class="diff-added">+    h: size.h + LABEL_PADDING * 2,</div><div class="diff-added">+  }</div><div class="diff-added">+}</div><div class="diff-added">+</div><div class="diff-added">+function getLines(props: TLGeoShape['props'], sw: number) {</div><div class="diff-added">+  switch (props.geo) {</div><div class="diff-added">+    case 'x-box': {</div><div class="diff-added">+      return getXBoxLines(props.w, props.h, sw, props.dash)</div><div class="diff-added">+    }</div><div class="diff-added">+    case 'check-box': {</div><div class="diff-added">+      return getCheckBoxLines(props.w, props.h)</div><div class="diff-added">+    }</div><div class="diff-added">+    default: {</div><div class="diff-added">+      return undefined</div><div class="diff-added">+    }</div><div class="diff-added">+  }</div><div class="diff-added">+}</div><div class="diff-added">+</div><div class="diff-added">+function getXBoxLines(w: number, h: number, sw: number, dash: TLDefaultDashStyle) {</div><div class="diff-added">+  const inset = dash === 'draw' ? 0.62 : 0</div><div class="diff-added">+</div><div class="diff-added">+  if (dash === 'dashed') {</div><div class="diff-added">+    return [</div><div class="diff-added">+      [new Vec2d(0, 0), new Vec2d(w / 2, h / 2)],</div><div class="diff-added">+      [new Vec2d(w, h), new Vec2d(w / 2, h / 2)],</div><div class="diff-added">+      [new Vec2d(0, h), new Vec2d(w / 2, h / 2)],</div><div class="diff-added">+      [new Vec2d(w, 0), new Vec2d(w / 2, h / 2)],</div><div class="diff-added">+    ]</div><div class="diff-added">+  }</div><div class="diff-added">+</div><div class="diff-added">+  return [</div><div class="diff-added">+    [new Vec2d(sw * inset, sw * inset), new Vec2d(w - sw * inset, h - sw * inset)],</div><div class="diff-added">+    [new Vec2d(sw * inset, h - sw * inset), new Vec2d(w - sw * inset, sw * inset)],</div><div class="diff-added">+  ]</div><div> }</div><div> </div><div class="diff-removed">-function getUnscaledLabelSize(editor: Editor, shape: TLGeoShape) {</div><div class="diff-removed">-	const { richText, font, size, w } = shape.props</div><div class="diff-removed">-</div><div class="diff-removed">-	if (!richText || isEmptyRichText(richText)) {</div><div class="diff-removed">-		return { w: 0, h: 0 }</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	const minSize = editor.textMeasure.measureText('w', {</div><div class="diff-removed">-		...TEXT_PROPS,</div><div class="diff-removed">-		fontFamily: FONT_FAMILIES[font],</div><div class="diff-removed">-		fontSize: LABEL_FONT_SIZES[size],</div><div class="diff-removed">-		maxWidth: 100, // ?</div><div class="diff-removed">-	})</div><div class="diff-removed">-</div><div class="diff-removed">-	// TODO: Can I get these from somewhere?</div><div class="diff-removed">-	const sizes = {</div><div class="diff-removed">-		s: 2,</div><div class="diff-removed">-		m: 3.5,</div><div class="diff-removed">-		l: 5,</div><div class="diff-removed">-		xl: 10,</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	const html = renderHtmlFromRichTextForMeasurement(editor, richText)</div><div class="diff-removed">-	const textSize = editor.textMeasure.measureHtml(html, {</div><div class="diff-removed">-		...TEXT_PROPS,</div><div class="diff-removed">-		fontFamily: FONT_FAMILIES[font],</div><div class="diff-removed">-		fontSize: LABEL_FONT_SIZES[size],</div><div class="diff-removed">-		minWidth: minSize.w,</div><div class="diff-removed">-		maxWidth: Math.max(</div><div class="diff-removed">-			// Guard because a DOM nodes can't be less 0</div><div class="diff-removed">-			0,</div><div class="diff-removed">-			// A 'w' width that we're setting as the min-width</div><div class="diff-removed">-			Math.ceil(minSize.w + sizes[size]),</div><div class="diff-removed">-			// The actual text size</div><div class="diff-removed">-			Math.ceil(w / shape.props.scale - LABEL_PADDING * 2)</div><div class="diff-removed">-		),</div><div class="diff-removed">-	})</div><div class="diff-removed">-</div><div class="diff-removed">-	return {</div><div class="diff-removed">-		w: textSize.w + LABEL_PADDING * 2,</div><div class="diff-removed">-		h: textSize.h + LABEL_PADDING * 2,</div><div class="diff-removed">-	}</div><div class="diff-added">+function getCheckBoxLines(w: number, h: number) {</div><div class="diff-added">+  const size = Math.min(w, h) * 0.82</div><div class="diff-added">+  const ox = (w - size) / 2</div><div class="diff-added">+  const oy = (h - size) / 2</div><div class="diff-added">+  return [</div><div class="diff-added">+    [new Vec2d(ox + size * 0.25, oy + size * 0.52), new Vec2d(ox + size * 0.45, oy + size * 0.82)],</div><div class="diff-added">+    [new Vec2d(ox + size * 0.45, oy + size * 0.82), new Vec2d(ox + size * 0.82, oy + size * 0.22)],</div><div class="diff-added">+  ]</div><div> }</div><div>\ No newline at end of file</div><div></div></pre>
                </div>
            </div>
        </section>
    </main>
    <footer>
        <p>LoCoDiff-bench - <a href="https://github.com/AbanteAI/LoCoDiff-bench">GitHub Repository</a></p>
    </footer>
</body>
</html>
    