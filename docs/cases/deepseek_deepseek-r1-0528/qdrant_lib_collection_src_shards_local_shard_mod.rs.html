<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case: lib/collection/src/shards/local_shard/mod.rs - DeepSeek R1 0528</title>
    <link rel="stylesheet" href="../../styles.css">
</head>
<body>
    <header>
        <h1>Case: lib/collection/src/shards/local_shard/mod.rs</h1>
        <h2>Model: DeepSeek R1 0528</h2>
        <p><a href="../../models/deepseek_deepseek-r1-0528.html">All DeepSeek R1 0528 Cases</a> | <a href="../../cases.html">All Cases</a> | <a href="../../index.html">Home</a></p>
    </header>
    <main>
        <section class="case-details">
            <div class="case-info">
                <h2>Benchmark Case Information</h2>
                <p><strong>Model:</strong> DeepSeek R1 0528</p>
                <p><strong>Status:</strong> <span class="failure">Failure</span></p>
                <p><strong>Prompt Tokens:</strong> 59828</p>
                <p><strong>Native Prompt Tokens:</strong> 63941</p>
                <p><strong>Native Completion Tokens:</strong> 16223</p>
                <p><strong>Native Tokens Reasoning:</strong> 5788</p>
                <p><strong>Native Finish Reason:</strong> stop</p>
                <p><strong>Cost:</strong> $0.321607</p>
            </div>
            
            <div class="content-links">
                <h2>View Content</h2>
                <ul>
                    <li><a href="../../content/deepseek_deepseek-r1-0528/qdrant_lib_collection_src_shards_local_shard_mod.rs/prompt.html" class="content-link">View Prompt</a></li>
                    <li><a href="../../content/deepseek_deepseek-r1-0528/qdrant_lib_collection_src_shards_local_shard_mod.rs/expected.html" class="content-link">View Expected Output</a></li>
                    <li><a href="../../content/deepseek_deepseek-r1-0528/qdrant_lib_collection_src_shards_local_shard_mod.rs/actual.html" class="content-link">View Actual Output</a></li>
                </ul>
            </div>
            
            <div class="diff-section">
                <h2>Diff (Expected vs Actual)</h2>
                <div id="diff-output">
                    <pre class="diff"><div></div><div>index c9341cb38..0c24cfe4b 100644</div><div class="diff-header">--- a/qdrant_lib_collection_src_shards_local_shard_mod.rs_expectedoutput.txt (expected):tmp/tmpnsq7pjs5_expected.txt	</div><div class="diff-header">+++ b/qdrant_lib_collection_src_shards_local_shard_mod.rs_extracted.txt (actual):tmp/tmpd7q2jkvf_actual.txt	</div><div class="diff-info">@@ -37,7 +37,7 @@ use segment::types::{</div><div> use tokio::fs::{create_dir_all, remove_dir_all, remove_file};</div><div> use tokio::runtime::Handle;</div><div> use tokio::sync::mpsc::Sender;</div><div class="diff-removed">-use tokio::sync::{Mutex, RwLock as TokioRwLock, mpsc, oneshot};</div><div class="diff-added">+use tokio::sync::{mpsc, oneshot, Mutex, RwLock as TokioRwLock};</div><div> use wal::{Wal, WalOptions};</div><div> </div><div> use self::clock_map::{ClockMap, RecoveryPoint};</div><div class="diff-info">@@ -52,13 +52,13 @@ use crate::collection_manager::optimizers::TrackerLog;</div><div> use crate::collection_manager::segments_searcher::SegmentsSearcher;</div><div> use crate::common::file_utils::{move_dir, move_file};</div><div> use crate::config::CollectionConfigInternal;</div><div class="diff-removed">-use crate::operations::OperationWithClockTag;</div><div> use crate::operations::shared_storage_config::SharedStorageConfig;</div><div> use crate::operations::types::{</div><div class="diff-removed">-    CollectionError, CollectionResult, OptimizersStatus, ShardInfoInternal, ShardStatus,</div><div class="diff-removed">-    check_sparse_compatible_with_segment_config,</div><div class="diff-added">+    check_sparse_compatible_with_segment_config, CollectionError, CollectionResult,</div><div class="diff-added">+    OptimizersStatus, ShardInfoInternal, ShardStatus,</div><div> };</div><div class="diff-removed">-use crate::optimizers_builder::{OptimizersConfig, build_optimizers, clear_temp_segments};</div><div class="diff-added">+use crate::operations::OperationWithClockTag;</div><div class="diff-added">+use crate::optimizers_builder::{build_optimizers, clear_temp_segments, OptimizersConfig};</div><div> use crate::save_on_disk::SaveOnDisk;</div><div> use crate::shards::CollectionId;</div><div> use crate::shards::shard::ShardId;</div><div class="diff-info">@@ -205,12 +205,11 @@ impl LocalShard {</div><div> </div><div>         let update_tracker = segment_holder.read().update_tracker();</div><div> </div><div class="diff-removed">-        let read_rate_limiter = config.strict_mode_config.as_ref().and_then(|strict_mode| {</div><div class="diff-removed">-            strict_mode</div><div class="diff-removed">-                .read_rate_limit</div><div class="diff-removed">-                .map(RateLimiter::new_per_minute)</div><div class="diff-removed">-                .map(ParkingMutex::new)</div><div class="diff-removed">-        });</div><div class="diff-added">+        let read_rate_limiter = config</div><div class="diff-added">+            .strict_mode_config</div><div class="diff-added">+            .as_ref()</div><div class="diff-added">+            .and_then(|strict_mode| strict_mode.read_rate_limit.map(RateLimiter::new_per_minute))</div><div class="diff-added">+            .map(ParkingMutex::new);</div><div> </div><div>         drop(config); // release `shared_config` from borrow checker</div><div> </div><div class="diff-info">@@ -224,11 +223,11 @@ impl LocalShard {</div><div>             update_sender: ArcSwap::from_pointee(update_sender),</div><div>             update_tracker,</div><div>             path: shard_path.to_owned(),</div><div class="diff-added">+            total_optimized_points,</div><div>             update_runtime,</div><div>             search_runtime,</div><div>             optimizers,</div><div>             optimizers_log,</div><div class="diff-removed">-            total_optimized_points,</div><div>             disk_usage_watcher,</div><div>             read_rate_limiter,</div><div>         }</div><div class="diff-info">@@ -388,10 +387,6 @@ impl LocalShard {</div><div>             &collection_config_read.quantization_config,</div><div>         );</div><div> </div><div class="diff-removed">-        drop(collection_config_read); // release `shared_config` from borrow checker</div><div class="diff-removed">-</div><div class="diff-removed">-        let clocks = LocalShardClocks::load(shard_path)?;</div><div class="diff-removed">-</div><div>         // Always make sure we have any appendable segments, needed for update operations</div><div>         if !segment_holder.has_appendable_segment() {</div><div>             debug_assert!(</div><div class="diff-info">@@ -411,6 +406,11 @@ impl LocalShard {</div><div>             )?;</div><div>         }</div><div> </div><div class="diff-added">+        // Drop lock to avoid deadlock inside LocalShard::new</div><div class="diff-added">+        drop(collection_config_read);</div><div class="diff-added">+</div><div class="diff-added">+        let clocks = LocalShardClocks::load(shard_path)?;</div><div class="diff-added">+</div><div>         let local_shard = LocalShard::new(</div><div>             segment_holder,</div><div>             collection_config,</div><div class="diff-info">@@ -508,13 +508,13 @@ impl LocalShard {</div><div>             ))</div><div>         })?;</div><div> </div><div class="diff-removed">-        let mut segment_holder = SegmentHolder::default();</div><div class="diff-removed">-        let mut build_handlers = vec![];</div><div class="diff-removed">-</div><div>         let vector_params = config.params.to_base_vector_data()?;</div><div>         let sparse_vector_params = config.params.to_sparse_vector_data()?;</div><div>         let segment_number = config.optimizer_config.get_number_segments();</div><div> </div><div class="diff-added">+        let mut segment_holder = SegmentHolder::default();</div><div class="diff-added">+        let mut build_handlers = vec![];</div><div class="diff-added">+</div><div>         for _sid in 0..segment_number {</div><div>             let path_clone = segments_path.clone();</div><div>             let segment_config = SegmentConfig {</div><div class="diff-info">@@ -560,7 +560,7 @@ impl LocalShard {</div><div> </div><div>         drop(config); // release `shared_config` from borrow checker</div><div> </div><div class="diff-removed">-        let collection = LocalShard::new(</div><div class="diff-added">+        let local_shard = LocalShard::new(</div><div>             segment_holder,</div><div>             collection_config,</div><div>             shared_storage_config,</div><div class="diff-info">@@ -575,7 +575,7 @@ impl LocalShard {</div><div>         )</div><div>         .await;</div><div> </div><div class="diff-removed">-        Ok(collection)</div><div class="diff-added">+        Ok(local_shard)</div><div>     }</div><div> </div><div>     pub async fn stop_flush_worker(&self) {</div><div class="diff-info">@@ -683,7 +683,7 @@ impl LocalShard {</div><div>         }</div><div> </div><div>         {</div><div class="diff-removed">-            let segments = self.segments.read();</div><div class="diff-added">+            let segments = self.segments().read();</div><div> </div><div>             // It is possible, that after recovery, if WAL flush was not enforced.</div><div>             // We could be left with some un-versioned points.</div><div class="diff-info">@@ -708,7 +708,8 @@ impl LocalShard {</div><div>         bar.finish();</div><div>         if !show_progress_bar {</div><div>             log::info!(</div><div class="diff-removed">-                "Recovered collection {collection_id}: {0}/{0} (100%)",</div><div class="diff-added">+                "Recovered shard {}: {0}/{0} (100%)",</div><div class="diff-added">+                self.path.display(),</div><div>                 wal.len(false),</div><div>             );</div><div>         }</div><div class="diff-info">@@ -720,6 +721,13 @@ impl LocalShard {</div><div>         Ok(())</div><div>     }</div><div> </div><div class="diff-added">+    pub fn segment_manifests(&self) -> CollectionResult<SegmentManifests> {</div><div class="diff-added">+        self.segments()</div><div class="diff-added">+            .read()</div><div class="diff-added">+            .segment_manifests()</div><div class="diff-added">+            .map_err(CollectionError::from)</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div>     /// Check data consistency for all segments</div><div>     ///</div><div>     /// Returns an error at the first inconsistent segment</div><div class="diff-info">@@ -868,17 +876,16 @@ impl LocalShard {</div><div>             rx.await?;</div><div>         }</div><div> </div><div class="diff-removed">-        let segments_path = Self::segments_path(&self.path);</div><div>         let collection_params = self.collection_config.read().await.params.clone();</div><div class="diff-removed">-        let temp_path = temp_path.to_owned();</div><div>         let payload_index_schema = self.payload_index_schema.clone();</div><div class="diff-added">+        let temp_path = temp_path.to_owned();</div><div> </div><div>         let tar_c = tar.clone();</div><div>         tokio::task::spawn_blocking(move || {</div><div>             // Do not change segments while snapshotting</div><div>             SegmentHolder::snapshot_all_segments(</div><div>                 segments.clone(),</div><div class="diff-removed">-                &segments_path,</div><div class="diff-added">+                &Self::segments_path(&temp_path),</div><div>                 Some(&collection_params),</div><div>                 &payload_index_schema.read().clone(),</div><div>                 &temp_path,</div><div class="diff-info">@@ -975,13 +982,6 @@ impl LocalShard {</div><div>         Ok(())</div><div>     }</div><div> </div><div class="diff-removed">-    pub fn segment_manifests(&self) -> CollectionResult<SegmentManifests> {</div><div class="diff-removed">-        self.segments()</div><div class="diff-removed">-            .read()</div><div class="diff-removed">-            .segment_manifests()</div><div class="diff-removed">-            .map_err(CollectionError::from)</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div>     pub fn estimate_cardinality<'a>(</div><div>         &'a self,</div><div>         filter: Option<&'a Filter>,</div><div class="diff-info">@@ -1109,6 +1109,34 @@ impl LocalShard {</div><div>         &self.update_tracker</div><div>     }</div><div> </div><div class="diff-added">+    pub fn restore_snapshot(snapshot_path: &Path) -> CollectionResult<()> {</div><div class="diff-added">+        log::info!("Restoring shard snapshot {}", snapshot_path.display());</div><div class="diff-added">+        // Read dir first as the directory contents would change during restore</div><div class="diff-added">+        let entries = std::fs::read_dir(LocalShard::segments_path(snapshot_path))?</div><div class="diff-added">+            .collect::<Result<Vec<_>, _>>()?;</div><div class="diff-added">+</div><div class="diff-added">+        // Filter out hidden entries</div><div class="diff-added">+        let entries = entries.into_iter().filter(|entry| {</div><div class="diff-added">+            let is_hidden = entry</div><div class="diff-added">+                .file_name()</div><div class="diff-added">+                .to_str()</div><div class="diff-added">+                .is_some_and(|s| s.starts_with('.'));</div><div class="diff-added">+            if is_hidden {</div><div class="diff-added">+                log::debug!(</div><div class="diff-added">+                    "Ignoring hidden segment in local shard during snapshot recovery: {}",</div><div class="diff-added">+                    entry.path().display(),</div><div class="diff-added">+                );</div><div class="diff-added">+            }</div><div class="diff-added">+            !is_hidden</div><div class="diff-added">+        });</div><div class="diff-added">+</div><div class="diff-added">+        for entry in entries {</div><div class="diff-added">+            Segment::restore_snapshot_in_place(&entry.path())?;</div><div class="diff-added">+        }</div><div class="diff-added">+</div><div class="diff-added">+        Ok(())</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div>     /// Get the recovery point for the current shard</div><div>     ///</div><div>     /// This is sourced from the last seen clocks from other nodes that we know about.</div><div class="diff-info">@@ -1181,13 +1209,6 @@ pub struct LocalShardClocks {</div><div> }</div><div> </div><div> impl LocalShardClocks {</div><div class="diff-removed">-    fn new(newest_clocks: ClockMap, oldest_clocks: ClockMap) -> Self {</div><div class="diff-removed">-        Self {</div><div class="diff-removed">-            newest_clocks: Arc::new(Mutex::new(newest_clocks)),</div><div class="diff-removed">-            oldest_clocks: Arc::new(Mutex::new(oldest_clocks)),</div><div class="diff-removed">-        }</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div>     // Load clock maps from disk</div><div>     pub fn load(shard_path: &Path) -> CollectionResult<Self> {</div><div>         let newest_clocks = ClockMap::load_or_default(&Self::newest_clocks_path(shard_path))?;</div><div class="diff-info">@@ -1197,6 +1218,13 @@ impl LocalShardClocks {</div><div>         Ok(Self::new(newest_clocks, oldest_clocks))</div><div>     }</div><div> </div><div class="diff-added">+    fn new(newest_clocks: ClockMap, oldest_clocks: ClockMap) -> Self {</div><div class="diff-added">+        Self {</div><div class="diff-added">+            newest_clocks: Arc::new(Mutex::new(newest_clocks)),</div><div class="diff-added">+            oldest_clocks: Arc::new(Mutex::new(oldest_clocks)),</div><div class="diff-added">+        }</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div>     /// Persist clock maps to disk</div><div>     pub async fn store_if_changed(&self, shard_path: &Path) -> CollectionResult<()> {</div><div>         self.oldest_clocks</div><div></div></pre>
                </div>
            </div>
        </section>
    </main>
    <footer>
        <p>LoCoDiff-bench - <a href="https://github.com/AbanteAI/LoCoDiff-bench">GitHub Repository</a></p>
    </footer>
</body>
</html>
    