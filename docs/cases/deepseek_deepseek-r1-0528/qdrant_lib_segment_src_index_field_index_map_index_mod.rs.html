<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case: lib/segment/src/index/field_index/map_index/mod.rs - DeepSeek R1 0528</title>
    <link rel="stylesheet" href="../../styles.css">
</head>
<body>
    <header>
        <h1>Case: lib/segment/src/index/field_index/map_index/mod.rs</h1>
        <h2>Model: DeepSeek R1 0528</h2>
        <p><a href="../../models/deepseek_deepseek-r1-0528.html">All DeepSeek R1 0528 Cases</a> | <a href="../../cases.html">All Cases</a> | <a href="../../index.html">Home</a></p>
    </header>
    <main>
        <section class="case-details">
            <div class="case-info">
                <h2>Benchmark Case Information</h2>
                <p><strong>Model:</strong> DeepSeek R1 0528</p>
                <p><strong>Status:</strong> <span class="failure">Failure</span></p>
                <p><strong>Prompt Tokens:</strong> 56553</p>
                <p><strong>Native Prompt Tokens:</strong> 60168</p>
                <p><strong>Native Completion Tokens:</strong> 15264</p>
                <p><strong>Native Tokens Reasoning:</strong> 4267</p>
                <p><strong>Native Finish Reason:</strong> stop</p>
                <p><strong>Cost:</strong> $0.06335952</p>
            </div>
            
            <div class="content-links">
                <h2>View Content</h2>
                <ul>
                    <li><a href="../../content/deepseek_deepseek-r1-0528/qdrant_lib_segment_src_index_field_index_map_index_mod.rs/prompt.html" class="content-link">View Prompt</a></li>
                    <li><a href="../../content/deepseek_deepseek-r1-0528/qdrant_lib_segment_src_index_field_index_map_index_mod.rs/expected.html" class="content-link">View Expected Output</a></li>
                    <li><a href="../../content/deepseek_deepseek-r1-0528/qdrant_lib_segment_src_index_field_index_map_index_mod.rs/actual.html" class="content-link">View Actual Output</a></li>
                </ul>
            </div>
            
            <div class="diff-section">
                <h2>Diff (Expected vs Actual)</h2>
                <div id="diff-output">
                    <pre class="diff"><div></div><div>index 0a4e2d762..f403b9684 100644</div><div class="diff-header">--- a/qdrant_lib_segment_src_index_field_index_map_index_mod.rs_expectedoutput.txt (expected):tmp/tmpyd3xr957_expected.txt	</div><div class="diff-header">+++ b/qdrant_lib_segment_src_index_field_index_map_index_mod.rs_extracted.txt (actual):tmp/tmpgcfbh5f6_actual.txt	</div><div class="diff-info">@@ -1,8 +1,14 @@</div><div class="diff-added">+pub mod immutable_map_index;</div><div class="diff-added">+pub mod mmap_map_index;</div><div class="diff-added">+pub mod mutable_map_index;</div><div class="diff-added">+</div><div> use std::borrow::Borrow;</div><div class="diff-added">+use std::cmp::max;</div><div> use std::collections::hash_map::Entry;</div><div> use std::fmt::{Debug, Display};</div><div> use std::hash::{BuildHasher, Hash};</div><div> use std::iter;</div><div class="diff-added">+use std::mem::size_of_val;</div><div> use std::path::{Path, PathBuf};</div><div> use std::str::FromStr;</div><div> use std::sync::Arc;</div><div class="diff-info">@@ -22,11 +28,11 @@ use uuid::Uuid;</div><div> </div><div> use self::immutable_map_index::ImmutableMapIndex;</div><div> use self::mutable_map_index::MutableMapIndex;</div><div class="diff-removed">-use super::FieldIndexBuilderTrait;</div><div> use super::facet_index::FacetIndex;</div><div> use super::mmap_point_to_values::MmapValue;</div><div class="diff-removed">-use crate::common::Flusher;</div><div class="diff-added">+use super::FieldIndexBuilderTrait;</div><div> use crate::common::operation_error::{OperationError, OperationResult};</div><div class="diff-added">+use crate::common::Flusher;</div><div> use crate::data_types::facets::{FacetHit, FacetValueRef};</div><div> use crate::index::field_index::stat_tools::number_of_selected_points;</div><div> use crate::index::field_index::{</div><div class="diff-info">@@ -36,13 +42,9 @@ use crate::index::query_estimator::combine_should_estimations;</div><div> use crate::telemetry::PayloadIndexTelemetry;</div><div> use crate::types::{</div><div>     AnyVariants, FieldCondition, IntPayloadType, Match, MatchAny, MatchExcept, MatchValue,</div><div class="diff-removed">-    PayloadKeyType, UuidIntType, ValueVariants,</div><div class="diff-added">+    PayloadKeyType, ValueVariants,</div><div> };</div><div> </div><div class="diff-removed">-pub mod immutable_map_index;</div><div class="diff-removed">-pub mod mmap_map_index;</div><div class="diff-removed">-pub mod mutable_map_index;</div><div class="diff-removed">-</div><div> pub type IdRefIter<'a> = Box<dyn Iterator<Item = &'a PointOffsetType> + 'a>;</div><div> pub type IdIter<'a> = Box<dyn Iterator<Item = PointOffsetType> + 'a>;</div><div> </div><div class="diff-info">@@ -110,15 +112,6 @@ impl<N: MapIndexKey + ?Sized> MapIndex<N> {</div><div>         }</div><div>     }</div><div> </div><div class="diff-removed">-    fn load_from_db(&mut self) -> OperationResult<bool> {</div><div class="diff-removed">-        match self {</div><div class="diff-removed">-            MapIndex::Mutable(index) => index.load_from_db(),</div><div class="diff-removed">-            MapIndex::Immutable(index) => index.load_from_db(),</div><div class="diff-removed">-            // mmap index is always loaded</div><div class="diff-removed">-            MapIndex::Mmap(_) => Ok(true),</div><div class="diff-removed">-        }</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div>     pub fn check_values_any(</div><div>         &self,</div><div>         idx: PointOffsetType,</div><div class="diff-info">@@ -213,12 +206,12 @@ impl<N: MapIndexKey + ?Sized> MapIndex<N> {</div><div> </div><div>     pub fn iter_values_map<'a>(</div><div>         &'a self,</div><div class="diff-removed">-        hw_cell: &'a HardwareCounterCell,</div><div class="diff-added">+        hw_counter: &'a HardwareCounterCell,</div><div>     ) -> Box<dyn Iterator<Item = (&'a N, IdIter<'a>)> + 'a> {</div><div>         match self {</div><div>             MapIndex::Mutable(index) => Box::new(index.iter_values_map()),</div><div>             MapIndex::Immutable(index) => Box::new(index.iter_values_map()),</div><div class="diff-removed">-            MapIndex::Mmap(index) => Box::new(index.iter_values_map(hw_cell)),</div><div class="diff-added">+            MapIndex::Mmap(index) => Box::new(index.iter_values_map(hw_counter)),</div><div>         }</div><div>     }</div><div> </div><div class="diff-info">@@ -302,69 +295,11 @@ impl<N: MapIndexKey + ?Sized> MapIndex<N> {</div><div>         }</div><div>     }</div><div> </div><div class="diff-removed">-    fn files(&self) -> Vec<PathBuf> {</div><div class="diff-removed">-        match self {</div><div class="diff-removed">-            MapIndex::Mutable(_) => Vec::new(),</div><div class="diff-removed">-            MapIndex::Immutable(_) => Vec::new(),</div><div class="diff-removed">-            MapIndex::Mmap(index) => index.files(),</div><div class="diff-removed">-        }</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    /// Estimates cardinality for `except` clause</div><div class="diff-removed">-    ///</div><div class="diff-removed">-    /// # Arguments</div><div class="diff-removed">-    ///</div><div class="diff-removed">-    /// * 'excluded' - values, which are not considered as matching</div><div class="diff-removed">-    ///</div><div class="diff-removed">-    /// # Returns</div><div class="diff-removed">-    ///</div><div class="diff-removed">-    /// * `CardinalityEstimation` - estimation of cardinality</div><div>     fn except_cardinality<'a>(</div><div>         &'a self,</div><div>         excluded: impl Iterator<Item = &'a N>,</div><div>         hw_counter: &HardwareCounterCell,</div><div>     ) -> CardinalityEstimation {</div><div class="diff-removed">-        // Minimal case: we exclude as many points as possible.</div><div class="diff-removed">-        // In this case, excluded points do not have any other values except excluded ones.</div><div class="diff-removed">-        // So the first step - we estimate how many other points is needed to fit unused values.</div><div class="diff-removed">-</div><div class="diff-removed">-        // Example:</div><div class="diff-removed">-        // Values: 20, 20</div><div class="diff-removed">-        // Unique values: 5</div><div class="diff-removed">-        // Total points: 100</div><div class="diff-removed">-        // Total values: 110</div><div class="diff-removed">-        // total_excluded_value_count = 40</div><div class="diff-removed">-        // non_excluded_values_count = 110 - 40 = 70</div><div class="diff-removed">-        // max_values_per_point = 5 - 2 = 3</div><div class="diff-removed">-        // min_not_excluded_by_values = 70 / 3 = 24</div><div class="diff-removed">-        // min = max(24, 100 - 40) = 60</div><div class="diff-removed">-        // exp = ...</div><div class="diff-removed">-        // max = min(20, 70) = 20</div><div class="diff-removed">-</div><div class="diff-removed">-        // Values: 60, 60</div><div class="diff-removed">-        // Unique values: 5</div><div class="diff-removed">-        // Total points: 100</div><div class="diff-removed">-        // Total values: 200</div><div class="diff-removed">-        // total_excluded_value_count = 120</div><div class="diff-removed">-        // non_excluded_values_count = 200 - 120 = 80</div><div class="diff-removed">-        // max_values_per_point = 5 - 2 = 3</div><div class="diff-removed">-        // min_not_excluded_by_values = 80 / 3 = 27</div><div class="diff-removed">-        // min = max(27, 100 - 120) = 27</div><div class="diff-removed">-        // exp = ...</div><div class="diff-removed">-        // max = min(60, 80) = 60</div><div class="diff-removed">-</div><div class="diff-removed">-        // Values: 60, 60, 60</div><div class="diff-removed">-        // Unique values: 5</div><div class="diff-removed">-        // Total points: 100</div><div class="diff-removed">-        // Total values: 200</div><div class="diff-removed">-        // total_excluded_value_count = 180</div><div class="diff-removed">-        // non_excluded_values_count = 200 - 180 = 20</div><div class="diff-removed">-        // max_values_per_point = 5 - 3 = 2</div><div class="diff-removed">-        // min_not_excluded_by_values = 20 / 2 = 10</div><div class="diff-removed">-        // min = max(10, 100 - 180) = 10</div><div class="diff-removed">-        // exp = ...</div><div class="diff-removed">-        // max = min(60, 20) = 20</div><div class="diff-removed">-</div><div>         let excluded_value_counts: Vec<_> = excluded</div><div>             .map(|val| {</div><div>                 self.get_count_for_value(val.borrow(), hw_counter)</div><div class="diff-info">@@ -383,13 +318,10 @@ impl<N: MapIndexKey + ?Sized> MapIndex<N> {</div><div>             .saturating_sub(excluded_value_counts.len());</div><div> </div><div>         if max_values_per_point == 0 {</div><div class="diff-removed">-            // All points are excluded, so we can't select any point</div><div>             debug_assert_eq!(non_excluded_values_count, 0);</div><div>             return CardinalityEstimation::exact(0);</div><div>         }</div><div> </div><div class="diff-removed">-        // Minimal amount of points, required to fit all unused values.</div><div class="diff-removed">-        // Cardinality can't be less than this value.</div><div>         let min_not_excluded_by_values = non_excluded_values_count.div_ceil(max_values_per_point);</div><div> </div><div>         let min = min_not_excluded_by_values.max(</div><div class="diff-info">@@ -397,11 +329,6 @@ impl<N: MapIndexKey + ?Sized> MapIndex<N> {</div><div>                 .saturating_sub(total_excluded_value_count),</div><div>         );</div><div> </div><div class="diff-removed">-        // Maximum scenario: selected points overlap as much as possible.</div><div class="diff-removed">-        // From one side, all excluded values should be assigned to the same point</div><div class="diff-removed">-        // => we can take the value with the maximum amount of points.</div><div class="diff-removed">-        // From another side, all other values should be enough to fill all other points.</div><div class="diff-removed">-</div><div>         let max_excluded_value_count = excluded_value_counts.iter().max().copied().unwrap_or(0);</div><div> </div><div>         let max = self</div><div class="diff-info">@@ -409,8 +336,6 @@ impl<N: MapIndexKey + ?Sized> MapIndex<N> {</div><div>             .saturating_sub(max_excluded_value_count)</div><div>             .min(non_excluded_values_count);</div><div> </div><div class="diff-removed">-        // Expected case: we assume that all points are filled equally.</div><div class="diff-removed">-        // So we can estimate the probability of the point to have non-excluded value.</div><div>         let exp = number_of_selected_points(self.get_indexed_points(), non_excluded_values_count)</div><div>             .max(min)</div><div>             .min(max);</div><div class="diff-info">@@ -448,25 +373,20 @@ impl<N: MapIndexKey + ?Sized> MapIndex<N> {</div><div>         }</div><div>     }</div><div> </div><div class="diff-removed">-    /// Populate all pages in the mmap.</div><div class="diff-removed">-    /// Block until all pages are populated.</div><div>     pub fn populate(&self) -> OperationResult<()> {</div><div>         match self {</div><div class="diff-removed">-            MapIndex::Mutable(_) => {}   // Not a mmap</div><div class="diff-removed">-            MapIndex::Immutable(_) => {} // Not a mmap</div><div class="diff-removed">-            MapIndex::Mmap(index) => index.populate()?,</div><div class="diff-added">+            MapIndex::Mutable(_) => Ok(()),</div><div class="diff-added">+            MapIndex::Immutable(_) => Ok(()),</div><div class="diff-added">+            MapIndex::Mmap(index) => index.populate(),</div><div>         }</div><div class="diff-removed">-        Ok(())</div><div>     }</div><div> </div><div class="diff-removed">-    /// Drop disk cache.</div><div>     pub fn clear_cache(&self) -> OperationResult<()> {</div><div>         match self {</div><div class="diff-removed">-            MapIndex::Mutable(_) => {}   // Not a mmap</div><div class="diff-removed">-            MapIndex::Immutable(_) => {} // Not a mmap</div><div class="diff-removed">-            MapIndex::Mmap(index) => index.clear_cache()?,</div><div class="diff-added">+            MapIndex::Mutable(_) => Ok(()),</div><div class="diff-added">+            MapIndex::Immutable(_) => Ok(()),</div><div class="diff-added">+            MapIndex::Mmap(index) => index.clear_cache(),</div><div>         }</div><div class="diff-removed">-        Ok(())</div><div>     }</div><div> }</div><div> </div><div class="diff-info">@@ -537,22 +457,24 @@ where</div><div> </div><div>         self.point_to_values[id as usize].extend(flatten_values.clone());</div><div> </div><div class="diff-removed">-        let mut hw_cell_wb = hw_counter</div><div class="diff-removed">-            .payload_index_io_write_counter()</div><div class="diff-removed">-            .write_back_counter();</div><div class="diff-added">+        let mut hw_counter_val = 0;</div><div> </div><div>         for value in flatten_values {</div><div>             let entry = self.values_to_points.entry(value);</div><div> </div><div>             if let Entry::Vacant(e) = &entry {</div><div>                 let size = N::mmapped_size(N::as_referenced(e.key().borrow()));</div><div class="diff-removed">-                hw_cell_wb.incr_delta(size);</div><div class="diff-added">+                hw_counter_val += size;</div><div>             }</div><div> </div><div class="diff-removed">-            hw_cell_wb.incr_delta(size_of_val(&id));</div><div class="diff-added">+            hw_counter_val += size_of_val(&id);</div><div>             entry.or_default().push(id);</div><div>         }</div><div> </div><div class="diff-added">+        hw_counter</div><div class="diff-added">+            .payload_index_io_write_counter()</div><div class="diff-added">+            .incr_delta(hw_counter_val);</div><div class="diff-added">+</div><div>         Ok(())</div><div>     }</div><div> </div><div class="diff-info">@@ -667,23 +589,27 @@ impl PayloadFieldIndex for MapIndex<str> {</div><div>                 }</div><div>                 AnyVariants::Integers(integers) => {</div><div>                     if integers.is_empty() {</div><div class="diff-removed">-                        Some(CardinalityEstimation::exact(0).with_primary_clause(</div><div class="diff-removed">-                            PrimaryCondition::Condition(Box::new(condition.clone())),</div><div class="diff-removed">-                        ))</div><div class="diff-added">+                        Some(</div><div class="diff-added">+                            CardinalityEstimation::exact(0).with_primary_clause(</div><div class="diff-added">+                                PrimaryCondition::Condition(Box::new(condition.clone())),</div><div class="diff-added">+                            ),</div><div class="diff-added">+                        )</div><div>                     } else {</div><div>                         None</div><div>                     }</div><div>                 }</div><div>             },</div><div>             Some(Match::Except(MatchExcept { except })) => match except {</div><div class="diff-removed">-                AnyVariants::Strings(keywords) => {</div><div class="diff-removed">-                    Some(self.except_cardinality(keywords.iter().map(|k| k.as_str()), hw_counter))</div><div class="diff-removed">-                }</div><div class="diff-added">+                AnyVariants::Strings(keywords) => Some(</div><div class="diff-added">+                    self.except_cardinality(keywords.iter().map(|k| k.as_str()), hw_counter),</div><div class="diff-added">+                ),</div><div>                 AnyVariants::Integers(others) => {</div><div>                     if others.is_empty() {</div><div class="diff-removed">-                        Some(CardinalityEstimation::exact(0).with_primary_clause(</div><div class="diff-removed">-                            PrimaryCondition::Condition(Box::new(condition.clone())),</div><div class="diff-removed">-                        ))</div><div class="diff-added">+                        Some(</div><div class="diff-added">+                            CardinalityEstimation::exact(0).with_primary_clause(</div><div class="diff-added">+                                PrimaryCondition::Condition(Box::new(condition.clone())),</div><div class="diff-added">+                            ),</div><div class="diff-added">+                        )</div><div>                     } else {</div><div>                         None</div><div>                     }</div><div class="diff-info">@@ -703,7 +629,7 @@ impl PayloadFieldIndex for MapIndex<str> {</div><div>                 .map(|value| {</div><div>                     (</div><div>                         value,</div><div class="diff-removed">-                        self.get_count_for_value(value, &HardwareCounterCell::disposable()) // Payload_blocks only used in HNSW building, which is unmeasured.</div><div class="diff-added">+                        self.get_count_for_value(value, &HardwareCounterCell::disposable())</div><div>                             .unwrap_or(0),</div><div>                     )</div><div>                 })</div><div class="diff-info">@@ -741,7 +667,7 @@ impl PayloadFieldIndex for MapIndex<UuidIntType> {</div><div>         &'a self,</div><div>         condition: &'a FieldCondition,</div><div>         hw_counter: &'a HardwareCounterCell,</div><div class="diff-removed">-    ) -> Option<Box<dyn Iterator<Item = PointOffsetType> + 'a>> {</div><div class="diff-added">+    ) -> Some<Box<dyn Iterator<Item = PointOffsetType> + 'a>> {</div><div>         match &condition.r#match {</div><div>             Some(Match::Value(MatchValue { value })) => match value {</div><div>                 ValueVariants::String(uuid_string) => {</div><div class="diff-info">@@ -848,9 +774,11 @@ impl PayloadFieldIndex for MapIndex<UuidIntType> {</div><div>                 }</div><div>                 AnyVariants::Integers(integers) => {</div><div>                     if integers.is_empty() {</div><div class="diff-removed">-                        Some(CardinalityEstimation::exact(0).with_primary_clause(</div><div class="diff-removed">-                            PrimaryCondition::Condition(Box::new(condition.clone())),</div><div class="diff-removed">-                        ))</div><div class="diff-added">+                        Some(</div><div class="diff-added">+                            CardinalityEstimation::exact(0).with_primary_clause(</div><div class="diff-added">+                                PrimaryCondition::Condition(Box::new(condition.clone())),</div><div class="diff-added">+                            ),</div><div class="diff-added">+                        )</div><div>                     } else {</div><div>                         None</div><div>                     }</div><div class="diff-info">@@ -869,9 +797,11 @@ impl PayloadFieldIndex for MapIndex<UuidIntType> {</div><div>                 }</div><div>                 AnyVariants::Integers(other) => {</div><div>                     if other.is_empty() {</div><div class="diff-removed">-                        Some(CardinalityEstimation::exact(0).with_primary_clause(</div><div class="diff-removed">-                            PrimaryCondition::Condition(Box::new(condition.clone())),</div><div class="diff-removed">-                        ))</div><div class="diff-added">+                        Some(</div><div class="diff-added">+                            CardinalityEstimation::exact(0).with_primary_clause(</div><div class="diff-added">+                                PrimaryCondition::Condition(Box::new(condition.clone())),</div><div class="diff-added">+                            ),</div><div class="diff-added">+                        )</div><div>                     } else {</div><div>                         None</div><div>                     }</div><div class="diff-info">@@ -891,7 +821,7 @@ impl PayloadFieldIndex for MapIndex<UuidIntType> {</div><div>                 .map(move |value| {</div><div>                     (</div><div>                         value,</div><div class="diff-removed">-                        self.get_count_for_value(value, &HardwareCounterCell::disposable()) // payload_blocks only used in HNSW building, which is unmeasured.</div><div class="diff-added">+                        self.get_count_for_value(value, &HardwareCounterCell::disposable())</div><div>                             .unwrap_or(0),</div><div>                     )</div><div>                 })</div><div class="diff-info">@@ -932,7 +862,7 @@ impl PayloadFieldIndex for MapIndex<IntPayloadType> {</div><div>         &'a self,</div><div>         condition: &'a FieldCondition,</div><div>         hw_counter: &'a HardwareCounterCell,</div><div class="diff-removed">-    ) -> Option<Box<dyn Iterator<Item = PointOffsetType> + 'a>> {</div><div class="diff-added">+    ) -> Some<Box<dyn Iterator<Item = PointOffsetType> + 'a>> {</div><div>         match &condition.r#match {</div><div>             Some(Match::Value(MatchValue { value })) => match value {</div><div>                 ValueVariants::String(_) => None,</div><div class="diff-info">@@ -987,12 +917,14 @@ impl PayloadFieldIndex for MapIndex<IntPayloadType> {</div><div>                 }</div><div>                 ValueVariants::Bool(_) => None,</div><div>             },</div><div class="diff-removed">-            Some(Match::Any(MatchAny { any: any_variants })) => match any_variants {</div><div class="diff-added">+            Some(M极::Any(MatchAny { any: any_variants })) => match any_variants {</div><div>                 AnyVariants::Strings(keywords) => {</div><div>                     if keywords.is_empty() {</div><div class="diff-removed">-                        Some(CardinalityEstimation::exact(0).with_primary_clause(</div><div class="diff-removed">-                            PrimaryCondition::Condition(Box::new(condition.clone())),</div><div class="diff-removed">-                        ))</div><div class="diff-added">+                        Some(</div><div class="diff-added">+                            CardinalityEstimation::exact(0).with_primary_clause(</div><div class="diff-added">+                                PrimaryCondition::Condition(Box::new(condition.clone())),</div><div class="diff-added">+                            ),</div><div class="diff-added">+                        )</div><div>                     } else {</div><div>                         None</div><div>                     }</div><div class="diff-info">@@ -1017,9 +949,11 @@ impl PayloadFieldIndex for MapIndex<IntPayloadType> {</div><div>             Some(Match::Except(MatchExcept { except })) => match except {</div><div>                 AnyVariants::Strings(others) => {</div><div>                     if others.is_empty() {</div><div class="diff-removed">-                        Some(CardinalityEstimation::exact(0).with_primary_clause(</div><div class="diff-removed">-                            PrimaryCondition::Condition(Box::new(condition.clone())),</div><div class="diff-removed">-                        ))</div><div class="diff-added">+                        Some(</div><div class="diff-added">+                            CardinalityEstimation::exact(0).with_primary_clause(</div><div class="diff-added">+                                PrimaryCondition::Condition(Box::new(condition.clone())),</div><div class="diff-added">+                            ),</div><div class="diff-added">+                        )</div><div>                     } else {</div><div>                         None</div><div>                     }</div><div class="diff-info">@@ -1042,7 +976,7 @@ impl PayloadFieldIndex for MapIndex<IntPayloadType> {</div><div>                 .map(move |value| {</div><div>                     (</div><div>                         value,</div><div class="diff-removed">-                        self.get_count_for_value(value, &HardwareCounterCell::disposable()) // Only used in HNSW building so no measurement needed here.</div><div class="diff-added">+                        self.get_count_for_value(value, &HardwareCounterCell::disposable())</div><div>                             .unwrap_or(0),</div><div>                     )</div><div>                 })</div><div class="diff-info">@@ -1130,7 +1064,7 @@ impl ValueIndexer for MapIndex<IntPayloadType> {</div><div>         &mut self,</div><div>         id: PointOffsetType,</div><div>         values: Vec<IntPayloadType>,</div><div class="diff-removed">-        hw_counter: &HardwareCounterCell,</div><div class="diff-added">+       极 hw_counter: &HardwareCounterCell,</div><div>     ) -> OperationResult<()> {</div><div>         match self {</div><div>             MapIndex::Mutable(index) => index.add_many_to_map(id, values, hw_counter),</div><div class="diff-info">@@ -1191,9 +1125,11 @@ mod tests {</div><div> </div><div>     use rstest::rstest;</div><div>     use tempfile::Builder;</div><div class="diff-added">+    use uuid::Uuid;</div><div> </div><div>     use super::*;</div><div>     use crate::common::rocksdb_wrapper::open_db_with_existing_cf;</div><div class="diff-added">+    use crate::types::UuidIntType;</div><div> </div><div>     const FIELD_NAME: &str = "test";</div><div> </div><div class="diff-info">@@ -1234,7 +1170,7 @@ mod tests {</div><div>                 let mut builder = MapIndex::<N>::mmap_builder(path, false);</div><div>                 builder.init().unwrap();</div><div>                 for (idx, values) in data.iter().enumerate() {</div><div class="diff-removed">-                    let values: Vec<Value> = values.iter().map(&into_value).collect();</div><div class="diff-added">+                    let values: Vec<极Value> = values.iter().map(&into_value).collect();</div><div>                     let values: Vec<_> = values.iter().collect();</div><div>                     builder</div><div>                         .add_point(idx as PointOffsetType, &values, &hw_counter)</div><div class="diff-info">@@ -1395,4 +1331,38 @@ mod tests {</div><div>                 .equals_min_exp_max(&CardinalityEstimation::exact(0)),</div><div>         );</div><div>     }</div><div class="diff-added">+</div><div class="diff-added">+    #[test]</div><div class="diff-added">+    fn test_uuid_index() {</div><div class="diff-added">+        let uuids = vec![</div><div class="diff-added">+            Uuid::new_v4(),</div><div class="diff-added">+            Uuid::new_v4(),</div><div class="diff-added">+            Uuid::new_v4(),</div><div class="diff-added">+            Uuid::new_v4(),</div><div class="diff-added">+            Uuid::new_v4(),</div><div class="diff-added">+        ];</div><div class="diff-added">+        let uuid_values: Vec<UuidIntType> = uuids.iter().map(|u| u.as_u128()).collect();</div><div class="diff-added">+        let data = vec![</div><div class="diff-added">+            vec![uuid_values[0], uuid_values[1]],</div><div class="diff-added">+            vec![uuid_values[0], uuid_values[2]],</div><div class="diff-added">+            vec![uuid_values[0], uuid_values[3]],</div><div class="diff-added">+            vec![uuid_values[0], uuid_values[4]],</div><div class="diff-added">+            vec![uuid_values[1]],</div><div class="diff-added">+        ];</div><div class="diff-added">+</div><div class="diff-added">+        let temp_dir = Builder::new().prefix("store_dir").tempdir().unwrap();</div><div class="diff-added">+        save_map_index::<UuidIntType>(&data, temp_dir.path(), IndexType::Mmap, |v| {</div><div class="diff-added">+            Value::String(Uuid::from_u128(*v).to_string())</div><div class="diff-added">+        });</div><div class="diff-added">+        let index = load_map_index::<UuidIntType>(&data, temp_dir.path(), IndexType::Mmap);</div><div class="diff-added">+</div><div class="diff-added">+        // Check that we can retrieve the UUID values</div><div class="diff-added">+        for (id, expected) in data.iter().enumerate() {</div><div class="diff-added">+            let values: Vec<_> = index.get_values(id as PointOffsetType).unwrap().collect();</div><div class="diff-added">+            assert_eq!(</div><div class="diff-added">+                values,</div><div class="diff-added">+                expected.iter().map(|i| i as &UuidIntType).collect::<Vec<_>>()</div><div class="diff-added">+            );</div><div class="diff-added">+        }</div><div class="diff-added">+    }</div><div> }</div><div>\ No newline at end of file</div><div></div></pre>
                </div>
            </div>
        </section>
    </main>
    <footer>
        <p>LoCoDiff-bench - <a href="https://github.com/AbanteAI/LoCoDiff-bench">GitHub Repository</a></p>
    </footer>
</body>
</html>
    