<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case: lib/segment/src/payload_storage/query_checker.rs - Sonnet 3.5</title>
    <link rel="stylesheet" href="../../styles.css">
</head>
<body>
    <header>
        <h1>Case: lib/segment/src/payload_storage/query_checker.rs</h1>
        <h2>Model: Sonnet 3.5</h2>
        <p><a href="../../models/anthropic_claude-3.5-sonnet-20240620.html">All Sonnet 3.5 Cases</a> | <a href="../../cases.html">All Cases</a> | <a href="../../index.html">Home</a></p>
    </header>
    <main>
        <section class="case-details">
            <div class="case-info">
                <h2>Benchmark Case Information</h2>
                <p><strong>Model:</strong> Sonnet 3.5</p>
                <p><strong>Status:</strong> <span class="failure">Failure</span></p>
                <p><strong>Prompt Tokens:</strong> 59599</p>
                <p><strong>Native Prompt Tokens:</strong> 79711</p>
                <p><strong>Native Completion Tokens:</strong> 273</p>
                <p><strong>Native Tokens Reasoning:</strong> 0</p>
                <p><strong>Native Finish Reason:</strong> stop</p>
                <p><strong>Cost:</strong> $0.243228</p>
            </div>
            
            <div class="content-links">
                <h2>View Content</h2>
                <ul>
                    <li><a href="../../content/anthropic_claude-3.5-sonnet-20240620/qdrant_lib_segment_src_payload_storage_query_checker.rs/prompt.html" class="content-link">View Prompt</a></li>
                    <li><a href="../../content/anthropic_claude-3.5-sonnet-20240620/qdrant_lib_segment_src_payload_storage_query_checker.rs/expected.html" class="content-link">View Expected Output</a></li>
                    <li><a href="../../content/anthropic_claude-3.5-sonnet-20240620/qdrant_lib_segment_src_payload_storage_query_checker.rs/actual.html" class="content-link">View Actual Output</a></li>
                </ul>
            </div>
            
            <div class="diff-section">
                <h2>Diff (Expected vs Actual)</h2>
                <div id="diff-output">
                    <pre class="diff"><div></div><div>index 4e5c39ca7..30df4ced9 100644</div><div class="diff-header">--- a/qdrant_lib_segment_src_payload_storage_query_checker.rs_expectedoutput.txt (expected):tmp/tmppdijpanj_expected.txt	</div><div class="diff-header">+++ b/qdrant_lib_segment_src_payload_storage_query_checker.rs_extracted.txt (actual):tmp/tmpqdt2jyv6_actual.txt	</div><div class="diff-info">@@ -1,666 +1,31 @@</div><div class="diff-removed">-#![cfg_attr(not(feature = "testing"), allow(unused_imports))]</div><div class="diff-added">+Here's a summary of the key changes made to the `query_checker.rs` file in the Qdrant segment library over time:</div><div> </div><div class="diff-removed">-use std::cell::RefCell;</div><div class="diff-removed">-use std::collections::HashMap;</div><div class="diff-removed">-use std::ops::Deref;</div><div class="diff-removed">-use std::sync::Arc;</div><div class="diff-added">+1. Initial implementation of payload query checking logic.</div><div> </div><div class="diff-removed">-use atomic_refcell::AtomicRefCell;</div><div class="diff-removed">-use common::counter::hardware_counter::HardwareCounterCell;</div><div class="diff-removed">-use common::types::PointOffsetType;</div><div class="diff-added">+2. Added support for geo-based filtering conditions.</div><div> </div><div class="diff-removed">-use crate::common::utils::{IndexesMap, check_is_empty, check_is_null};</div><div class="diff-removed">-use crate::id_tracker::IdTrackerSS;</div><div class="diff-removed">-use crate::index::field_index::FieldIndex;</div><div class="diff-removed">-use crate::payload_storage::condition_checker::ValueChecker;</div><div class="diff-removed">-use crate::payload_storage::payload_storage_enum::PayloadStorageEnum;</div><div class="diff-removed">-use crate::payload_storage::{ConditionChecker, PayloadStorage};</div><div class="diff-removed">-use crate::types::{</div><div class="diff-removed">-    Condition, FieldCondition, Filter, IsEmptyCondition, IsNullCondition, MinShould,</div><div class="diff-removed">-    OwnedPayloadRef, Payload, PayloadContainer, PayloadKeyType, VectorNameBuf,</div><div class="diff-removed">-};</div><div class="diff-removed">-use crate::vector_storage::{VectorStorage, VectorStorageEnum};</div><div class="diff-added">+3. Refactored to use a generic payload storage interface.</div><div> </div><div class="diff-removed">-fn check_condition<F>(checker: &F, condition: &Condition) -> bool</div><div class="diff-removed">-where</div><div class="diff-removed">-    F: Fn(&Condition) -> bool,</div><div class="diff-removed">-{</div><div class="diff-removed">-    match condition {</div><div class="diff-removed">-        Condition::Filter(filter) => check_filter(checker, filter),</div><div class="diff-removed">-        _ => checker(condition),</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-added">+4. Added support for nested object filtering.</div><div> </div><div class="diff-removed">-pub fn check_filter<F>(checker: &F, filter: &Filter) -> bool</div><div class="diff-removed">-where</div><div class="diff-removed">-    F: Fn(&Condition) -> bool,</div><div class="diff-removed">-{</div><div class="diff-removed">-    check_should(checker, &filter.should)</div><div class="diff-removed">-        && check_min_should(checker, &filter.min_should)</div><div class="diff-removed">-        && check_must(checker, &filter.must)</div><div class="diff-removed">-        && check_must_not(checker, &filter.must_not)</div><div class="diff-removed">-}</div><div class="diff-added">+5. Implemented "min should" clause filtering.</div><div> </div><div class="diff-removed">-fn check_should<F>(checker: &F, should: &Option<Vec<Condition>>) -> bool</div><div class="diff-removed">-where</div><div class="diff-removed">-    F: Fn(&Condition) -> bool,</div><div class="diff-removed">-{</div><div class="diff-removed">-    let check = |x| check_condition(checker, x);</div><div class="diff-removed">-    match should {</div><div class="diff-removed">-        None => true,</div><div class="diff-removed">-        Some(conditions) => conditions.iter().any(check),</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-added">+6. Added datetime payload indexing and filtering.</div><div> </div><div class="diff-removed">-fn check_min_should<F>(checker: &F, min_should: &Option<MinShould>) -> bool</div><div class="diff-removed">-where</div><div class="diff-removed">-    F: Fn(&Condition) -> bool,</div><div class="diff-removed">-{</div><div class="diff-removed">-    let check = |x| check_condition(checker, x);</div><div class="diff-removed">-    match min_should {</div><div class="diff-removed">-        None => true,</div><div class="diff-removed">-        Some(MinShould {</div><div class="diff-removed">-            conditions,</div><div class="diff-removed">-            min_count,</div><div class="diff-removed">-        }) => {</div><div class="diff-removed">-            conditions</div><div class="diff-removed">-                .iter()</div><div class="diff-removed">-                .filter(|cond| check(cond))</div><div class="diff-removed">-                .take(*min_count)</div><div class="diff-removed">-                .count()</div><div class="diff-removed">-                == *min_count</div><div class="diff-removed">-        }</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-added">+7. Introduced "has vector" filtering condition.</div><div> </div><div class="diff-removed">-fn check_must<F>(checker: &F, must: &Option<Vec<Condition>>) -> bool</div><div class="diff-removed">-where</div><div class="diff-removed">-    F: Fn(&Condition) -> bool,</div><div class="diff-removed">-{</div><div class="diff-removed">-    let check = |x| check_condition(checker, x);</div><div class="diff-removed">-    match must {</div><div class="diff-removed">-        None => true,</div><div class="diff-removed">-        Some(conditions) => conditions.iter().all(check),</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-added">+8. Refactored to use a `JsonPath` type for payload keys.</div><div> </div><div class="diff-removed">-fn check_must_not<F>(checker: &F, must: &Option<Vec<Condition>>) -> bool</div><div class="diff-removed">-where</div><div class="diff-removed">-    F: Fn(&Condition) -> bool,</div><div class="diff-removed">-{</div><div class="diff-removed">-    let check = |x| !check_condition(checker, x);</div><div class="diff-removed">-    match must {</div><div class="diff-removed">-        None => true,</div><div class="diff-removed">-        Some(conditions) => conditions.iter().all(check),</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-added">+9. Added IO measurement capabilities.</div><div> </div><div class="diff-removed">-pub fn select_nested_indexes<'a, R>(</div><div class="diff-removed">-    nested_path: &PayloadKeyType,</div><div class="diff-removed">-    field_indexes: &'a HashMap<PayloadKeyType, R>,</div><div class="diff-removed">-) -> HashMap<PayloadKeyType, &'a Vec<FieldIndex>></div><div class="diff-removed">-where</div><div class="diff-removed">-    R: AsRef<Vec<FieldIndex>>,</div><div class="diff-removed">-{</div><div class="diff-removed">-    let nested_indexes: HashMap<_, _> = field_indexes</div><div class="diff-removed">-        .iter()</div><div class="diff-removed">-        .filter_map(|(key, indexes)| {</div><div class="diff-removed">-            key.strip_prefix(nested_path)</div><div class="diff-removed">-                .map(|key| (key, indexes.as_ref()))</div><div class="diff-removed">-        })</div><div class="diff-removed">-        .collect();</div><div class="diff-removed">-    nested_indexes</div><div class="diff-removed">-}</div><div class="diff-added">+10. Introduced `VectorName` type alias.</div><div> </div><div class="diff-removed">-pub fn check_payload<'a, R>(</div><div class="diff-removed">-    get_payload: Box<dyn Fn() -> OwnedPayloadRef<'a> + 'a>,</div><div class="diff-removed">-    id_tracker: Option<&IdTrackerSS>,</div><div class="diff-removed">-    vector_storages: &HashMap<VectorNameBuf, Arc<AtomicRefCell<VectorStorageEnum>>>,</div><div class="diff-removed">-    query: &Filter,</div><div class="diff-removed">-    point_id: PointOffsetType,</div><div class="diff-removed">-    field_indexes: &HashMap<PayloadKeyType, R>,</div><div class="diff-removed">-    hw_counter: &HardwareCounterCell,</div><div class="diff-removed">-) -> bool</div><div class="diff-removed">-where</div><div class="diff-removed">-    R: AsRef<Vec<FieldIndex>>,</div><div class="diff-removed">-{</div><div class="diff-removed">-    let checker = |condition: &Condition| match condition {</div><div class="diff-removed">-        Condition::Field(field_condition) => check_field_condition(</div><div class="diff-removed">-            field_condition,</div><div class="diff-removed">-            get_payload().deref(),</div><div class="diff-removed">-            field_indexes,</div><div class="diff-removed">-            hw_counter,</div><div class="diff-removed">-        ),</div><div class="diff-removed">-        Condition::IsEmpty(is_empty) => check_is_empty_condition(is_empty, get_payload().deref()),</div><div class="diff-removed">-        Condition::IsNull(is_null) => check_is_null_condition(is_null, get_payload().deref()),</div><div class="diff-removed">-        Condition::HasId(has_id) => id_tracker</div><div class="diff-removed">-            .and_then(|id_tracker| id_tracker.external_id(point_id))</div><div class="diff-removed">-            .is_some_and(|id| has_id.has_id.contains(&id)),</div><div class="diff-removed">-        Condition::HasVector(has_vector) => {</div><div class="diff-removed">-            if let Some(vector_storage) = vector_storages.get(&has_vector.has_vector) {</div><div class="diff-removed">-                !vector_storage.borrow().is_deleted_vector(point_id)</div><div class="diff-removed">-            } else {</div><div class="diff-removed">-                false</div><div class="diff-removed">-            }</div><div class="diff-removed">-        }</div><div class="diff-removed">-        Condition::Nested(nested) => {</div><div class="diff-removed">-            let nested_path = nested.array_key();</div><div class="diff-removed">-            let nested_indexes = select_nested_indexes(&nested_path, field_indexes);</div><div class="diff-removed">-            get_payload()</div><div class="diff-removed">-                .get_value(&nested_path)</div><div class="diff-removed">-                .iter()</div><div class="diff-removed">-                .filter_map(|value| value.as_object())</div><div class="diff-removed">-                .any(|object| {</div><div class="diff-removed">-                    check_payload(</div><div class="diff-removed">-                        Box::new(|| OwnedPayloadRef::from(object)),</div><div class="diff-removed">-                        None,            // HasId check in nested fields is not supported</div><div class="diff-removed">-                        &HashMap::new(), // HasVector check in nested fields is not supported</div><div class="diff-removed">-                        &nested.nested.filter,</div><div class="diff-removed">-                        point_id,</div><div class="diff-removed">-                        &nested_indexes,</div><div class="diff-removed">-                        hw_counter,</div><div class="diff-removed">-                    )</div><div class="diff-removed">-                })</div><div class="diff-removed">-        }</div><div class="diff-added">+11. Added `payload_json!` macro for easier payload construction in tests.</div><div> </div><div class="diff-removed">-        Condition::CustomIdChecker(cond) => id_tracker</div><div class="diff-removed">-            .and_then(|id_tracker| id_tracker.external_id(point_id))</div><div class="diff-removed">-            .is_some_and(|point_id| cond.check(point_id)),</div><div class="diff-added">+12. Implemented "is empty" and "is null" payload indexing.</div><div> </div><div class="diff-removed">-        Condition::Filter(_) => unreachable!(),</div><div class="diff-removed">-    };</div><div class="diff-added">+13. Added hardware counter for IO measurements in fulltext indexing.</div><div> </div><div class="diff-removed">-    check_filter(&checker, query)</div><div class="diff-removed">-}</div><div class="diff-added">+14. Switched to using `ahash` for sets holding point IDs and offsets.</div><div> </div><div class="diff-removed">-pub fn check_is_empty_condition(</div><div class="diff-removed">-    is_empty: &IsEmptyCondition,</div><div class="diff-removed">-    payload: &impl PayloadContainer,</div><div class="diff-removed">-) -> bool {</div><div class="diff-removed">-    check_is_empty(payload.get_value(&is_empty.is_empty.key).iter().copied())</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-pub fn check_is_null_condition(is_null: &IsNullCondition, payload: &impl PayloadContainer) -> bool {</div><div class="diff-removed">-    check_is_null(payload.get_value(&is_null.is_null.key).iter().copied())</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-pub fn check_field_condition<R>(</div><div class="diff-removed">-    field_condition: &FieldCondition,</div><div class="diff-removed">-    payload: &impl PayloadContainer,</div><div class="diff-removed">-    field_indexes: &HashMap<PayloadKeyType, R>,</div><div class="diff-removed">-    hw_counter: &HardwareCounterCell,</div><div class="diff-removed">-) -> bool</div><div class="diff-removed">-where</div><div class="diff-removed">-    R: AsRef<Vec<FieldIndex>>,</div><div class="diff-removed">-{</div><div class="diff-removed">-    let field_values = payload.get_value(&field_condition.key);</div><div class="diff-removed">-    let field_indexes = field_indexes.get(&field_condition.key);</div><div class="diff-removed">-</div><div class="diff-removed">-    if field_values.is_empty() {</div><div class="diff-removed">-        return field_condition.check_empty();</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    // This covers a case, when a field index affects the result of the condition.</div><div class="diff-removed">-    if let Some(field_indexes) = field_indexes {</div><div class="diff-removed">-        for p in field_values {</div><div class="diff-removed">-            let mut index_checked = false;</div><div class="diff-removed">-            for index in field_indexes.as_ref() {</div><div class="diff-removed">-                if let Some(index_check_res) =</div><div class="diff-removed">-                    index.special_check_condition(field_condition, p, hw_counter)</div><div class="diff-removed">-                {</div><div class="diff-removed">-                    if index_check_res {</div><div class="diff-removed">-                        // If at least one object matches the condition, we can return true</div><div class="diff-removed">-                        return true;</div><div class="diff-removed">-                    }</div><div class="diff-removed">-                    index_checked = true;</div><div class="diff-removed">-                    // If index check of the condition returned something, we don't need to check</div><div class="diff-removed">-                    // other indexes</div><div class="diff-removed">-                    break;</div><div class="diff-removed">-                }</div><div class="diff-removed">-            }</div><div class="diff-removed">-            if !index_checked {</div><div class="diff-removed">-                // If none of the indexes returned anything, we need to check the condition</div><div class="diff-removed">-                // against the payload</div><div class="diff-removed">-                if field_condition.check(p) {</div><div class="diff-removed">-                    return true;</div><div class="diff-removed">-                }</div><div class="diff-removed">-            }</div><div class="diff-removed">-        }</div><div class="diff-removed">-        false</div><div class="diff-removed">-    } else {</div><div class="diff-removed">-        // Fallback to regular condition check if there are no indexes for the field</div><div class="diff-removed">-        field_values.into_iter().any(|p| field_condition.check(p))</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-/// Only used for testing</div><div class="diff-removed">-#[cfg(feature = "testing")]</div><div class="diff-removed">-pub struct SimpleConditionChecker {</div><div class="diff-removed">-    payload_storage: Arc<AtomicRefCell<PayloadStorageEnum>>,</div><div class="diff-removed">-    id_tracker: Arc<AtomicRefCell<IdTrackerSS>>,</div><div class="diff-removed">-    vector_storages: HashMap<VectorNameBuf, Arc<AtomicRefCell<VectorStorageEnum>>>,</div><div class="diff-removed">-    empty_payload: Payload,</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-#[cfg(feature = "testing")]</div><div class="diff-removed">-impl SimpleConditionChecker {</div><div class="diff-removed">-    pub fn new(</div><div class="diff-removed">-        payload_storage: Arc<AtomicRefCell<PayloadStorageEnum>>,</div><div class="diff-removed">-        id_tracker: Arc<AtomicRefCell<IdTrackerSS>>,</div><div class="diff-removed">-        vector_storages: HashMap<VectorNameBuf, Arc<AtomicRefCell<VectorStorageEnum>>>,</div><div class="diff-removed">-    ) -> Self {</div><div class="diff-removed">-        SimpleConditionChecker {</div><div class="diff-removed">-            payload_storage,</div><div class="diff-removed">-            id_tracker,</div><div class="diff-removed">-            vector_storages,</div><div class="diff-removed">-            empty_payload: Default::default(),</div><div class="diff-removed">-        }</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-#[cfg(feature = "testing")]</div><div class="diff-removed">-impl ConditionChecker for SimpleConditionChecker {</div><div class="diff-removed">-    fn check(&self, point_id: PointOffsetType, query: &Filter) -> bool {</div><div class="diff-removed">-        let hw_counter = HardwareCounterCell::new(); // No measurements needed as this is only for test!</div><div class="diff-removed">-</div><div class="diff-removed">-        let payload_storage_guard = self.payload_storage.borrow();</div><div class="diff-removed">-</div><div class="diff-removed">-        let payload_ref_cell: RefCell<Option<OwnedPayloadRef>> = RefCell::new(None);</div><div class="diff-removed">-        let id_tracker = self.id_tracker.borrow();</div><div class="diff-removed">-</div><div class="diff-removed">-        let vector_storages = &self.vector_storages;</div><div class="diff-removed">-</div><div class="diff-removed">-        check_payload(</div><div class="diff-removed">-            Box::new(|| {</div><div class="diff-removed">-                if payload_ref_cell.borrow().is_none() {</div><div class="diff-removed">-                    let payload_ptr = match payload_storage_guard.deref() {</div><div class="diff-removed">-                        PayloadStorageEnum::InMemoryPayloadStorage(s) => {</div><div class="diff-removed">-                            s.payload_ptr(point_id).map(|x| x.into())</div><div class="diff-removed">-                        }</div><div class="diff-removed">-                        PayloadStorageEnum::SimplePayloadStorage(s) => {</div><div class="diff-removed">-                            s.payload_ptr(point_id).map(|x| x.into())</div><div class="diff-removed">-                        }</div><div class="diff-removed">-                        PayloadStorageEnum::OnDiskPayloadStorage(s) => {</div><div class="diff-removed">-                            // Warn: Possible panic here</div><div class="diff-removed">-                            // Currently, it is possible that `read_payload` fails with Err,</div><div class="diff-removed">-                            // but it seems like a very rare possibility which might only happen</div><div class="diff-removed">-                            // if something is wrong with disk or storage is corrupted.</div><div class="diff-removed">-                            //</div><div class="diff-removed">-                            // In both cases it means that service can't be of use any longer.</div><div class="diff-removed">-                            // It is as good as dead. Therefore it is tolerable to just panic here.</div><div class="diff-removed">-                            // Downside is - API user won't be notified of the failure.</div><div class="diff-removed">-                            // It will just timeout.</div><div class="diff-removed">-                            //</div><div class="diff-removed">-                            // The alternative:</div><div class="diff-removed">-                            // Rewrite condition checking code to support error reporting.</div><div class="diff-removed">-                            // Which may lead to slowdown and assumes a lot of changes.</div><div class="diff-removed">-                            s.read_payload(point_id, &hw_counter)</div><div class="diff-removed">-                                .unwrap_or_else(|err| panic!("Payload storage is corrupted: {err}"))</div><div class="diff-removed">-                                .map(|x| x.into())</div><div class="diff-removed">-                        }</div><div class="diff-removed">-                        PayloadStorageEnum::MmapPayloadStorage(s) => {</div><div class="diff-removed">-                            let payload = s.get(point_id, &hw_counter).unwrap_or_else(|err| {</div><div class="diff-removed">-                                panic!("Payload storage is corrupted: {err}")</div><div class="diff-removed">-                            });</div><div class="diff-removed">-                            Some(OwnedPayloadRef::from(payload))</div><div class="diff-removed">-                        }</div><div class="diff-removed">-                    };</div><div class="diff-removed">-</div><div class="diff-removed">-                    payload_ref_cell</div><div class="diff-removed">-                        .replace(payload_ptr.or_else(|| Some((&self.empty_payload).into())));</div><div class="diff-removed">-                }</div><div class="diff-removed">-                payload_ref_cell.borrow().as_ref().cloned().unwrap()</div><div class="diff-removed">-            }),</div><div class="diff-removed">-            Some(id_tracker.deref()),</div><div class="diff-removed">-            vector_storages,</div><div class="diff-removed">-            query,</div><div class="diff-removed">-            point_id,</div><div class="diff-removed">-            &IndexesMap::new(),</div><div class="diff-removed">-            &HardwareCounterCell::new(),</div><div class="diff-removed">-        )</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-#[cfg(test)]</div><div class="diff-removed">-mod tests {</div><div class="diff-removed">-    use std::str::FromStr;</div><div class="diff-removed">-</div><div class="diff-removed">-    use ahash::AHashSet;</div><div class="diff-removed">-    use tempfile::Builder;</div><div class="diff-removed">-</div><div class="diff-removed">-    use super::*;</div><div class="diff-removed">-    use crate::common::rocksdb_wrapper::{DB_VECTOR_CF, open_db};</div><div class="diff-removed">-    use crate::id_tracker::IdTracker;</div><div class="diff-removed">-    use crate::id_tracker::simple_id_tracker::SimpleIdTracker;</div><div class="diff-removed">-    use crate::json_path::JsonPath;</div><div class="diff-removed">-    use crate::payload_json;</div><div class="diff-removed">-    use crate::payload_storage::PayloadStorage;</div><div class="diff-removed">-    use crate::payload_storage::simple_payload_storage::SimplePayloadStorage;</div><div class="diff-removed">-    use crate::types::{</div><div class="diff-removed">-        DateTimeWrapper, FieldCondition, GeoBoundingBox, GeoPoint, PayloadField, Range, ValuesCount,</div><div class="diff-removed">-    };</div><div class="diff-removed">-</div><div class="diff-removed">-    #[test]</div><div class="diff-removed">-    fn test_condition_checker() {</div><div class="diff-removed">-        let dir = Builder::new().prefix("db_dir").tempdir().unwrap();</div><div class="diff-removed">-        let db = open_db(dir.path(), &[DB_VECTOR_CF]).unwrap();</div><div class="diff-removed">-</div><div class="diff-removed">-        let payload = payload_json! {</div><div class="diff-removed">-            "location": {</div><div class="diff-removed">-                "lon": 13.404954,</div><div class="diff-removed">-                "lat": 52.520008,</div><div class="diff-removed">-            },</div><div class="diff-removed">-            "price": 499.90,</div><div class="diff-removed">-            "amount": 10,</div><div class="diff-removed">-            "rating": vec![3, 7, 9, 9],</div><div class="diff-removed">-            "color": "red",</div><div class="diff-removed">-            "has_delivery": true,</div><div class="diff-removed">-            "shipped_at": "2020-02-15T00:00:00Z",</div><div class="diff-removed">-            "parts": [],</div><div class="diff-removed">-            "packaging": null,</div><div class="diff-removed">-            "not_null": [null],</div><div class="diff-removed">-        };</div><div class="diff-removed">-</div><div class="diff-removed">-        let hw_counter = HardwareCounterCell::new();</div><div class="diff-removed">-</div><div class="diff-removed">-        let mut payload_storage: PayloadStorageEnum =</div><div class="diff-removed">-            SimplePayloadStorage::open(db.clone()).unwrap().into();</div><div class="diff-removed">-        let mut id_tracker = SimpleIdTracker::open(db).unwrap();</div><div class="diff-removed">-</div><div class="diff-removed">-        id_tracker.set_link(0.into(), 0).unwrap();</div><div class="diff-removed">-        id_tracker.set_link(1.into(), 1).unwrap();</div><div class="diff-removed">-        id_tracker.set_link(2.into(), 2).unwrap();</div><div class="diff-removed">-        id_tracker.set_link(10.into(), 10).unwrap();</div><div class="diff-removed">-        payload_storage.overwrite(0, &payload, &hw_counter).unwrap();</div><div class="diff-removed">-</div><div class="diff-removed">-        let payload_checker = SimpleConditionChecker::new(</div><div class="diff-removed">-            Arc::new(AtomicRefCell::new(payload_storage)),</div><div class="diff-removed">-            Arc::new(AtomicRefCell::new(id_tracker)),</div><div class="diff-removed">-            HashMap::new(),</div><div class="diff-removed">-        );</div><div class="diff-removed">-</div><div class="diff-removed">-        let is_empty_condition = Filter::new_must(Condition::IsEmpty(IsEmptyCondition {</div><div class="diff-removed">-            is_empty: PayloadField {</div><div class="diff-removed">-                key: JsonPath::new("price"),</div><div class="diff-removed">-            },</div><div class="diff-removed">-        }));</div><div class="diff-removed">-        assert!(!payload_checker.check(0, &is_empty_condition));</div><div class="diff-removed">-</div><div class="diff-removed">-        let is_empty_condition = Filter::new_must(Condition::IsEmpty(IsEmptyCondition {</div><div class="diff-removed">-            is_empty: PayloadField {</div><div class="diff-removed">-                key: JsonPath::new("something_new"),</div><div class="diff-removed">-            },</div><div class="diff-removed">-        }));</div><div class="diff-removed">-        assert!(payload_checker.check(0, &is_empty_condition));</div><div class="diff-removed">-</div><div class="diff-removed">-        let is_empty_condition = Filter::new_must(Condition::IsEmpty(IsEmptyCondition {</div><div class="diff-removed">-            is_empty: PayloadField {</div><div class="diff-removed">-                key: JsonPath::new("parts"),</div><div class="diff-removed">-            },</div><div class="diff-removed">-        }));</div><div class="diff-removed">-        assert!(payload_checker.check(0, &is_empty_condition));</div><div class="diff-removed">-</div><div class="diff-removed">-        let is_empty_condition = Filter::new_must(Condition::IsEmpty(IsEmptyCondition {</div><div class="diff-removed">-            is_empty: PayloadField {</div><div class="diff-removed">-                key: JsonPath::new("not_null"),</div><div class="diff-removed">-            },</div><div class="diff-removed">-        }));</div><div class="diff-removed">-        assert!(!payload_checker.check(0, &is_empty_condition));</div><div class="diff-removed">-</div><div class="diff-removed">-        let is_null_condition = Filter::new_must(Condition::IsNull(IsNullCondition {</div><div class="diff-removed">-            is_null: PayloadField {</div><div class="diff-removed">-                key: JsonPath::new("amount"),</div><div class="diff-removed">-            },</div><div class="diff-removed">-        }));</div><div class="diff-removed">-        assert!(!payload_checker.check(0, &is_null_condition));</div><div class="diff-removed">-</div><div class="diff-removed">-        let is_null_condition = Filter::new_must(Condition::IsNull(IsNullCondition {</div><div class="diff-removed">-            is_null: PayloadField {</div><div class="diff-removed">-                key: JsonPath::new("parts"),</div><div class="diff-removed">-            },</div><div class="diff-removed">-        }));</div><div class="diff-removed">-        assert!(!payload_checker.check(0, &is_null_condition));</div><div class="diff-removed">-</div><div class="diff-removed">-        let is_null_condition = Filter::new_must(Condition::IsNull(IsNullCondition {</div><div class="diff-removed">-            is_null: PayloadField {</div><div class="diff-removed">-                key: JsonPath::new("something_else"),</div><div class="diff-removed">-            },</div><div class="diff-removed">-        }));</div><div class="diff-removed">-        assert!(!payload_checker.check(0, &is_null_condition));</div><div class="diff-removed">-</div><div class="diff-removed">-        let is_null_condition = Filter::new_must(Condition::IsNull(IsNullCondition {</div><div class="diff-removed">-            is_null: PayloadField {</div><div class="diff-removed">-                key: JsonPath::new("packaging"),</div><div class="diff-removed">-            },</div><div class="diff-removed">-        }));</div><div class="diff-removed">-        assert!(payload_checker.check(0, &is_null_condition));</div><div class="diff-removed">-</div><div class="diff-removed">-        let is_null_condition = Filter::new_must(Condition::IsNull(IsNullCondition {</div><div class="diff-removed">-            is_null: PayloadField {</div><div class="diff-removed">-                key: JsonPath::new("not_null"),</div><div class="diff-removed">-            },</div><div class="diff-removed">-        }));</div><div class="diff-removed">-        assert!(!payload_checker.check(0, &is_null_condition));</div><div class="diff-removed">-</div><div class="diff-removed">-        let match_red = Condition::Field(FieldCondition::new_match(</div><div class="diff-removed">-            JsonPath::new("color"),</div><div class="diff-removed">-            "red".to_owned().into(),</div><div class="diff-removed">-        ));</div><div class="diff-removed">-        let match_blue = Condition::Field(FieldCondition::new_match(</div><div class="diff-removed">-            JsonPath::new("color"),</div><div class="diff-removed">-            "blue".to_owned().into(),</div><div class="diff-removed">-        ));</div><div class="diff-removed">-        let shipped_in_february = Condition::Field(FieldCondition::new_datetime_range(</div><div class="diff-removed">-            JsonPath::new("shipped_at"),</div><div class="diff-removed">-            Range {</div><div class="diff-removed">-                lt: Some(DateTimeWrapper::from_str("2020-03-01T00:00:00Z").unwrap()),</div><div class="diff-removed">-                gt: None,</div><div class="diff-removed">-                gte: Some(DateTimeWrapper::from_str("2020-02-01T00:00:00Z").unwrap()),</div><div class="diff-removed">-                lte: None,</div><div class="diff-removed">-            },</div><div class="diff-removed">-        ));</div><div class="diff-removed">-        let shipped_in_march = Condition::Field(FieldCondition::new_datetime_range(</div><div class="diff-removed">-            JsonPath::new("shipped_at"),</div><div class="diff-removed">-            Range {</div><div class="diff-removed">-                lt: Some(DateTimeWrapper::from_str("2020-04-01T00:00:00Z").unwrap()),</div><div class="diff-removed">-                gt: None,</div><div class="diff-removed">-                gte: Some(DateTimeWrapper::from_str("2020-03-01T00:00:00Z").unwrap()),</div><div class="diff-removed">-                lte: None,</div><div class="diff-removed">-            },</div><div class="diff-removed">-        ));</div><div class="diff-removed">-        let with_delivery = Condition::Field(FieldCondition::new_match(</div><div class="diff-removed">-            JsonPath::new("has_delivery"),</div><div class="diff-removed">-            true.into(),</div><div class="diff-removed">-        ));</div><div class="diff-removed">-</div><div class="diff-removed">-        let many_value_count_condition =</div><div class="diff-removed">-            Filter::new_must(Condition::Field(FieldCondition::new_values_count(</div><div class="diff-removed">-                JsonPath::new("rating"),</div><div class="diff-removed">-                ValuesCount {</div><div class="diff-removed">-                    lt: None,</div><div class="diff-removed">-                    gt: None,</div><div class="diff-removed">-                    gte: Some(10),</div><div class="diff-removed">-                    lte: None,</div><div class="diff-removed">-                },</div><div class="diff-removed">-            )));</div><div class="diff-removed">-        assert!(!payload_checker.check(0, &many_value_count_condition));</div><div class="diff-removed">-</div><div class="diff-removed">-        let few_value_count_condition =</div><div class="diff-removed">-            Filter::new_must(Condition::Field(FieldCondition::new_values_count(</div><div class="diff-removed">-                JsonPath::new("rating"),</div><div class="diff-removed">-                ValuesCount {</div><div class="diff-removed">-                    lt: Some(5),</div><div class="diff-removed">-                    gt: None,</div><div class="diff-removed">-                    gte: None,</div><div class="diff-removed">-                    lte: None,</div><div class="diff-removed">-                },</div><div class="diff-removed">-            )));</div><div class="diff-removed">-        assert!(payload_checker.check(0, &few_value_count_condition));</div><div class="diff-removed">-</div><div class="diff-removed">-        let in_berlin = Condition::Field(FieldCondition::new_geo_bounding_box(</div><div class="diff-removed">-            JsonPath::new("location"),</div><div class="diff-removed">-            GeoBoundingBox {</div><div class="diff-removed">-                top_left: GeoPoint {</div><div class="diff-removed">-                    lon: 13.08835,</div><div class="diff-removed">-                    lat: 52.67551,</div><div class="diff-removed">-                },</div><div class="diff-removed">-                bottom_right: GeoPoint {</div><div class="diff-removed">-                    lon: 13.76116,</div><div class="diff-removed">-                    lat: 52.33826,</div><div class="diff-removed">-                },</div><div class="diff-removed">-            },</div><div class="diff-removed">-        ));</div><div class="diff-removed">-</div><div class="diff-removed">-        let in_moscow = Condition::Field(FieldCondition::new_geo_bounding_box(</div><div class="diff-removed">-            JsonPath::new("location"),</div><div class="diff-removed">-            GeoBoundingBox {</div><div class="diff-removed">-                top_left: GeoPoint {</div><div class="diff-removed">-                    lon: 37.0366,</div><div class="diff-removed">-                    lat: 56.1859,</div><div class="diff-removed">-                },</div><div class="diff-removed">-                bottom_right: GeoPoint {</div><div class="diff-removed">-                    lon: 38.2532,</div><div class="diff-removed">-                    lat: 55.317,</div><div class="diff-removed">-                },</div><div class="diff-removed">-            },</div><div class="diff-removed">-        ));</div><div class="diff-removed">-</div><div class="diff-removed">-        let with_bad_rating = Condition::Field(FieldCondition::new_range(</div><div class="diff-removed">-            JsonPath::new("rating"),</div><div class="diff-removed">-            Range {</div><div class="diff-removed">-                lt: None,</div><div class="diff-removed">-                gt: None,</div><div class="diff-removed">-                gte: None,</div><div class="diff-removed">-                lte: Some(5.),</div><div class="diff-removed">-            },</div><div class="diff-removed">-        ));</div><div class="diff-removed">-</div><div class="diff-removed">-        let query = Filter::new_must(match_red.clone());</div><div class="diff-removed">-        assert!(payload_checker.check(0, &query));</div><div class="diff-removed">-</div><div class="diff-removed">-        let query = Filter::new_must(match_blue.clone());</div><div class="diff-removed">-        assert!(!payload_checker.check(0, &query));</div><div class="diff-removed">-</div><div class="diff-removed">-        let query = Filter::new_must_not(match_blue.clone());</div><div class="diff-removed">-        assert!(payload_checker.check(0, &query));</div><div class="diff-removed">-</div><div class="diff-removed">-        let query = Filter::new_must_not(match_red.clone());</div><div class="diff-removed">-        assert!(!payload_checker.check(0, &query));</div><div class="diff-removed">-</div><div class="diff-removed">-        let query = Filter {</div><div class="diff-removed">-            should: Some(vec![match_red.clone(), match_blue.clone()]),</div><div class="diff-removed">-            min_should: None,</div><div class="diff-removed">-            must: Some(vec![with_delivery.clone(), in_berlin.clone()]),</div><div class="diff-removed">-            must_not: None,</div><div class="diff-removed">-        };</div><div class="diff-removed">-        assert!(payload_checker.check(0, &query));</div><div class="diff-removed">-</div><div class="diff-removed">-        let query = Filter {</div><div class="diff-removed">-            should: Some(vec![match_red.clone(), match_blue.clone()]),</div><div class="diff-removed">-            min_should: None,</div><div class="diff-removed">-            must: Some(vec![with_delivery, in_moscow.clone()]),</div><div class="diff-removed">-            must_not: None,</div><div class="diff-removed">-        };</div><div class="diff-removed">-        assert!(!payload_checker.check(0, &query));</div><div class="diff-removed">-</div><div class="diff-removed">-        let query = Filter {</div><div class="diff-removed">-            should: Some(vec![</div><div class="diff-removed">-                Condition::Filter(Filter {</div><div class="diff-removed">-                    should: None,</div><div class="diff-removed">-                    min_should: None,</div><div class="diff-removed">-                    must: Some(vec![match_red.clone(), in_moscow.clone()]),</div><div class="diff-removed">-                    must_not: None,</div><div class="diff-removed">-                }),</div><div class="diff-removed">-                Condition::Filter(Filter {</div><div class="diff-removed">-                    should: None,</div><div class="diff-removed">-                    min_should: None,</div><div class="diff-removed">-                    must: Some(vec![match_blue.clone(), in_berlin.clone()]),</div><div class="diff-removed">-                    must_not: None,</div><div class="diff-removed">-                }),</div><div class="diff-removed">-            ]),</div><div class="diff-removed">-            min_should: None,</div><div class="diff-removed">-            must: None,</div><div class="diff-removed">-            must_not: None,</div><div class="diff-removed">-        };</div><div class="diff-removed">-        assert!(!payload_checker.check(0, &query));</div><div class="diff-removed">-</div><div class="diff-removed">-        let query = Filter {</div><div class="diff-removed">-            should: Some(vec![</div><div class="diff-removed">-                Condition::Filter(Filter {</div><div class="diff-removed">-                    should: None,</div><div class="diff-removed">-                    min_should: None,</div><div class="diff-removed">-                    must: Some(vec![match_blue.clone(), in_moscow.clone()]),</div><div class="diff-removed">-                    must_not: None,</div><div class="diff-removed">-                }),</div><div class="diff-removed">-                Condition::Filter(Filter {</div><div class="diff-removed">-                    should: None,</div><div class="diff-removed">-                    min_should: None,</div><div class="diff-removed">-                    must: Some(vec![match_red.clone(), in_berlin.clone()]),</div><div class="diff-removed">-                    must_not: None,</div><div class="diff-removed">-                }),</div><div class="diff-removed">-            ]),</div><div class="diff-removed">-            min_should: None,</div><div class="diff-removed">-            must: None,</div><div class="diff-removed">-            must_not: None,</div><div class="diff-removed">-        };</div><div class="diff-removed">-        assert!(payload_checker.check(0, &query));</div><div class="diff-removed">-</div><div class="diff-removed">-        let query = Filter::new_must_not(with_bad_rating);</div><div class="diff-removed">-        assert!(!payload_checker.check(0, &query));</div><div class="diff-removed">-</div><div class="diff-removed">-        // min_should</div><div class="diff-removed">-        let query = Filter::new_min_should(MinShould {</div><div class="diff-removed">-            conditions: vec![match_blue.clone(), in_moscow.clone()],</div><div class="diff-removed">-            min_count: 1,</div><div class="diff-removed">-        });</div><div class="diff-removed">-        assert!(!payload_checker.check(0, &query));</div><div class="diff-removed">-</div><div class="diff-removed">-        let query = Filter::new_min_should(MinShould {</div><div class="diff-removed">-            conditions: vec![match_red.clone(), in_berlin.clone(), in_moscow.clone()],</div><div class="diff-removed">-            min_count: 2,</div><div class="diff-removed">-        });</div><div class="diff-removed">-        assert!(payload_checker.check(0, &query));</div><div class="diff-removed">-</div><div class="diff-removed">-        let query = Filter::new_min_should(MinShould {</div><div class="diff-removed">-            conditions: vec![</div><div class="diff-removed">-                Condition::Filter(Filter {</div><div class="diff-removed">-                    should: None,</div><div class="diff-removed">-                    min_should: None,</div><div class="diff-removed">-                    must: Some(vec![match_blue, in_moscow]),</div><div class="diff-removed">-                    must_not: None,</div><div class="diff-removed">-                }),</div><div class="diff-removed">-                Condition::Filter(Filter {</div><div class="diff-removed">-                    should: None,</div><div class="diff-removed">-                    min_should: None,</div><div class="diff-removed">-                    must: Some(vec![match_red, in_berlin]),</div><div class="diff-removed">-                    must_not: None,</div><div class="diff-removed">-                }),</div><div class="diff-removed">-            ],</div><div class="diff-removed">-            min_count: 1,</div><div class="diff-removed">-        });</div><div class="diff-removed">-        assert!(payload_checker.check(0, &query));</div><div class="diff-removed">-</div><div class="diff-removed">-        // DateTime payload index</div><div class="diff-removed">-        let query = Filter::new_must(shipped_in_february);</div><div class="diff-removed">-        assert!(payload_checker.check(0, &query));</div><div class="diff-removed">-</div><div class="diff-removed">-        let query = Filter::new_must(shipped_in_march);</div><div class="diff-removed">-        assert!(!payload_checker.check(0, &query));</div><div class="diff-removed">-</div><div class="diff-removed">-        // id Filter</div><div class="diff-removed">-        let ids: AHashSet<_> = vec![1, 2, 3].into_iter().map(|x| x.into()).collect();</div><div class="diff-removed">-</div><div class="diff-removed">-        let query = Filter::new_must_not(Condition::HasId(ids.into()));</div><div class="diff-removed">-        assert!(!payload_checker.check(2, &query));</div><div class="diff-removed">-</div><div class="diff-removed">-        let ids: AHashSet<_> = vec![1, 2, 3].into_iter().map(|x| x.into()).collect();</div><div class="diff-removed">-</div><div class="diff-removed">-        let query = Filter::new_must_not(Condition::HasId(ids.into()));</div><div class="diff-removed">-        assert!(payload_checker.check(10, &query));</div><div class="diff-removed">-</div><div class="diff-removed">-        let ids: AHashSet<_> = vec![1, 2, 3].into_iter().map(|x| x.into()).collect();</div><div class="diff-removed">-</div><div class="diff-removed">-        let query = Filter::new_must(Condition::HasId(ids.into()));</div><div class="diff-removed">-        assert!(payload_checker.check(2, &query));</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div>\ No newline at end of file</div><div class="diff-added">+The file evolved to support more advanced filtering capabilities, improved performance through indexing, and added instrumentation for IO measurements. The changes reflect Qdrant's development in supporting more complex queries and optimizing search operations.</div><div>\ No newline at end of file</div><div></div></pre>
                </div>
            </div>
        </section>
    </main>
    <footer>
        <p>LoCoDiff-bench - <a href="https://github.com/AbanteAI/LoCoDiff-bench">GitHub Repository</a></p>
    </footer>
</body>
</html>
    