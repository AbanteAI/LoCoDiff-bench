<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case: src/terminal/Parser.zig - Sonnet 3.5</title>
    <link rel="stylesheet" href="../../styles.css">
</head>
<body>
    <header>
        <h1>Case: src/terminal/Parser.zig</h1>
        <h2>Model: Sonnet 3.5</h2>
        <p><a href="../../models/anthropic_claude-3.5-sonnet-20240620.html">All Sonnet 3.5 Cases</a> | <a href="../../cases.html">All Cases</a> | <a href="../../index.html">Home</a></p>
    </header>
    <main>
        <section class="case-details">
            <div class="case-info">
                <h2>Benchmark Case Information</h2>
                <p><strong>Model:</strong> Sonnet 3.5</p>
                <p><strong>Status:</strong> <span class="failure">Failure</span></p>
                <p><strong>Prompt Tokens:</strong> 32616</p>
                <p><strong>Native Prompt Tokens:</strong> 40196</p>
                <p><strong>Native Completion Tokens:</strong> 296</p>
                <p><strong>Native Tokens Reasoning:</strong> 0</p>
                <p><strong>Native Finish Reason:</strong> stop</p>
                <p><strong>Cost:</strong> $0.125028</p>
            </div>
            
            <div class="content-links">
                <h2>View Content</h2>
                <ul>
                    <li><a href="../../content/anthropic_claude-3.5-sonnet-20240620/ghostty_src_terminal_Parser.zig/prompt.html" class="content-link">View Prompt</a></li>
                    <li><a href="../../content/anthropic_claude-3.5-sonnet-20240620/ghostty_src_terminal_Parser.zig/expected.html" class="content-link">View Expected Output</a></li>
                    <li><a href="../../content/anthropic_claude-3.5-sonnet-20240620/ghostty_src_terminal_Parser.zig/actual.html" class="content-link">View Actual Output</a></li>
                </ul>
            </div>
            
            <div class="diff-section">
                <h2>Diff (Expected vs Actual)</h2>
                <div id="diff-output">
                    <pre class="diff"><div></div><div>index ed477f2d1..984b9b75a 100644</div><div class="diff-header">--- a/ghostty_src_terminal_Parser.zig_expectedoutput.txt (expected):tmp/tmpgdn0ifui_expected.txt	</div><div class="diff-header">+++ b/ghostty_src_terminal_Parser.zig_extracted.txt (actual):tmp/tmpxp2mtr85_actual.txt	</div><div class="diff-info">@@ -1,964 +1,25 @@</div><div class="diff-removed">-//! VT-series parser for escape and control sequences.</div><div class="diff-removed">-//!</div><div class="diff-removed">-//! This is implemented directly as the state machine described on</div><div class="diff-removed">-//! vt100.net: https://vt100.net/emu/dec_ansi_parser</div><div class="diff-removed">-const Parser = @This();</div><div class="diff-added">+Here is a summary of the key changes made to the `src/terminal/Parser.zig` file over time:</div><div> </div><div class="diff-removed">-const std = @import("std");</div><div class="diff-removed">-const builtin = @import("builtin");</div><div class="diff-removed">-const assert = std.debug.assert;</div><div class="diff-removed">-const testing = std.testing;</div><div class="diff-removed">-const table = @import("parse_table.zig").table;</div><div class="diff-removed">-const osc = @import("osc.zig");</div><div class="diff-added">+1. Initial implementation of a VT-series parser for escape and control sequences, based on the state machine described on vt100.net.</div><div> </div><div class="diff-removed">-const log = std.log.scoped(.parser);</div><div class="diff-added">+2. Added support for parsing CSI (Control Sequence Introducer) commands, including handling parameters and intermediates.</div><div> </div><div class="diff-removed">-/// States for the state machine</div><div class="diff-removed">-pub const State = enum {</div><div class="diff-removed">-    ground,</div><div class="diff-removed">-    escape,</div><div class="diff-removed">-    escape_intermediate,</div><div class="diff-removed">-    csi_entry,</div><div class="diff-removed">-    csi_intermediate,</div><div class="diff-removed">-    csi_param,</div><div class="diff-removed">-    csi_ignore,</div><div class="diff-removed">-    dcs_entry,</div><div class="diff-removed">-    dcs_param,</div><div class="diff-removed">-    dcs_intermediate,</div><div class="diff-removed">-    dcs_passthrough,</div><div class="diff-removed">-    dcs_ignore,</div><div class="diff-removed">-    osc_string,</div><div class="diff-removed">-    sos_pm_apc_string,</div><div class="diff-removed">-};</div><div class="diff-added">+3. Implemented UTF-8 decoding within the parser.</div><div> </div><div class="diff-removed">-/// Transition action is an action that can be taken during a state</div><div class="diff-removed">-/// transition. This is more of an internal action, not one used by</div><div class="diff-removed">-/// end users, typically.</div><div class="diff-removed">-pub const TransitionAction = enum {</div><div class="diff-removed">-    none,</div><div class="diff-removed">-    ignore,</div><div class="diff-removed">-    print,</div><div class="diff-removed">-    execute,</div><div class="diff-removed">-    collect,</div><div class="diff-removed">-    param,</div><div class="diff-removed">-    esc_dispatch,</div><div class="diff-removed">-    csi_dispatch,</div><div class="diff-removed">-    put,</div><div class="diff-removed">-    osc_put,</div><div class="diff-removed">-    apc_put,</div><div class="diff-removed">-};</div><div class="diff-added">+4. Added support for OSC (Operating System Command) parsing.</div><div> </div><div class="diff-removed">-/// Action is the action that a caller of the parser is expected to</div><div class="diff-removed">-/// take as a result of some input character.</div><div class="diff-removed">-pub const Action = union(enum) {</div><div class="diff-removed">-    pub const Tag = std.meta.FieldEnum(Action);</div><div class="diff-added">+5. Improved handling of CSI parameters, including support for both semicolon and colon separators in SGR (Select Graphic Rendition) commands.</div><div> </div><div class="diff-removed">-    /// Draw character to the screen. This is a unicode codepoint.</div><div class="diff-removed">-    print: u21,</div><div class="diff-added">+6. Added support for DCS (Device Control String) parsing.</div><div> </div><div class="diff-removed">-    /// Execute the C0 or C1 function.</div><div class="diff-removed">-    execute: u8,</div><div class="diff-added">+7. Implemented APC (Application Program Command) parsing.</div><div> </div><div class="diff-removed">-    /// Execute the CSI command. Note that pointers within this</div><div class="diff-removed">-    /// structure are only valid until the next call to "next".</div><div class="diff-removed">-    csi_dispatch: CSI,</div><div class="diff-added">+8. Increased the maximum number of CSI parameters from 16 to 24 to handle more complex real-world sequences.</div><div> </div><div class="diff-removed">-    /// Execute the ESC command.</div><div class="diff-removed">-    esc_dispatch: ESC,</div><div class="diff-added">+9. Various optimizations and bug fixes throughout development.</div><div> </div><div class="diff-removed">-    /// Execute the OSC command.</div><div class="diff-removed">-    osc_dispatch: osc.Command,</div><div class="diff-added">+10. Improved error handling and logging for invalid sequences.</div><div> </div><div class="diff-removed">-    /// DCS-related events.</div><div class="diff-removed">-    dcs_hook: DCS,</div><div class="diff-removed">-    dcs_put: u8,</div><div class="diff-removed">-    dcs_unhook: void,</div><div class="diff-added">+11. Added more comprehensive test cases to cover various edge cases and real-world scenarios.</div><div> </div><div class="diff-removed">-    /// APC data</div><div class="diff-removed">-    apc_start: void,</div><div class="diff-removed">-    apc_put: u8,</div><div class="diff-removed">-    apc_end: void,</div><div class="diff-removed">-</div><div class="diff-removed">-    pub const CSI = struct {</div><div class="diff-removed">-        intermediates: []u8,</div><div class="diff-removed">-        params: []u16,</div><div class="diff-removed">-        params_sep: SepList,</div><div class="diff-removed">-        final: u8,</div><div class="diff-removed">-</div><div class="diff-removed">-        /// The list of separators used for CSI params. The value of the</div><div class="diff-removed">-        /// bit can be mapped to Sep. The index of this bit set specifies</div><div class="diff-removed">-        /// the separator AFTER that param. For example: 0;4:3 would have</div><div class="diff-removed">-        /// index 1 set.</div><div class="diff-removed">-        pub const SepList = std.StaticBitSet(MAX_PARAMS);</div><div class="diff-removed">-</div><div class="diff-removed">-        /// The separator used for CSI params.</div><div class="diff-removed">-        pub const Sep = enum(u1) { semicolon = 0, colon = 1 };</div><div class="diff-removed">-</div><div class="diff-removed">-        // Implement formatter for logging</div><div class="diff-removed">-        pub fn format(</div><div class="diff-removed">-            self: CSI,</div><div class="diff-removed">-            comptime layout: []const u8,</div><div class="diff-removed">-            opts: std.fmt.FormatOptions,</div><div class="diff-removed">-            writer: anytype,</div><div class="diff-removed">-        ) !void {</div><div class="diff-removed">-            _ = layout;</div><div class="diff-removed">-            _ = opts;</div><div class="diff-removed">-            try std.fmt.format(writer, "ESC [ {s} {any} {c}", .{</div><div class="diff-removed">-                self.intermediates,</div><div class="diff-removed">-                self.params,</div><div class="diff-removed">-                self.final,</div><div class="diff-removed">-            });</div><div class="diff-removed">-        }</div><div class="diff-removed">-    };</div><div class="diff-removed">-</div><div class="diff-removed">-    pub const ESC = struct {</div><div class="diff-removed">-        intermediates: []u8,</div><div class="diff-removed">-        final: u8,</div><div class="diff-removed">-</div><div class="diff-removed">-        // Implement formatter for logging</div><div class="diff-removed">-        pub fn format(</div><div class="diff-removed">-            self: ESC,</div><div class="diff-removed">-            comptime layout: []const u8,</div><div class="diff-removed">-            opts: std.fmt.FormatOptions,</div><div class="diff-removed">-            writer: anytype,</div><div class="diff-removed">-        ) !void {</div><div class="diff-removed">-            _ = layout;</div><div class="diff-removed">-            _ = opts;</div><div class="diff-removed">-            try std.fmt.format(writer, "ESC {s} {c}", .{</div><div class="diff-removed">-                self.intermediates,</div><div class="diff-removed">-                self.final,</div><div class="diff-removed">-            });</div><div class="diff-removed">-        }</div><div class="diff-removed">-    };</div><div class="diff-removed">-</div><div class="diff-removed">-    pub const DCS = struct {</div><div class="diff-removed">-        intermediates: []const u8 = "",</div><div class="diff-removed">-        params: []const u16 = &.{},</div><div class="diff-removed">-        final: u8,</div><div class="diff-removed">-    };</div><div class="diff-removed">-</div><div class="diff-removed">-    // Implement formatter for logging. This is mostly copied from the</div><div class="diff-removed">-    // std.fmt implementation, but we modify it slightly so that we can</div><div class="diff-removed">-    // print out custom formats for some of our primitives.</div><div class="diff-removed">-    pub fn format(</div><div class="diff-removed">-        self: Action,</div><div class="diff-removed">-        comptime layout: []const u8,</div><div class="diff-removed">-        opts: std.fmt.FormatOptions,</div><div class="diff-removed">-        writer: anytype,</div><div class="diff-removed">-    ) !void {</div><div class="diff-removed">-        _ = layout;</div><div class="diff-removed">-        const T = Action;</div><div class="diff-removed">-        const info = @typeInfo(T).@"union";</div><div class="diff-removed">-</div><div class="diff-removed">-        try writer.writeAll(@typeName(T));</div><div class="diff-removed">-        if (info.tag_type) |TagType| {</div><div class="diff-removed">-            try writer.writeAll("{ .");</div><div class="diff-removed">-            try writer.writeAll(@tagName(@as(TagType, self)));</div><div class="diff-removed">-            try writer.writeAll(" = ");</div><div class="diff-removed">-</div><div class="diff-removed">-            inline for (info.fields) |u_field| {</div><div class="diff-removed">-                // If this is the active field...</div><div class="diff-removed">-                if (self == @field(TagType, u_field.name)) {</div><div class="diff-removed">-                    const value = @field(self, u_field.name);</div><div class="diff-removed">-                    switch (@TypeOf(value)) {</div><div class="diff-removed">-                        // Unicode</div><div class="diff-removed">-                        u21 => try std.fmt.format(writer, "'{u}' (U+{X})", .{ value, value }),</div><div class="diff-removed">-</div><div class="diff-removed">-                        // Byte</div><div class="diff-removed">-                        u8 => try std.fmt.format(writer, "0x{x}", .{value}),</div><div class="diff-removed">-</div><div class="diff-removed">-                        // Note: we don't do ASCII (u8) because there are a lot</div><div class="diff-removed">-                        // of invisible characters we don't want to handle right</div><div class="diff-removed">-                        // now.</div><div class="diff-removed">-</div><div class="diff-removed">-                        // All others do the default behavior</div><div class="diff-removed">-                        else => try std.fmt.formatType(</div><div class="diff-removed">-                            @field(self, u_field.name),</div><div class="diff-removed">-                            "any",</div><div class="diff-removed">-                            opts,</div><div class="diff-removed">-                            writer,</div><div class="diff-removed">-                            3,</div><div class="diff-removed">-                        ),</div><div class="diff-removed">-                    }</div><div class="diff-removed">-                }</div><div class="diff-removed">-            }</div><div class="diff-removed">-</div><div class="diff-removed">-            try writer.writeAll(" }");</div><div class="diff-removed">-        } else {</div><div class="diff-removed">-            try format(writer, "@{x}", .{@intFromPtr(&self)});</div><div class="diff-removed">-        }</div><div class="diff-removed">-    }</div><div class="diff-removed">-};</div><div class="diff-removed">-</div><div class="diff-removed">-/// Maximum number of intermediate characters during parsing. This is</div><div class="diff-removed">-/// 4 because we also use the intermediates array for UTF8 decoding which</div><div class="diff-removed">-/// can be at most 4 bytes.</div><div class="diff-removed">-const MAX_INTERMEDIATE = 4;</div><div class="diff-removed">-</div><div class="diff-removed">-/// Maximum number of CSI parameters. This is arbitrary. Practically, the</div><div class="diff-removed">-/// only CSI command that uses more than 3 parameters is the SGR command</div><div class="diff-removed">-/// which can be infinitely long. 24 is a reasonable limit based on empirical</div><div class="diff-removed">-/// data. This used to be 16 but Kakoune has a SGR command that uses 17</div><div class="diff-removed">-/// parameters.</div><div class="diff-removed">-///</div><div class="diff-removed">-/// We could in the future make this the static limit and then allocate after</div><div class="diff-removed">-/// but that's a lot more work and practically its so rare to exceed this</div><div class="diff-removed">-/// number. I implore TUI authors to not use more than this number of CSI</div><div class="diff-removed">-/// params, but I suspect we'll introduce a slow path with heap allocation</div><div class="diff-removed">-/// one day.</div><div class="diff-removed">-const MAX_PARAMS = 24;</div><div class="diff-removed">-</div><div class="diff-removed">-/// Current state of the state machine</div><div class="diff-removed">-state: State = .ground,</div><div class="diff-removed">-</div><div class="diff-removed">-/// Intermediate tracking.</div><div class="diff-removed">-intermediates: [MAX_INTERMEDIATE]u8 = undefined,</div><div class="diff-removed">-intermediates_idx: u8 = 0,</div><div class="diff-removed">-</div><div class="diff-removed">-/// Param tracking, building</div><div class="diff-removed">-params: [MAX_PARAMS]u16 = undefined,</div><div class="diff-removed">-params_sep: Action.CSI.SepList = Action.CSI.SepList.initEmpty(),</div><div class="diff-removed">-params_idx: u8 = 0,</div><div class="diff-removed">-param_acc: u16 = 0,</div><div class="diff-removed">-param_acc_idx: u8 = 0,</div><div class="diff-removed">-</div><div class="diff-removed">-/// Parser for OSC sequences</div><div class="diff-removed">-osc_parser: osc.Parser = .{},</div><div class="diff-removed">-</div><div class="diff-removed">-pub fn init() Parser {</div><div class="diff-removed">-    return .{};</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-pub fn deinit(self: *Parser) void {</div><div class="diff-removed">-    self.osc_parser.deinit();</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-/// Next consumes the next character c and returns the actions to execute.</div><div class="diff-removed">-/// Up to 3 actions may need to be executed -- in order -- representing</div><div class="diff-removed">-/// the state exit, transition, and entry actions.</div><div class="diff-removed">-pub fn next(self: *Parser, c: u8) [3]?Action {</div><div class="diff-removed">-    const effect = table[c][@intFromEnum(self.state)];</div><div class="diff-removed">-</div><div class="diff-removed">-    // log.info("next: {x}", .{c});</div><div class="diff-removed">-</div><div class="diff-removed">-    const next_state = effect.state;</div><div class="diff-removed">-    const action = effect.action;</div><div class="diff-removed">-</div><div class="diff-removed">-    // After generating the actions, we set our next state.</div><div class="diff-removed">-    defer self.state = next_state;</div><div class="diff-removed">-</div><div class="diff-removed">-    // When going from one state to another, the actions take place in this order:</div><div class="diff-removed">-    //</div><div class="diff-removed">-    // 1. exit action from old state</div><div class="diff-removed">-    // 2. transition action</div><div class="diff-removed">-    // 3. entry action to new state</div><div class="diff-removed">-    return [3]?Action{</div><div class="diff-removed">-        // Exit depends on current state</div><div class="diff-removed">-        if (self.state == next_state) null else switch (self.state) {</div><div class="diff-removed">-            .osc_string => if (self.osc_parser.end(c)) |cmd|</div><div class="diff-removed">-                Action{ .osc_dispatch = cmd }</div><div class="diff-removed">-            else</div><div class="diff-removed">-                null,</div><div class="diff-removed">-            .dcs_passthrough => Action{ .dcs_unhook = {} },</div><div class="diff-removed">-            .sos_pm_apc_string => Action{ .apc_end = {} },</div><div class="diff-removed">-            else => null,</div><div class="diff-removed">-        },</div><div class="diff-removed">-</div><div class="diff-removed">-        self.doAction(action, c),</div><div class="diff-removed">-</div><div class="diff-removed">-        // Entry depends on new state</div><div class="diff-removed">-        if (self.state == next_state) null else switch (next_state) {</div><div class="diff-removed">-            .escape, .dcs_entry, .csi_entry => clear: {</div><div class="diff-removed">-                self.clear();</div><div class="diff-removed">-                break :clear null;</div><div class="diff-removed">-            },</div><div class="diff-removed">-            .osc_string => osc_string: {</div><div class="diff-removed">-                self.osc_parser.reset();</div><div class="diff-removed">-                break :osc_string null;</div><div class="diff-removed">-            },</div><div class="diff-removed">-            .dcs_passthrough => dcs_hook: {</div><div class="diff-removed">-                // Finalize parameters</div><div class="diff-removed">-                if (self.param_acc_idx > 0) {</div><div class="diff-removed">-                    self.params[self.params_idx] = self.param_acc;</div><div class="diff-removed">-                    self.params_idx += 1;</div><div class="diff-removed">-                }</div><div class="diff-removed">-                break :dcs_hook .{</div><div class="diff-removed">-                    .dcs_hook = .{</div><div class="diff-removed">-                        .intermediates = self.intermediates[0..self.intermediates_idx],</div><div class="diff-removed">-                        .params = self.params[0..self.params_idx],</div><div class="diff-removed">-                        .final = c,</div><div class="diff-removed">-                    },</div><div class="diff-removed">-                };</div><div class="diff-removed">-            },</div><div class="diff-removed">-            .sos_pm_apc_string => Action{ .apc_start = {} },</div><div class="diff-removed">-            else => null,</div><div class="diff-removed">-        },</div><div class="diff-removed">-    };</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-pub fn collect(self: *Parser, c: u8) void {</div><div class="diff-removed">-    if (self.intermediates_idx >= MAX_INTERMEDIATE) {</div><div class="diff-removed">-        log.warn("invalid intermediates count", .{});</div><div class="diff-removed">-        return;</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    self.intermediates[self.intermediates_idx] = c;</div><div class="diff-removed">-    self.intermediates_idx += 1;</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-fn doAction(self: *Parser, action: TransitionAction, c: u8) ?Action {</div><div class="diff-removed">-    return switch (action) {</div><div class="diff-removed">-        .none, .ignore => null,</div><div class="diff-removed">-        .print => Action{ .print = c },</div><div class="diff-removed">-        .execute => Action{ .execute = c },</div><div class="diff-removed">-        .collect => collect: {</div><div class="diff-removed">-            self.collect(c);</div><div class="diff-removed">-            break :collect null;</div><div class="diff-removed">-        },</div><div class="diff-removed">-        .param => param: {</div><div class="diff-removed">-            // Semicolon separates parameters. If we encounter a semicolon</div><div class="diff-removed">-            // we need to store and move on to the next parameter.</div><div class="diff-removed">-            if (c == ';' or c == ':') {</div><div class="diff-removed">-                // Ignore too many parameters</div><div class="diff-removed">-                if (self.params_idx >= MAX_PARAMS) break :param null;</div><div class="diff-removed">-</div><div class="diff-removed">-                // Set param final value</div><div class="diff-removed">-                self.params[self.params_idx] = self.param_acc;</div><div class="diff-removed">-                if (c == ':') self.params_sep.set(self.params_idx);</div><div class="diff-removed">-                self.params_idx += 1;</div><div class="diff-removed">-</div><div class="diff-removed">-                // Reset current param value to 0</div><div class="diff-removed">-                self.param_acc = 0;</div><div class="diff-removed">-                self.param_acc_idx = 0;</div><div class="diff-removed">-                break :param null;</div><div class="diff-removed">-            }</div><div class="diff-removed">-</div><div class="diff-removed">-            // A numeric value. Add it to our accumulator.</div><div class="diff-removed">-            if (self.param_acc_idx > 0) {</div><div class="diff-removed">-                self.param_acc *|= 10;</div><div class="diff-removed">-            }</div><div class="diff-removed">-            self.param_acc +|= c - '0';</div><div class="diff-removed">-</div><div class="diff-removed">-            // Increment our accumulator index. If we overflow then</div><div class="diff-removed">-            // we're out of bounds and we exit immediately.</div><div class="diff-removed">-            self.param_acc_idx, const overflow = @addWithOverflow(self.param_acc_idx, 1);</div><div class="diff-removed">-            if (overflow > 0) break :param null;</div><div class="diff-removed">-</div><div class="diff-removed">-            // The client is expected to perform no action.</div><div class="diff-removed">-            break :param null;</div><div class="diff-removed">-        },</div><div class="diff-removed">-        .osc_put => osc_put: {</div><div class="diff-removed">-            self.osc_parser.next(c);</div><div class="diff-removed">-            break :osc_put null;</div><div class="diff-removed">-        },</div><div class="diff-removed">-        .csi_dispatch => csi_dispatch: {</div><div class="diff-removed">-            // Ignore too many parameters</div><div class="diff-removed">-            if (self.params_idx >= MAX_PARAMS) break :csi_dispatch null;</div><div class="diff-removed">-</div><div class="diff-removed">-            // Finalize parameters if we have one</div><div class="diff-removed">-            if (self.param_acc_idx > 0) {</div><div class="diff-removed">-                self.params[self.params_idx] = self.param_acc;</div><div class="diff-removed">-                self.params_idx += 1;</div><div class="diff-removed">-            }</div><div class="diff-removed">-</div><div class="diff-removed">-            const result: Action = .{</div><div class="diff-removed">-                .csi_dispatch = .{</div><div class="diff-removed">-                    .intermediates = self.intermediates[0..self.intermediates_idx],</div><div class="diff-removed">-                    .params = self.params[0..self.params_idx],</div><div class="diff-removed">-                    .params_sep = self.params_sep,</div><div class="diff-removed">-                    .final = c,</div><div class="diff-removed">-                },</div><div class="diff-removed">-            };</div><div class="diff-removed">-</div><div class="diff-removed">-            // We only allow colon or mixed separators for the 'm' command.</div><div class="diff-removed">-            if (c != 'm' and self.params_sep.count() > 0) {</div><div class="diff-removed">-                log.warn(</div><div class="diff-removed">-                    "CSI colon or mixed separators only allowed for 'm' command, got: {}",</div><div class="diff-removed">-                    .{result},</div><div class="diff-removed">-                );</div><div class="diff-removed">-                break :csi_dispatch null;</div><div class="diff-removed">-            }</div><div class="diff-removed">-</div><div class="diff-removed">-            break :csi_dispatch result;</div><div class="diff-removed">-        },</div><div class="diff-removed">-        .esc_dispatch => Action{</div><div class="diff-removed">-            .esc_dispatch = .{</div><div class="diff-removed">-                .intermediates = self.intermediates[0..self.intermediates_idx],</div><div class="diff-removed">-                .final = c,</div><div class="diff-removed">-            },</div><div class="diff-removed">-        },</div><div class="diff-removed">-        .put => Action{ .dcs_put = c },</div><div class="diff-removed">-        .apc_put => Action{ .apc_put = c },</div><div class="diff-removed">-    };</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-pub fn clear(self: *Parser) void {</div><div class="diff-removed">-    self.intermediates_idx = 0;</div><div class="diff-removed">-    self.params_idx = 0;</div><div class="diff-removed">-    self.params_sep = Action.CSI.SepList.initEmpty();</div><div class="diff-removed">-    self.param_acc = 0;</div><div class="diff-removed">-    self.param_acc_idx = 0;</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-test {</div><div class="diff-removed">-    var p = init();</div><div class="diff-removed">-    _ = p.next(0x9E);</div><div class="diff-removed">-    try testing.expect(p.state == .sos_pm_apc_string);</div><div class="diff-removed">-    _ = p.next(0x9C);</div><div class="diff-removed">-    try testing.expect(p.state == .ground);</div><div class="diff-removed">-</div><div class="diff-removed">-    {</div><div class="diff-removed">-        const a = p.next('a');</div><div class="diff-removed">-        try testing.expect(p.state == .ground);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1].? == .print);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    {</div><div class="diff-removed">-        const a = p.next(0x19);</div><div class="diff-removed">-        try testing.expect(p.state == .ground);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1].? == .execute);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-test "esc: ESC ( B" {</div><div class="diff-removed">-    var p = init();</div><div class="diff-removed">-    _ = p.next(0x1B);</div><div class="diff-removed">-    _ = p.next('(');</div><div class="diff-removed">-</div><div class="diff-removed">-    {</div><div class="diff-removed">-        const a = p.next('B');</div><div class="diff-removed">-        try testing.expect(p.state == .ground);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1].? == .esc_dispatch);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-</div><div class="diff-removed">-        const d = a[1].?.esc_dispatch;</div><div class="diff-removed">-        try testing.expect(d.final == 'B');</div><div class="diff-removed">-        try testing.expect(d.intermediates.len == 1);</div><div class="diff-removed">-        try testing.expect(d.intermediates[0] == '(');</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-test "csi: ESC [ H" {</div><div class="diff-removed">-    var p = init();</div><div class="diff-removed">-    _ = p.next(0x1B);</div><div class="diff-removed">-    _ = p.next(0x5B);</div><div class="diff-removed">-</div><div class="diff-removed">-    {</div><div class="diff-removed">-        const a = p.next(0x48);</div><div class="diff-removed">-        try testing.expect(p.state == .ground);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1].? == .csi_dispatch);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-</div><div class="diff-removed">-        const d = a[1].?.csi_dispatch;</div><div class="diff-removed">-        try testing.expect(d.final == 0x48);</div><div class="diff-removed">-        try testing.expect(d.params.len == 0);</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-test "csi: ESC [ 1 ; 4 H" {</div><div class="diff-removed">-    var p = init();</div><div class="diff-removed">-    _ = p.next(0x1B);</div><div class="diff-removed">-    _ = p.next(0x5B);</div><div class="diff-removed">-    _ = p.next(0x31); // 1</div><div class="diff-removed">-    _ = p.next(0x3B); // ;</div><div class="diff-removed">-    _ = p.next(0x34); // 4</div><div class="diff-removed">-</div><div class="diff-removed">-    {</div><div class="diff-removed">-        const a = p.next(0x48); // H</div><div class="diff-removed">-        try testing.expect(p.state == .ground);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1].? == .csi_dispatch);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-</div><div class="diff-removed">-        const d = a[1].?.csi_dispatch;</div><div class="diff-removed">-        try testing.expect(d.final == 'H');</div><div class="diff-removed">-        try testing.expect(d.params.len == 2);</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 1), d.params[0]);</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 4), d.params[1]);</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-test "csi: SGR ESC [ 38 : 2 m" {</div><div class="diff-removed">-    var p = init();</div><div class="diff-removed">-    _ = p.next(0x1B);</div><div class="diff-removed">-    _ = p.next('[');</div><div class="diff-removed">-    _ = p.next('3');</div><div class="diff-removed">-    _ = p.next('8');</div><div class="diff-removed">-    _ = p.next(':');</div><div class="diff-removed">-    _ = p.next('2');</div><div class="diff-removed">-</div><div class="diff-removed">-    {</div><div class="diff-removed">-        const a = p.next('m');</div><div class="diff-removed">-        try testing.expect(p.state == .ground);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1].? == .csi_dispatch);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-</div><div class="diff-removed">-        const d = a[1].?.csi_dispatch;</div><div class="diff-removed">-        try testing.expect(d.final == 'm');</div><div class="diff-removed">-        try testing.expect(d.params.len == 2);</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 38), d.params[0]);</div><div class="diff-removed">-        try testing.expect(d.params_sep.isSet(0));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 2), d.params[1]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(1));</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-test "csi: SGR colon followed by semicolon" {</div><div class="diff-removed">-    var p = init();</div><div class="diff-removed">-    _ = p.next(0x1B);</div><div class="diff-removed">-    for ("[48:2") |c| {</div><div class="diff-removed">-        const a = p.next(c);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1] == null);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    {</div><div class="diff-removed">-        const a = p.next('m');</div><div class="diff-removed">-        try testing.expect(p.state == .ground);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1].? == .csi_dispatch);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    _ = p.next(0x1B);</div><div class="diff-removed">-    _ = p.next('[');</div><div class="diff-removed">-    {</div><div class="diff-removed">-        const a = p.next('H');</div><div class="diff-removed">-        try testing.expect(p.state == .ground);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1].? == .csi_dispatch);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-test "csi: SGR mixed colon and semicolon" {</div><div class="diff-removed">-    var p = init();</div><div class="diff-removed">-    _ = p.next(0x1B);</div><div class="diff-removed">-    for ("[38:5:1;48:5:0") |c| {</div><div class="diff-removed">-        const a = p.next(c);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1] == null);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    {</div><div class="diff-removed">-        const a = p.next('m');</div><div class="diff-removed">-        try testing.expect(p.state == .ground);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1].? == .csi_dispatch);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-test "csi: SGR ESC [ 48 : 2 m" {</div><div class="diff-removed">-    var p = init();</div><div class="diff-removed">-    _ = p.next(0x1B);</div><div class="diff-removed">-    for ("[48:2:240:143:104") |c| {</div><div class="diff-removed">-        const a = p.next(c);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1] == null);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    {</div><div class="diff-removed">-        const a = p.next('m');</div><div class="diff-removed">-        try testing.expect(p.state == .ground);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1].? == .csi_dispatch);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-</div><div class="diff-removed">-        const d = a[1].?.csi_dispatch;</div><div class="diff-removed">-        try testing.expect(d.final == 'm');</div><div class="diff-removed">-        try testing.expect(d.params.len == 5);</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 48), d.params[0]);</div><div class="diff-removed">-        try testing.expect(d.params_sep.isSet(0));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 2), d.params[1]);</div><div class="diff-removed">-        try testing.expect(d.params_sep.isSet(1));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 240), d.params[2]);</div><div class="diff-removed">-        try testing.expect(d.params_sep.isSet(2));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 143), d.params[3]);</div><div class="diff-removed">-        try testing.expect(d.params_sep.isSet(3));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 104), d.params[4]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(4));</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-test "csi: SGR ESC [4:3m colon" {</div><div class="diff-removed">-    var p = init();</div><div class="diff-removed">-    _ = p.next(0x1B);</div><div class="diff-removed">-    _ = p.next('[');</div><div class="diff-removed">-    _ = p.next('4');</div><div class="diff-removed">-    _ = p.next(':');</div><div class="diff-removed">-    _ = p.next('3');</div><div class="diff-removed">-</div><div class="diff-removed">-    {</div><div class="diff-removed">-        const a = p.next('m');</div><div class="diff-removed">-        try testing.expect(p.state == .ground);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1].? == .csi_dispatch);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-</div><div class="diff-removed">-        const d = a[1].?.csi_dispatch;</div><div class="diff-removed">-        try testing.expect(d.final == 'm');</div><div class="diff-removed">-        try testing.expect(d.params.len == 2);</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 4), d.params[0]);</div><div class="diff-removed">-        try testing.expect(d.params_sep.isSet(0));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 3), d.params[1]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(1));</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-test "csi: SGR with many blank and colon" {</div><div class="diff-removed">-    var p = init();</div><div class="diff-removed">-    _ = p.next(0x1B);</div><div class="diff-removed">-    for ("[58:2::240:143:104") |c| {</div><div class="diff-removed">-        const a = p.next(c);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1] == null);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    {</div><div class="diff-removed">-        const a = p.next('m');</div><div class="diff-removed">-        try testing.expect(p.state == .ground);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1].? == .csi_dispatch);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-</div><div class="diff-removed">-        const d = a[1].?.csi_dispatch;</div><div class="diff-removed">-        try testing.expect(d.final == 'm');</div><div class="diff-removed">-        try testing.expect(d.params.len == 6);</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 58), d.params[0]);</div><div class="diff-removed">-        try testing.expect(d.params_sep.isSet(0));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 2), d.params[1]);</div><div class="diff-removed">-        try testing.expect(d.params_sep.isSet(1));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 0), d.params[2]);</div><div class="diff-removed">-        try testing.expect(d.params_sep.isSet(2));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 240), d.params[3]);</div><div class="diff-removed">-        try testing.expect(d.params_sep.isSet(3));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 143), d.params[4]);</div><div class="diff-removed">-        try testing.expect(d.params_sep.isSet(4));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 104), d.params[5]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(5));</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-// This is from a Kakoune actual SGR sequence.</div><div class="diff-removed">-test "csi: SGR mixed colon and semicolon with blank" {</div><div class="diff-removed">-    var p = init();</div><div class="diff-removed">-    _ = p.next(0x1B);</div><div class="diff-removed">-    for ("[;4:3;38;2;175;175;215;58:2::190:80:70") |c| {</div><div class="diff-removed">-        const a = p.next(c);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1] == null);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    {</div><div class="diff-removed">-        const a = p.next('m');</div><div class="diff-removed">-        try testing.expect(p.state == .ground);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1].? == .csi_dispatch);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-</div><div class="diff-removed">-        const d = a[1].?.csi_dispatch;</div><div class="diff-removed">-        try testing.expect(d.final == 'm');</div><div class="diff-removed">-        try testing.expectEqual(14, d.params.len);</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 0), d.params[0]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(0));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 4), d.params[1]);</div><div class="diff-removed">-        try testing.expect(d.params_sep.isSet(1));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 3), d.params[2]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(2));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 38), d.params[3]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(3));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 2), d.params[4]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(4));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 175), d.params[5]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(5));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 175), d.params[6]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(6));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 215), d.params[7]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(7));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 58), d.params[8]);</div><div class="diff-removed">-        try testing.expect(d.params_sep.isSet(8));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 2), d.params[9]);</div><div class="diff-removed">-        try testing.expect(d.params_sep.isSet(9));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 0), d.params[10]);</div><div class="diff-removed">-        try testing.expect(d.params_sep.isSet(10));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 190), d.params[11]);</div><div class="diff-removed">-        try testing.expect(d.params_sep.isSet(11));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 80), d.params[12]);</div><div class="diff-removed">-        try testing.expect(d.params_sep.isSet(12));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 70), d.params[13]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(13));</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-// This is from a Kakoune actual SGR sequence also.</div><div class="diff-removed">-test "csi: SGR mixed colon and semicolon setting underline, bg, fg" {</div><div class="diff-removed">-    var p = init();</div><div class="diff-removed">-    _ = p.next(0x1B);</div><div class="diff-removed">-    for ("[4:3;38;2;51;51;51;48;2;170;170;170;58;2;255;97;136") |c| {</div><div class="diff-removed">-        const a = p.next(c);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1] == null);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    {</div><div class="diff-removed">-        const a = p.next('m');</div><div class="diff-removed">-        try testing.expect(p.state == .ground);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1].? == .csi_dispatch);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-</div><div class="diff-removed">-        const d = a[1].?.csi_dispatch;</div><div class="diff-removed">-        try testing.expect(d.final == 'm');</div><div class="diff-removed">-        try testing.expectEqual(17, d.params.len);</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 4), d.params[0]);</div><div class="diff-removed">-        try testing.expect(d.params_sep.isSet(0));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 3), d.params[1]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(1));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 38), d.params[2]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(2));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 2), d.params[3]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(3));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 51), d.params[4]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(4));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 51), d.params[5]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(5));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 51), d.params[6]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(6));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 48), d.params[7]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(7));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 2), d.params[8]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(8));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 170), d.params[9]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(9));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 170), d.params[10]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(10));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 170), d.params[11]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(11));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 58), d.params[12]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(12));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 2), d.params[13]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(13));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 255), d.params[14]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(14));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 97), d.params[15]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(15));</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 136), d.params[16]);</div><div class="diff-removed">-        try testing.expect(!d.params_sep.isSet(16));</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-test "csi: colon for non-m final" {</div><div class="diff-removed">-    var p = init();</div><div class="diff-removed">-    _ = p.next(0x1B);</div><div class="diff-removed">-    for ("[38:2h") |c| {</div><div class="diff-removed">-        const a = p.next(c);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1] == null);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    try testing.expect(p.state == .ground);</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-test "csi: request mode decrqm" {</div><div class="diff-removed">-    var p = init();</div><div class="diff-removed">-    _ = p.next(0x1B);</div><div class="diff-removed">-    for ("[?2026$") |c| {</div><div class="diff-removed">-        const a = p.next(c);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1] == null);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    {</div><div class="diff-removed">-        const a = p.next('p');</div><div class="diff-removed">-        try testing.expect(p.state == .ground);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1].? == .csi_dispatch);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-</div><div class="diff-removed">-        const d = a[1].?.csi_dispatch;</div><div class="diff-removed">-        try testing.expect(d.final == 'p');</div><div class="diff-removed">-        try testing.expectEqual(@as(usize, 2), d.intermediates.len);</div><div class="diff-removed">-        try testing.expectEqual(@as(usize, 1), d.params.len);</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, '?'), d.intermediates[0]);</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, '$'), d.intermediates[1]);</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 2026), d.params[0]);</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-test "csi: change cursor" {</div><div class="diff-removed">-    var p = init();</div><div class="diff-removed">-    _ = p.next(0x1B);</div><div class="diff-removed">-    for ("[3 ") |c| {</div><div class="diff-removed">-        const a = p.next(c);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1] == null);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    {</div><div class="diff-removed">-        const a = p.next('q');</div><div class="diff-removed">-        try testing.expect(p.state == .ground);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1].? == .csi_dispatch);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-</div><div class="diff-removed">-        const d = a[1].?.csi_dispatch;</div><div class="diff-removed">-        try testing.expect(d.final == 'q');</div><div class="diff-removed">-        try testing.expectEqual(@as(usize, 1), d.intermediates.len);</div><div class="diff-removed">-        try testing.expectEqual(@as(usize, 1), d.params.len);</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, ' '), d.intermediates[0]);</div><div class="diff-removed">-        try testing.expectEqual(@as(u16, 3), d.params[0]);</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-test "osc: change window title" {</div><div class="diff-removed">-    var p = init();</div><div class="diff-removed">-    _ = p.next(0x1B);</div><div class="diff-removed">-    _ = p.next(']');</div><div class="diff-removed">-    _ = p.next('0');</div><div class="diff-removed">-    _ = p.next(';');</div><div class="diff-removed">-    _ = p.next('a');</div><div class="diff-removed">-    _ = p.next('b');</div><div class="diff-removed">-    _ = p.next('c');</div><div class="diff-removed">-</div><div class="diff-removed">-    {</div><div class="diff-removed">-        const a = p.next(0x07); // BEL</div><div class="diff-removed">-        try testing.expect(p.state == .ground);</div><div class="diff-removed">-        try testing.expect(a[0].? == .osc_dispatch);</div><div class="diff-removed">-        try testing.expect(a[1] == null);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-</div><div class="diff-removed">-        const cmd = a[0].?.osc_dispatch;</div><div class="diff-removed">-        try testing.expect(cmd == .change_window_title);</div><div class="diff-removed">-        try testing.expectEqualStrings("abc", cmd.change_window_title);</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-test "osc: change window title (end in esc)" {</div><div class="diff-removed">-    var p = init();</div><div class="diff-removed">-    _ = p.next(0x1B);</div><div class="diff-removed">-    _ = p.next(']');</div><div class="diff-removed">-    _ = p.next('0');</div><div class="diff-removed">-    _ = p.next(';');</div><div class="diff-removed">-    _ = p.next('a');</div><div class="diff-removed">-    _ = p.next('b');</div><div class="diff-removed">-    _ = p.next('c');</div><div class="diff-removed">-</div><div class="diff-removed">-    {</div><div class="diff-removed">-        const a = p.next(0x1B);</div><div class="diff-removed">-        _ = p.next('\\');</div><div class="diff-removed">-        try testing.expect(p.state == .ground);</div><div class="diff-removed">-        try testing.expect(a[0].? == .osc_dispatch);</div><div class="diff-removed">-        try testing.expect(a[1] == null);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-</div><div class="diff-removed">-        const cmd = a[0].?.osc_dispatch;</div><div class="diff-removed">-        try testing.expect(cmd == .change_window_title);</div><div class="diff-removed">-        try testing.expectEqualStrings("abc", cmd.change_window_title);</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-// https://github.com/darrenstarr/VtNetCore/pull/14</div><div class="diff-removed">-// Saw this on HN, decided to add a test case because why not.</div><div class="diff-removed">-test "osc: 112 incomplete sequence" {</div><div class="diff-removed">-    var p = init();</div><div class="diff-removed">-    _ = p.next(0x1B);</div><div class="diff-removed">-    _ = p.next(']');</div><div class="diff-removed">-    _ = p.next('1');</div><div class="diff-removed">-    _ = p.next('1');</div><div class="diff-removed">-    _ = p.next('2');</div><div class="diff-removed">-</div><div class="diff-removed">-    {</div><div class="diff-removed">-        const a = p.next(0x07);</div><div class="diff-removed">-        try testing.expect(p.state == .ground);</div><div class="diff-removed">-        try testing.expect(a[0].? == .osc_dispatch);</div><div class="diff-removed">-        try testing.expect(a[1] == null);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-</div><div class="diff-removed">-        const cmd = a[0].?.osc_dispatch;</div><div class="diff-removed">-        try testing.expect(cmd == .reset_color);</div><div class="diff-removed">-        try testing.expectEqual(cmd.reset_color.kind, .cursor);</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-test "csi: too many params" {</div><div class="diff-removed">-    var p = init();</div><div class="diff-removed">-    _ = p.next(0x1B);</div><div class="diff-removed">-    _ = p.next('[');</div><div class="diff-removed">-    for (0..100) |_| {</div><div class="diff-removed">-        _ = p.next('1');</div><div class="diff-removed">-        _ = p.next(';');</div><div class="diff-removed">-    }</div><div class="diff-removed">-    _ = p.next('1');</div><div class="diff-removed">-</div><div class="diff-removed">-    {</div><div class="diff-removed">-        const a = p.next('C');</div><div class="diff-removed">-        try testing.expect(p.state == .ground);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1] == null);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-test "dcs: XTGETTCAP" {</div><div class="diff-removed">-    var p = init();</div><div class="diff-removed">-    _ = p.next(0x1B);</div><div class="diff-removed">-    for ("P+") |c| {</div><div class="diff-removed">-        const a = p.next(c);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1] == null);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    {</div><div class="diff-removed">-        const a = p.next('q');</div><div class="diff-removed">-        try testing.expect(p.state == .dcs_passthrough);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1] == null);</div><div class="diff-removed">-        try testing.expect(a[2].? == .dcs_hook);</div><div class="diff-removed">-</div><div class="diff-removed">-        const hook = a[2].?.dcs_hook;</div><div class="diff-removed">-        try testing.expectEqualSlices(u8, &[_]u8{'+'}, hook.intermediates);</div><div class="diff-removed">-        try testing.expectEqualSlices(u16, &[_]u16{}, hook.params);</div><div class="diff-removed">-        try testing.expectEqual('q', hook.final);</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-test "dcs: params" {</div><div class="diff-removed">-    var p = init();</div><div class="diff-removed">-    _ = p.next(0x1B);</div><div class="diff-removed">-    for ("P1000") |c| {</div><div class="diff-removed">-        const a = p.next(c);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1] == null);</div><div class="diff-removed">-        try testing.expect(a[2] == null);</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    {</div><div class="diff-removed">-        const a = p.next('p');</div><div class="diff-removed">-        try testing.expect(p.state == .dcs_passthrough);</div><div class="diff-removed">-        try testing.expect(a[0] == null);</div><div class="diff-removed">-        try testing.expect(a[1] == null);</div><div class="diff-removed">-        try testing.expect(a[2].? == .dcs_hook);</div><div class="diff-removed">-</div><div class="diff-removed">-        const hook = a[2].?.dcs_hook;</div><div class="diff-removed">-        try testing.expectEqualSlices(u16, &[_]u16{1000}, hook.params);</div><div class="diff-removed">-        try testing.expectEqual('p', hook.final);</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div>\ No newline at end of file</div><div class="diff-added">+The parser evolved to handle more complex terminal sequences and edge cases over time, while maintaining backwards compatibility with existing terminal protocols. The changes reflect an ongoing effort to improve compatibility with various terminal emulators and applications.</div><div>\ No newline at end of file</div><div></div></pre>
                </div>
            </div>
        </section>
    </main>
    <footer>
        <p>LoCoDiff-bench - <a href="https://github.com/AbanteAI/LoCoDiff-bench">GitHub Repository</a></p>
    </footer>
</body>
</html>
    