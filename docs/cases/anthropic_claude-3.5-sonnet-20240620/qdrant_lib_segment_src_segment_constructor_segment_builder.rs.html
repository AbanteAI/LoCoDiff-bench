<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case: lib/segment/src/segment_constructor/segment_builder.rs - Sonnet 3.5</title>
    <link rel="stylesheet" href="../../styles.css">
</head>
<body>
    <header>
        <h1>Case: lib/segment/src/segment_constructor/segment_builder.rs</h1>
        <h2>Model: Sonnet 3.5</h2>
        <p><a href="../../models/anthropic_claude-3.5-sonnet-20240620.html">All Sonnet 3.5 Cases</a> | <a href="../../cases.html">All Cases</a> | <a href="../../index.html">Home</a></p>
    </header>
    <main>
        <section class="case-details">
            <div class="case-info">
                <h2>Benchmark Case Information</h2>
                <p><strong>Model:</strong> Sonnet 3.5</p>
                <p><strong>Status:</strong> <span class="failure">Failure</span></p>
                <p><strong>Prompt Tokens:</strong> 67813</p>
                <p><strong>Native Prompt Tokens:</strong> 93291</p>
                <p><strong>Native Completion Tokens:</strong> 7943</p>
                <p><strong>Native Tokens Reasoning:</strong> 0</p>
                <p><strong>Native Finish Reason:</strong> stop</p>
                <p><strong>Cost:</strong> $0.399018</p>
            </div>
            
            <div class="content-links">
                <h2>View Content</h2>
                <ul>
                    <li><a href="../../content/anthropic_claude-3.5-sonnet-20240620/qdrant_lib_segment_src_segment_constructor_segment_builder.rs/prompt.html" class="content-link">View Prompt</a></li>
                    <li><a href="../../content/anthropic_claude-3.5-sonnet-20240620/qdrant_lib_segment_src_segment_constructor_segment_builder.rs/expected.html" class="content-link">View Expected Output</a></li>
                    <li><a href="../../content/anthropic_claude-3.5-sonnet-20240620/qdrant_lib_segment_src_segment_constructor_segment_builder.rs/actual.html" class="content-link">View Actual Output</a></li>
                </ul>
            </div>
            
            <div class="diff-section">
                <h2>Diff (Expected vs Actual)</h2>
                <div id="diff-output">
                    <pre class="diff"><div></div><div>index 70dd22b46..46f3ee96b 100644</div><div class="diff-header">--- a/qdrant_lib_segment_src_segment_constructor_segment_builder.rs_expectedoutput.txt (expected):tmp/tmpe7nsawn3_expected.txt	</div><div class="diff-header">+++ b/qdrant_lib_segment_src_segment_constructor_segment_builder.rs_extracted.txt (actual):tmp/tmprouohe_l_actual.txt	</div><div class="diff-info">@@ -478,23 +478,13 @@ impl SegmentBuilder {</div><div>                 IdTrackerEnum::ImmutableIdTracker(_) => {</div><div>                     unreachable!("ImmutableIdTracker should not be used for building segment")</div><div>                 }</div><div class="diff-removed">-                IdTrackerEnum::RocksDbIdTracker(_) => id_tracker,</div><div>             };</div><div> </div><div>             id_tracker.mapping_flusher()()?;</div><div>             id_tracker.versions_flusher()()?;</div><div>             let id_tracker_arc = Arc::new(AtomicRefCell::new(id_tracker));</div><div> </div><div class="diff-removed">-            let mut quantized_vectors = Self::update_quantization(</div><div class="diff-removed">-                &segment_config,</div><div class="diff-removed">-                &vector_data,</div><div class="diff-removed">-                temp_dir.path(),</div><div class="diff-removed">-                &permit,</div><div class="diff-removed">-                stopped,</div><div class="diff-removed">-            )?;</div><div class="diff-removed">-</div><div>             let mut vector_storages_arc = HashMap::new();</div><div class="diff-removed">-            let mut old_indices = HashMap::new();</div><div> </div><div>             for vector_name in segment_config.vector_data.keys() {</div><div>                 let Some(vector_info) = vector_data.remove(vector_name) else {</div><div class="diff-info">@@ -507,8 +497,6 @@ impl SegmentBuilder {</div><div> </div><div>                 let vector_storage_arc = Arc::new(AtomicRefCell::new(vector_info.vector_storage));</div><div> </div><div class="diff-removed">-                old_indices.insert(vector_name, vector_info.old_indices);</div><div class="diff-removed">-</div><div>                 vector_storages_arc.insert(vector_name.to_owned(), vector_storage_arc);</div><div>             }</div><div> </div><div class="diff-info">@@ -558,17 +546,32 @@ impl SegmentBuilder {</div><div>             // Arc permit to share it with each vector store</div><div>             let permit = Arc::new(permit);</div><div> </div><div class="diff-added">+            let mut quantized_vectors = Self::update_quantization(</div><div class="diff-added">+                &segment_config,</div><div class="diff-added">+                &vector_data,</div><div class="diff-added">+                temp_dir.path(),</div><div class="diff-added">+                &permit,</div><div class="diff-added">+                stopped,</div><div class="diff-added">+            )?;</div><div class="diff-added">+</div><div class="diff-added">+            let mut old_indices = HashMap::new();</div><div class="diff-added">+</div><div>             for (vector_name, vector_config) in &segment_config.vector_data {</div><div class="diff-removed">-                let vector_storage = vector_storages_arc.remove(vector_name).unwrap();</div><div class="diff-removed">-                let quantized_vectors =</div><div class="diff-removed">-                    Arc::new(AtomicRefCell::new(quantized_vectors.remove(vector_name)));</div><div class="diff-added">+                let vector_storage_arc = vector_storages_arc.remove(vector_name).unwrap();</div><div class="diff-added">+                let vector_storage = vector_data.remove(vector_name).unwrap();</div><div class="diff-added">+                let vector_index_path = get_vector_index_path(temp_dir.path(), vector_name);</div><div class="diff-added">+                let quantized_vectors = Arc::new(AtomicRefCell::new(</div><div class="diff-added">+                    quantized_vectors.remove(vector_name),</div><div class="diff-added">+                ));</div><div class="diff-added">+</div><div class="diff-added">+                old_indices.insert(vector_name, vector_storage.old_indices);</div><div> </div><div>                 let index = build_vector_index(</div><div>                     vector_config,</div><div>                     VectorIndexOpenArgs {</div><div class="diff-removed">-                        path: &get_vector_index_path(temp_dir.path(), vector_name),</div><div class="diff-added">+                        path: &vector_index_path,</div><div>                         id_tracker: id_tracker_arc.clone(),</div><div class="diff-removed">-                        vector_storage: vector_storage.clone(),</div><div class="diff-added">+                        vector_storage: vector_storage_arc.clone(),</div><div>                         payload_index: payload_index_arc.clone(),</div><div>                         quantized_vectors: quantized_vectors.clone(),</div><div>                     },</div><div class="diff-info">@@ -581,10 +584,10 @@ impl SegmentBuilder {</div><div>                     },</div><div>                 )?;</div><div> </div><div class="diff-removed">-                if vector_storage.borrow().is_on_disk() {</div><div class="diff-added">+                if vector_storage_arc.borrow().is_on_disk() {</div><div>                     // If vector storage is expected to be on-disk, we need to clear cache</div><div>                     // to avoid cache pollution</div><div class="diff-removed">-                    vector_storage.borrow().clear_cache()?;</div><div class="diff-added">+                    vector_storage_arc.borrow().clear_cache()?;</div><div>                 }</div><div> </div><div>                 if let Some(quantized_vectors) = quantized_vectors.borrow().as_ref() {</div><div></div></pre>
                </div>
            </div>
        </section>
    </main>
    <footer>
        <p>LoCoDiff-bench - <a href="https://github.com/AbanteAI/LoCoDiff-bench">GitHub Repository</a></p>
    </footer>
</body>
</html>
    