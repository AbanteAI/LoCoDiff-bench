<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case: lib/segment/src/index/field_index/map_index/mod.rs - Sonnet 3.5</title>
    <link rel="stylesheet" href="../../styles.css">
</head>
<body>
    <header>
        <h1>Case: lib/segment/src/index/field_index/map_index/mod.rs</h1>
        <h2>Model: Sonnet 3.5</h2>
        <p><a href="../../models/anthropic_claude-3.5-sonnet-20240620.html">All Sonnet 3.5 Cases</a> | <a href="../../cases.html">All Cases</a> | <a href="../../index.html">Home</a></p>
    </header>
    <main>
        <section class="case-details">
            <div class="case-info">
                <h2>Benchmark Case Information</h2>
                <p><strong>Model:</strong> Sonnet 3.5</p>
                <p><strong>Status:</strong> <span class="failure">Failure</span></p>
                <p><strong>Prompt Tokens:</strong> 56553</p>
                <p><strong>Native Prompt Tokens:</strong> 76866</p>
                <p><strong>Native Completion Tokens:</strong> 8192</p>
                <p><strong>Native Tokens Reasoning:</strong> 0</p>
                <p><strong>Native Finish Reason:</strong> length</p>
                <p><strong>Cost:</strong> $0.353478</p>
            </div>
            
            <div class="content-links">
                <h2>View Content</h2>
                <ul>
                    <li><a href="../../content/anthropic_claude-3.5-sonnet-20240620/qdrant_lib_segment_src_index_field_index_map_index_mod.rs/prompt.html" class="content-link">View Prompt</a></li>
                    <li><a href="../../content/anthropic_claude-3.5-sonnet-20240620/qdrant_lib_segment_src_index_field_index_map_index_mod.rs/expected.html" class="content-link">View Expected Output</a></li>
                    <li><a href="../../content/anthropic_claude-3.5-sonnet-20240620/qdrant_lib_segment_src_index_field_index_map_index_mod.rs/actual.html" class="content-link">View Actual Output</a></li>
                </ul>
            </div>
            
            <div class="diff-section">
                <h2>Diff (Expected vs Actual)</h2>
                <div id="diff-output">
                    <pre class="diff"><div></div><div>index 0a4e2d762..c85ec7065 100644</div><div class="diff-header">--- a/qdrant_lib_segment_src_index_field_index_map_index_mod.rs_expectedoutput.txt (expected):tmp/tmp7v1wbl8o_expected.txt	</div><div class="diff-header">+++ b/qdrant_lib_segment_src_index_field_index_map_index_mod.rs_extracted.txt (actual):tmp/tmpyr5aq4yf_actual.txt	</div><div class="diff-info">@@ -3,6 +3,7 @@ use std::collections::hash_map::Entry;</div><div> use std::fmt::{Debug, Display};</div><div> use std::hash::{BuildHasher, Hash};</div><div> use std::iter;</div><div class="diff-added">+use std::mem::size_of_val;</div><div> use std::path::{Path, PathBuf};</div><div> use std::str::FromStr;</div><div> use std::sync::Arc;</div><div class="diff-info">@@ -302,14 +303,6 @@ impl<N: MapIndexKey + ?Sized> MapIndex<N> {</div><div>         }</div><div>     }</div><div> </div><div class="diff-removed">-    fn files(&self) -> Vec<PathBuf> {</div><div class="diff-removed">-        match self {</div><div class="diff-removed">-            MapIndex::Mutable(_) => Vec::new(),</div><div class="diff-removed">-            MapIndex::Immutable(_) => Vec::new(),</div><div class="diff-removed">-            MapIndex::Mmap(index) => index.files(),</div><div class="diff-removed">-        }</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div>     /// Estimates cardinality for `except` clause</div><div>     ///</div><div>     /// # Arguments</div><div class="diff-info">@@ -700,7 +693,7 @@ impl PayloadFieldIndex for MapIndex<str> {</div><div>     ) -> Box<dyn Iterator<Item = PayloadBlockCondition> + '_> {</div><div>         Box::new(</div><div>             self.iter_values()</div><div class="diff-removed">-                .map(|value| {</div><div class="diff-added">+                .map(move |value| {</div><div>                     (</div><div>                         value,</div><div>                         self.get_count_for_value(value, &HardwareCounterCell::disposable()) // Payload_blocks only used in HNSW building, which is unmeasured.</div><div class="diff-info">@@ -756,643 +749,4 @@ impl PayloadFieldIndex for MapIndex<UuidIntType> {</div><div>             Some(Match::Any(MatchAny { any: any_variant })) => match any_variant {</div><div>                 AnyVariants::Strings(uuids_string) => {</div><div>                     let uuids: Result<IndexSet<u128>, _> = uuids_string</div><div class="diff-removed">-                        .iter()</div><div class="diff-removed">-                        .map(|uuid_string| Uuid::from_str(uuid_string).map(|x| x.as_u128()))</div><div class="diff-removed">-                        .collect();</div><div class="diff-removed">-</div><div class="diff-removed">-                    let uuids = uuids.ok()?;</div><div class="diff-removed">-</div><div class="diff-removed">-                    Some(Box::new(</div><div class="diff-removed">-                        uuids</div><div class="diff-removed">-                            .into_iter()</div><div class="diff-removed">-                            .flat_map(move |uuid| self.get_iterator(&uuid, hw_counter).copied())</div><div class="diff-removed">-                            .unique(),</div><div class="diff-removed">-                    ))</div><div class="diff-removed">-                }</div><div class="diff-removed">-                AnyVariants::Integers(integers) => {</div><div class="diff-removed">-                    if integers.is_empty() {</div><div class="diff-removed">-                        Some(Box::new(iter::empty()))</div><div class="diff-removed">-                    } else {</div><div class="diff-removed">-                        None</div><div class="diff-removed">-                    }</div><div class="diff-removed">-                }</div><div class="diff-removed">-            },</div><div class="diff-removed">-            Some(Match::Except(MatchExcept { except })) => match except {</div><div class="diff-removed">-                AnyVariants::Strings(uuids_string) => {</div><div class="diff-removed">-                    let uuids: Result<IndexSet<u128>, _> = uuids_string</div><div class="diff-removed">-                        .iter()</div><div class="diff-removed">-                        .map(|uuid_string| Uuid::from_str(uuid_string).map(|x| x.as_u128()))</div><div class="diff-removed">-                        .collect();</div><div class="diff-removed">-</div><div class="diff-removed">-                    let excluded_uuids = uuids.ok()?;</div><div class="diff-removed">-                    let exclude_iter = self</div><div class="diff-removed">-                        .iter_values()</div><div class="diff-removed">-                        .filter(move |key| !excluded_uuids.contains(*key))</div><div class="diff-removed">-                        .flat_map(move |key| self.get_iterator(key, hw_counter).copied())</div><div class="diff-removed">-                        .unique();</div><div class="diff-removed">-                    Some(Box::new(exclude_iter))</div><div class="diff-removed">-                }</div><div class="diff-removed">-                AnyVariants::Integers(other) => {</div><div class="diff-removed">-                    if other.is_empty() {</div><div class="diff-removed">-                        Some(Box::new(iter::empty()))</div><div class="diff-removed">-                    } else {</div><div class="diff-removed">-                        None</div><div class="diff-removed">-                    }</div><div class="diff-removed">-                }</div><div class="diff-removed">-            },</div><div class="diff-removed">-            _ => None,</div><div class="diff-removed">-        }</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    fn estimate_cardinality(</div><div class="diff-removed">-        &self,</div><div class="diff-removed">-        condition: &FieldCondition,</div><div class="diff-removed">-        hw_counter: &HardwareCounterCell,</div><div class="diff-removed">-    ) -> Option<CardinalityEstimation> {</div><div class="diff-removed">-        match &condition.r#match {</div><div class="diff-removed">-            Some(Match::Value(MatchValue { value })) => match value {</div><div class="diff-removed">-                ValueVariants::String(uuid_string) => {</div><div class="diff-removed">-                    let uuid = Uuid::from_str(uuid_string).ok()?;</div><div class="diff-removed">-                    let mut estimation = self.match_cardinality(&uuid.as_u128(), hw_counter);</div><div class="diff-removed">-                    estimation</div><div class="diff-removed">-                        .primary_clauses</div><div class="diff-removed">-                        .push(PrimaryCondition::Condition(Box::new(condition.clone())));</div><div class="diff-removed">-                    Some(estimation)</div><div class="diff-removed">-                }</div><div class="diff-removed">-                ValueVariants::Integer(_) => None,</div><div class="diff-removed">-                ValueVariants::Bool(_) => None,</div><div class="diff-removed">-            },</div><div class="diff-removed">-            Some(Match::Any(MatchAny { any: any_variant })) => match any_variant {</div><div class="diff-removed">-                AnyVariants::Strings(uuids_string) => {</div><div class="diff-removed">-                    let uuids: Result<IndexSet<u128>, _> = uuids_string</div><div class="diff-removed">-                        .iter()</div><div class="diff-removed">-                        .map(|uuid_string| Uuid::from_str(uuid_string).map(|x| x.as_u128()))</div><div class="diff-removed">-                        .collect();</div><div class="diff-removed">-</div><div class="diff-removed">-                    let uuids = uuids.ok()?;</div><div class="diff-removed">-</div><div class="diff-removed">-                    let estimations = uuids</div><div class="diff-removed">-                        .into_iter()</div><div class="diff-removed">-                        .map(|uuid| self.match_cardinality(&uuid, hw_counter))</div><div class="diff-removed">-                        .collect::<Vec<_>>();</div><div class="diff-removed">-                    let estimation = if estimations.is_empty() {</div><div class="diff-removed">-                        CardinalityEstimation::exact(0)</div><div class="diff-removed">-                    } else {</div><div class="diff-removed">-                        combine_should_estimations(&estimations, self.get_indexed_points())</div><div class="diff-removed">-                    };</div><div class="diff-removed">-                    Some(</div><div class="diff-removed">-                        estimation.with_primary_clause(PrimaryCondition::Condition(Box::new(</div><div class="diff-removed">-                            condition.clone(),</div><div class="diff-removed">-                        ))),</div><div class="diff-removed">-                    )</div><div class="diff-removed">-                }</div><div class="diff-removed">-                AnyVariants::Integers(integers) => {</div><div class="diff-removed">-                    if integers.is_empty() {</div><div class="diff-removed">-                        Some(CardinalityEstimation::exact(0).with_primary_clause(</div><div class="diff-removed">-                            PrimaryCondition::Condition(Box::new(condition.clone())),</div><div class="diff-removed">-                        ))</div><div class="diff-removed">-                    } else {</div><div class="diff-removed">-                        None</div><div class="diff-removed">-                    }</div><div class="diff-removed">-                }</div><div class="diff-removed">-            },</div><div class="diff-removed">-            Some(Match::Except(MatchExcept { except })) => match except {</div><div class="diff-removed">-                AnyVariants::Strings(uuids_string) => {</div><div class="diff-removed">-                    let uuids: Result<IndexSet<u128>, _> = uuids_string</div><div class="diff-removed">-                        .iter()</div><div class="diff-removed">-                        .map(|uuid_string| Uuid::from_str(uuid_string).map(|x| x.as_u128()))</div><div class="diff-removed">-                        .collect();</div><div class="diff-removed">-</div><div class="diff-removed">-                    let excluded_uuids = uuids.ok()?;</div><div class="diff-removed">-</div><div class="diff-removed">-                    Some(self.except_cardinality(excluded_uuids.iter(), hw_counter))</div><div class="diff-removed">-                }</div><div class="diff-removed">-                AnyVariants::Integers(other) => {</div><div class="diff-removed">-                    if other.is_empty() {</div><div class="diff-removed">-                        Some(CardinalityEstimation::exact(0).with_primary_clause(</div><div class="diff-removed">-                            PrimaryCondition::Condition(Box::new(condition.clone())),</div><div class="diff-removed">-                        ))</div><div class="diff-removed">-                    } else {</div><div class="diff-removed">-                        None</div><div class="diff-removed">-                    }</div><div class="diff-removed">-                }</div><div class="diff-removed">-            },</div><div class="diff-removed">-            _ => None,</div><div class="diff-removed">-        }</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    fn payload_blocks(</div><div class="diff-removed">-        &self,</div><div class="diff-removed">-        threshold: usize,</div><div class="diff-removed">-        key: PayloadKeyType,</div><div class="diff-removed">-    ) -> Box<dyn Iterator<Item = PayloadBlockCondition> + '_> {</div><div class="diff-removed">-        Box::new(</div><div class="diff-removed">-            self.iter_values()</div><div class="diff-removed">-                .map(move |value| {</div><div class="diff-removed">-                    (</div><div class="diff-removed">-                        value,</div><div class="diff-removed">-                        self.get_count_for_value(value, &HardwareCounterCell::disposable()) // payload_blocks only used in HNSW building, which is unmeasured.</div><div class="diff-removed">-                            .unwrap_or(0),</div><div class="diff-removed">-                    )</div><div class="diff-removed">-                })</div><div class="diff-removed">-                .filter(move |(_value, count)| *count >= threshold)</div><div class="diff-removed">-                .map(move |(value, count)| PayloadBlockCondition {</div><div class="diff-removed">-                    condition: FieldCondition::new_match(</div><div class="diff-removed">-                        key.clone(),</div><div class="diff-removed">-                        Uuid::from_u128(*value).to_string().into(),</div><div class="diff-removed">-                    ),</div><div class="diff-removed">-                    cardinality: count,</div><div class="diff-removed">-                }),</div><div class="diff-removed">-        )</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-impl PayloadFieldIndex for MapIndex<IntPayloadType> {</div><div class="diff-removed">-    fn count_indexed_points(&self) -> usize {</div><div class="diff-removed">-        self.get_indexed_points()</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    fn load(&mut self) -> OperationResult<bool> {</div><div class="diff-removed">-        self.load_from_db()</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    fn cleanup(self) -> OperationResult<()> {</div><div class="diff-removed">-        self.clear()</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    fn flusher(&self) -> Flusher {</div><div class="diff-removed">-        MapIndex::flusher(self)</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    fn files(&self) -> Vec<PathBuf> {</div><div class="diff-removed">-        self.files()</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    fn filter<'a>(</div><div class="diff-removed">-        &'a self,</div><div class="diff-removed">-        condition: &'a FieldCondition,</div><div class="diff-removed">-        hw_counter: &'a HardwareCounterCell,</div><div class="diff-removed">-    ) -> Option<Box<dyn Iterator<Item = PointOffsetType> + 'a>> {</div><div class="diff-removed">-        match &condition.r#match {</div><div class="diff-removed">-            Some(Match::Value(MatchValue { value })) => match value {</div><div class="diff-removed">-                ValueVariants::String(_) => None,</div><div class="diff-removed">-                ValueVariants::Integer(integer) => {</div><div class="diff-removed">-                    Some(Box::new(self.get_iterator(integer, hw_counter).copied()))</div><div class="diff-removed">-                }</div><div class="diff-removed">-                ValueVariants::Bool(_) => None,</div><div class="diff-removed">-            },</div><div class="diff-removed">-            Some(Match::Any(MatchAny { any: any_variant })) => match any_variant {</div><div class="diff-removed">-                AnyVariants::Strings(keywords) => {</div><div class="diff-removed">-                    if keywords.is_empty() {</div><div class="diff-removed">-                        Some(Box::new(vec![].into_iter()))</div><div class="diff-removed">-                    } else {</div><div class="diff-removed">-                        None</div><div class="diff-removed">-                    }</div><div class="diff-removed">-                }</div><div class="diff-removed">-                AnyVariants::Integers(integers) => Some(Box::new(</div><div class="diff-removed">-                    integers</div><div class="diff-removed">-                        .iter()</div><div class="diff-removed">-                        .flat_map(move |integer| self.get_iterator(integer, hw_counter).copied())</div><div class="diff-removed">-                        .unique(),</div><div class="diff-removed">-                )),</div><div class="diff-removed">-            },</div><div class="diff-removed">-            Some(Match::Except(MatchExcept { except })) => match except {</div><div class="diff-removed">-                AnyVariants::Strings(other) => {</div><div class="diff-removed">-                    if other.is_empty() {</div><div class="diff-removed">-                        Some(Box::new(iter::empty()))</div><div class="diff-removed">-                    } else {</div><div class="diff-removed">-                        None</div><div class="diff-removed">-                    }</div><div class="diff-removed">-                }</div><div class="diff-removed">-                AnyVariants::Integers(integers) => Some(self.except_set(integers, hw_counter)),</div><div class="diff-removed">-            },</div><div class="diff-removed">-            _ => None,</div><div class="diff-removed">-        }</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    fn estimate_cardinality(</div><div class="diff-removed">-        &self,</div><div class="diff-removed">-        condition: &FieldCondition,</div><div class="diff-removed">-        hw_counter: &HardwareCounterCell,</div><div class="diff-removed">-    ) -> Option<CardinalityEstimation> {</div><div class="diff-removed">-        match &condition.r#match {</div><div class="diff-removed">-            Some(Match::Value(MatchValue { value })) => match value {</div><div class="diff-removed">-                ValueVariants::String(_) => None,</div><div class="diff-removed">-                ValueVariants::Integer(integer) => {</div><div class="diff-removed">-                    let mut estimation = self.match_cardinality(integer, hw_counter);</div><div class="diff-removed">-                    estimation</div><div class="diff-removed">-                        .primary_clauses</div><div class="diff-removed">-                        .push(PrimaryCondition::Condition(Box::new(condition.clone())));</div><div class="diff-removed">-                    Some(estimation)</div><div class="diff-removed">-                }</div><div class="diff-removed">-                ValueVariants::Bool(_) => None,</div><div class="diff-removed">-            },</div><div class="diff-removed">-            Some(Match::Any(MatchAny { any: any_variants })) => match any_variants {</div><div class="diff-removed">-                AnyVariants::Strings(keywords) => {</div><div class="diff-removed">-                    if keywords.is_empty() {</div><div class="diff-removed">-                        Some(CardinalityEstimation::exact(0).with_primary_clause(</div><div class="diff-removed">-                            PrimaryCondition::Condition(Box::new(condition.clone())),</div><div class="diff-removed">-                        ))</div><div class="diff-removed">-                    } else {</div><div class="diff-removed">-                        None</div><div class="diff-removed">-                    }</div><div class="diff-removed">-                }</div><div class="diff-removed">-                AnyVariants::Integers(integers) => {</div><div class="diff-removed">-                    let estimations = integers</div><div class="diff-removed">-                        .iter()</div><div class="diff-removed">-                        .map(|integer| self.match_cardinality(integer, hw_counter))</div><div class="diff-removed">-                        .collect::<Vec<_>>();</div><div class="diff-removed">-                    let estimation = if estimations.is_empty() {</div><div class="diff-removed">-                        CardinalityEstimation::exact(0)</div><div class="diff-removed">-                    } else {</div><div class="diff-removed">-                        combine_should_estimations(&estimations, self.get_indexed_points())</div><div class="diff-removed">-                    };</div><div class="diff-removed">-                    Some(</div><div class="diff-removed">-                        estimation.with_primary_clause(PrimaryCondition::Condition(Box::new(</div><div class="diff-removed">-                            condition.clone(),</div><div class="diff-removed">-                        ))),</div><div class="diff-removed">-                    )</div><div class="diff-removed">-                }</div><div class="diff-removed">-            },</div><div class="diff-removed">-            Some(Match::Except(MatchExcept { except })) => match except {</div><div class="diff-removed">-                AnyVariants::Strings(others) => {</div><div class="diff-removed">-                    if others.is_empty() {</div><div class="diff-removed">-                        Some(CardinalityEstimation::exact(0).with_primary_clause(</div><div class="diff-removed">-                            PrimaryCondition::Condition(Box::new(condition.clone())),</div><div class="diff-removed">-                        ))</div><div class="diff-removed">-                    } else {</div><div class="diff-removed">-                        None</div><div class="diff-removed">-                    }</div><div class="diff-removed">-                }</div><div class="diff-removed">-                AnyVariants::Integers(integers) => {</div><div class="diff-removed">-                    Some(self.except_cardinality(integers.iter(), hw_counter))</div><div class="diff-removed">-                }</div><div class="diff-removed">-            },</div><div class="diff-removed">-            _ => None,</div><div class="diff-removed">-        }</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    fn payload_blocks(</div><div class="diff-removed">-        &self,</div><div class="diff-removed">-        threshold: usize,</div><div class="diff-removed">-        key: PayloadKeyType,</div><div class="diff-removed">-    ) -> Box<dyn Iterator<Item = PayloadBlockCondition> + '_> {</div><div class="diff-removed">-        Box::new(</div><div class="diff-removed">-            self.iter_values()</div><div class="diff-removed">-                .map(move |value| {</div><div class="diff-removed">-                    (</div><div class="diff-removed">-                        value,</div><div class="diff-removed">-                        self.get_count_for_value(value, &HardwareCounterCell::disposable()) // Only used in HNSW building so no measurement needed here.</div><div class="diff-removed">-                            .unwrap_or(0),</div><div class="diff-removed">-                    )</div><div class="diff-removed">-                })</div><div class="diff-removed">-                .filter(move |(_value, count)| *count >= threshold)</div><div class="diff-removed">-                .map(move |(value, count)| PayloadBlockCondition {</div><div class="diff-removed">-                    condition: FieldCondition::new_match(key.clone(), (*value).into()),</div><div class="diff-removed">-                    cardinality: count,</div><div class="diff-removed">-                }),</div><div class="diff-removed">-        )</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-impl<N> FacetIndex for MapIndex<N></div><div class="diff-removed">-where</div><div class="diff-removed">-    N: MapIndexKey + ?Sized,</div><div class="diff-removed">-    for<'a> N::Referenced<'a>: Into<FacetValueRef<'a>>,</div><div class="diff-removed">-    for<'a> &'a N: Into<FacetValueRef<'a>>,</div><div class="diff-removed">-{</div><div class="diff-removed">-    fn get_point_values(</div><div class="diff-removed">-        &self,</div><div class="diff-removed">-        point_id: PointOffsetType,</div><div class="diff-removed">-    ) -> impl Iterator<Item = FacetValueRef> + '_ {</div><div class="diff-removed">-        MapIndex::get_values(self, point_id)</div><div class="diff-removed">-            .into_iter()</div><div class="diff-removed">-            .flatten()</div><div class="diff-removed">-            .map(Into::into)</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    fn iter_values(&self) -> impl Iterator<Item = FacetValueRef<'_>> + '_ {</div><div class="diff-removed">-        self.iter_values().map(Into::into)</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    fn iter_values_map<'a>(</div><div class="diff-removed">-        &'a self,</div><div class="diff-removed">-        hw_counter: &'a HardwareCounterCell,</div><div class="diff-removed">-    ) -> impl Iterator<Item = (FacetValueRef<'a>, IdIter<'a>)> + 'a {</div><div class="diff-removed">-        self.iter_values_map(hw_counter)</div><div class="diff-removed">-            .map(|(k, iter)| (k.into(), iter))</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    fn iter_counts_per_value(&self) -> impl Iterator<Item = FacetHit<FacetValueRef<'_>>> + '_ {</div><div class="diff-removed">-        self.iter_counts_per_value().map(|(value, count)| FacetHit {</div><div class="diff-removed">-            value: value.into(),</div><div class="diff-removed">-            count,</div><div class="diff-removed">-        })</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-impl ValueIndexer for MapIndex<str> {</div><div class="diff-removed">-    type ValueType = String;</div><div class="diff-removed">-</div><div class="diff-removed">-    fn add_many(</div><div class="diff-removed">-        &mut self,</div><div class="diff-removed">-        id: PointOffsetType,</div><div class="diff-removed">-        values: Vec<String>,</div><div class="diff-removed">-        hw_counter: &HardwareCounterCell,</div><div class="diff-removed">-    ) -> OperationResult<()> {</div><div class="diff-removed">-        match self {</div><div class="diff-removed">-            MapIndex::Mutable(index) => index.add_many_to_map(id, values, hw_counter),</div><div class="diff-removed">-            MapIndex::Immutable(_) => Err(OperationError::service_error(</div><div class="diff-removed">-                "Can't add values to immutable map index",</div><div class="diff-removed">-            )),</div><div class="diff-removed">-            MapIndex::Mmap(_) => Err(OperationError::service_error(</div><div class="diff-removed">-                "Can't add values to mmap map index",</div><div class="diff-removed">-            )),</div><div class="diff-removed">-        }</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    fn get_value(value: &Value) -> Option<String> {</div><div class="diff-removed">-        if let Value::String(keyword) = value {</div><div class="diff-removed">-            return Some(keyword.to_owned());</div><div class="diff-removed">-        }</div><div class="diff-removed">-        None</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    fn remove_point(&mut self, id: PointOffsetType) -> OperationResult<()> {</div><div class="diff-removed">-        self.remove_point(id)</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-impl ValueIndexer for MapIndex<IntPayloadType> {</div><div class="diff-removed">-    type ValueType = IntPayloadType;</div><div class="diff-removed">-</div><div class="diff-removed">-    fn add_many(</div><div class="diff-removed">-        &mut self,</div><div class="diff-removed">-        id: PointOffsetType,</div><div class="diff-removed">-        values: Vec<IntPayloadType>,</div><div class="diff-removed">-        hw_counter: &HardwareCounterCell,</div><div class="diff-removed">-    ) -> OperationResult<()> {</div><div class="diff-removed">-        match self {</div><div class="diff-removed">-            MapIndex::Mutable(index) => index.add_many_to_map(id, values, hw_counter),</div><div class="diff-removed">-            MapIndex::Immutable(_) => Err(OperationError::service_error(</div><div class="diff-removed">-                "Can't add values to immutable map index",</div><div class="diff-removed">-            )),</div><div class="diff-removed">-            MapIndex::Mmap(_) => Err(OperationError::service_error(</div><div class="diff-removed">-                "Can't add values to mmap map index",</div><div class="diff-removed">-            )),</div><div class="diff-removed">-        }</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    fn get_value(value: &Value) -> Option<IntPayloadType> {</div><div class="diff-removed">-        if let Value::Number(num) = value {</div><div class="diff-removed">-            return num.as_i64();</div><div class="diff-removed">-        }</div><div class="diff-removed">-        None</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    fn remove_point(&mut self, id: PointOffsetType) -> OperationResult<()> {</div><div class="diff-removed">-        self.remove_point(id)</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-impl ValueIndexer for MapIndex<UuidIntType> {</div><div class="diff-removed">-    type ValueType = UuidIntType;</div><div class="diff-removed">-</div><div class="diff-removed">-    fn add_many(</div><div class="diff-removed">-        &mut self,</div><div class="diff-removed">-        id: PointOffsetType,</div><div class="diff-removed">-        values: Vec<Self::ValueType>,</div><div class="diff-removed">-        hw_counter: &HardwareCounterCell,</div><div class="diff-removed">-    ) -> OperationResult<()> {</div><div class="diff-removed">-        match self {</div><div class="diff-removed">-            MapIndex::Mutable(index) => index.add_many_to_map(id, values, hw_counter),</div><div class="diff-removed">-            MapIndex::Immutable(_) => Err(OperationError::service_error(</div><div class="diff-removed">-                "Can't add values to immutable map index",</div><div class="diff-removed">-            )),</div><div class="diff-removed">-            MapIndex::Mmap(_) => Err(OperationError::service_error(</div><div class="diff-removed">-                "Can't add values to mmap map index",</div><div class="diff-removed">-            )),</div><div class="diff-removed">-        }</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    fn get_value(value: &Value) -> Option<Self::ValueType> {</div><div class="diff-removed">-        Some(Uuid::parse_str(value.as_str()?).ok()?.as_u128())</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    fn remove_point(&mut self, id: PointOffsetType) -> OperationResult<()> {</div><div class="diff-removed">-        self.remove_point(id)</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-#[cfg(test)]</div><div class="diff-removed">-mod tests {</div><div class="diff-removed">-    use std::collections::HashSet;</div><div class="diff-removed">-    use std::path::Path;</div><div class="diff-removed">-</div><div class="diff-removed">-    use rstest::rstest;</div><div class="diff-removed">-    use tempfile::Builder;</div><div class="diff-removed">-</div><div class="diff-removed">-    use super::*;</div><div class="diff-removed">-    use crate::common::rocksdb_wrapper::open_db_with_existing_cf;</div><div class="diff-removed">-</div><div class="diff-removed">-    const FIELD_NAME: &str = "test";</div><div class="diff-removed">-</div><div class="diff-removed">-    #[derive(Clone, Copy)]</div><div class="diff-removed">-    enum IndexType {</div><div class="diff-removed">-        Mutable,</div><div class="diff-removed">-        Immutable,</div><div class="diff-removed">-        Mmap,</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    fn save_map_index<N>(</div><div class="diff-removed">-        data: &[Vec<N::Owned>],</div><div class="diff-removed">-        path: &Path,</div><div class="diff-removed">-        index_type: IndexType,</div><div class="diff-removed">-        into_value: impl Fn(&N::Owned) -> Value,</div><div class="diff-removed">-    ) where</div><div class="diff-removed">-        N: MapIndexKey + ?Sized,</div><div class="diff-removed">-        MapIndex<N>: PayloadFieldIndex + ValueIndexer,</div><div class="diff-removed">-        <MapIndex<N> as ValueIndexer>::ValueType: Into<N::Owned>,</div><div class="diff-removed">-    {</div><div class="diff-removed">-        let hw_counter = HardwareCounterCell::new();</div><div class="diff-removed">-</div><div class="diff-removed">-        match index_type {</div><div class="diff-removed">-            IndexType::Mutable | IndexType::Immutable => {</div><div class="diff-removed">-                let mut builder =</div><div class="diff-removed">-                    MapIndex::<N>::builder(open_db_with_existing_cf(path).unwrap(), FIELD_NAME);</div><div class="diff-removed">-                builder.init().unwrap();</div><div class="diff-removed">-                for (idx, values) in data.iter().enumerate() {</div><div class="diff-removed">-                    let values: Vec<Value> = values.iter().map(&into_value).collect();</div><div class="diff-removed">-                    let values: Vec<_> = values.iter().collect();</div><div class="diff-removed">-                    builder</div><div class="diff-removed">-                        .add_point(idx as PointOffsetType, &values, &hw_counter)</div><div class="diff-removed">-                        .unwrap();</div><div class="diff-removed">-                }</div><div class="diff-removed">-                builder.finalize().unwrap();</div><div class="diff-removed">-            }</div><div class="diff-removed">-            IndexType::Mmap => {</div><div class="diff-removed">-                let mut builder = MapIndex::<N>::mmap_builder(path, false);</div><div class="diff-removed">-                builder.init().unwrap();</div><div class="diff-removed">-                for (idx, values) in data.iter().enumerate() {</div><div class="diff-removed">-                    let values: Vec<Value> = values.iter().map(&into_value).collect();</div><div class="diff-removed">-                    let values: Vec<_> = values.iter().collect();</div><div class="diff-removed">-                    builder</div><div class="diff-removed">-                        .add_point(idx as PointOffsetType, &values, &hw_counter)</div><div class="diff-removed">-                        .unwrap();</div><div class="diff-removed">-                }</div><div class="diff-removed">-                builder.finalize().unwrap();</div><div class="diff-removed">-            }</div><div class="diff-removed">-        }</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    fn load_map_index<N: MapIndexKey + ?Sized>(</div><div class="diff-removed">-        data: &[Vec<N::Owned>],</div><div class="diff-removed">-        path: &Path,</div><div class="diff-removed">-        index_type: IndexType,</div><div class="diff-removed">-    ) -> MapIndex<N> {</div><div class="diff-removed">-        let mut index = match index_type {</div><div class="diff-removed">-            IndexType::Mutable => {</div><div class="diff-removed">-                MapIndex::<N>::new_memory(open_db_with_existing_cf(path).unwrap(), FIELD_NAME, true)</div><div class="diff-removed">-            }</div><div class="diff-removed">-            IndexType::Immutable => MapIndex::<N>::new_memory(</div><div class="diff-removed">-                open_db_with_existing_cf(path).unwrap(),</div><div class="diff-removed">-                FIELD_NAME,</div><div class="diff-removed">-                false,</div><div class="diff-removed">-            ),</div><div class="diff-removed">-            IndexType::Mmap => MapIndex::<N>::new_mmap(path, false).unwrap(),</div><div class="diff-removed">-        };</div><div class="diff-removed">-        index.load_from_db().unwrap();</div><div class="diff-removed">-        for (idx, values) in data.iter().enumerate() {</div><div class="diff-removed">-            let index_values: HashSet<N::Owned> = index</div><div class="diff-removed">-                .get_values(idx as PointOffsetType)</div><div class="diff-removed">-                .unwrap()</div><div class="diff-removed">-                .map(|v| N::to_owned(N::from_referenced(&v)))</div><div class="diff-removed">-                .collect();</div><div class="diff-removed">-            let index_values: HashSet<&N> = index_values.iter().map(|v| v.borrow()).collect();</div><div class="diff-removed">-            let check_values: HashSet<&N> = values.iter().map(|v| v.borrow()).collect();</div><div class="diff-removed">-            assert_eq!(index_values, check_values);</div><div class="diff-removed">-        }</div><div class="diff-removed">-</div><div class="diff-removed">-        index</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    #[test]</div><div class="diff-removed">-    fn test_index_non_ascending_insertion() {</div><div class="diff-removed">-        let temp_dir = Builder::new().prefix("store_dir").tempdir().unwrap();</div><div class="diff-removed">-        let mut builder = MapIndex::<IntPayloadType>::mmap_builder(temp_dir.path(), false);</div><div class="diff-removed">-        builder.init().unwrap();</div><div class="diff-removed">-</div><div class="diff-removed">-        let data = [vec![1, 2, 3, 4, 5, 6], vec![25], vec![10, 11]];</div><div class="diff-removed">-</div><div class="diff-removed">-        let hw_counter = HardwareCounterCell::new();</div><div class="diff-removed">-</div><div class="diff-removed">-        for (idx, values) in data.iter().enumerate().rev() {</div><div class="diff-removed">-            let values: Vec<Value> = values.iter().map(|i| (*i).into()).collect();</div><div class="diff-removed">-            let values: Vec<_> = values.iter().collect();</div><div class="diff-removed">-            builder</div><div class="diff-removed">-                .add_point(idx as PointOffsetType, &values, &hw_counter)</div><div class="diff-removed">-                .unwrap();</div><div class="diff-removed">-        }</div><div class="diff-removed">-</div><div class="diff-removed">-        let index = builder.finalize().unwrap();</div><div class="diff-removed">-        for (idx, values) in data.iter().enumerate().rev() {</div><div class="diff-removed">-            let res: Vec<_> = index</div><div class="diff-removed">-                .get_values(idx as u32)</div><div class="diff-removed">-                .unwrap()</div><div class="diff-removed">-                .map(|i| *i as i32)</div><div class="diff-removed">-                .collect();</div><div class="diff-removed">-            assert_eq!(res, *values);</div><div class="diff-removed">-        }</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    #[rstest]</div><div class="diff-removed">-    #[case(IndexType::Mutable)]</div><div class="diff-removed">-    #[case(IndexType::Immutable)]</div><div class="diff-removed">-    #[case(IndexType::Mmap)]</div><div class="diff-removed">-    fn test_int_disk_map_index(#[case] index_type: IndexType) {</div><div class="diff-removed">-        let data = vec![</div><div class="diff-removed">-            vec![1, 2, 3, 4, 5, 6],</div><div class="diff-removed">-            vec![1, 2, 3, 4, 5, 6],</div><div class="diff-removed">-            vec![13, 14, 15, 16, 17, 18],</div><div class="diff-removed">-            vec![19, 20, 21, 22, 23, 24],</div><div class="diff-removed">-            vec![25],</div><div class="diff-removed">-        ];</div><div class="diff-removed">-</div><div class="diff-removed">-        let temp_dir = Builder::new().prefix("store_dir").tempdir().unwrap();</div><div class="diff-removed">-        save_map_index::<IntPayloadType>(&data, temp_dir.path(), index_type, |v| (*v).into());</div><div class="diff-removed">-        let index = load_map_index::<IntPayloadType>(&data, temp_dir.path(), index_type);</div><div class="diff-removed">-</div><div class="diff-removed">-        let hw_counter = HardwareCounterCell::new();</div><div class="diff-removed">-</div><div class="diff-removed">-        // Ensure cardinality is non zero</div><div class="diff-removed">-        assert!(</div><div class="diff-removed">-            !index</div><div class="diff-removed">-                .except_cardinality(vec![].into_iter(), &hw_counter)</div><div class="diff-removed">-                .equals_min_exp_max(&CardinalityEstimation::exact(0)),</div><div class="diff-removed">-        );</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    #[rstest]</div><div class="diff-removed">-    #[case(IndexType::Mutable)]</div><div class="diff-removed">-    #[case(IndexType::Immutable)]</div><div class="diff-removed">-    #[case(IndexType::Mmap)]</div><div class="diff-removed">-    fn test_string_disk_map_index(#[case] index_type: IndexType) {</div><div class="diff-removed">-        let data = vec![</div><div class="diff-removed">-            vec![</div><div class="diff-removed">-                SmolStr::from("AABB"),</div><div class="diff-removed">-                SmolStr::from("UUFF"),</div><div class="diff-removed">-                SmolStr::from("IIBB"),</div><div class="diff-removed">-            ],</div><div class="diff-removed">-            vec![</div><div class="diff-removed">-                SmolStr::from("PPMM"),</div><div class="diff-removed">-                SmolStr::from("QQXX"),</div><div class="diff-removed">-                SmolStr::from("YYBB"),</div><div class="diff-removed">-            ],</div><div class="diff-removed">-            vec![</div><div class="diff-removed">-                SmolStr::from("FFMM"),</div><div class="diff-removed">-                SmolStr::from("IICC"),</div><div class="diff-removed">-                SmolStr::from("IIBB"),</div><div class="diff-removed">-            ],</div><div class="diff-removed">-            vec![</div><div class="diff-removed">-                SmolStr::from("AABB"),</div><div class="diff-removed">-                SmolStr::from("UUFF"),</div><div class="diff-removed">-                SmolStr::from("IIBB"),</div><div class="diff-removed">-            ],</div><div class="diff-removed">-            vec![SmolStr::from("PPGG")],</div><div class="diff-removed">-        ];</div><div class="diff-removed">-</div><div class="diff-removed">-        let temp_dir = Builder::new().prefix("store_dir").tempdir().unwrap();</div><div class="diff-removed">-        save_map_index::<str>(&data, temp_dir.path(), index_type, |v| v.to_string().into());</div><div class="diff-removed">-        let index = load_map_index::<str>(&data, temp_dir.path(), index_type);</div><div class="diff-removed">-</div><div class="diff-removed">-        let hw_counter = HardwareCounterCell::new();</div><div class="diff-removed">-</div><div class="diff-removed">-        // Ensure cardinality is non zero</div><div class="diff-removed">-        assert!(</div><div class="diff-removed">-            !index</div><div class="diff-removed">-                .except_cardinality(vec![].into_iter(), &hw_counter)</div><div class="diff-removed">-                .equals_min_exp_max(&CardinalityEstimation::exact(0)),</div><div class="diff-removed">-        );</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    #[rstest]</div><div class="diff-removed">-    #[case(IndexType::Mutable)]</div><div class="diff-removed">-    #[case(IndexType::Immutable)]</div><div class="diff-removed">-    #[case(IndexType::Mmap)]</div><div class="diff-removed">-    fn test_empty_index(#[case] index_type: IndexType) {</div><div class="diff-removed">-        let data: Vec<Vec<SmolStr>> = vec![];</div><div class="diff-removed">-</div><div class="diff-removed">-        let temp_dir = Builder::new().prefix("store_dir").tempdir().unwrap();</div><div class="diff-removed">-        save_map_index::<str>(&data, temp_dir.path(), index_type, |v| v.to_string().into());</div><div class="diff-removed">-        let index = load_map_index::<str>(&data, temp_dir.path(), index_type);</div><div class="diff-removed">-</div><div class="diff-removed">-        let hw_counter = HardwareCounterCell::new();</div><div class="diff-removed">-</div><div class="diff-removed">-        // Ensure cardinality is zero</div><div class="diff-removed">-        assert!(</div><div class="diff-removed">-            index</div><div class="diff-removed">-                .except_cardinality(vec![].into_iter(), &hw_counter)</div><div class="diff-removed">-                .equals_min_exp_max(&CardinalityEstimation::exact(0)),</div><div class="diff-removed">-        );</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div>\ No newline at end of file</div><div class="diff-added">+                        .iter()</div><div>\ No newline at end of file</div><div></div></pre>
                </div>
            </div>
        </section>
    </main>
    <footer>
        <p>LoCoDiff-bench - <a href="https://github.com/AbanteAI/LoCoDiff-bench">GitHub Repository</a></p>
    </footer>
</body>
</html>
    