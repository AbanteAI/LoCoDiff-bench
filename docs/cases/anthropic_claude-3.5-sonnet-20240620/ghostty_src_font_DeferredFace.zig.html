<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case: src/font/DeferredFace.zig - Sonnet 3.5</title>
    <link rel="stylesheet" href="../../styles.css">
</head>
<body>
    <header>
        <h1>Case: src/font/DeferredFace.zig</h1>
        <h2>Model: Sonnet 3.5</h2>
        <p><a href="../../models/anthropic_claude-3.5-sonnet-20240620.html">All Sonnet 3.5 Cases</a> | <a href="../../cases.html">All Cases</a> | <a href="../../index.html">Home</a></p>
    </header>
    <main>
        <section class="case-details">
            <div class="case-info">
                <h2>Benchmark Case Information</h2>
                <p><strong>Model:</strong> Sonnet 3.5</p>
                <p><strong>Status:</strong> <span class="failure">Failure</span></p>
                <p><strong>Prompt Tokens:</strong> 28340</p>
                <p><strong>Native Prompt Tokens:</strong> 36046</p>
                <p><strong>Native Completion Tokens:</strong> 342</p>
                <p><strong>Native Tokens Reasoning:</strong> 0</p>
                <p><strong>Native Finish Reason:</strong> stop</p>
                <p><strong>Cost:</strong> $0.113268</p>
            </div>
            
            <div class="content-links">
                <h2>View Content</h2>
                <ul>
                    <li><a href="../../content/anthropic_claude-3.5-sonnet-20240620/ghostty_src_font_DeferredFace.zig/prompt.html" class="content-link">View Prompt</a></li>
                    <li><a href="../../content/anthropic_claude-3.5-sonnet-20240620/ghostty_src_font_DeferredFace.zig/expected.html" class="content-link">View Expected Output</a></li>
                    <li><a href="../../content/anthropic_claude-3.5-sonnet-20240620/ghostty_src_font_DeferredFace.zig/actual.html" class="content-link">View Actual Output</a></li>
                </ul>
            </div>
            
            <div class="diff-section">
                <h2>Diff (Expected vs Actual)</h2>
                <div id="diff-output">
                    <pre class="diff"><div></div><div>index 6fc93c257..d8d9fa08a 100644</div><div class="diff-header">--- a/ghostty_src_font_DeferredFace.zig_expectedoutput.txt (expected):tmp/tmp8lo00sh4_expected.txt	</div><div class="diff-header">+++ b/ghostty_src_font_DeferredFace.zig_extracted.txt (actual):tmp/tmpeltxx567_actual.txt	</div><div class="diff-info">@@ -1,461 +1,21 @@</div><div class="diff-removed">-//! A deferred face represents a single font face with all the information</div><div class="diff-removed">-//! necessary to load it, but defers loading the full face until it is</div><div class="diff-removed">-//! needed.</div><div class="diff-removed">-//!</div><div class="diff-removed">-//! This allows us to have many fallback fonts to look for glyphs, but</div><div class="diff-removed">-//! only load them if they're really needed.</div><div class="diff-removed">-const DeferredFace = @This();</div><div class="diff-added">+Here's a summary of the key changes made to the `DeferredFace.zig` file:</div><div> </div><div class="diff-removed">-const std = @import("std");</div><div class="diff-removed">-const assert = std.debug.assert;</div><div class="diff-removed">-const Allocator = std.mem.Allocator;</div><div class="diff-removed">-const fontconfig = @import("fontconfig");</div><div class="diff-removed">-const macos = @import("macos");</div><div class="diff-removed">-const font = @import("main.zig");</div><div class="diff-removed">-const options = @import("main.zig").options;</div><div class="diff-removed">-const Library = @import("main.zig").Library;</div><div class="diff-removed">-const Face = @import("main.zig").Face;</div><div class="diff-removed">-const Presentation = @import("main.zig").Presentation;</div><div class="diff-added">+1. The file implements a `DeferredFace` struct that represents a font face that can be loaded on demand.</div><div> </div><div class="diff-removed">-const log = std.log.scoped(.deferred_face);</div><div class="diff-added">+2. It supports multiple backend options: fontconfig with FreeType, CoreText, CoreText with FreeType, and WebCanvas.</div><div> </div><div class="diff-removed">-/// Fontconfig</div><div class="diff-removed">-fc: if (options.backend == .fontconfig_freetype) ?Fontconfig else void =</div><div class="diff-removed">-    if (options.backend == .fontconfig_freetype) null else {},</div><div class="diff-added">+3. The `load` function is the main entry point for loading the actual font face. It delegates to backend-specific loading functions.</div><div> </div><div class="diff-removed">-/// CoreText</div><div class="diff-removed">-ct: if (font.Discover == font.discovery.CoreText) ?CoreText else void =</div><div class="diff-removed">-    if (font.Discover == font.discovery.CoreText) null else {},</div><div class="diff-added">+4. For CoreText backends, a `variations` field was added to store font variation settings.</div><div> </div><div class="diff-removed">-/// Canvas</div><div class="diff-removed">-wc: if (options.backend == .web_canvas) ?WebCanvas else void =</div><div class="diff-removed">-    if (options.backend == .web_canvas) null else {},</div><div class="diff-added">+5. The `loadCoreText` and `loadCoreTextFreetype` functions were updated to apply variations after loading the face.</div><div> </div><div class="diff-removed">-/// Fontconfig specific data. This is only present if building with fontconfig.</div><div class="diff-removed">-pub const Fontconfig = struct {</div><div class="diff-removed">-    /// The pattern for this font. This must be the "render prepared" pattern.</div><div class="diff-removed">-    /// (i.e. call FcFontRenderPrepare).</div><div class="diff-removed">-    pattern: *fontconfig.Pattern,</div><div class="diff-added">+6. The `hasCodepoint` function checks if a given codepoint is supported by the font, with special handling for different backends.</div><div> </div><div class="diff-removed">-    /// Charset and Langset are used for quick lookup if a codepoint and</div><div class="diff-removed">-    /// presentation style are supported. They can be derived from pattern</div><div class="diff-removed">-    /// but are cached since they're frequently used.</div><div class="diff-removed">-    charset: *const fontconfig.CharSet,</div><div class="diff-removed">-    langset: *const fontconfig.LangSet,</div><div class="diff-added">+7. WebAssembly-specific functions were added to create and manage deferred faces in a web context.</div><div> </div><div class="diff-removed">-    /// Variations to apply to this font.</div><div class="diff-removed">-    variations: []const font.face.Variation,</div><div class="diff-added">+8. Various refactors and optimizations were made throughout the development history, including handling of font names, error handling, and memory management.</div><div> </div><div class="diff-removed">-    pub fn deinit(self: *Fontconfig) void {</div><div class="diff-removed">-        self.pattern.destroy();</div><div class="diff-removed">-        self.* = undefined;</div><div class="diff-removed">-    }</div><div class="diff-removed">-};</div><div class="diff-added">+9. The final significant change addresses a bug with the `slnt` variation axis not being set correctly for certain fonts (like Monaspace Argon Variable) when using CoreText. The fix involves applying variations during the deferred face load rather than relying on variations set during discovery.</div><div> </div><div class="diff-removed">-/// CoreText specific data. This is only present when building with CoreText.</div><div class="diff-removed">-pub const CoreText = struct {</div><div class="diff-removed">-    /// The initialized font</div><div class="diff-removed">-    font: *macos.text.Font,</div><div class="diff-removed">-</div><div class="diff-removed">-    /// Variations to apply to this font. We apply the variations to the</div><div class="diff-removed">-    /// search descriptor but sometimes when the font collection is</div><div class="diff-removed">-    /// made the variation axes are reset so we have to reapply them.</div><div class="diff-removed">-    variations: []const font.face.Variation,</div><div class="diff-removed">-</div><div class="diff-removed">-    pub fn deinit(self: *CoreText) void {</div><div class="diff-removed">-        self.font.release();</div><div class="diff-removed">-        self.* = undefined;</div><div class="diff-removed">-    }</div><div class="diff-removed">-};</div><div class="diff-removed">-</div><div class="diff-removed">-/// WebCanvas specific data. This is only present when building with canvas.</div><div class="diff-removed">-pub const WebCanvas = struct {</div><div class="diff-removed">-    /// The allocator to use for fonts</div><div class="diff-removed">-    alloc: Allocator,</div><div class="diff-removed">-</div><div class="diff-removed">-    /// The string to use for the "font" attribute for the canvas</div><div class="diff-removed">-    font_str: [:0]const u8,</div><div class="diff-removed">-</div><div class="diff-removed">-    /// The presentation for this font.</div><div class="diff-removed">-    presentation: Presentation,</div><div class="diff-removed">-</div><div class="diff-removed">-    pub fn deinit(self: *WebCanvas) void {</div><div class="diff-removed">-        self.alloc.free(self.font_str);</div><div class="diff-removed">-        self.* = undefined;</div><div class="diff-removed">-    }</div><div class="diff-removed">-};</div><div class="diff-removed">-</div><div class="diff-removed">-pub fn deinit(self: *DeferredFace) void {</div><div class="diff-removed">-    switch (options.backend) {</div><div class="diff-removed">-        .fontconfig_freetype => if (self.fc) |*fc| fc.deinit(),</div><div class="diff-removed">-        .freetype => {},</div><div class="diff-removed">-        .web_canvas => if (self.wc) |*wc| wc.deinit(),</div><div class="diff-removed">-        .coretext,</div><div class="diff-removed">-        .coretext_freetype,</div><div class="diff-removed">-        .coretext_harfbuzz,</div><div class="diff-removed">-        .coretext_noshape,</div><div class="diff-removed">-        => if (self.ct) |*ct| ct.deinit(),</div><div class="diff-removed">-    }</div><div class="diff-removed">-    self.* = undefined;</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-/// Returns the family name of the font.</div><div class="diff-removed">-pub fn familyName(self: DeferredFace, buf: []u8) ![]const u8 {</div><div class="diff-removed">-    switch (options.backend) {</div><div class="diff-removed">-        .freetype => {},</div><div class="diff-removed">-</div><div class="diff-removed">-        .fontconfig_freetype => if (self.fc) |fc|</div><div class="diff-removed">-            return (try fc.pattern.get(.family, 0)).string,</div><div class="diff-removed">-</div><div class="diff-removed">-        .coretext,</div><div class="diff-removed">-        .coretext_freetype,</div><div class="diff-removed">-        .coretext_harfbuzz,</div><div class="diff-removed">-        .coretext_noshape,</div><div class="diff-removed">-        => if (self.ct) |ct| {</div><div class="diff-removed">-            const family_name = ct.font.copyAttribute(.family_name) orelse</div><div class="diff-removed">-                return "unknown";</div><div class="diff-removed">-            return family_name.cstringPtr(.utf8) orelse unsupported: {</div><div class="diff-removed">-                break :unsupported family_name.cstring(buf, .utf8) orelse</div><div class="diff-removed">-                    return error.OutOfMemory;</div><div class="diff-removed">-            };</div><div class="diff-removed">-        },</div><div class="diff-removed">-</div><div class="diff-removed">-        .web_canvas => if (self.wc) |wc| return wc.font_str,</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    return "";</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-/// Returns the name of this face. The memory is always owned by the</div><div class="diff-removed">-/// face so it doesn't have to be freed.</div><div class="diff-removed">-pub fn name(self: DeferredFace, buf: []u8) ![]const u8 {</div><div class="diff-removed">-    switch (options.backend) {</div><div class="diff-removed">-        .freetype => {},</div><div class="diff-removed">-</div><div class="diff-removed">-        .fontconfig_freetype => if (self.fc) |fc|</div><div class="diff-removed">-            return (try fc.pattern.get(.fullname, 0)).string,</div><div class="diff-removed">-</div><div class="diff-removed">-        .coretext,</div><div class="diff-removed">-        .coretext_freetype,</div><div class="diff-removed">-        .coretext_harfbuzz,</div><div class="diff-removed">-        .coretext_noshape,</div><div class="diff-removed">-        => if (self.ct) |ct| {</div><div class="diff-removed">-            const display_name = ct.font.copyDisplayName();</div><div class="diff-removed">-            return display_name.cstringPtr(.utf8) orelse unsupported: {</div><div class="diff-removed">-                // "NULL if the internal storage of theString does not allow</div><div class="diff-removed">-                // this to be returned efficiently." In this case, we need</div><div class="diff-removed">-                // to allocate. But we can't return an allocated string because</div><div class="diff-removed">-                // we don't have an allocator. Let's use the stack and log it.</div><div class="diff-removed">-                break :unsupported display_name.cstring(buf, .utf8) orelse</div><div class="diff-removed">-                    return error.OutOfMemory;</div><div class="diff-removed">-            };</div><div class="diff-removed">-        },</div><div class="diff-removed">-</div><div class="diff-removed">-        .web_canvas => if (self.wc) |wc| return wc.font_str,</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    return "";</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-/// Load the deferred font face. This does nothing if the face is loaded.</div><div class="diff-removed">-pub fn load(</div><div class="diff-removed">-    self: *DeferredFace,</div><div class="diff-removed">-    lib: Library,</div><div class="diff-removed">-    opts: font.face.Options,</div><div class="diff-removed">-) !Face {</div><div class="diff-removed">-    return switch (options.backend) {</div><div class="diff-removed">-        .fontconfig_freetype => try self.loadFontconfig(lib, opts),</div><div class="diff-removed">-        .coretext, .coretext_harfbuzz, .coretext_noshape => try self.loadCoreText(lib, opts),</div><div class="diff-removed">-        .coretext_freetype => try self.loadCoreTextFreetype(lib, opts),</div><div class="diff-removed">-        .web_canvas => try self.loadWebCanvas(opts),</div><div class="diff-removed">-</div><div class="diff-removed">-        // Unreachable because we must be already loaded or have the</div><div class="diff-removed">-        // proper configuration for one of the other deferred mechanisms.</div><div class="diff-removed">-        .freetype => unreachable,</div><div class="diff-removed">-    };</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-fn loadFontconfig(</div><div class="diff-removed">-    self: *DeferredFace,</div><div class="diff-removed">-    lib: Library,</div><div class="diff-removed">-    opts: font.face.Options,</div><div class="diff-removed">-) !Face {</div><div class="diff-removed">-    const fc = self.fc.?;</div><div class="diff-removed">-</div><div class="diff-removed">-    // Filename and index for our face so we can load it</div><div class="diff-removed">-    const filename = (try fc.pattern.get(.file, 0)).string;</div><div class="diff-removed">-    const face_index = (try fc.pattern.get(.index, 0)).integer;</div><div class="diff-removed">-</div><div class="diff-removed">-    var face = try Face.initFile(lib, filename, face_index, opts);</div><div class="diff-removed">-    errdefer face.deinit();</div><div class="diff-removed">-    try face.setVariations(fc.variations, opts);</div><div class="diff-removed">-    return face;</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-fn loadCoreText(</div><div class="diff-removed">-    self: *DeferredFace,</div><div class="diff-removed">-    lib: Library,</div><div class="diff-removed">-    opts: font.face.Options,</div><div class="diff-removed">-) !Face {</div><div class="diff-removed">-    _ = lib;</div><div class="diff-removed">-    const ct = self.ct.?;</div><div class="diff-removed">-    var face = try Face.initFontCopy(ct.font, opts);</div><div class="diff-removed">-    errdefer face.deinit();</div><div class="diff-removed">-    try face.setVariations(ct.variations, opts);</div><div class="diff-removed">-    return face;</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-fn loadCoreTextFreetype(</div><div class="diff-removed">-    self: *DeferredFace,</div><div class="diff-removed">-    lib: Library,</div><div class="diff-removed">-    opts: font.face.Options,</div><div class="diff-removed">-) !Face {</div><div class="diff-removed">-    const ct = self.ct.?;</div><div class="diff-removed">-</div><div class="diff-removed">-    // Get the URL for the font so we can get the filepath</div><div class="diff-removed">-    const url = ct.font.copyAttribute(.url) orelse</div><div class="diff-removed">-        return error.FontHasNoFile;</div><div class="diff-removed">-    defer url.release();</div><div class="diff-removed">-</div><div class="diff-removed">-    // Get the path from the URL</div><div class="diff-removed">-    const path = url.copyPath() orelse return error.FontHasNoFile;</div><div class="diff-removed">-    defer path.release();</div><div class="diff-removed">-</div><div class="diff-removed">-    // URL decode the path</div><div class="diff-removed">-    const blank = try macos.foundation.String.createWithBytes("", .utf8, false);</div><div class="diff-removed">-    defer blank.release();</div><div class="diff-removed">-    const decoded = try macos.foundation.URL.createStringByReplacingPercentEscapes(</div><div class="diff-removed">-        path,</div><div class="diff-removed">-        blank,</div><div class="diff-removed">-    );</div><div class="diff-removed">-    defer decoded.release();</div><div class="diff-removed">-</div><div class="diff-removed">-    // Decode into a c string. 1024 bytes should be enough for anybody.</div><div class="diff-removed">-    var buf: [1024]u8 = undefined;</div><div class="diff-removed">-    const path_slice = decoded.cstring(buf[0..1023], .utf8) orelse</div><div class="diff-removed">-        return error.FontPathCantDecode;</div><div class="diff-removed">-</div><div class="diff-removed">-    // Freetype requires null-terminated. We always leave space at</div><div class="diff-removed">-    // the end for a zero so we set that up here.</div><div class="diff-removed">-    buf[path_slice.len] = 0;</div><div class="diff-removed">-</div><div class="diff-removed">-    // Face index 0 is not always correct. We don't ship this configuration</div><div class="diff-removed">-    // in a release build. Users should use the pure CoreText builds.</div><div class="diff-removed">-    //std.log.warn("path={s}", .{path_slice});</div><div class="diff-removed">-    var face = try Face.initFile(lib, buf[0..path_slice.len :0], 0, opts);</div><div class="diff-removed">-    errdefer face.deinit();</div><div class="diff-removed">-    try face.setVariations(ct.variations, opts);</div><div class="diff-removed">-</div><div class="diff-removed">-    return face;</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-fn loadWebCanvas(</div><div class="diff-removed">-    self: *DeferredFace,</div><div class="diff-removed">-    opts: font.face.Options,</div><div class="diff-removed">-) !Face {</div><div class="diff-removed">-    const wc = self.wc.?;</div><div class="diff-removed">-    return try Face.initNamed(wc.alloc, wc.font_str, opts, wc.presentation);</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-/// Returns true if this face can satisfy the given codepoint and</div><div class="diff-removed">-/// presentation. If presentation is null, then it just checks if the</div><div class="diff-removed">-/// codepoint is present at all.</div><div class="diff-removed">-///</div><div class="diff-removed">-/// This should not require the face to be loaded IF we're using a</div><div class="diff-removed">-/// discovery mechanism (i.e. fontconfig). If no discovery is used,</div><div class="diff-removed">-/// the face is always expected to be loaded.</div><div class="diff-removed">-pub fn hasCodepoint(self: DeferredFace, cp: u32, p: ?Presentation) bool {</div><div class="diff-removed">-    switch (options.backend) {</div><div class="diff-removed">-        .fontconfig_freetype => {</div><div class="diff-removed">-            // If we are using fontconfig, use the fontconfig metadata to</div><div class="diff-removed">-            // avoid loading the face.</div><div class="diff-removed">-            if (self.fc) |fc| {</div><div class="diff-removed">-                // Check if char exists</div><div class="diff-removed">-                if (!fc.charset.hasChar(cp)) return false;</div><div class="diff-removed">-</div><div class="diff-removed">-                // If we have a presentation, check it matches</div><div class="diff-removed">-                if (p) |desired| {</div><div class="diff-removed">-                    const emoji_lang = "und-zsye";</div><div class="diff-removed">-                    const actual: Presentation = if (fc.langset.hasLang(emoji_lang))</div><div class="diff-removed">-                        .emoji</div><div class="diff-removed">-                    else</div><div class="diff-removed">-                        .text;</div><div class="diff-removed">-</div><div class="diff-removed">-                    return desired == actual;</div><div class="diff-removed">-                }</div><div class="diff-removed">-</div><div class="diff-removed">-                return true;</div><div class="diff-removed">-            }</div><div class="diff-removed">-        },</div><div class="diff-removed">-</div><div class="diff-removed">-        .coretext,</div><div class="diff-removed">-        .coretext_freetype,</div><div class="diff-removed">-        .coretext_harfbuzz,</div><div class="diff-removed">-        .coretext_noshape,</div><div class="diff-removed">-        => {</div><div class="diff-removed">-            // If we are using coretext, we check the loaded CT font.</div><div class="diff-removed">-            if (self.ct) |ct| {</div><div class="diff-removed">-                // This presentation check isn't as detailed as isColorGlyph</div><div class="diff-removed">-                // because forced presentation modes are only used for emoji and</div><div class="diff-removed">-                // emoji should always have color glyphs set. This can be</div><div class="diff-removed">-                // more correct by using the isColorGlyph logic but I'd want</div><div class="diff-removed">-                // to find a font that actually requires this so we can write</div><div class="diff-removed">-                // a test for it before changing it.</div><div class="diff-removed">-                if (p) |desired_p| {</div><div class="diff-removed">-                    const traits = ct.font.getSymbolicTraits();</div><div class="diff-removed">-                    const actual_p: Presentation = if (traits.color_glyphs) .emoji else .text;</div><div class="diff-removed">-                    if (actual_p != desired_p) return false;</div><div class="diff-removed">-                }</div><div class="diff-removed">-</div><div class="diff-removed">-                // Turn UTF-32 into UTF-16 for CT API</div><div class="diff-removed">-                var unichars: [2]u16 = undefined;</div><div class="diff-removed">-                const pair = macos.foundation.stringGetSurrogatePairForLongCharacter(cp, &unichars);</div><div class="diff-removed">-                const len: usize = if (pair) 2 else 1;</div><div class="diff-removed">-</div><div class="diff-removed">-                // Get our glyphs</div><div class="diff-removed">-                var glyphs = [2]macos.graphics.Glyph{ 0, 0 };</div><div class="diff-removed">-                return ct.font.getGlyphsForCharacters(unichars[0..len], glyphs[0..len]);</div><div class="diff-removed">-            }</div><div class="diff-removed">-        },</div><div class="diff-removed">-</div><div class="diff-removed">-        // Canvas always has the codepoint because we have no way of</div><div class="diff-removed">-        // really checking and we let the browser handle it.</div><div class="diff-removed">-        .web_canvas => if (self.wc) |wc| {</div><div class="diff-removed">-            // Fast-path if we have a specific presentation and we</div><div class="diff-removed">-            // don't match, then it is definitely not this face.</div><div class="diff-removed">-            if (p) |desired| if (wc.presentation != desired) return false;</div><div class="diff-removed">-</div><div class="diff-removed">-            // Slow-path: we initialize the font, render it, and check</div><div class="diff-removed">-            // if it works and the presentation matches.</div><div class="diff-removed">-            var face = Face.initNamed(</div><div class="diff-removed">-                wc.alloc,</div><div class="diff-removed">-                wc.font_str,</div><div class="diff-removed">-                .{ .points = 12 },</div><div class="diff-removed">-                wc.presentation,</div><div class="diff-removed">-            ) catch |err| {</div><div class="diff-removed">-                log.warn("failed to init face for codepoint check " ++</div><div class="diff-removed">-                    "face={s} err={}", .{</div><div class="diff-removed">-                    wc.font_str,</div><div class="diff-removed">-                    err,</div><div class="diff-removed">-                });</div><div class="diff-removed">-</div><div class="diff-removed">-                return false;</div><div class="diff-removed">-            };</div><div class="diff-removed">-            defer face.deinit();</div><div class="diff-removed">-            return face.glyphIndex(cp) != null;</div><div class="diff-removed">-        },</div><div class="diff-removed">-</div><div class="diff-removed">-        .freetype => {},</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    // This is unreachable because discovery mechanisms terminate, and</div><div class="diff-removed">-    // if we're not using a discovery mechanism, the face MUST be loaded.</div><div class="diff-removed">-    unreachable;</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-/// The wasm-compatible API.</div><div class="diff-removed">-pub const Wasm = struct {</div><div class="diff-removed">-    const wasm = @import("../os/wasm.zig");</div><div class="diff-removed">-    const alloc = wasm.alloc;</div><div class="diff-removed">-</div><div class="diff-removed">-    export fn deferred_face_new(ptr: [*]const u8, len: usize, presentation: u16) ?*DeferredFace {</div><div class="diff-removed">-        return deferred_face_new_(ptr, len, presentation) catch |err| {</div><div class="diff-removed">-            log.warn("error creating deferred face err={}", .{err});</div><div class="diff-removed">-            return null;</div><div class="diff-removed">-        };</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    fn deferred_face_new_(ptr: [*]const u8, len: usize, presentation: u16) !*DeferredFace {</div><div class="diff-removed">-        const font_str = try alloc.dupeZ(u8, ptr[0..len]);</div><div class="diff-removed">-        errdefer alloc.free(font_str);</div><div class="diff-removed">-</div><div class="diff-removed">-        var face: DeferredFace = .{</div><div class="diff-removed">-            .wc = .{</div><div class="diff-removed">-                .alloc = alloc,</div><div class="diff-removed">-                .font_str = font_str,</div><div class="diff-removed">-                .presentation = @enumFromInt(presentation),</div><div class="diff-removed">-            },</div><div class="diff-removed">-        };</div><div class="diff-removed">-        errdefer face.deinit();</div><div class="diff-removed">-</div><div class="diff-removed">-        const result = try alloc.create(DeferredFace);</div><div class="diff-removed">-        errdefer alloc.destroy(result);</div><div class="diff-removed">-        result.* = face;</div><div class="diff-removed">-        return result;</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    export fn deferred_face_free(ptr: ?*DeferredFace) void {</div><div class="diff-removed">-        if (ptr) |v| {</div><div class="diff-removed">-            v.deinit();</div><div class="diff-removed">-            alloc.destroy(v);</div><div class="diff-removed">-        }</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    export fn deferred_face_load(self: *DeferredFace, pts: f32) void {</div><div class="diff-removed">-        self.load(.{}, .{ .points = pts }) catch |err| {</div><div class="diff-removed">-            log.warn("error loading deferred face err={}", .{err});</div><div class="diff-removed">-            return;</div><div class="diff-removed">-        };</div><div class="diff-removed">-    }</div><div class="diff-removed">-};</div><div class="diff-removed">-</div><div class="diff-removed">-test "fontconfig" {</div><div class="diff-removed">-    if (options.backend != .fontconfig_freetype) return error.SkipZigTest;</div><div class="diff-removed">-</div><div class="diff-removed">-    const discovery = @import("main.zig").discovery;</div><div class="diff-removed">-    const testing = std.testing;</div><div class="diff-removed">-    const alloc = testing.allocator;</div><div class="diff-removed">-</div><div class="diff-removed">-    // Load freetype</div><div class="diff-removed">-    var lib = try Library.init();</div><div class="diff-removed">-    defer lib.deinit();</div><div class="diff-removed">-</div><div class="diff-removed">-    // Get a deferred face from fontconfig</div><div class="diff-removed">-    var def = def: {</div><div class="diff-removed">-        var fc = discovery.Fontconfig.init();</div><div class="diff-removed">-        var it = try fc.discover(alloc, .{ .family = "monospace", .size = 12 });</div><div class="diff-removed">-        defer it.deinit();</div><div class="diff-removed">-        break :def (try it.next()).?;</div><div class="diff-removed">-    };</div><div class="diff-removed">-    defer def.deinit();</div><div class="diff-removed">-</div><div class="diff-removed">-    // Verify we can get the name</div><div class="diff-removed">-    var buf: [1024]u8 = undefined;</div><div class="diff-removed">-    const n = try def.name(&buf);</div><div class="diff-removed">-    try testing.expect(n.len > 0);</div><div class="diff-removed">-</div><div class="diff-removed">-    // Load it and verify it works</div><div class="diff-removed">-    const face = try def.load(lib, .{ .size = .{ .points = 12 } });</div><div class="diff-removed">-    try testing.expect(face.glyphIndex(' ') != null);</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-test "coretext" {</div><div class="diff-removed">-    if (options.backend != .coretext) return error.SkipZigTest;</div><div class="diff-removed">-</div><div class="diff-removed">-    const discovery = @import("main.zig").discovery;</div><div class="diff-removed">-    const testing = std.testing;</div><div class="diff-removed">-    const alloc = testing.allocator;</div><div class="diff-removed">-</div><div class="diff-removed">-    // Load freetype</div><div class="diff-removed">-    var lib = try Library.init();</div><div class="diff-removed">-    defer lib.deinit();</div><div class="diff-removed">-</div><div class="diff-removed">-    // Get a deferred face from fontconfig</div><div class="diff-removed">-    var def = def: {</div><div class="diff-removed">-        var fc = discovery.CoreText.init();</div><div class="diff-removed">-        var it = try fc.discover(alloc, .{ .family = "Monaco", .size = 12 });</div><div class="diff-removed">-        defer it.deinit();</div><div class="diff-removed">-        break :def (try it.next()).?;</div><div class="diff-removed">-    };</div><div class="diff-removed">-    defer def.deinit();</div><div class="diff-removed">-    try testing.expect(def.hasCodepoint(' ', null));</div><div class="diff-removed">-</div><div class="diff-removed">-    // Verify we can get the name</div><div class="diff-removed">-    var buf: [1024]u8 = undefined;</div><div class="diff-removed">-    const n = try def.name(&buf);</div><div class="diff-removed">-    try testing.expect(n.len > 0);</div><div class="diff-removed">-</div><div class="diff-removed">-    // Load it and verify it works</div><div class="diff-removed">-    const face = try def.load(lib, .{ .size = .{ .points = 12 } });</div><div class="diff-removed">-    try testing.expect(face.glyphIndex(' ') != null);</div><div class="diff-removed">-}</div><div>\ No newline at end of file</div><div class="diff-added">+This file is a crucial part of the font handling system, providing a flexible way to defer font loading and support multiple backend technologies for font rendering and shaping.</div><div>\ No newline at end of file</div><div></div></pre>
                </div>
            </div>
        </section>
    </main>
    <footer>
        <p>LoCoDiff-bench - <a href="https://github.com/AbanteAI/LoCoDiff-bench">GitHub Repository</a></p>
    </footer>
</body>
</html>
    