<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case: lib/collection/src/shards/local_shard/mod.rs - GPT-4.1</title>
    <link rel="stylesheet" href="../../styles.css">
</head>
<body>
    <header>
        <h1>Case: lib/collection/src/shards/local_shard/mod.rs</h1>
        <h2>Model: GPT-4.1</h2>
        <p><a href="../../models/openai_gpt-4.1.html">All GPT-4.1 Cases</a> | <a href="../../cases.html">All Cases</a> | <a href="../../index.html">Home</a></p>
    </header>
    <main>
        <section class="case-details">
            <div class="case-info">
                <h2>Benchmark Case Information</h2>
                <p><strong>Model:</strong> GPT-4.1</p>
                <p><strong>Status:</strong> <span class="failure">Failure</span></p>
                <p><strong>Prompt Tokens:</strong> 59828</p>
                <p><strong>Native Prompt Tokens:</strong> 59479</p>
                <p><strong>Native Completion Tokens:</strong> 9369</p>
                <p><strong>Native Tokens Reasoning:</strong> 0</p>
                <p><strong>Native Finish Reason:</strong> stop</p>
                <p><strong>Cost:</strong> $0.0096955</p>
            </div>
            
            <div class="content-links">
                <h2>View Content</h2>
                <ul>
                    <li><a href="../../content/openai_gpt-4.1/qdrant_lib_collection_src_shards_local_shard_mod.rs/prompt.html" class="content-link">View Prompt</a></li>
                    <li><a href="../../content/openai_gpt-4.1/qdrant_lib_collection_src_shards_local_shard_mod.rs/expected.html" class="content-link">View Expected Output</a></li>
                    <li><a href="../../content/openai_gpt-4.1/qdrant_lib_collection_src_shards_local_shard_mod.rs/actual.html" class="content-link">View Actual Output</a></li>
                </ul>
            </div>
            
            <div class="diff-section">
                <h2>Diff (Expected vs Actual)</h2>
                <div id="diff-output">
                    <pre class="diff"><div></div><div>index c9341cb3..a31d8f7f 100644</div><div class="diff-header">--- a/qdrant_lib_collection_src_shards_local_shard_mod.rs_expectedoutput.txt (expected):tmp/tmp26imzjmg_expected.txt	</div><div class="diff-header">+++ b/qdrant_lib_collection_src_shards_local_shard_mod.rs_extracted.txt (actual):tmp/tmpmrx2am3s_actual.txt	</div><div class="diff-info">@@ -52,12 +52,12 @@ use crate::collection_manager::optimizers::TrackerLog;</div><div> use crate::collection_manager::segments_searcher::SegmentsSearcher;</div><div> use crate::common::file_utils::{move_dir, move_file};</div><div> use crate::config::CollectionConfigInternal;</div><div class="diff-removed">-use crate::operations::OperationWithClockTag;</div><div> use crate::operations::shared_storage_config::SharedStorageConfig;</div><div> use crate::operations::types::{</div><div>     CollectionError, CollectionResult, OptimizersStatus, ShardInfoInternal, ShardStatus,</div><div>     check_sparse_compatible_with_segment_config,</div><div> };</div><div class="diff-added">+use crate::operations::OperationWithClockTag;</div><div> use crate::optimizers_builder::{OptimizersConfig, build_optimizers, clear_temp_segments};</div><div> use crate::save_on_disk::SaveOnDisk;</div><div> use crate::shards::CollectionId;</div><div class="diff-info">@@ -102,7 +102,6 @@ pub struct LocalShard {</div><div>     read_rate_limiter: Option<ParkingMutex<RateLimiter>>,</div><div> }</div><div> </div><div class="diff-removed">-/// Shard holds information about segments and WAL.</div><div> impl LocalShard {</div><div>     /// Moves `wal`, `segments` and `clocks` data from one path to another.</div><div>     pub async fn move_data(from: &Path, to: &Path) -> CollectionResult<()> {</div><div class="diff-info">@@ -173,16 +172,6 @@ impl LocalShard {</div><div>         let optimizers_log = Arc::new(ParkingMutex::new(Default::default()));</div><div>         let total_optimized_points = Arc::new(AtomicUsize::new(0));</div><div> </div><div class="diff-removed">-        // default to 2x the WAL capacity</div><div class="diff-removed">-        let disk_buffer_threshold_mb =</div><div class="diff-removed">-            2 * (collection_config.read().await.wal_config.wal_capacity_mb);</div><div class="diff-removed">-</div><div class="diff-removed">-        let disk_usage_watcher = disk_usage_watcher::DiskUsageWatcher::new(</div><div class="diff-removed">-            shard_path.to_owned(),</div><div class="diff-removed">-            disk_buffer_threshold_mb,</div><div class="diff-removed">-        )</div><div class="diff-removed">-        .await;</div><div class="diff-removed">-</div><div>         let mut update_handler = UpdateHandler::new(</div><div>             shared_storage_config.clone(),</div><div>             payload_index_schema.clone(),</div><div class="diff-info">@@ -197,6 +186,8 @@ impl LocalShard {</div><div>             config.optimizer_config.max_optimization_threads,</div><div>             clocks.clone(),</div><div>             shard_path.into(),</div><div class="diff-added">+            search_runtime.clone(),</div><div class="diff-added">+            None,</div><div>         );</div><div> </div><div>         let (update_sender, update_receiver) =</div><div class="diff-info">@@ -238,7 +229,18 @@ impl LocalShard {</div><div>         self.segments.deref()</div><div>     }</div><div> </div><div class="diff-removed">-    /// Recovers shard from disk.</div><div class="diff-added">+    pub fn shard_path(&self) -> PathBuf {</div><div class="diff-added">+        self.path.clone()</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    pub fn wal_path(shard_path: &Path) -> PathBuf {</div><div class="diff-added">+        shard_path.join(WAL_PATH)</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div class="diff-added">+    pub fn segments_path(shard_path: &Path) -> PathBuf {</div><div class="diff-added">+        shard_path.join(SEGMENTS_PATH)</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div>     #[allow(clippy::too_many_arguments)]</div><div>     pub async fn load(</div><div>         id: ShardId,</div><div class="diff-info">@@ -432,19 +434,6 @@ impl LocalShard {</div><div>         Ok(local_shard)</div><div>     }</div><div> </div><div class="diff-removed">-    pub fn shard_path(&self) -> PathBuf {</div><div class="diff-removed">-        self.path.clone()</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    pub fn wal_path(shard_path: &Path) -> PathBuf {</div><div class="diff-removed">-        shard_path.join(WAL_PATH)</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    pub fn segments_path(shard_path: &Path) -> PathBuf {</div><div class="diff-removed">-        shard_path.join(SEGMENTS_PATH)</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    #[allow(clippy::too_many_arguments)]</div><div>     pub async fn build_local(</div><div>         id: ShardId,</div><div>         collection_id: CollectionId,</div><div class="diff-info">@@ -459,7 +448,7 @@ impl LocalShard {</div><div>     ) -> CollectionResult<LocalShard> {</div><div>         // initialize local shard config file</div><div>         let local_shard_config = ShardConfig::new_replica_set();</div><div class="diff-removed">-        let shard = Self::build(</div><div class="diff-added">+        let local_shard = Self::build(</div><div>             id,</div><div>             collection_id,</div><div>             shard_path,</div><div class="diff-info">@@ -473,7 +462,7 @@ impl LocalShard {</div><div>         )</div><div>         .await?;</div><div>         local_shard_config.save(shard_path)?;</div><div class="diff-removed">-        Ok(shard)</div><div class="diff-added">+        Ok(local_shard)</div><div>     }</div><div> </div><div>     /// Creates new empty shard with given configuration, initializing all storages, optimizers and directories.</div><div class="diff-info">@@ -560,7 +549,7 @@ impl LocalShard {</div><div> </div><div>         drop(config); // release `shared_config` from borrow checker</div><div> </div><div class="diff-removed">-        let collection = LocalShard::new(</div><div class="diff-added">+        let local_shard = LocalShard::new(</div><div>             segment_holder,</div><div>             collection_config,</div><div>             shared_storage_config,</div><div class="diff-info">@@ -575,7 +564,7 @@ impl LocalShard {</div><div>         )</div><div>         .await;</div><div> </div><div class="diff-removed">-        Ok(collection)</div><div class="diff-added">+        Ok(local_shard)</div><div>     }</div><div> </div><div>     pub async fn stop_flush_worker(&self) {</div><div class="diff-info">@@ -778,27 +767,6 @@ impl LocalShard {</div><div>         Ok(())</div><div>     }</div><div> </div><div class="diff-removed">-    /// Apply shard's strict mode configuration update</div><div class="diff-removed">-    /// - Update read rate limiter</div><div class="diff-removed">-    pub async fn on_strict_mode_config_update(&mut self) {</div><div class="diff-removed">-        let config = self.collection_config.read().await;</div><div class="diff-removed">-</div><div class="diff-removed">-        if let Some(strict_mode_config) = &config.strict_mode_config {</div><div class="diff-removed">-            if strict_mode_config.enabled == Some(true) {</div><div class="diff-removed">-                // update read rate limiter</div><div class="diff-removed">-                if let Some(read_rate_limit_per_min) = strict_mode_config.read_rate_limit {</div><div class="diff-removed">-                    let new_read_rate_limiter =</div><div class="diff-removed">-                        RateLimiter::new_per_minute(read_rate_limit_per_min);</div><div class="diff-removed">-                    self.read_rate_limiter</div><div class="diff-removed">-                        .replace(parking_lot::Mutex::new(new_read_rate_limiter));</div><div class="diff-removed">-                    return;</div><div class="diff-removed">-                }</div><div class="diff-removed">-            }</div><div class="diff-removed">-        }</div><div class="diff-removed">-        // remove read rate limiter for all other situations</div><div class="diff-removed">-        self.read_rate_limiter.take();</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div>     pub fn trigger_optimizers(&self) {</div><div>         // Send a trigger signal and ignore errors because all error cases are acceptable:</div><div>         // - If receiver is already dead - we do not care</div><div class="diff-info">@@ -868,7 +836,6 @@ impl LocalShard {</div><div>             rx.await?;</div><div>         }</div><div> </div><div class="diff-removed">-        let segments_path = Self::segments_path(&self.path);</div><div>         let collection_params = self.collection_config.read().await.params.clone();</div><div>         let temp_path = temp_path.to_owned();</div><div>         let payload_index_schema = self.payload_index_schema.clone();</div><div class="diff-info">@@ -878,7 +845,7 @@ impl LocalShard {</div><div>             // Do not change segments while snapshotting</div><div>             SegmentHolder::snapshot_all_segments(</div><div>                 segments.clone(),</div><div class="diff-removed">-                &segments_path,</div><div class="diff-added">+                &LocalShard::segments_path(&segments.read().collection_path),</div><div>                 Some(&collection_params),</div><div>                 &payload_index_schema.read().clone(),</div><div>                 &temp_path,</div><div class="diff-info">@@ -982,9 +949,9 @@ impl LocalShard {</div><div>             .map_err(CollectionError::from)</div><div>     }</div><div> </div><div class="diff-removed">-    pub fn estimate_cardinality<'a>(</div><div class="diff-removed">-        &'a self,</div><div class="diff-removed">-        filter: Option<&'a Filter>,</div><div class="diff-added">+    pub fn estimate_cardinality(</div><div class="diff-added">+        &self,</div><div class="diff-added">+        filter: Option<&Filter>,</div><div>         hw_counter: &HardwareCounterCell,</div><div>     ) -> CollectionResult<CardinalityEstimation> {</div><div>         let segments = self.segments().read();</div><div class="diff-info">@@ -1007,9 +974,9 @@ impl LocalShard {</div><div>         Ok(cardinality)</div><div>     }</div><div> </div><div class="diff-removed">-    pub async fn read_filtered<'a>(</div><div class="diff-removed">-        &'a self,</div><div class="diff-removed">-        filter: Option<&'a Filter>,</div><div class="diff-added">+    pub async fn read_filtered(</div><div class="diff-added">+        &self,</div><div class="diff-added">+        filter: Option<&Filter>,</div><div>         runtime_handle: &Handle,</div><div>         hw_counter: HwMeasurementAcc,</div><div>     ) -> CollectionResult<BTreeSet<PointIdType>> {</div><div class="diff-info">@@ -1109,9 +1076,6 @@ impl LocalShard {</div><div>         &self.update_tracker</div><div>     }</div><div> </div><div class="diff-removed">-    /// Get the recovery point for the current shard</div><div class="diff-removed">-    ///</div><div class="diff-removed">-    /// This is sourced from the last seen clocks from other nodes that we know about.</div><div>     pub async fn recovery_point(&self) -> RecoveryPoint {</div><div>         self.wal.recovery_point().await</div><div>     }</div><div class="diff-info">@@ -1244,7 +1208,6 @@ impl LocalShardClocks {</div><div>             let oldest_clocks_to = Self::oldest_clocks_path(to);</div><div>             move_file(oldest_clocks_from, oldest_clocks_to).await?;</div><div>         }</div><div class="diff-removed">-</div><div>         Ok(())</div><div>     }</div><div> </div><div class="diff-info">@@ -1260,7 +1223,6 @@ impl LocalShardClocks {</div><div>         if oldest_clocks_path.exists() {</div><div>             remove_file(oldest_clocks_path).await?;</div><div>         }</div><div class="diff-removed">-</div><div>         Ok(())</div><div>     }</div><div> </div><div></div></pre>
                </div>
            </div>
        </section>
    </main>
    <footer>
        <p>LoCoDiff-bench - <a href="https://github.com/AbanteAI/LoCoDiff-bench">GitHub Repository</a></p>
    </footer>
</body>
</html>
    