<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case: lib/collection/src/collection_manager/optimizers/indexing_optimizer.rs - GPT-4.1</title>
    <link rel="stylesheet" href="../../styles.css">
</head>
<body>
    <header>
        <h1>Case: lib/collection/src/collection_manager/optimizers/indexing_optimizer.rs</h1>
        <h2>Model: GPT-4.1</h2>
        <p><a href="../../models/openai_gpt-4.1.html">All GPT-4.1 Cases</a> | <a href="../../cases.html">All Cases</a> | <a href="../../index.html">Home</a></p>
    </header>
    <main>
        <section class="case-details">
            <div class="case-info">
                <h2>Benchmark Case Information</h2>
                <p><strong>Model:</strong> GPT-4.1</p>
                <p><strong>Status:</strong> <span class="failure">Failure</span></p>
                <p><strong>Prompt Tokens:</strong> 58760</p>
                <p><strong>Native Prompt Tokens:</strong> 58973</p>
                <p><strong>Native Completion Tokens:</strong> 8092</p>
                <p><strong>Native Tokens Reasoning:</strong> 0</p>
                <p><strong>Native Finish Reason:</strong> stop</p>
                <p><strong>Cost:</strong> $0.0091341</p>
            </div>
            
            <div class="content-links">
                <h2>View Content</h2>
                <ul>
                    <li><a href="../../content/openai_gpt-4.1/qdrant_lib_collection_src_collection_manager_optimizers_indexing_optimizer.rs/prompt.html" class="content-link">View Prompt</a></li>
                    <li><a href="../../content/openai_gpt-4.1/qdrant_lib_collection_src_collection_manager_optimizers_indexing_optimizer.rs/expected.html" class="content-link">View Expected Output</a></li>
                    <li><a href="../../content/openai_gpt-4.1/qdrant_lib_collection_src_collection_manager_optimizers_indexing_optimizer.rs/actual.html" class="content-link">View Actual Output</a></li>
                </ul>
            </div>
            
            <div class="diff-section">
                <h2>Diff (Expected vs Actual)</h2>
                <div id="diff-output">
                    <pre class="diff"><div></div><div>index 237415b4..a1f0bc3f 100644</div><div class="diff-header">--- a/qdrant_lib_collection_src_collection_manager_optimizers_indexing_optimizer.rs_expectedoutput.txt (expected):tmp/tmpmum5f90b_expected.txt	</div><div class="diff-header">+++ b/qdrant_lib_collection_src_collection_manager_optimizers_indexing_optimizer.rs_extracted.txt (actual):tmp/tmpn9p1mq0y_actual.txt	</div><div class="diff-info">@@ -295,7 +295,6 @@ mod tests {</div><div>     use segment::index::hnsw_index::num_rayon_threads;</div><div>     use segment::json_path::JsonPath;</div><div>     use segment::payload_json;</div><div class="diff-removed">-    use segment::segment_constructor::simple_segment_constructor::{VECTOR1_NAME, VECTOR2_NAME};</div><div>     use segment::types::{Distance, PayloadSchemaType, VectorNameBuf};</div><div>     use tempfile::Builder;</div><div> </div><div class="diff-info">@@ -417,8 +416,8 @@ mod tests {</div><div> </div><div>         for config in configs {</div><div>             assert_eq!(config.vector_data.len(), 2);</div><div class="diff-removed">-            assert_eq!(config.vector_data.get(VECTOR1_NAME).unwrap().size, dim1);</div><div class="diff-removed">-            assert_eq!(config.vector_data.get(VECTOR2_NAME).unwrap().size, dim2);</div><div class="diff-added">+            assert_eq!(config.vector_data.get(super::VECTOR1_NAME).unwrap().size, dim1);</div><div class="diff-added">+            assert_eq!(config.vector_data.get(super::VECTOR2_NAME).unwrap().size, dim2);</div><div>         }</div><div>     }</div><div> </div><div class="diff-info">@@ -464,19 +463,15 @@ mod tests {</div><div>             segments_dir.path().to_owned(),</div><div>             segments_temp_dir.path().to_owned(),</div><div>             CollectionParams {</div><div class="diff-removed">-                vectors: VectorsConfig::Single(</div><div class="diff-removed">-                    VectorParamsBuilder::new(</div><div class="diff-removed">-                        segment_config.vector_data[DEFAULT_VECTOR_NAME].size as u64,</div><div class="diff-removed">-                        segment_config.vector_data[DEFAULT_VECTOR_NAME].distance,</div><div class="diff-removed">-                    )</div><div class="diff-removed">-                    .build(),</div><div class="diff-removed">-                ),</div><div class="diff-added">+                vectors: VectorsConfig::Single(VectorParamsBuilder::new(</div><div class="diff-added">+                    segment_config.vector_data[DEFAULT_VECTOR_NAME].size as u64,</div><div class="diff-added">+                    segment_config.vector_data[DEFAULT_VECTOR_NAME].distance,</div><div class="diff-added">+                ).build()),</div><div>                 ..CollectionParams::empty()</div><div>             },</div><div>             Default::default(),</div><div>             Default::default(),</div><div>         );</div><div class="diff-removed">-</div><div>         let locked_holder: Arc<RwLock<_, _>> = Arc::new(RwLock::new(holder));</div><div> </div><div>         let excluded_ids = Default::default();</div><div class="diff-info">@@ -525,15 +520,137 @@ mod tests {</div><div>         )</div><div>         .unwrap();</div><div> </div><div class="diff-added">+        let infos = locked_holder</div><div class="diff-added">+            .read()</div><div class="diff-added">+            .iter()</div><div class="diff-added">+            .map(|(_sid, segment)| segment.get().read().info())</div><div class="diff-added">+            .collect_vec();</div><div class="diff-added">+</div><div class="diff-added">+        for info in &infos {</div><div class="diff-added">+            assert!(</div><div class="diff-added">+                info.index_schema.contains_key(&payload_field),</div><div class="diff-added">+                "Testing that payload is not lost"</div><div class="diff-added">+            );</div><div class="diff-added">+            assert_eq!(</div><div class="diff-added">+                info.index_schema[&payload_field].data_type,</div><div class="diff-added">+                PayloadSchemaType::Integer,</div><div class="diff-added">+                "Testing that payload type is not lost"</div><div class="diff-added">+            );</div><div class="diff-added">+        }</div><div class="diff-added">+</div><div class="diff-added">+        let point_payload = payload_json! {"number": 10000i64};</div><div class="diff-added">+</div><div class="diff-added">+        let batch = BatchPersisted {</div><div class="diff-added">+            ids: vec![501.into(), 502.into(), 503.into()],</div><div class="diff-added">+            vectors: BatchVectorStructPersisted::Single(vec![</div><div class="diff-added">+                random_vector(&mut rng, dim),</div><div class="diff-added">+                random_vector(&mut rng, dim),</div><div class="diff-added">+                random_vector(&mut rng, dim),</div><div class="diff-added">+            ]),</div><div class="diff-added">+            payloads: Some(vec![</div><div class="diff-added">+                Some(point_payload.clone()),</div><div class="diff-added">+                Some(point_payload.clone()),</div><div class="diff-added">+                Some(point_payload),</div><div class="diff-added">+            ]),</div><div class="diff-added">+        };</div><div class="diff-added">+</div><div class="diff-added">+        let insert_point_ops =</div><div class="diff-added">+            PointOperations::UpsertPoints(PointInsertOperationsInternal::from(batch));</div><div class="diff-added">+</div><div class="diff-added">+        let smallest_size = infos</div><div class="diff-added">+            .iter()</div><div class="diff-added">+            .min_by_key(|info| info.num_vectors)</div><div class="diff-added">+            .unwrap()</div><div class="diff-added">+            .num_vectors;</div><div class="diff-added">+</div><div class="diff-added">+        let hw_counter = HardwareCounterCell::new();</div><div class="diff-added">+</div><div class="diff-added">+        process_point_operation(</div><div class="diff-added">+            locked_holder.deref(),</div><div class="diff-added">+            opnum.next().unwrap(),</div><div class="diff-added">+            insert_point_ops,</div><div class="diff-added">+            &hw_counter,</div><div class="diff-added">+        )</div><div class="diff-added">+        .unwrap();</div><div class="diff-added">+</div><div class="diff-added">+        let new_infos = locked_holder</div><div class="diff-added">+            .read()</div><div class="diff-added">+            .iter()</div><div class="diff-added">+            .map(|(_sid, segment)| segment.get().read().info())</div><div class="diff-added">+            .collect_vec();</div><div class="diff-added">+        let new_smallest_size = new_infos</div><div class="diff-added">+            .iter()</div><div class="diff-added">+            .min_by_key(|info| info.num_vectors)</div><div class="diff-added">+            .unwrap()</div><div class="diff-added">+            .num_vectors;</div><div class="diff-added">+</div><div class="diff-added">+        assert_eq!(</div><div class="diff-added">+            new_smallest_size,</div><div class="diff-added">+            smallest_size + 3,</div><div class="diff-added">+            "Testing that new data is added to an appendable segment only"</div><div class="diff-added">+        );</div><div class="diff-added">+</div><div class="diff-added">+        let suggested_to_optimize =</div><div class="diff-added">+            index_optimizer.check_condition(locked_holder.clone(), &excluded_ids);</div><div class="diff-added">+        assert!(suggested_to_optimize.contains(&large_segment_id));</div><div>         let permit_cpu_count = num_rayon_threads(0);</div><div>         let budget = ResourceBudget::new(permit_cpu_count, permit_cpu_count);</div><div>         let permit = budget.try_acquire(0, permit_cpu_count).unwrap();</div><div class="diff-added">+        index_optimizer</div><div class="diff-added">+            .optimize(</div><div class="diff-added">+                locked_holder.clone(),</div><div class="diff-added">+                suggested_to_optimize,</div><div class="diff-added">+                permit,</div><div class="diff-added">+                budget.clone(),</div><div class="diff-added">+                &stopped,</div><div class="diff-added">+            )</div><div class="diff-added">+            .unwrap();</div><div class="diff-added">+</div><div class="diff-added">+        let infos = locked_holder</div><div class="diff-added">+            .read()</div><div class="diff-added">+            .iter()</div><div class="diff-added">+            .map(|(_sid, segment)| segment.get().read().info())</div><div class="diff-added">+            .collect_vec();</div><div class="diff-added">+        let configs = locked_holder</div><div class="diff-added">+            .read()</div><div class="diff-added">+            .iter()</div><div class="diff-added">+            .map(|(_sid, segment)| segment.get().read().config().clone())</div><div class="diff-added">+            .collect_vec();</div><div class="diff-added">+</div><div class="diff-added">+        assert_eq!(</div><div class="diff-added">+            infos.len(),</div><div class="diff-added">+            2,</div><div class="diff-added">+            "Testing info length after the optimization"</div><div class="diff-added">+        );</div><div class="diff-added">+        assert_eq!(</div><div class="diff-added">+            configs.len(),</div><div class="diff-added">+            2,</div><div class="diff-added">+            "Testing configs length after the optimization"</div><div class="diff-added">+        );</div><div class="diff-added">+</div><div class="diff-added">+        let indexed_count = infos</div><div class="diff-added">+            .iter()</div><div class="diff-added">+            .filter(|info| info.segment_type == SegmentType::Indexed)</div><div class="diff-added">+            .count();</div><div class="diff-added">+        assert_eq!(</div><div class="diff-added">+            indexed_count, 2,</div><div class="diff-added">+            "Testing that 2 segments are actually indexed"</div><div class="diff-added">+        );</div><div class="diff-added">+</div><div class="diff-added">+        let on_disk_count = configs</div><div class="diff-added">+            .iter()</div><div class="diff-added">+            .filter(|config| config.is_any_on_disk())</div><div class="diff-added">+            .count();</div><div class="diff-added">+        assert_eq!(</div><div class="diff-added">+            on_disk_count, 1,</div><div class="diff-added">+            "Testing that only largest segment is not Mmap"</div><div class="diff-added">+        );</div><div> </div><div>         // ------ Plain -> Mmap & Indexed payload</div><div>         let suggested_to_optimize =</div><div>             index_optimizer.check_condition(locked_holder.clone(), &excluded_ids);</div><div class="diff-removed">-        assert!(suggested_to_optimize.contains(&large_segment_id));</div><div class="diff-removed">-        eprintln!("suggested_to_optimize = {suggested_to_optimize:#?}");</div><div class="diff-added">+        log::debug!("suggested_to_optimize = {suggested_to_optimize:#?}");</div><div class="diff-added">+        let permit = budget.try_acquire(0, permit_cpu_count).unwrap();</div><div>         index_optimizer</div><div>             .optimize(</div><div>                 locked_holder.clone(),</div><div class="diff-info">@@ -543,7 +660,7 @@ mod tests {</div><div>                 &stopped,</div><div>             )</div><div>             .unwrap();</div><div class="diff-removed">-        eprintln!("Done");</div><div class="diff-added">+        log::debug!("Done");</div><div> </div><div>         // ------ Plain -> Indexed payload</div><div>         let permit = budget.try_acquire(0, permit_cpu_count).unwrap();</div><div class="diff-info">@@ -567,16 +684,11 @@ mod tests {</div><div> </div><div>         assert_eq!(</div><div>             locked_holder.read().len(),</div><div class="diff-removed">-            3,</div><div class="diff-added">+            2,</div><div>             "Testing no new segments were created"</div><div>         );</div><div> </div><div class="diff-removed">-        let infos = locked_holder</div><div class="diff-removed">-            .read()</div><div class="diff-removed">-            .iter()</div><div class="diff-removed">-            .map(|(_sid, segment)| segment.get().read().info())</div><div class="diff-removed">-            .collect_vec();</div><div class="diff-removed">-        let configs = locked_holder</div><div class="diff-added">+        let new_configs = locked_holder</div><div>             .read()</div><div>             .iter()</div><div>             .map(|(_sid, segment)| segment.get().read().config().clone())</div><div class="diff-info">@@ -591,7 +703,7 @@ mod tests {</div><div>             "Testing that 2 segments are actually indexed"</div><div>         );</div><div> </div><div class="diff-removed">-        let on_disk_count = configs</div><div class="diff-added">+        let on_disk_count = new_configs</div><div>             .iter()</div><div>             .filter(|config| config.is_any_on_disk())</div><div>             .count();</div><div class="diff-info">@@ -671,6 +783,8 @@ mod tests {</div><div>             "Testing that new data is added to an appendable segment only"</div><div>         );</div><div> </div><div class="diff-added">+        let large_segment_id = *locked_holder.read().iter().next().unwrap().0;</div><div class="diff-added">+</div><div>         // ---- New appendable segment should be created if none left</div><div> </div><div>         // Index even the smallest segment</div><div class="diff-info">@@ -696,7 +810,7 @@ mod tests {</div><div>             .collect_vec();</div><div> </div><div>         let mut has_empty = false;</div><div class="diff-removed">-        for info in new_infos2 {</div><div class="diff-added">+        for info in new_infos2.iter() {</div><div>             has_empty |= info.num_vectors == 0;</div><div>         }</div><div> </div><div class="diff-info">@@ -718,6 +832,8 @@ mod tests {</div><div>         let insert_point_ops =</div><div>             PointOperations::UpsertPoints(PointInsertOperationsInternal::from(batch));</div><div> </div><div class="diff-added">+        let hw_counter = HardwareCounterCell::new();</div><div class="diff-added">+</div><div>         process_point_operation(</div><div>             locked_holder.deref(),</div><div>             opnum.next().unwrap(),</div><div class="diff-info">@@ -761,7 +877,7 @@ mod tests {</div><div> </div><div>         let locked_holder: Arc<RwLock<_, _>> = Arc::new(RwLock::new(holder));</div><div> </div><div class="diff-removed">-        let index_optimizer = IndexingOptimizer::new(</div><div class="diff-added">+        let mut index_optimizer = IndexingOptimizer::new(</div><div>             number_of_segments, // Keep the same number of segments</div><div>             OptimizerThresholds {</div><div>                 max_segment_size_kb: 1000,</div><div class="diff-info">@@ -881,15 +997,16 @@ mod tests {</div><div>                 dir.path().to_owned(),</div><div>                 temp_dir.path().to_owned(),</div><div>                 collection_params.clone(),</div><div class="diff-removed">-                hnsw_config.clone(),</div><div class="diff-added">+                hnsw_config,</div><div>                 Default::default(),</div><div>             );</div><div>             let config_mismatch_optimizer = ConfigMismatchOptimizer::new(</div><div class="diff-added">+                2,</div><div>                 thresholds_config,</div><div>                 dir.path().to_owned(),</div><div>                 temp_dir.path().to_owned(),</div><div>                 collection_params.clone(),</div><div class="diff-removed">-                hnsw_config.clone(),</div><div class="diff-added">+                hnsw_config,</div><div>                 Default::default(),</div><div>             );</div><div> </div><div class="diff-info">@@ -945,10 +1062,11 @@ mod tests {</div><div>             dir.path().to_owned(),</div><div>             temp_dir.path().to_owned(),</div><div>             collection_params.clone(),</div><div class="diff-removed">-            hnsw_config.clone(),</div><div class="diff-added">+            hnsw_config,</div><div>             Default::default(),</div><div>         );</div><div>         let config_mismatch_optimizer = ConfigMismatchOptimizer::new(</div><div class="diff-added">+            2,</div><div>             thresholds_config,</div><div>             dir.path().to_owned(),</div><div>             temp_dir.path().to_owned(),</div><div></div></pre>
                </div>
            </div>
        </section>
    </main>
    <footer>
        <p>LoCoDiff-bench - <a href="https://github.com/AbanteAI/LoCoDiff-bench">GitHub Repository</a></p>
    </footer>
</body>
</html>
    