<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case: lib/segment/src/payload_storage/query_checker.rs - Gemini 2.5 Flash Thinking</title>
    <link rel="stylesheet" href="../../styles.css">
</head>
<body>
    <header>
        <h1>Case: lib/segment/src/payload_storage/query_checker.rs</h1>
        <p><a href="../../models/google_gemini-2.5-flash-previewthinking.html">‚Üê Back to Gemini 2.5 Flash Thinking Cases</a> | <a href="../../index.html">Home</a></p>
    </header>
    <main>
        <section class="case-details">
            <div class="case-info">
                <h2>Benchmark Case Information</h2>
                <p><strong>Model:</strong> Gemini 2.5 Flash Thinking</p>
                <p><strong>Status:</strong> <span class="failure">Failure</span></p>
                <p><strong>Prompt Tokens:</strong> 59599</p>
                <p><strong>Output Tokens:</strong> N/A</p>
                <p><strong>Native Prompt Tokens:</strong> 76420</p>
                <p><strong>Native Completion Tokens:</strong> 16988</p>
                <p><strong>Native Tokens Reasoning:</strong> 9214</p>
                <p><strong>Native Finish Reason:</strong> STOP</p>
                <p><strong>Runtime:</strong> N/As</p>
                <p><strong>Cost:</strong> $0.070921</p>
            </div>
            
            <div class="content-links">
                <h2>View Content</h2>
                <ul>
                    <li><a href="../../content/google_gemini-2.5-flash-previewthinking/qdrant_lib_segment_src_payload_storage_query_checker.rs/prompt.html" class="content-link">View Prompt</a></li>
                    <li><a href="../../content/google_gemini-2.5-flash-previewthinking/qdrant_lib_segment_src_payload_storage_query_checker.rs/expected.html" class="content-link">View Expected Output</a></li>
                    <li><a href="../../content/google_gemini-2.5-flash-previewthinking/qdrant_lib_segment_src_payload_storage_query_checker.rs/actual.html" class="content-link">View Actual Output</a></li>
                </ul>
            </div>
            
            <div class="diff-section">
                <h2>Diff (Expected vs Actual)</h2>
                <div id="diff-output">
                    <pre class="diff"><div class="diff-header">--- qdrant_lib_segment_src_payload_storage_query_checker.rs_expectedoutput.txt (expected)+++ qdrant_lib_segment_src_payload_storage_query_checker.rs_extracted.txt (actual)@@ -9,9 +9,10 @@ use common::counter::hardware_counter::HardwareCounterCell;</div><div> use common::types::PointOffsetType;</div><div> </div><div class="diff-removed">-use crate::common::utils::{IndexesMap, check_is_empty, check_is_null};</div><div class="diff-removed">-use crate::id_tracker::IdTrackerSS;</div><div class="diff-added">+use crate::common::utils::{check_is_empty, check_is_null, IndexesMap};</div><div class="diff-added">+use crate::id_tracker::{IdTracker, IdTrackerSS};</div><div> use crate::index::field_index::FieldIndex;</div><div class="diff-added">+use crate::json_path::JsonPath;</div><div> use crate::payload_storage::condition_checker::ValueChecker;</div><div> use crate::payload_storage::payload_storage_enum::PayloadStorageEnum;</div><div> use crate::payload_storage::{ConditionChecker, PayloadStorage};</div><div class="diff-info">@@ -62,14 +63,7 @@         Some(MinShould {</div><div>             conditions,</div><div>             min_count,</div><div class="diff-removed">-        }) => {</div><div class="diff-removed">-            conditions</div><div class="diff-removed">-                .iter()</div><div class="diff-removed">-                .filter(|cond| check(cond))</div><div class="diff-removed">-                .take(*min_count)</div><div class="diff-removed">-                .count()</div><div class="diff-removed">-                == *min_count</div><div class="diff-removed">-        }</div><div class="diff-added">+        }) => conditions.iter().filter(|cond| check(cond)).take(*min_count).count() == *min_count,</div><div>     }</div><div> }</div><div> </div><div class="diff-info">@@ -102,16 +96,19 @@ where</div><div>     R: AsRef<Vec<FieldIndex>>,</div><div> {</div><div class="diff-removed">-    let nested_indexes: HashMap<_, _> = field_indexes</div><div class="diff-added">+    field_indexes</div><div>         .iter()</div><div>         .filter_map(|(key, indexes)| {</div><div>             key.strip_prefix(nested_path)</div><div class="diff-removed">-                .map(|key| (key, indexes.as_ref()))</div><div class="diff-added">+                .map(|key| (key.into(), indexes.as_ref()))</div><div>         })</div><div class="diff-removed">-        .collect();</div><div class="diff-removed">-    nested_indexes</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-added">+        .collect()</div><div class="diff-added">+}</div><div class="diff-added">+</div><div class="diff-added">+// NOTE: `id_tracker`, `vector_storages` and `field_indexes` are only passed</div><div class="diff-added">+// for nested filters. The top-level check provides appropriate values there where</div><div class="diff-added">+// necessary. This is an optimization to avoid passing the full segment state</div><div class="diff-added">+// to the payload checker.</div><div> pub fn check_payload<'a, R>(</div><div>     get_payload: Box<dyn Fn() -> OwnedPayloadRef<'a> + 'a>,</div><div>     id_tracker: Option<&IdTrackerSS>,</div><div class="diff-info">@@ -145,9 +142,9 @@         }</div><div>         Condition::Nested(nested) => {</div><div>             let nested_path = nested.array_key();</div><div class="diff-removed">-            let nested_indexes = select_nested_indexes(&nested_path, field_indexes);</div><div class="diff-added">+            let nested_indexes = select_nested_indexes(nested_path, field_indexes);</div><div>             get_payload()</div><div class="diff-removed">-                .get_value(&nested_path)</div><div class="diff-added">+                .get_value(nested_path)</div><div>                 .iter()</div><div>                 .filter_map(|value| value.as_object())</div><div>                 .any(|object| {</div><div class="diff-info">@@ -213,7 +210,7 @@                         return true;</div><div>                     }</div><div>                     index_checked = true;</div><div class="diff-removed">-                    // If index check of the condition returned something, we don't need to check</div><div class="diff-added">+                    // If none of the indexes returned anything, we don't need to check</div><div>                     // other indexes</div><div>                     break;</div><div>                 }</div><div class="diff-info">@@ -316,28 +313,32 @@             query,</div><div>             point_id,</div><div>             &IndexesMap::new(),</div><div class="diff-removed">-            &HardwareCounterCell::new(),</div><div class="diff-added">+            &hw_counter,</div><div>         )</div><div>     }</div><div> }</div><div> </div><div> #[cfg(test)]</div><div> mod tests {</div><div class="diff-added">+    use std::collections::HashMap;</div><div>     use std::str::FromStr;</div><div class="diff-added">+    use std::sync::Arc;</div><div> </div><div>     use ahash::AHashSet;</div><div class="diff-added">+    use atomic_refcell::AtomicRefCell;</div><div class="diff-added">+    use common::counter::hardware_counter::HardwareCounterCell;</div><div>     use tempfile::Builder;</div><div> </div><div>     use super::*;</div><div class="diff-removed">-    use crate::common::rocksdb_wrapper::{DB_VECTOR_CF, open_db};</div><div class="diff-added">+    use crate::common::rocksdb_wrapper::{open_db, DB_VECTOR_CF};</div><div>     use crate::id_tracker::IdTracker;</div><div>     use crate::id_tracker::simple_id_tracker::SimpleIdTracker;</div><div>     use crate::json_path::JsonPath;</div><div>     use crate::payload_json;</div><div class="diff-added">+    use crate::payload_storage::simple_payload_storage::SimplePayloadStorage;</div><div>     use crate::payload_storage::PayloadStorage;</div><div class="diff-removed">-    use crate::payload_storage::simple_payload_storage::SimplePayloadStorage;</div><div>     use crate::types::{</div><div class="diff-removed">-        DateTimeWrapper, FieldCondition, GeoBoundingBox, GeoPoint, PayloadField, Range, ValuesCount,</div><div class="diff-added">+        DateTimeWrapper, FieldCondition, FilterSelector, GeoBoundingBox, GeoPoint, MinShould, NestedCondition, PayloadField, Range, ValuesCount,</div><div>     };</div><div> </div><div>     #[test]</div><div class="diff-info">@@ -352,13 +353,22 @@             },</div><div>             "price": 499.90,</div><div>             "amount": 10,</div><div class="diff-removed">-            "rating": vec![3, 7, 9, 9],</div><div class="diff-added">+            "rating": [3, 7, 9, 9],</div><div>             "color": "red",</div><div>             "has_delivery": true,</div><div>             "shipped_at": "2020-02-15T00:00:00Z",</div><div>             "parts": [],</div><div>             "packaging": null,</div><div>             "not_null": [null],</div><div class="diff-added">+            "tags": [</div><div class="diff-added">+                {"name": "tag1", "value": 1},</div><div class="diff-added">+                {"name": "tag2", "value": 2},</div><div class="diff-added">+            ],</div><div class="diff-added">+            "features": [</div><div class="diff-added">+                {"name": "feat1", "amount": 10, "source": {"producer": "prod1"}},</div><div class="diff-added">+                {"name": "feat2", "amount": 20, "source": {"producer": "prod2"}},</div><div class="diff-added">+                {"name": "feat3", "amount": 10, "source": {"producer": "prod3", "codes": [1, 2, 3]}},</div><div class="diff-added">+            ]</div><div>         };</div><div> </div><div>         let hw_counter = HardwareCounterCell::new();</div><div class="diff-info">@@ -379,6 +389,7 @@             HashMap::new(),</div><div>         );</div><div> </div><div class="diff-added">+        // is_empty</div><div>         let is_empty_condition = Filter::new_must(Condition::IsEmpty(IsEmptyCondition {</div><div>             is_empty: PayloadField {</div><div>                 key: JsonPath::new("price"),</div><div class="diff-info">@@ -407,6 +418,7 @@         }));</div><div>         assert!(!payload_checker.check(0, &is_empty_condition));</div><div> </div><div class="diff-added">+        // is_null</div><div>         let is_null_condition = Filter::new_must(Condition::IsNull(IsNullCondition {</div><div>             is_null: PayloadField {</div><div>                 key: JsonPath::new("amount"),</div><div class="diff-info">@@ -442,6 +454,7 @@         }));</div><div>         assert!(!payload_checker.check(0, &is_null_condition));</div><div> </div><div class="diff-added">+        // match</div><div>         let match_red = Condition::Field(FieldCondition::new_match(</div><div>             JsonPath::new("color"),</div><div>             "red".to_owned().into(),</div><div class="diff-info">@@ -450,6 +463,8 @@             JsonPath::new("color"),</div><div>             "blue".to_owned().into(),</div><div>         ));</div><div class="diff-added">+</div><div class="diff-added">+        // datetime range</div><div>         let shipped_in_february = Condition::Field(FieldCondition::new_datetime_range(</div><div>             JsonPath::new("shipped_at"),</div><div>             Range {</div><div class="diff-info">@@ -468,11 +483,14 @@                 lte: None,</div><div>             },</div><div>         ));</div><div class="diff-added">+</div><div class="diff-added">+        // match (boolean)</div><div>         let with_delivery = Condition::Field(FieldCondition::new_match(</div><div>             JsonPath::new("has_delivery"),</div><div>             true.into(),</div><div>         ));</div><div> </div><div class="diff-added">+        // values count</div><div>         let many_value_count_condition =</div><div>             Filter::new_must(Condition::Field(FieldCondition::new_values_count(</div><div>                 JsonPath::new("rating"),</div><div class="diff-info">@@ -497,6 +515,7 @@             )));</div><div>         assert!(payload_checker.check(0, &few_value_count_condition));</div><div> </div><div class="diff-added">+        // geo bounding box</div><div>         let in_berlin = Condition::Field(FieldCondition::new_geo_bounding_box(</div><div>             JsonPath::new("location"),</div><div>             GeoBoundingBox {</div><div class="diff-info">@@ -525,6 +544,7 @@             },</div><div>         ));</div><div> </div><div class="diff-added">+        // range</div><div>         let with_bad_rating = Condition::Field(FieldCondition::new_range(</div><div>             JsonPath::new("rating"),</div><div>             Range {</div><div class="diff-info">@@ -535,18 +555,23 @@             },</div><div>         ));</div><div> </div><div class="diff-added">+        // Combinations</div><div class="diff-added">+</div><div class="diff-added">+        // must</div><div>         let query = Filter::new_must(match_red.clone());</div><div>         assert!(payload_checker.check(0, &query));</div><div> </div><div>         let query = Filter::new_must(match_blue.clone());</div><div>         assert!(!payload_checker.check(0, &query));</div><div> </div><div class="diff-added">+        // must_not</div><div>         let query = Filter::new_must_not(match_blue.clone());</div><div>         assert!(payload_checker.check(0, &query));</div><div> </div><div>         let query = Filter::new_must_not(match_red.clone());</div><div>         assert!(!payload_checker.check(0, &query));</div><div> </div><div class="diff-added">+        // should</div><div>         let query = Filter {</div><div>             should: Some(vec![match_red.clone(), match_blue.clone()]),</div><div>             min_should: None,</div><div class="diff-info">@@ -563,6 +588,7 @@         };</div><div>         assert!(!payload_checker.check(0, &query));</div><div> </div><div class="diff-added">+        // should filter</div><div>         let query = Filter {</div><div>             should: Some(vec![</div><div>                 Condition::Filter(Filter {</div><div class="diff-info">@@ -662,5 +688,65 @@ </div><div>         let query = Filter::new_must(Condition::HasId(ids.into()));</div><div>         assert!(payload_checker.check(2, &query));</div><div class="diff-added">+</div><div class="diff-added">+        // Nested filters</div><div class="diff-added">+        let nested_match_tag1 = Condition::Nested(NestedCondition {</div><div class="diff-added">+            array_key: JsonPath::new("tags"),</div><div class="diff-added">+            nested: FilterSelector { filter: Box::new(Filter::new_must(Condition::Field(FieldCondition::new_match(JsonPath::new("name"), "tag1".to_owned().into()))))},</div><div class="diff-added">+        });</div><div class="diff-added">+        assert!(payload_checker.check(0, &Filter::new_must(nested_match_tag1)));</div><div class="diff-added">+</div><div class="diff-added">+        let nested_match_tag3 = Condition::Nested(NestedCondition {</div><div class="diff-added">+             array_key: JsonPath::new("tags"),</div><div class="diff-added">+            nested: FilterSelector { filter: Box::new(Filter::new_must(Condition::Field(FieldCondition::new_match(JsonPath::new("name"), "tag3".to_owned().into()))))},</div><div class="diff-added">+        });</div><div class="diff-added">+        assert!(!payload_checker.check(0, &Filter::new_must(nested_match_tag3)));</div><div class="diff-added">+</div><div class="diff-added">+        let nested_empty_tag = Condition::Nested(NestedCondition {</div><div class="diff-added">+            array_key: JsonPath::new("tags"),</div><div class="diff-added">+            nested: FilterSelector { filter: Box::new(Filter::new_must(Condition::IsEmpty(IsEmptyCondition { is_empty: PayloadField { key: JsonPath::new("name") } })))},</div><div class="diff-added">+        });</div><div class="diff-added">+        assert!(!payload_checker.check(0, &Filter::new_must(nested_empty_tag.clone())));</div><div class="diff-added">+</div><div class="diff-added">+        let nested_range_value_1_to_2 = Condition::Nested(NestedCondition {</div><div class="diff-added">+            array_key: JsonPath::new("tags"),</div><div class="diff-added">+            nested: FilterSelector { filter: Box::new(Filter::new_must(Condition::Field(FieldCondition::new_range(JsonPath::new("value"), Range { lt: Some(3.0), gt: Some(0.0), gte: None, lte: None } ))))},</div><div class="diff-added">+        });</div><div class="diff-added">+        assert!(payload_checker.check(0, &Filter::new_must(nested_range_value_1_to_2)));</div><div class="diff-added">+</div><div class="diff-added">+        let nested_range_value_greater_than_2 = Condition::Nested(NestedCondition {</div><div class="diff-added">+            array_key: JsonPath::new("tags"),</div><div class="diff-added">+            nested: FilterSelector { filter: Box::new(Filter::new_must(Condition::Field(FieldCondition::new_range(JsonPath::new("value"), Range { lt: None, gt: Some(2.0), gte: None, lte: None } )))) },</div><div class="diff-added">+        });</div><div class="diff-added">+        assert!(!payload_checker.check(0, &Filter::new_must(nested_range_value_greater_than_2)));</div><div class="diff-added">+</div><div class="diff-added">+        let nested_filter_combined_feature_1 = Condition::Nested(NestedCondition {</div><div class="diff-added">+            array_key: JsonPath::new("features"),</div><div class="diff-added">+            nested: FilterSelector { filter: Box::new(Filter::new_must(vec![</div><div class="diff-added">+                Condition::Field(FieldCondition::new_match(JsonPath::new("name"), "feat1".to_owned().into())),</div><div class="diff-added">+                Condition::Field(FieldCondition::new_range(JsonPath::new("amount"), Range { lt: Some(20.0), gt: None, gte: Some(10.0), lte: None })),</div><div class="diff-added">+                Condition::Nested(NestedCondition {</div><div class="diff-added">+                    array_key: JsonPath::new("source"),</div><div class="diff-added">+                    nested: FilterSelector { filter: Box::new(Filter::new_must(Condition::Field(FieldCondition::new_match(JsonPath::new("producer"), "prod1".to_owned().into()))))},</div><div class="diff-added">+                }),</div><div class="diff-added">+            ]))},</div><div class="diff-added">+        });</div><div class="diff-added">+        assert!(payload_checker.check(0, &Filter::new_must(nested_filter_combined_feature_1)));</div><div class="diff-added">+</div><div class="diff-added">+        let nested_filter_combined_feature_3 = Condition::Nested(NestedCondition {</div><div class="diff-added">+            array_key: JsonPath::new("features"),</div><div class="diff-added">+            nested: FilterSelector { filter: Box::new(Filter::new_must(vec![</div><div class="diff-added">+                Condition::Field(FieldCondition::new_match(JsonPath::new("name"), "feat3".to_owned().into())),</div><div class="diff-added">+                Condition::Nested(NestedCondition {</div><div class="diff-added">+                    array_key: JsonPath::new("source"),</div><div class="diff-added">+                    nested: FilterSelector { filter: Box::new(Filter::new_must(vec![</div><div class="diff-added">+                       Condition::Field(FieldCondition::new_match(JsonPath::new("producer"), "prod3".to_owned().into())),</div><div class="diff-added">+                       Condition::Field(FieldCondition::new_match(JsonPath::new("codes"), 2.into())),</div><div class="diff-added">+                    ]))},</div><div class="diff-added">+                }),</div><div class="diff-added">+            ]))},</div><div class="diff-added">+        });</div><div class="diff-added">+</div><div class="diff-added">+        assert!(payload_checker.check(0, &Filter::new_must(nested_filter_combined_feature_3)));</div><div>     }</div><div> }</div></pre>
                </div>
            </div>
        </section>
    </main>
    <footer>
        <p>LoCoDiff-bench - <a href="https://github.com/AbanteAI/LoCoDiff-bench">GitHub Repository</a></p>
    </footer>
</body>
</html>
    