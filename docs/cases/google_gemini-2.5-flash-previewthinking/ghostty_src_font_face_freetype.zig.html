<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case: src/font/face/freetype.zig - Gemini 2.5 Flash Thinking</title>
    <link rel="stylesheet" href="../../styles.css">
</head>
<body>
    <header>
        <h1>Case: src/font/face/freetype.zig</h1>
        <h2>Model: Gemini 2.5 Flash Thinking</h2>
        <p><a href="../../models/google_gemini-2.5-flash-previewthinking.html">All Gemini 2.5 Flash Thinking Cases</a> | <a href="../../cases.html">All Cases</a> | <a href="../../index.html">Home</a></p>
    </header>
    <main>
        <section class="case-details">
            <div class="case-info">
                <h2>Benchmark Case Information</h2>
                <p><strong>Model:</strong> Gemini 2.5 Flash Thinking</p>
                <p><strong>Status:</strong> <span class="failure">Failure</span></p>
                <p><strong>Prompt Tokens:</strong> 57124</p>
                <p><strong>Native Prompt Tokens:</strong> 69394</p>
                <p><strong>Native Completion Tokens:</strong> 30022</p>
                <p><strong>Native Tokens Reasoning:</strong> 18737</p>
                <p><strong>Native Finish Reason:</strong> STOP</p>
                <p><strong>Cost:</strong> $0.1154861</p>
            </div>
            
            <div class="content-links">
                <h2>View Content</h2>
                <ul>
                    <li><a href="../../content/google_gemini-2.5-flash-previewthinking/ghostty_src_font_face_freetype.zig/prompt.html" class="content-link">View Prompt</a></li>
                    <li><a href="../../content/google_gemini-2.5-flash-previewthinking/ghostty_src_font_face_freetype.zig/expected.html" class="content-link">View Expected Output</a></li>
                    <li><a href="../../content/google_gemini-2.5-flash-previewthinking/ghostty_src_font_face_freetype.zig/actual.html" class="content-link">View Actual Output</a></li>
                </ul>
            </div>
            
            <div class="diff-section">
                <h2>Diff (Expected vs Actual)</h2>
                <div id="diff-output">
                    <pre class="diff"><div></div><div>index 94dc6911..f979597a 100644</div><div class="diff-header">--- a/ghostty_src_font_face_freetype.zig_expectedoutput.txt (expected):tmp/tmp3p2cy_n0_expected.txt	</div><div class="diff-header">+++ b/ghostty_src_font_face_freetype.zig_extracted.txt (actual):tmp/tmp8aa4bhdr_actual.txt	</div><div class="diff-info">@@ -8,6 +8,7 @@ const std = @import("std");</div><div> const builtin = @import("builtin");</div><div> const freetype = @import("freetype");</div><div> const harfbuzz = @import("harfbuzz");</div><div class="diff-added">+const opentype = @import("../opentype.zig");</div><div> const stb = @import("../../stb/ghostty_src_font_face_freetype.zig_extracted.txt (actual): *const Face, buf: []u8) Allocator.Error![]const u8 {</div><div>         // We don't use this today but its possible the table below</div><div>         // returns UTF-16 in which case we'd want to use this for conversion.</div><div class="diff-info">@@ -140,8 +140,8 @@ pub const Face = struct {</div><div>         return "";</div><div>     }</div><div> </div><div class="diff-removed">-    /// Return a new face that is the same as this but also has synthetic</div><div class="diff-removed">-    /// bold applied.</div><div class="diff-added">+    // Return a new face that is the same as this but also has synthetic</div><div class="diff-added">+    // bold applied.</div><div>     pub fn syntheticBold(self: *const Face, opts: font.face.Options) !Face {</div><div>         // Increase face ref count</div><div>         self.face.ref();</div><div class="diff-info">@@ -337,9 +337,10 @@ pub const Face = struct {</div><div>             try self.face.renderGlyph(.normal);</div><div>         }</div><div> </div><div class="diff-added">+        const bitmap_ft = glyph.*.bitmap;</div><div class="diff-added">+</div><div>         // This bitmap is blank. I've seen it happen in a font, I don't know why.</div><div>         // If it is empty, we just return a valid glyph struct that does nothing.</div><div class="diff-removed">-        const bitmap_ft = glyph.*.bitmap;</div><div>         if (bitmap_ft.rows == 0) return .{</div><div>             .width = 0,</div><div>             .height = 0,</div><div class="diff-info">@@ -363,6 +364,7 @@ pub const Face = struct {</div><div>                 @panic("unsupported pixel mode");</div><div>             },</div><div>         };</div><div class="diff-added">+        // assert(atlas.format == format); // Not true if format == null</div><div> </div><div>         // If our atlas format doesn't match, look for conversions if possible.</div><div>         const bitmap_converted = if (format == null or atlas.format != format.?) blk: {</div><div class="diff-info">@@ -504,7 +506,7 @@ pub const Face = struct {</div><div>             // We can avoid a buffer copy if our atlas width and bitmap</div><div>             // width match and the bitmap pitch is just the width (meaning</div><div>             // the data is tightly packed).</div><div class="diff-removed">-            const needs_copy = !(tgt_w == bitmap.width and (bitmap.width * depth) == bitmap.pitch);</div><div class="diff-added">+            const needs_copy = !(tgt_w == bitmap.width and (@as(c_int, bitmap.width) * depth) == bitmap.pitch);</div><div> </div><div>             // If we need to copy the data, we copy it into a temporary buffer.</div><div>             const buffer = if (needs_copy) buffer: {</div><div class="diff-info">@@ -536,7 +538,7 @@ pub const Face = struct {</div><div>             //</div><div>             // NOTE(mitchellh): I don't know if this is right, this doesn't</div><div>             // _feel_ right, but it makes all my limited test cases work.</div><div class="diff-removed">-            if (self.face.hasColor() and !self.face.isScalable()) {</div><div class="diff-added">+            if (self.face.has color and !self.face.isScalable()) {</div><div>                 break :offset_y @intCast(tgt_h + (metrics.cell_height -| tgt_h) / 2);</div><div>             }</div><div> </div><div class="diff-info">@@ -582,15 +584,6 @@ pub const Face = struct {</div><div>         };</div><div>     }</div><div> </div><div class="diff-removed">-    /// Convert 16.6 pixel format to pixels based on the scale factor of the</div><div class="diff-removed">-    /// current font size.</div><div class="diff-removed">-    fn unitsToPxY(self: Face, units: i32) i32 {</div><div class="diff-removed">-        return @intCast(freetype.mulFix(</div><div class="diff-removed">-            units,</div><div class="diff-removed">-            @intCast(self.face.handle.*.size.*.metrics.y_scale),</div><div class="diff-removed">-        ) >> 6);</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div>     /// Convert 26.6 pixel format to f32</div><div>     fn f26dot6ToFloat(v: freetype.c.FT_F26Dot6) f32 {</div><div>         return @floatFromInt(v >> 6);</div><div class="diff-info">@@ -698,6 +691,7 @@ pub const Face = struct {</div><div>             };</div><div>         };</div><div> </div><div class="diff-added">+</div><div>         // Some fonts have degenerate 'post' tables where the underline</div><div>         // thickness (and often position) are 0. We consider them null</div><div>         // if this is the case and use our own fallbacks when we calculate.</div><div class="diff-info">@@ -920,8 +914,6 @@ test "color emoji" {</div><div>                 .cell_baseline = 0,</div><div>                 .underline_position = 0,</div><div>                 .underline_thickness = 0,</div><div class="diff-removed">-                .strikethrough_position = 0,</div><div class="diff-removed">-                .strikethrough_thickness = 0,</div><div>                 .overline_position = 0,</div><div>                 .overline_thickness = 0,</div><div>                 .box_thickness = 0,</div><div class="diff-info">@@ -932,6 +924,52 @@ test "color emoji" {</div><div>     }</div><div> }</div><div> </div><div class="diff-added">+test "metrics" {</div><div class="diff-added">+    const testFont = font.embedded.inconsolata;</div><div class="diff-added">+    const alloc = testing.allocator;</div><div class="diff-added">+</div><div class="diff-added">+    var lib = try Library.init();</div><div class="diff-added">+    defer lib.deinit();</div><div class="diff-added">+</div><div class="diff-added">+    var atlas = try font.Atlas.init(alloc, 512, .grayscale);</div><div class="diff-added">+    defer atlas.deinit(alloc);</div><div class="diff-added">+</div><div class="diff-added">+    var ft_font = try Face.init(</div><div class="diff-added">+        lib,</div><div class="diff-added">+        testFont,</div><div class="diff-added">+        .{ .size = .{ .points = 12, .xdpi = 96, .ydpi = 96 } },</div><div class="diff-added">+    );</div><div class="diff-added">+    defer ft_font.deinit();</div><div class="diff-added">+</div><div class="diff-added">+    try testing.expectEqual(font.Metrics.FaceMetrics{</div><div class="diff-added">+        .cell_width = 8.0,</div><div class="diff-added">+        .ascent = 13.744,</div><div class="diff-added">+        .descent = -3.04,</div><div class="diff-added">+        .line_gap = 0.0,</div><div class="diff-added">+        .underline_position = 1.92,</div><div class="diff-added">+        .underline_thickness = 0.96,</div><div class="diff-added">+        .strikethrough_position = 4.906666666666666,</div><div class="diff-added">+        .strikethrough_thickness = 0.96,</div><div class="diff-added">+        .cap_height = null,</div><div class="diff-added">+        .ex_height = null,</div><div class="diff-added">+    }, try ft_font.getMetrics());</div><div class="diff-added">+</div><div class="diff-added">+    // Resize should change metrics</div><div class="diff-added">+    try ft_font.setSize(.{ .size = .{ .points = 24, .xdpi = 96, .ydpi = 96 } });</div><div class="diff-added">+    try testing.expectEqual(font.Metrics.FaceMetrics{</div><div class="diff-added">+        .cell_width = 16.0,</div><div class="diff-added">+        .ascent = 27.488,</div><div class="diff-added">+        .descent = -6.08,</div><div class="diff-added">+        .line_gap = 0.0,</div><div class="diff-added">+        .underline_position = 3.84,</div><div class="diff-added">+        .underline_thickness = 1.92,</div><div class="diff-added">+        .strikethrough_position = 9.813333333333333,</div><div class="diff-added">+        .strikethrough_thickness = 1.92,</div><div class="diff-added">+        .cap_height = null,</div><div class="diff-added">+        .ex_height = null,</div><div class="diff-added">+    }, try ft_font.getMetrics());</div><div class="diff-added">+}</div><div class="diff-added">+</div><div> test "mono to rgba" {</div><div>     const alloc = testing.allocator;</div><div>     const testFont = font.embedded.emoji;</div><div></div></pre>
                </div>
            </div>
        </section>
    </main>
    <footer>
        <p>LoCoDiff-bench - <a href="https://github.com/AbanteAI/LoCoDiff-bench">GitHub Repository</a></p>
    </footer>
</body>
</html>
    