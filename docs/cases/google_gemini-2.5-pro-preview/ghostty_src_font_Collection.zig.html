<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case: src/font/Collection.zig - Gemini 2.5 Pro</title>
    <link rel="stylesheet" href="../../styles.css">
</head>
<body>
    <header>
        <h1>Case: src/font/Collection.zig</h1>
        <p><a href="../../models/google_gemini-2.5-pro-preview.html">‚Üê Back to Gemini 2.5 Pro Cases</a> | <a href="../../index.html">Home</a></p>
    </header>
    <main>
        <section class="case-details">
            <div class="case-info">
                <h2>Benchmark Case Information</h2>
                <p><strong>Model:</strong> Gemini 2.5 Pro</p>
                <p><strong>Status:</strong> <span class="failure">Failure</span></p>
                <p><strong>Prompt Tokens:</strong> 24732</p>
                <p><strong>Output Tokens:</strong> N/A</p>
                <p><strong>Native Prompt Tokens:</strong> 29618</p>
                <p><strong>Native Completion Tokens:</strong> 3515</p>
                <p><strong>Native Tokens Reasoning:</strong> 752</p>
                <p><strong>Native Finish Reason:</strong> None</p>
                <p><strong>Cost:</strong> $0.0721725</p>
            </div>
            
            <div class="content-links">
                <h2>View Content</h2>
                <ul>
                    <li><a href="../../content/google_gemini-2.5-pro-preview/ghostty_src_font_Collection.zig/prompt.html" class="content-link">View Prompt</a></li>
                    <li><a href="../../content/google_gemini-2.5-pro-preview/ghostty_src_font_Collection.zig/expected.html" class="content-link">View Expected Output</a></li>
                    <li><a href="../../content/google_gemini-2.5-pro-preview/ghostty_src_font_Collection.zig/actual.html" class="content-link">View Actual Output</a></li>
                </ul>
            </div>
            
            <div class="diff-section">
                <h2>Diff (Expected vs Actual)</h2>
                <div id="diff-output">
                    <pre class="diff"><div></div><div>index efd8b5f4..bd01ef49 100644</div><div class="diff-header">--- a/ghostty_src_font_Collection.zig_expectedoutput.txt (expected):tmp/tmpvbio0dxg_expected.txt	</div><div class="diff-header">+++ b/ghostty_src_font_Collection.zig_extracted.txt (actual):tmp/tmp_cyonnm9_actual.txt	</div><div class="diff-info">@@ -78,880 +78,4 @@ pub const AddError = Allocator.Error || error{</div><div> /// next in priority if others exist already, i.e. it'll be the _last_ to be</div><div> /// searched for a glyph in that list.</div><div> ///</div><div class="diff-removed">-/// The collection takes ownership of the face. The face will be deallocated</div><div class="diff-removed">-/// when the collection is deallocated.</div><div class="diff-removed">-///</div><div class="diff-removed">-/// If a loaded face is added to the collection, it should be the same</div><div class="diff-removed">-/// size as all the other faces in the collection. This function will not</div><div class="diff-removed">-/// verify or modify the size until the size of the entire collection is</div><div class="diff-removed">-/// changed.</div><div class="diff-removed">-pub fn add(</div><div class="diff-removed">-    self: *Collection,</div><div class="diff-removed">-    alloc: Allocator,</div><div class="diff-removed">-    style: Style,</div><div class="diff-removed">-    face: Entry,</div><div class="diff-removed">-) AddError!Index {</div><div class="diff-removed">-    const list = self.faces.getPtr(style);</div><div class="diff-removed">-</div><div class="diff-removed">-    // We have some special indexes so we must never pass those.</div><div class="diff-removed">-    const idx = list.count();</div><div class="diff-removed">-    if (idx >= Index.Special.start - 1)</div><div class="diff-removed">-        return error.CollectionFull;</div><div class="diff-removed">-</div><div class="diff-removed">-    // If this is deferred and we don't have load options, we can't.</div><div class="diff-removed">-    if (face.isDeferred() and self.load_options == null)</div><div class="diff-removed">-        return error.DeferredLoadingUnavailable;</div><div class="diff-removed">-</div><div class="diff-removed">-    try list.append(alloc, face);</div><div class="diff-removed">-    return .{ .style = style, .idx = @intCast(idx) };</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-/// Return the Face represented by a given Index. The returned pointer</div><div class="diff-removed">-/// is only valid as long as this collection is not modified.</div><div class="diff-removed">-///</div><div class="diff-removed">-/// This will initialize the face if it is deferred and not yet loaded,</div><div class="diff-removed">-/// which can fail.</div><div class="diff-removed">-pub fn getFace(self: *Collection, index: Index) !*Face {</div><div class="diff-removed">-    if (index.special() != null) return error.SpecialHasNoFace;</div><div class="diff-removed">-    const list = self.faces.getPtr(index.style);</div><div class="diff-removed">-    const item: *Entry = item: {</div><div class="diff-removed">-        var item = list.at(index.idx);</div><div class="diff-removed">-        switch (item.*) {</div><div class="diff-removed">-            .alias => |ptr| item = ptr,</div><div class="diff-removed">-</div><div class="diff-removed">-            .deferred,</div><div class="diff-removed">-            .fallback_deferred,</div><div class="diff-removed">-            .loaded,</div><div class="diff-removed">-            .fallback_loaded,</div><div class="diff-removed">-            => {},</div><div class="diff-removed">-        }</div><div class="diff-removed">-        assert(item.* != .alias);</div><div class="diff-removed">-        break :item item;</div><div class="diff-removed">-    };</div><div class="diff-removed">-</div><div class="diff-removed">-    return try self.getFaceFromEntry(item);</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-/// Get the face from an entry.</div><div class="diff-removed">-///</div><div class="diff-removed">-/// This entry must not be an alias.</div><div class="diff-removed">-fn getFaceFromEntry(self: *Collection, entry: *Entry) !*Face {</div><div class="diff-removed">-    assert(entry.* != .alias);</div><div class="diff-removed">-</div><div class="diff-removed">-    return switch (entry.*) {</div><div class="diff-removed">-        inline .deferred, .fallback_deferred => |*d, tag| deferred: {</div><div class="diff-removed">-            const opts = self.load_options orelse</div><div class="diff-removed">-                return error.DeferredLoadingUnavailable;</div><div class="diff-removed">-            const face = try d.load(opts.library, opts.faceOptions());</div><div class="diff-removed">-            d.deinit();</div><div class="diff-removed">-            entry.* = switch (tag) {</div><div class="diff-removed">-                .deferred => .{ .loaded = face },</div><div class="diff-removed">-                .fallback_deferred => .{ .fallback_loaded = face },</div><div class="diff-removed">-                else => unreachable,</div><div class="diff-removed">-            };</div><div class="diff-removed">-</div><div class="diff-removed">-            break :deferred switch (tag) {</div><div class="diff-removed">-                .deferred => &entry.loaded,</div><div class="diff-removed">-                .fallback_deferred => &entry.fallback_loaded,</div><div class="diff-removed">-                else => unreachable,</div><div class="diff-removed">-            };</div><div class="diff-removed">-        },</div><div class="diff-removed">-</div><div class="diff-removed">-        .loaded, .fallback_loaded => |*f| f,</div><div class="diff-removed">-</div><div class="diff-removed">-        // When setting `entry` above, we ensure we don't end up with</div><div class="diff-removed">-        // an alias.</div><div class="diff-removed">-        .alias => unreachable,</div><div class="diff-removed">-    };</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-/// Return the index of the font in this collection that contains</div><div class="diff-removed">-/// the given codepoint, style, and presentation. If no font is found,</div><div class="diff-removed">-/// null is returned.</div><div class="diff-removed">-///</div><div class="diff-removed">-/// This does not trigger font loading; deferred fonts can be</div><div class="diff-removed">-/// searched for codepoints.</div><div class="diff-removed">-pub fn getIndex(</div><div class="diff-removed">-    self: *const Collection,</div><div class="diff-removed">-    cp: u32,</div><div class="diff-removed">-    style: Style,</div><div class="diff-removed">-    p_mode: PresentationMode,</div><div class="diff-removed">-) ?Index {</div><div class="diff-removed">-    var i: usize = 0;</div><div class="diff-removed">-    var it = self.faces.get(style).constIterator(0);</div><div class="diff-removed">-    while (it.next()) |entry| {</div><div class="diff-removed">-        if (entry.hasCodepoint(cp, p_mode)) {</div><div class="diff-removed">-            return .{</div><div class="diff-removed">-                .style = style,</div><div class="diff-removed">-                .idx = @intCast(i),</div><div class="diff-removed">-            };</div><div class="diff-removed">-        }</div><div class="diff-removed">-</div><div class="diff-removed">-        i += 1;</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    // Not found</div><div class="diff-removed">-    return null;</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-/// Check if a specific font index has a specific codepoint. This does not</div><div class="diff-removed">-/// necessarily force the font to load. The presentation value "p" will</div><div class="diff-removed">-/// verify the Emoji representation matches if it is non-null. If "p" is</div><div class="diff-removed">-/// null then any presentation will be accepted.</div><div class="diff-removed">-pub fn hasCodepoint(</div><div class="diff-removed">-    self: *const Collection,</div><div class="diff-removed">-    index: Index,</div><div class="diff-removed">-    cp: u32,</div><div class="diff-removed">-    p_mode: PresentationMode,</div><div class="diff-removed">-) bool {</div><div class="diff-removed">-    const list = self.faces.get(index.style);</div><div class="diff-removed">-    if (index.idx >= list.count()) return false;</div><div class="diff-removed">-    return list.at(index.idx).hasCodepoint(cp, p_mode);</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-pub const CompleteError = Allocator.Error || error{</div><div class="diff-removed">-    DefaultUnavailable,</div><div class="diff-removed">-};</div><div class="diff-removed">-</div><div class="diff-removed">-/// Ensure we have an option for all styles in the collection, such</div><div class="diff-removed">-/// as italic and bold by synthesizing them if necessary from the</div><div class="diff-removed">-/// first regular face that has text glyphs.</div><div class="diff-removed">-///</div><div class="diff-removed">-/// If there is no regular face that has text glyphs, then this</div><div class="diff-removed">-/// does nothing.</div><div class="diff-removed">-pub fn completeStyles(</div><div class="diff-removed">-    self: *Collection,</div><div class="diff-removed">-    alloc: Allocator,</div><div class="diff-removed">-    synthetic_config: config.FontSyntheticStyle,</div><div class="diff-removed">-) CompleteError!void {</div><div class="diff-removed">-    // If every style has at least one entry then we're done!</div><div class="diff-removed">-    // This is the most common case.</div><div class="diff-removed">-    empty: {</div><div class="diff-removed">-        var it = self.faces.iterator();</div><div class="diff-removed">-        while (it.next()) |entry| {</div><div class="diff-removed">-            if (entry.value.count() == 0) break :empty;</div><div class="diff-removed">-        }</div><div class="diff-removed">-</div><div class="diff-removed">-        return;</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    // Find the first regular face that has non-colorized text glyphs.</div><div class="diff-removed">-    // This is the font we want to fallback to. This may not be index zero</div><div class="diff-removed">-    // if a user configures something like an Emoji font first.</div><div class="diff-removed">-    const regular_entry: *Entry = entry: {</div><div class="diff-removed">-        const list = self.faces.getPtr(.regular);</div><div class="diff-removed">-        if (list.count() == 0) return;</div><div class="diff-removed">-</div><div class="diff-removed">-        // Find our first regular face that has text glyphs.</div><div class="diff-removed">-        var it = list.iterator(0);</div><div class="diff-removed">-        while (it.next()) |entry| {</div><div class="diff-removed">-            // Load our face. If we fail to load it, we just skip it and</div><div class="diff-removed">-            // continue on to try the next one.</div><div class="diff-removed">-            const face = self.getFaceFromEntry(entry) catch |err| {</div><div class="diff-removed">-                log.warn("error loading regular entry={d} err={}", .{</div><div class="diff-removed">-                    it.index - 1,</div><div class="diff-removed">-                    err,</div><div class="diff-removed">-                });</div><div class="diff-removed">-</div><div class="diff-removed">-                continue;</div><div class="diff-removed">-            };</div><div class="diff-removed">-</div><div class="diff-removed">-            // We have two conditionals here. The color check is obvious:</div><div class="diff-removed">-            // we want to auto-italicize a normal text font. The second</div><div class="diff-removed">-            // check is less obvious... for mixed color/non-color fonts, we</div><div class="diff-removed">-            // accept the regular font if it has basic ASCII. This may not</div><div class="diff-removed">-            // be strictly correct (especially with international fonts) but</div><div class="diff-removed">-            // it's a reasonable heuristic and the first case will match 99%</div><div class="diff-removed">-            // of the time.</div><div class="diff-removed">-            if (!face.hasColor() or face.glyphIndex('A') != null) {</div><div class="diff-removed">-                break :entry entry;</div><div class="diff-removed">-            }</div><div class="diff-removed">-        }</div><div class="diff-removed">-</div><div class="diff-removed">-        // No regular text face found. We can't provide any fallback.</div><div class="diff-removed">-        return error.DefaultUnavailable;</div><div class="diff-removed">-    };</div><div class="diff-removed">-</div><div class="diff-removed">-    // If we don't have italic, attempt to create a synthetic italic face.</div><div class="diff-removed">-    // If we can't create a synthetic italic face, we'll just use the regular</div><div class="diff-removed">-    // face for italic.</div><div class="diff-removed">-    const italic_list = self.faces.getPtr(.italic);</div><div class="diff-removed">-    const have_italic = italic_list.count() > 0;</div><div class="diff-removed">-    if (!have_italic) italic: {</div><div class="diff-removed">-        if (!synthetic_config.italic) {</div><div class="diff-removed">-            log.info("italic style not available and synthetic italic disabled", .{});</div><div class="diff-removed">-            try italic_list.append(alloc, .{ .alias = regular_entry });</div><div class="diff-removed">-            break :italic;</div><div class="diff-removed">-        }</div><div class="diff-removed">-</div><div class="diff-removed">-        const synthetic = self.syntheticItalic(regular_entry) catch |err| {</div><div class="diff-removed">-            log.warn("failed to create synthetic italic, italic style will not be available err={}", .{err});</div><div class="diff-removed">-            try italic_list.append(alloc, .{ .alias = regular_entry });</div><div class="diff-removed">-            break :italic;</div><div class="diff-removed">-        };</div><div class="diff-removed">-</div><div class="diff-removed">-        log.info("synthetic italic face created", .{});</div><div class="diff-removed">-        try italic_list.append(alloc, .{ .loaded = synthetic });</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    // If we don't have bold, use the regular font.</div><div class="diff-removed">-    const bold_list = self.faces.getPtr(.bold);</div><div class="diff-removed">-    const have_bold = bold_list.count() > 0;</div><div class="diff-removed">-    if (!have_bold) bold: {</div><div class="diff-removed">-        if (!synthetic_config.bold) {</div><div class="diff-removed">-            log.info("bold style not available and synthetic bold disabled", .{});</div><div class="diff-removed">-            try bold_list.append(alloc, .{ .alias = regular_entry });</div><div class="diff-removed">-            break :bold;</div><div class="diff-removed">-        }</div><div class="diff-removed">-</div><div class="diff-removed">-        const synthetic = self.syntheticBold(regular_entry) catch |err| {</div><div class="diff-removed">-            log.warn("failed to create synthetic bold, bold style will not be available err={}", .{err});</div><div class="diff-removed">-            try bold_list.append(alloc, .{ .alias = regular_entry });</div><div class="diff-removed">-            break :bold;</div><div class="diff-removed">-        };</div><div class="diff-removed">-</div><div class="diff-removed">-        log.info("synthetic bold face created", .{});</div><div class="diff-removed">-        try bold_list.append(alloc, .{ .loaded = synthetic });</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    // If we don't have bold italic, we attempt to synthesize a bold variant</div><div class="diff-removed">-    // of the italic font. If we can't do that, we'll use the italic font.</div><div class="diff-removed">-    const bold_italic_list = self.faces.getPtr(.bold_italic);</div><div class="diff-removed">-    if (bold_italic_list.count() == 0) bold_italic: {</div><div class="diff-removed">-        if (!synthetic_config.@"bold-italic") {</div><div class="diff-removed">-            log.info("bold italic style not available and synthetic bold italic disabled", .{});</div><div class="diff-removed">-            try bold_italic_list.append(alloc, .{ .alias = regular_entry });</div><div class="diff-removed">-            break :bold_italic;</div><div class="diff-removed">-        }</div><div class="diff-removed">-</div><div class="diff-removed">-        // Prefer to synthesize on top of the face we already had. If we</div><div class="diff-removed">-        // have bold then we try to synthesize italic on top of bold.</div><div class="diff-removed">-        if (have_bold) {</div><div class="diff-removed">-            if (self.syntheticItalic(bold_list.at(0))) |synthetic| {</div><div class="diff-removed">-                log.info("synthetic bold italic face created from bold", .{});</div><div class="diff-removed">-                try bold_italic_list.append(alloc, .{ .loaded = synthetic });</div><div class="diff-removed">-                break :bold_italic;</div><div class="diff-removed">-            } else |_| {}</div><div class="diff-removed">-</div><div class="diff-removed">-            // If synthesizing italic failed, then we try to synthesize</div><div class="diff-removed">-            // bold on whatever italic font we have.</div><div class="diff-removed">-        }</div><div class="diff-removed">-</div><div class="diff-removed">-        // Nested alias isn't allowed so we need to unwrap the italic entry.</div><div class="diff-removed">-        const base_entry = base: {</div><div class="diff-removed">-            const italic_entry = italic_list.at(0);</div><div class="diff-removed">-            break :base switch (italic_entry.*) {</div><div class="diff-removed">-                .alias => |v| v,</div><div class="diff-removed">-</div><div class="diff-removed">-                .loaded,</div><div class="diff-removed">-                .fallback_loaded,</div><div class="diff-removed">-                .deferred,</div><div class="diff-removed">-                .fallback_deferred,</div><div class="diff-removed">-                => italic_entry,</div><div class="diff-removed">-            };</div><div class="diff-removed">-        };</div><div class="diff-removed">-</div><div class="diff-removed">-        if (self.syntheticBold(base_entry)) |synthetic| {</div><div class="diff-removed">-            log.info("synthetic bold italic face created from italic", .{});</div><div class="diff-removed">-            try bold_italic_list.append(alloc, .{ .loaded = synthetic });</div><div class="diff-removed">-            break :bold_italic;</div><div class="diff-removed">-        } else |_| {}</div><div class="diff-removed">-</div><div class="diff-removed">-        log.warn("bold italic style not available, using italic font", .{});</div><div class="diff-removed">-        try bold_italic_list.append(alloc, .{ .alias = base_entry });</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-// Create a synthetic bold font face from the given entry and return it.</div><div class="diff-removed">-fn syntheticBold(self: *Collection, entry: *Entry) !Face {</div><div class="diff-removed">-    // Not all font backends support synthetic bold.</div><div class="diff-removed">-    if (comptime !@hasDecl(Face, "syntheticBold")) return error.SyntheticBoldUnavailable;</div><div class="diff-removed">-</div><div class="diff-removed">-    // We require loading options to create a synthetic bold face.</div><div class="diff-removed">-    const opts = self.load_options orelse return error.DeferredLoadingUnavailable;</div><div class="diff-removed">-</div><div class="diff-removed">-    // Try to bold it.</div><div class="diff-removed">-    const regular = try self.getFaceFromEntry(entry);</div><div class="diff-removed">-    const face = try regular.syntheticBold(opts.faceOptions());</div><div class="diff-removed">-</div><div class="diff-removed">-    var buf: [256]u8 = undefined;</div><div class="diff-removed">-    if (face.name(&buf)) |name| {</div><div class="diff-removed">-        log.info("font synthetic bold created family={s}", .{name});</div><div class="diff-removed">-    } else |_| {}</div><div class="diff-removed">-</div><div class="diff-removed">-    return face;</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-// Create a synthetic italic font face from the given entry and return it.</div><div class="diff-removed">-fn syntheticItalic(self: *Collection, entry: *Entry) !Face {</div><div class="diff-removed">-    // Not all font backends support synthetic italicization.</div><div class="diff-removed">-    if (comptime !@hasDecl(Face, "syntheticItalic")) return error.SyntheticItalicUnavailable;</div><div class="diff-removed">-</div><div class="diff-removed">-    // We require loading options to create a synthetic italic face.</div><div class="diff-removed">-    const opts = self.load_options orelse return error.DeferredLoadingUnavailable;</div><div class="diff-removed">-</div><div class="diff-removed">-    // Try to italicize it.</div><div class="diff-removed">-    const regular = try self.getFaceFromEntry(entry);</div><div class="diff-removed">-    const face = try regular.syntheticItalic(opts.faceOptions());</div><div class="diff-removed">-</div><div class="diff-removed">-    var buf: [256]u8 = undefined;</div><div class="diff-removed">-    if (face.name(&buf)) |name| {</div><div class="diff-removed">-        log.info("font synthetic italic created family={s}", .{name});</div><div class="diff-removed">-    } else |_| {}</div><div class="diff-removed">-</div><div class="diff-removed">-    return face;</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-/// Update the size of all faces in the collection. This will</div><div class="diff-removed">-/// also update the size in the load options for future deferred</div><div class="diff-removed">-/// face loading.</div><div class="diff-removed">-///</div><div class="diff-removed">-/// This requires load options to be set.</div><div class="diff-removed">-pub fn setSize(self: *Collection, size: DesiredSize) !void {</div><div class="diff-removed">-    // Get a pointer to our options so we can modify the size.</div><div class="diff-removed">-    const opts = if (self.load_options) |*v|</div><div class="diff-removed">-        v</div><div class="diff-removed">-    else</div><div class="diff-removed">-        return error.DeferredLoadingUnavailable;</div><div class="diff-removed">-    opts.size = size;</div><div class="diff-removed">-</div><div class="diff-removed">-    // Resize all our faces that are loaded</div><div class="diff-removed">-    var it = self.faces.iterator();</div><div class="diff-removed">-    while (it.next()) |array| {</div><div class="diff-removed">-        var entry_it = array.value.iterator(0);</div><div class="diff-removed">-        while (entry_it.next()) |entry| switch (entry.*) {</div><div class="diff-removed">-            .loaded, .fallback_loaded => |*f| try f.setSize(</div><div class="diff-removed">-                opts.faceOptions(),</div><div class="diff-removed">-            ),</div><div class="diff-removed">-</div><div class="diff-removed">-            // Deferred aren't loaded so we don't need to set their size.</div><div class="diff-removed">-            // The size for when they're loaded is set since `opts` changed.</div><div class="diff-removed">-            .deferred, .fallback_deferred => continue,</div><div class="diff-removed">-</div><div class="diff-removed">-            // Alias faces don't own their size.</div><div class="diff-removed">-            .alias => continue,</div><div class="diff-removed">-        };</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    try self.updateMetrics();</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-const UpdateMetricsError = font.Face.GetMetricsError || error{</div><div class="diff-removed">-    CannotLoadPrimaryFont,</div><div class="diff-removed">-};</div><div class="diff-removed">-</div><div class="diff-removed">-/// Update the cell metrics for this collection, based on</div><div class="diff-removed">-/// the primary font and the modifiers in `metric_modifiers`.</div><div class="diff-removed">-///</div><div class="diff-removed">-/// This requires a primary font (index `0`) to be present.</div><div class="diff-removed">-pub fn updateMetrics(self: *Collection) UpdateMetricsError!void {</div><div class="diff-removed">-    const primary_face = self.getFace(.{ .idx = 0 }) catch return error.CannotLoadPrimaryFont;</div><div class="diff-removed">-</div><div class="diff-removed">-    const face_metrics = try primary_face.getMetrics();</div><div class="diff-removed">-</div><div class="diff-removed">-    var metrics = Metrics.calc(face_metrics);</div><div class="diff-removed">-</div><div class="diff-removed">-    metrics.apply(self.metric_modifiers);</div><div class="diff-removed">-</div><div class="diff-removed">-    self.metrics = metrics;</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-/// Packed array of all Style enum cases mapped to a growable list of faces.</div><div class="diff-removed">-///</div><div class="diff-removed">-/// We use this data structure because there aren't many styles and all</div><div class="diff-removed">-/// styles are typically loaded for a terminal session. The overhead per</div><div class="diff-removed">-/// style even if it is not used or barely used is minimal given the</div><div class="diff-removed">-/// small style count.</div><div class="diff-removed">-///</div><div class="diff-removed">-/// We use a segmented list because the entry values must be pointer-stable</div><div class="diff-removed">-/// to support the "alias" field in Entry.</div><div class="diff-removed">-///</div><div class="diff-removed">-/// WARNING: We cannot use any prealloc yet for the segmented list because</div><div class="diff-removed">-/// the collection is copied around by value and pointers aren't stable.</div><div class="diff-removed">-const StyleArray = std.EnumArray(Style, std.SegmentedList(Entry, 0));</div><div class="diff-removed">-</div><div class="diff-removed">-/// Load options are used to configure all the details a Collection</div><div class="diff-removed">-/// needs to load deferred faces.</div><div class="diff-removed">-pub const LoadOptions = struct {</div><div class="diff-removed">-    /// The library to use for loading faces. This is not owned by</div><div class="diff-removed">-    /// the collection and can be used by multiple collections. When</div><div class="diff-removed">-    /// deinitializing the collection, the library is not deinitialized.</div><div class="diff-removed">-    library: Library,</div><div class="diff-removed">-</div><div class="diff-removed">-    /// The desired font size for all loaded faces.</div><div class="diff-removed">-    size: DesiredSize = .{ .points = 12 },</div><div class="diff-removed">-</div><div class="diff-removed">-    /// Freetype Load Flags to use when loading glyphs. This is a list of</div><div class="diff-removed">-    /// bitfield constants that controls operations to perform during glyph</div><div class="diff-removed">-    /// loading. Only a subset is exposed for configuration, for the whole set</div><div class="diff-removed">-    /// of flags see `pkg.freetype.face.LoadFlags`.</div><div class="diff-removed">-    freetype_load_flags: font.face.FreetypeLoadFlags = font.face.freetype_load_flags_default,</div><div class="diff-removed">-</div><div class="diff-removed">-    pub fn deinit(self: *LoadOptions, alloc: Allocator) void {</div><div class="diff-removed">-        _ = self;</div><div class="diff-removed">-        _ = alloc;</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    /// The options to use for loading faces.</div><div class="diff-removed">-    pub fn faceOptions(self: *const LoadOptions) font.face.Options {</div><div class="diff-removed">-        return .{</div><div class="diff-removed">-            .size = self.size,</div><div class="diff-removed">-            .freetype_load_flags = self.freetype_load_flags,</div><div class="diff-removed">-        };</div><div class="diff-removed">-    }</div><div class="diff-removed">-};</div><div class="diff-removed">-</div><div class="diff-removed">-/// A entry in a collection can be deferred or loaded. A deferred face</div><div class="diff-removed">-/// is not yet fully loaded and only represents the font descriptor</div><div class="diff-removed">-/// and usually uses less resources. A loaded face is fully parsed,</div><div class="diff-removed">-/// ready to rasterize, and usually uses more resources than a</div><div class="diff-removed">-/// deferred version.</div><div class="diff-removed">-///</div><div class="diff-removed">-/// A face can also be a "fallback" variant that is still either</div><div class="diff-removed">-/// deferred or loaded. Today, there is only one difference between</div><div class="diff-removed">-/// fallback and non-fallback (or "explicit") faces: the handling</div><div class="diff-removed">-/// of emoji presentation.</div><div class="diff-removed">-///</div><div class="diff-removed">-/// For explicit faces, when an explicit emoji presentation is</div><div class="diff-removed">-/// not requested, we will use any glyph for that codepoint found</div><div class="diff-removed">-/// even if the font presentation does not match the UCD</div><div class="diff-removed">-/// (Unicode Character Database) value. When an explicit presentation</div><div class="diff-removed">-/// is requested (via either VS15/V16), that is always honored.</div><div class="diff-removed">-/// The reason we do this is because we assume that if a user</div><div class="diff-removed">-/// explicitly chosen a font face (hence it is "explicit" and</div><div class="diff-removed">-/// not "fallback"), they want to use any glyphs possible within that</div><div class="diff-removed">-/// font face. Fallback fonts on the other hand are picked as a</div><div class="diff-removed">-/// last resort, so we should prefer exactness if possible.</div><div class="diff-removed">-pub const Entry = union(enum) {</div><div class="diff-removed">-    deferred: DeferredFace, // Not loaded</div><div class="diff-removed">-    loaded: Face, // Loaded, explicit use</div><div class="diff-removed">-</div><div class="diff-removed">-    // The same as deferred/loaded but fallback font semantics (see large</div><div class="diff-removed">-    // comment above Entry).</div><div class="diff-removed">-    fallback_deferred: DeferredFace,</div><div class="diff-removed">-    fallback_loaded: Face,</div><div class="diff-removed">-</div><div class="diff-removed">-    // An alias to another entry. This is used to share the same face,</div><div class="diff-removed">-    // avoid memory duplication. An alias must point to a non-alias entry.</div><div class="diff-removed">-    alias: *Entry,</div><div class="diff-removed">-</div><div class="diff-removed">-    pub fn deinit(self: *Entry) void {</div><div class="diff-removed">-        switch (self.*) {</div><div class="diff-removed">-            inline .deferred,</div><div class="diff-removed">-            .loaded,</div><div class="diff-removed">-            .fallback_deferred,</div><div class="diff-removed">-            .fallback_loaded,</div><div class="diff-removed">-            => |*v| v.deinit(),</div><div class="diff-removed">-</div><div class="diff-removed">-            // Aliased fonts are not owned by this entry so we let them</div><div class="diff-removed">-            // be deallocated by the owner.</div><div class="diff-removed">-            .alias => {},</div><div class="diff-removed">-        }</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    /// True if the entry is deferred.</div><div class="diff-removed">-    fn isDeferred(self: Entry) bool {</div><div class="diff-removed">-        return switch (self) {</div><div class="diff-removed">-            .deferred, .fallback_deferred => true,</div><div class="diff-removed">-            .loaded, .fallback_loaded => false,</div><div class="diff-removed">-            .alias => |v| v.isDeferred(),</div><div class="diff-removed">-        };</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    /// True if this face satisfies the given codepoint and presentation.</div><div class="diff-removed">-    pub fn hasCodepoint(</div><div class="diff-removed">-        self: Entry,</div><div class="diff-removed">-        cp: u32,</div><div class="diff-removed">-        p_mode: PresentationMode,</div><div class="diff-removed">-    ) bool {</div><div class="diff-removed">-        return switch (self) {</div><div class="diff-removed">-            .alias => |v| v.hasCodepoint(cp, p_mode),</div><div class="diff-removed">-</div><div class="diff-removed">-            // Non-fallback fonts require explicit presentation matching but</div><div class="diff-removed">-            // otherwise don't care about presentation</div><div class="diff-removed">-            .deferred => |v| switch (p_mode) {</div><div class="diff-removed">-                .explicit => |p| v.hasCodepoint(cp, p),</div><div class="diff-removed">-                .default, .any => v.hasCodepoint(cp, null),</div><div class="diff-removed">-            },</div><div class="diff-removed">-</div><div class="diff-removed">-            .loaded => |face| switch (p_mode) {</div><div class="diff-removed">-                .explicit => |p| explicit: {</div><div class="diff-removed">-                    const index = face.glyphIndex(cp) orelse break :explicit false;</div><div class="diff-removed">-                    break :explicit switch (p) {</div><div class="diff-removed">-                        .text => !face.isColorGlyph(index),</div><div class="diff-removed">-                        .emoji => face.isColorGlyph(index),</div><div class="diff-removed">-                    };</div><div class="diff-removed">-                },</div><div class="diff-removed">-                .default, .any => face.glyphIndex(cp) != null,</div><div class="diff-removed">-            },</div><div class="diff-removed">-</div><div class="diff-removed">-            // Fallback fonts require exact presentation matching.</div><div class="diff-removed">-            .fallback_deferred => |v| switch (p_mode) {</div><div class="diff-removed">-                .explicit, .default => |p| v.hasCodepoint(cp, p),</div><div class="diff-removed">-                .any => v.hasCodepoint(cp, null),</div><div class="diff-removed">-            },</div><div class="diff-removed">-</div><div class="diff-removed">-            .fallback_loaded => |face| switch (p_mode) {</div><div class="diff-removed">-                .explicit,</div><div class="diff-removed">-                .default,</div><div class="diff-removed">-                => |p| explicit: {</div><div class="diff-removed">-                    const index = face.glyphIndex(cp) orelse break :explicit false;</div><div class="diff-removed">-                    break :explicit switch (p) {</div><div class="diff-removed">-                        .text => !face.isColorGlyph(index),</div><div class="diff-removed">-                        .emoji => face.isColorGlyph(index),</div><div class="diff-removed">-                    };</div><div class="diff-removed">-                },</div><div class="diff-removed">-                .any => face.glyphIndex(cp) != null,</div><div class="diff-removed">-            },</div><div class="diff-removed">-        };</div><div class="diff-removed">-    }</div><div class="diff-removed">-};</div><div class="diff-removed">-</div><div class="diff-removed">-/// The requested presentation for a codepoint.</div><div class="diff-removed">-pub const PresentationMode = union(enum) {</div><div class="diff-removed">-    /// The codepoint has an explicit presentation that is required,</div><div class="diff-removed">-    /// i.e. VS15/V16.</div><div class="diff-removed">-    explicit: Presentation,</div><div class="diff-removed">-</div><div class="diff-removed">-    /// The codepoint has no explicit presentation and we should use</div><div class="diff-removed">-    /// the presentation from the UCD.</div><div class="diff-removed">-    default: Presentation,</div><div class="diff-removed">-</div><div class="diff-removed">-    /// The codepoint can be any presentation.</div><div class="diff-removed">-    any: void,</div><div class="diff-removed">-};</div><div class="diff-removed">-</div><div class="diff-removed">-/// This represents a specific font in the collection.</div><div class="diff-removed">-///</div><div class="diff-removed">-/// The backing size of this packed struct represents the total number</div><div class="diff-removed">-/// of possible usable fonts in a collection. And the number of bits</div><div class="diff-removed">-/// used for the index and not the style represents the total number</div><div class="diff-removed">-/// of possible usable fonts for a given style.</div><div class="diff-removed">-///</div><div class="diff-removed">-/// The goal is to keep the size of this struct as small as practical. We</div><div class="diff-removed">-/// accept the limitations that this imposes so long as they're reasonable.</div><div class="diff-removed">-/// At the time of writing this comment, this is a 16-bit struct with 13</div><div class="diff-removed">-/// bits used for the index, supporting up to 8192 fonts per style. This</div><div class="diff-removed">-/// seems more than reasonable. There are synthetic scenarios where this</div><div class="diff-removed">-/// could be a limitation but I can't think of any that are practical.</div><div class="diff-removed">-///</div><div class="diff-removed">-/// If you somehow need more fonts per style, you can increase the size of</div><div class="diff-removed">-/// the Backing type and everything should just work fine.</div><div class="diff-removed">-pub const Index = packed struct(Index.Backing) {</div><div class="diff-removed">-    const Backing = u16;</div><div class="diff-removed">-    const backing_bits = @typeInfo(Backing).int.bits;</div><div class="diff-removed">-</div><div class="diff-removed">-    /// The number of bits we use for the index.</div><div class="diff-removed">-    const idx_bits = backing_bits - @typeInfo(@typeInfo(Style).@"enum".tag_type).int.bits;</div><div class="diff-removed">-    pub const IndexInt = @Type(.{ .int = .{ .signedness = .unsigned, .bits = idx_bits } });</div><div class="diff-removed">-</div><div class="diff-removed">-    /// The special-case fonts that we support.</div><div class="diff-removed">-    pub const Special = enum(IndexInt) {</div><div class="diff-removed">-        // We start all special fonts at this index so they can be detected.</div><div class="diff-removed">-        pub const start = std.math.maxInt(IndexInt);</div><div class="diff-removed">-</div><div class="diff-removed">-        /// Sprite drawing, this is rendered JIT using 2D graphics APIs.</div><div class="diff-removed">-        sprite = start,</div><div class="diff-removed">-    };</div><div class="diff-removed">-</div><div class="diff-removed">-    style: Style = .regular,</div><div class="diff-removed">-    idx: IndexInt = 0,</div><div class="diff-removed">-</div><div class="diff-removed">-    /// Initialize a special font index.</div><div class="diff-removed">-    pub fn initSpecial(v: Special) Index {</div><div class="diff-removed">-        return .{ .style = .regular, .idx = @intFromEnum(v) };</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    /// Convert to int</div><div class="diff-removed">-    pub fn int(self: Index) Backing {</div><div class="diff-removed">-        return @bitCast(self);</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    /// Returns true if this is a "special" index which doesn't map to</div><div class="diff-removed">-    /// a real font face. We can still render it but there is no face for</div><div class="diff-removed">-    /// this font.</div><div class="diff-removed">-    pub fn special(self: Index) ?Special {</div><div class="diff-removed">-        if (self.idx < Special.start) return null;</div><div class="diff-removed">-        return @enumFromInt(self.idx);</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    test {</div><div class="diff-removed">-        // We never want to take up more than a byte since font indexes are</div><div class="diff-removed">-        // everywhere so if we increase the size of this we'll dramatically</div><div class="diff-removed">-        // increase our memory usage.</div><div class="diff-removed">-        try std.testing.expectEqual(@sizeOf(Backing), @sizeOf(Index));</div><div class="diff-removed">-</div><div class="diff-removed">-        // Just so we're aware when this changes. The current maximum number</div><div class="diff-removed">-        // of fonts for a style is 13 bits or 8192 fonts.</div><div class="diff-removed">-        try std.testing.expectEqual(13, idx_bits);</div><div class="diff-removed">-    }</div><div class="diff-removed">-};</div><div class="diff-removed">-</div><div class="diff-removed">-test init {</div><div class="diff-removed">-    const testing = std.testing;</div><div class="diff-removed">-    const alloc = testing.allocator;</div><div class="diff-removed">-</div><div class="diff-removed">-    var c = init();</div><div class="diff-removed">-    defer c.deinit(alloc);</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-test "add full" {</div><div class="diff-removed">-    const testing = std.testing;</div><div class="diff-removed">-    const alloc = testing.allocator;</div><div class="diff-removed">-    const testFont = font.embedded.regular;</div><div class="diff-removed">-</div><div class="diff-removed">-    var lib = try Library.init();</div><div class="diff-removed">-    defer lib.deinit();</div><div class="diff-removed">-</div><div class="diff-removed">-    var c = init();</div><div class="diff-removed">-    defer c.deinit(alloc);</div><div class="diff-removed">-</div><div class="diff-removed">-    for (0..Index.Special.start - 1) |_| {</div><div class="diff-removed">-        _ = try c.add(alloc, .regular, .{ .loaded = try Face.init(</div><div class="diff-removed">-            lib,</div><div class="diff-removed">-            testFont,</div><div class="diff-removed">-            .{ .size = .{ .points = 12 } },</div><div class="diff-removed">-        ) });</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    try testing.expectError(error.CollectionFull, c.add(</div><div class="diff-removed">-        alloc,</div><div class="diff-removed">-        .regular,</div><div class="diff-removed">-        .{ .loaded = try Face.init(</div><div class="diff-removed">-            lib,</div><div class="diff-removed">-            testFont,</div><div class="diff-removed">-            .{ .size = .{ .points = 12 } },</div><div class="diff-removed">-        ) },</div><div class="diff-removed">-    ));</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-test "add deferred without loading options" {</div><div class="diff-removed">-    const testing = std.testing;</div><div class="diff-removed">-    const alloc = testing.allocator;</div><div class="diff-removed">-</div><div class="diff-removed">-    var c = init();</div><div class="diff-removed">-    defer c.deinit(alloc);</div><div class="diff-removed">-</div><div class="diff-removed">-    try testing.expectError(error.DeferredLoadingUnavailable, c.add(</div><div class="diff-removed">-        alloc,</div><div class="diff-removed">-        .regular,</div><div class="diff-removed">-</div><div class="diff-removed">-        // This can be undefined because it should never be accessed.</div><div class="diff-removed">-        .{ .deferred = undefined },</div><div class="diff-removed">-    ));</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-test getFace {</div><div class="diff-removed">-    const testing = std.testing;</div><div class="diff-removed">-    const alloc = testing.allocator;</div><div class="diff-removed">-    const testFont = font.embedded.regular;</div><div class="diff-removed">-</div><div class="diff-removed">-    var lib = try Library.init();</div><div class="diff-removed">-    defer lib.deinit();</div><div class="diff-removed">-</div><div class="diff-removed">-    var c = init();</div><div class="diff-removed">-    defer c.deinit(alloc);</div><div class="diff-removed">-</div><div class="diff-removed">-    const idx = try c.add(alloc, .regular, .{ .loaded = try Face.init(</div><div class="diff-removed">-        lib,</div><div class="diff-removed">-        testFont,</div><div class="diff-removed">-        .{ .size = .{ .points = 12, .xdpi = 96, .ydpi = 96 } },</div><div class="diff-removed">-    ) });</div><div class="diff-removed">-</div><div class="diff-removed">-    {</div><div class="diff-removed">-        const face1 = try c.getFace(idx);</div><div class="diff-removed">-        const face2 = try c.getFace(idx);</div><div class="diff-removed">-        try testing.expectEqual(@intFromPtr(face1), @intFromPtr(face2));</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-test getIndex {</div><div class="diff-removed">-    const testing = std.testing;</div><div class="diff-removed">-    const alloc = testing.allocator;</div><div class="diff-removed">-    const testFont = font.embedded.regular;</div><div class="diff-removed">-</div><div class="diff-removed">-    var lib = try Library.init();</div><div class="diff-removed">-    defer lib.deinit();</div><div class="diff-removed">-</div><div class="diff-removed">-    var c = init();</div><div class="diff-removed">-    defer c.deinit(alloc);</div><div class="diff-removed">-</div><div class="diff-removed">-    _ = try c.add(alloc, .regular, .{ .loaded = try Face.init(</div><div class="diff-removed">-        lib,</div><div class="diff-removed">-        testFont,</div><div class="diff-removed">-        .{ .size = .{ .points = 12, .xdpi = 96, .ydpi = 96 } },</div><div class="diff-removed">-    ) });</div><div class="diff-removed">-</div><div class="diff-removed">-    // Should find all visible ASCII</div><div class="diff-removed">-    var i: u32 = 32;</div><div class="diff-removed">-    while (i < 127) : (i += 1) {</div><div class="diff-removed">-        const idx = c.getIndex(i, .regular, .{ .any = {} });</div><div class="diff-removed">-        try testing.expect(idx != null);</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div class="diff-removed">-    // Should not find emoji</div><div class="diff-removed">-    {</div><div class="diff-removed">-        const idx = c.getIndex('ü•∏', .regular, .{ .any = {} });</div><div class="diff-removed">-        try testing.expect(idx == null);</div><div class="diff-removed">-    }</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-test completeStyles {</div><div class="diff-removed">-    const testing = std.testing;</div><div class="diff-removed">-    const alloc = testing.allocator;</div><div class="diff-removed">-    const testFont = font.embedded.regular;</div><div class="diff-removed">-</div><div class="diff-removed">-    var lib = try Library.init();</div><div class="diff-removed">-    defer lib.deinit();</div><div class="diff-removed">-</div><div class="diff-removed">-    var c = init();</div><div class="diff-removed">-    defer c.deinit(alloc);</div><div class="diff-removed">-    c.load_options = .{ .library = lib };</div><div class="diff-removed">-</div><div class="diff-removed">-    _ = try c.add(alloc, .regular, .{ .loaded = try Face.init(</div><div class="diff-removed">-        lib,</div><div class="diff-removed">-        testFont,</div><div class="diff-removed">-        .{ .size = .{ .points = 12, .xdpi = 96, .ydpi = 96 } },</div><div class="diff-removed">-    ) });</div><div class="diff-removed">-</div><div class="diff-removed">-    try testing.expect(c.getIndex('A', .bold, .{ .any = {} }) == null);</div><div class="diff-removed">-    try testing.expect(c.getIndex('A', .italic, .{ .any = {} }) == null);</div><div class="diff-removed">-    try testing.expect(c.getIndex('A', .bold_italic, .{ .any = {} }) == null);</div><div class="diff-removed">-    try c.completeStyles(alloc, .{});</div><div class="diff-removed">-    try testing.expect(c.getIndex('A', .bold, .{ .any = {} }) != null);</div><div class="diff-removed">-    try testing.expect(c.getIndex('A', .italic, .{ .any = {} }) != null);</div><div class="diff-removed">-    try testing.expect(c.getIndex('A', .bold_italic, .{ .any = {} }) != null);</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-test setSize {</div><div class="diff-removed">-    const testing = std.testing;</div><div class="diff-removed">-    const alloc = testing.allocator;</div><div class="diff-removed">-    const testFont = font.embedded.regular;</div><div class="diff-removed">-</div><div class="diff-removed">-    var lib = try Library.init();</div><div class="diff-removed">-    defer lib.deinit();</div><div class="diff-removed">-</div><div class="diff-removed">-    var c = init();</div><div class="diff-removed">-    defer c.deinit(alloc);</div><div class="diff-removed">-    c.load_options = .{ .library = lib };</div><div class="diff-removed">-</div><div class="diff-removed">-    _ = try c.add(alloc, .regular, .{ .loaded = try Face.init(</div><div class="diff-removed">-        lib,</div><div class="diff-removed">-        testFont,</div><div class="diff-removed">-        .{ .size = .{ .points = 12, .xdpi = 96, .ydpi = 96 } },</div><div class="diff-removed">-    ) });</div><div class="diff-removed">-</div><div class="diff-removed">-    try testing.expectEqual(@as(u32, 12), c.load_options.?.size.points);</div><div class="diff-removed">-    try c.setSize(.{ .points = 24 });</div><div class="diff-removed">-    try testing.expectEqual(@as(u32, 24), c.load_options.?.size.points);</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-test hasCodepoint {</div><div class="diff-removed">-    const testing = std.testing;</div><div class="diff-removed">-    const alloc = testing.allocator;</div><div class="diff-removed">-    const testFont = font.embedded.regular;</div><div class="diff-removed">-</div><div class="diff-removed">-    var lib = try Library.init();</div><div class="diff-removed">-    defer lib.deinit();</div><div class="diff-removed">-</div><div class="diff-removed">-    var c = init();</div><div class="diff-removed">-    defer c.deinit(alloc);</div><div class="diff-removed">-    c.load_options = .{ .library = lib };</div><div class="diff-removed">-</div><div class="diff-removed">-    const idx = try c.add(alloc, .regular, .{ .loaded = try Face.init(</div><div class="diff-removed">-        lib,</div><div class="diff-removed">-        testFont,</div><div class="diff-removed">-        .{ .size = .{ .points = 12, .xdpi = 96, .ydpi = 96 } },</div><div class="diff-removed">-    ) });</div><div class="diff-removed">-</div><div class="diff-removed">-    try testing.expect(c.hasCodepoint(idx, 'A', .{ .any = {} }));</div><div class="diff-removed">-    try testing.expect(!c.hasCodepoint(idx, 'ü•∏', .{ .any = {} }));</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-test "hasCodepoint emoji default graphical" {</div><div class="diff-removed">-    if (options.backend != .fontconfig_freetype) return error.SkipZigTest;</div><div class="diff-removed">-</div><div class="diff-removed">-    const testing = std.testing;</div><div class="diff-removed">-    const alloc = testing.allocator;</div><div class="diff-removed">-    const testEmoji = font.embedded.emoji;</div><div class="diff-removed">-</div><div class="diff-removed">-    var lib = try Library.init();</div><div class="diff-removed">-    defer lib.deinit();</div><div class="diff-removed">-</div><div class="diff-removed">-    var c = init();</div><div class="diff-removed">-    defer c.deinit(alloc);</div><div class="diff-removed">-    c.load_options = .{ .library = lib };</div><div class="diff-removed">-</div><div class="diff-removed">-    const idx = try c.add(alloc, .regular, .{ .loaded = try Face.init(</div><div class="diff-removed">-        lib,</div><div class="diff-removed">-        testEmoji,</div><div class="diff-removed">-        .{ .size = .{ .points = 12, .xdpi = 96, .ydpi = 96 } },</div><div class="diff-removed">-    ) });</div><div class="diff-removed">-</div><div class="diff-removed">-    try testing.expect(!c.hasCodepoint(idx, 'A', .{ .any = {} }));</div><div class="diff-removed">-    try testing.expect(c.hasCodepoint(idx, 'ü•∏', .{ .any = {} }));</div><div class="diff-removed">-    // TODO(fontmem): test explicit/implicit</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-test "metrics" {</div><div class="diff-removed">-    const testing = std.testing;</div><div class="diff-removed">-    const alloc = testing.allocator;</div><div class="diff-removed">-    const testFont = font.embedded.inconsolata;</div><div class="diff-removed">-</div><div class="diff-removed">-    var lib = try Library.init();</div><div class="diff-removed">-    defer lib.deinit();</div><div class="diff-removed">-</div><div class="diff-removed">-    var c = init();</div><div class="diff-removed">-    defer c.deinit(alloc);</div><div class="diff-removed">-    c.load_options = .{ .library = lib };</div><div class="diff-removed">-</div><div class="diff-removed">-    _ = try c.add(alloc, .regular, .{ .loaded = try Face.init(</div><div class="diff-removed">-        lib,</div><div class="diff-removed">-        testFont,</div><div class="diff-removed">-        .{ .size = .{ .points = 12, .xdpi = 96, .ydpi = 96 } },</div><div class="diff-removed">-    ) });</div><div class="diff-removed">-</div><div class="diff-removed">-    try c.updateMetrics();</div><div class="diff-removed">-</div><div class="diff-removed">-    try std.testing.expectEqual(font.Metrics{</div><div class="diff-removed">-        .cell_width = 8,</div><div class="diff-removed">-        // The cell height is 17 px because the calculation is</div><div class="diff-removed">-        //</div><div class="diff-removed">-        //  ascender - descender + gap</div><div class="diff-removed">-        //</div><div class="diff-removed">-        // which, for inconsolata is</div><div class="diff-removed">-        //</div><div class="diff-removed">-        //  859 - -190 + 0</div><div class="diff-removed">-        //</div><div class="diff-removed">-        // font units, at 1000 units per em that works out to 1.049 em,</div><div class="diff-removed">-        // and 1em should be the point size * dpi scale, so 12 * (96/72)</div><div class="diff-removed">-        // which is 16, and 16 * 1.049 = 16.784, which finally is rounded</div><div class="diff-removed">-        // to 17.</div><div class="diff-removed">-        .cell_height = 17,</div><div class="diff-removed">-        .cell_baseline = 3,</div><div class="diff-removed">-        .underline_position = 17,</div><div class="diff-removed">-        .underline_thickness = 1,</div><div class="diff-removed">-        .strikethrough_position = 10,</div><div class="diff-removed">-        .strikethrough_thickness = 1,</div><div class="diff-removed">-        .overline_position = 0,</div><div class="diff-removed">-        .overline_thickness = 1,</div><div class="diff-removed">-        .box_thickness = 1,</div><div class="diff-removed">-        .cursor_height = 17,</div><div class="diff-removed">-    }, c.metrics);</div><div class="diff-removed">-</div><div class="diff-removed">-    // Resize should change metrics</div><div class="diff-removed">-    try c.setSize(.{ .points = 24, .xdpi = 96, .ydpi = 96 });</div><div class="diff-removed">-    try std.testing.expectEqual(font.Metrics{</div><div class="diff-removed">-        .cell_width = 16,</div><div class="diff-removed">-        .cell_height = 34,</div><div class="diff-removed">-        .cell_baseline = 6,</div><div class="diff-removed">-        .underline_position = 34,</div><div class="diff-removed">-        .underline_thickness = 2,</div><div class="diff-removed">-        .strikethrough_position = 19,</div><div class="diff-removed">-        .strikethrough_thickness = 2,</div><div class="diff-removed">-        .overline_position = 0,</div><div class="diff-removed">-        .overline_thickness = 2,</div><div class="diff-removed">-        .box_thickness = 2,</div><div class="diff-removed">-        .cursor_height = 34,</div><div class="diff-removed">-    }, c.metrics);</div><div class="diff-removed">-}</div><div>\ No newline at end of file</div><div class="diff-added">+/// The collection</div><div>\ No newline at end of file</div><div></div></pre>
                </div>
            </div>
        </section>
    </main>
    <footer>
        <p>LoCoDiff-bench - <a href="https://github.com/AbanteAI/LoCoDiff-bench">GitHub Repository</a></p>
    </footer>
</body>
</html>
    