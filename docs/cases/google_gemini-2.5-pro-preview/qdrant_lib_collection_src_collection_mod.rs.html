<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case: lib/collection/src/collection/mod.rs - Gemini 2.5 Pro 05-06</title>
    <link rel="stylesheet" href="../../styles.css">
</head>
<body>
    <header>
        <h1>Case: lib/collection/src/collection/mod.rs</h1>
        <h2>Model: Gemini 2.5 Pro 05-06</h2>
        <p><a href="../../models/google_gemini-2.5-pro-preview.html">All Gemini 2.5 Pro 05-06 Cases</a> | <a href="../../cases.html">All Cases</a> | <a href="../../index.html">Home</a></p>
    </header>
    <main>
        <section class="case-details">
            <div class="case-info">
                <h2>Benchmark Case Information</h2>
                <p><strong>Model:</strong> Gemini 2.5 Pro 05-06</p>
                <p><strong>Status:</strong> <span class="failure">Failure</span></p>
                <p><strong>Prompt Tokens:</strong> 58627</p>
                <p><strong>Native Prompt Tokens:</strong> 73689</p>
                <p><strong>Native Completion Tokens:</strong> 12676</p>
                <p><strong>Native Tokens Reasoning:</strong> 917</p>
                <p><strong>Native Finish Reason:</strong> STOP</p>
                <p><strong>Cost:</strong> $0.21887125</p>
            </div>
            
            <div class="content-links">
                <h2>View Content</h2>
                <ul>
                    <li><a href="../../content/google_gemini-2.5-pro-preview/qdrant_lib_collection_src_collection_mod.rs/prompt.html" class="content-link">View Prompt</a></li>
                    <li><a href="../../content/google_gemini-2.5-pro-preview/qdrant_lib_collection_src_collection_mod.rs/expected.html" class="content-link">View Expected Output</a></li>
                    <li><a href="../../content/google_gemini-2.5-pro-preview/qdrant_lib_collection_src_collection_mod.rs/actual.html" class="content-link">View Actual Output</a></li>
                </ul>
            </div>
            
            <div class="diff-section">
                <h2>Diff (Expected vs Actual)</h2>
                <div id="diff-output">
                    <pre class="diff"><div></div><div>index 71e15f9b..2c3910d1 100644</div><div class="diff-header">--- a/qdrant_lib_collection_src_collection_mod.rs_expectedoutput.txt (expected):tmp/tmpnnlu754n_expected.txt	</div><div class="diff-header">+++ b/qdrant_lib_collection_src_collection_mod.rs_extracted.txt (actual):tmp/tmpx0_yqt42_actual.txt	</div><div class="diff-info">@@ -93,7 +93,6 @@ pub struct Collection {</div><div> }</div><div> </div><div> pub type RequestShardTransfer = Arc<dyn Fn(ShardTransfer) + Send + Sync>;</div><div class="diff-removed">-</div><div> pub type OnTransferFailure = Arc<dyn Fn(ShardTransfer, CollectionId, &str) + Send + Sync>;</div><div> pub type OnTransferSuccess = Arc<dyn Fn(ShardTransfer, CollectionId) + Send + Sync>;</div><div> </div><div class="diff-info">@@ -438,13 +437,18 @@ impl Collection {</div><div>             )));</div><div>         }</div><div> </div><div class="diff-added">+        // Functions below lock `shard_holder`!</div><div class="diff-added">+        // Because of that, we need to grab all necessary data (like `resharding_state`),</div><div class="diff-added">+        // before calling `ensure_replica_with_state`.</div><div class="diff-added">+        // Otherwise it might lead to double-lock on `shard_holder`.</div><div class="diff-added">+        let resharding_state = shard_holder.resharding_state.read().clone();</div><div class="diff-added">+</div><div>         // Update replica status</div><div>         replica_set</div><div>             .ensure_replica_with_state(peer_id, new_state)</div><div>             .await?;</div><div> </div><div>         if new_state == ReplicaState::Dead {</div><div class="diff-removed">-            let resharding_state = shard_holder.resharding_state.read().clone();</div><div>             let related_transfers = shard_holder.get_related_transfers(shard_id, peer_id);</div><div> </div><div>             // Functions below lock `shard_holder`!</div><div class="diff-info">@@ -469,7 +473,7 @@ impl Collection {</div><div>                 .as_ref()</div><div>                 .is_some_and(ReplicaState::is_resharding);</div><div>             if is_resharding {</div><div class="diff-removed">-                if let Some(state) = resharding_state {</div><div class="diff-added">+                if let Some(state) = resharding_state.filter(|state| state.peer_id == peer_id) {</div><div>                     abort_resharding_result = self.abort_resharding(state.key(), false).await;</div><div>                 }</div><div>             }</div><div class="diff-info">@@ -563,6 +567,15 @@ impl Collection {</div><div>         }</div><div>     }</div><div> </div><div class="diff-added">+    pub async fn apply_state(</div><div class="diff-added">+        &self,</div><div class="diff-added">+        state: State,</div><div class="diff-added">+        this_peer_id: PeerId,</div><div class="diff-added">+        abort_transfer: impl FnMut(ShardTransfer),</div><div class="diff-added">+    ) -> CollectionResult<()> {</div><div class="diff-added">+        state.apply(this_peer_id, self, abort_transfer).await</div><div class="diff-added">+    }</div><div class="diff-added">+</div><div>     pub async fn remove_shards_at_peer(&self, peer_id: PeerId) -> CollectionResult<()> {</div><div>         // Abort resharding, if shards are removed from peer driving resharding</div><div>         // (which *usually* means the *peer* is being removed from consensus)</div><div class="diff-info">@@ -618,7 +631,7 @@ impl Collection {</div><div>                 None => {</div><div>                     log::debug!(</div><div>                         "Transfer {:?} does not exist, but not reported as cancelled. Reporting now.",</div><div class="diff-removed">-                        transfer.key(),</div><div class="diff-added">+                        (transfer.key())</div><div>                     );</div><div>                     on_transfer_failure(transfer, self.name(), "transfer task does not exist");</div><div>                 }</div><div class="diff-info">@@ -626,14 +639,14 @@ impl Collection {</div><div>                 Some(TaskResult::Finished) => {</div><div>                     log::debug!(</div><div>                         "Transfer {:?} is finished successfully, but not reported. Reporting now.",</div><div class="diff-removed">-                        transfer.key(),</div><div class="diff-added">+                        (transfer.key())</div><div>                     );</div><div>                     on_transfer_success(transfer, self.name());</div><div>                 }</div><div>                 Some(TaskResult::Failed) => {</div><div>                     log::debug!(</div><div>                         "Transfer {:?} is failed, but not reported as failed. Reporting now.",</div><div class="diff-removed">-                        transfer.key(),</div><div class="diff-added">+                        (transfer.key())</div><div>                     );</div><div>                     on_transfer_failure(transfer, self.name(), "transfer failed");</div><div>                 }</div><div class="diff-info">@@ -677,15 +690,18 @@ impl Collection {</div><div>                 continue;</div><div>             }</div><div> </div><div class="diff-removed">-            // Don't automatically recover replicas if started in recovery mode</div><div class="diff-removed">-            if self.shared_storage_config.recovery_mode.is_some() {</div><div class="diff-removed">-                continue;</div><div class="diff-removed">-            }</div><div class="diff-removed">-</div><div class="diff-removed">-            // Don't recover replicas if not dead</div><div class="diff-removed">-            let is_dead = this_peer_state == Some(Dead);</div><div class="diff-removed">-            if !is_dead {</div><div class="diff-removed">-                continue;</div><div class="diff-added">+            let is_dummy = replica_set.is_dummy().await;</div><div class="diff-added">+            if this_peer_state == Some(Dead) && is_dummy {</div><div class="diff-added">+                // Dummy shard is dead and needs recovery</div><div class="diff-added">+                log::warn!(</div><div class="diff-added">+                    "Shard {}:{shard_id} replica on peer {this_peer_id} is a dummy and needs recovery",</div><div class="diff-added">+                    self.id</div><div class="diff-added">+                );</div><div class="diff-added">+            } else {</div><div class="diff-added">+                // Don't automatically recover replicas if not dead</div><div class="diff-added">+                if this_peer_state != Some(Dead) {</div><div class="diff-added">+                    continue;</div><div class="diff-added">+                }</div><div>             }</div><div> </div><div>             // Try to find dead replicas with no active transfers</div><div class="diff-info">@@ -838,16 +854,6 @@ impl Collection {</div><div>         }</div><div>     }</div><div> </div><div class="diff-removed">-    pub async fn effective_optimizers_config(&self) -> CollectionResult<OptimizersConfig> {</div><div class="diff-removed">-        let config = self.collection_config.read().await;</div><div class="diff-removed">-</div><div class="diff-removed">-        if let Some(optimizers_overwrite) = self.optimizers_overwrite.clone() {</div><div class="diff-removed">-            Ok(optimizers_overwrite.update(&config.optimizer_config)?)</div><div class="diff-removed">-        } else {</div><div class="diff-removed">-            Ok(config.optimizer_config.clone())</div><div class="diff-removed">-        }</div><div class="diff-removed">-    }</div><div class="diff-removed">-</div><div>     pub async fn lock_updates(&self) -> RwLockWriteGuard<()> {</div><div>         self.updates_lock.write().await</div><div>     }</div><div></div></pre>
                </div>
            </div>
        </section>
    </main>
    <footer>
        <p>LoCoDiff-bench - <a href="https://github.com/AbanteAI/LoCoDiff-bench">GitHub Repository</a></p>
    </footer>
</body>
</html>
    