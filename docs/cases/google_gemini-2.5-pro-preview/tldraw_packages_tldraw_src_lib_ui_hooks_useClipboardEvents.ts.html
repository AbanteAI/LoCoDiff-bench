<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case: packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts - Gemini 2.5 Pro 05-06</title>
    <link rel="stylesheet" href="../../styles.css">
</head>
<body>
    <header>
        <h1>Case: packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts</h1>
        <h2>Model: Gemini 2.5 Pro 05-06</h2>
        <p><a href="../../models/google_gemini-2.5-pro-preview.html">All Gemini 2.5 Pro 05-06 Cases</a> | <a href="../../cases.html">All Cases</a> | <a href="../../index.html">Home</a></p>
    </header>
    <main>
        <section class="case-details">
            <div class="case-info">
                <h2>Benchmark Case Information</h2>
                <p><strong>Model:</strong> Gemini 2.5 Pro 05-06</p>
                <p><strong>Status:</strong> <span class="failure">Failure</span></p>
                <p><strong>Prompt Tokens:</strong> 40274</p>
                <p><strong>Native Prompt Tokens:</strong> 48305</p>
                <p><strong>Native Completion Tokens:</strong> 13323</p>
                <p><strong>Native Tokens Reasoning:</strong> 10101</p>
                <p><strong>Native Finish Reason:</strong> None</p>
                <p><strong>Cost:</strong> $0.19361125</p>
            </div>
            
            <div class="content-links">
                <h2>View Content</h2>
                <ul>
                    <li><a href="../../content/google_gemini-2.5-pro-preview/tldraw_packages_tldraw_src_lib_ui_hooks_useClipboardEvents.ts/prompt.html" class="content-link">View Prompt</a></li>
                    <li><a href="../../content/google_gemini-2.5-pro-preview/tldraw_packages_tldraw_src_lib_ui_hooks_useClipboardEvents.ts/expected.html" class="content-link">View Expected Output</a></li>
                    <li><a href="../../content/google_gemini-2.5-pro-preview/tldraw_packages_tldraw_src_lib_ui_hooks_useClipboardEvents.ts/actual.html" class="content-link">View Actual Output</a></li>
                </ul>
            </div>
            
            <div class="diff-section">
                <h2>Diff (Expected vs Actual)</h2>
                <div id="diff-output">
                    <pre class="diff"><div></div><div>index 5ea95b92..74cbbc98 100644</div><div class="diff-header">--- a/tldraw_packages_tldraw_src_lib_ui_hooks_useClipboardEvents.ts_expectedoutput.txt (expected):tmp/tmp55n0vwb0_expected.txt	</div><div class="diff-header">+++ b/tldraw_packages_tldraw_src_lib_ui_hooks_useClipboardEvents.ts_extracted.txt (actual):tmp/tmpkbkm4lrz_actual.txt	</div><div class="diff-info">@@ -399,390 +399,4 @@ async function handleClipboardThings(editor: Editor, things: ClipboardThing[], p</div><div> 									return</div><div> 								}</div><div> </div><div class="diff-removed">-								if (thing.type === 'url') {</div><div class="diff-removed">-									r({ type: 'text', data: text, subtype: 'url' })</div><div class="diff-removed">-									return</div><div class="diff-removed">-								}</div><div class="diff-removed">-</div><div class="diff-removed">-								// if we have not found a tldraw comment, Otherwise, try to parse the text as JSON directly.</div><div class="diff-removed">-								try {</div><div class="diff-removed">-									const json = JSON.parse(text)</div><div class="diff-removed">-									if (json.type === 'excalidraw/clipboard') {</div><div class="diff-removed">-										// If the clipboard contains content copied from excalidraw, then paste that</div><div class="diff-removed">-										r({ type: 'excalidraw', data: json })</div><div class="diff-removed">-										return</div><div class="diff-removed">-									} else {</div><div class="diff-removed">-										r({ type: 'text', data: text, subtype: 'json' })</div><div class="diff-removed">-										return</div><div class="diff-removed">-									}</div><div class="diff-removed">-								} catch {</div><div class="diff-removed">-									// If we could not parse the text as JSON, then it's just text</div><div class="diff-removed">-									r({ type: 'text', data: text, subtype: 'text' })</div><div class="diff-removed">-									return</div><div class="diff-removed">-								}</div><div class="diff-removed">-							}</div><div class="diff-removed">-</div><div class="diff-removed">-							r({ type: 'error', data: text, reason: 'unhandled case' })</div><div class="diff-removed">-						})</div><div class="diff-removed">-					})</div><div class="diff-removed">-			)</div><div class="diff-removed">-	)</div><div class="diff-removed">-</div><div class="diff-removed">-	// 3.</div><div class="diff-removed">-	//</div><div class="diff-removed">-	// Now that we know what kind of stuff we're dealing with, we can actual create some content.</div><div class="diff-removed">-	// There are priorities here, so order matters: we've already handled images and files, which</div><div class="diff-removed">-	// take first priority; then we want to handle tldraw content, then excalidraw content, then</div><div class="diff-removed">-	// html content, then links, and finally text content.</div><div class="diff-removed">-</div><div class="diff-removed">-	// Try to paste tldraw content</div><div class="diff-removed">-	for (const result of results) {</div><div class="diff-removed">-		if (result.type === 'tldraw') {</div><div class="diff-removed">-			editor.markHistoryStoppingPoint('paste')</div><div class="diff-removed">-			editor.putExternalContent({ type: 'tldraw', content: result.data, point })</div><div class="diff-removed">-			return</div><div class="diff-removed">-		}</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	// Try to paste excalidraw content</div><div class="diff-removed">-	for (const result of results) {</div><div class="diff-removed">-		if (result.type === 'excalidraw') {</div><div class="diff-removed">-			editor.markHistoryStoppingPoint('paste')</div><div class="diff-removed">-			editor.putExternalContent({ type: 'excalidraw', content: result.data, point })</div><div class="diff-removed">-			return</div><div class="diff-removed">-		}</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	// Try to paste html content</div><div class="diff-removed">-	for (const result of results) {</div><div class="diff-removed">-		if (result.type === 'text' && result.subtype === 'html') {</div><div class="diff-removed">-			// try to find a link</div><div class="diff-removed">-			const rootNode = new DOMParser().parseFromString(result.data, 'text/html')</div><div class="diff-removed">-			const bodyNode = rootNode.querySelector('body')</div><div class="diff-removed">-</div><div class="diff-removed">-			// Edge on Windows 11 home appears to paste a link as a single <a/tldraw_packages_tldraw_src_lib_ui_hooks_useClipboardEvents.ts_expectedoutput.txt (expected): 'text',</div><div class="diff-removed">-						text: html,</div><div class="diff-removed">-						html: result.data,</div><div class="diff-removed">-						point,</div><div class="diff-removed">-						sources: results,</div><div class="diff-removed">-					})</div><div class="diff-removed">-					return</div><div class="diff-removed">-				}</div><div class="diff-removed">-			}</div><div class="diff-removed">-		}</div><div class="diff-removed">-</div><div class="diff-removed">-		// Allow you to paste YouTube or Google Maps embeds, for example.</div><div class="diff-removed">-		if (result.type === 'text' && result.subtype === 'text' && result.data.startsWith('<iframe ')) {</div><div class="diff-removed">-			// try to find an iframe</div><div class="diff-removed">-			const rootNode = new DOMParser().parseFromString(result.data, 'text/html')</div><div class="diff-removed">-			const bodyNode = rootNode.querySelector('body')</div><div class="diff-removed">-</div><div class="diff-removed">-			const isSingleIframe =</div><div class="diff-removed">-				bodyNode &&</div><div class="diff-removed">-				Array.from(bodyNode.children).filter((el) => el.nodeType === 1).length === 1 &&</div><div class="diff-removed">-				bodyNode.firstElementChild &&</div><div class="diff-removed">-				bodyNode.firstElementChild.tagName === 'IFRAME' &&</div><div class="diff-removed">-				bodyNode.firstElementChild.hasAttribute('src') &&</div><div class="diff-removed">-				bodyNode.firstElementChild.getAttribute('src') !== ''</div><div class="diff-removed">-</div><div class="diff-removed">-			if (isSingleIframe) {</div><div class="diff-removed">-				const src = bodyNode.firstElementChild.getAttribute('src')!</div><div class="diff-removed">-				handleText(editor, src, point, results)</div><div class="diff-removed">-				return</div><div class="diff-removed">-			}</div><div class="diff-removed">-		}</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	// Try to paste a link</div><div class="diff-removed">-	for (const result of results) {</div><div class="diff-removed">-		if (result.type === 'text' && result.subtype === 'url') {</div><div class="diff-removed">-			pasteUrl(editor, result.data, point, results)</div><div class="diff-removed">-			return</div><div class="diff-removed">-		}</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	// Finally, if we haven't bailed on anything yet, we can paste text content</div><div class="diff-removed">-	for (const result of results) {</div><div class="diff-removed">-		if (result.type === 'text' && result.subtype === 'text' && result.data.trim()) {</div><div class="diff-removed">-			// The clipboard may include multiple text items, but we only want to paste the first one</div><div class="diff-removed">-			handleText(editor, result.data, point, results)</div><div class="diff-removed">-			return</div><div class="diff-removed">-		}</div><div class="diff-removed">-	}</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-/**</div><div class="diff-removed">- * When the user copies, write the contents to local storage and to the clipboard</div><div class="diff-removed">- *</div><div class="diff-removed">- * @param editor - The editor instance.</div><div class="diff-removed">- * @public</div><div class="diff-removed">- */</div><div class="diff-removed">-const handleNativeOrMenuCopy = async (editor: Editor) => {</div><div class="diff-removed">-	const content = await editor.resolveAssetsInContent(</div><div class="diff-removed">-		editor.getContentFromCurrentPage(editor.getSelectedShapeIds())</div><div class="diff-removed">-	)</div><div class="diff-removed">-	if (!content) {</div><div class="diff-removed">-		if (navigator && navigator.clipboard) {</div><div class="diff-removed">-			navigator.clipboard.writeText('')</div><div class="diff-removed">-		}</div><div class="diff-removed">-		return</div><div class="diff-removed">-	}</div><div class="diff-removed">-</div><div class="diff-removed">-	const stringifiedClipboard = lz.compressToBase64(</div><div class="diff-removed">-		JSON.stringify({</div><div class="diff-removed">-			type: 'application/tldraw',</div><div class="diff-removed">-			kind: 'content',</div><div class="diff-removed">-			data: content,</div><div class="diff-removed">-		})</div><div class="diff-removed">-	)</div><div class="diff-removed">-</div><div class="diff-removed">-	if (typeof navigator === 'undefined') {</div><div class="diff-removed">-		return</div><div class="diff-removed">-	} else {</div><div class="diff-removed">-		// Extract the text from the clipboard</div><div class="diff-removed">-		const textItems = content.shapes</div><div class="diff-removed">-			.map((shape) => {</div><div class="diff-removed">-				const util = editor.getShapeUtil(shape)</div><div class="diff-removed">-				return util.getText(shape)</div><div class="diff-removed">-			})</div><div class="diff-removed">-			.filter(isDefined)</div><div class="diff-removed">-</div><div class="diff-removed">-		if (navigator.clipboard?.write) {</div><div class="diff-removed">-			const htmlBlob = new Blob([`<div data-tldraw>${stringifiedClipboard}</div>`], {</div><div class="diff-removed">-				type: 'text/html',</div><div class="diff-removed">-			})</div><div class="diff-removed">-</div><div class="diff-removed">-			let textContent = textItems.join(' ')</div><div class="diff-removed">-</div><div class="diff-removed">-			// This is a bug in chrome android where it won't paste content if</div><div class="diff-removed">-			// the text/plain content is "" so we need to always add an empty</div><div class="diff-removed">-			// space 🤬</div><div class="diff-removed">-			if (textContent === '') {</div><div class="diff-removed">-				textContent = ' '</div><div class="diff-removed">-			}</div><div class="diff-removed">-</div><div class="diff-removed">-			navigator.clipboard.write([</div><div class="diff-removed">-				new ClipboardItem({</div><div class="diff-removed">-					'text/html': htmlBlob,</div><div class="diff-removed">-					// What is this second blob used for?</div><div class="diff-removed">-					'text/plain': new Blob([textContent], { type: 'text/plain' }),</div><div class="diff-removed">-				}),</div><div class="diff-removed">-			])</div><div class="diff-removed">-		} else if (navigator.clipboard.writeText) {</div><div class="diff-removed">-			navigator.clipboard.writeText(`<div data-tldraw>${stringifiedClipboard}</div>`)</div><div class="diff-removed">-		}</div><div class="diff-removed">-	}</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-/** @public */</div><div class="diff-removed">-export function useMenuClipboardEvents() {</div><div class="diff-removed">-	const editor = useMaybeEditor()</div><div class="diff-removed">-	const trackEvent = useUiEvents()</div><div class="diff-removed">-</div><div class="diff-removed">-	const copy = useCallback(</div><div class="diff-removed">-		async function onCopy(source: TLUiEventSource) {</div><div class="diff-removed">-			assert(editor, 'editor is required for copy')</div><div class="diff-removed">-			if (editor.getSelectedShapeIds().length === 0) return</div><div class="diff-removed">-</div><div class="diff-removed">-			await handleNativeOrMenuCopy(editor)</div><div class="diff-removed">-			trackEvent('copy', { source })</div><div class="diff-removed">-		},</div><div class="diff-removed">-		[editor, trackEvent]</div><div class="diff-removed">-	)</div><div class="diff-removed">-</div><div class="diff-removed">-	const cut = useCallback(</div><div class="diff-removed">-		async function onCut(source: TLUiEventSource) {</div><div class="diff-removed">-			if (!editor) return</div><div class="diff-removed">-			if (editor.getSelectedShapeIds().length === 0) return</div><div class="diff-removed">-</div><div class="diff-removed">-			await handleNativeOrMenuCopy(editor)</div><div class="diff-removed">-			editor.deleteShapes(editor.getSelectedShapeIds())</div><div class="diff-removed">-			trackEvent('cut', { source })</div><div class="diff-removed">-		},</div><div class="diff-removed">-		[editor, trackEvent]</div><div class="diff-removed">-	)</div><div class="diff-removed">-</div><div class="diff-removed">-	const paste = useCallback(</div><div class="diff-removed">-		async function onPaste(</div><div class="diff-removed">-			data: DataTransfer | ClipboardItem[],</div><div class="diff-removed">-			source: TLUiEventSource,</div><div class="diff-removed">-			point?: VecLike</div><div class="diff-removed">-		) {</div><div class="diff-removed">-			if (!editor) return</div><div class="diff-removed">-			// If we're editing a shape, or we are focusing an editable input, then</div><div class="diff-removed">-			// we would want the user's paste interaction to go to that element or</div><div class="diff-removed">-			// input instead; e.g. when pasting text into a text shape's content</div><div class="diff-removed">-			if (editor.getEditingShapeId() !== null) return</div><div class="diff-removed">-</div><div class="diff-removed">-			if (Array.isArray(data) && data[0] instanceof ClipboardItem) {</div><div class="diff-removed">-				handlePasteFromClipboardApi({ editor, clipboardItems: data, point })</div><div class="diff-removed">-				trackEvent('paste', { source: 'menu' })</div><div class="diff-removed">-			} else {</div><div class="diff-removed">-				// Read it first and then recurse, kind of weird</div><div class="diff-removed">-				navigator.clipboard.read().then((clipboardItems) => {</div><div class="diff-removed">-					paste(clipboardItems, source, point)</div><div class="diff-removed">-				})</div><div class="diff-removed">-			}</div><div class="diff-removed">-		},</div><div class="diff-removed">-		[editor, trackEvent]</div><div class="diff-removed">-	)</div><div class="diff-removed">-</div><div class="diff-removed">-	return {</div><div class="diff-removed">-		copy,</div><div class="diff-removed">-		cut,</div><div class="diff-removed">-		paste,</div><div class="diff-removed">-	}</div><div class="diff-removed">-}</div><div class="diff-removed">-</div><div class="diff-removed">-/** @public */</div><div class="diff-removed">-export function useNativeClipboardEvents() {</div><div class="diff-removed">-	const editor = useEditor()</div><div class="diff-removed">-	const trackEvent = useUiEvents()</div><div class="diff-removed">-</div><div class="diff-removed">-	const appIsFocused = useValue('editor.isFocused', () => editor.getInstanceState().isFocused, [</div><div class="diff-removed">-		editor,</div><div class="diff-removed">-	])</div><div class="diff-removed">-</div><div class="diff-removed">-	useEffect(() => {</div><div class="diff-removed">-		if (!appIsFocused) return</div><div class="diff-removed">-		const copy = async (e: ClipboardEvent) => {</div><div class="diff-removed">-			if (</div><div class="diff-removed">-				editor.getSelectedShapeIds().length === 0 ||</div><div class="diff-removed">-				editor.getEditingShapeId() !== null ||</div><div class="diff-removed">-				areShortcutsDisabled(editor)</div><div class="diff-removed">-			) {</div><div class="diff-removed">-				return</div><div class="diff-removed">-			}</div><div class="diff-removed">-</div><div class="diff-removed">-			preventDefault(e)</div><div class="diff-removed">-			await handleNativeOrMenuCopy(editor)</div><div class="diff-removed">-			trackEvent('copy', { source: 'kbd' })</div><div class="diff-removed">-		}</div><div class="diff-removed">-</div><div class="diff-removed">-		async function cut(e: ClipboardEvent) {</div><div class="diff-removed">-			if (</div><div class="diff-removed">-				editor.getSelectedShapeIds().length === 0 ||</div><div class="diff-removed">-				editor.getEditingShapeId() !== null ||</div><div class="diff-removed">-				areShortcutsDisabled(editor)</div><div class="diff-removed">-			) {</div><div class="diff-removed">-				return</div><div class="diff-removed">-			}</div><div class="diff-removed">-			preventDefault(e)</div><div class="diff-removed">-			await handleNativeOrMenuCopy(editor)</div><div class="diff-removed">-			editor.deleteShapes(editor.getSelectedShapeIds())</div><div class="diff-removed">-			trackEvent('cut', { source: 'kbd' })</div><div class="diff-removed">-		}</div><div class="diff-removed">-</div><div class="diff-removed">-		let disablingMiddleClickPaste = false</div><div class="diff-removed">-		const pointerUpHandler = (e: PointerEvent) => {</div><div class="diff-removed">-			if (e.button === 1) {</div><div class="diff-removed">-				// middle mouse button</div><div class="diff-removed">-				disablingMiddleClickPaste = true</div><div class="diff-removed">-				editor.timers.requestAnimationFrame(() => {</div><div class="diff-removed">-					disablingMiddleClickPaste = false</div><div class="diff-removed">-				})</div><div class="diff-removed">-			}</div><div class="diff-removed">-		}</div><div class="diff-removed">-</div><div class="diff-removed">-		const paste = (e: ClipboardEvent) => {</div><div class="diff-removed">-			if (disablingMiddleClickPaste) {</div><div class="diff-removed">-				stopEventPropagation(e)</div><div class="diff-removed">-				return</div><div class="diff-removed">-			}</div><div class="diff-removed">-</div><div class="diff-removed">-			// If we're editing a shape, or we are focusing an editable input, then</div><div class="diff-removed">-			// we would want the user's paste interaction to go to that element or</div><div class="diff-removed">-			// input instead; e.g. when pasting text into a text shape's content</div><div class="diff-removed">-			if (editor.getEditingShapeId() !== null || areShortcutsDisabled(editor)) return</div><div class="diff-removed">-</div><div class="diff-removed">-			// Where should the shapes go?</div><div class="diff-removed">-			let point: Vec | undefined = undefined</div><div class="diff-removed">-			let pasteAtCursor = false</div><div class="diff-removed">-</div><div class="diff-removed">-			// | Shiftkey | Paste at cursor mode | Paste at point? |</div><div class="diff-removed">-			// |    N 		|         N            |       N 				 |</div><div class="diff-removed">-			// |    Y 		|         N            |       Y 				 |</div><div class="diff-removed">-			// |    N 		|         Y            |       Y 				 |</div><div class="diff-removed">-			// |    Y 		|         Y            |       N 				 |</div><div class="diff-removed">-			if (editor.inputs.shiftKey) pasteAtCursor = true</div><div class="diff-removed">-			if (editor.user.getIsPasteAtCursorMode()) pasteAtCursor = !pasteAtCursor</div><div class="diff-removed">-			if (pasteAtCursor) point = editor.inputs.currentPagePoint</div><div class="diff-removed">-</div><div class="diff-removed">-			const pasteFromEvent = () => {</div><div class="diff-removed">-				if (e.clipboardData) {</div><div class="diff-removed">-					handlePasteFromEventClipboardData(editor, e.clipboardData, point)</div><div class="diff-removed">-				}</div><div class="diff-removed">-			}</div><div class="diff-removed">-</div><div class="diff-removed">-			// if we can read from the clipboard API, we want to try using that first. that allows</div><div class="diff-removed">-			// us to access most things, and doesn't strip out metadata added to tldraw's own</div><div class="diff-removed">-			// copy-as-png features - so copied shapes come back in at the correct size.</div><div class="diff-removed">-			if (navigator.clipboard?.read) {</div><div class="diff-removed">-				// We can't read files from the filesystem using the clipboard API though - they'll</div><div class="diff-removed">-				// just come in as the file names instead. So we'll use the clipboard event's files</div><div class="diff-removed">-				// as a fallback - if we only got text, but do have files, we use those instead.</div><div class="diff-removed">-				const fallbackFiles = Array.from(e.clipboardData?.files || [])</div><div class="diff-removed">-				navigator.clipboard.read().then(</div><div class="diff-removed">-					(clipboardItems) => {</div><div class="diff-removed">-						if (Array.isArray(clipboardItems) && clipboardItems[0] instanceof ClipboardItem) {</div><div class="diff-removed">-							handlePasteFromClipboardApi({ editor, clipboardItems, point, fallbackFiles })</div><div class="diff-removed">-						}</div><div class="diff-removed">-					},</div><div class="diff-removed">-					() => {</div><div class="diff-removed">-						// if reading from the clipboard fails, try to use the event clipboard data</div><div class="diff-removed">-						pasteFromEvent()</div><div class="diff-removed">-					}</div><div class="diff-removed">-				)</div><div class="diff-removed">-			} else {</div><div class="diff-removed">-				pasteFromEvent()</div><div class="diff-removed">-			}</div><div class="diff-removed">-</div><div class="diff-removed">-			preventDefault(e)</div><div class="diff-removed">-			trackEvent('paste', { source: 'kbd' })</div><div class="diff-removed">-		}</div><div class="diff-removed">-</div><div class="diff-removed">-		document.addEventListener('copy', copy)</div><div class="diff-removed">-		document.addEventListener('cut', cut)</div><div class="diff-removed">-		document.addEventListener('paste', paste)</div><div class="diff-removed">-		document.addEventListener('pointerup', pointerUpHandler)</div><div class="diff-removed">-</div><div class="diff-removed">-		return () => {</div><div class="diff-removed">-			document.removeEventListener('copy', copy)</div><div class="diff-removed">-			document.removeEventListener('cut', cut)</div><div class="diff-removed">-			document.removeEventListener('paste', paste)</div><div class="diff-removed">-			document.removeEventListener('pointerup', pointerUpHandler)</div><div class="diff-removed">-		}</div><div class="diff-removed">-	}, [editor, trackEvent, appIsFocused])</div><div class="diff-removed">-}</div><div>\ No newline at end of file</div><div class="diff-added">+								if (</div><div>\ No newline at end of file</div><div></div></pre>
                </div>
            </div>
        </section>
    </main>
    <footer>
        <p>LoCoDiff-bench - <a href="https://github.com/AbanteAI/LoCoDiff-bench">GitHub Repository</a></p>
    </footer>
</body>
</html>
    