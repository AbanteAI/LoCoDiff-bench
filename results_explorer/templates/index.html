{% extends "base.html" %}

{% block title %}Benchmark Overview - LoCoDiff Explorer{% endblock %}

{% block content %}
    <h1>LoCoDiff Benchmark Overview</h1>

    <div class="metadata-box">
        <h2>Benchmark Summary</h2>
        <p><strong>Total Benchmark Cases Defined:</strong> {{ total_cases if total_cases is not none else 'Metadata not found' }}</p>
        <p><strong>Models with Results Found:</strong> {{ models|length }}</p>
        {% if benchmark_metadata and benchmark_metadata.generation_parameters %}
            <h3>Generation Parameters</h3>
            <ul>
                {% for key, value in benchmark_metadata.generation_parameters.items() %}
                    <li><strong>{{ key|replace('_', ' ')|title }}:</strong> {{ value }}</li>
                {% endfor %}
            </ul>
        {% endif %}
    </div>

    <h2>Models Explored</h2>
    {% if models %}
        <ul>
            {% for model in models %}
                <li><a href="{{ url_for('model_results', model_name=model) }}">{{ model }}</a></li>
            {% endfor %}
        </ul>
    {% else %}
        <p>No benchmark results found in <code>{{ config.RESULTS_BASE_DIR }}</code>.</p>
        <p>Run the benchmark using <code>./benchmark_pipeline/3_run_benchmark.py --model &lt;model_name&gt; --num-runs -1</code>.</p>
    {% endif %}

    {% if analysis_results and analysis_results.models %}
        <h2>Overall Model Performance Summary</h2>
        <table>
            <thead>
                <tr>
                    <th>Model</th>
                    <th>Defined</th>
                    <th>Runs Found</th>
                    <th>Successful</th>
                    <th>Success Rate</th>
                    <th>Total Cost (USD)</th>
                </tr>
            </thead>
            <tbody>
                {% for model_name in models %} {# Use sorted list from route #}
                    {% set stats = analysis_results.models[model_name] %}
                    <tr>
                        <td><a href="{{ url_for('model_results', model_name=model_name) }}">{{ model_name }}</a></td>
                        <td>{{ stats.total_benchmarks }}</td>
                        <td>{{ stats.runs_found }}</td>
                        <td>{{ stats.successful_runs }}</td>
                        <td>{{ "%.1f%%"|format(stats.success_rate * 100) }}</td>
                        <td>${{ "%.4f"|format(stats.total_cost_usd) }}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>

        <h2>Per-Bucket Success Rate (%)</h2>
        {% if analysis_results.bucket_keys %}
            <table>
                <thead>
                    <tr>
                        <th>Bucket (k tk)</th>
                        {% for model_name in models %}
                            <th>{{ model_name }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for i in range(analysis_results.bucket_keys|length) %}
                        {% set bucket_key = analysis_results.bucket_keys[i] %}
                        {% set formatted_key = analysis_results.formatted_bucket_keys[i] %}
                        <tr>
                            <td>{{ formatted_key }}</td>
                            {% for model_name in models %}
                                {% set bucket_stats = analysis_results.models[model_name].buckets[bucket_key] %}
                                <td>
                                    {% if bucket_stats.runs_found > 0 %}
                                        {{ "%.1f%%"|format(bucket_stats.success_rate * 100) }}
                                        <small>({{ bucket_stats.successful_runs }}/{{ bucket_stats.runs_found }})</small>
                                    {% elif bucket_stats.total_in_bucket > 0 %}
                                        0/0
                                    {% else %}
                                        - {# Bucket empty #}
                                    {% endif %}
                                </td>
                            {% endfor %}
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>No bucket information found in analysis results.</p>
        {% endif %}

    {% elif models %} {# Only show this if models were found but analysis failed #}
        <p class="failure">Analysis results could not be generated or loaded. Check application logs.</p>
    {% endif %}


    <h2>Overall Success Rate Plot</h2>
    <div class="chart-container">
        <canvas id="successRateChart"></canvas>
    </div>
    <p><small>Interactive plot generated dynamically using Chart.js. Hover over data points to see details.</small></p>

    <h2>Sliding Window Success Rate Plot (+/- 5k Tokens)</h2>
    <div class="chart-container">
        <canvas id="slidingSuccessRateChart"></canvas>
    </div>
    <p><small>Interactive plot showing success rate within a +/- 5k token window around each point. Hover over data points to see details.</small></p>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const ctxBucket = document.getElementById('successRateChart').getContext('2d');
    const ctxSliding = document.getElementById('slidingSuccessRateChart').getContext('2d');
    let bucketChart = null;
    let slidingChart = null;
    
    // Color palette for datasets - will be assigned to models in order
    const colorPalette = [
        'rgb(54, 162, 235)',   // blue
        'rgb(255, 99, 132)',   // red
        'rgb(75, 192, 192)',   // teal
        'rgb(255, 159, 64)',   // orange
        'rgb(153, 102, 255)',  // purple
        'rgb(255, 205, 86)',   // yellow
        'rgb(201, 203, 207)',  // grey
        'rgb(22, 160, 133)',   // green
        'rgb(142, 68, 173)',   // dark purple
        'rgb(211, 84, 0)'      // dark orange
    ];
    
    // Format tooltips to show actual numbers and confidence intervals for sliding chart
    const tooltipCallback = {
        label: function(context) {
            const datasetLabel = context.dataset.label || '';
            const value = context.parsed.y;
            let label = datasetLabel + ': ';

            if (value !== null && !isNaN(value)) {
                label += (value * 100).toFixed(1) + '%';
            } else {
                label += 'N/A'; // Handle null or NaN rates
            }

            // Check if this is the sliding window chart (by checking for wilson bounds in dataset)
            if (context.dataset.wilson_lower && context.dataset.wilson_upper) {
                const lowerBound = context.dataset.wilson_lower[context.dataIndex];
                const upperBound = context.dataset.wilson_upper[context.dataIndex];

                if (lowerBound !== null && upperBound !== null) {
                    label += ` (CI: ${(lowerBound * 100).toFixed(1)}% - ${(upperBound * 100).toFixed(1)}%)`;
                } else {
                    label += ' (CI: N/A)';
                }
            }
            return label;
        },
        title: function(context) {
            // Use the x-axis label (e.g., "5k", "6k") as the title
            return 'Window Center: ' + context[0].label;
        },
        footer: function(context) {
            // We could add more details here if needed, like total runs in window
            return '';
        }
    };

    // Function to create a chart
    function createChart(ctx, apiUrl, chartTitle, xAxisLabel, errorContainerSelector) {
        fetch(apiUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`API response was not ok (${response.status})`);
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }

                let chartDatasets = [];
                const isSlidingChart = apiUrl.includes('sliding');

                // Process the datasets and assign colors/structure
                data.datasets.forEach((apiDataset, index) => {
                    const colorIndex = index % colorPalette.length;
                    const mainColor = colorPalette[colorIndex];
                    const transparentColor = mainColor.replace('rgb', 'rgba').replace(')', ', 0.2)'); // Lighter fill for bands

                    // Main data line
                    const mainDataset = {
                        ...apiDataset, // Includes label, data, wilson_lower, wilson_upper
                        borderColor: mainColor,
                        backgroundColor: mainColor, // For points
                        pointBackgroundColor: mainColor,
                        pointHoverRadius: 6,
                        fill: false,
                        tension: 0.1,
                        order: 1, // Draw main line on top
                        spanGaps: isSlidingChart, // Apply spanGaps if it's the sliding chart
                    };
                    chartDatasets.push(mainDataset);

                    // Add datasets for confidence interval bands ONLY for the sliding chart
                    if (isSlidingChart && apiDataset.wilson_lower && apiDataset.wilson_upper) {
                        // Lower bound dataset (invisible line, fills up to upper bound)
                        chartDatasets.push({
                            label: apiDataset.label + ' CI Lower', // Internal label, not shown in legend
                            data: apiDataset.wilson_lower,
                            borderColor: 'transparent',
                            backgroundColor: transparentColor, // Fill color
                            pointRadius: 0,
                            fill: '+1', // Fill to the next dataset (upper bound)
                            showInLegend: false,
                            order: 2, // Draw fill below main line
                            spanGaps: true, // Connect gaps for fill
                        });

                        // Upper bound dataset (invisible line, defines top of fill)
                        chartDatasets.push({
                            label: apiDataset.label + ' CI Upper', // Internal label, not shown in legend
                            data: apiDataset.wilson_upper,
                            borderColor: 'transparent',
                            backgroundColor: 'transparent', // No background for this line itself
                            pointRadius: 0,
                            fill: false, // Don't fill this line itself
                            showInLegend: false,
                            order: 3, // Draw below lower bound fill target
                            spanGaps: true, // Connect gaps for fill boundary
                        });
                    }
                });
                
                // Create the chart
                return new Chart(ctx, {
                    type: 'line',
                    data: { // Structure data for Chart.js
                        labels: data.labels,
                        datasets: chartDatasets // Use the structured datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 1,
                                ticks: {
                                    callback: function(value) {
                                        return (value * 100) + '%';
                                    }
                                },
                                title: {
                                    display: true,
                                    text: 'Success Rate'
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.1)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: xAxisLabel // Use dynamic label
                                },
                                grid: {
                                    display: false
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: tooltipCallback
                            },
                            legend: {
                                position: 'right',
                                labels: {
                                    boxWidth: 12,
                                    padding: 15
                                },
                                title: {
                                    display: true,
                                    text: 'Models',
                                    padding: 10
                                }
                            },
                            title: {
                                display: true,
                                text: chartTitle, // Use dynamic title
                                font: {
                                    size: 16
                                },
                                padding: 20
                            }
                        }
                    }
                });
            })
            .catch(error => {
                console.error(`Error fetching chart data from ${apiUrl}:`, error);
                // Display error message in the canvas container
                const errorContainer = ctx.canvas.closest('.chart-container'); // Find parent container
                if (errorContainer) {
                    const errorMsg = document.createElement('div');
                    errorMsg.style.textAlign = 'center';
                    errorMsg.style.paddingTop = '150px'; // Adjust as needed
                    errorMsg.innerHTML = `
                        <p style="color: red; font-weight: bold;">Error loading chart data</p>
                        <p>${error.message}</p>
                        <p>Check browser console for details.</p>
                    `;
                    // Clear previous content and add error message
                    while (errorContainer.firstChild) {
                        errorContainer.removeChild(errorContainer.firstChild);
                    }
                    errorContainer.appendChild(errorMsg);
                }
            });
    } // End of createChart function definition

    // Create the Bucket Chart
    bucketChart = createChart(
        ctxBucket,
        '/api/plot-data',
        'Benchmark Success Rate per Prompt Token Bucket',
        'Prompt Token Bucket (k tokens)',
        '#successRateChart' // Not used anymore, error displayed in container
    );

    // Create the Sliding Window Chart
    slidingChart = createChart(
        ctxSliding,
        '/api/sliding-plot-data',
        'Sliding Window Success Rate (+/- 5k Tokens)',
        'Window Center (k tokens)',
        '#slidingSuccessRateChart' // Not used anymore, error displayed in container
    );
});
</script>
{% endblock %}
