{% extends "base.html" %}

{% block title %}Benchmark Overview - LoCoDiff Explorer{% endblock %}

{% block content %}
    <h1>LoCoDiff Benchmark Overview</h1>

    <div class="metadata-box">
        <h2>Benchmark Summary</h2>
        <p><strong>Total Benchmark Cases Defined:</strong> {{ total_cases if total_cases is not none else 'Metadata not found' }}</p>
        <p><strong>Models with Results Found:</strong> {{ models|length }}</p>
        {% if benchmark_metadata and benchmark_metadata.generation_parameters %}
            <h3>Generation Parameters</h3>
            <ul>
                {% for key, value in benchmark_metadata.generation_parameters.items() %}
                    <li><strong>{{ key|replace('_', ' ')|title }}:</strong> {{ value }}</li>
                {% endfor %}
            </ul>
        {% endif %}
    </div>

    <h2>Models Explored</h2>
    {% if models %}
        <ul>
            {% for model in models %}
                <li><a href="{{ url_for('model_results', model_name=model) }}">{{ model }}</a></li>
            {% endfor %}
        </ul>
    {% else %}
        <p>No benchmark results found in <code>{{ config.RESULTS_BASE_DIR }}</code>.</p>
        <p>Run the benchmark using <code>./benchmark_pipeline/3_run_benchmark.py --model &lt;model_name&gt; --num-runs -1</code>.</p>
    {% endif %}

    {% if analysis_results and analysis_results.models %}
        <h2>Overall Model Performance Summary</h2>
        <table>
            <thead>
                <tr>
                    <th>Model</th>
                    <th>Defined</th>
                    <th>Runs Found</th>
                    <th>Successful</th>
                    <th>Success Rate</th>
                    <th>Total Cost (USD)</th>
                </tr>
            </thead>
            <tbody>
                {% for model_name in models %} {# Use sorted list from route #}
                    {% set stats = analysis_results.models[model_name] %}
                    <tr>
                        <td><a href="{{ url_for('model_results', model_name=model_name) }}">{{ model_name }}</a></td>
                        <td>{{ stats.total_benchmarks }}</td>
                        <td>{{ stats.runs_found }}</td>
                        <td>{{ stats.successful_runs }}</td>
                        <td>{{ "%.1f%%"|format(stats.success_rate * 100) }}</td>
                        <td>${{ "%.4f"|format(stats.total_cost_usd) }}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>

        <h2>Per-Bucket Success Rate (%)</h2>
        {% if analysis_results.bucket_keys %}
            <table>
                <thead>
                    <tr>
                        <th>Bucket (k tk)</th>
                        {% for model_name in models %}
                            <th>{{ model_name }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for i in range(analysis_results.bucket_keys|length) %}
                        {% set bucket_key = analysis_results.bucket_keys[i] %}
                        {% set formatted_key = analysis_results.formatted_bucket_keys[i] %}
                        <tr>
                            <td>{{ formatted_key }}</td>
                            {% for model_name in models %}
                                {% set bucket_stats = analysis_results.models[model_name].buckets[bucket_key] %}
                                <td>
                                    {% if bucket_stats.runs_found > 0 %}
                                        {{ "%.1f%%"|format(bucket_stats.success_rate * 100) }}
                                        <small>({{ bucket_stats.successful_runs }}/{{ bucket_stats.runs_found }})</small>
                                    {% elif bucket_stats.total_in_bucket > 0 %}
                                        0/0
                                    {% else %}
                                        - {# Bucket empty #}
                                    {% endif %}
                                </td>
                            {% endfor %}
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>No bucket information found in analysis results.</p>
        {% endif %}

    {% elif models %} {# Only show this if models were found but analysis failed #}
        <p class="failure">Analysis results could not be generated or loaded. Check application logs.</p>
    {% endif %}


    <h2>Overall Success Rate Plot</h2>
    <div class="plot-container">
        {% if plot_url %}
            <img src="{{ plot_url }}" alt="Benchmark Success Rate Plot">
            {# Use PLOT_STATIC_PATH from config which now points to the destination #}
            <p><small>Plot generated by the explorer app and saved to <code>{{ config.PLOT_STATIC_PATH }}</code>.</small></p>
        {% else %}
            {# Use PLOT_STATIC_PATH from config #}
            <p>Plot file (<code>{{ config.PLOT_STATIC_PATH }}</code>) not found.</p>
            <p>The plot should be generated automatically when the explorer app starts. Check application logs for errors.</p>
        {% endif %}
    </div>

{% endblock %}
