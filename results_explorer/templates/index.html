{% extends "base.html" %}

{% block title %}Benchmark Overview - LoCoDiff Explorer{% endblock %}

{% block content %}
    <h1>LoCoDiff Benchmark Overview</h1>

    <div class="metadata-box">
        <h2>Benchmark Summary</h2>
        <p><strong>Total Benchmark Cases Defined:</strong> {{ total_cases if total_cases is not none else 'Metadata not found' }}</p>
        <p><strong>Models with Results Found:</strong> {{ models|length }}</p>
        {% if benchmark_metadata and benchmark_metadata.generation_parameters %}
            <h3>Generation Parameters</h3>
            <ul>
                {% for key, value in benchmark_metadata.generation_parameters.items() %}
                    <li><strong>{{ key|replace('_', ' ')|title }}:</strong> {{ value }}</li>
                {% endfor %}
            </ul>
        {% endif %}
    </div>

    <h2>Models Explored</h2>
    {% if models %}
        <ul>
            {% for model in models %}
                <li><a href="{{ url_for('model_results', model_name=model) }}">{{ model }}</a></li>
            {% endfor %}
        </ul>
    {% else %}
        <p>No benchmark results found in <code>{{ config.RESULTS_BASE_DIR }}</code>.</p>
        <p>Run the benchmark using <code>./benchmark_pipeline/3_run_benchmark.py --model &lt;model_name&gt; --num-runs -1</code>.</p>
    {% endif %}

    {% if analysis_results and analysis_results.models %}
        <h2>Overall Model Performance Summary</h2>
        <table>
            <thead>
                <tr>
                    <th>Model</th>
                    <th>Defined</th>
                    <th>Runs Found</th>
                    <th>Successful</th>
                    <th>Success Rate</th>
                    <th>Total Cost (USD)</th>
                </tr>
            </thead>
            <tbody>
                {% for model_name in models %} {# Use sorted list from route #}
                    {% set stats = analysis_results.models[model_name] %}
                    <tr>
                        <td><a href="{{ url_for('model_results', model_name=model_name) }}">{{ model_name }}</a></td>
                        <td>{{ stats.total_benchmarks }}</td>
                        <td>{{ stats.runs_found }}</td>
                        <td>{{ stats.successful_runs }}</td>
                        <td>{{ "%.1f%%"|format(stats.success_rate * 100) }}</td>
                        <td>${{ "%.4f"|format(stats.total_cost_usd) }}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>

        <h2>Per-Bucket Success Rate (%)</h2>
        {% if analysis_results.bucket_keys %}
            <table>
                <thead>
                    <tr>
                        <th>Bucket (k tk)</th>
                        {% for model_name in models %}
                            <th>{{ model_name }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for i in range(analysis_results.bucket_keys|length) %}
                        {% set bucket_key = analysis_results.bucket_keys[i] %}
                        {% set formatted_key = analysis_results.formatted_bucket_keys[i] %}
                        <tr>
                            <td>{{ formatted_key }}</td>
                            {% for model_name in models %}
                                {% set bucket_stats = analysis_results.models[model_name].buckets[bucket_key] %}
                                <td>
                                    {% if bucket_stats.runs_found > 0 %}
                                        {{ "%.1f%%"|format(bucket_stats.success_rate * 100) }}
                                        <small>({{ bucket_stats.successful_runs }}/{{ bucket_stats.runs_found }})</small>
                                    {% elif bucket_stats.total_in_bucket > 0 %}
                                        0/0
                                    {% else %}
                                        - {# Bucket empty #}
                                    {% endif %}
                                </td>
                            {% endfor %}
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>No bucket information found in analysis results.</p>
        {% endif %}

    {% elif models %} {# Only show this if models were found but analysis failed #}
        <p class="failure">Analysis results could not be generated or loaded. Check application logs.</p>
    {% endif %}


    <h2>Overall Success Rate Plot</h2>
    <div class="chart-container">
        <canvas id="successRateChart"></canvas>
    </div>
    <p><small>Interactive plot generated dynamically using Chart.js. Hover over data points to see details.</small></p>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('successRateChart').getContext('2d');
    let chart = null;
    
    // Color palette for datasets - will be assigned to models in order
    const colorPalette = [
        'rgb(54, 162, 235)',   // blue
        'rgb(255, 99, 132)',   // red
        'rgb(75, 192, 192)',   // teal
        'rgb(255, 159, 64)',   // orange
        'rgb(153, 102, 255)',  // purple
        'rgb(255, 205, 86)',   // yellow
        'rgb(201, 203, 207)',  // grey
        'rgb(22, 160, 133)',   // green
        'rgb(142, 68, 173)',   // dark purple
        'rgb(211, 84, 0)'      // dark orange
    ];
    
    // Format tooltips to show actual numbers
    const tooltipCallback = {
        label: function(context) {
            const label = context.dataset.label || '';
            const value = context.parsed.y;
            return label + ': ' + (value * 100).toFixed(1) + '%';
        },
        title: function(context) {
            return 'Bucket: ' + context[0].label;
        },
        footer: function(context) {
            // We could add more details here if needed
            return '';
        }
    };
    
    // Fetch the data from our API
    fetch('/api/plot-data')
        .then(response => {
            if (!response.ok) {
                throw new Error('API response was not ok');
            }
            return response.json();
        })
        .then(data => {
            // Process the datasets and assign colors
            data.datasets.forEach((dataset, index) => {
                const colorIndex = index % colorPalette.length;
                const color = colorPalette[colorIndex];
                
                dataset.borderColor = color;
                dataset.backgroundColor = color.replace('rgb', 'rgba').replace(')', ', 0.5)');
                dataset.pointBackgroundColor = color;
                dataset.pointHoverRadius = 6;
            });
            
            // Create the chart
            chart = new Chart(ctx, {
                type: 'line',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 1,
                            ticks: {
                                callback: function(value) {
                                    return (value * 100) + '%';
                                }
                            },
                            title: {
                                display: true,
                                text: 'Success Rate'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Prompt Token Bucket (k tokens)'
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: tooltipCallback
                        },
                        legend: {
                            position: 'right',
                            labels: {
                                boxWidth: 12,
                                padding: 15
                            },
                            title: {
                                display: true,
                                text: 'Models',
                                padding: 10
                            }
                        },
                        title: {
                            display: true,
                            text: 'Benchmark Success Rate per Prompt Token Bucket',
                            font: {
                                size: 16
                            },
                            padding: 20
                        }
                    }
                }
            });
        })
        .catch(error => {
            console.error('Error fetching chart data:', error);
            // Display error message in the canvas
            const errorMsg = document.createElement('div');
            errorMsg.style.textAlign = 'center';
            errorMsg.style.paddingTop = '150px';
            errorMsg.innerHTML = `
                <p style="color: red; font-weight: bold;">Error loading chart data</p>
                <p>${error.message}</p>
                <p>Check browser console for details.</p>
            `;
            document.querySelector('.chart-container').appendChild(errorMsg);
            document.getElementById('successRateChart').style.display = 'none';
        });
});
</script>
{% endblock %}
